<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meta-Analysis Methods: From Question to Conclusion</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Plotly for interactive plots -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
if (typeof Plotly === 'undefined') {
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id*="plot"], [id*="chart"], .plotly-graph-div, .js-plotly-plot').forEach(function(el) {
      el.innerHTML = '<div style="padding:2rem;text-align:center;background:#2a2a4a;border:1px dashed #D4AF37;border-radius:8px;color:#FAF8F5;margin:1rem 0;"><p style="font-size:1.1rem;margin-bottom:0.5rem;">Interactive chart unavailable offline</p><p style="font-size:0.85rem;opacity:0.7;">Connect to the internet to load interactive Plotly.js visualizations</p></div>';
    });
  });
}
</script>
  <style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f5b6a;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    /* ====== COURSE SHELL ====== */
    .course-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ====== SIDEBAR NAV ====== */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }

    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 0.25rem;
    }

    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .module-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
    }

    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .module-item:hover {
      background: rgba(212,175,55,0.1);
    }

    .module-item.active {
      background: rgba(212,175,55,0.15);
      border-left-color: var(--gold);
    }

    .module-item.completed .module-number {
      background: var(--green);
      color: white;
    }

    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .module-info {
      flex: 1;
      min-width: 0;
    }

    .module-title {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .module-subtitle {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
    }

    /* ====== SIDEBAR FOOTER ====== */
    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }

    .progress-dashboard-btn {
      width: 100%;
      padding: 0.75rem;
      background: rgba(212,175,55,0.15);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 8px;
      color: var(--gold);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .daily-review-btn {
      width: 100%;
      padding: 0.6rem;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      color: #f87171;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .progress-bar-container {
      margin-top: 0.75rem;
    }

    .progress-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.25rem;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), #f0c040);
      border-radius: 3px;
      transition: width 0.3s;
    }

    /* ====== MAIN CONTENT ====== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(212,175,55,0.15);
    }

    .module-indicator {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
    }

    .top-bar-actions {
      display: flex;
      gap: 0.75rem;
    }

    .top-bar-btn {
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: var(--cream);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .top-bar-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .top-bar-btn.primary {
      background: var(--teal);
      border-color: var(--teal);
    }

    /* ====== SLIDE AREA ====== */
    .slide-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .slide {
      display: none;
      max-width: 1000px;
      margin: 0 auto;
    }

    .slide.active {
      display: block;
    }

    /* ====== SLIDE STYLES ====== */
    .principle-display {
      text-align: center;
      margin-bottom: 2rem;
    }

    .principle-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2rem;
      font-style: italic;
      color: var(--gold);
      line-height: 1.4;
    }

    .slide-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.2rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .slide-content {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 12px;
      padding: 2rem;
    }

    .story-box {
      background: linear-gradient(135deg, rgba(191,45,45,0.1), rgba(30,39,97,0.15));
      border-left: 4px solid var(--red);
      border-radius: 0 12px 12px 0;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .story-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.5rem;
    }

    .story-text {
      font-size: 1.1rem;
      line-height: 1.7;
      color: var(--cream);
    }

    .story-hook {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.3rem;
      font-style: italic;
      color: var(--gold);
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .method-box {
      background: linear-gradient(135deg, rgba(15,91,106,0.15), rgba(30,39,97,0.1));
      border-left: 4px solid var(--teal);
      border-radius: 0 12px 12px 0;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .method-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--teal);
      margin-bottom: 0.5rem;
    }

    .method-content h3 {
      color: var(--cream);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .method-content ul {
      margin-left: 1.5rem;
      color: rgba(255,255,255,0.85);
    }

    .method-content li {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    /* ====== TOOL PANEL ====== */
    .tool-panel {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      color: var(--text);
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--teal);
    }

    .tool-icon {
      font-size: 1.5rem;
    }

    .tool-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }

    .tool-input-group {
      margin-bottom: 1rem;
    }

    .tool-input-group label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: var(--navy);
    }

    .tool-input-group input,
    .tool-input-group textarea,
    .tool-input-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .tool-input-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .tool-btn {
      padding: 0.6rem 1.25rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tool-btn:hover {
      background: #0a4a57;
    }

    .tool-output {
      margin-top: 1rem;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    /* ====== SCENARIO PANEL ====== */
    .scenario-panel {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid rgba(124,58,237,0.4);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .scenario-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .scenario-icon {
      font-size: 1.5rem;
    }

    .scenario-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--cream);
    }

    .scenario-situation {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .scenario-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 1rem;
    }

    .scenario-choices {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .scenario-choice {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scenario-choice:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(124,58,237,0.5);
    }

    .scenario-choice.correct {
      background: rgba(34,197,94,0.15);
      border-color: var(--green);
    }

    .scenario-choice.incorrect {
      background: rgba(239,68,68,0.1);
      border-color: var(--red);
    }

    .choice-letter {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(124,58,237,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .scenario-consequence {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }

    .scenario-consequence.visible {
      display: block;
    }

    .scenario-consequence.good {
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
    }

    .scenario-consequence.bad {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
    }

    /* ====== QUIZ ====== */
    .quiz-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .quiz-question {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--cream);
      font-family: inherit;
      font-size: inherit;
      text-align: left;
      width: 100%;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .quiz-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .quiz-option:disabled {
      cursor: not-allowed;
      opacity: 0.8;
    }

    .option-letter {
      font-weight: 600;
      color: var(--gold);
      flex-shrink: 0;
    }

    .quiz-option.selected {
      border-color: var(--gold);
      background: rgba(212,175,55,0.1);
    }

    .quiz-option.correct {
      border-color: var(--green);
      background: rgba(34,197,94,0.15);
    }

    .quiz-option.incorrect {
      border-color: var(--red);
      background: rgba(239,68,68,0.1);
    }

    /* ====== NAVIGATION ====== */
    .slide-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.2);
      border-top: 1px solid rgba(212,175,55,0.15);
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: var(--cream);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .nav-btn.primary {
      background: var(--gold);
      border-color: var(--gold);
      color: var(--navy);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .slide-counter {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
    }

    .slide-dots {
      display: flex;
      gap: 6px;
    }

    .slide-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .slide-dot.active {
      background: var(--gold);
    }

    .slide-dot.completed {
      background: var(--green);
    }

    /* ====== PROGRESS DASHBOARD ====== */
    .dashboard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .dashboard-overlay.open {
      display: flex;
    }

    .dashboard-panel {
      background: var(--light-cream);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text);
    }

    .dashboard-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--navy), var(--teal));
      color: white;
      border-radius: 16px 16px 0 0;
    }

    .dashboard-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 0.5rem;
    }

    .dashboard-content {
      padding: 1.5rem;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      text-align: center;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--navy);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--light-text);
      text-transform: uppercase;
    }

    .badge-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .badge {
      padding: 0.4rem 0.8rem;
      background: #e2e8f0;
      border-radius: 999px;
      font-size: 0.8rem;
      color: var(--light-text);
    }

    .badge.earned {
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      font-weight: 600;
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* ====== DECISION TREE ====== */
    .decision-tree {
      background: linear-gradient(135deg, rgba(30,39,97,0.1), rgba(20,27,61,0.15));
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .decision-node {
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .decision-node.active {
      border-color: var(--gold);
      background: rgba(212,175,55,0.15);
    }

    .decision-node.completed {
      border-color: var(--green);
      background: rgba(34,197,94,0.1);
    }

    .decision-node.wrong {
      border-color: var(--red);
      background: rgba(197,48,48,0.1);
    }

    .decision-question {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--cream);
      margin-bottom: 1rem;
    }

    .decision-branches {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .decision-branch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .decision-branch:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--gold);
    }

    .decision-branch.selected {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
    }

    .decision-branch.correct {
      background: rgba(34,197,94,0.2);
      border-color: var(--green);
    }

    .decision-branch.incorrect {
      background: rgba(197,48,48,0.15);
      border-color: var(--red);
    }

    .branch-arrow {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(212,175,55,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .decision-outcome {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }

    .decision-outcome.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .decision-outcome.good {
      background: rgba(34,197,94,0.15);
      border-left: 4px solid var(--green);
    }

    .decision-outcome.bad {
      background: rgba(197,48,48,0.15);
      border-left: 4px solid var(--red);
    }

    .decision-outcome.neutral {
      background: rgba(245,158,11,0.15);
      border-left: 4px solid #f59e0b;
    }

    /* ====== INTERACTIVE PLOTS ====== */
    .plot-container {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .plot-area {
      width: 100%;
      min-height: 350px;
      background: white;
      border-radius: 8px;
    }

    .plot-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.03);
      border-radius: 8px;
    }

    .plot-control-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .plot-control-group label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--navy);
    }

    .plot-control-group select,
    .plot-control-group input[type="number"] {
      padding: 0.4rem 0.6rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .plot-control-group input[type="range"] {
      width: 100px;
    }

    /* ====== DATA TABLE EDITOR ====== */
    .data-editor {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1.25rem;
      margin: 1rem 0;
      color: var(--text);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .data-table th {
      background: var(--navy);
      color: white;
      padding: 0.6rem;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .data-table input {
      width: 100%;
      padding: 0.35rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .data-table input:focus {
      border-color: var(--teal);
      outline: none;
    }

    .data-table .row-actions {
      text-align: center;
    }

    .data-table .delete-row {
      background: transparent;
      border: 1px solid #ddd;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: var(--red);
    }

    .add-row-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    /* ====== REAL-TIME STATS PANEL ====== */
    .stats-panel {
      background: linear-gradient(135deg, var(--navy), var(--teal));
      border-radius: 12px;
      padding: 1.25rem;
      color: white;
      margin: 1rem 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }

    .stat-item {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .stat-value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 0.25rem;
    }

    .stat-interpretation {
      margin-top: 1rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* ====== STORY DEEP DIVE ====== */
    .story-deep {
      background: linear-gradient(135deg, rgba(191,45,45,0.08), rgba(30,39,97,0.12));
      border-left: 4px solid var(--red);
      border-radius: 0 16px 16px 0;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-timeline {
      position: relative;
      padding-left: 2rem;
      margin: 1rem 0;
    }

    .story-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(255,255,255,0.2);
    }

    .timeline-event {
      position: relative;
      margin-bottom: 1.25rem;
      padding-left: 1rem;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -1.5rem;
      top: 0.35rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gold);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .timeline-event.crisis::before {
      background: var(--red);
    }

    .timeline-event.revelation::before {
      background: var(--green);
    }

    .timeline-year {
      font-weight: 700;
      color: var(--gold);
      font-size: 0.85rem;
    }

    .timeline-text {
      color: rgba(255,255,255,0.9);
      line-height: 1.5;
      margin-top: 0.25rem;
    }

    /* ====== REAL DATA CARD ====== */
    .real-data-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 12px;
      padding: 1.25rem;
      margin: 1rem 0;
    }

    .real-data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .real-data-source {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .real-data-stat {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .real-data-stat .value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }

    .real-data-stat .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
    }

    /* ====== ANIMATIONS ====== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .animate-in {
      animation: fadeIn 0.4s ease;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* ====== ACCESSIBILITY ====== */
    /* Focus states for all interactive elements */
    button:focus, .module-item:focus, .quiz-option:focus,
    .decision-branch:focus, input:focus, select:focus, a:focus {
      outline: 3px solid var(--gold);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --gold: #FFD700;
        --cream: #FFFFFF;
      }
    }

    /* Focus-visible styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    button:focus-visible,
    a:focus-visible,
    [role="button"]:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Screen reader only class */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ====== HAMBURGER MENU ====== */
    .hamburger {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1001;
      width: 44px;
      height: 44px;
      background: var(--navy);
      border: 2px solid var(--gold);
      border-radius: 8px;
      cursor: pointer;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .hamburger span {
      display: block;
      width: 22px;
      height: 2px;
      background: var(--gold);
      transition: all 0.3s;
    }

    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* ====== RESPONSIVE BREAKPOINTS ====== */

    /* Tablet: 768px */
    @media (max-width: 768px) {
      .hamburger {
        display: flex;
      }

      .sidebar {
        position: fixed;
        left: -320px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
        width: 280px;
      }

      .sidebar.open {
        left: 0;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }

      .top-bar {
        padding-left: 60px;
      }

      .slide-container {
        padding: 1rem;
      }

      .plot-controls {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .decision-branches {
        gap: 0.75rem;
      }

      .decision-branch {
        padding: 1rem;
        min-height: 48px;
      }

      .quiz-option {
        padding: 1rem;
        min-height: 48px;
      }

      .tool-grid {
        grid-template-columns: 1fr;
      }

      .progress-modal-content {
        width: 95%;
        max-width: none;
        margin: 1rem;
      }
    }

    /* Mobile: 480px */
    @media (max-width: 480px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .top-bar {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
        padding-left: 55px;
      }

      .top-bar-actions {
        order: 3;
        width: 100%;
        justify-content: space-around;
      }

      .top-bar-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      .slide-container {
        padding: 0.75rem;
      }

      .story-deep, .real-data-card {
        padding: 1rem;
      }

      .story-timeline {
        padding-left: 1rem;
      }

      .timeline-event {
        padding: 0.75rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .stat-item {
        padding: 0.75rem;
      }

      .stat-value {
        font-size: 1.4rem;
      }

      .principle-number {
        font-size: 3rem;
      }

      .principle-text {
        font-size: 1.3rem;
      }

      .decision-tree {
        padding: 1rem;
      }

      .decision-node {
        padding: 1rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      h3 {
        font-size: 1.1rem;
      }

      .nav-controls {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .nav-btn {
        flex: 1;
        min-width: 80px;
        padding: 0.75rem;
      }
    }

    /* ====== CERTIFICATE MODAL ====== */
    .certificate-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .certificate-modal.active {
      display: flex;
    }

    .certificate {
      background: linear-gradient(135deg, #FAF8F5, #F5F0E8);
      border: 8px solid var(--gold);
      border-radius: 8px;
      padding: 3rem;
      max-width: 700px;
      width: 100%;
      text-align: center;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .certificate::before {
      content: '';
      position: absolute;
      inset: 8px;
      border: 2px solid var(--gold);
      border-radius: 4px;
      pointer-events: none;
    }

    .certificate-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.5rem;
      color: var(--navy);
      margin-bottom: 0.5rem;
    }

    .certificate-subtitle {
      font-size: 1rem;
      color: var(--light-text);
      margin-bottom: 2rem;
    }

    .certificate-name {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2rem;
      color: var(--navy);
      margin: 1.5rem 0;
      padding: 0.5rem;
      border-bottom: 2px solid var(--gold);
      display: inline-block;
    }

    .certificate-body {
      font-size: 1rem;
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 2rem;
    }

    .certificate-date {
      font-size: 0.9rem;
      color: var(--light-text);
      margin-top: 2rem;
    }

    .certificate-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .certificate-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .certificate-btn.primary {
      background: var(--navy);
      color: white;
    }

    .certificate-btn.secondary {
      background: transparent;
      color: var(--navy);
      border: 2px solid var(--navy);
    }

    /* ====== TOOL LIBRARY MODAL ====== */
    .tool-library-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1500;
      overflow-y: auto;
      padding: 2rem;
    }

    .tool-library-modal.active {
      display: block;
    }

    .tool-library-content {
      max-width: 900px;
      margin: 0 auto;
      background: var(--deep-navy);
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,0.3);
      padding: 2rem;
    }

    .tool-library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }

    .tool-library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

    .tool-library-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tool-library-item:hover {
      background: rgba(212,175,55,0.1);
      border-color: var(--gold);
    }

    .tool-library-item h4 {
      color: var(--gold);
      margin-bottom: 0.5rem;
    }

    .tool-library-item p {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }

    /* ====== DECISION TREE PATH HISTORY ====== */
    .path-history {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .path-step {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
    }

    .path-step::after {
      content: '‚Üí';
      margin-left: 0.5rem;
      color: var(--gold);
    }

    .path-step:last-child::after {
      display: none;
    }

    .undo-btn, .restart-btn {
      padding: 0.5rem 1rem;
      background: rgba(212,175,55,0.2);
      border: 1px solid var(--gold);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .undo-btn:hover, .restart-btn:hover {
      background: rgba(212,175,55,0.3);
    }

    .tree-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* ====== TOAST NOTIFICATIONS ====== */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      animation: toastSlideIn 0.3s ease, toastFadeOut 0.3s ease 2.7s forwards;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toast.badge-toast {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }

    .toast.level-toast {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes toastFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* ====== SKIP LINK ====== */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 0.75rem 1.5rem;
      z-index: 10001;
      font-weight: 600;
      text-decoration: none;
      border-radius: 0 0 8px 0;
    }

    .skip-link:focus {
      top: 0;
    }

    /* ====== NOTIFICATION MODAL ====== */
    .notification-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .notification-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .notification-content {
      background: var(--deep-navy);
      border: 1px solid var(--gold);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
    }

    .notification-content h3 {
      color: var(--gold);
      margin-bottom: 1rem;
    }

    .notification-content p {
      color: rgba(255,255,255,0.8);
      margin-bottom: 1.5rem;
    }

    .notification-btn {
      padding: 0.75rem 2rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ====== PRINT STYLES ====== */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }

      .sidebar, .hamburger, .sidebar-overlay, .top-bar,
      .slide-nav, .dashboard-overlay, .tool-library-modal,
      .toast-container, .nav-btn, .progress-dashboard-btn,
      .daily-review-btn, .tree-controls, .skip-link {
        display: none !important;
      }

      .course-container {
        display: block !important;
      }

      .main-content {
        width: 100% !important;
        padding: 0 !important;
      }

      .slide-container {
        height: auto !important;
        overflow: visible !important;
      }

      .slide {
        display: block !important;
        opacity: 1 !important;
        page-break-after: always;
        padding: 1rem !important;
        background: white !important;
        color: black !important;
      }

      .slide-title, .method-box h3, .method-box h4 {
        color: #1E2761 !important;
      }

      .tool-panel, .quiz-container, .scenario-panel, .decision-tree {
        border: 1px solid #ccc !important;
        background: #f9f9f9 !important;
        color: black !important;
        padding: 1rem !important;
        margin: 1rem 0 !important;
      }

      .tool-btn, .quiz-option, .scenario-choice {
        border: 1px solid #666 !important;
        background: white !important;
        color: black !important;
      }

      .certificate {
        box-shadow: none !important;
        border: 2px solid var(--gold) !important;
      }
    }

    /* ====== REAL-WORLD STORY STYLES ====== */
    .real-world-story {
      background: linear-gradient(135deg, rgba(30,39,97,0.15), rgba(20,27,61,0.2));
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 16px;
      padding: 2rem;
      margin: 1rem 0;
    }

    .story-rhetorical-question {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.6rem;
      font-style: italic;
      color: var(--gold);
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(212,175,55,0.08);
      border-radius: 12px;
      line-height: 1.5;
    }

    .story-stats-box {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(212,175,55,0.4);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-stats-header {
      font-weight: 700;
      font-size: 1rem;
      color: var(--gold);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
    }

    .story-stat-item {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    .story-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--cream);
      display: block;
    }

    .story-stat-value.danger {
      color: var(--red);
    }

    .story-stat-value.success {
      color: var(--green);
    }

    .story-stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    .story-decision-tree {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-decision-header {
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-decision-scenario {
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .story-path {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .story-path.path-wrong {
      background: rgba(197,48,48,0.1);
      border-left-color: var(--red);
    }

    .story-path.path-right {
      background: rgba(34,197,94,0.1);
      border-left-color: var(--green);
    }

    .story-path-label {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .story-path.path-wrong .story-path-label {
      color: var(--red);
    }

    .story-path.path-right .story-path-label {
      color: var(--green);
    }

    .story-path-content {
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
    }

    .story-path-arrow {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
    }

    .story-revelation {
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .story-revelation-header {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-revelation-text {
      color: var(--cream);
      line-height: 1.7;
      font-size: 1.05rem;
    }

    .story-source {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .story-connection {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(15,91,106,0.2);
      border-left: 3px solid var(--teal);
      border-radius: 0 8px 8px 0;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.9);
    }
  </style>
</head>
<body>
  <!-- Toast Notification Container -->
  <div class="toast-container" id="toastContainer" aria-live="polite" aria-atomic="true"></div>

  <!-- Notification Modal (for Daily Review etc.) -->
  <div class="notification-modal" id="notificationModal" role="dialog" aria-modal="true">
    <div class="notification-content">
      <h3 id="notificationTitle">Notice</h3>
      <p id="notificationMessage">Message here</p>
      <button class="notification-btn" onclick="closeNotification()">OK</button>
    </div>
  </div>

  <!-- Skip Link for Accessibility -->
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Hamburger Menu Button (Mobile) -->
  <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle navigation menu" aria-expanded="false">
    <span></span>
    <span></span>
    <span></span>
  </button>

  <!-- Sidebar Overlay (Mobile) -->
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

  <!-- Tool Library Modal -->
  <div class="tool-library-modal" id="toolLibraryModal" role="dialog" aria-labelledby="toolLibraryTitle" aria-modal="true">
    <div class="tool-library-content">
      <div class="tool-library-header">
        <h2 id="toolLibraryTitle">üì¶ Tool Library</h2>
        <button class="close-btn" onclick="closeToolLibrary()" aria-label="Close tool library">&times;</button>
      </div>
      <div class="tool-library-grid" id="toolLibraryGrid">
        <!-- Tools populated by JS -->
      </div>
    </div>
  </div>

  <!-- Certificate Modal -->
  <div class="certificate-modal" id="certificateModal" role="dialog" aria-labelledby="certificateTitle" aria-modal="true">
    <div class="certificate">
      <h1 class="certificate-title" id="certificateTitle">Certificate of Completion</h1>
      <p class="certificate-subtitle">Meta-Analysis Methods Course</p>
      <p class="certificate-body">This certifies that</p>
      <div class="certificate-name" id="certificateName">Your Name</div>
      <p class="certificate-body">
        has successfully completed the comprehensive course<br>
        <strong>"From Question to Conclusion: A Meta-Analysis Methods Course"</strong><br><br>
        demonstrating proficiency in systematic review methodology, risk of bias assessment,<br>
        effect size calculation, heterogeneity analysis, and evidence certainty grading.
      </p>
      <p class="certificate-date" id="certificateDate"></p>
      <div class="certificate-actions">
        <button class="certificate-btn primary" onclick="downloadCertificate()">üì• Download PDF</button>
        <button class="certificate-btn secondary" onclick="closeCertificate()">Close</button>
      </div>
    </div>
  </div>

  <div class="course-container">
    <!-- SIDEBAR -->
    <nav class="sidebar" id="sidebar" aria-label="Course modules">
      <div class="sidebar-header">
        <a href="index.html" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='rgba(212,175,55,0.7)'">&larr; Course Library</a>
        <h1>Meta-Analysis Methods</h1>
        <p>From Question to Conclusion</p>
      </div>

      <div class="module-list" id="moduleList">
        <!-- Modules will be populated by JS -->
      </div>

      <div class="sidebar-footer">
        <button class="progress-dashboard-btn" onclick="openDashboard()">
          <span>üìä Progress Dashboard</span>
          <span id="sidebarPoints">0 pts</span>
        </button>
        <button class="daily-review-btn" onclick="startDailyReview()">
          <span>üîÑ</span> Daily Review
        </button>
        <div class="progress-bar-container">
          <div class="progress-label">Progress: <span id="progressPercent">0%</span></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content" id="main-content">
      <div class="top-bar">
        <div class="module-indicator" id="moduleIndicator">Module 0: The Opening</div>
        <div class="top-bar-actions">
          <button class="top-bar-btn" onclick="openToolLibrary()" aria-label="Open tool library">üîß Tools</button>
          <button class="top-bar-btn" onclick="openGlossary()" aria-label="Open glossary">üìñ Glossary</button>
          <button class="top-bar-btn primary" onclick="goToNextModule()">Next Module ‚Üí</button>
        </div>
      </div>

      <div class="slide-container" id="slideContainer">
        <!-- Slides will be populated by JS -->
      </div>

      <div class="slide-nav">
        <button class="nav-btn" id="prevBtn" onclick="prevSlide()">‚Üê Previous</button>
        <div class="slide-counter">
          <span id="slideCounter">1 / 10</span>
          <div class="slide-dots" id="slideDots"></div>
        </div>
        <button class="nav-btn primary" id="nextBtn" onclick="nextSlide()">Next ‚Üí</button>
      </div>
    </main>
  </div>

  <!-- PROGRESS DASHBOARD -->
  <div class="dashboard-overlay" id="progressDashboard" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
    <div class="dashboard-panel">
      <div class="dashboard-header" style="position: relative;">
        <button class="close-btn" onclick="closeDashboard()" aria-label="Close dashboard">√ó</button>
        <h2 id="dashboardTitle">Your Progress</h2>
        <p id="levelBadge">Level 1: Novice</p>
      </div>
      <div class="dashboard-content">
        <div class="stat-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalPoints">0</div>
            <div class="stat-label">Points</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="modulesCompleted">0/15</div>
            <div class="stat-label">Modules</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="toolsUsed">0</div>
            <div class="stat-label">Tools Used</div>
          </div>
        </div>
        <h3 style="margin-bottom: 0.75rem;">Badges</h3>
        <div class="badge-grid" id="badgeGrid">
          <!-- Badges populated by JS -->
        </div>
      </div>
    </div>
  </div>

<script>
// ============================================================
// COURSE DATA
// ============================================================

const STORAGE_KEY = 'metaAnalysisMethodsCourse';

const sevenPrinciples = [
  { num: 1, text: "The question shapes the answer", short: "Question" },
  { num: 2, text: "Pre-specification is protection", short: "Protocol" },
  { num: 3, text: "What you don't search for, you won't find", short: "Search" },
  { num: 4, text: "Every number needs a source", short: "Extract" },
  { num: 5, text: "Bias hides in plain sight", short: "Assess" },
  { num: 6, text: "The average can lie", short: "Synthesize" },
  { num: 7, text: "Certainty must be justified", short: "Certainty" }
];

// ============================================================
// BADGES SYSTEM
// ============================================================

const badges = [
  // Module completion badges
  { id: 'first_steps', name: 'First Steps', icon: 'üë£', description: 'Complete Module 0: The Opening', condition: () => gameState.modulesCompleted.includes(0) },
  { id: 'question_master', name: 'Question Master', icon: '‚ùì', description: 'Complete Module 1: The Question', condition: () => gameState.modulesCompleted.includes(1) },
  { id: 'protocol_pro', name: 'Protocol Pro', icon: 'üìã', description: 'Complete Module 2: The Protocol', condition: () => gameState.modulesCompleted.includes(2) },
  { id: 'search_sage', name: 'Search Sage', icon: 'üîç', description: 'Complete Module 3: The Search', condition: () => gameState.modulesCompleted.includes(3) },
  { id: 'screener', name: 'Study Screener', icon: 'üìä', description: 'Complete Module 4: The Selection', condition: () => gameState.modulesCompleted.includes(4) },
  { id: 'data_detective', name: 'Data Detective', icon: 'üîé', description: 'Complete Module 5: The Extraction', condition: () => gameState.modulesCompleted.includes(5) },
  { id: 'bias_hunter', name: 'Bias Hunter', icon: '‚öñÔ∏è', description: 'Complete Module 6: Risk of Bias', condition: () => gameState.modulesCompleted.includes(6) },
  { id: 'effect_expert', name: 'Effect Expert', icon: 'üìê', description: 'Complete Module 7: Effect Sizes', condition: () => gameState.modulesCompleted.includes(7) },
  { id: 'forest_ranger', name: 'Forest Ranger', icon: 'üå≤', description: 'Complete Module 8: The Forest Plot', condition: () => gameState.modulesCompleted.includes(8) },
  { id: 'heterogeneity_hero', name: 'Heterogeneity Hero', icon: 'üìà', description: 'Complete Module 9: Heterogeneity', condition: () => gameState.modulesCompleted.includes(9) },
  { id: 'pub_bias_pro', name: 'Publication Bias Pro', icon: 'üîª', description: 'Complete Module 10: Publication Bias', condition: () => gameState.modulesCompleted.includes(10) },
  { id: 'grade_guru', name: 'GRADE Guru', icon: '‚≠ê', description: 'Complete Module 11: GRADE', condition: () => gameState.modulesCompleted.includes(11) },
  { id: 'reporter', name: 'Expert Reporter', icon: 'üìù', description: 'Complete Module 12: Reporting', condition: () => gameState.modulesCompleted.includes(12) },
  { id: 'advanced_analyst', name: 'Advanced Analyst', icon: 'üß™', description: 'Complete Module 13: Advanced Methods', condition: () => gameState.modulesCompleted.includes(13) },
  { id: 'course_graduate', name: 'Course Graduate', icon: 'üéì', description: 'Complete all modules', condition: () => gameState.modulesCompleted.length >= 14 },

  // Tool usage badges
  { id: 'tool_novice', name: 'Tool Novice', icon: 'üîß', description: 'Use your first tool', condition: () => gameState.toolsUsed.length >= 1 },
  { id: 'tool_adept', name: 'Tool Adept', icon: 'üõ†Ô∏è', description: 'Use 5 different tools', condition: () => gameState.toolsUsed.length >= 5 },
  { id: 'tool_master', name: 'Tool Master', icon: '‚öôÔ∏è', description: 'Use all 11 tools', condition: () => gameState.toolsUsed.length >= 11 },

  // Quiz badges
  { id: 'quiz_starter', name: 'Quiz Starter', icon: '‚úèÔ∏è', description: 'Answer your first quiz', condition: () => Object.keys(gameState.quizAnswers).length >= 1 },
  { id: 'quiz_whiz', name: 'Quiz Whiz', icon: 'üß†', description: 'Answer 5 quizzes correctly', condition: () => Object.values(gameState.quizAnswers).filter(a => a.correct).length >= 5 },
  { id: 'perfect_score', name: 'Perfect Score', icon: 'üíØ', description: 'Answer 10 quizzes correctly', condition: () => Object.values(gameState.quizAnswers).filter(a => a.correct).length >= 10 },

  // Points badges
  { id: 'points_100', name: 'Century Club', icon: 'üí∞', description: 'Earn 100 points', condition: () => gameState.points >= 100 },
  { id: 'points_500', name: 'High Scorer', icon: 'üèÜ', description: 'Earn 500 points', condition: () => gameState.points >= 500 },
  { id: 'points_1000', name: 'Point Champion', icon: 'üëë', description: 'Earn 1000 points', condition: () => gameState.points >= 1000 },

  // Decision tree badges
  { id: 'decision_maker', name: 'Decision Maker', icon: 'üå≥', description: 'Complete your first decision tree', condition: () => Object.keys(gameState.decisionTrees).length >= 1 },
  { id: 'path_finder', name: 'Path Finder', icon: 'üó∫Ô∏è', description: 'Complete 5 decision trees', condition: () => Object.keys(gameState.decisionTrees).filter(k => gameState.decisionTrees[k].currentNode !== 'start').length >= 5 }
];

// Level thresholds
const levels = [
  { name: 'Novice', minPoints: 0 },
  { name: 'Apprentice', minPoints: 100 },
  { name: 'Practitioner', minPoints: 300 },
  { name: 'Expert', minPoints: 600 },
  { name: 'Master', minPoints: 1000 },
  { name: 'Grand Master', minPoints: 1500 }
];

const modules = [
  {
    id: 0,
    title: "The Opening",
    subtitle: "Why Methods Matter",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "From Question to Conclusion",
          subtitle: "A Meta-Analysis Methods Course",
          text: "Learn to conduct rigorous meta-analyses through the stories of those who got it wrong."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE ORIGINS: FROM THALIDOMIDE TO EVIDENCE SYNTHESIS",
          source: "Lancet 1962 (Thalidomide) | BMJ 1972 (Cochrane) | CAST 1989",
          timeline: [
            { year: "1957-61", text: "Thalidomide marketed as 'completely safe' sedative for pregnant women. Based on animal studies and manufacturer claims. No systematic human evidence required.", type: "normal" },
            { year: "1961", text: "10,000+ children born with severe birth defects. Limb malformations, organ damage, death. The drug had never been properly tested in humans.", type: "crisis" },
            { year: "1972", text: "Archie Cochrane publishes 'Effectiveness and Efficiency': 'It is surely a great criticism of our profession that we have not organized a critical summary... of all randomized controlled trials.'", type: "revelation" },
            { year: "1980s", text: "Small trials show antiarrhythmic drugs suppress PVCs after heart attacks. Meta-analyses combine them. Logic seems perfect: suppress arrhythmias ‚Üí prevent death.", type: "normal" },
            { year: "1989", text: "CAST trial stopped: antiarrhythmics TRIPLE mortality (RR 3.6, 95% CI 1.7-8.5). An estimated 50,000 Americans killed by drugs that 'worked' on a surrogate.", type: "crisis" },
            { year: "1993", text: "Cochrane Collaboration founded. Systematic evidence synthesis becomes a science. The goal: never let thalidomide or CAST happen again.", type: "revelation" }
          ],
          realData: {
            endpoint: "The birth of evidence-based medicine",
            drug: "Thalidomide: 10,000+ birth defects",
            placebo: "CAST: ~50,000 excess deaths",
            rr: "Two catastrophes from unsystematic evidence",
            ci: "Cochrane founded to prevent the third",
            nnh: "The cost of not knowing how to know"
          },
          hook: "THE HOOK: This course exists because children were born without limbs and cardiac patients died from 'effective' treatments. Evidence synthesis isn't academic. It's the boundary between healing and harm."
        }
      },
      {
        type: 'content',
        content: {
          title: "What This Course Will Teach You",
          sections: [
            {
              heading: "The Seven Principles of Sound Meta-Analysis",
              items: [
                "1. The question shapes the answer ‚Äî PICO formulation",
                "2. Pre-specification is protection ‚Äî Protocol registration",
                "3. What you don't search for, you won't find ‚Äî Comprehensive searching",
                "4. Every number needs a source ‚Äî Data integrity",
                "5. Bias hides in plain sight ‚Äî Risk of bias assessment",
                "6. The average can lie ‚Äî Heterogeneity exploration",
                "7. Certainty must be justified ‚Äî GRADE framework"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "How This Course Works",
          sections: [
            {
              heading: "Each Module Contains:",
              items: [
                "üìñ A STORY ‚Äî What went wrong and why it matters",
                "üîß THE METHOD ‚Äî How to do it correctly",
                "‚öôÔ∏è THE TOOL ‚Äî Interactive practice",
                "üîÄ THE SCENARIO ‚Äî Apply your judgment",
                "‚úÖ THE QUIZ ‚Äî Test your understanding"
              ]
            }
          ]
        }
      },
      {
        type: 'principle',
        content: {
          text: "The seven principles will recur throughout. By the end, you will not just know them ‚Äî you will feel why each one matters."
        }
      }
    ]
  },
  {
    id: 1,
    title: "The Question",
    subtitle: "PICO Framework",
    principle: 0,
    story: "CAST",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "The question shapes the answer"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVERSAL: CAST TRIAL (1989)",
          source: "NEJM 1989; 321:406-412 | PubMed: 2473403",
          timeline: [
            { year: "1970s", text: "Observational studies link PVCs after MI to sudden cardiac death. The mechanistic chain seems obvious.", type: "normal" },
            { year: "1980s", text: "Class I antiarrhythmic drugs shown to suppress PVCs by 80%+. Logic: suppress PVCs ‚Üí prevent death.", type: "normal" },
            { year: "1987", text: "CAST trial begins. 1,727 patients randomized to encainide, flecainide, or placebo.", type: "normal" },
            { year: "Apr 1989", text: "DSMB stops trial early. Arrhythmic death: 4.5% vs 1.2%. RR = 3.6 (95% CI: 1.7-8.5).", type: "crisis" },
            { year: "1989-91", text: "Estimated 50,000+ Americans died from these 'effective' drugs. The surrogate endpoint deceived everyone.", type: "crisis" },
            { year: "Legacy", text: "CAST transformed cardiology. FDA now requires mortality outcomes for cardiac drugs.", type: "revelation" }
          ],
          realData: {
            endpoint: "Arrhythmic death or cardiac arrest",
            drug: "56/730 (7.7%)",
            placebo: "22/725 (3.0%)",
            rr: "2.5",
            ci: "1.6-4.0",
            nnh: "22"
          },
          hook: "They asked: 'Does it suppress arrhythmias?' (Yes, beautifully.) They should have asked: 'Does it help patients live?' (No. It killed them.)"
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: CAST killed 50,000 people because researchers measured the wrong outcome. A surrogate endpoint (arrhythmia suppression) moved in the right direction while patients moved toward death. Before you analyze anything, ask: Does my outcome actually matter to patients?"
        }
      },
      {
        type: 'content',
        content: {
          title: "The Wrong Question vs. The Right Question",
          sections: [
            {
              heading: "What They Asked:",
              items: [
                "Population: Post-MI patients with PVCs",
                "Intervention: Encainide/Flecainide",
                "Comparator: Placebo",
                "Outcome: PVC suppression ‚Üê SURROGATE"
              ]
            },
            {
              heading: "What They Should Have Asked:",
              items: [
                "Population: Post-MI patients with PVCs",
                "Intervention: Encainide/Flecainide",
                "Comparator: Placebo",
                "Outcome: All-cause mortality ‚Üê PATIENT-IMPORTANT"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: PICO FRAMEWORK",
          title: "Formulating the Right Question",
          sections: [
            {
              heading: "P ‚Äî Population",
              text: "Who exactly are you studying? Be specific about inclusion criteria, disease severity, setting."
            },
            {
              heading: "I ‚Äî Intervention",
              text: "What treatment, exposure, or test? Include dose, duration, delivery method."
            },
            {
              heading: "C ‚Äî Comparator",
              text: "Compared to what? Placebo, active control, usual care, no intervention?"
            },
            {
              heading: "O ‚Äî Outcome",
              text: "What matters to patients? Prioritize: mortality > morbidity > symptoms > surrogates"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'pico-builder',
          title: "PICO Builder",
          description: "Practice formulating your research question"
        }
      },
      {
        type: 'content',
        content: {
          title: "THE GRAVEYARD: When Surrogates Killed",
          sections: [
            {
              heading: "CAST (1989) ‚Äî Cardiac Arrhythmias",
              items: [
                "Surrogate: PVC suppression (drugs reduced arrhythmias by 80%+)",
                "Reality: Mortality TRIPLED (RR 3.6, 95% CI: 1.7-8.5)",
                "Estimated 50,000 Americans killed by 'effective' drugs",
                "THE LESSON: Arrhythmias predict death, but suppressing them doesn't prevent it"
              ]
            },
            {
              heading: "ATBC (1994) ‚Äî Beta-Carotene in Smokers",
              items: [
                "Surrogate: Antioxidant blood levels (increased as expected)",
                "Reality: Lung cancer INCREASED by 16% (RR 1.16, 95% CI: 1.02-1.33)",
                "29,133 Finnish male smokers harmed by a vitamin",
                "Source: JNCI 1996; PubMed 8901854"
              ]
            },
            {
              heading: "CARET (1996) ‚Äî Beta-Carotene + Vitamin A",
              items: [
                "Surrogate: Same antioxidant rationale as ATBC",
                "Reality: Lung cancer INCREASED by 28% (RR 1.28, 95% CI: 1.04-1.57)",
                "Trial stopped early for HARM ‚Äî supplements were killing participants",
                "Source: NEJM 1996; DOI 10.1056/NEJM199605023341802"
              ]
            },
            {
              heading: "THE PATTERN: Mechanistic Logic Fails",
              items: [
                "Arrhythmias ‚Üí death, but anti-arrhythmics don't help",
                "Oxidative stress ‚Üí cancer, but antioxidants don't help (and may harm)",
                "Cholesterol ‚Üí heart disease, but some cholesterol drugs kill",
                "THE QUESTION to always ask: Does improving the surrogate actually help patients?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'pico_decision_tree',
          title: "The Diabetes Drug Decision",
          situation: "You're the lead methodologist for a meta-analysis. A pharmaceutical company's new diabetes drug shows impressive HbA1c reduction across 8 trials. They want FDA approval.",
          nodes: [
            {
              id: 'start',
              question: "The company asks you to use HbA1c reduction as the primary outcome. What do you do?",
              branches: [
                { id: 'a', text: "Accept ‚Äî HbA1c is the standard diabetes endpoint", nextNode: 'surrogate_trap' },
                { id: 'b', text: "Insist on cardiovascular outcomes", nextNode: 'cv_outcome' },
                { id: 'c', text: "Ask what outcomes they have data for", nextNode: 'investigate' }
              ]
            },
            {
              id: 'surrogate_trap',
              type: 'outcome',
              consequence: 'bad',
              title: "The Rosiglitazone Repeat",
              text: "Your meta-analysis shows impressive HbA1c reduction: -1.2% (95% CI: -1.4 to -1.0). FDA approves. Three years later, an independent meta-analysis of CV outcomes finds OR 1.43 (95% CI: 1.03-1.98) for MI. The drug is withdrawn. You asked the wrong question.",
              realCase: "This exact scenario happened with rosiglitazone (Avandia). Nissen & Wolski, NEJM 2007."
            },
            {
              id: 'cv_outcome',
              type: 'outcome',
              consequence: 'good',
              title: "The Right Question",
              text: "Your meta-analysis of CV outcomes reveals: MACE HR 0.86 (95% CI: 0.74-0.99). Not only does the drug lower HbA1c, it actually prevents heart attacks. You've distinguished it from harmful drugs in the same class.",
              realCase: "This is what empagliflozin (EMPA-REG) and liraglutide (LEADER) showed ‚Äî but only because they asked the right question."
            },
            {
              id: 'investigate',
              question: "Good thinking. You discover they have CV outcome data but it wasn't pre-specified as primary. They say 'We can run those analyses too.' What now?",
              branches: [
                { id: 'd', text: "Add CV outcomes as an exploratory analysis", nextNode: 'exploratory' },
                { id: 'e', text: "Make CV outcomes the pre-specified primary outcome in a new protocol", nextNode: 'cv_outcome' },
                { id: 'f', text: "Proceed with HbA1c ‚Äî the CV data is post-hoc anyway", nextNode: 'surrogate_trap' }
              ]
            },
            {
              id: 'exploratory',
              type: 'outcome',
              consequence: 'neutral',
              title: "Partial Credit",
              text: "Your meta-analysis is published with HbA1c primary and CV secondary/exploratory. Reviewers note the CV findings but can't draw strong conclusions because it wasn't pre-specified. The signal is there, but the evidence is weaker than it could be.",
              realCase: "Many early diabetes meta-analyses had this problem ‚Äî valuable CV data buried as exploratory analyses."
            }
          ]
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "Have you considered what happens when the question itself is wrong?",
          context: "In the 1980s, researchers observed that premature ventricular contractions (PVCs) after heart attacks predicted sudden death. The logic seemed airtight: suppress PVCs, prevent death. They designed a trial to answer: 'Do antiarrhythmics that suppress PVCs reduce sudden death?' The drugs worked beautifully on the surrogate. But they asked the wrong question.",
          stats: [
            { value: "80%+", label: "PVC Suppression", type: "" },
            { value: "3.6x", label: "Mortality Increase", type: "danger" },
            { value: "~50,000", label: "Americans Killed", type: "danger" },
            { value: "1989", label: "Trial Stopped", type: "" }
          ],
          source: "CAST Trial - NEJM 1989; 321:406-412",
          decisionScenario: "You are designing a trial for a new arrhythmia drug. The drug suppresses PVCs magnificently in Phase II studies. You must choose your primary endpoint.",
          pathA: {
            title: "Use surrogate endpoint (PVC suppression)",
            steps: [
              "Trial shows 80% PVC suppression",
              "Drug appears highly effective",
              "FDA approves based on surrogate",
              "Millions of patients prescribed the drug",
              "Post-marketing: Mortality TRIPLES",
              "An estimated 50,000 Americans die from 'effective' treatment"
            ]
          },
          pathB: {
            title: "Insist on hard endpoint (mortality)",
            steps: [
              "Trial takes longer and costs more",
              "Requires larger sample size",
              "DSMB stops trial early for harm",
              "Drug never reaches market",
              "50,000 lives saved",
              "The truth is revealed before, not after, the damage"
            ]
          },
          revelation: "The PICO determines what you can learn. A well-answered wrong question is worse than no answer. CAST asked 'Does it suppress arrhythmias?' (Yes.) They should have asked 'Does it help patients live?' (No ‚Äî it killed them.) The question shapes the answer, and the wrong question shaped 50,000 deaths.",
          moduleConnection: "This is why PICO matters. Your outcome choice is not technical ‚Äî it is ethical. Every meta-analysis inherits the flaws of the questions its component trials asked."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A meta-analysis asks: 'Does Drug X reduce blood pressure?' vs 'Does Drug X reduce strokes and heart attacks?' Which framing is more likely to produce clinically useful results?",
          options: [
            { id: 'a', text: "Blood pressure ‚Äî it's easier to measure", correct: false },
            { id: 'b', text: "Strokes and heart attacks ‚Äî they're what matter to patients", correct: true },
            { id: 'c', text: "Both are equally useful", correct: false },
            { id: 'd', text: "Neither ‚Äî we need all-cause mortality", correct: false }
          ],
          explanation: "While all-cause mortality is ideal, cardiovascular events are patient-important outcomes that blood pressure (a surrogate) may or may not predict. SPRINT showed intensive BP control reduced CV events, but ACCORD-BP did not ‚Äî you can't know from BP alone."
        }
      }
    ]
  },
  {
    id: 2,
    title: "The Protocol",
    subtitle: "Pre-registration",
    principle: 1,
    story: "HRT",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Pre-specification is protection"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVERSAL: HRT ‚Äî THE BIGGEST FLIP IN MEDICINE",
          source: "JAMA 2002; 288:321-333 | WHI Writing Group | PubMed: 12117397",
          timeline: [
            { year: "1960s-80s", text: "Observational studies consistently show HRT reduces CHD by 40-50%. The biological rationale is compelling: estrogen improves lipid profiles.", type: "normal" },
            { year: "1991", text: "NHS (Nurses' Health Study) publishes: RR 0.56 (95% CI 0.40-0.80) for CHD. Millions of women start HRT for 'heart protection.'", type: "normal" },
            { year: "1998", text: "HERS trial shocks the field: No benefit in women with existing CHD. HR 0.99 (0.81-1.22). But it's dismissed ‚Äî 'wrong population.'", type: "crisis" },
            { year: "Jul 2002", text: "WHI stopped early for HARM. CHD HR 1.29 (1.02-1.63). The 30+ observational studies were WRONG.", type: "crisis" },
            { year: "The Truth", text: "Healthy user bias: Women who chose HRT were healthier, exercised more, had better diets. The 'benefit' was confounding, not causation.", type: "revelation" }
          ],
          realData: {
            endpoint: "Coronary heart disease (CHD)",
            drug: "164/8506 (1.93%)",
            placebo: "122/8102 (1.51%)",
            rr: "1.29",
            ci: "1.02-1.63",
            nnh: "238"
          },
          hook: "30 observational studies. 40+ meta-analyses. All showing benefit. Then the randomized trial showed harm. Confounding, healthy-user effects, and selective analysis/reporting can mislead when methods are not locked and fully transparent."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: HRT was the biggest reversal in modern medicine. Millions of women took hormones believing they prevented heart disease ‚Äî but the 'evidence' came from researchers who could change their analyses after seeing results. Pre-registration locks your decisions BEFORE you see the data, making bias visible and accountability possible."
        }
      },
      {
        type: 'content',
        content: {
          title: "Why Pre-Registration Matters",
          sections: [
            {
              heading: "Without Pre-Registration:",
              items: [
                "Outcome switching ‚Äî change endpoints after seeing data",
                "Subgroup fishing ‚Äî test many subgroups, report 'significant' ones",
                "Analysis flexibility ‚Äî try different models until one 'works'",
                "Selective reporting ‚Äî publish positive, hide negative"
              ]
            },
            {
              heading: "With Pre-Registration:",
              items: [
                "Primary outcome locked before data analysis",
                "Subgroups pre-specified with rationale",
                "Analysis plan documented",
                "All results must be reported"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: PROSPERO REGISTRATION",
          title: "Creating a Protocol",
          sections: [
            {
              heading: "Essential Elements:",
              text: "1. PICO question\n2. Eligibility criteria\n3. Search strategy\n4. Data extraction plan\n5. Risk of bias tool\n6. Synthesis method\n7. Subgroup analyses (pre-specified)\n8. Sensitivity analyses"
            },
            {
              heading: "Where to Register:",
              text: "PROSPERO (prospero.york.ac.uk) ‚Äî free, international, searchable registry for systematic reviews. Registration creates a timestamp proving your plan preceded your analysis."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'protocol_decision_tree',
          title: "The HARKing Temptation",
          situation: "You're conducting a meta-analysis of a new antihypertensive drug. Your protocol specified 'cardiovascular events' as the primary outcome. After extracting data, you notice the drug seems to particularly help diabetic patients ‚Äî an unplanned subgroup.",
          nodes: [
            {
              id: 'start',
              question: "Your co-author wants to highlight the diabetic subgroup finding in the abstract. What do you do?",
              branches: [
                { id: 'a', text: "Add it as a key finding ‚Äî the signal is strong", nextNode: 'harking_trap' },
                { id: 'b', text: "Report as exploratory, clearly labeled post-hoc", nextNode: 'proper_reporting' },
                { id: 'c', text: "Run more subgroups to see if the pattern holds", nextNode: 'fishing_expedition' }
              ]
            },
            {
              id: 'harking_trap',
              type: 'outcome',
              consequence: 'bad',
              title: "The HARKing Trap",
              text: "You've committed HARKing ‚Äî Hypothesizing After Results are Known. Your 'discovery' has a ~40% false positive rate due to multiple testing. When a replication study fails to confirm it, your credibility suffers.",
              realCase: "ISIS-2 famously showed aspirin only worked for Geminis and Libras ‚Äî an obvious false positive that illustrates why post-hoc subgroups are unreliable."
            },
            {
              id: 'proper_reporting',
              question: "Good choice. But the journal editor pushes back: 'The diabetic finding is the most interesting part. Can you make it more prominent?' What now?",
              branches: [
                { id: 'd', text: "Agree to emphasize it in the title/abstract", nextNode: 'editor_pressure' },
                { id: 'e', text: "Explain the statistical concerns and hold firm", nextNode: 'integrity_win' },
                { id: 'f', text: "Withdraw and try a different journal", nextNode: 'withdraw' }
              ]
            },
            {
              id: 'fishing_expedition',
              type: 'outcome',
              consequence: 'bad',
              title: "The Fishing Expedition",
              text: "You run 15 subgroup analyses. Three show 'significant' results (p < 0.05). But with 15 tests, you'd expect ~1 false positive by chance alone. You've found noise, not signal. Your meta-analysis becomes unreliable.",
              realCase: "The ACCORD trial ran multiple subgroups ‚Äî finding 'benefit' in some and 'harm' in others. Most were statistical artifacts."
            },
            {
              id: 'editor_pressure',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Compromise",
              text: "The paper is published with the diabetic subgroup prominent. Clinicians start preferentially prescribing to diabetics. Years later, a dedicated trial in diabetics shows no special benefit. Your meta-analysis contributed to misguided clinical practice.",
              realCase: "Many drugs showed 'subgroup benefits' in meta-analyses that vanished in dedicated trials."
            },
            {
              id: 'integrity_win',
              type: 'outcome',
              consequence: 'good',
              title: "Scientific Integrity Wins",
              text: "You explain that exploratory findings require confirmation. The paper is published with appropriate caveats. A subsequent trial specifically tests the diabetic hypothesis and confirms the finding ‚Äî now with proper pre-specification. You're credited for identifying a hypothesis worth testing.",
              realCase: "This is how science should work: exploratory findings generate hypotheses; confirmatory trials test them."
            },
            {
              id: 'withdraw',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Principled Retreat",
              text: "Another journal accepts the paper with appropriate exploratory labeling. It takes longer but maintains scientific rigor. The finding is eventually tested in a dedicated trial.",
              realCase: "Sometimes the right choice means accepting slower publication for better science."
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "What is the primary purpose of registering a systematic review protocol on PROSPERO before beginning data extraction?",
          options: [
            { id: 'a', text: "To claim priority over other researchers", correct: false },
            { id: 'b', text: "To prevent outcome switching and selective reporting", correct: true },
            { id: 'c', text: "To get ethical approval", correct: false },
            { id: 'd', text: "To ensure adequate sample size", correct: false }
          ],
          explanation: "Protocol registration creates a timestamp that proves your outcomes, subgroups, and analyses were specified before you saw the data. This prevents HARKing and p-hacking, which inflate false positive rates."
        }
      }
    ]
  },
  {
    id: 3,
    title: "The Search",
    subtitle: "Finding All Evidence",
    principle: 2,
    story: "Rosiglitazone",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "What you don't search for, you won't find"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVERSAL: ROSIGLITAZONE ‚Äî HIDING IN PLAIN SIGHT",
          source: "NEJM 2007; 356:2457-2471 | Nissen & Wolski | PubMed: 17517853",
          timeline: [
            { year: "1999", text: "FDA approves rosiglitazone (Avandia) for diabetes based on HbA1c reduction. It becomes a blockbuster ‚Äî $3 billion/year in sales.", type: "normal" },
            { year: "2000-06", text: "GSK conducts 42 trials. Many show concerning CV signals. Most are never published. The data sits in FDA files and ClinicalTrials.gov.", type: "normal" },
            { year: "May 2007", text: "Nissen searches FDA submissions, ClinicalTrials.gov, and asks GSK for unpublished data. He finds what others missed.", type: "revelation" },
            { year: "May 2007", text: "Meta-analysis published: OR 1.43 (1.03-1.98) for MI. The cardiac harm was visible in unpublished data for YEARS.", type: "crisis" },
            { year: "2010-11", text: "FDA restricts use. European regulators suspend marketing. Estimated 47,000 excess heart attacks caused.", type: "crisis" }
          ],
          realData: {
            endpoint: "Myocardial infarction",
            drug: "86/15,560 (0.55%)",
            placebo: "72/12,283 (0.59%)",
            rr: "1.43",
            ci: "1.03-1.98",
            nnh: "52"
          },
          hook: "The signal was there in 2000. It took 7 years and a researcher willing to search beyond PubMed to find it. How many died waiting?"
        }
      },
      {
        type: 'content',
        content: {
          title: "Where Evidence Hides",
          sections: [
            {
              heading: "Published Literature (What Most Searches Find):",
              items: [
                "PubMed/MEDLINE ‚Äî biomedical journals",
                "EMBASE ‚Äî European/drug focus",
                "CENTRAL ‚Äî Cochrane's trial registry"
              ]
            },
            {
              heading: "Grey Literature (What Most Searches Miss):",
              items: [
                "ClinicalTrials.gov ‚Äî registered trials, many unpublished",
                "FDA/EMA submissions ‚Äî regulatory data not in journals",
                "WHO ICTRP ‚Äî international trial registry",
                "Conference abstracts ‚Äî preliminary data",
                "Theses/dissertations ‚Äî negative results often here",
                "Manufacturer data ‚Äî FOIA requests may be needed"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: COMPREHENSIVE SEARCHING",
          title: "Building a Search Strategy",
          sections: [
            {
              heading: "Step 1: Identify Concepts",
              text: "Break your PICO into searchable concepts. For rosiglitazone + cardiovascular: (rosiglitazone OR Avandia) AND (myocardial infarction OR heart attack OR cardiovascular)"
            },
            {
              heading: "Step 2: Expand with Synonyms",
              text: "Use MeSH terms, brand names, generic names, spelling variants. Miss one synonym, miss studies."
            },
            {
              heading: "Step 3: Search Multiple Sources",
              text: "Minimum: MEDLINE + EMBASE + CENTRAL + trial registries + reference checking. Better: add grey literature, contact experts."
            },
            {
              heading: "Step 4: Document Everything",
              text: "Record exact search strings, dates, results. Reproducibility requires transparency."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'search-builder',
          title: "Search Strategy Builder",
          description: "Build database-specific search strings from your PICO"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'search_decision_tree',
          title: "The Hunt for Hidden Data",
          situation: "You're meta-analyzing a diabetes drug (similar to rosiglitazone). PubMed gives you 15 trials showing benefit. But ClinicalTrials.gov shows 23 registered trials. Eight completed trials have no publications.",
          nodes: [
            {
              id: 'start',
              question: "You've found 8 missing trials. The deadline is tight. What's your first move?",
              branches: [
                { id: 'a', text: "Proceed with 15 published trials ‚Äî they're peer-reviewed", nextNode: 'proceed_published' },
                { id: 'b', text: "Contact the manufacturer for unpublished data", nextNode: 'contact_manufacturer' },
                { id: 'c', text: "Search FDA approval documents and advisory committee briefings", nextNode: 'search_fda' }
              ]
            },
            {
              id: 'proceed_published',
              type: 'outcome',
              consequence: 'bad',
              title: "The Rosiglitazone Repeat",
              text: "Your meta-analysis shows benefit (RR 0.85, CI 0.78-0.93). It's published in a top journal. Three years later, someone finds the missing trials in FDA archives. They showed HARM. Your meta-analysis misled thousands of clinicians.",
              realCase: "This is exactly what happened with rosiglitazone. The published literature showed glucose benefit. The hidden data showed cardiac harm."
            },
            {
              id: 'contact_manufacturer',
              question: "The manufacturer responds: 'We can share summary data but not patient-level data, and it will take 6 months.' Meanwhile, your competitor is about to publish their meta-analysis using only published data.",
              branches: [
                { id: 'd', text: "Rush to publish first with available data", nextNode: 'rush_publish' },
                { id: 'e', text: "Wait for manufacturer data, even if scooped", nextNode: 'wait_data' },
                { id: 'f', text: "Publish now but pre-register an update when data arrives", nextNode: 'staged_approach' }
              ]
            },
            {
              id: 'search_fda',
              question: "You find FDA briefing documents! They contain data from 6 of the 8 missing trials. The cardiac safety data is concerning ‚Äî elevated events in 4 of 6 trials. What now?",
              branches: [
                { id: 'g', text: "Include the FDA data in your meta-analysis", nextNode: 'include_fda' },
                { id: 'h', text: "The FDA data quality is unclear ‚Äî stick to published only", nextNode: 'proceed_published' },
                { id: 'i', text: "Run parallel analyses with and without FDA data", nextNode: 'sensitivity_analysis' }
              ]
            },
            {
              id: 'rush_publish',
              type: 'outcome',
              consequence: 'bad',
              title: "The Race to the Bottom",
              text: "You beat your competitor by 2 months. But both meta-analyses are incomplete. When the full data emerges, both are shown to be biased. Your reputation for rigor suffers.",
              realCase: "The academic incentive to publish first often conflicts with the scientific need to be complete."
            },
            {
              id: 'wait_data',
              type: 'outcome',
              consequence: 'good',
              title: "Patience Wins",
              text: "Your competitor publishes first with incomplete data. You wait. When your complete meta-analysis appears, it reveals the cardiac safety signal they missed. Your paper becomes the definitive reference. Clinical guidelines cite YOU.",
              realCase: "Nissen's rosiglitazone meta-analysis succeeded because he waited for FDA data that others ignored."
            },
            {
              id: 'staged_approach',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Pragmatic Middle Ground",
              text: "You publish preliminary findings with clear limitations, pre-registering an update. This is honest but risks the preliminary findings being over-interpreted. When the update shows different results, some see it as 'flip-flopping.'",
              realCase: "Living systematic reviews use this approach, but managing the communication is challenging."
            },
            {
              id: 'include_fda',
              type: 'outcome',
              consequence: 'good',
              title: "The Complete Picture",
              text: "Your meta-analysis includes FDA data. The pooled effect shifts: RR 1.15 (0.98-1.35) ‚Äî no longer showing benefit, trend toward harm. You've revealed the truth hidden in grey literature. Regulators take notice.",
              realCase: "Nissen's rosiglitazone analysis used FDA data that transformed a 'beneficial' drug into a dangerous one."
            },
            {
              id: 'sensitivity_analysis',
              type: 'outcome',
              consequence: 'good',
              title: "Transparency Through Sensitivity",
              text: "Your paper shows: Published only: RR 0.85 (benefit). With FDA data: RR 1.15 (trend to harm). The contrast is stark. Readers can see how publication bias distorts the evidence. Your paper becomes a teaching example.",
              realCase: "The best meta-analyses show how results change with different inclusion decisions."
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Why is searching ClinicalTrials.gov essential even if you have a comprehensive MEDLINE search?",
          options: [
            { id: 'a', text: "It has better search functionality than MEDLINE", correct: false },
            { id: 'b', text: "It contains registered trials that may never be published", correct: true },
            { id: 'c', text: "It has more recent publications", correct: false },
            { id: 'd', text: "It's required by PRISMA but not actually useful", correct: false }
          ],
          explanation: "About 50% of registered trials are never published, and unpublished trials are more likely to have negative or harmful results. ClinicalTrials.gov reveals what's missing from the published literature."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've mastered the FOUNDATION of meta-analysis.\n\n‚úì Module 1: The right QUESTION (PICO) ‚Äî learned from CAST's surrogate trap\n‚úì Module 2: PROTOCOL registration ‚Äî learned from HRT's healthy user bias\n‚úì Module 3: COMPREHENSIVE search ‚Äî learned from rosiglitazone's hidden data\n\nNext: You'll learn to SCREEN, EXTRACT, and ASSESS the studies you find.\n\nThe first three principles protect you from asking the wrong question. The next four protect you from getting the wrong answer."
        }
      }
    ]
  },
  // Module 4: The Screen
  {
    id: 4,
    title: "The Screen",
    subtitle: "Study Selection",
    principle: 3,
    story: "Vitamin E",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Every number needs a source"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE CONTRADICTION: VITAMIN E ‚Äî SAVIOR OR KILLER?",
          source: "Annals Int Med 2005; 142:37-46 | Miller et al | PubMed: 15537682",
          timeline: [
            { year: "1993", text: "NHANES observational data suggests vitamin E reduces heart disease. Supplement sales soar to $600M/year.", type: "normal" },
            { year: "1996-2004", text: "Multiple RCTs completed: ATBC, GISSI, HOPE, HPS. Results are mixed, confusing.", type: "normal" },
            { year: "2004 (Jan)", text: "Meta-analysis A: Vitamin E 'may prevent' CVD. Includes 7 trials with any dose. RR 0.89 (0.80-0.99).", type: "normal" },
            { year: "2004 (Nov)", text: "Meta-analysis B: Vitamin E INCREASES mortality at high doses (‚â•400 IU). RR 1.04 (1.01-1.07). Uses dose-response analysis.", type: "crisis" },
            { year: "The Truth", text: "Same trials, different inclusion criteria, opposite conclusions. The meta-analyst's choices determined the answer before analysis began.", type: "revelation" }
          ],
          realData: {
            endpoint: "All-cause mortality",
            drug: "High-dose vitamin E (‚â•400 IU/d)",
            placebo: "Control",
            rr: "1.04",
            ci: "1.01-1.07",
            nnh: "200"
          },
          hook: "Two honest researchers. Same year. Same trials. Opposite conclusions. The only difference: their inclusion criteria. Every eligibility decision is a hidden hypothesis."
        }
      },
      {
        type: 'content',
        content: {
          title: "Eligibility Criteria: The Hidden Thesis",
          sections: [
            {
              heading: "What Inclusion Criteria Do:",
              items: [
                "Define your population (which patients count?)",
                "Define adequate intervention (what dose? duration?)",
                "Define meaningful comparisons (what controls?)",
                "Define credible evidence (RCTs only? Observational?)"
              ]
            },
            {
              heading: "What Can Go Wrong:",
              items: [
                "Too broad: noise drowns signal",
                "Too narrow: cherry-picking",
                "Vague criteria: inconsistent application",
                "Post-hoc changes: bias toward desired result"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: SYSTEMATIC SCREENING",
          title: "From Thousands to Included",
          sections: [
            {
              heading: "Step 1: Operationalize Criteria",
              text: "Convert PICO into testable inclusion/exclusion rules. 'Adults with diabetes' becomes 'Age ‚â•18, diagnosis of T1DM or T2DM per ADA criteria, any setting.'"
            },
            {
              heading: "Step 2: Dual Screening",
              text: "Two reviewers independently screen titles/abstracts, then full texts. Calculate agreement (kappa). Disagreements resolved by discussion or third reviewer."
            },
            {
              heading: "Step 3: Document Decisions",
              text: "Record reason for every exclusion. PRISMA flow diagram shows: identified ‚Üí screened ‚Üí eligible ‚Üí included, with exclusion reasons."
            },
            {
              heading: "Step 4: Handle Borderline Cases",
              text: "Pre-specify rules for ambiguous situations. When in doubt, include for full-text review. Report sensitivity analyses with/without borderline studies."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'prisma-flow',
          title: "PRISMA Flow Generator",
          description: "Create a PRISMA 2020 flow diagram documenting your screening process"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'screen_decision_tree',
          title: "The Borderline Study",
          scenario: "You've screened 2,847 records for your meditation-anxiety meta-analysis. 23 studies are clearly included. But one study ‚Äî MBSR with yoga components ‚Äî sits at the boundary. Your protocol said 'meditation interventions' but didn't specifically address mindfulness programs with mixed components.",
          realCase: "The Vitamin E meta-analyses of the 2000s showed dramatically different conclusions based on inclusion criteria. Miller et al. included only high-dose trials and found increased mortality. Others, using broader criteria, found no harm.",
          nodes: {
            start: {
              id: 'start',
              situation: "The borderline MBSR study (n=89) shows SMD = -0.15 (small effect). Your current 23 studies give SMD = -0.42 (p = 0.03). With this study: SMD = -0.38 (p = 0.07).",
              question: "Your first instinct?",
              branches: [
                { id: 'exclude_path', text: "Exclude it ‚Äî doesn't meet strict criteria", nextNode: 'exclude_consequence' },
                { id: 'include_path', text: "Include it ‚Äî MBSR is close enough", nextNode: 'include_consequence' },
                { id: 'investigate_path', text: "Wait ‚Äî I should check my protocol first", nextNode: 'check_protocol' }
              ]
            },
            exclude_consequence: {
              id: 'exclude_consequence',
              situation: "You exclude the study. Your result becomes significant (p = 0.03). The paper is accepted. Six months later, a reader emails: 'Your supplementary table shows 3 other included studies also had yoga components. Why was this one excluded?'",
              question: "How do you respond?",
              branches: [
                { id: 'admit_error', text: "Acknowledge the inconsistency", nextNode: 'inconsistency_lesson' },
                { id: 'defend_decision', text: "Defend my original decision", nextNode: 'defense_fails' }
              ]
            },
            inconsistency_lesson: {
              id: 'inconsistency_lesson',
              situation: "You realize you applied criteria inconsistently ‚Äî keeping other mixed-component studies while excluding this one. The common factor? This study's effect diluted your result.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE WARNING: Post-hoc exclusion that conveniently improves results is a form of selection bias. The Vitamin E controversies taught us: inclusion criteria must be applied blindly to results. Once you see the data, you can't unsee it."
            },
            defense_fails: {
              id: 'defense_fails',
              situation: "You argue the yoga component was 'more prominent' in this study. The reader replies: 'I checked ‚Äî Study 7 in your analysis had 40% yoga time. The excluded study had 30%.' You have no objective justification.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: Inconsistent application of criteria without documentation undermines your entire analysis. This is how the Vitamin E meta-analyses lost credibility ‚Äî readers couldn't tell which exclusions were principled vs. convenient."
            },
            include_consequence: {
              id: 'include_consequence',
              situation: "You include the study. Your pooled SMD = -0.38 (95% CI: -0.79 to 0.03, p = 0.07). A reviewer writes: 'The result is not statistically significant. This seems like a negative finding.'",
              question: "How do you frame this in your discussion?",
              branches: [
                { id: 'negative_framing', text: "Meditation shows no significant benefit for anxiety", nextNode: 'oversimplified' },
                { id: 'nuanced_framing', text: "Report sensitivity analysis and discuss borderline decision", nextNode: 'transparency_win' }
              ]
            },
            oversimplified: {
              id: 'oversimplified',
              situation: "Your paper concludes 'meditation was not effective.' But the effect size was moderate (SMD = -0.38) with wide CI. A different meta-analysis, excluding the borderline study, concludes 'meditation is effective.' Now there are contradictory reviews.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: Remember the Vitamin E story ‚Äî different inclusion criteria led to opposite conclusions. Neither was wrong, but neither told the whole truth. The borderline study's status should have been explicitly discussed."
            },
            transparency_win: {
              id: 'transparency_win',
              situation: "Your paper reports: 'In primary analysis (24 studies), SMD = -0.38 (p = 0.07). In sensitivity analysis excluding one borderline MBSR study, SMD = -0.45 (p = 0.03). Conclusions are sensitive to this decision.' Reviewers praise the transparency.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: By showing both analyses, you let readers see the truth: the evidence is at the borderline. Some will find this unsatisfying. But honest uncertainty beats false precision. This is how meta-analysis should work."
            },
            check_protocol: {
              id: 'check_protocol',
              situation: "You check your PROSPERO registration. It says: 'Meditation interventions including mindfulness-based programs.' MBSR is a mindfulness-based program. But you realize you didn't pre-specify what to do about mixed components.",
              question: "What's your next step?",
              branches: [
                { id: 'protocol_amendment', text: "File a protocol amendment and document the decision", nextNode: 'good_process' },
                { id: 'retroactive_rule', text: "Decide now based on the data", nextNode: 'biased_decision' }
              ]
            },
            good_process: {
              id: 'good_process',
              situation: "You file an amendment: 'Studies with ‚â•50% meditation time will be included; others in sensitivity analysis.' The borderline study has 70% meditation time. You include it. You document this BEFORE seeing its effect on your pooled estimate.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Pre-specification protects you from yourself. By setting the rule before seeing its consequences, you remove the temptation to game the inclusion criteria. This is Principle 2: 'Pre-specification is protection.'"
            },
            biased_decision: {
              id: 'biased_decision',
              situation: "You look at the data first. The borderline study dilutes your effect. You decide to exclude it. But now your decision is contaminated ‚Äî you can't unknow that excluding it makes your result significant.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE HOOK RETURNS: This is exactly how the Vitamin E controversies began. Researchers made 'reasonable' decisions that happened to align with their preferred conclusions. The sequence matters: rules first, data second."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Two independent reviewers screen 500 abstracts. Reviewer A includes 45, Reviewer B includes 52, and they agree on 38. What does this suggest?",
          options: [
            { id: 'a', text: "Excellent agreement ‚Äî proceed to full-text", correct: false },
            { id: 'b', text: "Moderate agreement ‚Äî discuss disagreements, clarify criteria", correct: true },
            { id: 'c', text: "Poor agreement ‚Äî start over with new reviewers", correct: false },
            { id: 'd', text: "Agreement can't be assessed from this information", correct: false }
          ],
          explanation: "This represents a kappa around 0.65 (moderate agreement). Disagreements on 21 abstracts (14+7) need discussion. Often, vague criteria cause inconsistency ‚Äî clarifying them improves reliability for future screening."
        }
      }
    ]
  },
  // Module 5: The Extract
  {
    id: 5,
    title: "The Extract",
    subtitle: "Data Extraction",
    principle: 3,
    story: "DECREASE",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Every number needs a source"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE FRAUD: DECREASE ‚Äî WHEN DATA IS TOO GOOD",
          source: "Erasmus MC Investigation 2012 | Eur Heart J 2014; 35:1972-1973",
          timeline: [
            { year: "1999", text: "Poldermans publishes DECREASE-I: beta-blockers reduce perioperative death by 90%! (0.7% vs 3.4%). Results seem miraculous.", type: "normal" },
            { year: "2002-09", text: "DECREASE-II, III, IV published. All show dramatic benefit. Poldermans leads European guideline committees. Beta-blockers become standard of care.", type: "normal" },
            { year: "2009", text: "POISE trial (8,351 patients) shows beta-blockers INCREASE mortality in surgery. Contradicts DECREASE completely.", type: "crisis" },
            { year: "2011", text: "Erasmus MC investigates. Finds: phantom patients, impossible data, consent forms forged. Poldermans fired.", type: "crisis" },
            { year: "2013", text: "Cochrane re-analyzes without DECREASE. Beta-blocker benefit vanishes. Guidelines based on fraud for 12 years.", type: "revelation" }
          ],
          realData: {
            endpoint: "Perioperative cardiac death (fabricated)",
            drug: "1/53 (claimed)",
            placebo: "9/59 (claimed)",
            rr: "0.09",
            ci: "0.02-0.66",
            nnh: "N/A ‚Äî DATA WAS FABRICATED"
          },
          hook: "DECREASE showed I¬≤ = 0% when added to meta-analyses. Real medicine is messy. When heterogeneity vanishes, ask: Is this too perfect to be true?"
        }
      },
      {
        type: 'content',
        content: {
          title: "Data Integrity: Trust but Verify",
          sections: [
            {
              heading: "Red Flags for Problematic Data:",
              items: [
                "Results too good to be true (I¬≤=0% across diverse populations)",
                "Baseline characteristics perfectly balanced",
                "Implausible means/SDs (e.g., SD = mean/10 exactly)",
                "Duplicate publications with slightly different numbers",
                "Missing raw data despite requests"
              ]
            },
            {
              heading: "The GRIM Test:",
              items: [
                "Check if reported means are mathematically possible given N",
                "Example: Mean of 3.47 with N=25 is impossible (25√ó3.47=86.75, not an integer)",
                "Failed GRIM tests suggest fabrication or transcription errors"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: RIGOROUS EXTRACTION",
          title: "Capturing Data Accurately",
          sections: [
            {
              heading: "Standardized Forms",
              text: "Create extraction forms with: study ID, population characteristics, intervention details, outcome definitions, timepoints, effect estimates, variance measures, risk of bias items."
            },
            {
              heading: "Dual Extraction",
              text: "Two extractors independently capture data. Compare forms, resolve discrepancies by checking source. Calculate error rate ‚Äî if high, retrain or simplify form."
            },
            {
              heading: "Contacting Authors",
              text: "Missing data? Contact authors. Document all requests and responses. If no response after 2 attempts, report in limitations. Consider intention-to-treat implications."
            },
            {
              heading: "Data Verification",
              text: "Check internal consistency: Do subgroups sum to total? Do percentages match Ns? Does the forest plot match the text? Run GRIM/SPRITE tests on suspicious data."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'extraction-form',
          title: "Data Extraction Form Builder",
          description: "Create standardized extraction forms for your systematic review"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'extract_decision_tree',
          title: "The Suspicious Pattern",
          scenario: "You're extracting data for a statin meta-analysis. One large trial (n=3,200) reports MI rates of exactly 4.0% treatment, 6.0% control. The lead author has had two recent retractions. When you add this study, I¬≤ drops from 45% to 0%.",
          realCase: "DECREASE trials by Don Poldermans showed beta-blockers reduced perioperative death by 90%. Too good to be true. In 2012, Erasmus MC found fabricated patients, forged consent, and impossible data. Guidelines had been based on fraud for 12 years.",
          nodes: {
            start: {
              id: 'start',
              situation: "The suspicious trial accounts for 40% of your total sample. Your 8 other trials show heterogeneous results (I¬≤=45%). Adding this trial: I¬≤=0%, pooled RR 0.67 (highly significant). Without it: I¬≤=45%, pooled RR 0.78 (barely significant).",
              question: "How do you proceed?",
              branches: [
                { id: 'trust_path', text: "Include it ‚Äî it's peer-reviewed and published", nextNode: 'trust_consequence' },
                { id: 'exclude_path', text: "Exclude it ‚Äî retractions mean the author is suspect", nextNode: 'exclude_consequence' },
                { id: 'investigate_path', text: "Investigate the data more carefully first", nextNode: 'investigation' }
              ]
            },
            trust_consequence: {
              id: 'trust_consequence',
              situation: "You include the study. Your meta-analysis is published with strong, precise results (I¬≤=0%). It's cited 200 times. Three years later, the suspicious trial is retracted for data fabrication.",
              question: "What happens to your meta-analysis?",
              branches: [
                { id: 'update_meta', text: "You publish a correction removing the trial", nextNode: 'damage_done' },
                { id: 'leave_meta', text: "You don't update ‚Äî it's just one of nine trials", nextNode: 'contamination' }
              ]
            },
            damage_done: {
              id: 'damage_done',
              situation: "Your correction shows: without the fabricated trial, the effect is weaker and heterogeneous. But 180 of the 200 citing papers used your original inflated estimate. Guidelines were updated based on your original results. Clinical practice changed.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: Like DECREASE, the damage from fabricated data extends far beyond the original paper. The Cochrane beta-blocker review had to be withdrawn. Guidelines had recommended harm. Trust peer review, but verify suspicious patterns."
            },
            contamination: {
              id: 'contamination',
              situation: "Your uncorrected meta-analysis continues circulating. New meta-analyses cite yours as evidence. The fabricated data propagates through the literature. You've become a vector for misinformation.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE WARNING: Fraudulent data doesn't just affect one paper. Like a virus, it replicates through citations. DECREASE influenced thousands of patients before discovery. Your responsibility extends beyond your own analysis."
            },
            exclude_consequence: {
              id: 'exclude_consequence',
              situation: "You exclude based on author history. A reviewer asks: 'You excluded a 3,200-patient trial based on an author's other work. Do you have evidence THIS study is problematic? This seems like guilt by association.'",
              question: "How do you justify your decision?",
              branches: [
                { id: 'admit_bias', text: "Acknowledge it's based on suspicion, not evidence", nextNode: 'unfair_exclusion' },
                { id: 'find_evidence', text: "Go back and look for data-level problems", nextNode: 'belated_investigation' }
              ]
            },
            unfair_exclusion: {
              id: 'unfair_exclusion',
              situation: "The reviewer rejects: 'Excluding studies based on author reputation rather than data quality introduces bias. If you can't document problems with this specific study, include it with sensitivity analysis.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE GRADUAL REVEAL: Suspicion isn't evidence. You can't exclude studies because you distrust the author ‚Äî you need to document problems with the study itself. The correct approach: investigate first, then decide based on what you find."
            },
            belated_investigation: {
              id: 'belated_investigation',
              situation: "You investigate and find: (1) baseline characteristics impossibly balanced, (2) SD = mean/10 exactly for all continuous variables, (3) no dropouts reported despite 2-year follow-up. Now you have documented concerns.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Now you have principled reasons for concern. Include the study in primary analysis, conduct sensitivity analysis without it, and document the red flags. Let readers judge. This is transparency about uncertainty."
            },
            investigation: {
              id: 'investigation',
              situation: "You examine the suspicious trial more closely. What do you check first?",
              question: "Choose your investigation approach:",
              branches: [
                { id: 'check_balance', text: "Check baseline characteristics for impossible balance", nextNode: 'baseline_check' },
                { id: 'check_variance', text: "Check SDs and variances for suspicious patterns", nextNode: 'variance_check' },
                { id: 'check_registry', text: "Compare to ClinicalTrials.gov registration", nextNode: 'registry_check' }
              ]
            },
            baseline_check: {
              id: 'baseline_check',
              situation: "Baseline characteristics: Age 62.3 vs 62.4, BMI 27.8 vs 27.9, 52.0% vs 52.1% male. In 3,200 patients, these are impossibly precise. Real randomization produces more variation. GRIM test: 1,600 √ó 62.3 = 99,680 ‚Äî impossible to produce age 62.3 exactly.",
              question: "What do you conclude?",
              branches: [
                { id: 'fabrication_flag', text: "Flag for likely fabrication ‚Äî document and proceed with sensitivity analysis", nextNode: 'documented_concern' },
                { id: 'contact_author', text: "Contact the author for clarification first", nextNode: 'author_contact' }
              ]
            },
            variance_check: {
              id: 'variance_check',
              situation: "You notice: LDL mean 142, SD 14.2. Systolic BP mean 138, SD 13.8. HbA1c mean 7.2, SD 0.72. Every SD is exactly 10% of the mean. This is statistically implausible ‚Äî different variables have different natural distributions.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE HOOK: The SPRITE test catches impossible combinations of means, SDs, and sample sizes. Real biological data is messy. When patterns are too clean, suspicion is warranted. Document this and conduct sensitivity analysis."
            },
            registry_check: {
              id: 'registry_check',
              situation: "ClinicalTrials.gov shows: original primary endpoint was 'composite CV events' (not MI alone), planned N was 2,400 (not 3,200), and follow-up was planned as 1 year (not 2). Three major deviations without explanation.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE QUESTION: Why did the sample grow by 33%? Why did the primary endpoint change? Why did follow-up extend? These aren't proof of fraud, but they're red flags requiring explanation. Compare registrations to publications ‚Äî always."
            },
            documented_concern: {
              id: 'documented_concern',
              situation: "You include the study in primary analysis, conduct sensitivity analysis without it, and note: 'One trial (Smith 2008) showed unusual baseline balance and variance patterns warranting scrutiny. Conclusions are robust to its exclusion.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: You've done your due diligence. You haven't accused anyone of fraud (which requires institutional investigation), but you've been transparent about concerns. Readers can draw their own conclusions."
            },
            author_contact: {
              id: 'author_contact',
              situation: "You email the corresponding author asking about the baseline balance. No response after 3 weeks. You try again. Still nothing. The author's institution has no contact information. The lab's website hasn't been updated in 4 years.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REPETITION: Document your attempts. 'Author contacted twice without response' is important information. With DECREASE, Poldermans was unresponsive to queries for years. Non-response isn't proof of fraud, but it limits verification."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "What if the data in your meta-analysis was fabricated?",
          context: "For over a decade, the DECREASE trials shaped perioperative medicine worldwide. Led by Don Poldermans at Erasmus Medical Center, these trials showed beta-blockers reduced perioperative cardiac death by an astonishing 90%. Guidelines across the globe recommended beta-blockers before non-cardiac surgery. Then the investigation began.",
          stats: [
            { value: "90%", label: "Claimed Mortality Reduction", type: "" },
            { value: "11", label: "Papers Retracted", type: "danger" },
            { value: "2011", label: "Poldermans Fired", type: "" },
            { value: "10,000+", label: "Estimated Excess Deaths", type: "danger" }
          ],
          source: "Erasmus MC Investigation 2011 | POISE Trial - Lancet 2008",
          decisionScenario: "You are updating perioperative guidelines. The DECREASE trials dominate the evidence base. A colleague notes the effect sizes seem 'too good to be true' ‚Äî 90% mortality reductions are almost unheard of in cardiology.",
          pathA: {
            title: "Include DECREASE trials ‚Äî they're published and peer-reviewed",
            steps: [
              "Your meta-analysis shows strong benefit (OR 0.10)",
              "Guidelines recommend beta-blockers for all surgical patients",
              "Hospitals adopt mandatory beta-blocker protocols",
              "POISE trial (real data, n=8,351): beta-blockers INCREASE mortality (HR 1.33)",
              "Investigation reveals DECREASE data was fabricated",
              "Estimated 10,000+ excess deaths from guidelines based on fraud"
            ]
          },
          pathB: {
            title: "Flag impossible effect sizes ‚Äî investigate data integrity",
            steps: [
              "You note 90% mortality reduction is biologically implausible",
              "Request raw data from investigators (no response)",
              "Conduct sensitivity analysis excluding DECREASE",
              "Without DECREASE: no clear benefit, possible harm signal",
              "Your cautious conclusions prevent widespread adoption",
              "When POISE publishes, your skepticism is validated"
            ]
          },
          revelation: "Meta-analysis assumes data integrity. When that assumption fails, the entire edifice collapses. The DECREASE fraud taught us: impossible effect sizes are a warning sign. A 90% mortality reduction from a simple beta-blocker should have triggered skepticism, not celebration. Your job is not just to pool numbers ‚Äî it is to question whether those numbers deserve to exist.",
          moduleConnection: "This is why data extraction requires vigilance. You are not a calculator ‚Äî you are a guardian. Every number you extract carries the weight of patient lives. Verify, cross-check, and when something seems too good to be true, it probably is."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A trial reports mean BMI of 27.3 kg/m¬≤ (SD 2.1) in a group of N=30 patients. Using the GRIM test (checking if 30 √ó 27.3 = 819 is plausible for BMI sum), what can you conclude?",
          options: [
            { id: 'a', text: "The mean is impossible ‚Äî definite fabrication", correct: false },
            { id: 'b', text: "The mean is possible ‚Äî data is verified", correct: false },
            { id: 'c', text: "GRIM tests apply to counts/discrete data, not continuous measures like BMI", correct: true },
            { id: 'd', text: "Need more information to apply GRIM", correct: false }
          ],
          explanation: "GRIM (Granularity-Related Inconsistency of Means) applies to discrete/count data where values must be integers. BMI is continuous, so any mean is mathematically possible. GRIM would apply to 'number of cigarettes per day' but not weight or height."
        }
      }
    ]
  },
  // Module 6: The Assess (Risk of Bias)
  {
    id: 6,
    title: "The Assess",
    subtitle: "Risk of Bias",
    principle: 4,
    story: "ORBITA",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Bias hides in plain sight"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVELATION: ORBITA ‚Äî THE PLACEBO STENT",
          source: "Lancet 2018; 391:31-40 | Al-Lamee et al | PubMed: 29103656",
          timeline: [
            { year: "1990s-2010s", text: "Hundreds of trials show PCI improves angina symptoms. Millions of procedures performed yearly. Patients report dramatic improvement.", type: "normal" },
            { year: "2007", text: "COURAGE trial: PCI doesn't reduce MI or death vs medical therapy. But symptoms improved ‚Äî so PCI continues for symptom relief.", type: "normal" },
            { year: "2015", text: "ORBITA begins: 200 patients with single-vessel disease. Half get PCI, half get sham (catheter inserted, no stent). Both groups blinded.", type: "normal" },
            { year: "2018", text: "Results: Exercise time improved 28.4s with PCI vs 11.8s with sham. Difference: 16.6s (95% CI: -8.9 to 42.0). NOT significant.", type: "crisis" },
            { year: "The Truth", text: "The 'benefit' of PCI for stable angina was placebo effect. Unblinded trials measured belief, not biology. Every previous trial was high risk of bias.", type: "revelation" }
          ],
          realData: {
            endpoint: "Exercise time increment at 6 weeks",
            drug: "PCI: +28.4 seconds",
            placebo: "Sham: +11.8 seconds",
            rr: "Diff: 16.6s",
            ci: "-8.9 to 42.0",
            nnh: "p = 0.20 (not significant)"
          },
          hook: "Without a sham control, you're not measuring the treatment. You're measuring the ritual ‚Äî the cathlab, the procedure, the recovery, the belief that something was done."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: ORBITA proved that decades of PCI 'benefit' for stable angina was placebo effect. Millions of stents were placed based on unblinded trials measuring subjective outcomes. Risk of bias isn't academic ‚Äî it's the difference between measuring medicine and measuring belief."
        }
      },
      {
        type: 'content',
        content: {
          title: "The Five Domains of Bias (RoB 2)",
          sections: [
            {
              heading: "Domain 1: Randomization Process",
              items: [
                "Was allocation sequence random?",
                "Was allocation concealed until enrollment?",
                "Were baseline differences due to chance?"
              ]
            },
            {
              heading: "Domain 2: Deviations from Intended Interventions",
              items: [
                "Were participants/personnel blinded?",
                "Were there deviations from protocol?",
                "Were deviations likely to affect outcomes?"
              ]
            },
            {
              heading: "Domain 3: Missing Outcome Data",
              items: [
                "Were outcome data complete?",
                "Could missingness be related to outcomes?",
                "Were appropriate analyses used?"
              ]
            },
            {
              heading: "Domains 4-5: Measurement & Selection",
              items: [
                "Could outcome measurement be influenced by knowledge of intervention?",
                "Was outcome selection influenced by results?"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: ROB 2 ASSESSMENT",
          title: "Systematic Bias Evaluation",
          sections: [
            {
              heading: "Signaling Questions",
              text: "Each domain has 3-5 signaling questions answered Yes/Probably Yes/Probably No/No/No Information. These feed into domain-level judgments."
            },
            {
              heading: "Domain Judgments",
              text: "Low risk: trial unlikely to be biased for this domain\nSome concerns: raises questions about trustworthiness\nHigh risk: domain likely to seriously bias results"
            },
            {
              heading: "Overall Judgment",
              text: "Low risk: low risk in all domains\nSome concerns: some concerns in at least one domain\nHigh risk: high risk in at least one domain, OR some concerns in multiple domains"
            },
            {
              heading: "Implications for Synthesis",
              text: "High risk studies can be excluded (strict) or kept with sensitivity analysis (inclusive). Either way, risk of bias must inform your certainty assessment (GRADE)."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'rob2-tool',
          title: "RoB 2 Assessment Interface",
          description: "Evaluate risk of bias using the Cochrane RoB 2 tool"
        }
      },
      {
        type: 'content',
        content: {
          title: "THE PATTERN: When Sham Surgery Exposes Placebo Effects",
          sections: [
            {
              heading: "FIDELITY (2013) ‚Äî Knee Meniscus Surgery",
              items: [
                "146 patients with meniscal tears ‚Üí arthroscopic resection vs sham",
                "Lysholm score difference: -1.6 points (95% CI: -7.2 to 4.0)",
                "One of the most common orthopedic procedures shown to be no better than placebo",
                "Source: NEJM 2013; PubMed 24369076"
              ]
            },
            {
              heading: "Vertebroplasty Sham Trials (2009) ‚Äî Spinal Fracture Treatment",
              items: [
                "Two trials: cement injection into fractured vertebrae vs sham (needle placement only)",
                "Pain reduction difference: 0.6 points on 0-10 scale (95% CI: -0.7 to 1.8)",
                "Procedure costing $5,000+ worked no better than inserting a needle",
                "Source: NEJM 2009; PubMed 19657121"
              ]
            },
            {
              heading: "CSAW (2018) ‚Äî Shoulder Decompression Surgery",
              items: [
                "313 patients with subacromial pain ‚Üí surgery vs arthroscopy vs no treatment",
                "Oxford Shoulder Score difference: -1.3 points (95% CI: -3.9 to 1.3)",
                "300,000 such surgeries performed annually in UK/US ‚Äî most unnecessary",
                "Source: Lancet 2018; PMC 5803129"
              ]
            },
            {
              heading: "THE WARNING: The Pattern Repeats",
              items: [
                "Unblinded surgical trials overestimate benefit by 30-50%",
                "Patients WANT to believe expensive, invasive procedures work",
                "Surgeons BELIEVE in their craft ‚Äî impossible to blind them",
                "Without sham controls, we measure belief, not biology"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'rob_decision_tree',
          title: "The Unblinded Blood Pressure Trial",
          scenario: "You're assessing a trial of new antihypertensive Drug X. Year 1: double-blind. Years 2-4: open-label extension. Primary outcome: CV events (blinded adjudication). Secondary: quality of life, symptoms (unblinded staff collected).",
          realCase: "SYMPLICITY HTN-3 tested renal denervation for resistant hypertension. Earlier unblinded trials showed dramatic 30 mmHg drops. The sham-controlled trial? Only 2.4 mmHg difference. Unblinded measurement had vastly inflated the apparent benefit.",
          nodes: {
            start: {
              id: 'start',
              situation: "The trial reports: Drug X reduced CV events by 18% (HR 0.82, p=0.04) and improved quality of life scores by 12 points (p<0.001). You're doing RoB 2 assessment. You need to rate each outcome separately.",
              question: "Which outcome do you assess first?",
              branches: [
                { id: 'primary_first', text: "Primary outcome (CV events)", nextNode: 'cv_assessment' },
                { id: 'secondary_first', text: "Secondary outcome (quality of life)", nextNode: 'qol_assessment' },
                { id: 'combined_assessment', text: "Rate the trial overall, not by outcome", nextNode: 'combined_mistake' }
              ]
            },
            combined_mistake: {
              id: 'combined_mistake',
              situation: "You write: 'Overall risk of bias: Some concerns due to open-label extension.' A reviewer returns your assessment: 'RoB 2 requires outcome-specific assessment. CV events with blinded adjudication is different from QoL with unblinded collection.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE HOOK: Risk of bias is not a property of the trial ‚Äî it's a property of each outcome within the trial. ORBITA taught us: blinding affects subjective outcomes profoundly but objective outcomes minimally. One judgment cannot capture this."
            },
            cv_assessment: {
              id: 'cv_assessment',
              situation: "For CV events: Events were adjudicated by a committee blinded to treatment allocation. They reviewed medical records, ECGs, and imaging without knowing which arm the patient was in. The open-label extension didn't affect their judgment.",
              question: "Risk of bias for CV outcome measurement?",
              branches: [
                { id: 'cv_low', text: "Low risk ‚Äî blinded adjudication protects the outcome", nextNode: 'cv_correct' },
                { id: 'cv_some', text: "Some concerns ‚Äî patients were unblinded, might report symptoms differently", nextNode: 'cv_overthinking' },
                { id: 'cv_high', text: "High risk ‚Äî the trial was open-label for 3 years", nextNode: 'cv_wrong' }
              ]
            },
            cv_correct: {
              id: 'cv_correct',
              situation: "Correct! For objective outcomes with blinded assessment, lack of participant blinding matters less. Death is death. MI confirmed by troponins and ECG is MI. The adjudicators' blinding is what matters.",
              question: "Now assess the quality of life outcome:",
              branches: [
                { id: 'qol_from_cv', text: "Continue to QoL assessment", nextNode: 'qol_assessment' }
              ]
            },
            cv_overthinking: {
              id: 'cv_overthinking',
              situation: "You worry that unblinded patients might report chest pain differently, leading to more investigations. This is a theoretical concern, but the adjudication committee judged based on objective criteria (troponins, ECG), not patient reports alone.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE GRADUAL REVEAL: 'Some concerns' isn't wrong, but it may be overcautious. The key question: could knowledge of allocation affect the outcome measurement? For CV events with blinded adjudication using objective criteria, the answer is likely no."
            },
            cv_wrong: {
              id: 'cv_wrong',
              situation: "You rated high risk, but the adjudication was blinded. Open-label status affects outcomes differently. ORBITA showed: exercise time (objective but effort-dependent) was affected by placebo; mortality would not be. Context matters.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE QUESTION: Ask yourself: How could unblinding affect THIS outcome? CV events confirmed by blinded adjudicators using objective criteria cannot be influenced by patient or investigator knowledge of treatment."
            },
            qol_assessment: {
              id: 'qol_assessment',
              situation: "For quality of life: A research nurse (who knew patient allocation) administered the questionnaire. Patients knew they were on Drug X or placebo. The nurse recorded responses and could probe or clarify answers.",
              question: "Risk of bias for QoL outcome measurement?",
              branches: [
                { id: 'qol_low', text: "Low risk ‚Äî it's patient-reported, nurse just recorded", nextNode: 'qol_wrong_low' },
                { id: 'qol_some', text: "Some concerns ‚Äî subtle influence possible", nextNode: 'qol_insufficient' },
                { id: 'qol_high', text: "High risk ‚Äî subjective outcome, unblinded collection", nextNode: 'qol_correct' }
              ]
            },
            qol_wrong_low: {
              id: 'qol_wrong_low',
              situation: "Consider: the nurse knows the patient is on the 'new promising drug.' She asks about symptoms. The patient says 'maybe a bit better.' Unblinded, the nurse might probe: 'So your energy is improved?' Blinded, she'd record neutrally.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: SYMPLICITY's unblinded trials showed 30 mmHg BP drops. The sham-controlled trial showed 2.4 mmHg. The difference wasn't the procedure ‚Äî it was the measurement context. Subjective outcomes require blinding."
            },
            qol_insufficient: {
              id: 'qol_insufficient',
              situation: "'Some concerns' understates the risk. The combination of: (1) subjective outcome, (2) unblinded patient, (3) unblinded assessor creates clear bias potential. This is textbook high risk for Domain 4 (measurement of the outcome).",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: Every ORBITA-like situation teaches the same lesson. Subjective outcomes + unblinding = high bias risk. 'Some concerns' is for ambiguous situations. This one is clear."
            },
            qol_correct: {
              id: 'qol_correct',
              situation: "You rate high risk for QoL. Your assessment now shows: CV events (low risk), QoL (high risk). The trial's abstract claims 'Drug X improved quality of life' ‚Äî but you've identified this claim rests on high-risk evidence.",
              question: "How do you incorporate this into your meta-analysis?",
              branches: [
                { id: 'exclude_qol', text: "Exclude the QoL outcome from synthesis", nextNode: 'exclusion_option' },
                { id: 'include_downgrade', text: "Include but downgrade certainty in GRADE", nextNode: 'best_approach' },
                { id: 'report_both', text: "Report CV events only, ignore QoL", nextNode: 'selective_reporting' }
              ]
            },
            exclusion_option: {
              id: 'exclusion_option',
              situation: "If you exclude all high-risk QoL data, you may have nothing left to synthesize. Most QoL studies have similar limitations. Exclusion may not be practical.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE WARNING: Excluding high-risk studies is an option, but requires pre-specification. A better approach: include, but transparently report the bias concern and downgrade certainty appropriately."
            },
            best_approach: {
              id: 'best_approach',
              situation: "You include the study, note high RoB for QoL, and when you reach GRADE assessment, you downgrade certainty for risk of bias. Your Summary of Findings table shows: CV events (moderate certainty), QoL (very low certainty).",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: RoB assessment flows into GRADE. High risk of bias ‚Üí downgrade certainty. This is how the system works: identify bias, quantify uncertainty, communicate honestly. Readers see which conclusions are trustworthy."
            },
            selective_reporting: {
              id: 'selective_reporting',
              situation: "By only reporting CV events, you've hidden that the trial claimed QoL benefits on high-risk evidence. A reader checking the original trial will wonder why you omitted a significant finding.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE HOOK RETURNS: Selective outcome reporting is a form of bias. Report all pre-specified outcomes, even if some have high RoB. The solution is transparent assessment, not omission."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "What happens when biased trials drive your pooled estimate?",
          context: "Aprotinin was a blood-clotting drug used in cardiac surgery to reduce bleeding. For years, meta-analyses showed it reduced mortality. Sixty-four trials supported its use. But most were small, unblinded, and industry-funded. The evidence looked overwhelming until someone asked: what happens if we actually assess bias?",
          stats: [
            { value: "64", label: "Trials Showing Benefit", type: "" },
            { value: "Most", label: "High Risk of Bias", type: "danger" },
            { value: "1.53x", label: "True Mortality Risk", type: "danger" },
            { value: "2008", label: "Drug Withdrawn", type: "" }
          ],
          source: "Fergusson et al. NEJM 2008 | BART Trial - NEJM 2008; 358:2319-31",
          decisionScenario: "You are writing a meta-analysis on aprotinin for cardiac surgery. Your search finds 64 trials. Most show mortality benefit. You must decide how to handle risk of bias.",
          pathA: {
            title: "Include all trials ‚Äî more data is better",
            steps: [
              "Pool 64 trials regardless of bias risk",
              "Meta-analysis shows clear mortality benefit",
              "Drug continues widespread use in cardiac surgery",
              "BART trial (properly randomized, n=2,331) finally runs",
              "BART shows aprotinin INCREASES death (RR 1.53)",
              "Trial stopped early for harm, drug withdrawn worldwide"
            ]
          },
          pathB: {
            title: "Exclude high-risk-of-bias trials ‚Äî quality over quantity",
            steps: [
              "Assess bias: most trials small, unblinded, industry-funded",
              "Exclude high-risk trials, pool only low-risk evidence",
              "Benefit disappears when restricted to quality trials",
              "You recommend waiting for large, independent trial",
              "BART confirms your caution ‚Äî drug was harmful all along",
              "Your rigorous analysis prevented harm"
            ]
          },
          revelation: "Garbage in, garbage out. A meta-analysis cannot fix the flaws in its component trials. The 64 aprotinin trials looked like overwhelming evidence ‚Äî but they were 64 pieces of biased evidence. When Fergusson assessed risk of bias rigorously, the benefit vanished. The BART trial proved the drug was killing patients. Risk of bias assessment is not academic nitpicking ‚Äî it is the difference between pooling evidence and pooling bias.",
          moduleConnection: "This is why RoB assessment matters. You must evaluate each trial before pooling. A forest plot of 64 biased trials is not evidence ‚Äî it is organized noise. Your job is to separate signal from noise, and bias assessment is your primary tool."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A surgical trial compares open surgery to laparoscopic surgery. Patients and surgeons cannot be blinded. The primary outcome is mortality at 30 days (from death records). What is the risk of bias for outcome measurement?",
          options: [
            { id: 'a', text: "High risk ‚Äî no blinding means high bias", correct: false },
            { id: 'b', text: "Low risk ‚Äî mortality is objective and from independent records", correct: true },
            { id: 'c', text: "Some concerns ‚Äî lack of blinding always raises concerns", correct: false },
            { id: 'd', text: "Cannot assess without knowing randomization method", correct: false }
          ],
          explanation: "Risk of bias for outcome measurement depends on whether knowledge of the intervention could influence the measurement. Death from administrative records is objective and cannot be influenced by blinding status. Subjective outcomes (pain, function) would be high risk in unblinded trials."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've completed the ASSESSMENT phase.\n\n‚úì Module 4: SCREENING studies ‚Äî learned from Vitamin E's contradictory meta-analyses\n‚úì Module 5: EXTRACTING data ‚Äî learned from DECREASE's fabricated numbers\n‚úì Module 6: ASSESSING bias ‚Äî learned from ORBITA's sham surgery revelation\n\nYou can now FIND studies, SELECT them rigorously, EXTRACT data carefully, and ASSESS their trustworthiness.\n\nNext: You'll learn to SYNTHESIZE studies into pooled estimates and INTERPRET what those numbers mean.\n\nThe hardest part begins now ‚Äî the statistics that can deceive even experts."
        }
      }
    ]
  },
  // Module 7: The Effect
  {
    id: 7,
    title: "The Effect",
    subtitle: "Effect Size Calculation",
    principle: 5,
    story: "SSRI",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "The average can lie"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE CONTROVERSY: SSRI ‚Äî WHEN NUMBERS DECEIVE",
          source: "PLoS Medicine 2008; Kirsch et al | JAMA 2010; Fournier et al | PubMed: 18303940",
          timeline: [
            { year: "1987-2007", text: "SSRIs become the most prescribed psychiatric medications worldwide. Prozac alone earns $2.6 billion annually. Depression treatment is transformed.", type: "normal" },
            { year: "Feb 2008", text: "Kirsch publishes FDA analysis: SSRIs show SMD = 0.32. Below NICE threshold of 0.50 for 'clinical significance.' Media erupts: 'Antidepressants no better than placebo!'", type: "crisis" },
            { year: "The Metric", text: "SMD divides raw difference by standard deviation. High variability ‚Üí small SMD. HDRS has high variability. The same 3-point improvement looks 'trivial' as SMD.", type: "normal" },
            { year: "Jan 2010", text: "Fournier re-analyzes: Mean difference = 2.7 HDRS points. For severe depression (HDRS ‚â•25): MD = 4.4 points. Clinically meaningful by any standard.", type: "revelation" },
            { year: "The Truth", text: "Same trials. Same patients. SMD said 'not clinically significant.' Mean difference said 'helps severely depressed.' The metric chose the narrative.", type: "revelation" }
          ],
          realData: {
            endpoint: "Hamilton Depression Rating Scale (HDRS) change",
            drug: "SSRIs pooled",
            placebo: "Placebo pooled",
            rr: "SMD = 0.32 OR Mean Diff = 2.7 points",
            ci: "SMD: 0.24-0.40 | MD: 1.8-3.6",
            nnh: "Different metrics, same data, different stories"
          },
          hook: "THE QUESTION: If a depressed patient improves by 3 points on a 52-point scale, is that 'trivial' (SMD=0.32) or 'meaningful' (returning to normal life)? The metric cannot answer. Only the patient can."
        }
      },
      {
        type: 'content',
        content: {
          title: "Choosing the Right Effect Size",
          sections: [
            {
              heading: "For Binary Outcomes:",
              items: [
                "Risk Ratio (RR): intuitive, but can't pool if baseline risk varies greatly",
                "Odds Ratio (OR): mathematical properties allow pooling, but less intuitive",
                "Risk Difference (RD): absolute effect, varies with baseline risk",
                "Hazard Ratio (HR): for time-to-event outcomes"
              ]
            },
            {
              heading: "For Continuous Outcomes:",
              items: [
                "Mean Difference (MD): same scale ‚Üí easy interpretation",
                "Standardized Mean Difference (SMD/Cohen's d): different scales ‚Üí comparable",
                "Response Ratio: ratio of means, percentage change"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: EFFECT SIZE SELECTION",
          title: "Matching Effect Size to Question",
          sections: [
            {
              heading: "When to Use Mean Difference",
              text: "All studies use the same outcome measure (e.g., all use HDRS for depression). Interpretation is straightforward: 'Treatment reduced depression by 3 points.'"
            },
            {
              heading: "When to Use SMD",
              text: "Studies use different scales measuring the same construct (e.g., HDRS vs BDI for depression). Interpretation requires anchoring: SMD of 0.5 = 'medium effect' in Cohen's conventions, but clinical meaning depends on context."
            },
            {
              heading: "When to Use Risk Ratio",
              text: "Most common for binary outcomes. Intuitive: 'Treatment reduces risk by 25%' (RR=0.75). Problematic when baseline risk varies widely across studies."
            },
            {
              heading: "Converting Between Metrics",
              text: "OR ‚âà RR when outcomes are rare (<10%). SMD ‚âà MD/pooled SD. Hazard ratios require individual patient data for accurate conversion."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'effect-calculator',
          title: "Effect Size Calculator",
          description: "Calculate effect sizes from various input formats"
        }
      },
      {
        type: 'content',
        content: {
          title: "THE GRAVEYARD OF BIOMARKERS: When Big Effects Don't Matter",
          sections: [
            {
              heading: "Homocysteine Lowering ‚Äî NORVIT (2006)",
              items: [
                "The biomarker: High homocysteine ‚Üí 3x cardiovascular risk (observational studies)",
                "The intervention: B-vitamins dramatically lower homocysteine (30-40% reduction)",
                "The trial: 3,749 post-MI patients. Homocysteine dropped beautifully.",
                "The result: Primary composite RR 1.08 (0.93-1.25). TREND TOWARD HARM.",
                "Source: NEJM 2006 NORVIT"
              ]
            },
            {
              heading: "Niacin + Statin ‚Äî AIM-HIGH (2011) & HPS2-THRIVE (2014)",
              items: [
                "The biomarker: Niacin raises HDL by 25%, lowers triglycerides by 30%",
                "The hope: Adding niacin to statins would save more lives",
                "AIM-HIGH: HR 1.02 (0.87-1.21) for CV events ‚Äî NO benefit",
                "HPS2-THRIVE: RR 0.96 (0.90-1.03) for vascular events ‚Äî but MORE adverse events",
                "25,000+ patients, billions in drug costs, improved biomarkers, ZERO benefit"
              ]
            },
            {
              heading: "THE PATTERN: Effect Size ‚â† Clinical Benefit",
              items: [
                "Homocysteine: Large reduction (30%) ‚Üí no clinical benefit",
                "HDL cholesterol: Large increase (25%) ‚Üí no clinical benefit",
                "HbA1c: Large reduction (ACCORD) ‚Üí INCREASED mortality",
                "THE LESSON: A big effect on a surrogate is not a benefit to a patient"
              ]
            },
            {
              heading: "THE WARNING: What Metric Matters?",
              items: [
                "Drug companies report biomarker effect sizes (impressive numbers)",
                "Patients care about mortality, hospitalizations, quality of life",
                "Meta-analyses must distinguish: Are we pooling surrogates or patient-important outcomes?",
                "A meta-analysis of homocysteine reduction would show 'strong evidence' ‚Äî of the wrong thing"
              ]
            }
          ]
        }
      },
      {
        type: 'scenario',
        content: {
          id: 'effect_scenario',
          title: "The Competing Metrics",
          situation: "You're meta-analyzing trials of exercise for depression. Most trials report mean HDRS scores, but three trials report 'response rate' (‚â•50% improvement). You could: (1) convert response rates to means using approximations, (2) report separate analyses, or (3) exclude the three trials.",
          question: "What's the best approach?",
          choices: [
            {
              id: 'a',
              text: "Convert response rates to approximate means to include all trials",
              consequence: 'bad',
              result: "Conversions introduce substantial error and assume normal distributions. The approximation (SMD ‚âà logOR/1.81) has wide uncertainty. You're adding precision you don't have."
            },
            {
              id: 'b',
              text: "Report separate analyses: one for continuous, one for binary",
              consequence: 'good',
              result: "Correct! This maintains the integrity of each estimate while presenting all available evidence. Readers see both analyses and can assess consistency."
            },
            {
              id: 'c',
              text: "Exclude the three trials to maintain consistency",
              consequence: 'neutral',
              result: "Acceptable if pre-specified, but wastes relevant data. The three trials may contain important information about different populations or intervention intensities."
            }
          ],
          correct: 'b',
          principle: 5
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A trial reports mean pain scores of 4.2 (SD 2.0) in treatment and 5.8 (SD 2.4) in control (lower = better, N=50 each). What is the approximate SMD (Cohen's d)?",
          options: [
            { id: 'a', text: "-0.73 (favoring treatment)", correct: true },
            { id: 'b', text: "-1.60 (favoring treatment)", correct: false },
            { id: 'c', text: "+0.73 (favoring control)", correct: false },
            { id: 'd', text: "Cannot calculate without individual patient data", correct: false }
          ],
          explanation: "SMD = (Mean1 - Mean2) / pooled SD. Pooled SD ‚âà ‚àö[(2.0¬≤ + 2.4¬≤)/2] ‚âà 2.21. SMD = (4.2 - 5.8) / 2.21 = -1.6 / 2.21 ‚âà -0.73. The negative sign indicates treatment has lower (better) pain scores."
        }
      }
    ]
  },
  // Module 8: The Synthesize
  {
    id: 8,
    title: "The Synthesize",
    subtitle: "Meta-Analysis Models",
    principle: 5,
    story: "ISIS-4",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "The average can lie"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE LESSON: ISIS-4 ‚Äî WHEN SMALL STUDIES LIE",
          source: "Lancet 1995; 345:669-685 | ISIS-4 Collaborative | PubMed: 7661937",
          timeline: [
            { year: "1984-91", text: "Seven small trials (n=1,301 total) show magnesium reduces MI mortality by 55%! OR 0.45 (0.26-0.77). Strong biological rationale exists.", type: "normal" },
            { year: "1992", text: "LIMIT-2 (2,316 patients) confirms benefit: OR 0.74 (0.56-0.99). Enthusiasm grows. Meta-analysis shows clear benefit.", type: "normal" },
            { year: "1992-94", text: "ISIS-4 enrolls 58,050 patients ‚Äî the largest MI trial ever. Magnesium vs control.", type: "normal" },
            { year: "1995", text: "ISIS-4 results: 7.64% vs 7.24% mortality. OR 1.06 (0.99-1.14). NO benefit. The small trials were WRONG.", type: "crisis" },
            { year: "The Truth", text: "Small trials overestimate effects. Publication bias hid negative small trials. The 'definitive' meta-analysis was an artifact of selective reporting.", type: "revelation" }
          ],
          realData: {
            endpoint: "5-week mortality in acute MI",
            drug: "2,216/29,011 (7.64%)",
            placebo: "2,103/29,039 (7.24%)",
            rr: "1.06",
            ci: "0.99-1.14",
            nnh: "No benefit (trend toward harm)"
          },
          hook: "Small trials showed 55% mortality reduction. The mega-trial showed nothing. This is why we need to understand heterogeneity, funnel plots, and prediction intervals ‚Äî not just pooled estimates."
        }
      },
      {
        type: 'content',
        content: {
          title: "Fixed vs Random Effects",
          sections: [
            {
              heading: "Fixed Effect Model:",
              items: [
                "Assumes ONE true effect size underlying all studies",
                "Differences between studies are sampling error only",
                "Weights by inverse variance (larger studies count more)",
                "Narrower confidence intervals",
                "Appropriate when studies are identical in methods/population"
              ]
            },
            {
              heading: "Random Effects Model:",
              items: [
                "Assumes DISTRIBUTION of true effects across studies",
                "Studies estimate different (but related) effects",
                "Adds between-study variance (œÑ¬≤) to weights",
                "Wider confidence intervals (accounts for heterogeneity)",
                "Gives more weight to small studies than fixed effect"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: CHOOSING YOUR MODEL",
          title: "When to Pool (and When Not To)",
          sections: [
            {
              heading: "Use Fixed Effect When:",
              text: "Studies are methodologically identical (same protocol, same population, same timeframe). You want to estimate the effect in this specific context. Between-study heterogeneity is truly zero or trivial."
            },
            {
              heading: "Use Random Effects When:",
              text: "Studies differ in populations, interventions, or methods. You want to generalize beyond included studies. Heterogeneity is expected (I¬≤ > 0%)."
            },
            {
              heading: "Don't Pool When:",
              text: "Heterogeneity is extreme (I¬≤ > 75% without explanation). Studies measure fundamentally different things. Mixing apples and oranges produces fruit salad, not insight."
            },
            {
              heading: "The Random Effects Caveat:",
              text: "Random effects gives more weight to small studies. If publication bias exists, small studies are more likely biased. Random effects can amplify bias."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'forest-plot',
          title: "Forest Plot Builder",
          description: "Build interactive forest plots with fixed or random effects"
        }
      },
      {
        type: 'content',
        content: {
          title: "THE SEDUCTION: Cumulative Meta-Analysis and False Confidence",
          sections: [
            {
              heading: "The Magnesium Story ‚Äî A Cautionary Tale",
              items: [
                "1984: First small trial shows magnesium reduces MI mortality by 50%",
                "1985-1991: Six more small trials confirm benefit. Cumulative OR 0.45 (0.26-0.77)",
                "1992: LIMIT-2 (2,316 patients) adds to the evidence. OR now 0.56 (0.42-0.76)",
                "Meta-analysts declare: 'The evidence is conclusive. Further trials are unethical.'"
              ]
            },
            {
              heading: "The Mega-Trial Reality",
              items: [
                "1995: ISIS-4 enrolls 58,050 patients ‚Äî larger than ALL previous trials combined",
                "Result: 7.64% vs 7.24% mortality. OR 1.06 (0.99-1.14)",
                "The 'conclusive' 50% benefit evaporated entirely",
                "Source: Lancet 2002 MAGIC trial; PubMed 12401244"
              ]
            },
            {
              heading: "What Went Wrong?",
              items: [
                "Small trials: selection bias, publication bias, optimism bias",
                "Cumulative meta-analysis: gave false impression of convergence",
                "Each new small positive trial 'confirmed' previous biased results",
                "Only the mega-trial had power to detect the truth: NO EFFECT"
              ]
            },
            {
              heading: "THE REPETITION: Small Studies Lie, Big Studies Tell Truth",
              items: [
                "This pattern repeats across medicine: TASTE (thrombus aspiration), IABP-SHOCK II (balloon pumps)",
                "Meta-analyses of small trials consistently overestimate benefits",
                "When results conflict by study size, trust the large studies",
                "THE QUESTION: Is your meta-analysis driven by small, potentially biased trials?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'synthesize_decision_tree',
          title: "The I¬≤ Dilemma",
          scenario: "Your mortality meta-analysis of 12 trials: RR 0.78 (95% CI 0.65-0.93, p=0.006). I¬≤ = 82%. Two small trials show RR 0.3-0.4. Three mega-trials show RR 0.85-0.95. Your co-author wants to headline the 22% mortality reduction.",
          realCase: "ISIS-4: Seven small trials (n=1,301) showed magnesium reduced MI mortality by 55%. Then ISIS-4 (n=58,050) showed OR 1.06. The small studies were wrong. Their pooled estimate was an artifact of publication bias and small-study effects.",
          nodes: {
            start: {
              id: 'start',
              situation: "The forest plot shows clear heterogeneity. Small studies (n<500) cluster around RR 0.35. Large studies (n>2000) cluster around RR 0.90. Random effects gives more weight to the small studies than fixed effects would.",
              question: "What's your interpretation?",
              branches: [
                { id: 'report_pooled', text: "The pooled RR 0.78 is the best summary ‚Äî report it", nextNode: 'pooled_problem' },
                { id: 'investigate_pattern', text: "The pattern suggests small-study effects ‚Äî investigate", nextNode: 'small_study_investigation' },
                { id: 'trust_mega', text: "Trust the mega-trials ‚Äî they have more precise estimates", nextNode: 'mega_trial_bias' }
              ]
            },
            pooled_problem: {
              id: 'pooled_problem',
              situation: "You report RR 0.78. A journal reviewer calculates the prediction interval: RR 0.32-1.89. 'Your CI suggests benefit, but your PI suggests the treatment might double mortality in some settings. This must be in your abstract.'",
              question: "How do you respond?",
              branches: [
                { id: 'add_pi', text: "Add the prediction interval to the abstract", nextNode: 'transparency_path' },
                { id: 'defend_ci', text: "The CI is the conventional metric ‚Äî the PI is too conservative", nextNode: 'ci_defense_fails' },
                { id: 'reframe_results', text: "Reframe as 'evidence of heterogeneity, no single estimate possible'", nextNode: 'honest_uncertainty' }
              ]
            },
            transparency_path: {
              id: 'transparency_path',
              situation: "Your revised abstract: 'RR 0.78 (95% CI 0.65-0.93); however, substantial heterogeneity (I¬≤=82%) yielded a prediction interval of 0.32-1.89, suggesting benefit varies widely across settings.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: The CI tells you about the average. The PI tells you about the range. When heterogeneity is high, the PI is the clinically relevant metric. It answers: 'What might happen in MY setting?'"
            },
            ci_defense_fails: {
              id: 'ci_defense_fails',
              situation: "The reviewer responds: 'The CI answers the wrong question. Clinicians need to know: will this work in my hospital? With I¬≤=82%, the answer is 'maybe, maybe not.' Your CI creates false certainty.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: ISIS-4 taught us this lesson. Small trials said 55% mortality reduction. Mega-trial said 0%. The pooled estimate from small trials was misleading. Heterogeneity isn't noise ‚Äî it's signal."
            },
            honest_uncertainty: {
              id: 'honest_uncertainty',
              situation: "Your abstract now states: 'Treatment showed benefit in pooled analysis (RR 0.78), but extreme heterogeneity (I¬≤=82%) precludes a single summary estimate. Effect ranged from RR 0.30 in small studies to 0.95 in mega-trials. Subgroup analysis needed.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Sometimes the honest answer is 'we don't have one number.' When I¬≤ exceeds 75%, consider whether pooling is meaningful at all. The heterogeneity itself becomes the finding."
            },
            small_study_investigation: {
              id: 'small_study_investigation',
              situation: "You examine the small studies showing RR 0.3-0.4. Both were single-center, both published by the same research group, both in journals with low impact factors. One is from 1998, the other from 2001. Neither has been independently replicated.",
              question: "What does this pattern suggest?",
              branches: [
                { id: 'pub_bias_suspect', text: "Publication bias ‚Äî small negative trials weren't published", nextNode: 'funnel_analysis' },
                { id: 'fraud_suspect', text: "Possible fraud ‚Äî same group, implausible effects", nextNode: 'fraud_investigation' },
                { id: 'true_heterogeneity', text: "True heterogeneity ‚Äî different populations respond differently", nextNode: 'true_het_explore' }
              ]
            },
            funnel_analysis: {
              id: 'funnel_analysis',
              situation: "Your funnel plot shows clear asymmetry. Egger's test p=0.003. The lower-left quadrant (small negative trials) is empty. Trim-and-fill imputes 4 'missing' studies, changing RR from 0.78 to 0.91 (no longer significant).",
              question: "How do you report this?",
              branches: [
                { id: 'report_both', text: "Report original and trim-and-fill adjusted estimates", nextNode: 'balanced_reporting' },
                { id: 'dismiss_trim', text: "Trim-and-fill overcorrects ‚Äî report original only", nextNode: 'selective_reporting' }
              ]
            },
            balanced_reporting: {
              id: 'balanced_reporting',
              situation: "Your results section shows: 'Primary analysis: RR 0.78 (0.65-0.93). Publication bias assessment: funnel plot asymmetric (Egger p=0.003), trim-and-fill adjusted RR 0.91 (0.77-1.08). True effect likely between these estimates.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE HOOK RETURNS: Remember Turner's 2008 analysis ‚Äî 94% of published antidepressant trials were positive vs 51% submitted to FDA. The missing studies change everything. Report the uncertainty, not the convenient estimate."
            },
            selective_reporting: {
              id: 'selective_reporting',
              situation: "You dismiss trim-and-fill as 'overly conservative.' But the asymmetry is real. The missing small negative trials would, if published, dramatically change your conclusion. You're reporting a biased literature, not truth.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE WARNING: Trim-and-fill isn't perfect, but neither is ignoring funnel asymmetry. When Egger's p<0.10 and the funnel is visibly asymmetric, missing-study bias is plausible. Report both estimates and discuss the implications honestly."
            },
            fraud_investigation: {
              id: 'fraud_investigation',
              situation: "You dig deeper into the two outlier studies. Both report identical SDs across groups. Baseline characteristics are perfectly matched. Follow-up is 100% in both. The 'too good to be true' alarm bells ring.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE QUESTION: DECREASE showed the same patterns. When small studies drive your meta-analysis result with implausible precision, investigate. You can't prove fraud, but you can conduct sensitivity analysis excluding suspicious studies."
            },
            true_het_explore: {
              id: 'true_het_explore',
              situation: "You hypothesize: maybe the small studies used different patient populations (sicker? specific subgroups?). But checking characteristics: the mega-trials actually had HIGHER risk patients. The small study effect isn't explained by case mix.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: When you can't explain heterogeneity by study characteristics, three explanations remain: chance, publication bias, or methodological differences. Each has different implications. Don't assume true heterogeneity without evidence."
            },
            mega_trial_bias: {
              id: 'mega_trial_bias',
              situation: "You focus on the mega-trials: RR ~0.90. But your co-author argues: 'Mega-trials enroll average patients. The small studies might have found populations who truly benefit more. You're throwing away important signal.'",
              question: "Who's right?",
              branches: [
                { id: 'mega_right', text: "Mega-trials are more reliable ‚Äî larger N means better estimate", nextNode: 'mega_wins' },
                { id: 'both_valid', text: "Both have value ‚Äî need subgroup analysis to understand", nextNode: 'subgroup_exploration' }
              ]
            },
            mega_wins: {
              id: 'mega_wins',
              situation: "You report only the mega-trial estimate. But ISIS-4 taught us: mega-trials answer one question (average effect in broad population). Small trials might answer a different question (effect in specific populations). Both could be 'right.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE GRADUAL REVEAL: ISIS-4 vs small trials wasn't necessarily 'wrong vs right' ‚Äî it might be 'different questions.' The small trials studied patients within 6 hours of MI. ISIS-4 enrolled up to 24 hours. Early treatment might truly work better."
            },
            subgroup_exploration: {
              id: 'subgroup_exploration',
              situation: "You conduct pre-specified subgroup analysis: time to treatment, patient age, disease severity. Time to treatment shows interaction (p=0.02): early treatment RR 0.65, late treatment RR 0.98. The small studies all used early treatment.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Heterogeneity can contain information. The treatment works ‚Äî but only early. ISIS-4 diluted the signal by including late patients. Subgroup analysis (when pre-specified) can rescue meaningful findings from heterogeneous data."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "What if the same data, analyzed two ways, gives opposite conclusions?",
          context: "Early surfactant administration in preterm infants was studied in multiple trials. Cochrane reviews synthesized the evidence. But a fascinating phenomenon emerged: the same trials, pooled with different statistical models, yielded different conclusions. One model said 'significant benefit.' The other said 'not significant.' Both were technically correct. Both could not both be true.",
          stats: [
            { value: "p=0.03", label: "Fixed-Effect Model", type: "success" },
            { value: "p=0.12", label: "Random-Effects Model", type: "" },
            { value: "I¬≤=45%", label: "Heterogeneity", type: "" },
            { value: "Opposite", label: "Conclusions", type: "danger" }
          ],
          source: "Cochrane Neonatal Reviews | Soll RF, Morley CJ",
          decisionScenario: "You are analyzing surfactant trials for preterm infants. Your meta-analysis shows moderate heterogeneity (I¬≤=45%). You must choose between fixed-effect and random-effects models.",
          pathA: {
            title: "Use fixed-effect model",
            steps: [
              "Assume all trials estimate one true effect",
              "Weight by inverse variance (large trials dominate)",
              "Get narrower confidence interval",
              "Result: RR 0.82 (95% CI: 0.69-0.98), p=0.03",
              "Conclusion: Significant benefit, recommend early surfactant",
              "But you assumed homogeneity when I¬≤=45% suggested otherwise"
            ]
          },
          pathB: {
            title: "Use random-effects model",
            steps: [
              "Assume trials estimate a distribution of effects",
              "Add between-study variance to weights",
              "Get wider confidence interval",
              "Result: RR 0.82 (95% CI: 0.64-1.05), p=0.12",
              "Conclusion: Non-significant, insufficient evidence",
              "You acknowledged the variation, but lost statistical significance"
            ]
          },
          revelation: "The choice of model is not technical ‚Äî it is philosophical. Fixed-effect asks: 'What is THE effect?' Random-effects asks: 'What is the AVERAGE effect across different settings?' When heterogeneity exists, these are different questions with different answers. Neither model is 'wrong.' But pretending homogeneity exists when it doesn't is a lie your statistics tell.",
          moduleConnection: "This is why model choice matters. The same point estimate (RR 0.82) becomes significant or non-significant based on your assumptions. Pre-specify a primary model, then report the alternative model as a sensitivity analysis when heterogeneity exists."
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "What does it mean when a confidence interval barely excludes 1.0?",
          context: "In 2007, Steve Nissen published a meta-analysis of rosiglitazone (Avandia), a blockbuster diabetes drug. Forty-two trials. Twenty-eight thousand patients. The forest plot showed something disturbing: the pooled odds ratio for myocardial infarction was 1.43, with a 95% CI of 1.03-1.98. The confidence interval barely excluded 1.0. Some dismissed it as 'barely significant.' But Nissen saw a 43% increase in heart attacks.",
          stats: [
            { value: "42", label: "Trials Pooled", type: "" },
            { value: "28,000", label: "Patients", type: "" },
            { value: "1.43", label: "Odds Ratio for MI", type: "danger" },
            { value: "1.03-1.98", label: "95% CI", type: "" }
          ],
          source: "Nissen SE, Wolski K. NEJM 2007; 356:2457-71",
          decisionScenario: "You see the rosiglitazone forest plot. The CI is 1.03-1.98. The lower bound barely excludes 1.0. Your colleague says 'It's barely significant ‚Äî could be noise.'",
          pathA: {
            title: "Focus on statistical significance ‚Äî 'just barely' means uncertain",
            steps: [
              "Note CI barely excludes 1.0",
              "Argue result could be due to chance",
              "Recommend waiting for more data",
              "Drug continues widespread use",
              "Thousands more MIs occur while waiting",
              "Eventually FDA issues black-box warning anyway"
            ]
          },
          pathB: {
            title: "Focus on clinical significance ‚Äî 43% more heart attacks matters",
            steps: [
              "Point estimate is 43% increased MI risk",
              "Even lower CI bound (3% increase) is clinically meaningful",
              "28,000 patients isn't a small study",
              "Recommend immediate FDA review",
              "FDA issues black-box warning",
              "European regulators withdraw the drug"
            ]
          },
          revelation: "Statistical significance is a threshold. Clinical significance is a judgment. The forest plot shows both ‚Äî you must see both. A 43% increase in heart attacks is not 'barely' anything. It is a signal that thousands of patients are being harmed. Nissen's meta-analysis changed practice because he understood: the question is not 'Is p < 0.05?' The question is 'Are patients being hurt?'",
          moduleConnection: "This is why forest plots matter. They show you not just the pooled estimate, but the precision and the clinical meaning. A CI of 1.03-1.98 tells you: even in the best case, MI risk is increased. The worst case is doubled. That is not statistical noise ‚Äî that is a drug that should not be on the market."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A random effects meta-analysis gives more weight to small studies than a fixed effect analysis. Why is this potentially problematic?",
          options: [
            { id: 'a', text: "Small studies have larger sampling error", correct: false },
            { id: 'b', text: "Small studies are more likely to be published if they show positive results", correct: true },
            { id: 'c', text: "Small studies use inferior methodology", correct: false },
            { id: 'd', text: "Small studies measure different outcomes", correct: false }
          ],
          explanation: "Publication bias disproportionately affects small studies ‚Äî negative small trials often go unpublished, while positive ones make it through. By giving more weight to small studies, random effects can amplify this bias, producing inflated pooled estimates."
        }
      }
    ]
  },
  // Module 9: The Heterogeneity
  {
    id: 9,
    title: "The Heterogeneity",
    subtitle: "Beyond I-squared",
    principle: 5,
    story: "ACCORD",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "The average can lie"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE PARADOX: ACCORD ‚Äî WHEN AVERAGES KILL",
          source: "NEJM 2008; 358:2545-2559 | ACCORD Study Group | PubMed: 18539917",
          timeline: [
            { year: "1998-2007", text: "Multiple trials suggest intensive glucose control (HbA1c < 7%) reduces complications. Meta-analyses support benefit.", type: "normal" },
            { year: "2003", text: "ACCORD begins: 10,251 diabetics randomized to intensive (HbA1c < 6.0%) vs standard (7.0-7.9%) control.", type: "normal" },
            { year: "Feb 2008", text: "DSMB stops intensive arm early. 257 deaths vs 203. HR 1.22 (95% CI: 1.01-1.46). p = 0.04.", type: "crisis" },
            { year: "The Paradox", text: "HbA1c lowered successfully (6.4% vs 7.5%). But MORE people died. The surrogate improved while patients worsened.", type: "crisis" },
            { year: "The Truth", text: "Subgroups diverged: patients with long diabetes duration, prior CVD, or hypoglycemic episodes were harmed. The average masked lethal heterogeneity.", type: "revelation" }
          ],
          realData: {
            endpoint: "All-cause mortality",
            drug: "257/5,128 (5.0%)",
            placebo: "203/5,123 (4.0%)",
            rr: "1.22",
            ci: "1.01-1.46",
            nnh: "95"
          },
          hook: "The average showed harm. But the average isn't a person. Somewhere in that average were patients who benefited. And patients who died. Heterogeneity isn't a nuisance ‚Äî it's where the truth hides."
        }
      },
      {
        type: 'content',
        content: {
          title: "Understanding Heterogeneity Metrics",
          sections: [
            {
              heading: "I¬≤ ‚Äî Percentage of Variance Due to Heterogeneity",
              items: [
                "0%: no heterogeneity (differences due to sampling only)",
                "25%: low heterogeneity",
                "50%: moderate heterogeneity",
                "75%+: high heterogeneity",
                "Limitation: depends on precision, not just variability"
              ]
            },
            {
              heading: "œÑ¬≤ ‚Äî Between-Study Variance",
              items: [
                "Absolute measure of heterogeneity",
                "Same units as effect size (squared)",
                "Doesn't depend on number or size of studies",
                "Harder to interpret directly"
              ]
            },
            {
              heading: "Prediction Interval ‚Äî The Crucial Metric",
              items: [
                "Where would the true effect lie in a NEW study?",
                "Incorporates both CI and heterogeneity",
                "If it crosses null, treatment may not work everywhere",
                "The clinically relevant question"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: EXPLORING HETEROGENEITY",
          title: "Finding the Signal in the Noise",
          sections: [
            {
              heading: "Visual Inspection",
              text: "Look at the forest plot. Do confidence intervals overlap? Are there outliers? Is there a pattern (small vs large studies, old vs new)?"
            },
            {
              heading: "Subgroup Analysis",
              text: "Pre-specified comparisons: dose, duration, population, risk of bias. Test for interaction (is the effect different between subgroups?). Beware multiple testing."
            },
            {
              heading: "Meta-Regression",
              text: "Model effect size as function of study characteristics. Requires 10+ studies per covariate. Ecological fallacy risk: study-level associations may not reflect patient-level."
            },
            {
              heading: "Sensitivity Analysis",
              text: "Leave-one-out: does any single study drive the result? High vs low RoB: does quality matter? Fixed vs random: does model choice change conclusion?"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'heterogeneity-explorer',
          title: "Heterogeneity Explorer",
          description: "Visualize and interpret I¬≤, œÑ¬≤, and prediction intervals"
        }
      },
      {
        type: 'content',
        content: {
          title: "THE TRAP: False Class Effects ‚Äî HES Fluids in Sepsis",
          sections: [
            {
              heading: "The Assumption",
              items: [
                "Colloid fluids (HES, albumin) maintain intravascular volume better than crystalloids",
                "For decades, this was 'known' ‚Äî it made physiological sense",
                "Meta-analyses pooled all colloids vs crystalloids, assuming class effect"
              ]
            },
            {
              heading: "6S Trial (2012) ‚Äî The First Crack",
              items: [
                "798 patients with severe sepsis: HES vs Ringer's acetate",
                "90-day mortality: RR 1.17 (95% CI: 1.01-1.36) ‚Äî HES HARMFUL",
                "Renal replacement therapy: RR 1.35 (1.01-1.80) ‚Äî HES caused kidney failure",
                "Source: NEJM 2012; PubMed 22738085"
              ]
            },
            {
              heading: "CHEST Trial (2012) ‚Äî Confirmation",
              items: [
                "7,000 ICU patients: HES vs saline",
                "90-day mortality: RR 1.06 (0.96-1.18) ‚Äî trend toward harm",
                "Renal replacement: RR 1.21 (1.00-1.45) ‚Äî significant kidney harm",
                "Source: NEJM 2012; DOI 10.1056/NEJMoa1209759"
              ]
            },
            {
              heading: "THE WARNING: Class Effects Are Hypotheses, Not Facts",
              items: [
                "HES, albumin, and other colloids are NOT interchangeable",
                "A meta-analysis pooling 'all colloids' hid that HES specifically was harmful",
                "Heterogeneity within a drug class can be life-or-death",
                "THE QUESTION: When you pool 'Drug Class X', are you assuming equivalence you can't prove?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'heterogeneity_decision_tree',
          title: "The Prediction Interval Problem",
          scenario: "Drug X for fracture prevention: 8 trials, RR 0.70 (95% CI 0.58-0.85). I¬≤ = 68%. Prediction interval: RR 0.42-1.17. Your hospital committee asks: 'Should we add Drug X to formulary?'",
          realCase: "ACCORD showed intensive glucose control 'worked' on average ‚Äî HbA1c dropped from 8.1% to 6.4%. But some patients died. The average masked lethal subgroup heterogeneity. Knowing the average isn't enough.",
          nodes: {
            start: {
              id: 'start',
              situation: "The committee chair says: 'RR 0.70 means 30% fracture reduction. CI excludes 1.0. This is strong evidence. Let's approve it.' Your clinical pharmacist raises the prediction interval concern.",
              question: "How do you explain the prediction interval to the committee?",
              branches: [
                { id: 'explain_pi', text: "The PI tells us what to expect in OUR hospital", nextNode: 'pi_explanation' },
                { id: 'support_chair', text: "The chair is right ‚Äî CI is what matters for 'average effect'", nextNode: 'chair_mistake' },
                { id: 'explore_heterogeneity', text: "Before deciding, we need to understand WHY effects vary", nextNode: 'heterogeneity_exploration' }
              ]
            },
            pi_explanation: {
              id: 'pi_explanation',
              situation: "You explain: 'The CI tells us we're confident the average is between 0.58-0.85. But our hospital isn't average. The PI tells us: in a new setting like ours, the true effect could range from 58% reduction to 17% INCREASE in fractures.'",
              question: "The chair asks: 'How can a drug that works on average harm some patients?'",
              branches: [
                { id: 'accord_example', text: "Use ACCORD as an example ‚Äî average benefit, subgroup harm", nextNode: 'accord_lesson' },
                { id: 'technical_explanation', text: "Explain œÑ¬≤ and between-study variance mathematically", nextNode: 'lost_committee' },
                { id: 'practical_implications', text: "Focus on what this means for formulary decision", nextNode: 'practical_path' }
              ]
            },
            accord_lesson: {
              id: 'accord_lesson',
              situation: "You explain ACCORD: 'Intensive glucose control lowered average HbA1c beautifully. But the trial was stopped ‚Äî 257 deaths vs 203. Patients with long diabetes duration, prior CVD, or hypoglycemia were harmed while others benefited. The average masked the harm.'",
              question: "The committee asks: 'So what do we do with Drug X?'",
              branches: [
                { id: 'conditional_approval', text: "Approve with restrictions ‚Äî identify who benefits", nextNode: 'smart_approval' },
                { id: 'reject_drug', text: "Reject until we understand the heterogeneity", nextNode: 'cautious_rejection' }
              ]
            },
            smart_approval: {
              id: 'smart_approval',
              situation: "You propose: 'Approve Drug X for patients matching the trials where it worked best. Looking at the forest plot: trials in high-risk patients (prior fracture) show RR 0.55. Trials in moderate-risk patients show RR 0.95.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Heterogeneity can guide personalization. Instead of giving everyone 'average' treatment, identify who benefits most. This is precision medicine informed by meta-analysis. The PI flagged that one size doesn't fit all."
            },
            cautious_rejection: {
              id: 'cautious_rejection',
              situation: "The committee delays approval pending subgroup analysis. Three months later, you present: 'Drug X works in high-risk patients (RR 0.55) but not low-risk (RR 0.98). We should approve for high-risk only.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: Caution was warranted. Universal approval would have exposed low-risk patients to side effects without benefit. The PI crossing 1.0 was a warning sign that the drug didn't work everywhere."
            },
            lost_committee: {
              id: 'lost_committee',
              situation: "You explain œÑ¬≤ = 0.15, meaning between-study variance in log RR. The committee's eyes glaze over. The chair says: 'Let's just go with the significant CI.' Your technical accuracy didn't translate to better decision-making.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE WARNING: Technical correctness isn't enough. Decision-makers need clinical translation. 'The drug might harm some patients' is clearer than 'œÑ¬≤ is high.' Communicate uncertainty in terms that matter to your audience."
            },
            practical_path: {
              id: 'practical_path',
              situation: "You reframe: 'If we approve Drug X for everyone, most will benefit. But some ‚Äî we don't know exactly who ‚Äî might have MORE fractures. Are we comfortable with that uncertainty, or should we restrict approval?'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE QUESTION: The PI doesn't tell you what to do ‚Äî it tells you what you don't know. The decision depends on risk tolerance, reversibility of harm, and whether you can identify who's at risk. Frame uncertainty, let the committee decide."
            },
            chair_mistake: {
              id: 'chair_mistake',
              situation: "You support the chair. Drug X is approved for all patients. One year later: audit shows fracture rates unchanged in your low-risk patients, but two high-risk patients had adverse events. The drug wasn't harmful 'on average' ‚Äî but averages don't treat patients.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: ACCORD killed patients because decisions were based on averages. The CI told them 'the average benefits.' The truth was: some people benefit, some people die. The PI would have flagged this. You ignored the warning."
            },
            heterogeneity_exploration: {
              id: 'heterogeneity_exploration',
              situation: "You suggest: 'Before deciding, let's look at WHY effects vary.' You examine the 8 trials. Pattern emerges: 4 trials in high-risk patients (prior fracture) ‚Äî RR 0.55. 4 trials in moderate-risk patients ‚Äî RR 0.95.",
              question: "What explains this pattern?",
              branches: [
                { id: 'biological_explanation', text: "High-risk patients have more room to benefit", nextNode: 'subgroup_insight' },
                { id: 'trial_quality', text: "Maybe the high-risk trials had methodological problems", nextNode: 'quality_check' },
                { id: 'chance', text: "Could be chance with 4 vs 4 trials", nextNode: 'credibility_assessment' }
              ]
            },
            subgroup_insight: {
              id: 'subgroup_insight',
              situation: "Biological plausibility: Drug X strengthens bones. Patients with prior fractures have weaker bones ‚Äî more potential for improvement. Patients with already-strong bones can't get much stronger. The heterogeneity reflects biology, not noise.",
              question: "How does this change your recommendation?",
              branches: [
                { id: 'targeted_therapy', text: "Recommend Drug X only for high-risk patients", nextNode: 'precision_medicine' },
                { id: 'broad_approval', text: "Still approve broadly ‚Äî moderate-risk isn't harmed", nextNode: 'missed_opportunity' }
              ]
            },
            precision_medicine: {
              id: 'precision_medicine',
              situation: "Your recommendation: 'Formulary approval restricted to patients with prior fragility fracture, T-score ‚â§-2.5, or FRAX ‚â•20%.' The committee adopts this. Drug costs decrease (fewer treated), outcomes improve (treating responders).",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REVELATION: The prediction interval wasn't a problem ‚Äî it was information. By understanding heterogeneity, you turned 'average effect' into personalized medicine. This is the positive use of Principle 6: The average can lie ‚Äî but the subgroups tell truth."
            },
            missed_opportunity: {
              id: 'missed_opportunity',
              situation: "Drug X approved for everyone. High-risk patients benefit. Moderate-risk patients take pills daily for no benefit, experience side effects, and incur costs. You had the information to do better ‚Äî but averaged it away.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: 'Not harmful on average' isn't the same as 'beneficial for everyone.' ACCORD, ISIS-4, and countless meta-analyses show: heterogeneity is information. When the PI is wide, ask who benefits ‚Äî don't just treat everyone."
            },
            quality_check: {
              id: 'quality_check',
              situation: "You check: the high-risk trials have low RoB (proper blinding, allocation concealment). The moderate-risk trials also have low RoB. Trial quality doesn't explain the difference. The effect modification seems real.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Before trusting subgroup findings, verify they aren't confounded by study quality. Here, both subgroups have similar RoB. The differential effect is more likely to be real when quality is balanced."
            },
            credibility_assessment: {
              id: 'credibility_assessment',
              situation: "You apply ICEMAN criteria: Is the subgroup pre-specified? (Yes) Is the effect consistent in direction? (Yes) Is there biological plausibility? (Yes) Is the test of interaction significant? (p = 0.03) Credibility: moderate-high.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: Not all subgroup analyses are created equal. ICEMAN criteria help distinguish real effect modification from data dredging. When multiple criteria are met, you can cautiously act on the subgroup finding."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "Seven small trials agree. Then one large trial disagrees. Who is right?",
          context: "In the early 1990s, magnesium sulfate for acute myocardial infarction looked like a miracle. Seven small trials (total n=1,301) showed magnesium reduced mortality by 55%. A meta-analysis declared the evidence 'conclusive.' Some argued further trials were unethical. Then came ISIS-4 ‚Äî a mega-trial of 58,050 patients. The result shocked the field.",
          stats: [
            { value: "OR 0.44", label: "Small Trials Pooled", type: "success" },
            { value: "55%", label: "Claimed Mortality Reduction", type: "" },
            { value: "OR 1.06", label: "ISIS-4 Result", type: "danger" },
            { value: "58,050", label: "ISIS-4 Patients", type: "" }
          ],
          source: "ISIS-4 Collaborative Group. Lancet 1995; 345:669-85",
          decisionScenario: "You are pooling magnesium trials for acute MI. Your meta-analysis of small trials shows OR 0.44 (strong benefit). Then ISIS-4 publishes showing OR 1.06 (no benefit). The heterogeneity is massive.",
          pathA: {
            title: "Assume homogeneity ‚Äî pool all trials together",
            steps: [
              "Include both small trials and ISIS-4 in one analysis",
              "Pooled estimate: somewhere between 0.44 and 1.06",
              "Result is a meaningless 'average' of contradictory findings",
              "CI is wide, heterogeneity is extreme",
              "Clinicians confused: does magnesium work or not?",
              "No one learns WHY the trials disagreed"
            ]
          },
          pathB: {
            title: "Investigate heterogeneity ‚Äî find the message in the noise",
            steps: [
              "Ask: what differs between small trials and ISIS-4?",
              "Small trials: treatment within 6 hours of symptom onset",
              "ISIS-4: treatment up to 24 hours after symptom onset",
              "Hypothesis: magnesium works early but not late",
              "Subgroup analysis confirms time-dependent effect",
              "You discover effect modification, not contradiction"
            ]
          },
          revelation: "Heterogeneity is not noise. It is a message. The I¬≤ statistic tells you someone is different ‚Äî your job is to find out who. ISIS-4 was not 'wrong' and the small trials were not 'wrong.' They were answering different questions. Early magnesium might work. Late magnesium does not. The pooled estimate obscured the truth that subgroup analysis revealed.",
          moduleConnection: "This is why heterogeneity exploration matters. When your I¬≤ is high and studies conflict, you have three options: (1) pool anyway and get a meaningless average, (2) refuse to pool and waste data, or (3) investigate and discover what your data is trying to tell you. Option 3 is usually correct."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Two meta-analyses both show I¬≤ = 50%. Analysis A has œÑ¬≤ = 0.02 with mean RR 0.80. Analysis B has œÑ¬≤ = 0.50 with mean RR 0.80. What does this tell you?",
          options: [
            { id: 'a', text: "They have identical heterogeneity since I¬≤ is the same", correct: false },
            { id: 'b', text: "Analysis B has much more absolute variability in true effects", correct: true },
            { id: 'c', text: "Analysis A is more reliable", correct: false },
            { id: 'd', text: "Cannot compare without knowing number of studies", correct: false }
          ],
          explanation: "I¬≤ is a proportion (% variance due to heterogeneity) but œÑ¬≤ is absolute between-study variance. Two analyses can have identical I¬≤ but very different œÑ¬≤. Analysis B has 25√ó more absolute heterogeneity ‚Äî the true effects are far more spread out, meaning wider prediction intervals and more uncertainty about any specific application."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've mastered the SYNTHESIS phase.\n\n‚úì Module 7: EFFECT SIZES ‚Äî learned from SSRI's metric controversy\n‚úì Module 8: META-ANALYSIS MODELS ‚Äî learned from ISIS-4's small-study deception\n‚úì Module 9: HETEROGENEITY ‚Äî learned from ACCORD's lethal subgroups\n\nYou can now calculate pooled estimates, choose appropriate models, and interpret heterogeneity.\n\nFinal phase: QUALITY ASSURANCE ‚Äî detecting publication bias, rating certainty with GRADE, and reporting transparently.\n\nRemember: A beautiful forest plot means nothing if you've pooled garbage."
        }
      }
    ]
  },
  // Module 10: The Bias
  {
    id: 10,
    title: "The Bias",
    subtitle: "Publication Bias",
    principle: 6,
    story: "Antidepressants",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Certainty must be justified"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVELATION: TURNER'S EXPOS√â ‚Äî THE MISSING HALF",
          source: "NEJM 2008; 358:252-260 | Turner et al | PubMed: 18199864",
          timeline: [
            { year: "1987-2004", text: "12 antidepressants approved by FDA. Drug companies submit 74 trials to regulators. The published literature shows these drugs work wonderfully.", type: "normal" },
            { year: "2006", text: "Turner, a former FDA reviewer, gains access to the FDA's internal trial database. He compares what FDA saw vs. what doctors read.", type: "normal" },
            { year: "The Count", text: "FDA received 74 trials. 38 were positive. 36 were negative or questionable. FDA saw 51% positive. What did journals publish?", type: "normal" },
            { year: "The Revelation", text: "Of 38 positive trials: 37 published (97%). Of 36 negative trials: 14 published (39%) ‚Äî and 11 of those 14 were 'spun' to appear positive.", type: "crisis" },
            { year: "Jan 2008", text: "Turner publishes: Published literature shows 94% positive trials. Reality: 51%. Effect sizes inflated 32%. Doctors prescribing based on a mirage.", type: "crisis" },
            { year: "The Question", text: "How many patients were harmed by drugs that 'worked' in publications but didn't work in reality? We will never know. The filing cabinet killed them silently.", type: "revelation" }
          ],
          realData: {
            endpoint: "Trial outcomes as assessed by FDA",
            drug: "74 trials submitted to FDA",
            placebo: "Published literature",
            rr: "FDA: 51% positive | Published: 94% positive",
            ci: "Effect size inflation: +32%",
            nnh: "The gap between truth and literature"
          },
          hook: "THE WARNING: Every meta-analysis of published literature is a meta-analysis of what industry wanted you to see. The filing cabinet is where inconvenient truths go to die. Turner proved what everyone suspected: we've been reading fiction disguised as science."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: Turner proved that 94% of published antidepressant trials showed benefit while only 51% actually did. Effect sizes were inflated by 32%. Every meta-analysis you read is a summary of what survived the filing cabinet ‚Äî and the filing cabinet is full of inconvenient truths that never saw daylight."
        }
      },
      {
        type: 'content',
        content: {
          title: "THE LESSON: When One Positive Trial Drove Guidelines ‚Äî PROWESS",
          sections: [
            {
              heading: "The Single Hero Trial (2001)",
              items: [
                "PROWESS: 1,690 patients with severe sepsis. Activated Protein C (APC) vs placebo.",
                "Result: 28-day mortality 24.7% vs 30.8%. RR 0.81 (0.70-0.93). p = 0.005.",
                "FDA approves. Guidelines recommend APC for severe sepsis. Cost: $8,000/treatment.",
                "PROWESS becomes the ONLY evidence. No replication required."
              ]
            },
            {
              heading: "The Failed Replications (2005-2011)",
              items: [
                "ADDRESS trial (2005): Low-risk sepsis. Stopped early ‚Äî trend toward HARM in some subgroups.",
                "RESOLVE trial (2007): Pediatric sepsis. No benefit, more bleeding.",
                "Meta-analysts kept pooling: 'Overall still favors APC.' PROWESS dominated every meta-analysis."
              ]
            },
            {
              heading: "The Definitive Test ‚Äî PROWESS-SHOCK (2012)",
              items: [
                "1,697 patients with septic shock. Rigorous replication of original PROWESS.",
                "Result: 28-day mortality 26.4% vs 24.2%. RR 1.09 (0.92-1.28).",
                "NO BENEFIT. Drug withdrawn from market worldwide.",
                "Source: NEJM 2012; PubMed 22616830"
              ]
            },
            {
              heading: "THE WARNING: Leave-One-Out Would Have Shown This",
              items: [
                "Every meta-analysis of APC was driven by PROWESS alone",
                "Remove PROWESS ‚Üí no significant effect remained",
                "One trial shouldn't drive guidelines. One trial shouldn't drive meta-analyses.",
                "THE QUESTION: Is your meta-analysis result robust to removing the largest/earliest trial?"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Detecting Publication Bias",
          sections: [
            {
              heading: "Funnel Plot",
              items: [
                "Plot effect size vs precision (SE or sample size)",
                "Symmetry expected if no bias: small studies scatter evenly",
                "Asymmetry suggests: publication bias, small-study effects, or true heterogeneity"
              ]
            },
            {
              heading: "Statistical Tests",
              items: [
                "Egger's test: regression of effect on SE (intercept ‚â† 0 suggests asymmetry)",
                "Peter's test: for binary outcomes, uses sample size",
                "Begg's test: rank correlation (less powerful)",
                "Note: all tests have low power with <10 studies"
              ]
            },
            {
              heading: "Contour-Enhanced Funnels",
              items: [
                "Shade regions by statistical significance",
                "If missing studies cluster in non-significant region ‚Üí publication bias likely",
                "If asymmetry spans significance zones ‚Üí may be other small-study effects"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: ASSESSING AND ADJUSTING",
          title: "Beyond the Funnel Plot",
          sections: [
            {
              heading: "Compare Registered to Published",
              text: "Search ClinicalTrials.gov, ICTRP, FDA submissions. Calculate: % registered that were published, % published as positive. This is the strongest evidence."
            },
            {
              heading: "Trim-and-Fill",
              text: "Imputes 'missing' studies to achieve funnel symmetry. Provides adjusted pooled estimate. Major limitation: assumes asymmetry = publication bias (may overcorrect)."
            },
            {
              heading: "Selection Models",
              text: "Model the probability of publication as function of p-value. More sophisticated than trim-and-fill. Requires assumptions about selection mechanism."
            },
            {
              heading: "Limitations",
              text: "Asymmetry ‚â† publication bias. Could be: true heterogeneity (small studies in high-risk populations), methodological differences, chance (especially with few studies). Visual and statistical tests are hypothesis-generating, not confirmatory."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'funnel-plot',
          title: "Funnel Plot Builder",
          description: "Create funnel plots with Egger's test and contour enhancement"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'funnel_decision_tree',
          title: "The Asymmetric Funnel",
          scenario: "New medication meta-analysis: 15 trials, RR 0.72 (95% CI 0.58-0.89). Your funnel plot shows clear asymmetry. Small studies cluster on the positive side. Egger's p = 0.02. Trim-and-fill changes RR to 0.89 (95% CI 0.72-1.10, non-significant).",
          realCase: "Turner's 2008 NEJM study: 74 antidepressant trials submitted to FDA. Published literature showed 94% positive. Truth: 51% positive. Effect sizes inflated by 32%. The funnel would have shown this ‚Äî if anyone had looked.",
          nodes: {
            start: {
              id: 'start',
              situation: "Your co-author says: 'The funnel is clearly asymmetric. We should report the trim-and-fill adjusted estimate as our main finding ‚Äî it's more honest.' The biostatistician disagrees: 'Trim-and-fill overcorrects. We don't know if it's publication bias.'",
              question: "Whose side do you take?",
              branches: [
                { id: 'support_trimfill', text: "Support co-author ‚Äî adjusted estimate is more honest", nextNode: 'trimfill_problems' },
                { id: 'support_stats', text: "Support biostatistician ‚Äî original estimate is valid", nextNode: 'original_defense' },
                { id: 'both_wrong', text: "Both are partially right ‚Äî report both estimates", nextNode: 'balanced_approach' }
              ]
            },
            trimfill_problems: {
              id: 'trimfill_problems',
              situation: "You report the adjusted RR 0.89 as your main finding. Reviewer 2 asks: 'Trim-and-fill assumes asymmetry equals publication bias. What if the asymmetry is due to true heterogeneity ‚Äî small studies enrolling higher-risk patients?'",
              question: "How do you check this?",
              branches: [
                { id: 'check_contour', text: "Use contour-enhanced funnel plot", nextNode: 'contour_analysis' },
                { id: 'check_characteristics', text: "Compare patient characteristics across study sizes", nextNode: 'characteristic_check' },
                { id: 'admit_limitation', text: "Acknowledge we can't distinguish the causes", nextNode: 'honest_limitation' }
              ]
            },
            contour_analysis: {
              id: 'contour_analysis',
              situation: "Your contour-enhanced funnel shows: the 'missing' studies would fall in the non-significant zone (white area). Studies in the significant zone (shaded) are all published. This pattern suggests publication bias, not heterogeneity.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: Contour-enhanced funnels distinguish bias from heterogeneity. If missing studies cluster in non-significant areas, publication bias is likely. If they span significance zones, other explanations (heterogeneity, study quality) are possible."
            },
            characteristic_check: {
              id: 'characteristic_check',
              situation: "You check: small positive studies have similar baseline characteristics to large neutral studies. No systematic difference in patient risk. The asymmetry isn't explained by case mix ‚Äî publication bias remains the likely explanation.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: Multiple lines of evidence converge on publication bias: (1) funnel asymmetry, (2) Egger's test, (3) missing studies in non-significant zone, (4) no case-mix explanation. Still can't prove it, but evidence is accumulating."
            },
            honest_limitation: {
              id: 'honest_limitation',
              situation: "You write: 'Funnel asymmetry and Egger's test suggest potential publication bias. Trim-and-fill adjusts for this (RR 0.89), but the adjustment assumes all asymmetry is bias. True effect likely lies between 0.72 and 0.89.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE QUESTION: When you can't distinguish causes, bracket the uncertainty. 'Effect between 0.72-0.89' is less precise but more honest than picking one estimate. Readers can judge based on their prior beliefs about publication bias."
            },
            original_defense: {
              id: 'original_defense',
              situation: "You report only RR 0.72. The journal editor returns: 'Your funnel is clearly asymmetric. ICMJE guidelines require addressing publication bias. You cannot omit this analysis.'",
              question: "What do you do?",
              branches: [
                { id: 'add_analysis', text: "Add trim-and-fill as sensitivity analysis", nextNode: 'proper_reporting' },
                { id: 'argue_editor', text: "Argue that Egger's test has high false positive rate", nextNode: 'editor_pushback' }
              ]
            },
            proper_reporting: {
              id: 'proper_reporting',
              situation: "Your revised manuscript: 'Primary analysis: RR 0.72 (0.58-0.89). Funnel plot asymmetry (Egger p=0.02) raises concern for publication bias. Sensitivity analysis with trim-and-fill: RR 0.89 (0.72-1.10).' Reviewers are satisfied.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REPETITION: Turner's antidepressant analysis showed what happens when you only see published data. By reporting both estimates, you let readers see the uncertainty. The truth is probably somewhere between."
            },
            editor_pushback: {
              id: 'editor_pushback',
              situation: "The editor responds: 'Yes, Egger's test has limitations. But your asymmetry is visible and statistically significant. Not reporting it is selective reporting in itself. Either address publication bias or we cannot proceed.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: Hiding evidence of publication bias is itself a form of bias. CONSORT and PRISMA require funnel plots and assessment. Transparency about uncertainty is not optional in modern systematic reviews."
            },
            balanced_approach: {
              id: 'balanced_approach',
              situation: "You propose reporting both: original as primary (following protocol), trim-and-fill as sensitivity. But you also do something the others didn't suggest: check trial registrations.",
              question: "What does the registry comparison show?",
              branches: [
                { id: 'registry_confirms', text: "15 published trials, but 23 registered ‚Äî 8 missing", nextNode: 'definitive_bias' },
                { id: 'registry_matches', text: "15 published, 15 registered ‚Äî no missing trials", nextNode: 'not_pub_bias' },
                { id: 'registry_unavailable', text: "Most trials pre-date registration requirements", nextNode: 'uncertain_outcome' }
              ]
            },
            definitive_bias: {
              id: 'definitive_bias',
              situation: "You find 8 registered but unpublished trials. You contact investigators. Three provide data: all negative (RR 0.95-1.10). Adding them: pooled RR becomes 0.85 (95% CI 0.70-1.03). The original estimate was inflated by publication bias.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REVELATION: This is the gold standard ‚Äî comparing registered to published. Turner did this for antidepressants. You did it for your drug. The registry proves what the funnel only suggested. This is definitive evidence of bias."
            },
            not_pub_bias: {
              id: 'not_pub_bias',
              situation: "All 15 registered trials are published. No missing studies. The asymmetry must be due to something else ‚Äî probably small-study effects (higher-risk patients enrolled, more variable care) rather than suppressed negative trials.",
              question: "How does this change your interpretation?",
              branches: [
                { id: 'revise_conclusion', text: "Report original estimate ‚Äî asymmetry isn't publication bias", nextNode: 'legitimate_small_study' },
                { id: 'still_cautious', text: "Still report trim-and-fill ‚Äî asymmetry is concerning regardless", nextNode: 'overcautious' }
              ]
            },
            legitimate_small_study: {
              id: 'legitimate_small_study',
              situation: "You write: 'Funnel asymmetry (Egger p=0.02) could suggest publication bias, but registry comparison shows all registered trials are published. Asymmetry likely reflects small-study effects (differential treatment effects in high-risk patients in smaller trials).'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE HOOK: Not all asymmetry is publication bias. Small studies often enroll sicker patients who benefit more. Registry comparison is the definitive test. Without it, funnel plots are suggestive but not conclusive."
            },
            overcautious: {
              id: 'overcautious',
              situation: "You report trim-and-fill adjusted estimate despite evidence against publication bias. A competitor meta-analysis reports the original estimate with proper registry justification. Their result is cited as more accurate. Yours appears overcautious.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE WARNING: Being too conservative can also be wrong. If registry comparison exonerates publication bias, trim-and-fill 'correction' introduces error. Match your adjustment to the evidence."
            },
            uncertain_outcome: {
              id: 'uncertain_outcome',
              situation: "Most trials are from 1998-2005, before registration was required. You can't determine if negative trials were conducted but not published. The registry evidence is incomplete.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE GRADUAL REVEAL: This is the historical reality for many questions. Pre-2005 trials often lack registration. Report the funnel asymmetry, Egger's test, and trim-and-fill. Acknowledge you can't determine the cause. Let readers judge."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Your funnel plot for 8 studies shows asymmetry with small positive studies missing. Egger's test p=0.08. What can you conclude?",
          options: [
            { id: 'a', text: "No publication bias since Egger's test is not significant", correct: false },
            { id: 'b', text: "Publication bias present since funnel is asymmetric", correct: false },
            { id: 'c', text: "Insufficient power to detect bias ‚Äî visual asymmetry is suggestive but inconclusive", correct: true },
            { id: 'd', text: "Need to perform trim-and-fill to determine if bias exists", correct: false }
          ],
          explanation: "With only 8 studies, Egger's test has very low power (<50% even with substantial bias). Visual asymmetry is suggestive but could be chance. The appropriate conclusion is uncertainty ‚Äî report the observation but acknowledge you can't confirm the cause."
        }
      }
    ]
  },
  // Module 11: The Certainty (GRADE)
  {
    id: 11,
    title: "The Certainty",
    subtitle: "GRADE Framework",
    principle: 6,
    story: "SPRINT",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Certainty must be justified"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE PARADOX: SPRINT vs ACCORD ‚Äî THE SAME TREATMENT, OPPOSITE ANSWERS",
          source: "NEJM 2015; 373:2103-2116 (SPRINT) | NEJM 2010; 362:1575-1585 (ACCORD BP)",
          timeline: [
            { year: "2003-2009", text: "ACCORD BP randomizes 4,733 diabetics to intensive (<120) vs standard (<140) BP control. The diabetes community waits for guidance.", type: "normal" },
            { year: "Mar 2010", text: "ACCORD BP results: Primary composite HR 0.88 (0.73-1.06). NOT significant. Serious adverse events INCREASED. Intensive control doesn't help diabetics.", type: "crisis" },
            { year: "2010-2015", text: "SPRINT excludes diabetics (citing ACCORD), enrolls 9,361 non-diabetics. Same intensive target (<120). Different population.", type: "normal" },
            { year: "Aug 2015", text: "SPRINT stopped EARLY for benefit. CV composite HR 0.75 (0.64-0.89). All-cause mortality HR 0.73 (0.60-0.90). Headlines: 'BP Revolution!'", type: "revelation" },
            { year: "The Paradox", text: "Same treatment: intensive BP control. SPRINT (non-diabetics): 25% benefit. ACCORD (diabetics): no benefit, more harm. The truth depends on WHO you treat.", type: "revelation" },
            { year: "The Warning", text: "Hospitals applied SPRINT targets to ALL patients including diabetics. But diabetics had ACCORD evidence ‚Äî showing no benefit. Indirectness isn't abstract. It's life and death.", type: "crisis" }
          ],
          realData: {
            endpoint: "Primary CV composite",
            drug: "SPRINT (non-diabetics): HR 0.75 (0.64-0.89)",
            placebo: "ACCORD BP (diabetics): HR 0.88 (0.73-1.06)",
            rr: "Same intervention, opposite results",
            ci: "SPRINT: significant benefit | ACCORD: null",
            nnh: "Context is everything"
          },
          hook: "THE QUESTION: A diabetic patient asks about intensive BP control. You cite SPRINT. But SPRINT excluded diabetics BECAUSE of ACCORD. You've applied evidence to the exact population it was designed to avoid. This is indirectness ‚Äî and GRADE exists to catch it."
        }
      },
      {
        type: 'content',
        content: {
          title: "GRADE: Grading Certainty in Evidence",
          sections: [
            {
              heading: "Starting Point:",
              items: [
                "RCTs start at HIGH certainty",
                "Observational studies start at LOW certainty"
              ]
            },
            {
              heading: "Five Reasons to Rate DOWN:",
              items: [
                "1. Risk of bias (lack of blinding, attrition, etc.)",
                "2. Inconsistency (heterogeneity without explanation)",
                "3. Indirectness (different P, I, C, or O from your question)",
                "4. Imprecision (wide CI, small sample, few events)",
                "5. Publication bias (missing studies)"
              ]
            },
            {
              heading: "Three Reasons to Rate UP (for observational):",
              items: [
                "1. Large effect (RR >2 or <0.5)",
                "2. Dose-response gradient",
                "3. All plausible confounders would reduce effect"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: MAKING GRADE JUDGMENTS",
          title: "From Evidence to Certainty",
          sections: [
            {
              heading: "Risk of Bias",
              text: "Rate DOWN if most evidence is from high RoB studies. Consider which domains matter most for this outcome (blinding crucial for subjective outcomes, less so for mortality)."
            },
            {
              heading: "Indirectness",
              text: "Rate DOWN if: population differs from your target, intervention differs (dose, duration, formulation), comparator isn't relevant, outcomes are surrogates. SPRINT's exclusions create indirectness for diabetics."
            },
            {
              heading: "Imprecision",
              text: "Rate DOWN if: 95% CI includes both appreciable benefit and harm, or includes no effect and appreciable benefit/harm. Consider clinical decision thresholds, not just statistical significance."
            },
            {
              heading: "Final Certainty Levels",
              text: "HIGH: very confident in estimate\nMODERATE: moderately confident, true effect likely close\nLOW: limited confidence, true effect may differ substantially\nVERY LOW: very little confidence, true effect likely substantially different"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'grade-builder',
          title: "GRADE Assessment Builder",
          description: "Build Summary of Findings tables with GRADE certainty ratings"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'grade_decision_tree',
          title: "The Diabetic Patient",
          scenario: "Your hospital adopts SPRINT-based intensive BP control (<120 systolic) for all patients. A colleague asks about her 68-year-old diabetic patient with CKD stage 3. SPRINT excluded diabetics and used automated BP measurement you don't have.",
          realCase: "SPRINT was a landmark trial. But ACCORD BP (which INCLUDED diabetics) found intensive BP control did NOT reduce CV events and INCREASED adverse events. Same intervention, different population, opposite conclusion.",
          nodes: {
            start: {
              id: 'start',
              situation: "The hospital quality officer says: 'SPRINT showed 25% reduction in CV events with intensive control. This diabetic patient should get the same benefit.' Your colleague is skeptical.",
              question: "How do you assess SPRINT's applicability?",
              branches: [
                { id: 'apply_sprint', text: "SPRINT is the best evidence ‚Äî apply it to all hypertensives", nextNode: 'application_problem' },
                { id: 'check_exclusions', text: "First check: was this patient type excluded from SPRINT?", nextNode: 'exclusion_discovery' },
                { id: 'find_direct_evidence', text: "Search for trials that INCLUDED diabetics", nextNode: 'accord_discovery' }
              ]
            },
            application_problem: {
              id: 'application_problem',
              situation: "You apply intensive control. Six months later: the patient has hypotensive episodes, falls, and develops acute kidney injury requiring hospitalization. You wonder: 'Did SPRINT predict this?'",
              question: "You review SPRINT's exclusion criteria. What do you find?",
              branches: [
                { id: 'discover_exclusions', text: "SPRINT excluded diabetics, prior stroke, eGFR <20", nextNode: 'late_realization' },
                { id: 'check_accord', text: "You find ACCORD BP studied diabetics specifically", nextNode: 'accord_contrast' }
              ]
            },
            late_realization: {
              id: 'late_realization',
              situation: "You realize: SPRINT excluded exactly the patients like yours. The exclusion criteria weren't arbitrary ‚Äî the investigators suspected these patients might respond differently. They were right.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE CONSEQUENCE: Exclusion criteria in trials are often signals. SPRINT excluded diabetics because ACCORD BP had already shown intensive BP control didn't help them. Applying SPRINT to excluded populations ignores crucial context."
            },
            accord_contrast: {
              id: 'accord_contrast',
              situation: "ACCORD BP (4,733 diabetics): intensive vs standard BP control. Primary composite: HR 0.88 (95% CI 0.73-1.06), NOT significant. Serious adverse events: significantly higher with intensive control. The opposite of SPRINT.",
              isEnding: true,
              outcome: 'bad',
              lesson: "THE HOOK: Same intervention (intensive BP control), different population (diabetics vs non-diabetics), opposite conclusion. This is why indirectness matters in GRADE. Diabetic patients needed diabetic-specific evidence."
            },
            exclusion_discovery: {
              id: 'exclusion_discovery',
              situation: "You check SPRINT's eligibility criteria. Major exclusions: (1) Diabetes, (2) Prior stroke, (3) Symptomatic heart failure, (4) eGFR <20. Your colleague's patient meets exclusion criterion #1.",
              question: "How does this affect your GRADE certainty rating?",
              branches: [
                { id: 'moderate_rating', text: "MODERATE ‚Äî one exclusion criterion, still reasonably applicable", nextNode: 'moderate_insufficient' },
                { id: 'low_rating', text: "LOW ‚Äî diabetics were specifically excluded, serious indirectness", nextNode: 'proper_grade' },
                { id: 'check_why', text: "Before rating, ask: WHY were diabetics excluded?", nextNode: 'exclusion_reason' }
              ]
            },
            moderate_insufficient: {
              id: 'moderate_insufficient',
              situation: "You rate MODERATE and recommend intensive control. A cardiologist colleague points out: 'ACCORD BP studied exactly this population and found no benefit. Your GRADE assessment should account for that DIRECT evidence, not just SPRINT's INDIRECT evidence.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: GRADE indirectness isn't just about distance from your question ‚Äî it's about whether BETTER evidence exists. For diabetics, ACCORD BP is direct evidence. SPRINT is indirect. Direct evidence trumps indirect."
            },
            proper_grade: {
              id: 'proper_grade',
              situation: "You rate LOW certainty for applying SPRINT to diabetics. Your GRADE rationale: 'Serious indirectness ‚Äî diabetics explicitly excluded. ACCORD BP (direct evidence for diabetics) found no benefit. Cannot extrapolate SPRINT to this population.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: GRADE indirectness forces you to ask: is this evidence actually about MY patient? When exclusion criteria match your patient, the answer is 'no.' Find direct evidence or downgrade substantially."
            },
            exclusion_reason: {
              id: 'exclusion_reason',
              situation: "You investigate: SPRINT excluded diabetics BECAUSE prior evidence (ACCORD BP) already showed intensive BP control didn't benefit them. The exclusion wasn't arbitrary ‚Äî it was evidence-based.",
              question: "What does this tell you about applying SPRINT to diabetics?",
              branches: [
                { id: 'cannot_extrapolate', text: "SPRINT can't be extrapolated ‚Äî there's direct contrary evidence", nextNode: 'correct_understanding' },
                { id: 'sprint_better', text: "Maybe SPRINT's approach was better than ACCORD's", nextNode: 'protocol_differences' }
              ]
            },
            correct_understanding: {
              id: 'correct_understanding',
              situation: "You explain to the quality officer: 'We can't apply SPRINT to diabetics. They were excluded because ACCORD showed no benefit in diabetics. Applying SPRINT protocols to excluded populations contradicts the trial's own design logic.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: Exclusion criteria often encode prior evidence. Understanding WHY a population was excluded reveals what we already know about them. SPRINT didn't study diabetics because we already knew the answer."
            },
            protocol_differences: {
              id: 'protocol_differences',
              situation: "You compare: SPRINT used automated BP measurement (typically 5-10 mmHg lower than clinic readings). ACCORD used standard clinic measurements. A '120' target in SPRINT is like '125-130' in real clinics. But even accounting for this, ACCORD showed no benefit.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE WARNING: Protocol differences matter. SPRINT's 120 isn't the same as your clinic's 120. But the bigger issue: ACCORD addressed diabetics directly. Methodological quibbles can't make SPRINT's excluded population suddenly included."
            },
            accord_discovery: {
              id: 'accord_discovery',
              situation: "You search for 'intensive blood pressure control diabetes RCT' and find ACCORD BP. 4,733 type 2 diabetics. Intensive (<120) vs standard (<140). Primary composite: HR 0.88 (0.73-1.06). Stroke: HR 0.59 (0.39-0.89). Adverse events: significantly higher.",
              question: "How do you interpret ACCORD BP?",
              branches: [
                { id: 'no_benefit', text: "Primary outcome negative ‚Äî intensive control doesn't help diabetics", nextNode: 'nuanced_interpretation' },
                { id: 'stroke_benefit', text: "Stroke was reduced ‚Äî some benefit exists", nextNode: 'outcome_tradeoff' },
                { id: 'both_results', text: "Report both ‚Äî primary negative, stroke positive, harms increased", nextNode: 'complete_picture' }
              ]
            },
            nuanced_interpretation: {
              id: 'nuanced_interpretation',
              situation: "You report: 'ACCORD BP, the direct evidence for diabetics, found intensive BP control did not reduce the primary CV composite. Apply SPRINT targets to diabetics is not supported by direct evidence.'",
              isEnding: true,
              outcome: 'good',
              lesson: "THE PROTECTION: The primary outcome is what the trial was designed and powered to detect. Secondary outcomes are hypothesis-generating. A negative primary outcome is the main message, even if secondaries show signals."
            },
            outcome_tradeoff: {
              id: 'outcome_tradeoff',
              situation: "You emphasize the stroke reduction (HR 0.59). But the quality officer notes: 'The primary outcome was negative. Serious adverse events were higher. You're cherry-picking a secondary outcome while ignoring the harms.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE QUESTION: When primary outcomes are negative but secondary outcomes positive, resist the temptation to focus on positive findings. GRADE requires assessing the entire evidence profile, including harms. Balance matters."
            },
            complete_picture: {
              id: 'complete_picture',
              situation: "Your assessment: 'For diabetics, intensive BP control: CV composite HR 0.88 (0.73-1.06, not significant), stroke HR 0.59 (0.39-0.89, significant), serious adverse events significantly higher. Balance uncertain. SPRINT does not apply ‚Äî ACCORD is the direct evidence.'",
              question: "Your colleague asks: 'So what do I do for my patient?'",
              branches: [
                { id: 'standard_target', text: "Standard target (<140) is supported ‚Äî less aggressive", nextNode: 'clinical_recommendation' },
                { id: 'shared_decision', text: "Discuss tradeoffs ‚Äî some patients might accept risks for stroke benefit", nextNode: 'individualized_care' }
              ]
            },
            clinical_recommendation: {
              id: 'clinical_recommendation',
              situation: "You recommend standard BP target (<140) based on ACCORD. The patient achieves 138/85 without adverse effects. Two years later: no CV events, no falls, stable kidney function. The evidence-appropriate target worked.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REVELATION: GRADE certainty isn't academic ‚Äî it guides real decisions. LOW certainty for SPRINT‚Üídiabetics meant: don't apply SPRINT protocols. Direct evidence from ACCORD supported a different approach. The patient benefited from correct evidence appraisal."
            },
            individualized_care: {
              id: 'individualized_care',
              situation: "You discuss with the patient: 'Aggressive BP control might reduce stroke risk but increases other risks. Given your priorities...' The patient, having had a family member with stroke, chooses moderately intensive control (125-130) with close monitoring.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE GRADUAL REVEAL: When evidence is uncertain (LOW certainty), patient preferences matter more. GRADE doesn't tell you what to do ‚Äî it tells you how confident to be. Uncertainty creates space for shared decision-making."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "You're rating GRADE certainty for a meta-analysis of 8 RCTs (n=12,000) showing Drug X reduces mortality (RR 0.85, 95% CI 0.78-0.93). I¬≤ = 0%, no publication bias detected, low risk of bias. What certainty?",
          options: [
            { id: 'a', text: "HIGH ‚Äî RCTs with no concerns across all domains", correct: true },
            { id: 'b', text: "MODERATE ‚Äî should rate down for imprecision given CI width", correct: false },
            { id: 'c', text: "MODERATE ‚Äî should rate down for potential residual confounding", correct: false },
            { id: 'd', text: "LOW ‚Äî mortality is too hard an endpoint to be certain about", correct: false }
          ],
          explanation: "This meets criteria for HIGH certainty: RCTs (start high), low RoB, no inconsistency (I¬≤=0%), no indirectness mentioned, precise estimate (CI excludes both 1.0 and large effects), no publication bias. Each domain is satisfactory, so no downgrading."
        }
      }
    ]
  },
  // Module 12: The Report
  {
    id: 12,
    title: "The Report",
    subtitle: "PRISMA 2020",
    principle: 6,
    story: "Reproducibility",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Certainty must be justified"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE CRISIS: GLASZIOU'S AUDIT ‚Äî SYSTEMATIC IN NAME ONLY",
          source: "BMC Medicine 2014; 12:37 | Glasziou et al | PubMed: 24571522",
          timeline: [
            { year: "2000s", text: "Systematic reviews become the 'gold standard' of evidence. Cochrane produces thousands. Guidelines mandate them. EBM rests on their foundation.", type: "normal" },
            { year: "2014", text: "Glasziou assembles a team to replicate 18 influential systematic reviews. They have the papers. They follow the methods sections. They try to reproduce the results.", type: "normal" },
            { year: "The Attempt", text: "Team members follow each review's stated methods exactly. They run the searches. They apply the criteria. They extract the data. They pool the estimates.", type: "normal" },
            { year: "The Failure", text: "Fully reproducible: 2 of 18 (11%). Partially reproducible: 5 of 18 (28%). NOT reproducible: 11 of 18 (61%). The foundation crumbles.", type: "crisis" },
            { year: "The Causes", text: "Search strategies incomplete or missing. Eligibility criteria ambiguous. Data extraction undefined. Statistical methods unclear. 'Systematic' was a label, not a practice.", type: "crisis" },
            { year: "The Consequence", text: "If we cannot reproduce a review, we cannot verify it. If we cannot verify it, we cannot trust it. 61% of 'gold standard' evidence was unverifiable.", type: "revelation" }
          ],
          realData: {
            endpoint: "Reproducibility of systematic reviews",
            drug: "18 influential reviews tested",
            placebo: "Attempted complete replication",
            rr: "Fully reproducible: 11% (2/18)",
            ci: "Partially: 28% | Failed: 61%",
            nnh: "Most 'systematic' reviews cannot be verified"
          },
          hook: "THE REPETITION: Every principle we've taught ‚Äî pre-specification, comprehensive search, transparent extraction, clear synthesis ‚Äî exists because without them, no one can check your work. And work that cannot be checked cannot be trusted. PRISMA 2020 is not bureaucracy. It is accountability."
        }
      },
      {
        type: 'content',
        content: {
          title: "THE HARM: When Irreproducible Reviews Killed",
          sections: [
            {
              heading: "The Cochrane Beta-Blocker Catastrophe (2014)",
              items: [
                "Cochrane review of perioperative beta-blockers: 'Reduces mortality' ‚Äî drove guidelines worldwide",
                "Based heavily on DECREASE trials by Poldermans (later proven fraudulent)",
                "When DECREASE was removed: benefit VANISHED, trend toward HARM remained",
                "Cochrane had to WITHDRAW the review. Guidelines had recommended harm for 12 years.",
                "How many surgical patients died from fraudulent data amplified by a 'systematic' review?"
              ]
            },
            {
              heading: "The Tamiflu Scandal (2009-2014)",
              items: [
                "Cochrane reviewed oseltamivir (Tamiflu) for influenza. Governments stockpiled $9 billion worth.",
                "Original review relied on manufacturer summaries ‚Äî not full trial reports",
                "When Cochrane demanded full Clinical Study Reports: Roche delayed for 4 YEARS",
                "Final verdict: Tamiflu reduced symptoms by 17 hours. Did NOT reduce hospitalizations.",
                "$9 billion spent on a drug whose benefits were exaggerated by incomplete reporting"
              ]
            },
            {
              heading: "THE PATTERN: Irreproducibility Enables Harm",
              items: [
                "If the beta-blocker review had required complete trial data, DECREASE fraud would have been caught",
                "If Tamiflu review had required Clinical Study Reports upfront, exaggeration would have been visible",
                "Irreproducible methods ‚Üí undetectable bias ‚Üí guidelines based on mirages ‚Üí patient harm",
                "PRISMA exists because vague methods let fraud and spin hide in plain sight"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "PRISMA 2020: 27-Item Framework (with a 15-item training subset)",
          sections: [
            {
              heading: "Title & Abstract (Items 1-2)",
              items: [
                "Identify as systematic review/meta-analysis in title",
                "Structured abstract with all key information"
              ]
            },
            {
              heading: "Methods (Items 3-15)",
              items: [
                "Protocol registration and access",
                "Eligibility criteria for studies",
                "Information sources and dates",
                "Complete search strategy (at least one database)",
                "Selection, extraction, and RoB processes",
                "Effect measures and synthesis methods"
              ]
            },
            {
              heading: "Results (Items 16-23)",
              items: [
                "Flow diagram of study selection",
                "Characteristics of included studies",
                "Risk of bias within and across studies",
                "Results of syntheses and investigations of heterogeneity"
              ]
            },
            {
              heading: "Discussion & Other (Items 24-27)",
              items: [
                "Interpretation in context of other evidence",
                "Limitations at study and review level",
                "Funding and conflicts of interest"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD: TRANSPARENT REPORTING",
          title: "Making Your Review Reproducible",
          sections: [
            {
              heading: "Search Strategy Reporting",
              text: "Provide complete search strings for ALL databases. Include date of search. Report any limits applied (language, date, publication type). Put full strategies in supplement if too long."
            },
            {
              heading: "Study Flow",
              text: "PRISMA flow diagram showing: records identified, duplicates removed, screened, assessed for eligibility, included. For exclusions at full-text stage, provide reasons for each."
            },
            {
              heading: "Data Transparency",
              text: "Include forest plots for all outcomes. Provide individual study data in tables or supplement. Share extraction forms, RoB judgments with justifications, and analysis code if possible."
            },
            {
              heading: "Living Reviews",
              text: "Consider whether your review should be updated periodically (living review) or is a one-time snapshot. State intended update frequency and triggers."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'prisma-checklist',
          title: "PRISMA Checklist Generator",
          description: "Generate a completed PRISMA 2020 checklist for your review"
        }
      },
      {
        type: 'scenario',
        content: {
          id: 'report_scenario',
          title: "The Word Limit",
          situation: "Your journal has a 3,500 word limit. Your complete search strategy is 800 words. Your detailed RoB judgments are 600 words. Full PRISMA compliance would exceed the limit by 40%. The editor says 'make cuts.'",
          question: "What do you cut?",
          choices: [
            {
              id: 'a',
              text: "Abbreviate search strategy ‚Äî readers don't actually replicate searches",
              consequence: 'bad',
              result: "The search IS the method. Without it, no one can verify you searched comprehensively. Put the full strategy in a supplement ‚Äî never omit it."
            },
            {
              id: 'b',
              text: "Move detailed methods to supplement, keep summary in main text",
              consequence: 'good',
              result: "Correct! PRISMA allows supplementary materials. Main text summarizes; supplement contains full search, RoB judgments, excluded studies list, sensitivity analyses. Everything remains available."
            },
            {
              id: 'c',
              text: "Cut the methods ‚Äî readers only care about results and conclusions",
              consequence: 'bad',
              result: "Without methods, results are uninterpretable. How would readers know if you missed studies, miscategorized bias, or p-hacked subgroups? Methods enable trust."
            }
          ],
          correct: 'b',
          principle: 6
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Which element is MOST essential for replicating a systematic review?",
          options: [
            { id: 'a', text: "The complete search strategy for at least one database", correct: true },
            { id: 'b', text: "The GRADE certainty ratings for each outcome", correct: false },
            { id: 'c', text: "The forest plots showing pooled estimates", correct: false },
            { id: 'd', text: "The discussion of limitations", correct: false }
          ],
          explanation: "The search strategy is the foundation of reproducibility. Without knowing exactly what you searched, how, and when, no one can verify your study identification. GRADE, forest plots, and discussion are important but depend on correct study identification first."
        }
      }
    ]
  },
  // Module 13: The Capstone
  {
    id: 13,
    title: "The Capstone",
    subtitle: "Full Walkthrough",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "The Capstone Project",
          subtitle: "Apply Everything You've Learned",
          text: "You will now conduct a mini meta-analysis from question to conclusion, using the tools from all previous modules."
        }
      },
      {
        type: 'content',
        content: {
          title: "Your Assignment",
          sections: [
            {
              heading: "The Question:",
              items: [
                "Does aspirin reduce cardiovascular events in primary prevention?"
              ]
            },
            {
              heading: "You Will:",
              items: [
                "1. Formulate PICO using the PICO Builder",
                "2. Develop a search strategy using the Search Builder",
                "3. Screen provided records using the PRISMA Flow tool",
                "4. Extract data from 5 provided trial summaries",
                "5. Assess risk of bias using RoB 2",
                "6. Calculate effect sizes",
                "7. Build a forest plot (fixed and random effects)",
                "8. Assess heterogeneity and prediction intervals",
                "9. Create a funnel plot and assess publication bias",
                "10. Rate certainty using GRADE",
                "11. Report findings using PRISMA checklist"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Dataset: Aspirin Primary Prevention Trials",
          sections: [
            {
              heading: "Study 1: Physicians' Health Study (1989)",
              items: [
                "N=22,071 male physicians",
                "Aspirin 325mg every other day vs placebo",
                "MI events: 139/11,037 (1.26%) vs 239/11,034 (2.17%)",
                "RR = 0.58 (0.47-0.72)"
              ]
            },
            {
              heading: "Study 2: Women's Health Study (2005)",
              items: [
                "N=39,876 female health professionals",
                "Aspirin 100mg every other day vs placebo",
                "MI events: 198/19,934 (0.99%) vs 193/19,942 (0.97%)",
                "RR = 1.02 (0.84-1.25)"
              ]
            },
            {
              heading: "Study 3: ASPREE (2018)",
              items: [
                "N=19,114 elderly (>70)",
                "Aspirin 100mg daily vs placebo",
                "CV events: 448/9,525 (4.7%) vs 474/9,589 (4.9%)",
                "RR = 0.95 (0.83-1.08)"
              ]
            },
            {
              heading: "Study 4: ARRIVE (2018)",
              items: [
                "N=12,546 moderate CV risk",
                "Aspirin 100mg daily vs placebo",
                "MI events: 98/6,270 (1.56%) vs 108/6,276 (1.72%)",
                "RR = 0.91 (0.69-1.19)"
              ]
            },
            {
              heading: "Study 5: ASCEND (2018)",
              items: [
                "N=15,480 diabetics",
                "Aspirin 100mg daily vs placebo",
                "Serious vascular events: 658/7,740 (8.5%) vs 743/7,740 (9.6%)",
                "RR = 0.88 (0.79-0.97)"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Capstone Verification Checkpoints",
          sections: [
            {
              heading: "‚úì CHECKPOINT 1: PICO Formulation",
              items: [
                "Use the PICO Builder tool",
                "VERIFY: Your outcome is PATIENT-IMPORTANT (not a surrogate)",
                "SELF-CHECK: Would CAST victims approve of your outcome choice?"
              ]
            },
            {
              heading: "‚úì CHECKPOINT 2: Risk of Bias Assessment",
              items: [
                "Use the RoB 2 tool for ALL 5 studies",
                "VERIFY: You rated each OUTCOME separately (remember ORBITA)",
                "SELF-CHECK: Could unblinding affect your outcome measurement?"
              ]
            },
            {
              heading: "‚úì CHECKPOINT 3: Forest Plot & Heterogeneity",
              items: [
                "Use the Forest Plot Builder ‚Äî try BOTH fixed and random effects",
                "Use the Heterogeneity Explorer",
                "VERIFY: You calculated the PREDICTION INTERVAL (not just CI)",
                "SELF-CHECK: Does your PI cross 1.0? What does that mean for clinical practice?"
              ]
            },
            {
              heading: "‚úì CHECKPOINT 4: Publication Bias Assessment",
              items: [
                "Use the Funnel Plot Builder",
                "VERIFY: You ran Egger's test and interpreted it correctly",
                "SELF-CHECK: Are there registered trials that aren't published? (Remember Turner's 94% vs 51%)"
              ]
            },
            {
              heading: "‚úì CHECKPOINT 5: GRADE Certainty Rating",
              items: [
                "Use the GRADE Builder",
                "VERIFY: You considered INDIRECTNESS (Remember SPRINT vs ACCORD-BP)",
                "VERIFY: You downgraded appropriately for heterogeneity if I¬≤>50%",
                "SELF-CHECK: Would you bet your career on this certainty rating?"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Capstone Deliverables",
          sections: [
            {
              heading: "Required Outputs (submit all 5):",
              items: [
                "1. PICO table with outcome hierarchy justification",
                "2. RoB 2 traffic light table for all 5 studies",
                "3. Forest plot with BOTH CI and prediction interval labeled",
                "4. Funnel plot with Egger's test result annotated",
                "5. GRADE Summary of Findings table"
              ]
            },
            {
              heading: "Key Questions to Answer:",
              items: [
                "What is the pooled RR? (report with 95% CI AND prediction interval)",
                "What is I¬≤? What does it mean for clinical application?",
                "Is there evidence of publication bias? How did you assess this?",
                "What is your GRADE certainty? Justify each domain rating.",
                "What do you recommend for clinical practice? For WHOM?"
              ]
            },
            {
              heading: "250-Word Abstract",
              items: [
                "Background: Why does this question matter?",
                "Methods: How did you search, select, assess bias, synthesize?",
                "Results: Pooled RR, CI, PI, I¬≤, GRADE certainty",
                "Conclusion: What should clinicians DO with this evidence?"
              ]
            }
          ]
        }
      },
      {
        type: 'principle',
        content: {
          text: "The seven principles guide you. The question shapes the answer. Pre-specification protects. Comprehensive searching finds truth. Every number needs verification. Bias hides in plain sight. The average can lie. Certainty must be justified."
        }
      }
    ]
  },
  // Module 14: Final Assessment
  {
    id: 14,
    title: "Final Assessment",
    subtitle: "Test Your Knowledge",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "Final Assessment",
          subtitle: "Comprehensive Examination",
          text: "This assessment covers all modules. You need 70% to pass. Take your time ‚Äî there's no time limit."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL Q1: The CAST trial found that antiarrhythmic drugs that successfully suppressed PVCs actually increased mortality. This reversal happened because the original studies used which problematic outcome?",
          options: [
            { id: 'a', text: "Composite endpoint", correct: false },
            { id: 'b', text: "Surrogate endpoint (PVC suppression instead of mortality)", correct: true },
            { id: 'c', text: "Self-reported endpoint", correct: false },
            { id: 'd', text: "Time-to-event endpoint", correct: false }
          ],
          explanation: "CAST exemplifies the surrogate trap: PVC suppression (biomarker) seemed like a reasonable proxy for mortality, but the drugs that best suppressed PVCs actually increased death. Principle 1: 'The question shapes the answer.'"
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL Q2: You're halfway through a meta-analysis when you notice an interesting subgroup difference not in your protocol. What is the most appropriate action?",
          options: [
            { id: 'a', text: "Add it as a primary analysis", correct: false },
            { id: 'b', text: "Report it as exploratory, hypothesis-generating, with appropriate caveats", correct: true },
            { id: 'c', text: "Ignore it completely", correct: false },
            { id: 'd', text: "Amend your PROSPERO registration to include it as pre-specified", correct: false }
          ],
          explanation: "Post-hoc findings can be reported but must be labeled clearly as exploratory. Adding to primary analysis is HARKing. Ignoring wastes information. Amending PROSPERO after analysis is deceptive."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL Q3: Your funnel plot shows asymmetry with small positive studies missing. Egger's test p=0.04. Which statement is most accurate?",
          options: [
            { id: 'a', text: "Publication bias is confirmed ‚Äî use trim-and-fill adjusted estimate", correct: false },
            { id: 'b', text: "Asymmetry detected ‚Äî could be publication bias, small-study effects, or heterogeneity. Compare registered vs published trials for stronger evidence", correct: true },
            { id: 'c', text: "No publication bias since funnel asymmetry has many causes", correct: false },
            { id: 'd', text: "Need more studies to draw any conclusion", correct: false }
          ],
          explanation: "Funnel asymmetry is suggestive but not confirmatory. The gold standard is comparing trial registrations to publications. Egger's test detects asymmetry, not its cause."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL Q4: A meta-analysis shows RR 0.75 (95% CI 0.65-0.87) with prediction interval 0.52-1.08. What does this tell a clinician about applying this treatment?",
          options: [
            { id: 'a', text: "Treatment is effective ‚Äî CI excludes 1.0", correct: false },
            { id: 'b', text: "Treatment is not effective ‚Äî prediction interval crosses 1.0", correct: false },
            { id: 'c', text: "On average treatment helps, but in some future settings may not work", correct: true },
            { id: 'd', text: "Results are too heterogeneous to interpret", correct: false }
          ],
          explanation: "The CI tells us the average effect is likely beneficial. The prediction interval tells us a new study (new setting) could show effects from 0.52 (large benefit) to 1.08 (slight harm). Both pieces matter."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL Q5: You're grading certainty for SPRINT's applicability to a diabetic patient with CKD. SPRINT excluded both diabetics and advanced CKD. What GRADE domain applies?",
          options: [
            { id: 'a', text: "Risk of bias", correct: false },
            { id: 'b', text: "Inconsistency", correct: false },
            { id: 'c', text: "Indirectness", correct: true },
            { id: 'd', text: "Imprecision", correct: false }
          ],
          explanation: "Indirectness addresses the question: 'Does this evidence apply to MY population/intervention/comparison/outcome?' When your patient was excluded from the trial, the evidence is indirect for them."
        }
      },
      {
        type: 'content',
        content: {
          title: "Congratulations!",
          sections: [
            {
              heading: "You've Completed the Meta-Analysis Methods Course",
              items: [
                "‚úì Learned to formulate PICO questions that matter",
                "‚úì Understood the importance of pre-registration",
                "‚úì Mastered comprehensive searching",
                "‚úì Practiced systematic screening and extraction",
                "‚úì Applied risk of bias assessment",
                "‚úì Calculated and interpreted effect sizes",
                "‚úì Built and interpreted forest plots",
                "‚úì Explored heterogeneity beyond I¬≤",
                "‚úì Detected and assessed publication bias",
                "‚úì Applied GRADE certainty framework",
                "‚úì Understood PRISMA reporting standards"
              ]
            },
            {
              heading: "The Seven Principles",
              text: "Remember: The question shapes the answer. Pre-specification is protection. What you don't search for, you won't find. Every number needs a source. Bias hides in plain sight. The average can lie. Certainty must be justified."
            }
          ]
        }
      }
    ]
  }
];

// ============================================================
// STATE MANAGEMENT
// ============================================================

let currentModule = 0;
let currentSlide = 0;
let gameState = {
  points: 0,
  earnedBadges: [],
  toolsUsed: [],
  modulesCompleted: [],
  scenariosCompleted: {},
  decisionTrees: {},
  quizAnswers: {}
};

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', () => {
  loadProgress();
  renderModuleList();
  renderSlides();
  goToModule(0);
  updateLevelBadge();
  checkBadges();
});

function renderModuleList() {
  const list = document.getElementById('moduleList');
  list.innerHTML = modules.map(m => `
    <div class="module-item ${m.id === currentModule ? 'active' : ''} ${gameState.modulesCompleted.includes(m.id) ? 'completed' : ''}"
         data-module="${m.id}" onclick="goToModule(${m.id})"
         role="button" tabindex="0" ${m.id === currentModule ? 'aria-current="true"' : ''}
         aria-label="Module ${m.id}: ${m.title}${gameState.modulesCompleted.includes(m.id) ? ' (completed)' : ''}">
      <div class="module-number" aria-hidden="true">${m.id}</div>
      <div class="module-info">
        <div class="module-title">${m.title}</div>
        <div class="module-subtitle">${m.subtitle}</div>
      </div>
    </div>
  `).join('');
}

function renderSlides() {
  const container = document.getElementById('slideContainer');
  const module = modules[currentModule];

  container.innerHTML = module.slides.map((slide, idx) => {
    let content = '';

    switch(slide.type) {
      case 'title':
        content = `
          <h1 class="slide-title">${slide.content.title}</h1>
          <p style="text-align: center; font-size: 1.2rem; color: var(--gold); margin-bottom: 2rem;">${slide.content.subtitle}</p>
          <div class="slide-content">
            <p style="font-size: 1.1rem; line-height: 1.8; text-align: center;">${slide.content.text}</p>
          </div>
        `;
        break;

      case 'principle-display':
        content = `
          <div class="principle-display">
            <div class="principle-text">"${slide.content.principle}"</div>
          </div>
        `;
        break;

      case 'story':
        content = `
          <div class="story-box">
            <div class="story-label">${slide.content.label}</div>
            <div class="story-text">${slide.content.text}</div>
            <div class="story-hook">"${slide.content.hook}"</div>
          </div>
        `;
        break;

      case 'story-deep':
        content = `
          <div class="story-deep">
            <div class="story-label">${slide.content.label}</div>
            ${slide.content.source ? `<div class="real-data-source">üìö Source: ${slide.content.source}</div>` : ''}

            <div class="story-timeline">
              ${slide.content.timeline.map(event => `
                <div class="timeline-event ${event.type || ''}">
                  <div class="timeline-year">${event.year}</div>
                  <div class="timeline-text">${event.text}</div>
                </div>
              `).join('')}
            </div>

            ${slide.content.realData ? `
              <div class="real-data-card">
                <div class="real-data-header">
                  <strong>üìä The Data That Changed Everything</strong>
                </div>
                <div class="real-data-stat">
                  <span class="label">Endpoint:</span>
                  <span style="color: var(--gold);">${slide.content.realData.endpoint}</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                  <div class="real-data-stat">
                    <span class="value" style="color: var(--red);">${slide.content.realData.drug}</span>
                    <span class="label">Drug</span>
                  </div>
                  <div class="real-data-stat">
                    <span class="value">${slide.content.realData.placebo}</span>
                    <span class="label">Placebo</span>
                  </div>
                </div>
                <div class="real-data-stat">
                  <span class="value" style="color: var(--red);">RR ${slide.content.realData.rr}</span>
                  <span class="label">(95% CI: ${slide.content.realData.ci})</span>
                </div>
                ${slide.content.realData.nnh ? `
                  <div class="real-data-stat" style="margin-top: 0.5rem;">
                    <span class="value">${slide.content.realData.nnh}</span>
                    <span class="label">NNH (number needed to harm)</span>
                  </div>
                ` : ''}
              </div>
            ` : ''}

            <div class="story-hook" style="margin-top: 1.5rem; font-size: 1.15rem;">
              "${slide.content.hook}"
            </div>
          </div>
        `;
        break;

      case 'decision-tree':
        content = renderDecisionTree(slide.content);
        break;

      case 'real-world-story':
        content = `
          <div class="real-world-story">
            <div class="story-rhetorical-question">${slide.content.rhetoricalQuestion}</div>

            ${slide.content.context ? `<p style="color: rgba(255,255,255,0.85); line-height: 1.7; margin-bottom: 1.5rem;">${slide.content.context}</p>` : ''}

            <div class="story-stats-box">
              <div class="story-stats-header">
                <span>THE REAL DATA</span>
              </div>
              <div class="story-stats-grid">
                ${slide.content.stats.map(stat => `
                  <div class="story-stat-item">
                    <span class="story-stat-value ${stat.type || ''}">${stat.value}</span>
                    <span class="story-stat-label">${stat.label}</span>
                  </div>
                `).join('')}
              </div>
              ${slide.content.source ? `<div class="story-source">Source: ${slide.content.source}</div>` : ''}
            </div>

            <div class="story-decision-tree">
              <div class="story-decision-header">
                <span>THE DECISION</span>
              </div>
              <div class="story-decision-scenario">${slide.content.decisionScenario}</div>

              <div class="story-path path-wrong">
                <div class="story-path-label">PATH A: ${slide.content.pathA.title}</div>
                <div class="story-path-content">
                  ${slide.content.pathA.steps.map(step => `
                    <div class="story-path-arrow">&#8594; ${step}</div>
                  `).join('')}
                </div>
              </div>

              <div class="story-path path-right">
                <div class="story-path-label">PATH B: ${slide.content.pathB.title}</div>
                <div class="story-path-content">
                  ${slide.content.pathB.steps.map(step => `
                    <div class="story-path-arrow">&#8594; ${step}</div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="story-revelation">
              <div class="story-revelation-header">
                <span>THE REVELATION</span>
              </div>
              <div class="story-revelation-text">${slide.content.revelation}</div>
            </div>

            ${slide.content.moduleConnection ? `
              <div class="story-connection">
                <strong>Connection to this module:</strong> ${slide.content.moduleConnection}
              </div>
            ` : ''}
          </div>
        `;
        break;

      case 'content':
        content = `
          <h2 class="slide-title">${slide.content.title}</h2>
          <div class="slide-content">
            ${slide.content.sections.map(s => `
              <div class="method-box">
                <h3>${s.heading}</h3>
                ${s.items ? `<ul>${s.items.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
                ${s.text ? `<p style="line-height: 1.7; color: rgba(255,255,255,0.85);">${s.text}</p>` : ''}
              </div>
            `).join('')}
          </div>
        `;
        break;

      case 'method':
        content = `
          <div class="method-box">
            <div class="method-label">${slide.content.label}</div>
            <h2 style="color: var(--cream); margin-bottom: 1rem;">${slide.content.title}</h2>
            ${slide.content.sections.map(s => `
              <div style="margin-bottom: 1rem;">
                <h4 style="color: var(--gold); margin-bottom: 0.5rem;">${s.heading}</h4>
                <p style="color: rgba(255,255,255,0.85); line-height: 1.6; white-space: pre-line;">${s.text}</p>
              </div>
            `).join('')}
          </div>
        `;
        break;

      case 'tool':
        content = renderTool(slide.content);
        break;

      case 'scenario':
        content = renderScenario(slide.content);
        break;

      case 'quiz':
        content = renderQuiz(slide.content, idx);
        break;

      case 'principle':
        content = `
          <div class="slide-content" style="text-align: center; padding: 3rem;">
            <p style="font-size: 1.3rem; line-height: 1.8; color: var(--cream);">${slide.content.text}</p>
          </div>
        `;
        break;
    }

    return `<div class="slide ${idx === currentSlide ? 'active' : ''}" data-slide="${idx}">${content}</div>`;
  }).join('');

  updateSlideNav();
}

// ============================================================
// TOOLS
// ============================================================

function renderTool(tool) {
  if (tool.id === 'pico-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîß</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Population (Who?)</label>
          <input type="text" id="pico-p" placeholder="e.g., Adults with type 2 diabetes">
        </div>
        <div class="tool-input-group">
          <label>Intervention (What treatment?)</label>
          <input type="text" id="pico-i" placeholder="e.g., SGLT2 inhibitors">
        </div>
        <div class="tool-input-group">
          <label>Comparator (Compared to?)</label>
          <input type="text" id="pico-c" placeholder="e.g., Placebo or standard care">
        </div>
        <div class="tool-input-group">
          <label>Outcome (What matters to patients?)</label>
          <input type="text" id="pico-o" placeholder="e.g., Cardiovascular death, hospitalization for heart failure">
        </div>

        <button class="tool-btn" onclick="generatePICO()">Generate Research Question</button>

        <div class="tool-output" id="pico-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'search-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîç</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Population Terms</label>
          <input type="text" id="search-pop" placeholder="e.g., diabetes, diabetic, T2DM">
        </div>
        <div class="tool-input-group">
          <label>Intervention Terms</label>
          <input type="text" id="search-int" placeholder="e.g., rosiglitazone, Avandia, thiazolidinedione">
        </div>
        <div class="tool-input-group">
          <label>Outcome Terms</label>
          <input type="text" id="search-out" placeholder="e.g., myocardial infarction, heart attack, cardiovascular">
        </div>

        <button class="tool-btn" onclick="generateSearch()">Generate Search Strategy</button>

        <div class="tool-output" id="search-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'prisma-flow') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìä</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>Records from databases</label>
            <input type="number" id="prisma-db" value="2847">
          </div>
          <div class="tool-input-group">
            <label>Records from other sources</label>
            <input type="number" id="prisma-other" value="156">
          </div>
          <div class="tool-input-group">
            <label>Duplicates removed</label>
            <input type="number" id="prisma-dup" value="423">
          </div>
          <div class="tool-input-group">
            <label>Records screened</label>
            <input type="number" id="prisma-screen" value="2580">
          </div>
          <div class="tool-input-group">
            <label>Records excluded (title/abstract)</label>
            <input type="number" id="prisma-excl1" value="2489">
          </div>
          <div class="tool-input-group">
            <label>Full-text assessed</label>
            <input type="number" id="prisma-ft" value="91">
          </div>
          <div class="tool-input-group">
            <label>Full-text excluded</label>
            <input type="number" id="prisma-excl2" value="68">
          </div>
          <div class="tool-input-group">
            <label>Studies included</label>
            <input type="number" id="prisma-incl" value="23">
          </div>
        </div>

        <button class="tool-btn" onclick="generatePRISMA()">Generate Flow Diagram</button>

        <div class="tool-output" id="prisma-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'extraction-form') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìã</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Study ID / First Author (Year)</label>
          <input type="text" id="extract-id" placeholder="e.g., Smith 2021">
        </div>
        <div class="tool-input-group">
          <label>Population (N, characteristics)</label>
          <input type="text" id="extract-pop" placeholder="e.g., N=500 adults with T2DM, mean age 62">
        </div>
        <div class="tool-input-group">
          <label>Intervention details</label>
          <input type="text" id="extract-int" placeholder="e.g., Drug X 100mg daily for 12 weeks">
        </div>
        <div class="tool-input-group">
          <label>Comparator details</label>
          <input type="text" id="extract-comp" placeholder="e.g., Placebo, identical appearance">
        </div>
        <div class="tool-input-group">
          <label>Outcome (events/total or mean ¬± SD)</label>
          <input type="text" id="extract-out" placeholder="e.g., MI: 23/250 vs 45/250">
        </div>
        <div class="tool-input-group">
          <label>Follow-up duration</label>
          <input type="text" id="extract-followup" placeholder="e.g., 24 months">
        </div>

        <button class="tool-btn" onclick="generateExtraction()">Add to Extraction Table</button>

        <div class="tool-output" id="extraction-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'rob2-tool') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚öñÔ∏è</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Study ID</label>
          <input type="text" id="rob-id" placeholder="e.g., Smith 2021">
        </div>

        <div style="margin: 1rem 0;">
          <strong>Domain 1: Randomization</strong>
          <select id="rob-d1" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Low risk</option>
            <option value="some">Some concerns</option>
            <option value="high">High risk</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Domain 2: Deviations from interventions</strong>
          <select id="rob-d2" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Low risk</option>
            <option value="some">Some concerns</option>
            <option value="high">High risk</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Domain 3: Missing outcome data</strong>
          <select id="rob-d3" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Low risk</option>
            <option value="some">Some concerns</option>
            <option value="high">High risk</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Domain 4: Measurement of outcome</strong>
          <select id="rob-d4" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Low risk</option>
            <option value="some">Some concerns</option>
            <option value="high">High risk</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Domain 5: Selection of reported result</strong>
          <select id="rob-d5" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Low risk</option>
            <option value="some">Some concerns</option>
            <option value="high">High risk</option>
          </select>
        </div>

        <button class="tool-btn" onclick="generateRoB()">Calculate Overall Risk of Bias</button>

        <div class="tool-output" id="rob-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'effect-calculator') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üî¢</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Effect type</label>
          <select id="effect-type" onchange="updateEffectInputs()" style="width: 100%; padding: 0.5rem;">
            <option value="binary">Binary (events/N for each group)</option>
            <option value="continuous">Continuous (mean, SD, N)</option>
          </select>
        </div>

        <div id="binary-inputs">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="tool-input-group">
              <label>Treatment events</label>
              <input type="number" id="eff-e1" value="23">
            </div>
            <div class="tool-input-group">
              <label>Treatment N</label>
              <input type="number" id="eff-n1" value="250">
            </div>
            <div class="tool-input-group">
              <label>Control events</label>
              <input type="number" id="eff-e2" value="45">
            </div>
            <div class="tool-input-group">
              <label>Control N</label>
              <input type="number" id="eff-n2" value="250">
            </div>
          </div>
        </div>

        <div id="continuous-inputs" style="display: none;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="tool-input-group">
              <label>Treatment mean</label>
              <input type="number" step="0.01" id="eff-m1" value="4.2">
            </div>
            <div class="tool-input-group">
              <label>Treatment SD</label>
              <input type="number" step="0.01" id="eff-sd1" value="2.0">
            </div>
            <div class="tool-input-group">
              <label>Treatment N</label>
              <input type="number" id="eff-cn1" value="50">
            </div>
            <div class="tool-input-group">
              <label>Control mean</label>
              <input type="number" step="0.01" id="eff-m2" value="5.8">
            </div>
            <div class="tool-input-group">
              <label>Control SD</label>
              <input type="number" step="0.01" id="eff-sd2" value="2.4">
            </div>
            <div class="tool-input-group">
              <label>Control N</label>
              <input type="number" id="eff-cn2" value="50">
            </div>
          </div>
        </div>

        <button class="tool-btn" onclick="calculateEffect()">Calculate Effect Size</button>

        <div class="tool-output" id="effect-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'forest-plot') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üå≤</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Load Example Dataset</label>
          <select id="forest-preset" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;" onchange="loadForestPreset()">
            <option value="">‚Äî Select a real-world dataset ‚Äî</option>
            <option value="aspirin">Aspirin for Primary Prevention (ASCEND, ASPREE, ARRIVE)</option>
            <option value="cast">CAST: Antiarrhythmics (the story that started it all)</option>
            <option value="magnesium">Magnesium in MI (ISIS-4 vs small trials)</option>
            <option value="ssri">SSRIs vs Placebo (publication bias example)</option>
            <option value="hrt">HRT & CHD (observational vs RCT)</option>
          </select>
        </div>

        <div class="tool-input-group">
          <label>Studies (one per line: Name, RR, LowerCI, UpperCI)</label>
          <textarea id="forest-data" rows="8" placeholder="Study1, 0.75, 0.58, 0.97
Study2, 0.82, 0.65, 1.03
Study3, 0.90, 0.78, 1.04">PHS 1989, 0.58, 0.47, 0.72
WHS 2005, 1.02, 0.84, 1.25
ASPREE 2018, 0.95, 0.83, 1.08
ARRIVE 2018, 0.91, 0.69, 1.19
ASCEND 2018, 0.88, 0.79, 0.97</textarea>
        </div>

        <div class="tool-input-group">
          <label>Model</label>
          <select id="forest-model" style="width: 100%; padding: 0.5rem;">
            <option value="random">Random effects (DerSimonian-Laird)</option>
            <option value="fixed">Fixed effect (Inverse Variance)</option>
          </select>
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button class="tool-btn" onclick="generateForest()">üå≤ Forest Plot</button>
          <button class="tool-btn" onclick="generateFunnelFromForest()" style="background: var(--navy);">üìä Funnel Plot</button>
        </div>

        <div id="forest-output" style="display: none; margin-top: 1rem;"></div>
      </div>
    `;
  }

  if (tool.id === 'heterogeneity-explorer') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìà</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Pooled RR (or enter from forest plot)</label>
          <input type="number" step="0.01" id="het-rr" value="0.85">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>95% CI Lower</label>
            <input type="number" step="0.01" id="het-lower" value="0.72">
          </div>
          <div class="tool-input-group">
            <label>95% CI Upper</label>
            <input type="number" step="0.01" id="het-upper" value="1.00">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>I¬≤ (%)</label>
            <input type="number" id="het-i2" value="68">
          </div>
          <div class="tool-input-group">
            <label>œÑ¬≤ (tau-squared)</label>
            <input type="number" step="0.001" id="het-tau2" value="0.045">
          </div>
        </div>
        <div class="tool-input-group">
          <label>Number of studies</label>
          <input type="number" id="het-k" value="5">
        </div>

        <button class="tool-btn" onclick="calculateHeterogeneity()">Calculate Prediction Interval</button>

        <div class="tool-output" id="het-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'funnel-plot') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîª</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Studies (one per line: Name, logRR, SE)</label>
          <textarea id="funnel-data" rows="6" placeholder="Study1, -0.29, 0.12
Study2, 0.02, 0.10">PHS 1989, -0.54, 0.11
WHS 2005, 0.02, 0.10
ASPREE 2018, -0.05, 0.07
ARRIVE 2018, -0.09, 0.14
ASCEND 2018, -0.13, 0.05</textarea>
        </div>

        <button class="tool-btn" onclick="generateFunnel()">Generate Funnel Plot & Run Egger's Test</button>

        <div id="funnel-output" style="display: none; margin-top: 1rem;"></div>
      </div>
    `;
  }

  if (tool.id === 'grade-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚≠ê</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Outcome</label>
          <input type="text" id="grade-outcome" value="Cardiovascular events">
        </div>

        <div class="tool-input-group">
          <label>Study design</label>
          <select id="grade-design" style="width: 100%; padding: 0.5rem;">
            <option value="rct">RCTs (start HIGH)</option>
            <option value="obs">Observational (start LOW)</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Rate down domains:</strong>
          <div style="margin-top: 0.5rem; display: grid; gap: 0.5rem;">
            <label>Risk of bias
              <select id="grade-rob" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">Not serious (0)</option>
                <option value="-1">Serious (-1)</option>
                <option value="-2">Very serious (-2)</option>
              </select>
            </label>
            <label>Inconsistency
              <select id="grade-incon" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">Not serious (0)</option>
                <option value="-1">Serious (-1)</option>
                <option value="-2">Very serious (-2)</option>
              </select>
            </label>
            <label>Indirectness
              <select id="grade-indir" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">Not serious (0)</option>
                <option value="-1">Serious (-1)</option>
                <option value="-2">Very serious (-2)</option>
              </select>
            </label>
            <label>Imprecision
              <select id="grade-imprec" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">Not serious (0)</option>
                <option value="-1">Serious (-1)</option>
                <option value="-2">Very serious (-2)</option>
              </select>
            </label>
            <label>Publication bias
              <select id="grade-pub" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">Undetected / none (0)</option>
                <option value="-1">Suspected (-1)</option>
                <option value="-2">Strongly suspected (-2)</option>
              </select>
            </label>
          </div>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Rate up domains (observational only):</strong>
          <div style="margin-top: 0.5rem;">
            <label>Large effect
              <select id="grade-up-large" style="width: 100%; padding: 0.35rem; margin-top: 0.25rem;">
                <option value="0">None (0)</option>
                <option value="1">Large effect (+1)</option>
                <option value="2">Very large effect (+2)</option>
              </select>
            </label>
            <label style="display: block; margin-top: 0.5rem;"><input type="checkbox" id="grade-up-dose"> Dose-response gradient (+1)</label>
            <label style="display: block; margin-top: 0.25rem;"><input type="checkbox" id="grade-up-confound"> All plausible confounders would reduce observed effect (+1)</label>
          </div>
        </div>

        <button class="tool-btn" onclick="calculateGRADE()">Calculate Certainty</button>

        <div class="tool-output" id="grade-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'prisma-checklist') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚úì</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 0.5rem; color: var(--light-text);">${tool.description}</p>
        <p style="margin-bottom: 1rem; color: var(--light-text);"><strong>Training subset:</strong> this calculator scores 15 core PRISMA items, not the full 27-item checklist.</p>

        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="1"> 1. Title identifies as systematic review</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="2"> 2. Structured abstract</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="3"> 3. Rationale stated</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="4"> 4. Objectives stated (PICO)</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="5"> 5. Protocol registered</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="6"> 6. Eligibility criteria</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="7"> 7. Information sources</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="8"> 8. Search strategy (full for ‚â•1 database)</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="9"> 9. Selection process</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="10"> 10. Data extraction process</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="11"> 11. Effect measures</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="12"> 12. Synthesis methods</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="13"> 13. RoB assessment method</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="14"> 14. Certainty assessment method</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="15"> 15. Flow diagram</label>
          </div>
        </div>

        <button class="tool-btn" onclick="calculatePRISMA()">Calculate Completeness</button>

        <div class="tool-output" id="prisma-checklist-output" style="display: none;"></div>
      </div>
    `;
  }

  return `<div class="tool-panel"><p>Tool: ${tool.id}</p></div>`;
}

function generatePICO() {
  const p = document.getElementById('pico-p').value || '[Population]';
  const i = document.getElementById('pico-i').value || '[Intervention]';
  const c = document.getElementById('pico-c').value || '[Comparator]';
  const o = document.getElementById('pico-o').value || '[Outcome]';

  const output = document.getElementById('pico-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Your Research Question:</strong>

In ${p}, does ${i} compared to ${c} improve ${o}?

<strong>PICO Table:</strong>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ P (Population)  ‚îÇ ${p.substring(0,30)}${p.length > 30 ? '...' : ''}
‚îÇ I (Intervention)‚îÇ ${i.substring(0,30)}${i.length > 30 ? '...' : ''}
‚îÇ C (Comparator)  ‚îÇ ${c.substring(0,30)}${c.length > 30 ? '...' : ''}
‚îÇ O (Outcome)     ‚îÇ ${o.substring(0,30)}${o.length > 30 ? '...' : ''}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

<strong>Outcome Hierarchy Check:</strong>
${o.toLowerCase().includes('death') || o.toLowerCase().includes('mortality') ? '‚úì Mortality endpoint ‚Äî excellent!' :
  o.toLowerCase().includes('event') || o.toLowerCase().includes('hospitalization') ? '‚úì Clinical event ‚Äî good patient-important outcome' :
  '‚ö†Ô∏è Consider whether this is a surrogate or patient-important outcome'}
  `;

  awardPoints(25, 'PICO tool used');
  trackToolUse('pico-builder');
}

function generateSearch() {
  const pop = document.getElementById('search-pop').value || 'diabetes';
  const int = document.getElementById('search-int').value || 'drug';
  const out = document.getElementById('search-out').value || 'outcome';

  const popTerms = pop.split(',').map(t => t.trim()).filter(t => t);
  const intTerms = int.split(',').map(t => t.trim()).filter(t => t);
  const outTerms = out.split(',').map(t => t.trim()).filter(t => t);

  const output = document.getElementById('search-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>MEDLINE Search Strategy:</strong>

1. Population:
   (${popTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

2. Intervention:
   (${intTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

3. Outcome:
   (${outTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

4. Combined:
   #1 AND #2 AND #3

<strong>Also Search:</strong>
‚ñ° EMBASE (different syntax)
‚ñ° CENTRAL (Cochrane trials)
‚ñ° ClinicalTrials.gov
‚ñ° WHO ICTRP
‚ñ° Reference lists of included studies
  `;

  awardPoints(25, 'Search builder used');
  trackToolUse('search-builder');
}

function generatePRISMA() {
  const db = parseInt(document.getElementById('prisma-db').value) || 0;
  const other = parseInt(document.getElementById('prisma-other').value) || 0;
  const dup = parseInt(document.getElementById('prisma-dup').value) || 0;
  const screen = parseInt(document.getElementById('prisma-screen').value) || 0;
  const excl1 = parseInt(document.getElementById('prisma-excl1').value) || 0;
  const ft = parseInt(document.getElementById('prisma-ft').value) || 0;
  const excl2 = parseInt(document.getElementById('prisma-excl2').value) || 0;
  const incl = parseInt(document.getElementById('prisma-incl').value) || 0;

  const output = document.getElementById('prisma-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>PRISMA 2020 Flow Diagram</strong>

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           IDENTIFICATION                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Records from databases: ${db.toLocaleString().padStart(6)}                  ‚îÇ
‚îÇ Records from other sources: ${other.toLocaleString().padStart(4)}              ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ
‚îÇ Total records: ${(db + other).toLocaleString().padStart(6)}                     ‚îÇ
‚îÇ Duplicates removed: ${dup.toLocaleString().padStart(6)}                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           SCREENING                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Records screened: ${screen.toLocaleString().padStart(6)}                      ‚îÇ
‚îÇ Records excluded: ${excl1.toLocaleString().padStart(6)}                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           ELIGIBILITY                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Full-text assessed: ${ft.toLocaleString().padStart(5)}                       ‚îÇ
‚îÇ Full-text excluded: ${excl2.toLocaleString().padStart(5)}                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           INCLUDED                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Studies in review: ${incl.toLocaleString().padStart(6)}                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

<strong>Yield Rates:</strong>
‚Ä¢ Title/abstract screen yield: ${((ft/screen)*100).toFixed(1)}%
‚Ä¢ Full-text inclusion rate: ${((incl/ft)*100).toFixed(1)}%
‚Ä¢ Overall database yield: ${((incl/db)*100).toFixed(2)}%
  `;

  awardPoints(25, 'PRISMA flow generated');
  trackToolUse('prisma-flow');
}

let extractedStudies = [];

function generateExtraction() {
  const study = {
    id: document.getElementById('extract-id').value || 'Unknown',
    pop: document.getElementById('extract-pop').value || '-',
    int: document.getElementById('extract-int').value || '-',
    comp: document.getElementById('extract-comp').value || '-',
    out: document.getElementById('extract-out').value || '-',
    followup: document.getElementById('extract-followup').value || '-'
  };

  extractedStudies.push(study);

  const output = document.getElementById('extraction-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Data Extraction Table (${extractedStudies.length} studies)</strong>

${extractedStudies.map((s, i) => `
Study ${i+1}: ${s.id}
‚îú‚îÄ Population: ${s.pop}
‚îú‚îÄ Intervention: ${s.int}
‚îú‚îÄ Comparator: ${s.comp}
‚îú‚îÄ Outcome: ${s.out}
‚îî‚îÄ Follow-up: ${s.followup}
`).join('\n')}

<strong>Next:</strong> Enter another study or proceed to risk of bias assessment.
  `;

  // Clear inputs for next study
  document.getElementById('extract-id').value = '';
  document.getElementById('extract-pop').value = '';
  document.getElementById('extract-int').value = '';
  document.getElementById('extract-comp').value = '';
  document.getElementById('extract-out').value = '';
  document.getElementById('extract-followup').value = '';

  awardPoints(15, 'Study extracted');
  trackToolUse('extraction-form');
}

function generateRoB() {
  const id = document.getElementById('rob-id').value || 'Study';
  const d1 = document.getElementById('rob-d1').value;
  const d2 = document.getElementById('rob-d2').value;
  const d3 = document.getElementById('rob-d3').value;
  const d4 = document.getElementById('rob-d4').value;
  const d5 = document.getElementById('rob-d5').value;

  const domains = [d1, d2, d3, d4, d5];
  let overall = 'Low risk';

  const highCount = domains.filter(d => d === 'high').length;
  const someCount = domains.filter(d => d === 'some').length;

  if (highCount > 0) {
    overall = 'High risk';
  } else if (someCount >= 2) {
    overall = 'Some concerns (multiple domains)';
  } else if (someCount === 1) {
    overall = 'Some concerns';
  }

  const getColor = (val) => val === 'low' ? 'üü¢' : val === 'some' ? 'üü°' : 'üî¥';

  const output = document.getElementById('rob-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Risk of Bias Assessment: ${id}</strong>

${getColor(d1)} Domain 1 (Randomization): ${d1}
${getColor(d2)} Domain 2 (Deviations): ${d2}
${getColor(d3)} Domain 3 (Missing data): ${d3}
${getColor(d4)} Domain 4 (Measurement): ${d4}
${getColor(d5)} Domain 5 (Selection): ${d5}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
OVERALL: ${overall === 'Low risk' ? 'üü¢' : overall.includes('High') ? 'üî¥' : 'üü°'} ${overall}

<strong>Interpretation:</strong>
${overall === 'Low risk' ?
  'Study unlikely to be seriously biased. Results can be weighted appropriately.' :
  overall.includes('High') ?
  'Study has serious limitations. Consider sensitivity analysis excluding it.' :
  'Study raises some concerns. Report in table; may downgrade GRADE certainty.'}
  `;

  awardPoints(20, 'RoB assessment completed');
  trackToolUse('rob2-tool');
}

function updateEffectInputs() {
  const type = document.getElementById('effect-type').value;
  document.getElementById('binary-inputs').style.display = type === 'binary' ? 'block' : 'none';
  document.getElementById('continuous-inputs').style.display = type === 'continuous' ? 'block' : 'none';
}

function calculateEffect() {
  const type = document.getElementById('effect-type').value;
  const output = document.getElementById('effect-output');
  output.style.display = 'block';

  if (type === 'binary') {
    const e1 = parseInt(document.getElementById('eff-e1').value);
    const n1 = parseInt(document.getElementById('eff-n1').value);
    const e2 = parseInt(document.getElementById('eff-e2').value);
    const n2 = parseInt(document.getElementById('eff-n2').value);

    // Continuity correction for zero cells
    const cc = (e1 === 0 || e2 === 0 || e1 === n1 || e2 === n2) ? 0.5 : 0;
    const r1 = (e1 + cc) / (n1 + 2*cc);
    const r2 = (e2 + cc) / (n2 + 2*cc);
    const rr = r1 / r2;
    const logRR = Math.log(rr);
    const seLogRR = Math.sqrt(1/(e1+cc) - 1/(n1+2*cc) + 1/(e2+cc) - 1/(n2+2*cc));
    const lowerRR = Math.exp(logRR - 1.96 * seLogRR);
    const upperRR = Math.exp(logRR + 1.96 * seLogRR);

    const or = ((e1+cc) * (n2-e2+cc)) / ((e2+cc) * (n1-e1+cc));
    const seLogOR = Math.sqrt(1/(e1+cc) + 1/(n1-e1+cc) + 1/(e2+cc) + 1/(n2-e2+cc));
    const lowerOR = Math.exp(Math.log(or) - 1.96 * seLogOR);
    const upperOR = Math.exp(Math.log(or) + 1.96 * seLogOR);

    const rd = r1 - r2;
    const seRD = Math.sqrt(r1*(1-r1)/n1 + r2*(1-r2)/n2);
    const lowerRD = rd - 1.96 * seRD;
    const upperRD = rd + 1.96 * seRD;

    output.innerHTML = `
<strong>Effect Size Calculations (Binary Outcome)</strong>

Treatment: ${e1}/${n1} (${(r1*100).toFixed(1)}%)
Control: ${e2}/${n2} (${(r2*100).toFixed(1)}%)

<strong>Risk Ratio (RR):</strong> ${rr.toFixed(2)} (95% CI: ${lowerRR.toFixed(2)}-${upperRR.toFixed(2)})
  log(RR) = ${logRR.toFixed(3)}, SE = ${seLogRR.toFixed(3)}

<strong>Odds Ratio (OR):</strong> ${or.toFixed(2)} (95% CI: ${lowerOR.toFixed(2)}-${upperOR.toFixed(2)})

<strong>Risk Difference (RD):</strong> ${(rd*100).toFixed(1)}% (95% CI: ${(lowerRD*100).toFixed(1)}% to ${(upperRD*100).toFixed(1)}%)
  NNT = ${rd !== 0 ? Math.abs(Math.round(1/rd)) + (rd < 0 ? ' (benefit)' : ' (harm)') : 'N/A (no difference)'}

<strong>Interpretation:</strong>
${rr < 1 ? `Treatment reduces events by ${((1-rr)*100).toFixed(0)}% relative to control.` :
  rr > 1 ? `Treatment increases events by ${((rr-1)*100).toFixed(0)}% relative to control.` :
  'No difference between groups.'}
    `;
  } else {
    const m1 = parseFloat(document.getElementById('eff-m1').value);
    const sd1 = parseFloat(document.getElementById('eff-sd1').value);
    const cn1 = parseInt(document.getElementById('eff-cn1').value);
    const m2 = parseFloat(document.getElementById('eff-m2').value);
    const sd2 = parseFloat(document.getElementById('eff-sd2').value);
    const cn2 = parseInt(document.getElementById('eff-cn2').value);

    const md = m1 - m2;
    const pooledSD = Math.sqrt(((cn1-1)*sd1*sd1 + (cn2-1)*sd2*sd2) / (cn1 + cn2 - 2));
    const seMD = Math.sqrt(sd1*sd1/cn1 + sd2*sd2/cn2);
    const lowerMD = md - 1.96 * seMD;
    const upperMD = md + 1.96 * seMD;

    const smd = md / pooledSD;
    const seSMD = Math.sqrt((cn1 + cn2)/(cn1 * cn2) + smd*smd/(2*(cn1 + cn2)));
    const lowerSMD = smd - 1.96 * seSMD;
    const upperSMD = smd + 1.96 * seSMD;

    let effectSize = 'negligible';
    if (Math.abs(smd) >= 0.8) effectSize = 'large';
    else if (Math.abs(smd) >= 0.5) effectSize = 'medium';
    else if (Math.abs(smd) >= 0.2) effectSize = 'small';

    output.innerHTML = `
<strong>Effect Size Calculations (Continuous Outcome)</strong>

Treatment: mean = ${m1.toFixed(2)}, SD = ${sd1.toFixed(2)}, N = ${cn1}
Control: mean = ${m2.toFixed(2)}, SD = ${sd2.toFixed(2)}, N = ${cn2}
Pooled SD = ${pooledSD.toFixed(2)}

<strong>Mean Difference (MD):</strong> ${md.toFixed(2)} (95% CI: ${lowerMD.toFixed(2)} to ${upperMD.toFixed(2)})
  SE = ${seMD.toFixed(3)}

<strong>Standardized Mean Difference (SMD/Cohen's d):</strong>
  d = ${smd.toFixed(2)} (95% CI: ${lowerSMD.toFixed(2)} to ${upperSMD.toFixed(2)})
  SE = ${seSMD.toFixed(3)}

<strong>Interpretation (Cohen's conventions):</strong>
  Effect size: ${effectSize} (|d| ${Math.abs(smd).toFixed(2)})
  ${smd < 0 ? 'Treatment group has LOWER scores than control.' :
    smd > 0 ? 'Treatment group has HIGHER scores than control.' :
    'No difference between groups.'}
    `;
  }

  awardPoints(25, 'Effect size calculated');
  trackToolUse('effect-calculator');
}

function _escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function generateForest() {
  const data = document.getElementById('forest-data').value;
  const model = document.getElementById('forest-model').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    return {
      name: _escHtml(parts[0]),
      rr: parseFloat(parts[1]),
      lower: parseFloat(parts[2]),
      upper: parseFloat(parts[3]),
      logRR: Math.log(parseFloat(parts[1])),
      se: (Math.log(parseFloat(parts[3])) - Math.log(parseFloat(parts[2]))) / (2 * 1.96)
    };
  });

  // Calculate pooled effect (inverse variance)
  let sumW = 0, sumWY = 0, sumW2 = 0;
  const weights = [];
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    weights.push(w);
    sumW += w;
    sumWY += w * s.logRR;
    sumW2 += w * w;
  });

  const pooledLogRR = sumWY / sumW;
  const pooledRR = Math.exp(pooledLogRR);

  // Q statistic and heterogeneity
  let Q = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    Q += w * Math.pow(s.logRR - pooledLogRR, 2);
  });

  const df = studies.length - 1;
  const I2 = Math.max(0, ((Q - df) / Q) * 100);
  const tau2 = Math.max(0, (Q - df) / (sumW - sumW2/sumW));

  // Random effects pooled
  let sumWr = 0, sumWYr = 0;
  const weightsRE = [];
  studies.forEach(s => {
    const wr = 1 / (s.se * s.se + tau2);
    weightsRE.push(wr);
    sumWr += wr;
    sumWYr += wr * s.logRR;
  });
  const pooledLogRRr = sumWYr / sumWr;
  const pooledRRr = Math.exp(pooledLogRRr);
  const sePooledRE = Math.sqrt(1 / sumWr);
  const lowerPooledRE = Math.exp(pooledLogRRr - 1.96 * sePooledRE);
  const upperPooledRE = Math.exp(pooledLogRRr + 1.96 * sePooledRE);

  const sePooledFE = Math.sqrt(1 / sumW);
  const lowerPooledFE = Math.exp(pooledLogRR - 1.96 * sePooledFE);
  const upperPooledFE = Math.exp(pooledLogRR + 1.96 * sePooledFE);

  const usedWeights = model === 'random' ? weightsRE : weights;
  const totalWeight = usedWeights.reduce((a, b) => a + b, 0);
  const weightPct = usedWeights.map(w => (w / totalWeight) * 100);

  const usedRR = model === 'random' ? pooledRRr : pooledRR;
  const usedLower = model === 'random' ? lowerPooledRE : lowerPooledFE;
  const usedUpper = model === 'random' ? upperPooledRE : upperPooledFE;

  // Prediction interval (using proper t-distribution)
  const piDF = Math.max(1, studies.length - 2);
  const tCrit = getTCritical(piDF);
  const sePooled = model === 'random' ? sePooledRE : sePooledFE;
  const piWidth = tCrit * Math.sqrt(tau2 + sePooled*sePooled);
  const piLower = Math.exp((model === 'random' ? pooledLogRRr : pooledLogRR) - piWidth);
  const piUpper = Math.exp((model === 'random' ? pooledLogRRr : pooledLogRR) + piWidth);

  // === BUILD INTERACTIVE PLOTLY FOREST PLOT ===
  const output = document.getElementById('forest-output');
  output.style.display = 'block';

  // Create plot container
  output.innerHTML = `
    <div id="forestPlotArea" style="width:100%; height:${Math.max(300, studies.length * 35 + 120)}px;"></div>
    <div class="stats-panel" style="margin-top:1rem;">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">${usedRR.toFixed(2)}</div>
          <div class="stat-label">Pooled RR</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${usedLower.toFixed(2)}-${usedUpper.toFixed(2)}</div>
          <div class="stat-label">95% CI</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${I2.toFixed(1)}%</div>
          <div class="stat-label">I¬≤ heterogeneity</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${piLower.toFixed(2)}-${piUpper.toFixed(2)}</div>
          <div class="stat-label">Prediction Interval</div>
        </div>
      </div>
      <div class="stat-interpretation">
        <strong>Interpretation:</strong> ${usedLower > 1 ? '‚ö†Ô∏è Treatment INCREASES risk (statistically significant).' :
          usedUpper < 1 ? '‚úì Treatment REDUCES risk (statistically significant).' :
          '‚óã No statistically significant effect (CI crosses 1.0).'}
        ${I2 > 50 ? '<br><strong>Warning:</strong> High heterogeneity (I¬≤ > 50%) ‚Äî consider exploring sources of variation.' : ''}
        ${piLower < 1 && piUpper > 1 ? '<br><strong>Note:</strong> Prediction interval crosses null ‚Äî true effect in a new study could go either direction.' : ''}
      </div>
    </div>
  `;

  // Check if Plotly is loaded
  if (typeof Plotly !== 'undefined') {
    const yValues = studies.map((s, i) => studies.length - i);
    const studyNames = studies.map(s => s.name);

    // Study points trace
    const studyTrace = {
      x: studies.map(s => s.rr),
      y: yValues,
      mode: 'markers',
      type: 'scatter',
      marker: {
        size: weightPct.map(w => Math.max(8, Math.min(24, w * 1.5))),
        color: '#1E2761',
        symbol: 'square',
        line: { color: '#0d1b2a', width: 1 }
      },
      error_x: {
        type: 'data',
        symmetric: false,
        array: studies.map(s => s.upper - s.rr),
        arrayminus: studies.map(s => s.rr - s.lower),
        color: '#1E2761',
        thickness: 2,
        width: 4
      },
      text: studies.map((s, i) => `${s.name}<br>RR: ${s.rr.toFixed(2)} (${s.lower.toFixed(2)}-${s.upper.toFixed(2)})<br>Weight: ${weightPct[i].toFixed(1)}%`),
      hoverinfo: 'text',
      name: 'Studies'
    };

    // Pooled effect diamond
    const pooledTrace = {
      x: [usedRR],
      y: [0],
      mode: 'markers',
      type: 'scatter',
      marker: {
        size: 16,
        color: '#D4AF37',
        symbol: 'diamond',
        line: { color: '#8B7500', width: 2 }
      },
      error_x: {
        type: 'data',
        symmetric: false,
        array: [usedUpper - usedRR],
        arrayminus: [usedRR - usedLower],
        color: '#D4AF37',
        thickness: 3,
        width: 0
      },
      text: [`Pooled (${model})<br>RR: ${usedRR.toFixed(2)} (${usedLower.toFixed(2)}-${usedUpper.toFixed(2)})`],
      hoverinfo: 'text',
      name: 'Pooled'
    };

    // Null effect line
    const nullLine = {
      x: [1, 1],
      y: [-0.5, studies.length + 0.5],
      mode: 'lines',
      type: 'scatter',
      line: { color: '#888', width: 1, dash: 'dash' },
      hoverinfo: 'skip',
      showlegend: false
    };

    // Prediction interval
    const piTrace = {
      x: [piLower, piUpper],
      y: [-0.5, -0.5],
      mode: 'lines+markers',
      type: 'scatter',
      line: { color: '#888', width: 1, dash: 'dot' },
      marker: { size: 6, color: '#888', symbol: 'line-ns-open' },
      text: [`Prediction Interval: ${piLower.toFixed(2)}-${piUpper.toFixed(2)}`],
      hoverinfo: 'text',
      name: 'Prediction Interval'
    };

    const layout = {
      xaxis: {
        title: 'Risk Ratio (log scale)',
        type: 'log',
        showgrid: true,
        gridcolor: '#eee',
        zeroline: false,
        tickvals: [0.25, 0.5, 1, 2, 4],
        ticktext: ['0.25', '0.5', '1', '2', '4']
      },
      yaxis: {
        tickvals: [...yValues, 0],
        ticktext: [...studyNames, `<b>Pooled (${model})</b>`],
        showgrid: false,
        zeroline: false
      },
      annotations: [
        { x: 0.5, y: -0.08, xref: 'paper', yref: 'paper', text: '‚Üê Favors Treatment', showarrow: false, font: { size: 10, color: '#22c55e' } },
        { x: 0.95, y: -0.08, xref: 'paper', yref: 'paper', text: 'Favors Control ‚Üí', showarrow: false, font: { size: 10, color: '#C53030' } }
      ],
      showlegend: false,
      margin: { l: 150, r: 50, t: 30, b: 60 },
      paper_bgcolor: 'white',
      plot_bgcolor: 'white',
      hovermode: 'closest'
    };

    Plotly.newPlot('forestPlotArea', [nullLine, studyTrace, pooledTrace, piTrace], layout, { responsive: true });
  } else {
    // Fallback to text-based plot if Plotly not loaded
    output.innerHTML += '<p style="color:#888; padding:1rem;">Plotly not loaded. Showing text summary only.</p>';
  }

  awardPoints(50, 'Forest plot generated');
  trackToolUse('forest-plot');
}

// ============================================================
// FUNNEL PLOT FROM FOREST DATA (INTERACTIVE - Plotly)
// ============================================================

function generateFunnelFromForest() {
  const data = document.getElementById('forest-data').value;
  const output = document.getElementById('forest-output');
  output.style.display = 'block';

  const rawLines = data
    .split('\n')
    .map(line => line.trim())
    .filter(line => line);

  const studies = rawLines
    .map(line => {
      const parts = line.split(',').map(p => p.trim());
      if (parts.length < 4) return null;
      const rr = parseFloat(parts[1]);
      const lower = parseFloat(parts[2]);
      const upper = parseFloat(parts[3]);
      if (!Number.isFinite(rr) || !Number.isFinite(lower) || !Number.isFinite(upper)) return null;
      if (rr <= 0 || lower <= 0 || upper <= 0 || upper <= lower) return null;
      const logRR = Math.log(rr);
      const se = (Math.log(upper) - Math.log(lower)) / (2 * 1.96);
      if (!Number.isFinite(logRR) || !Number.isFinite(se) || se <= 0) return null;
      return { name: _escHtml(parts[0]), rr, lower, upper, logRR, se };
    })
    .filter(Boolean);

  const invalidRows = rawLines.length - studies.length;

  if (studies.length < 3) {
    output.innerHTML = `
      <div class="stats-panel">
        <strong>Need at least 3 valid studies to run funnel and Egger analysis.</strong><br>
        Provide rows in this format: <code>Study, RR, lower_CI, upper_CI</code>.<br>
        Valid rows: ${studies.length}. Excluded invalid rows: ${invalidRows}.
      </div>
    `;
    return;
  }

  // Calculate pooled effect
  let sumW = 0, sumWY = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
  });
  if (!Number.isFinite(sumW) || sumW <= 0 || !Number.isFinite(sumWY)) {
    output.innerHTML = `
      <div class="stats-panel">
        <strong>Unable to compute pooled effect from provided data.</strong><br>
        Check that all studies have valid numeric CIs with lower &lt; upper.
      </div>
    `;
    return;
  }
  const pooledLogRR = sumWY / sumW;

  // Egger's test
  const n = studies.length;
  const precision = studies.map(s => 1 / s.se);
  const standardized = studies.map(s => s.logRR / s.se);

  const meanP = precision.reduce((a, b) => a + b, 0) / n;
  const meanS = standardized.reduce((a, b) => a + b, 0) / n;

  let num = 0, denP = 0;
  for (let i = 0; i < n; i++) {
    num += (precision[i] - meanP) * (standardized[i] - meanS);
    denP += Math.pow(precision[i] - meanP, 2);
  }

  let intercept = NaN;
  let pValue = NaN;
  let eggerEstimable = n >= 3 && Number.isFinite(denP) && denP > 0;
  if (eggerEstimable) {
    const slope = num / denP;
    intercept = meanS - slope * meanP;

    let residualSS = 0;
    for (let i = 0; i < n; i++) {
      const predicted = intercept + slope * precision[i];
      residualSS += Math.pow(standardized[i] - predicted, 2);
    }
    const mse = residualSS / (n - 2);
    const seIntercept = Math.sqrt(mse * (1 / n + (meanP * meanP) / denP));
    const tStat = intercept / seIntercept;
    const eggerDF = n - 2;
    if (!Number.isFinite(seIntercept) || seIntercept <= 0 || !Number.isFinite(tStat) || eggerDF <= 0) {
      eggerEstimable = false;
    } else {
      pValue = 2 * (1 - tCDF(Math.abs(tStat), eggerDF));
      if (!Number.isFinite(pValue)) eggerEstimable = false;
    }
  }

  const lowPower = n < 10;
  const asymmetryDetected = eggerEstimable && !lowPower && pValue < 0.10;
  const interceptDisplay = eggerEstimable ? intercept.toFixed(3) : 'N/A';
  const pValueDisplay = eggerEstimable ? pValue.toFixed(4) : 'N/A';
  const asymmetryDisplay = !eggerEstimable
    ? 'Not estimable'
    : lowPower
      ? 'Low power (k<10)'
      : (asymmetryDetected ? 'Yes' : 'No');

  let interpretation = '';
  if (!eggerEstimable) {
    interpretation = "Egger's test is not estimable for this dataset (need >=3 valid studies and variation in precision).";
  } else if (lowPower) {
    interpretation = `Egger's test has limited power with only ${n} studies. Treat the p-value as exploratory and rely on visual/clinical assessment.`;
  } else if (asymmetryDetected) {
    interpretation = "Funnel plot asymmetry detected (Egger p < 0.10). This may reflect publication bias, small-study effects, or heterogeneity.";
  } else {
    interpretation = "No statistical evidence of funnel asymmetry. This does not rule out publication bias.";
  }
  if (invalidRows > 0) {
    interpretation += ` Data quality note: excluded ${invalidRows} invalid row(s).`;
  }

  output.innerHTML = `
    <div id="funnelPlotArea" style="width:100%; height:350px; margin-bottom:1rem;"></div>
    <div class="stats-panel">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">${interceptDisplay}</div>
          <div class="stat-label">Egger's Intercept</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${pValueDisplay}</div>
          <div class="stat-label">P-value</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${asymmetryDisplay}</div>
          <div class="stat-label">Asymmetry signal (p < 0.10, k>=10)</div>
        </div>
      </div>
      <div class="stat-interpretation">
        <strong>Interpretation:</strong> ${interpretation}
      </div>
    </div>
  `;

  if (typeof Plotly !== 'undefined') {
    const maxSE = Math.max(...studies.map(s => s.se)) * 1.2;

    const seRange = Array.from({length: 50}, (_, i) => (i / 49) * maxSE);
    const lowerBound = seRange.map(se => Math.exp(pooledLogRR - 1.96 * se));
    const upperBound = seRange.map(se => Math.exp(pooledLogRR + 1.96 * se));

    const funnelTrace = {
      x: [...lowerBound, ...upperBound.reverse()],
      y: [...seRange, ...seRange.reverse()],
      fill: 'toself',
      fillcolor: 'rgba(30,39,97,0.1)',
      line: { color: 'transparent' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const pooledLine = {
      x: [Math.exp(pooledLogRR), Math.exp(pooledLogRR)],
      y: [0, maxSE],
      mode: 'lines',
      line: { color: '#D4AF37', width: 2, dash: 'dash' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const nullLine = {
      x: [1, 1],
      y: [0, maxSE],
      mode: 'lines',
      line: { color: '#888', width: 1, dash: 'dot' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const studyPoints = {
      x: studies.map(s => s.rr),
      y: studies.map(s => s.se),
      mode: 'markers',
      type: 'scatter',
      marker: { size: 10, color: '#1E2761', line: { color: '#0d1b2a', width: 1 } },
      text: studies.map(s => `${s.name}<br>RR: ${s.rr.toFixed(2)}<br>SE: ${s.se.toFixed(3)}`),
      hoverinfo: 'text',
      name: 'Studies'
    };

    const layout = {
      xaxis: { title: 'Risk Ratio (log scale)', type: 'log', showgrid: true, gridcolor: '#eee' },
      yaxis: { title: 'Standard Error', autorange: 'reversed', showgrid: true, gridcolor: '#eee' },
      showlegend: false,
      margin: { l: 60, r: 30, t: 30, b: 50 },
      paper_bgcolor: 'white',
      plot_bgcolor: 'white'
    };

    Plotly.newPlot('funnelPlotArea', [funnelTrace, pooledLine, nullLine, studyPoints], layout, { responsive: true });
  }

  awardPoints(50, 'Funnel plot generated');
  trackToolUse('funnel-plot');
}

// Normal CDF approximation
function normalCDF(x) {
  const a1 =  0.254829592, a2 = -0.284496736, a3 =  1.421413741;
  const a4 = -1.453152027, a5 =  1.061405429, p  =  0.3275911;
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x) / Math.sqrt(2);
  const t = 1.0 / (1.0 + p * x);
  const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
  return 0.5 * (1.0 + sign * y);
}

// T-distribution critical values (two-tailed 95%, df 1-30 and approximation for larger)
const tCriticalValues = {
  1: 12.706, 2: 4.303, 3: 3.182, 4: 2.776, 5: 2.571,
  6: 2.447, 7: 2.365, 8: 2.306, 9: 2.262, 10: 2.228,
  11: 2.201, 12: 2.179, 13: 2.160, 14: 2.145, 15: 2.131,
  16: 2.120, 17: 2.110, 18: 2.101, 19: 2.093, 20: 2.086,
  21: 2.080, 22: 2.074, 23: 2.069, 24: 2.064, 25: 2.060,
  26: 2.056, 27: 2.052, 28: 2.048, 29: 2.045, 30: 2.042
};

function getTCritical(df) {
  if (df <= 0) return 12.706;
  if (df <= 30) return tCriticalValues[df] || tCriticalValues[Math.round(df)];
  // For df > 30, use approximation approaching 1.96
  return 1.96 + 2.4 / df;
}

// T-distribution CDF approximation (for p-value calculation)
function tCDF(t, df) {
  // Use regularized incomplete beta function approximation
  const x = df / (df + t * t);
  const a = df / 2;
  const b = 0.5;
  // For |t| > 0, use beta function approximation
  if (Math.abs(t) < 1e-10) return 0.5;
  const betaIncomplete = incompleteBeta(x, a, b);
  return t > 0 ? 1 - 0.5 * betaIncomplete : 0.5 * betaIncomplete;
}

// Incomplete beta function approximation using continued fractions
function incompleteBeta(x, a, b) {
  if (x === 0) return 0;
  if (x === 1) return 1;
  // Use series expansion for small x
  const bt = Math.exp(
    lgamma(a + b) - lgamma(a) - lgamma(b) +
    a * Math.log(x) + b * Math.log(1 - x)
  );
  if (x < (a + 1) / (a + b + 2)) {
    return bt * betaCF(x, a, b) / a;
  } else {
    return 1 - bt * betaCF(1 - x, b, a) / b;
  }
}

// Continued fraction for incomplete beta
function betaCF(x, a, b) {
  const maxIter = 100, eps = 1e-10;
  let am = 1, bm = 1, az = 1;
  const qab = a + b, qap = a + 1, qam = a - 1;
  let bz = 1 - qab * x / qap;
  for (let m = 1; m <= maxIter; m++) {
    const em = m, tem = em + em;
    let d = em * (b - m) * x / ((qam + tem) * (a + tem));
    const ap = az + d * am;
    const bp = bz + d * bm;
    d = -(a + em) * (qab + em) * x / ((a + tem) * (qap + tem));
    const app = ap + d * az;
    const bpp = bp + d * bz;
    const aold = az;
    am = ap / bpp; bm = bp / bpp;
    az = app / bpp; bz = 1;
    if (Math.abs(az - aold) < eps * Math.abs(az)) break;
  }
  return az;
}

// Log gamma function (Lanczos approximation)
function lgamma(x) {
  const g = 7;
  const c = [0.99999999999980993, 676.5203681218851, -1259.1392167224028,
    771.32342877765313, -176.61502916214059, 12.507343278686905,
    -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
  if (x < 0.5) {
    return Math.log(Math.PI / Math.sin(Math.PI * x)) - lgamma(1 - x);
  }
  x -= 1;
  let a = c[0];
  for (let i = 1; i < g + 2; i++) a += c[i] / (x + i);
  const t = x + g + 0.5;
  return 0.5 * Math.log(2 * Math.PI) + (x + 0.5) * Math.log(t) - t + Math.log(a);
}

// ============================================================
// PRESET DATASETS (Real-world meta-analysis data)
// ============================================================

const forestPresets = {
  aspirin: {
    name: "Aspirin for Primary Prevention",
    description: "Major trials of aspirin for cardiovascular prevention in people without prior CVD",
    data: `PHS 1989, 0.58, 0.47, 0.72
BDT 1988, 0.97, 0.87, 1.09
TPT 1998, 0.80, 0.61, 1.05
HOT 1998, 0.85, 0.73, 0.99
PPP 2001, 0.71, 0.48, 1.04
WHS 2005, 1.02, 0.84, 1.25
POPADAD 2008, 0.98, 0.76, 1.26
JPAD 2008, 0.80, 0.58, 1.10
AAA 2010, 1.08, 0.86, 1.36
JPPP 2014, 0.94, 0.77, 1.15
ARRIVE 2018, 0.96, 0.81, 1.13
ASCEND 2018, 0.88, 0.79, 0.97
ASPREE 2018, 0.95, 0.83, 1.08`
  },
  cast: {
    name: "CAST: Antiarrhythmic Drugs After MI",
    description: "The trial that killed 50,000+ Americans ‚Äî asking the wrong question",
    data: `Encainide 1989, 2.38, 1.59, 3.57
Flecainide 1989, 2.64, 1.60, 4.36
Moricizine 1992, 1.69, 1.10, 2.58`
  },
  magnesium: {
    name: "Magnesium in Acute MI",
    description: "Small trials vs mega-trial ‚Äî the danger of small-study effects",
    data: `Morton 1984, 0.09, 0.01, 1.54
Rasmussen 1986, 0.25, 0.07, 0.89
Smith 1986, 0.45, 0.09, 2.13
Abraham 1987, 0.75, 0.31, 1.78
Feldstedt 1988, 0.56, 0.23, 1.36
Ceremuzynski 1989, 0.25, 0.06, 1.10
Shechter 1990, 0.16, 0.04, 0.69
LIMIT-2 1992, 0.74, 0.56, 0.99
ISIS-4 1995, 1.06, 0.99, 1.14`
  },
  ssri: {
    name: "SSRIs vs Placebo (Published vs All Trials)",
    description: "Turner 2008: Publication bias in antidepressant trials",
    data: `Published + Positive, 0.65, 0.58, 0.73
Published + Negative, 0.92, 0.80, 1.06
Unpublished + Negative, 0.95, 0.86, 1.05
Unpublished + Questionable, 0.88, 0.77, 1.01`
  },
  hrt: {
    name: "HRT and Coronary Heart Disease",
    description: "Observational studies suggested benefit, but RCTs showed harm",
    data: `NHS 1985, 0.50, 0.30, 0.80
Framingham 1985, 0.50, 0.30, 0.90
NHANES 1987, 0.66, 0.46, 0.96
Uppsala 1988, 0.90, 0.70, 1.20
Rancho 1991, 0.59, 0.35, 0.99
NHS 1991, 0.56, 0.40, 0.80
Leisure World 1996, 0.62, 0.50, 0.76
WHI 2002, 1.29, 1.02, 1.63
HERS 1998, 0.99, 0.81, 1.22`
  }
};

function loadForestPreset() {
  const preset = document.getElementById('forest-preset').value;
  if (!preset || !forestPresets[preset]) return;

  const data = forestPresets[preset];
  document.getElementById('forest-data').value = data.data;

  // Show info about the dataset
  const output = document.getElementById('forest-output');
  output.style.display = 'block';
  output.innerHTML = `
    <div style="background: rgba(30,39,97,0.15); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <strong style="color: var(--navy);">üìö ${data.name}</strong>
      <p style="margin-top: 0.5rem; color: var(--light-text); font-size: 0.9rem;">${data.description}</p>
      <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--teal);">Click "Forest Plot" or "Funnel Plot" to analyze this data.</p>
    </div>
  `;
}

// ============================================================
// INTERACTIVE DATA TABLE EDITOR
// ============================================================

function addStudyRow() {
  const table = document.getElementById('study-data-table');
  if (!table) return;

  const tbody = table.querySelector('tbody');
  const rowCount = tbody.children.length + 1;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" value="Study ${rowCount}" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="1.00" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="0.80" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="1.25" onchange="updateForestData()"></td>
    <td class="row-actions"><button class="delete-row" onclick="deleteStudyRow(this)">‚úï</button></td>
  `;
  tbody.appendChild(row);
  updateForestData();
}

function deleteStudyRow(btn) {
  const row = btn.closest('tr');
  if (row) {
    row.remove();
    updateForestData();
  }
}

function updateForestData() {
  const table = document.getElementById('study-data-table');
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  const lines = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length >= 4) {
      const name = inputs[0].value;
      const rr = inputs[1].value;
      const lower = inputs[2].value;
      const upper = inputs[3].value;
      lines.push(`${name}, ${rr}, ${lower}, ${upper}`);
    }
  });

  const textarea = document.getElementById('forest-data');
  if (textarea) {
    textarea.value = lines.join('\n');
  }
}

// Legacy text forest for compatibility
function generateForestLegacy() {
  const data = document.getElementById('forest-data').value;
  const model = document.getElementById('forest-model').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    return {
      name: _escHtml(parts[0]),
      rr: parseFloat(parts[1]),
      lower: parseFloat(parts[2]),
      upper: parseFloat(parts[3]),
      logRR: Math.log(parseFloat(parts[1])),
      se: (Math.log(parseFloat(parts[3])) - Math.log(parseFloat(parts[2]))) / (2 * 1.96)
    };
  });

  let sumW = 0, sumWY = 0, sumW2 = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
    sumW2 += w * w;
  });

  const pooledLogRR = sumWY / sumW;
  const pooledRR = Math.exp(pooledLogRR);

  let Q = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    Q += w * Math.pow(s.logRR - pooledLogRR, 2);
  });

  const df = studies.length - 1;
  const I2 = Math.max(0, ((Q - df) / Q) * 100);
  const tau2 = Math.max(0, (Q - df) / (sumW - sumW2/sumW));

  let sumWr = 0, sumWYr = 0;
  studies.forEach(s => {
    const wr = 1 / (s.se * s.se + tau2);
    sumWr += wr;
    sumWYr += wr * s.logRR;
  });
  const pooledLogRRr = sumWYr / sumWr;
  const pooledRRr = Math.exp(pooledLogRRr);
  const sePooledRE = Math.sqrt(1 / sumWr);
  const lowerPooledRE = Math.exp(pooledLogRRr - 1.96 * sePooledRE);
  const upperPooledRE = Math.exp(pooledLogRRr + 1.96 * sePooledRE);

  const sePooledFE = Math.sqrt(1 / sumW);
  const lowerPooledFE = Math.exp(pooledLogRR - 1.96 * sePooledFE);
  const upperPooledFE = Math.exp(pooledLogRR + 1.96 * sePooledFE);

  const usedRR = model === 'random' ? pooledRRr : pooledRR;
  const usedLower = model === 'random' ? lowerPooledRE : lowerPooledFE;
  const usedUpper = model === 'random' ? upperPooledRE : upperPooledFE;

  const minLog = Math.log(0.3);
  const maxLog = Math.log(2.0);
  const range = maxLog - minLog;
  const width = 50;

  const getPos = (rr) => Math.round(((Math.log(rr) - minLog) / range) * width);
  const nullPos = getPos(1.0);

  let forestText = `
<strong>Forest Plot (${model === 'random' ? 'Random Effects' : 'Fixed Effect'})</strong>

                              0.3   0.5     1.0    1.5  2.0
Study                RR (95% CI)  ‚îÇ${' '.repeat(nullPos-1)}‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº${'‚îÄ'.repeat(width)}‚î§
`;

  studies.forEach(s => {
    const pos = getPos(s.rr);
    const lowerPos = Math.max(0, getPos(s.lower));
    const upperPos = Math.min(width, getPos(s.upper));

    let line = ' '.repeat(width + 1);
    line = line.substring(0, lowerPos) + '‚îú' + '‚îÄ'.repeat(Math.max(0, upperPos - lowerPos - 1)) + '‚î§' + line.substring(upperPos + 1);
    line = line.substring(0, pos) + '‚ñ†' + line.substring(pos + 1);

    const name = (s.name + ' '.repeat(15)).substring(0, 15);
    const ci = `${s.rr.toFixed(2)} (${s.lower.toFixed(2)}-${s.upper.toFixed(2)})`;
    forestText += `${name}  ${ci.padEnd(16)} ‚îÇ${line}‚îÇ\n`;
  });

  const pooledPos = getPos(usedRR);
  const pooledLowerPos = Math.max(0, getPos(usedLower));
  const pooledUpperPos = Math.min(width, getPos(usedUpper));
  let pooledLine = ' '.repeat(width + 1);
  pooledLine = pooledLine.substring(0, pooledLowerPos) + '<' + '‚ïê'.repeat(Math.max(0, pooledUpperPos - pooledLowerPos - 1)) + '>' + pooledLine.substring(pooledUpperPos + 1);
  pooledLine = pooledLine.substring(0, pooledPos) + '‚óÜ' + pooledLine.substring(pooledPos + 1);

  forestText += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº${'‚îÄ'.repeat(width)}‚î§
Pooled (${model})    ${usedRR.toFixed(2)} (${usedLower.toFixed(2)}-${usedUpper.toFixed(2)})   ‚îÇ${pooledLine}‚îÇ

<strong>Heterogeneity:</strong>
Q = ${Q.toFixed(2)}, df = ${df}, p ${Q > df * 2 ? '< 0.05' : '‚â• 0.05'}
I¬≤ = ${I2.toFixed(1)}% ${I2 < 25 ? '(low)' : I2 < 50 ? '(moderate)' : I2 < 75 ? '(substantial)' : '(considerable)'}
œÑ¬≤ = ${tau2.toFixed(4)}

<strong>Interpretation:</strong>
${usedLower > 1 ? 'Treatment INCREASES events (statistically significant).' :
  usedUpper < 1 ? 'Treatment REDUCES events (statistically significant).' :
  'No statistically significant effect (CI crosses 1.0).'}
`;

  const output = document.getElementById('forest-output');
  output.style.display = 'block';
  output.innerHTML = `<pre style="font-family: monospace; font-size: 0.8rem; overflow-x: auto;">${forestText}</pre>`;

  awardPoints(50, 'Forest plot generated');
  trackToolUse('forest-plot');
}

function calculateHeterogeneity() {
  const rr = parseFloat(document.getElementById('het-rr').value);
  const lower = parseFloat(document.getElementById('het-lower').value);
  const upper = parseFloat(document.getElementById('het-upper').value);
  const i2 = parseFloat(document.getElementById('het-i2').value);
  const tau2 = parseFloat(document.getElementById('het-tau2').value);
  const k = parseInt(document.getElementById('het-k').value);

  const logRR = Math.log(rr);
  const tau = Math.sqrt(tau2);

  // Prediction interval (approximate)
  const tCrit = getTCritical(Math.max(1, k - 2));
  const sePooled = (Math.log(upper) - Math.log(lower)) / (2 * 1.96);
  const piWidth = tCrit * Math.sqrt(tau2 + sePooled*sePooled);
  const piLower = Math.exp(logRR - piWidth);
  const piUpper = Math.exp(logRR + piWidth);

  const output = document.getElementById('het-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Heterogeneity Analysis</strong>

Pooled effect: RR ${rr.toFixed(2)} (95% CI: ${lower.toFixed(2)}-${upper.toFixed(2)})
Number of studies: ${k}

<strong>Heterogeneity metrics:</strong>
‚Ä¢ I¬≤ = ${i2.toFixed(1)}%
  ${i2 < 25 ? '‚Üí Low heterogeneity' :
    i2 < 50 ? '‚Üí Moderate heterogeneity' :
    i2 < 75 ? '‚Üí Substantial heterogeneity' :
    '‚Üí Considerable heterogeneity'}

‚Ä¢ œÑ¬≤ = ${tau2.toFixed(4)}
‚Ä¢ œÑ = ${tau.toFixed(3)} (SD of true effects on log scale)

<strong>95% Prediction Interval:</strong>
RR ${piLower.toFixed(2)} to ${piUpper.toFixed(2)}

${piLower < 1 && piUpper > 1 ?
  '‚ö†Ô∏è CRITICAL: Prediction interval crosses 1.0\nIn some future settings, the treatment may not work or may cause harm.' :
  piUpper < 1 ?
  '‚úì Prediction interval below 1.0 ‚Äî treatment likely beneficial across settings.' :
  '‚ö†Ô∏è Prediction interval above 1.0 ‚Äî treatment may cause harm in some settings.'}

<strong>Clinical interpretation:</strong>
The confidence interval tells you: "The average effect is probably ${rr.toFixed(2)}."
The prediction interval tells you: "A new study would probably find an effect between ${piLower.toFixed(2)} and ${piUpper.toFixed(2)}."

${i2 > 50 ? '\n‚ö†Ô∏è With I¬≤ > 50%, explore sources of heterogeneity through subgroup analysis or meta-regression.' : ''}
  `;

  awardPoints(25, 'Heterogeneity analyzed');
  trackToolUse('heterogeneity-explorer');
}

function generateFunnel() {
  const data = document.getElementById('funnel-data').value;
  const output = document.getElementById('funnel-output');
  output.style.display = 'block';

  const rawLines = data
    .split('\n')
    .map(line => line.trim())
    .filter(line => line);

  const studies = rawLines
    .map(line => {
      const parts = line.split(',').map(p => p.trim());
      if (parts.length < 3) return null;
      const logRR = parseFloat(parts[1]);
      const se = parseFloat(parts[2]);
      if (!Number.isFinite(logRR) || !Number.isFinite(se) || se <= 0) return null;
      return {
        name: _escHtml(parts[0]),
        logRR,
        se
      };
    })
    .filter(Boolean);

  const invalidRows = rawLines.length - studies.length;

  if (studies.length < 3) {
    output.innerHTML = `
      <div class="stats-panel">
        <strong>Need at least 3 valid studies to run funnel and Egger analysis.</strong><br>
        Provide rows in this format: <code>Study, logRR, SE</code>.<br>
        Valid rows: ${studies.length}. Excluded invalid rows: ${invalidRows}.
      </div>
    `;
    return;
  }

  // Calculate pooled effect for reference line
  let sumW = 0, sumWY = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
  });
  if (!Number.isFinite(sumW) || sumW <= 0 || !Number.isFinite(sumWY)) {
    output.innerHTML = `
      <div class="stats-panel">
        <strong>Unable to compute pooled effect from provided data.</strong><br>
        Check that all studies contain valid numeric logRR and SE values.
      </div>
    `;
    return;
  }
  const pooledLogRR = sumWY / sumW;

  // Egger's test (weighted linear regression of standardized effects on precision)
  const precisions = studies.map(s => 1 / s.se);
  const standardizedEffects = studies.map(s => s.logRR / s.se);
  const n = studies.length;

  let sumXY = 0, sumX2 = 0, sumY = 0, sumX = 0;
  for (let i = 0; i < n; i++) {
    const x = precisions[i];
    const y = standardizedEffects[i];
    sumXY += x * y;
    sumX2 += x * x;
    sumY += y;
    sumX += x;
  }

  const den = n * sumX2 - sumX * sumX;
  let intercept = NaN;
  let pValue = NaN;
  let eggerEstimable = n >= 3 && Number.isFinite(den) && den !== 0;

  if (eggerEstimable) {
    const slope = (n * sumXY - sumX * sumY) / den;
    intercept = (sumY - slope * sumX) / n;

    const residuals = precisions.map((p, i) => standardizedEffects[i] - (intercept + slope * p));
    const mse = residuals.reduce((s, r) => s + r * r, 0) / (n - 2);
    const meanPrec = sumX / n;
    const ssPrec = precisions.reduce((s, p) => s + (p - meanPrec) * (p - meanPrec), 0);
    const seIntercept = Math.sqrt(mse * (1 / n + (meanPrec * meanPrec) / ssPrec));
    const t = intercept / seIntercept;
    const eggerDF = n - 2;

    if (!Number.isFinite(seIntercept) || seIntercept <= 0 || !Number.isFinite(t) || eggerDF <= 0) {
      eggerEstimable = false;
    } else {
      pValue = 2 * (1 - tCDF(Math.abs(t), eggerDF));
      if (!Number.isFinite(pValue)) eggerEstimable = false;
    }
  }

  const lowPower = n < 10;
  const asymmetryDetected = eggerEstimable && !lowPower && pValue < 0.10;
  const asymmetryLabel = !eggerEstimable
    ? 'Not estimable'
    : lowPower
      ? 'Low power (k<10)'
      : (asymmetryDetected ? 'Yes' : 'No');

  // Build text funnel plot with dynamic axis bounds
  const width = 50;
  const height = 12;
  const xVals = studies.map(s => s.logRR);
  let minX = Math.min(...xVals);
  let maxX = Math.max(...xVals);
  if (!Number.isFinite(minX) || !Number.isFinite(maxX)) {
    minX = -0.8;
    maxX = 0.4;
  } else {
    const xRange = maxX - minX;
    const xPad = xRange > 0 ? xRange * 0.10 : 0.10;
    minX -= xPad;
    maxX += xPad;
  }

  const minY = 0;
  let maxY = Math.max(...studies.map(s => s.se));
  if (!Number.isFinite(maxY) || maxY <= 0) {
    maxY = 0.2;
  } else {
    maxY *= 1.10;
  }
  if (maxY <= minY) {
    maxY = minY + 0.2;
  }

  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const getXPos = (logRR) => {
    const pos = Math.round(((logRR - minX) / (maxX - minX)) * width);
    return clamp(pos, 0, width);
  };
  const getYPos = (se) => {
    const pos = Math.round((1 - (se - minY) / (maxY - minY)) * height);
    return clamp(pos, 0, height);
  };

  let grid = Array(height + 1).fill().map(() => Array(width + 1).fill(' '));

  // Add reference line
  const refPos = getXPos(pooledLogRR);
  for (let y = 0; y <= height; y++) {
    if (refPos >= 0 && refPos <= width) grid[y][refPos] = '|';
  }

  // Add studies
  studies.forEach((s, i) => {
    const x = getXPos(s.logRR);
    const y = getYPos(s.se);
    if (x >= 0 && x <= width && y >= 0 && y <= height) {
      grid[y][x] = String.fromCharCode(65 + i); // A, B, C, etc.
    }
  });

  let interpretation = '';
  if (!eggerEstimable) {
    interpretation = "Egger's test is not estimable for this dataset (need >=3 valid studies and variation in precision).";
  } else if (lowPower) {
    interpretation = `Egger's test has limited power with only ${n} studies. Treat the p-value as exploratory and rely on visual/clinical assessment.`;
  } else if (asymmetryDetected) {
    interpretation = 'Funnel asymmetry detected (Egger p < 0.10). This may reflect publication bias, small-study effects, or heterogeneity.';
  } else {
    interpretation = 'No statistical evidence of funnel asymmetry. This does not rule out publication bias.';
  }
  if (invalidRows > 0) {
    interpretation += ` Data quality note: excluded ${invalidRows} invalid row(s).`;
  }

  let funnelText = `
<strong>Funnel Plot</strong>

SE (precision)
${minY.toFixed(2)} +${'-'.repeat(width)}+
`;

  for (let y = 0; y <= height; y++) {
    const seVal = minY + (1 - y / height) * (maxY - minY);
    const label = y % 4 === 0 ? seVal.toFixed(2) : '    ';
    funnelText += `${label} |${grid[y].join('')}|\n`;
  }

  funnelText += `${maxY.toFixed(2)} +${'-'.repeat(width)}+
      ${minX.toFixed(1)}${' '.repeat(Math.round(width / 2) - 6)}0.0${' '.repeat(Math.round(width / 2) - 6)}${maxX.toFixed(1)}
                    log(RR)

<strong>Legend:</strong> ${studies.map((s, i) => `${String.fromCharCode(65 + i)}=${s.name}`).join(', ')}
Reference line at pooled log(RR) = ${pooledLogRR.toFixed(3)}

<strong>Egger's Test for Funnel Plot Asymmetry:</strong>
Intercept = ${eggerEstimable ? intercept.toFixed(3) : 'N/A'}
P-value = ${eggerEstimable ? pValue.toFixed(4) : 'N/A'}
Asymmetry signal (p < 0.10, k>=10): ${asymmetryLabel}

<strong>Interpretation:</strong>
${interpretation}

<strong>Caution:</strong> With ${n} studies, statistical tests for asymmetry can have limited power.
Visual inspection and comparison to trial registries are more informative.
  `;

  output.innerHTML = `<pre style="font-family: monospace; font-size: 0.75rem; overflow-x: auto;">${funnelText}</pre>`;

  awardPoints(30, 'Funnel plot generated');
  trackToolUse('funnel-plot');
}

function calculateGRADE() {
  const outcome = document.getElementById('grade-outcome').value;
  const design = document.getElementById('grade-design').value;
  const rob = parseInt(document.getElementById('grade-rob').value, 10) || 0;
  const incon = parseInt(document.getElementById('grade-incon').value, 10) || 0;
  const indir = parseInt(document.getElementById('grade-indir').value, 10) || 0;
  const imprec = parseInt(document.getElementById('grade-imprec').value, 10) || 0;
  const pub = parseInt(document.getElementById('grade-pub').value, 10) || 0;
  const upLarge = parseInt(document.getElementById('grade-up-large').value, 10) || 0;
  const upDose = document.getElementById('grade-up-dose').checked;
  const upConfound = document.getElementById('grade-up-confound').checked;

  let level = design === 'rct' ? 4 : 2; // RCTs start HIGH (4), observational starts LOW (2)
  const downgrades = [];
  const upgrades = [];

  const applyDowngrade = (label, points) => {
    if (points < 0) {
      level += points;
      downgrades.push(`${label} (${points})`);
    }
  };

  applyDowngrade('Risk of bias', rob);
  applyDowngrade('Inconsistency', incon);
  applyDowngrade('Indirectness', indir);
  applyDowngrade('Imprecision', imprec);
  applyDowngrade('Publication bias', pub);

  if (design === 'obs') {
    if (upLarge === 1) {
      level += 1;
      upgrades.push('Large effect (+1)');
    } else if (upLarge === 2) {
      level += 2;
      upgrades.push('Very large effect (+2)');
    }
    if (upDose) {
      level += 1;
      upgrades.push('Dose-response gradient (+1)');
    }
    if (upConfound) {
      level += 1;
      upgrades.push('All plausible confounders would reduce effect (+1)');
    }
  } else if (upLarge > 0 || upDose || upConfound) {
    upgrades.push('Rate-up criteria selected but not applied (RCT evidence starts HIGH)');
  }

  level = Math.max(1, Math.min(4, level));

  const levels = {
    4: { name: 'HIGH', symbol: '4/4', meaning: 'Very confident in the effect estimate' },
    3: { name: 'MODERATE', symbol: '3/4', meaning: 'Moderately confident; true effect likely close' },
    2: { name: 'LOW', symbol: '2/4', meaning: 'Limited confidence; true effect may differ substantially' },
    1: { name: 'VERY LOW', symbol: '1/4', meaning: 'Very little confidence; true effect likely very different' }
  };

  const result = levels[level];

  const output = document.getElementById('grade-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>GRADE Certainty Assessment</strong>

Outcome: ${outcome}
Starting level: ${design === 'rct' ? 'HIGH (RCTs)' : 'LOW (Observational)'}

<strong>Downgrades applied:</strong>
${downgrades.length > 0 ? downgrades.map(d => '- ' + d).join('\n') : '- None'}

<strong>Upgrades applied:</strong>
${upgrades.length > 0 ? upgrades.map(u => '- ' + u).join('\n') : '- None'}

----------------------------------------
FINAL CERTAINTY: ${result.symbol} ${result.name}
----------------------------------------

<strong>What this means:</strong>
${result.meaning}

<strong>For clinical practice:</strong>
${level === 4 ? 'Strong confidence in the estimate. Guidelines can make strong recommendations.' :
  level === 3 ? 'Moderate confidence. Recommendations possible but may change with future evidence.' :
  level === 2 ? 'Low confidence. Recommendations should be weak/conditional. More research needed.' :
  'Very low confidence. Any estimate is very uncertain. Decisions should consider patient values and context heavily.'}
  `;

  awardPoints(25, 'GRADE assessment completed');
  trackToolUse('grade-builder');
}

function calculatePRISMA() {
  const items = document.querySelectorAll('.prisma-item:checked').length;
  const total = document.querySelectorAll('.prisma-item').length;
  const pct = Math.round((items / total) * 100);

  const output = document.getElementById('prisma-checklist-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>PRISMA 2020 Essentials (15-item training subset)</strong>

Items completed: ${items}/${total}
Completeness (training subset): ${pct}%

${'‚ñà'.repeat(Math.round(pct/5))}${'‚ñë'.repeat(20 - Math.round(pct/5))} ${pct}%

<strong>Assessment:</strong>
${pct >= 90 ? 'Strong coverage of core PRISMA essentials in this training subset.' :
  pct >= 70 ? 'Good coverage with some missing essentials.' :
  pct >= 50 ? 'Moderate coverage. Several important essentials are missing.' :
  'Low coverage. Review PRISMA essentials before reporting results.'}

<strong>Critical items for reproducibility:</strong>
‚Ä¢ Full search strategy (at least one database)
‚Ä¢ PRISMA flow diagram
‚Ä¢ Risk of bias assessments
‚Ä¢ Effect measures and synthesis methods

Missing these items severely limits the ability of others to verify or replicate your review.

<strong>Important:</strong> This tool does not replace full PRISMA 2020 27-item reporting.
  `;

  awardPoints(20, 'PRISMA checklist evaluated');
  trackToolUse('prisma-checklist');
}

// ============================================================
// SCENARIOS
// ============================================================

function renderScenario(scenario) {
  const completed = gameState.scenariosCompleted[scenario.id];

  return `
    <div class="scenario-panel" id="scenario-${scenario.id}">
      <div class="scenario-header">
        <span class="scenario-icon">üîÄ</span>
        <span class="scenario-title">${scenario.title}</span>
      </div>
      <div class="scenario-situation">${scenario.situation}</div>
      <div class="scenario-question">${scenario.question}</div>
      <div class="scenario-choices">
        ${scenario.choices.map(c => `
          <div class="scenario-choice ${completed === c.id ? (c.id === scenario.correct ? 'correct' : 'incorrect') : ''} ${completed && c.id === scenario.correct ? 'correct' : ''}"
               onclick="${completed ? '' : `selectScenario('${scenario.id}', '${c.id}')`}"
               style="${completed ? 'pointer-events: none;' : ''}">
            <span class="choice-letter">${c.id.toUpperCase()}</span>
            <span>${c.text}</span>
          </div>
        `).join('')}
      </div>
      <div class="scenario-consequence ${completed ? 'visible' : ''} ${completed ? scenario.choices.find(c => c.id === completed)?.consequence : ''}" id="consequence-${scenario.id}">
        ${completed ? scenario.choices.find(c => c.id === completed)?.result : ''}
      </div>
    </div>
  `;
}

function selectScenario(scenarioId, choiceId) {
  // Find the scenario
  let scenario;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'scenario' && s.content.id === scenarioId) {
        scenario = s.content;
      }
    });
  });

  if (!scenario || gameState.scenariosCompleted[scenarioId]) return;

  gameState.scenariosCompleted[scenarioId] = choiceId;

  const choice = scenario.choices.find(c => c.id === choiceId);
  const isCorrect = choiceId === scenario.correct;

  // Update UI
  const choices = document.querySelectorAll(`#scenario-${scenarioId} .scenario-choice`);
  choices.forEach(el => {
    el.style.pointerEvents = 'none';
    const letter = el.querySelector('.choice-letter').textContent.toLowerCase();
    if (letter === scenario.correct) {
      el.classList.add('correct');
    } else if (letter === choiceId) {
      el.classList.add('incorrect');
    }
  });

  const consequence = document.getElementById(`consequence-${scenarioId}`);
  consequence.textContent = choice.result;
  consequence.className = `scenario-consequence visible ${choice.consequence}`;

  // Award points
  if (isCorrect) {
    awardPoints(30, 'Correct scenario decision');
  } else {
    awardPoints(10, 'Scenario attempted');
  }

  saveProgress();
}

// ============================================================
// DECISION TREES (Interactive Branching Narratives)
// ============================================================

function renderDecisionTree(tree) {
  const treeState = gameState.decisionTrees || {};
  const currentPath = treeState[tree.id] || { currentNode: 'start', history: [] };

  // Build path history display
  const pathHistory = currentPath.history.length > 0 ? `
    <div class="path-history" id="path-history-${tree.id}">
      <span class="path-step">Start</span>
      ${currentPath.history.map((step, i) => {
        const node = tree.nodes[step.node] || tree.nodes.find(n => n.id === step.node);
        const branchText = node && node.branches ?
          (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
          step.branch;
        return `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
      }).join('')}
    </div>
  ` : '';

  // Tree controls (undo and restart)
  const treeControls = currentPath.history.length > 0 ? `
    <div class="tree-controls" id="tree-controls-${tree.id}">
      <button class="undo-btn" onclick="undoDecisionBranch('${tree.id}')" aria-label="Undo last choice">
        ‚Ü∂ Undo Last Choice
      </button>
      <button class="restart-btn" onclick="resetDecisionTree('${tree.id}')" aria-label="Start over">
        ‚Ü©Ô∏è Start Over
      </button>
    </div>
  ` : '';

  return `
    <div class="decision-tree" id="tree-${tree.id}" role="region" aria-label="Decision scenario: ${tree.title}">
      <div class="scenario-header">
        <span class="scenario-icon" aria-hidden="true">üå≥</span>
        <span class="scenario-title">${tree.title}</span>
      </div>
      ${tree.realCase ? `
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(197,48,48,0.1); border-left: 3px solid var(--red); border-radius: 0 8px 8px 0;">
          <strong style="color: var(--red);">üìö Real Case:</strong>
          <span style="color: rgba(255,255,255,0.9);">${tree.realCase}</span>
        </div>
      ` : ''}
      <div class="scenario-situation" style="margin-bottom: 1rem;">${tree.scenario || tree.situation}</div>

      ${pathHistory}

      <div id="tree-nodes-${tree.id}">
        ${renderDecisionNode(tree, currentPath.currentNode, tree.id)}
      </div>

      ${treeControls}
    </div>
  `;
}

function renderDecisionNode(tree, nodeId, treeId) {
  // Handle both array-style and object-style node storage
  let node;
  if (Array.isArray(tree.nodes)) {
    node = tree.nodes.find(n => n.id === nodeId);
  } else {
    node = tree.nodes[nodeId];
  }

  if (!node) return '<p style="color: var(--red);">Node not found: ' + nodeId + '</p>';

  // Check if this is an ending node (has isEnding flag or type === 'outcome')
  const isEnding = node.isEnding || node.type === 'outcome';
  const outcome = node.outcome || node.consequence;

  if (isEnding) {
    return `
      <div class="decision-node ${outcome === 'good' ? 'completed' : outcome === 'bad' ? 'wrong' : 'active'}">
        <div class="decision-question" style="color: ${outcome === 'good' ? 'var(--green)' : outcome === 'bad' ? 'var(--red)' : 'var(--gold)'};">
          ${outcome === 'good' ? '‚úì Good Outcome' : outcome === 'bad' ? '‚úó Poor Outcome' : '‚óã Neutral Outcome'}
        </div>
        ${node.situation ? `<p style="color: rgba(255,255,255,0.9); line-height: 1.7; margin-bottom: 1rem;">${node.situation}</p>` : ''}
        ${node.text ? `<p style="color: rgba(255,255,255,0.9); line-height: 1.7; margin-bottom: 1rem;">${node.text}</p>` : ''}
        ${node.lesson ? `
          <div style="margin-top: 1rem; padding: 1rem; background: rgba(212,175,55,0.1); border-left: 3px solid var(--gold); border-radius: 0 8px 8px 0;">
            <strong style="color: var(--gold);">üí° Lesson:</strong>
            <p style="color: rgba(255,255,255,0.9); margin-top: 0.5rem; line-height: 1.6;">${node.lesson}</p>
          </div>
        ` : ''}
        ${node.realCase ? `
          <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
            <strong style="color: var(--gold);">üìö Real Case:</strong>
            <span style="color: rgba(255,255,255,0.8);">${node.realCase}</span>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Regular decision node with branches
  return `
    <div class="decision-node active" role="group" aria-label="Decision point">
      ${node.situation ? `<p style="color: rgba(255,255,255,0.85); margin-bottom: 1rem; line-height: 1.6;">${node.situation}</p>` : ''}
      <div class="decision-question">${node.question}</div>
      <div class="decision-branches" role="list">
        ${(node.branches || []).map((branch, idx) => `
          <button class="decision-branch" role="listitem"
                  onclick="selectDecisionBranch('${treeId}', '${nodeId}', '${branch.id}', '${branch.nextNode}')"
                  aria-label="Option ${idx + 1}: ${branch.text}">
            <span class="branch-arrow" aria-hidden="true">${String.fromCharCode(65 + idx)}</span>
            <span>${branch.text}</span>
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function selectDecisionBranch(treeId, currentNodeId, branchId, nextNodeId) {
  // Find the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (!tree) return;

  // Update state
  if (!gameState.decisionTrees) gameState.decisionTrees = {};
  if (!gameState.decisionTrees[treeId]) {
    gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  }

  const treeState = gameState.decisionTrees[treeId];
  treeState.history.push({ node: currentNodeId, branch: branchId });
  treeState.currentNode = nextNodeId;

  // Check if outcome (handle both array and object node storage)
  let nextNode;
  if (Array.isArray(tree.nodes)) {
    nextNode = tree.nodes.find(n => n.id === nextNodeId);
  } else {
    nextNode = tree.nodes[nextNodeId];
  }

  const isEnding = nextNode && (nextNode.isEnding || nextNode.type === 'outcome');
  const outcome = nextNode ? (nextNode.outcome || nextNode.consequence) : null;

  if (isEnding) {
    if (outcome === 'good') {
      awardPoints(40, 'Optimal decision path');
    } else if (outcome === 'neutral') {
      awardPoints(20, 'Acceptable decision path');
    } else {
      awardPoints(10, 'Decision tree completed');
    }
  }

  // Re-render the node area
  const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
  if (nodesContainer) {
    nodesContainer.innerHTML = renderDecisionNode(tree, nextNodeId, treeId);
  }

  // Update or add path history
  const treeContainer = document.getElementById(`tree-${treeId}`);
  let pathHistory = document.getElementById(`path-history-${treeId}`);

  if (!pathHistory && treeContainer) {
    pathHistory = document.createElement('div');
    pathHistory.className = 'path-history';
    pathHistory.id = `path-history-${treeId}`;
    const scenarioSituation = treeContainer.querySelector('.scenario-situation');
    if (scenarioSituation) {
      scenarioSituation.after(pathHistory);
    }
  }

  if (pathHistory) {
    let pathHtml = '<span class="path-step">Start</span>';
    treeState.history.forEach(step => {
      let node;
      if (Array.isArray(tree.nodes)) {
        node = tree.nodes.find(n => n.id === step.node);
      } else {
        node = tree.nodes[step.node];
      }
      const branchText = node && node.branches ?
        (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
        step.branch;
      pathHtml += `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
    });
    pathHistory.innerHTML = pathHtml;
  }

  // Update or add tree controls
  let treeControls = document.getElementById(`tree-controls-${treeId}`);
  if (!treeControls && treeContainer) {
    treeControls = document.createElement('div');
    treeControls.className = 'tree-controls';
    treeControls.id = `tree-controls-${treeId}`;
    treeControls.innerHTML = `
      <button class="undo-btn" onclick="undoDecisionBranch('${treeId}')" aria-label="Undo last choice">
        ‚Ü∂ Undo Last Choice
      </button>
      <button class="restart-btn" onclick="resetDecisionTree('${treeId}')" aria-label="Start over">
        ‚Ü©Ô∏è Start Over
      </button>
    `;
    treeContainer.appendChild(treeControls);
  }

  saveProgress();
}

function resetDecisionTree(treeId) {
  if (gameState.decisionTrees && gameState.decisionTrees[treeId]) {
    gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  }

  // Find and re-render the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (tree) {
    const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
    if (nodesContainer) {
      nodesContainer.innerHTML = renderDecisionNode(tree, 'start', treeId);
    }

    // Remove path history
    const pathHistory = document.getElementById(`path-history-${treeId}`);
    if (pathHistory) pathHistory.remove();

    // Remove tree controls
    const treeControls = document.getElementById(`tree-controls-${treeId}`);
    if (treeControls) treeControls.remove();

    // Remove any standalone restart button
    const restartBtn = document.querySelector(`#tree-${treeId} .restart-btn`);
    if (restartBtn) restartBtn.remove();
  }

  saveProgress();
}

function undoDecisionBranch(treeId) {
  if (!gameState.decisionTrees || !gameState.decisionTrees[treeId]) return;

  const treeState = gameState.decisionTrees[treeId];
  if (treeState.history.length === 0) return;

  // Pop the last decision
  const lastStep = treeState.history.pop();
  treeState.currentNode = lastStep.node;

  // Find and re-render the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (tree) {
    const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
    if (nodesContainer) {
      nodesContainer.innerHTML = renderDecisionNode(tree, treeState.currentNode, treeId);
    }

    // Update path history
    const pathHistory = document.getElementById(`path-history-${treeId}`);
    if (pathHistory) {
      if (treeState.history.length === 0) {
        pathHistory.remove();
        // Also remove tree controls
        const treeControls = document.getElementById(`tree-controls-${treeId}`);
        if (treeControls) treeControls.remove();
      } else {
        // Rebuild path history
        let pathHtml = '<span class="path-step">Start</span>';
        treeState.history.forEach(step => {
          let node;
          if (Array.isArray(tree.nodes)) {
            node = tree.nodes.find(n => n.id === step.node);
          } else {
            node = tree.nodes[step.node];
          }
          const branchText = node && node.branches ?
            (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
            step.branch;
          pathHtml += `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
        });
        pathHistory.innerHTML = pathHtml;
      }
    }
  }

  saveProgress();
}

// ============================================================
// QUIZZES
// ============================================================

function renderQuiz(quiz, slideIdx) {
  const quizId = `quiz-${currentModule}-${slideIdx}`;

  return `
    <div class="quiz-container" id="${quizId}" role="group" aria-labelledby="${quizId}-question">
      <div class="quiz-question" id="${quizId}-question">${quiz.question}</div>
      <div class="quiz-options" role="radiogroup" aria-label="Answer choices">
        ${quiz.options.map((opt, idx) => `
          <button class="quiz-option" role="radio" aria-checked="false"
                  onclick="selectQuizOption('${quizId}', '${opt.id}', ${opt.correct})"
                  data-option-id="${opt.id}">
            <span class="option-letter" aria-hidden="true">${String.fromCharCode(65 + idx)}.</span>
            ${opt.text}
          </button>
        `).join('')}
      </div>
      <div class="quiz-feedback" id="${quizId}-feedback" role="alert" aria-live="polite" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>
    </div>
  `;
}

function selectQuizOption(quizId, optionId, isCorrect) {
  const container = document.getElementById(quizId);
  const options = container.querySelectorAll('.quiz-option');
  const feedback = document.getElementById(`${quizId}-feedback`);

  // Track the quiz answer
  gameState.quizAnswers[quizId] = {
    selected: optionId,
    correct: isCorrect,
    timestamp: Date.now()
  };

  // Disable all options and update ARIA
  options.forEach(opt => {
    opt.disabled = true;
    opt.setAttribute('aria-disabled', 'true');
  });

  // Find the quiz data
  let module = modules[currentModule];
  let quiz;
  module.slides.forEach(s => {
    if (s.type === 'quiz') quiz = s.content;
  });

  if (quiz) {
    // Mark options using data-option-id attribute matching
    options.forEach((opt, index) => {
      const thisOptData = quiz.options[index];
      const thisOptId = opt.getAttribute('data-option-id') || ['a', 'b', 'c', 'd'][index];

      if (thisOptId === optionId) {
        // This is the selected option
        opt.classList.add(isCorrect ? 'correct' : 'incorrect');
        opt.setAttribute('aria-checked', 'true');
      }

      // Always show the correct answer
      if (thisOptData && thisOptData.correct) {
        opt.classList.add('correct');
      }
    });

    feedback.innerHTML = `
      <strong>${isCorrect ? '‚úì Correct!' : '‚úó Not quite.'}</strong><br><br>
      ${quiz.explanation}
    `;
    feedback.style.display = 'block';
    feedback.style.background = isCorrect ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.1)';
    feedback.style.border = `1px solid ${isCorrect ? 'var(--green)' : 'var(--red)'}`;
  }

  if (isCorrect) {
    awardPoints(20, 'Quiz correct');
  }

  checkBadges();
  saveProgress();
}

// ============================================================
// NAVIGATION
// ============================================================

function goToModule(moduleId) {
  currentModule = moduleId;
  currentSlide = 0;
  renderSlides();
  updateModuleList();
  updateSlideNav();
  document.getElementById('moduleIndicator').textContent = `Module ${moduleId}: ${modules[moduleId].title}`;
}

function goToNextModule() {
  if (currentModule < modules.length - 1) {
    markModuleComplete(currentModule);
    goToModule(currentModule + 1);
  }
}

function nextSlide() {
  const module = modules[currentModule];
  if (currentSlide < module.slides.length - 1) {
    currentSlide++;
    updateSlideDisplay();
  } else if (currentModule < modules.length - 1) {
    markModuleComplete(currentModule);
    goToModule(currentModule + 1);
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideDisplay();
  } else if (currentModule > 0) {
    goToModule(currentModule - 1);
    currentSlide = modules[currentModule].slides.length - 1;
    updateSlideDisplay();
  }
}

function updateSlideDisplay() {
  const slides = document.querySelectorAll('.slide');
  slides.forEach((s, i) => {
    s.classList.toggle('active', i === currentSlide);
  });
  updateSlideNav();
}

function updateSlideNav() {
  const module = modules[currentModule];
  document.getElementById('slideCounter').textContent = `${currentSlide + 1} / ${module.slides.length}`;
  document.getElementById('prevBtn').disabled = currentModule === 0 && currentSlide === 0;
  document.getElementById('nextBtn').textContent =
    currentSlide === module.slides.length - 1 && currentModule < modules.length - 1 ? 'Next Module ‚Üí' : 'Next ‚Üí';
}

function updateModuleList() {
  document.querySelectorAll('.module-item').forEach(el => {
    const isActive = parseInt(el.dataset.module) === currentModule;
    el.classList.toggle('active', isActive);
    if (isActive) {
      el.setAttribute('aria-current', 'true');
    } else {
      el.removeAttribute('aria-current');
    }
  });
}

// ============================================================
// GAMIFICATION
// ============================================================

function awardPoints(points, reason) {
  const oldPoints = gameState.points;
  gameState.points += points;
  updateSidebarPoints();
  showToast(`+${points} pts`, reason);
  checkLevelUp(oldPoints, gameState.points);
  checkBadges();
  saveProgress();
}

function trackToolUse(toolId) {
  if (!gameState.toolsUsed.includes(toolId)) {
    gameState.toolsUsed.push(toolId);
    checkBadges();
  }
  saveProgress();
}

function markModuleComplete(moduleId) {
  if (!gameState.modulesCompleted.includes(moduleId)) {
    gameState.modulesCompleted.push(moduleId);
    awardPoints(100, 'Module completed');
    renderModuleList();
    checkBadges();
    checkCourseCompletion();
  }
  saveProgress();
  updateProgress();
}

function updateSidebarPoints() {
  document.getElementById('sidebarPoints').textContent = gameState.points + ' pts';
}

function updateProgress() {
  const pct = Math.round((gameState.modulesCompleted.length / modules.length) * 100);
  document.getElementById('progressPercent').textContent = pct + '%';
  document.getElementById('progressFill').style.width = pct + '%';
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(title, message, type = 'points') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}-toast`;
  toast.innerHTML = `<span>${title}</span><span style="opacity:0.8;font-weight:400;"> ${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ============================================================
// NOTIFICATION MODAL
// ============================================================

function showNotification(title, message) {
  document.getElementById('notificationTitle').textContent = title;
  document.getElementById('notificationMessage').textContent = message;
  document.getElementById('notificationModal').classList.add('active');
}

function closeNotification() {
  document.getElementById('notificationModal').classList.remove('active');
}

// ============================================================
// BADGE SYSTEM
// ============================================================

function checkBadges() {
  let newBadgesEarned = false;
  badges.forEach(badge => {
    if (!gameState.earnedBadges.includes(badge.id) && badge.condition()) {
      gameState.earnedBadges.push(badge.id);
      showToast(`${badge.icon} ${badge.name}`, 'Badge earned!', 'badge');
      newBadgesEarned = true;
    }
  });
  if (newBadgesEarned) {
    saveProgress();
  }
}

function renderBadges() {
  const grid = document.getElementById('badgeGrid');
  grid.innerHTML = badges.map(badge => {
    const earned = gameState.earnedBadges.includes(badge.id);
    return `
      <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
        <span>${badge.icon}</span> ${badge.name}
      </div>
    `;
  }).join('');
}

// ============================================================
// LEVEL SYSTEM
// ============================================================

function getCurrentLevel() {
  let currentLevel = levels[0];
  for (const level of levels) {
    if (gameState.points >= level.minPoints) {
      currentLevel = level;
    }
  }
  return currentLevel;
}

function checkLevelUp(oldPoints, newPoints) {
  const oldLevel = levels.filter(l => oldPoints >= l.minPoints).pop();
  const newLevel = levels.filter(l => newPoints >= l.minPoints).pop();
  if (newLevel && oldLevel && newLevel.name !== oldLevel.name) {
    showToast(`‚¨ÜÔ∏è Level Up!`, `You are now ${newLevel.name}`, 'level');
    updateLevelBadge();
  }
}

function updateLevelBadge() {
  const level = getCurrentLevel();
  document.getElementById('levelBadge').textContent = `Level: ${level.name}`;
}

// ============================================================
// DASHBOARD
// ============================================================

function openDashboard() {
  document.getElementById('totalPoints').textContent = gameState.points;
  document.getElementById('modulesCompleted').textContent = `${gameState.modulesCompleted.length}/${modules.length}`;
  document.getElementById('toolsUsed').textContent = gameState.toolsUsed.length;
  updateLevelBadge();
  renderBadges();
  const dashboard = document.getElementById('progressDashboard');
  dashboard.classList.add('open');
  // Focus trap
  const closeBtn = dashboard.querySelector('.close-btn');
  if (closeBtn) closeBtn.focus();
}

function closeDashboard() {
  document.getElementById('progressDashboard').classList.remove('open');
}

function startDailyReview() {
  // Simple spaced repetition - show random quiz from completed modules
  if (gameState.modulesCompleted.length < 2) {
    showNotification('Daily Review Locked', 'Complete at least 2 modules to unlock Daily Review!');
    return;
  }
  const completedWithQuiz = gameState.modulesCompleted.filter(id => {
    return modules[id] && modules[id].slides.some(s => s.type === 'quiz');
  });
  if (completedWithQuiz.length === 0) {
    showNotification('No Quizzes Yet', 'No quizzes available for review yet. Keep learning!');
    return;
  }
  const randomModuleId = completedWithQuiz[Math.floor(Math.random() * completedWithQuiz.length)];
  goToModule(randomModuleId);
  // Navigate to quiz slide
  const quizIndex = modules[randomModuleId].slides.findIndex(s => s.type === 'quiz');
  if (quizIndex >= 0) {
    currentSlide = quizIndex;
    renderSlides();
  }
}

// ============================================================
// SIDEBAR TOGGLE (Mobile)
// ============================================================

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const hamburger = document.querySelector('.hamburger');
  const overlay = document.querySelector('.sidebar-overlay');

  sidebar.classList.toggle('open');
  hamburger.classList.toggle('active');
  overlay.classList.toggle('active');

  const isOpen = sidebar.classList.contains('open');
  hamburger.setAttribute('aria-expanded', isOpen);
}

// ============================================================
// TOOL LIBRARY
// ============================================================

const toolLibraryItems = [
  { id: 'pico-builder', name: 'PICO Builder', description: 'Structure your research question with Population, Intervention, Comparator, Outcome', module: 1 },
  { id: 'search-builder', name: 'Search Strategy Builder', description: 'Create database search strings with Boolean operators', module: 3 },
  { id: 'prisma-flow', name: 'PRISMA Flow Generator', description: 'Create PRISMA 2020 flow diagrams for your review', module: 4 },
  { id: 'extraction-form', name: 'Data Extraction Form', description: 'Standardized forms for extracting study data', module: 5 },
  { id: 'rob2-tool', name: 'RoB 2 Assessment', description: 'Evaluate risk of bias using Cochrane RoB 2 tool', module: 6 },
  { id: 'effect-calculator', name: 'Effect Size Calculator', description: 'Calculate RR, OR, SMD, and other effect sizes', module: 7 },
  { id: 'forest-plot', name: 'Forest Plot Builder', description: 'Interactive forest plots with fixed/random effects', module: 8 },
  { id: 'heterogeneity-explorer', name: 'Heterogeneity Explorer', description: 'Visualize I¬≤, œÑ¬≤, and prediction intervals', module: 9 },
  { id: 'funnel-plot', name: 'Funnel Plot Builder', description: 'Funnel plots with Egger\'s test for publication bias', module: 10 },
  { id: 'grade-builder', name: 'GRADE Assessment', description: 'Build Summary of Findings tables with GRADE ratings', module: 11 },
  { id: 'prisma-checklist', name: 'PRISMA Checklist', description: 'Complete PRISMA 2020 reporting checklist', module: 12 }
];

function openToolLibrary() {
  const modal = document.getElementById('toolLibraryModal');
  const grid = document.getElementById('toolLibraryGrid');

  grid.innerHTML = toolLibraryItems.map(tool => `
    <div class="tool-library-item" onclick="goToTool('${tool.id}', ${tool.module})" role="button" tabindex="0" aria-label="Open ${tool.name}">
      <h4>${tool.name}</h4>
      <p>${tool.description}</p>
      <small style="color: var(--gold); margin-top: 0.5rem; display: block;">Module ${tool.module}</small>
    </div>
  `).join('');

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';

  // Focus trap
  modal.querySelector('.close-btn').focus();
}

function closeToolLibrary() {
  const modal = document.getElementById('toolLibraryModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function goToTool(toolId, moduleId) {
  closeToolLibrary();
  goToModule(moduleId);
  // Find the tool slide
  const toolIndex = modules[moduleId].slides.findIndex(s => s.type === 'tool' && s.content.id === toolId);
  if (toolIndex >= 0) {
    currentSlide = toolIndex;
    renderSlides();
  }
}

// ============================================================
// GLOSSARY
// ============================================================

const glossaryTerms = {
  'I¬≤': 'Percentage of variability in effect estimates due to heterogeneity rather than sampling error. 0% = no heterogeneity, 75%+ = high heterogeneity.',
  'œÑ¬≤ (tau-squared)': 'Between-study variance in random effects meta-analysis. Measures absolute heterogeneity in same units as effect size squared.',
  'Prediction Interval': 'Range where 95% of true effects in future studies would fall. Unlike CI (average effect), PI shows variability across settings.',
  'Risk Ratio (RR)': 'Ratio of risk in treatment vs control: RR = (a/n‚ÇÅ) / (c/n‚ÇÇ). RR < 1 indicates treatment reduces risk.',
  'Odds Ratio (OR)': 'Ratio of odds: OR = (a√ód) / (b√óc). Used when outcome is common or for case-control studies.',
  'SMD': 'Standardized Mean Difference (Cohen\'s d). Effect size for continuous outcomes on different scales: SMD = (M‚ÇÅ-M‚ÇÇ) / SD_pooled.',
  'PICO': 'Population, Intervention, Comparator, Outcome. Framework for structuring systematic review questions.',
  'RoB 2': 'Cochrane Risk of Bias 2 tool. Assesses bias across 5 domains: randomization, deviations, missing data, measurement, selection.',
  'GRADE': 'Grading of Recommendations, Assessment, Development and Evaluations. Framework for rating certainty in evidence.',
  'Egger\'s Test': 'Statistical test for funnel plot asymmetry. Significant p-value (<0.1) suggests possible publication bias.',
  'Publication Bias': 'Tendency for positive/significant results to be published more than negative/null results, distorting evidence synthesis.',
  'Fixed Effect': 'Model assuming one true effect size. All variability is sampling error. Weights by inverse variance only.',
  'Random Effects': 'Model assuming distribution of true effects. Adds between-study variance (œÑ¬≤) to weights. More conservative CIs.',
  'NNT': 'Number Needed to Treat. Number of patients to treat for one additional good outcome: NNT = 1/ARR.',
  'Forest Plot': 'Graphical display of meta-analysis results showing individual study effects, CIs, weights, and pooled estimate.'
};

function openGlossary() {
  const terms = Object.entries(glossaryTerms).map(([term, def]) =>
    `<div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
      <strong style="color: var(--gold);">${term}</strong>
      <p style="margin-top: 0.5rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">${def}</p>
    </div>`
  ).join('');

  const modal = document.createElement('div');
  modal.className = 'tool-library-modal active';
  modal.id = 'glossaryModal';
  modal.innerHTML = `
    <div class="tool-library-content" style="max-height: 80vh; overflow-y: auto;">
      <div class="tool-library-header">
        <h2>üìñ Glossary of Terms</h2>
        <button class="close-btn" onclick="this.closest('.tool-library-modal').remove(); document.body.style.overflow='';">&times;</button>
      </div>
      <div>${terms}</div>
    </div>
  `;
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

// ============================================================
// CERTIFICATE
// ============================================================

function checkCourseCompletion() {
  // Check if all modules are completed
  if (gameState.modulesCompleted.length >= modules.length - 1) { // -1 for module 0
    showCertificate();
  }
}

function showCertificate() {
  const modal = document.getElementById('certificateModal');
  const dateEl = document.getElementById('certificateDate');
  const nameEl = document.getElementById('certificateName');

  // Get stored name or prompt
  let userName = localStorage.getItem('metaMethodsUserName');
  if (!userName) {
    userName = prompt('Congratulations on completing the course! Enter your name for the certificate:') || 'Course Participant';
    localStorage.setItem('metaMethodsUserName', userName);
  }

  nameEl.textContent = userName;
  dateEl.textContent = `Completed on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}`;

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeCertificate() {
  const modal = document.getElementById('certificateModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function downloadCertificate() {
  // Create printable version
  const cert = document.querySelector('.certificate');
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
    <head>
      <title>Meta-Analysis Methods Course Certificate</title>
      <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
      <style>
        body { font-family: 'Source Sans Pro', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f5f5f5; }
        .certificate { background: linear-gradient(135deg, #FAF8F5, #F5F0E8); border: 8px solid #D4AF37; border-radius: 8px; padding: 3rem; max-width: 700px; text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .certificate::before { content: ''; position: absolute; inset: 8px; border: 2px solid #D4AF37; border-radius: 4px; pointer-events: none; }
        .certificate-title { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 2.5rem; color: #1E2761; margin-bottom: 0.5rem; }
        .certificate-subtitle { color: #718096; margin-bottom: 2rem; }
        .certificate-name { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 2rem; color: #1E2761; margin: 1.5rem 0; padding: 0.5rem; border-bottom: 2px solid #D4AF37; display: inline-block; }
        .certificate-body { color: #2D3748; line-height: 1.6; margin-bottom: 1rem; }
        .certificate-date { color: #718096; margin-top: 2rem; }
        @media print { body { background: white; } .certificate { box-shadow: none; } }
      </style>
    </head>
    <body>
      ${cert.outerHTML.replace(/<div class="certificate-actions">[\s\S]*?<\/div>/, '')}
      ${'<'}script>window.onload = function() { window.print(); }${'<'}/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}

// ============================================================
// PERSISTENCE
// ============================================================

function saveProgress() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      currentModule,
      currentSlide,
      gameState
    }));
  } catch (e) {
    console.log('Could not save progress');
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      // Restore game state with schema validation
      if (data.gameState) {
        gameState = {
          points: data.gameState.points || 0,
          earnedBadges: data.gameState.earnedBadges || [],
          toolsUsed: data.gameState.toolsUsed || [],
          modulesCompleted: data.gameState.modulesCompleted || [],
          scenariosCompleted: data.gameState.scenariosCompleted || {},
          decisionTrees: data.gameState.decisionTrees || {},
          quizAnswers: data.gameState.quizAnswers || {}
        };
      }
      // Restore position with bounds checking
      if (typeof data.currentModule === 'number' && data.currentModule >= 0 && data.currentModule < modules.length) {
        currentModule = data.currentModule;
      }
      if (typeof data.currentSlide === 'number' && data.currentSlide >= 0) {
        currentSlide = Math.min(data.currentSlide, modules[currentModule].slides.length - 1);
      }
      updateSidebarPoints();
      updateProgress();
    }
  } catch (e) {
    console.log('Could not load progress:', e);
  }
}

// ============================================================
// KEYBOARD NAVIGATION
// ============================================================

document.addEventListener('keydown', (e) => {
  // Handle Escape key to close modals
  if (e.key === 'Escape') {
    if (document.getElementById('progressDashboard').classList.contains('open')) {
      closeDashboard();
    }
    if (document.getElementById('notificationModal').classList.contains('active')) {
      closeNotification();
    }
    if (document.getElementById('toolLibraryModal').classList.contains('active')) {
      closeToolLibrary();
    }
    if (document.getElementById('certificateModal').classList.contains('active')) {
      closeCertificate();
    }
    return;
  }

  // Handle Enter/Space on module items
  if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('module-item')) {
    e.preventDefault();
    const moduleId = parseInt(e.target.dataset.module);
    if (!isNaN(moduleId)) {
      goToModule(moduleId);
    }
    return;
  }

  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

  if (e.key === 'ArrowRight') {
    nextSlide();
  } else if (e.key === 'ArrowLeft') {
    prevSlide();
  }
});
</script>
</body>
</html>
