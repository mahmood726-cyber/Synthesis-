<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Umbrella Reviews: The Review of Reviews</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .xp-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      to { left: 100%; }
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .course-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      min-width: 44px;
      min-height: 44px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active {
      background: rgba(249,115,22,0.2);
      border-color: var(--orange);
      animation: flamePulse 1.5s ease-in-out infinite;
    }
    @keyframes flamePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; touch-action: pan-x pan-y; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }
    .slide.gold-bg { background: linear-gradient(135deg, #92702a 0%, #5c4520 100%); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: #4CAF50; }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--gold); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-left-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .decision-option:hover {
      background: rgba(124,58,237,0.2);
      border-color: var(--purple);
      transform: translateX(4px);
    }
    .decision-option:active {
      transform: scale(0.98);
    }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: 'o'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    @keyframes badgeBounce {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    .badge-modal.show .badge-modal-icon {
      animation: badgeBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .confetti { display: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:active { transform: scale(0.95); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; max-width: 280px; }
    .progress-dot {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      padding: 0;
      appearance: none;
      position: relative;
    }
    .progress-dot::after {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .progress-dot.active::after { width: 14px; height: 14px; background: var(--gold); transform: translate(-50%, -50%); }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-left: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }

    /* Course Completion Overlay */
    .completion-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
    .completion-overlay.show { display: flex; }
    .completion-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 450px;
      width: 90%;
    }
    .completion-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--gold); }
    .completion-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .completion-subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
    }
    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .completion-stat {
      text-align: center;
    }
    .completion-stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .completion-stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }
    .completion-actions { display: flex; gap: 0.75rem; justify-content: center; }

    /* Level Up Modal */
    .level-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1003;
    }
    .level-modal.show { display: flex; }
    .level-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 380px;
      width: 90%;
      animation: levelModalPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes levelModalPop {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .level-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: levelIconPulse 1s ease-in-out infinite;
    }
    @keyframes levelIconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    .level-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .level-modal-level {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3rem;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 0.25rem;
    }
    .level-modal-name {
      font-size: 1.2rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 1024px) and (min-width: 769px) {
      .sidebar { width: 280px; }
    }

    /* Small mobile improvements */
    @media (max-width: 480px) {
      .decision-option {
        padding: 1rem 1.25rem;
        font-size: 0.95rem;
      }
    }

    /* Landscape orientation handling */
    @media (orientation: landscape) and (max-height: 500px) {
      .slide-content { padding: 1rem; }
      .slide .title { font-size: 1.5rem; }
      .slide-nav { padding: 0.5rem; }
    }

    /* Safe area insets for notched devices */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .sidebar {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
      .slide-nav {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="course-container">
    <!-- Sidebar -->
    <nav class="sidebar" role="navigation" aria-label="Course navigation">
      <div class="sidebar-header">
        <a href="index.html" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='rgba(212,175,55,0.7)'">&larr; Course Library</a>
        <h1>Umbrella Reviews</h1>
        <p>The Review of Reviews</p>
      </div>

      <div class="stats-panel">
        <div class="level-display">
          <div class="level-badge" id="levelIcon">RR</div>
          <div class="level-info">
            <div class="level-title" id="levelTitle">Review Reader</div>
            <div class="level-subtitle">Level <span id="levelNum">1</span></div>
          </div>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
        <div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
        <div class="quick-stats">
          <div class="quick-stat">
            <div class="quick-stat-value" id="correctCount">0</div>
            <div class="quick-stat-label">Correct</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="decisionCount">0</div>
            <div class="quick-stat-label">Decisions</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="synthesisCount">0</div>
            <div class="quick-stat-label">Reviews</div>
          </div>
        </div>
      </div>

      <div class="course-progress">
        <div class="course-progress-label">
          <span>Course Progress</span>
          <span id="courseProgressPct">0%</span>
        </div>
        <div class="course-progress-bar">
          <div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="module-list" id="moduleList" role="list"></div>

      <div class="badges-panel">
        <div class="badges-title">Achievements</div>
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
      <header class="content-header">
        <div class="breadcrumb">Umbrella Reviews / <span id="currentModule">Module 1</span></div>
        <div class="header-actions">
          <div class="streak-display" id="streakDisplay">
            <span class="streak-flame" aria-hidden="true">&#x1F525;</span>
            <span class="streak-count" id="streakCount">0</span>
            <span>day streak</span>
          </div>
          <button class="btn" onclick="resetProgress()">Reset</button>
        </div>
      </header>

      <div class="content-body">
        <div class="slides-container" id="slidesContainer"></div>
      </div>
    </main>
  </div>

  <!-- XP Popup -->
  <div class="xp-popup" id="xpPopup" role="status" aria-live="polite" aria-atomic="true">
    <span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>

  <!-- Badge Modal -->
  <div class="badge-modal" id="badgeModal" role="dialog" aria-modal="true" aria-labelledby="badgeModalTitle">
    <div class="badge-modal-content">
      <div class="badge-modal-icon" id="badgeModalIcon">AW</div>
      <div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
      <div class="badge-modal-desc" id="badgeModalDesc">You unlocked a new achievement</div>
      <button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- Combo Counter -->
  <div class="combo-display" id="comboDisplay" role="status" aria-live="polite">COMBO <span id="comboCount">0</span>x</div>

  <!-- Course Completion Overlay -->
  <div class="completion-overlay" id="completionOverlay">
    <div class="completion-content">
      <div class="completion-icon">&#x1F3C6;</div>
      <div class="completion-title">Course Complete!</div>
      <div class="completion-subtitle">You have mastered umbrella reviews.</div>
      <div class="completion-stats">
        <div class="completion-stat">
          <div class="completion-stat-value" id="completionXP">0</div>
          <div class="completion-stat-label">Total XP</div>
        </div>
        <div class="completion-stat">
          <div class="completion-stat-value" id="completionBadges">0</div>
          <div class="completion-stat-label">Badges Earned</div>
        </div>
        <div class="completion-stat">
          <div class="completion-stat-value" id="completionLevel">1</div>
          <div class="completion-stat-label">Final Level</div>
        </div>
      </div>
      <div class="completion-actions">
        <button class="btn primary" onclick="downloadCertificate()">Download Certificate</button>
        <button class="btn" onclick="reviewBadges()">Review Badges</button>
        <button class="btn" onclick="closeCompletion()">Close</button>
      </div>
    </div>
  </div>

  <!-- Level Up Modal -->
  <div class="level-modal" id="levelModal" role="dialog" aria-modal="true" aria-labelledby="levelModalTitle" aria-hidden="true">
    <div class="level-modal-content">
      <div class="level-modal-icon">&#x1F396;&#xFE0F;</div>
      <div class="level-modal-title" id="levelModalTitle">Level Up!</div>
      <div class="level-modal-level" id="levelModalLevel">Level 2</div>
      <div class="level-modal-name" id="levelModalName">Search Scout</div>
      <button class="btn primary" onclick="closeLevelModal()">Continue</button>
    </div>
  </div>

  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu" aria-expanded="false">MENU</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {},
  consecutiveCorrect: 0,
  courseCompleted: false
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

// Migration from old storage key to versioned key
(function migrateStorage() {
  try {
    const oldData = localStorage.getItem('umbrellaReviewGame');
    if (oldData && !localStorage.getItem('umbrellaReviewGame_v1')) {
      localStorage.setItem('umbrellaReviewGame_v1', oldData);
      localStorage.removeItem('umbrellaReviewGame');
    }
  } catch (e) {}
})();

let gameState = safeGetStorage('umbrellaReviewGame_v1', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Review Reader", icon: "RR", xp: 0 },
  { level: 2, title: "Search Scout", icon: "SS", xp: 120 },
  { level: 3, title: "Quality Assessor", icon: "QA", xp: 300 },
  { level: 4, title: "Overlap Analyst", icon: "OA", xp: 520 },
  { level: 5, title: "Evidence Synthesizer", icon: "ES", xp: 780 },
  { level: 6, title: "Gap Mapper", icon: "GM", xp: 1050 },
  { level: 7, title: "Reporting Expert", icon: "RE", xp: 1350 },
  { level: 8, title: "Umbrella Master", icon: "UM", xp: 1700 }
];

const BADGES = [
  { id: "canopy_explorer", icon: "\u{1F333}", name: "Canopy Explorer", desc: "Complete Module 1: The Canopy" },
  { id: "first_scenario", icon: "\u{1F3AF}", name: "First Scenario", desc: "Complete your first decision scenario" },
  { id: "harvest_expert", icon: "\u{1F33E}", name: "Harvest Expert", desc: "Complete The Harvest module" },
  { id: "quality_judge", icon: "\u{1F50D}", name: "Quality Judge", desc: "Complete The Lens module" },
  { id: "overlap_detective", icon: "\u{1F50E}", name: "Overlap Detective", desc: "Complete The Overlap module" },
  { id: "evidence_weaver", icon: "\u{1F9F5}", name: "Evidence Weaver", desc: "Complete The Synthesis module" },
  { id: "gap_finder", icon: "\u{1F5FA}", name: "Gap Finder", desc: "Complete The Map module" },
  { id: "report_champion", icon: "\u{1F4DC}", name: "Report Champion", desc: "Complete The Report module" },
  { id: "perfect_5", icon: "\u{2B50}", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "\u{1F9E0}", name: "Decision Maker", desc: "Complete all 21 decision scenarios" },
  { id: "finisher", icon: "\u{1F3C6}", name: "Course Complete", desc: "Finish the entire course" },
  { id: "streak_3", icon: "\u{1F525}", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "\u{1F4AA}", name: "Weekly Warrior", desc: "Maintain a 7-day streak" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "The Canopy", subtitle: "Why one review is not enough", xp: 160,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "Umbrella Reviews", subtitle: "When one systematic review is not enough" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Explain why multiple systematic reviews on the same topic create confusion",
          "Define an umbrella review and how it differs from a standard systematic review",
          "Identify when an umbrella review is the right design choice",
          "Recognize the core steps in an umbrella review workflow"
        ],
        tip: "An umbrella review does not pool primary studies. It pools the conclusions of systematic reviews."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE FLOOD", title: "When five reviews gave five answers",
        text: "A guideline panel found five systematic reviews on the same intervention. Three said it worked, one was uncertain, and one warned of harm. Each used different search dates, inclusion criteria, and quality tools. The panel could not decide which to trust.",
        followup: "An umbrella review exists precisely for this moment: to stand above the individual reviews and assess the whole landscape."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE PAIR", title: "Two teams, two strategies",
        text: "Team A conducted a sixth systematic review on the same topic, adding to the noise. Team B conducted an umbrella review: they mapped all existing reviews, assessed their quality, checked for overlap, and synthesized conclusions across them.",
        followup: "Team B produced a single document that explained why the reviews disagreed and which conclusions were trustworthy.",
        warning: true
      }},
      { type: "stats", theme: "dark", content: {
        title: "The Evidence Landscape",
        stats: [
          { value: "8000+", label: "Systematic reviews published yearly" },
          { value: "multiple", label: "Reviews per clinical question" },
          { value: "30-50%", label: "Overlap in primary studies across SRs" },
          { value: "growing", label: "Need for evidence synthesis at scale" }
        ],
        caption: "Approximate figures from bibliometric studies."
      }},
      { type: "concept", theme: "dark", content: {
        title: "What an Umbrella Review Is",
        subtitle: "A systematic review of systematic reviews",
        text: "An umbrella review (also called overview of reviews or meta-review) systematically identifies, appraises, and synthesizes findings from multiple systematic reviews on a related topic. The unit of analysis is the systematic review itself, not the primary study.",
        highlight: "The umbrella review does not redo the original work. It evaluates, compares, and maps it."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "When to Choose an Umbrella Review",
        items: [
          "Multiple systematic reviews already exist on the topic",
          "Reviews reach discordant conclusions",
          "Decision makers need a single trustworthy summary",
          "You need to map evidence gaps across a broad question",
          "Resources are insufficient to redo all primary studies"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Scenario: Design Choice", xp: 25,
        scenario: "A health ministry asks for evidence on vitamin D and respiratory infections. Twelve systematic reviews already exist with varying conclusions.",
        question: "What is the most appropriate study design?",
        options: [
          { letter: "A", text: "Conduct a thirteenth systematic review", correct: false },
          { letter: "B", text: "Conduct an umbrella review of the twelve", correct: true },
          { letter: "C", text: "Pick the most recent review only", correct: false },
          { letter: "D", text: "Narrative opinion piece", correct: false }
        ],
        feedback: {
          correct: "Correct. When multiple SRs exist with varying conclusions, an umbrella review synthesizes and appraises them systematically.",
          incorrect: "Adding another SR to a crowded field increases noise. An umbrella review organizes the existing evidence."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Scenario: Unit of Analysis", xp: 25,
        scenario: "A researcher plans an umbrella review. They extract data from every RCT found in the included systematic reviews.",
        question: "What is the problem?",
        options: [
          { letter: "A", text: "Nothing, this is correct procedure", correct: false },
          { letter: "B", text: "The unit of analysis should be the SR, not the RCT", correct: true },
          { letter: "C", text: "They should only include meta-analyses", correct: false },
          { letter: "D", text: "They need more RCTs", correct: false }
        ],
        feedback: {
          correct: "Correct. In an umbrella review, the systematic review is the unit of analysis. Extracting primary study data crosses into a different design.",
          incorrect: "Umbrella reviews analyze systematic reviews as their unit. Going back to primary studies changes the design to a traditional SR or re-analysis."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Scenario: Too Few Reviews", xp: 25,
        scenario: "Only one systematic review exists on a rare disease intervention.",
        question: "Should you conduct an umbrella review?",
        options: [
          { letter: "A", text: "Yes, any topic can have an umbrella review", correct: false },
          { letter: "B", text: "No, an umbrella review requires multiple SRs to compare", correct: true },
          { letter: "C", text: "Only if the single SR is low quality", correct: false },
          { letter: "D", text: "Only if the disease is common enough", correct: false }
        ],
        feedback: {
          correct: "Correct. Umbrella reviews are designed to compare and synthesize across multiple SRs. With only one, update or replicate the SR instead.",
          incorrect: "An umbrella review needs multiple systematic reviews to fulfill its purpose of cross-review synthesis."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "When reviews multiply, the umbrella gathers them." }}
    ]
  },
  {
    id: 2, title: "The Harvest", subtitle: "Finding and selecting reviews", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Harvest", subtitle: "Gather every relevant review" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Design a search strategy targeting systematic reviews",
          "Apply eligibility criteria specific to umbrella reviews",
          "Handle borderline study designs (scoping reviews, rapid reviews)",
          "Document selection with a modified PRISMA flow"
        ],
        tip: "The harvest in an umbrella review is not about finding trials. It is about finding the reviews that already found the trials."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE NET", title: "When the search missed half the reviews",
        text: "An umbrella review searched only MEDLINE and missed systematic reviews published in regional databases, Cochrane, and PROSPERO-registered reviews with results. The final synthesis was incomplete and skewed toward English-language journals.",
        followup: "Searching for systematic reviews requires the same rigor as searching for primary studies: multiple databases, grey literature, and hand-searching reference lists of included reviews.",
        warning: true
      }},
      { type: "stats", theme: "dark", content: {
        title: "Search Sources for Systematic Reviews",
        stats: [
          { value: "MEDLINE", label: "Core biomedical database" },
          { value: "Cochrane", label: "Largest SR repository" },
          { value: "Epistemonikos", label: "SR-specific database" },
          { value: "PROSPERO", label: "SR protocol registry" }
        ],
        caption: "Key sources; additional databases depend on the topic."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Search Strategy for Reviews",
        subtitle: "Filter for the right study design",
        text: "Use validated search filters for systematic reviews and meta-analyses. Combine topic terms with methodological filters. Check SR-specific databases like Epistemonikos and the Cochrane Database of Systematic Reviews. Screen PROSPERO for completed but unpublished reviews.",
        highlight: "A missed review is a missed perspective. Comprehensive searching is not optional."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Harvest Checklist",
        items: [
          "Search at least three major databases with SR filters",
          "Include the Cochrane Library and Epistemonikos",
          "Check PROSPERO for registered reviews",
          "Hand-search reference lists of included reviews",
          "Define clear eligibility criteria before screening"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Scoping Review", xp: 25,
        scenario: "During screening, you find a well-conducted scoping review that maps evidence on your topic but does not pool effect sizes.",
        question: "Should you include it in your umbrella review?",
        options: [
          { letter: "A", text: "Yes, include all review types", correct: false },
          { letter: "B", text: "Exclude it; umbrella reviews include only systematic reviews", correct: true },
          { letter: "C", text: "Include it but label it differently", correct: false },
          { letter: "D", text: "Include only its reference list", correct: false }
        ],
        feedback: {
          correct: "Correct. Umbrella reviews typically include only systematic reviews (with or without meta-analysis). Scoping reviews use different methods and quality standards.",
          incorrect: "Scoping reviews follow different methodology and cannot be appraised with SR quality tools like AMSTAR 2."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Outdated Review", xp: 25,
        scenario: "A systematic review from 2008 meets your eligibility criteria but has been superseded by an updated version from 2022.",
        question: "How should you handle this?",
        options: [
          { letter: "A", text: "Include both versions as separate entries", correct: false },
          { letter: "B", text: "Include only the most recent version", correct: true },
          { letter: "C", text: "Exclude both to avoid double counting", correct: false },
          { letter: "D", text: "Merge them into one entry", correct: false }
        ],
        feedback: {
          correct: "Correct. When a review has been formally updated, include only the most recent version to avoid double counting the same evidence base.",
          incorrect: "Including both versions would double-count the same primary studies. The updated version supersedes the original."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Protocol Screening", xp: 25,
        scenario: "You find a PROSPERO registration for a systematic review that matches your topic perfectly but has no published results.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Include the protocol as a completed review", correct: false },
          { letter: "B", text: "Contact the authors to check for unpublished results", correct: true },
          { letter: "C", text: "Ignore it entirely", correct: false },
          { letter: "D", text: "Wait indefinitely for publication", correct: false }
        ],
        feedback: {
          correct: "Correct. Contacting authors can reveal completed but unpublished reviews, reducing publication bias in your umbrella review.",
          incorrect: "Registered but unpublished reviews may contain important evidence. Author contact is a standard step to reduce bias."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "A harvest that misses reviews misses the truth." }}
    ]
  },
  {
    id: 3, title: "The Lens", subtitle: "Quality assessment with AMSTAR 2", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Lens", subtitle: "Not all reviews deserve equal trust" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply AMSTAR 2 to assess the methodological quality of included SRs",
          "Distinguish critical from non-critical domains",
          "Assign overall confidence ratings: high, moderate, low, critically low",
          "Use quality assessment to weight conclusions, not just exclude reviews"
        ],
        tip: "AMSTAR 2 is not a score. It is a structured judgment that classifies confidence in the review's results."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE FLAW", title: "When a flawed review drove policy",
        text: "A systematic review with no risk of bias assessment and an incomplete search was cited by a national guideline. An umbrella review later showed this review had critically low confidence on AMSTAR 2, while three higher-quality reviews reached the opposite conclusion.",
        followup: "Without quality assessment, the loudest review wins. With it, the most trustworthy review leads."
      }},
      { type: "concept", theme: "dark", content: {
        title: "AMSTAR 2: The Standard Tool",
        subtitle: "16 items, 7 critical domains",
        text: "AMSTAR 2 evaluates systematic review methodology across 16 items. Seven are designated critical: protocol registration, comprehensive search, justification for exclusions, risk of bias assessment, appropriate meta-analytic methods, consideration of risk of bias in interpreting results, and assessment of publication bias.",
        highlight: "A single critical flaw drops the overall rating. Two or more critical flaws means critically low confidence."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "AMSTAR 2 Critical Domains",
        items: [
          "Protocol registered before the review began",
          "Comprehensive literature search performed",
          "Justification provided for excluding individual studies",
          "Risk of bias assessed for included studies",
          "Appropriate methods used for meta-analysis",
          "Risk of bias considered when interpreting results",
          "Publication bias assessed and discussed"
        ]
      }},
      { type: "amstar16", theme: "dark", content: {
        title: "AMSTAR 2: All 16 Items",
        subtitle: "7 Critical (starred) and 9 Non-critical items",
        critical: [
          { num: 2, text: "Protocol registered before the review began" },
          { num: 4, text: "Comprehensive literature search strategy" },
          { num: 7, text: "Justification for excluding individual studies" },
          { num: 9, text: "Satisfactory technique for assessing risk of bias" },
          { num: 11, text: "Appropriate meta-analytical methods" },
          { num: 13, text: "Risk of bias considered when interpreting results" },
          { num: 15, text: "Publication bias assessed and discussed" }
        ],
        nonCritical: [
          { num: 1, text: "Research questions include PICO components" },
          { num: 3, text: "Review methods established prior to conduct" },
          { num: 5, text: "Study selection performed in duplicate" },
          { num: 6, text: "Data extraction performed in duplicate" },
          { num: 8, text: "Adequate description of included studies" },
          { num: 10, text: "Funding sources for included studies reported" },
          { num: 12, text: "Impact of risk of bias on meta-analysis assessed" },
          { num: 14, text: "Heterogeneity discussed and explained" },
          { num: 16, text: "Conflicts of interest reported and managed" }
        ]
      }},
      { type: "stats", theme: "dark", content: {
        title: "Confidence Rating Scale",
        stats: [
          { value: "High", label: "No or one non-critical weakness" },
          { value: "Moderate", label: "More than one non-critical weakness" },
          { value: "Low", label: "One critical flaw with/without non-critical" },
          { value: "Crit. Low", label: "More than one critical flaw" }
        ],
        caption: "Based on the AMSTAR 2 classification scheme by Shea et al. 2017."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Missing Risk of Bias", xp: 25,
        scenario: "A systematic review included in your umbrella review did not assess risk of bias in any of its primary studies.",
        question: "What is the AMSTAR 2 implication?",
        options: [
          { letter: "A", text: "Non-critical weakness only", correct: false },
          { letter: "B", text: "Critical flaw, drops confidence to low or critically low", correct: true },
          { letter: "C", text: "No impact if the meta-analysis was done correctly", correct: false },
          { letter: "D", text: "Exclude the review entirely", correct: false }
        ],
        feedback: {
          correct: "Correct. Risk of bias assessment is a critical domain. Its absence constitutes a critical flaw.",
          incorrect: "Risk of bias assessment is one of the seven critical domains in AMSTAR 2. Missing it is a critical flaw."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Quality Exclusion", xp: 25,
        scenario: "All but one of your included reviews are rated critically low on AMSTAR 2. The remaining one is rated high.",
        question: "How should you handle this in your synthesis?",
        options: [
          { letter: "A", text: "Exclude all critically low reviews", correct: false },
          { letter: "B", text: "Include all but weight conclusions by quality rating", correct: true },
          { letter: "C", text: "Average all results equally", correct: false },
          { letter: "D", text: "Only report the high-quality review", correct: false }
        ],
        feedback: {
          correct: "Correct. Umbrella reviews should include all eligible reviews but use quality ratings to contextualize findings and weight conclusions.",
          incorrect: "Excluding low-quality reviews risks bias. Include them but clearly note how quality affects the strength of conclusions."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Dual Assessment", xp: 25,
        scenario: "Two reviewers disagree on whether a systematic review meets the AMSTAR 2 criterion for comprehensive searching.",
        question: "What is the best resolution?",
        options: [
          { letter: "A", text: "Accept the more generous rating", correct: false },
          { letter: "B", text: "Discuss, apply decision rules, and document the resolution", correct: true },
          { letter: "C", text: "Exclude the review to avoid the disagreement", correct: false },
          { letter: "D", text: "Let a third person decide without seeing the assessments", correct: false }
        ],
        feedback: {
          correct: "Correct. Disagreements should be resolved through discussion with pre-specified decision rules, and the resolution documented.",
          incorrect: "Transparent resolution with documentation maintains the integrity of the quality assessment."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The lens that ignores quality magnifies error." }}
    ]
  },
  {
    id: 4, title: "The Overlap", subtitle: "When reviews share the same studies", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Overlap", subtitle: "The hidden problem of double counting" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Explain why primary study overlap matters in umbrella reviews",
          "Calculate the Corrected Covered Area to quantify overlap",
          "Apply strategies to manage moderate and high overlap",
          "Report overlap transparently"
        ],
        tip: "If five reviews each include the same three RCTs, you do not have five independent pieces of evidence. You have one evidence base counted five times."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE ECHO", title: "When the same patients were counted three times",
        text: "An umbrella review pooled results from four systematic reviews. Unknown to the authors, three of the four reviews included the same large RCT. The pooled result was driven almost entirely by a single trial counted multiple times, creating a false sense of precision.",
        followup: "Overlap detection is not optional. Without it, umbrella reviews amplify echoes instead of evidence."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Overlap Thresholds (CCA)",
        stats: [
          { value: "0-5%", label: "Slight overlap" },
          { value: "6-10%", label: "Moderate overlap" },
          { value: "11-15%", label: "High overlap" },
          { value: ">15%", label: "Very high overlap" }
        ],
        caption: "Corrected Covered Area thresholds by Pieper et al. 2014."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Corrected Covered Area (CCA)",
        subtitle: "A metric for primary study overlap",
        text: "The CCA measures the degree to which the same primary studies appear across multiple systematic reviews. Build a citation matrix listing all primary studies (rows) against all included SRs (columns). Formula: CCA = (N &minus; r) / (r &times; c &minus; r), where N = total citations across all SRs, r = number of unique primary studies, and c = number of included SRs.",
        highlight: "High overlap means your reviews are not independent. Treat their results as correlated, not additive."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Overlap Management",
        items: [
          "Build a citation matrix of primary studies across SRs",
          "Calculate the Corrected Covered Area",
          "Report the overlap degree and its implications",
          "Consider using only the most comprehensive or most recent SR per comparison",
          "Never pool results from highly overlapping SRs as if independent"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Scenario: Very High Overlap", xp: 25,
        scenario: "Your citation matrix reveals a CCA of 22 percent. Most reviews share the same five core RCTs.",
        question: "What is the best approach for synthesis?",
        options: [
          { letter: "A", text: "Pool all review results as independent estimates", correct: false },
          { letter: "B", text: "Select the most comprehensive SR or conduct a de novo meta-analysis", correct: true },
          { letter: "C", text: "Ignore the overlap and proceed", correct: false },
          { letter: "D", text: "Remove the overlapping studies from all reviews", correct: false }
        ],
        feedback: {
          correct: "Correct. With very high overlap, pooling is misleading. Select the most comprehensive review or return to primary data.",
          incorrect: "Very high overlap means the reviews are not independent sources. Pooling would create false precision."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Scenario: Building the Matrix", xp: 25,
        scenario: "Two of your included reviews do not list individual study references in their forest plots or tables.",
        question: "How should you handle this for the citation matrix?",
        options: [
          { letter: "A", text: "Assume no overlap for those reviews", correct: false },
          { letter: "B", text: "Extract references from reference lists or contact authors", correct: true },
          { letter: "C", text: "Exclude those reviews from the umbrella review", correct: false },
          { letter: "D", text: "Skip the citation matrix entirely", correct: false }
        ],
        feedback: {
          correct: "Correct. Effort should be made to identify included studies from reference lists or by contacting authors.",
          incorrect: "The citation matrix requires knowing which studies each SR included. Missing data should be sought, not assumed."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Scenario: Slight Overlap", xp: 25,
        scenario: "Your CCA is 3 percent. Each review used a largely unique set of primary studies due to different search dates and inclusion criteria.",
        question: "How does this affect your synthesis?",
        options: [
          { letter: "A", text: "You can treat the reviews as largely independent", correct: true },
          { letter: "B", text: "You must still select only one review", correct: false },
          { letter: "C", text: "Overlap is always a fatal problem", correct: false },
          { letter: "D", text: "You should combine all primary studies instead", correct: false }
        ],
        feedback: {
          correct: "Correct. Slight overlap means the reviews provide largely independent evidence. Synthesis can proceed with appropriate caution.",
          incorrect: "Slight overlap is acceptable. The key is to measure it, report it, and interpret results accordingly."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Count the evidence once, not the echo." }}
    ]
  },
  {
    id: 5, title: "The Synthesis", subtitle: "Weaving evidence across reviews", xp: 170,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "The Synthesis", subtitle: "From many reviews to one answer" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Choose between narrative and quantitative synthesis approaches",
          "Understand when re-analysis of primary data is justified",
          "Present discordant results transparently",
          "Apply GRADE or a similar framework to rate certainty across reviews"
        ],
        tip: "The synthesis is where the umbrella review earns its value: transforming conflicting signals into a structured judgment."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE WEAVE", title: "When three meta-analyses disagreed",
        text: "Three systematic reviews each ran a meta-analysis on the same intervention. One found a significant benefit, one found no effect, and one found a trend toward harm. The umbrella review traced the discordance to different inclusion criteria, risk of bias handling, and statistical models.",
        followup: "The synthesis did not pick a winner. It explained why they disagreed and which methodological choices drove the difference.",
        warning: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Synthesis Approaches",
        subtitle: "Match the method to the data",
        text: "Narrative synthesis compares findings across reviews using structured tables. Quantitative re-analysis pools primary study data when overlap is low and data are accessible. A hybrid approach tabulates review-level results and uses forest plots to display concordance and discordance visually.",
        highlight: "Never pool results from overlapping reviews as if they were independent studies."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Synthesis Checklist",
        items: [
          "Tabulate all review results side by side with quality ratings",
          "Identify sources of discordance (scope, methods, dates, bias handling)",
          "Report direction, magnitude, and precision for each review",
          "Apply GRADE or equivalent to assess certainty of evidence",
          "Present both concordant and discordant findings transparently"
        ]
      }},
      { type: "stats", theme: "dark", content: {
        title: "Discordance Drivers",
        stats: [
          { value: "scope", label: "Different PICO definitions" },
          { value: "search", label: "Different databases or dates" },
          { value: "bias", label: "Different quality tools" },
          { value: "analysis", label: "Different statistical models" }
        ],
        caption: "Common reasons reviews on the same topic disagree."
      }},
      { type: "grade5", theme: "dark", content: {
        title: "GRADE: The Five Domains",
        subtitle: "Rate certainty by assessing each domain",
        domains: [
          { name: "Risk of Bias", desc: "Limitations in study design or execution that may bias results" },
          { name: "Inconsistency", desc: "Unexplained heterogeneity in results across studies" },
          { name: "Indirectness", desc: "Evidence does not directly apply to the question (population, intervention, comparator, outcome)" },
          { name: "Imprecision", desc: "Wide confidence intervals due to small sample size or few events" },
          { name: "Publication Bias", desc: "Selective publication of studies based on results" }
        ],
        note: "Each domain can downgrade certainty from high to moderate, low, or very low."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Pooling Decision", xp: 25,
        scenario: "You have six included SRs with moderate overlap (CCA 9 percent). Four used random-effects meta-analysis with similar PICO criteria.",
        question: "Can you pool their meta-analytic results?",
        options: [
          { letter: "A", text: "Yes, pool all six review-level estimates", correct: false },
          { letter: "B", text: "No, use narrative synthesis with a structured comparison table", correct: true },
          { letter: "C", text: "Pool only the four with similar methods, ignoring overlap", correct: false },
          { letter: "D", text: "Conduct a meta-analysis of meta-analyses without checking overlap", correct: false }
        ],
        feedback: {
          correct: "Correct. With moderate overlap, pooling review-level estimates risks double counting. Narrative synthesis with structured comparison is safer.",
          incorrect: "Moderate overlap means the reviews share primary studies. Pooling their results would overweight those shared studies."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Discordance Explained", xp: 25,
        scenario: "Two high-quality SRs disagree: one finds benefit, the other no effect. You trace the discordance to a single large trial included in one but not the other.",
        question: "How should you report this?",
        options: [
          { letter: "A", text: "Dismiss the review without the trial", correct: false },
          { letter: "B", text: "Explain the discordance source and present both results with context", correct: true },
          { letter: "C", text: "Average the two results", correct: false },
          { letter: "D", text: "Exclude both reviews", correct: false }
        ],
        feedback: {
          correct: "Correct. Transparent reporting of discordance sources is a core function of umbrella reviews.",
          incorrect: "Umbrella reviews add value by explaining why reviews disagree, not by hiding the disagreement."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: GRADE in Umbrella Reviews", xp: 25,
        scenario: "You want to rate the overall certainty of evidence across your included reviews. Multiple reviews used different approaches to GRADE.",
        question: "What is the recommended approach?",
        options: [
          { letter: "A", text: "Average the GRADE ratings from each review", correct: false },
          { letter: "B", text: "Apply GRADE independently based on the best available primary data", correct: true },
          { letter: "C", text: "Use the highest GRADE rating from any review", correct: false },
          { letter: "D", text: "Skip certainty assessment in umbrella reviews", correct: false }
        ],
        feedback: {
          correct: "Correct. Umbrella reviews should apply GRADE or equivalent independently, considering the most reliable evidence base and quality of included reviews.",
          incorrect: "Averaging or cherry-picking GRADE ratings is not valid. The umbrella review team should make their own certainty judgment."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The synthesis reveals the signal beneath the noise." }}
    ]
  },
  {
    id: 6, title: "The Map", subtitle: "Gaps, concordance, and visualization", xp: 170,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Map", subtitle: "See what is known and what is missing" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Create an evidence map showing where evidence is strong or weak",
          "Identify research gaps that future reviews or trials should address",
          "Visualize concordance and discordance across reviews",
          "Use structured tables and harvest plots to communicate findings"
        ],
        tip: "An umbrella review that only summarizes results misses its greatest strength: revealing the shape of the evidence landscape."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE BLANK", title: "When the map revealed the gap",
        text: "An umbrella review on exercise and mental health found twelve reviews on depression but none on bipolar disorder. The evidence map made this gap visible in a single figure, prompting a research funding call that led to three new trials.",
        followup: "The absence of evidence is itself a finding. The map makes it visible.",
        warning: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Evidence Mapping",
        subtitle: "Structure the landscape",
        text: "An evidence map cross-tabulates populations, interventions, comparisons, and outcomes against the number and quality of available reviews. Cells with many high-quality reviews show strong evidence; empty cells reveal gaps. Harvest plots display direction and strength of effects across reviews at a glance.",
        highlight: "The map is not decoration. It is the decision tool."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Mapping Checklist",
        items: [
          "Define the matrix dimensions (population, intervention, outcome)",
          "Populate each cell with the number and quality of reviews",
          "Mark cells with discordant findings",
          "Highlight empty cells as research gaps",
          "Use visual tools (harvest plots, bubble plots) for communication"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Priority Setting", xp: 25,
        scenario: "Your evidence map shows a cell with four critically low quality reviews and no high-quality review. The clinical question is important.",
        question: "What is the priority recommendation?",
        options: [
          { letter: "A", text: "Accept the critically low evidence as sufficient", correct: false },
          { letter: "B", text: "Recommend a high-quality systematic review to fill the gap", correct: true },
          { letter: "C", text: "Recommend more umbrella reviews", correct: false },
          { letter: "D", text: "Ignore the cell entirely", correct: false }
        ],
        feedback: {
          correct: "Correct. Cells with only low-quality reviews represent evidence that exists but cannot be trusted. A rigorous new SR is the priority.",
          incorrect: "Critically low quality reviews do not answer the question reliably. The gap is in quality, not quantity."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Concordance Display", xp: 25,
        scenario: "Six reviews all find a significant benefit for the same intervention-outcome pair, but they vary in effect size from small to large.",
        question: "How should you display this in the evidence map?",
        options: [
          { letter: "A", text: "Mark the cell as concordant with a note on effect size range", correct: true },
          { letter: "B", text: "Mark it as discordant because effect sizes differ", correct: false },
          { letter: "C", text: "Report only the median effect size", correct: false },
          { letter: "D", text: "Leave the cell blank", correct: false }
        ],
        feedback: {
          correct: "Correct. Concordance in direction with variation in magnitude is a common and important finding. Report both the agreement and the range.",
          incorrect: "Reviews that agree on direction but differ in magnitude are concordant on the key question, with precision varying by methods."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Empty Cell", xp: 25,
        scenario: "Your evidence map has an entire population column with no systematic reviews: children under five.",
        question: "What should you conclude?",
        options: [
          { letter: "A", text: "The intervention does not work in this population", correct: false },
          { letter: "B", text: "Evidence is absent, flag as a research gap, avoid making effectiveness claims", correct: true },
          { letter: "C", text: "Extrapolate from adult data", correct: false },
          { letter: "D", text: "Remove the population from the map", correct: false }
        ],
        feedback: {
          correct: "Correct. Absence of evidence is not evidence of absence. Flag the gap and recommend future research.",
          incorrect: "Empty cells mean the question has not been answered, not that the answer is negative."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The map shows not just what we know, but what we have yet to learn." }}
    ]
  },
  {
    id: 7, title: "The Report", subtitle: "Standards, pitfalls, and closure", xp: 200,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "The Report", subtitle: "Close the loop with transparent reporting" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply reporting guidelines for umbrella reviews (PRIOR, PRISMA adaptations)",
          "Avoid the most common pitfalls in published umbrella reviews",
          "Decide when an umbrella review adds value versus when a new SR is needed",
          "Return to the opening scenario with a structured answer"
        ],
        tip: "Ring structure: we return to the five conflicting reviews from Module 1. Now you have the tools to resolve them."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "THE RETURN", title: "The guideline panel, revisited",
        text: "The panel that faced five conflicting reviews now has an umbrella review. It shows that three of the five reviews had critically low quality, overlap was high, and the two trustworthy reviews agreed on a moderate benefit with low certainty. The panel has a clear, justified basis for its recommendation.",
        followup: "The umbrella review did not produce new data. It organized existing evidence into a trustworthy judgment.",
        success: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Reporting Standards",
        subtitle: "PRIOR and adapted PRISMA",
        text: "The Preferred Reporting Items for Overviews of Reviews (PRIOR) statement provides a checklist for transparent reporting of umbrella reviews. Key items include explicit description of overlap assessment, quality appraisal methods, synthesis approach, and certainty of evidence assessment. When PRIOR is unavailable, a PRISMA adaptation with umbrella-specific modifications is acceptable.",
        highlight: "A well-reported umbrella review enables others to judge its trustworthiness. Poor reporting defeats its purpose."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Common Pitfalls to Avoid",
        items: [
          "Failing to assess or report primary study overlap",
          "Using AMSTAR 2 as a numeric score instead of a confidence classification",
          "Pooling results from overlapping reviews without adjustment",
          "Ignoring discordance or reporting only concordant findings",
          "Omitting a structured evidence map or gap analysis"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Missing Overlap Report", xp: 35,
        scenario: "A reviewer suggests removing the citation matrix and CCA from the manuscript to save space. The editor agrees.",
        question: "What is the correct response?",
        options: [
          { letter: "A", text: "Agree, overlap is minor detail", correct: false },
          { letter: "B", text: "Keep the overlap assessment, move to supplement if needed", correct: true },
          { letter: "C", text: "Remove it and mention overlap in one sentence", correct: false },
          { letter: "D", text: "Replace it with a statement that overlap was low", correct: false }
        ],
        feedback: {
          correct: "Correct. Overlap assessment is a core methodological requirement. If space is limited, move it to a supplement but never omit it.",
          incorrect: "Overlap assessment is fundamental to the validity of an umbrella review. It must be reported, at minimum in supplementary materials."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Umbrella vs. New SR", xp: 35,
        scenario: "A research team wants to study the effect of a new drug class. Two low-quality SRs exist, both with incomplete searches.",
        question: "Should they conduct an umbrella review or a new systematic review?",
        options: [
          { letter: "A", text: "Umbrella review of the two existing SRs", correct: false },
          { letter: "B", text: "A new, rigorous systematic review", correct: true },
          { letter: "C", text: "Both simultaneously", correct: false },
          { letter: "D", text: "Neither, the evidence is sufficient", correct: false }
        ],
        feedback: {
          correct: "Correct. With only two low-quality SRs, an umbrella review would rest on a weak foundation. A new well-conducted SR is more valuable.",
          incorrect: "An umbrella review is only as strong as its included reviews. When the existing evidence base is small and weak, a new SR is the right choice."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Final Judgment", xp: 35,
        scenario: "Your umbrella review includes ten SRs. Seven are concordant (moderate benefit), two are discordant (no benefit), and one reports harm. Overlap is moderate. The seven concordant reviews are mostly high quality; the discordant ones are critically low quality.",
        question: "What is the appropriate conclusion?",
        options: [
          { letter: "A", text: "Definitive benefit, ignore the discordant reviews", correct: false },
          { letter: "B", text: "Probable moderate benefit with moderate certainty, noting discordance from lower-quality reviews", correct: true },
          { letter: "C", text: "No conclusion possible due to discordance", correct: false },
          { letter: "D", text: "Harm signal overrides all other findings", correct: false }
        ],
        feedback: {
          correct: "Correct. The synthesis weighs quality, concordance, and overlap. High-quality concordant evidence supports a conclusion while transparently acknowledging discordance.",
          incorrect: "Umbrella reviews integrate quality, concordance, and overlap to form a structured judgment, not a simple vote count."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "When reviews multiply, the umbrella gathers them." }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = gameState.consecutiveCorrect || 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('umbrellaReviewGame_v1', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [], consecutiveCorrect: 0 };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
  const modal = document.getElementById('levelModal');
  document.getElementById('levelModalLevel').textContent = `Level ${levelData.level}`;
  document.getElementById('levelModalName').textContent = levelData.title;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');

  // Auto-close after 3 seconds
  setTimeout(() => {
    closeLevelModal();
  }, 3000);
}

function closeLevelModal() {
  const modal = document.getElementById('levelModal');
  if (modal) {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  const modal = document.getElementById('badgeModal');
  modal.classList.add('show');
  if (celebrate) triggerConfetti();

  // Focus trap
  const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
  if (focusableElements.length > 0) {
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    firstFocusable.focus();

    // Remove any existing focus trap listener
    if (modal._focusTrapHandler) {
      modal.removeEventListener('keydown', modal._focusTrapHandler);
    }

    modal._focusTrapHandler = function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
      if (e.key === 'Escape') {
        closeBadgeModal();
      }
    };
    modal.addEventListener('keydown', modal._focusTrapHandler);
  }
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  const modal = document.getElementById('badgeModal');
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    modal._focusTrapHandler = null;
  }
  modal.classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.completedModules.length;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="badge-item ${earned ? 'earned' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${locked ? 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">Time ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn prev" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="Previous slide">&lt;</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn next" onclick="nextSlide()" aria-label="Next slide">&gt;</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">Left / Right arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} ${slide.content.warning ? 'warning' : ''} ${slide.content.teal ? 'teal' : ''} animate" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'amstar16':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <p class="subtitle animate delay-1">${slide.content.subtitle}</p>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;max-width:900px;margin-top:1rem" class="animate delay-2">
          <div style="flex:1;min-width:280px;background:rgba(239,68,68,0.15);border:2px solid var(--red);border-radius:8px;padding:1rem">
            <h3 style="color:var(--red);font-size:0.9rem;margin-bottom:0.75rem;font-weight:700">CRITICAL ITEMS (7)</h3>
            ${slide.content.critical.map(item => `
              <div style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.35rem 0;font-size:0.85rem">
                <span style="color:var(--red);font-weight:700;min-width:24px">${item.num}*</span>
                <span>${item.text}</span>
              </div>
            `).join('')}
          </div>
          <div style="flex:1;min-width:280px;background:rgba(34,197,94,0.1);border:2px solid var(--green);border-radius:8px;padding:1rem">
            <h3 style="color:var(--green);font-size:0.9rem;margin-bottom:0.75rem;font-weight:700">NON-CRITICAL ITEMS (9)</h3>
            ${slide.content.nonCritical.map(item => `
              <div style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.35rem 0;font-size:0.85rem">
                <span style="color:var(--green);font-weight:700;min-width:24px">${item.num}</span>
                <span>${item.text}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>`;
      break;

    case 'grade5':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <p class="subtitle animate delay-1">${slide.content.subtitle}</p>
        <div style="display:flex;flex-direction:column;gap:0.6rem;max-width:700px;margin-top:1rem" class="animate delay-2">
          ${slide.content.domains.map((domain, idx) => `
            <div style="display:flex;align-items:flex-start;gap:0.75rem;background:rgba(124,58,237,0.15);border-left:4px solid var(--purple);border-radius:0 8px 8px 0;padding:0.75rem 1rem">
              <div style="width:28px;height:28px;background:var(--purple);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;flex-shrink:0">${idx + 1}</div>
              <div>
                <div style="font-weight:700;color:var(--gold);font-size:0.95rem">${domain.name}</div>
                <div style="font-size:0.85rem;opacity:0.9">${domain.desc}</div>
              </div>
            </div>
          `).join('')}
        </div>
        <p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:1rem;max-width:600px">${slide.content.note}</p>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="decision-option ${isSelected ? 'selected' : ''} ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${answered ? 'disabled' : ''}"
                     onclick="answerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'Correct!' : 'Not quite'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
            ${answered && !(slide.content.options.find(o => o.letter === answered)?.correct) ? `<div style="margin-top:0.5rem;font-size:0.8rem;color:var(--orange);font-weight:600;">Partial credit: +${Math.floor(slide.content.xp * 0.2)} XP</div>` : ''}
          </div>
        </div>
      </div>`;
      break;

    default:
      html += '<div class="slide-content"><p>Unknown slide type</p></div>';
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  const prevBtn = container.querySelector('.nav-btn.prev');
  const nextBtn = container.querySelector('.nav-btn.next');
  if (prevBtn) prevBtn.disabled = currentSlide === 0;
  if (nextBtn) {
    const onLastSlide = currentSlide === MODULES[currentModule].slides.length - 1;
    nextBtn.disabled = onLastSlide && gameState.completedModules.includes(MODULES[currentModule].id);
  }
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;

  if (gameState.decisionsCompleted === 1) awardBadge('first_scenario');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 21) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
    addXP(Math.floor(xp * 0.2));
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 1) awardBadge('canopy_explorer');
    if (mod.id === 2) awardBadge('harvest_expert');
    if (mod.id === 3) awardBadge('quality_judge');
    if (mod.id === 4) awardBadge('overlap_detective');
    if (mod.id === 5) awardBadge('evidence_weaver');
    if (mod.id === 6) awardBadge('gap_finder');
    if (mod.id === 7) awardBadge('report_champion');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  } else if (gameState.completedModules.length === MODULES.length && !gameState.courseCompleted) {
    gameState.courseCompleted = true;
    saveGame();
    showCourseCompletion();
  }
}

function showCourseCompletion() {
  document.getElementById('completionXP').textContent = gameState.xp;
  document.getElementById('completionBadges').textContent = gameState.badges.length;
  document.getElementById('completionLevel').textContent = gameState.level;
  document.getElementById('completionOverlay').classList.add('show');
  triggerConfetti();
}

function closeCompletion() {
  document.getElementById('completionOverlay').classList.remove('show');
}

function reviewBadges() {
  document.getElementById('completionOverlay').classList.remove('show');
  // Scroll to badges panel and highlight it
  const badgesPanel = document.querySelector('.badges-panel');
  if (badgesPanel) {
    badgesPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    badgesPanel.style.transition = 'box-shadow 0.3s ease';
    badgesPanel.style.boxShadow = '0 0 20px 5px rgba(212,175,55,0.6)';
    setTimeout(() => {
      badgesPanel.style.boxShadow = '';
    }, 2000);
  }
}

function downloadCertificate() {
  const courseName = 'Umbrella Reviews: Synthesis of Syntheses';
  const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const level = LEVELS[gameState.level - 1] || LEVELS[0];
  const badgeCount = gameState.badges.length;
  const totalXP = gameState.xp;

  const certHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate of Completion - ${courseName}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Sans Pro', sans-serif; background: #f5f5f5; padding: 20px; }
    .certificate {
      max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #1E2761 0%, #141B3D 100%);
      border: 8px solid #D4AF37; border-radius: 12px; padding: 60px 50px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .cert-header { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 1rem; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 10px; }
    .cert-title { font-family: 'Cormorant Garamond', serif; color: #FAF8F5; font-size: 3rem; font-weight: 700; margin-bottom: 30px; }
    .cert-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 40px; }
    .cert-course { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 2rem; font-weight: 600; margin-bottom: 15px; padding: 20px; border-top: 1px solid rgba(212,175,55,0.3); border-bottom: 1px solid rgba(212,175,55,0.3); }
    .cert-stats { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
    .cert-stat { text-align: center; }
    .cert-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: #D4AF37; font-weight: 700; }
    .cert-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.1em; }
    .cert-date { color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-top: 40px; }
    .cert-footer { margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(212,175,55,0.2); }
    .cert-issuer { color: rgba(255,255,255,0.5); font-size: 0.85rem; }
    .cert-badge { display: inline-block; margin-top: 15px; padding: 8px 20px; background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.4); border-radius: 20px; color: #D4AF37; font-size: 0.9rem; }
    @media print {
      body { background: white; padding: 0; }
      .certificate { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="certificate">
    <div class="cert-header">Synthesis Course Collection</div>
    <div class="cert-title">Certificate of Completion</div>
    <div class="cert-subtitle">This certifies successful completion of</div>
    <div class="cert-course">${courseName}</div>
    <div class="cert-stats">
      <div class="cert-stat">
        <div class="cert-stat-value">${totalXP.toLocaleString()}</div>
        <div class="cert-stat-label">Total XP Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${badgeCount}</div>
        <div class="cert-stat-label">Badges Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${level.title}</div>
        <div class="cert-stat-label">Final Level</div>
      </div>
    </div>
    <div class="cert-date">Completed on ${completionDate}</div>
    <div class="cert-footer">
      <div class="cert-issuer">Synthesis Course Collection  Evidence Synthesis & Meta-Analysis Training</div>
      <div class="cert-badge">Verified Completion</div>
    </div>
  </div>
  <script>window.onload = () => window.print();<\/script>
</body>
</html>`;

  const blob = new Blob([certHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Certificate-Umbrella-Reviews-Course.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeBadgeModal();
    document.getElementById('completionOverlay').classList.remove('show');
    closeLevelModal();
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }

  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option')) && (e.key === 'Enter' || e.key === ' ')) {
    e.preventDefault();
    e.target.click();
    return;
  }

  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('button, a, input, textarea, select');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }

  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    const mod = MODULES[currentModule];
    const onLastSlide = currentSlide === mod.slides.length - 1;
    if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
    nextSlide();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    prevSlide();
  }
});

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) {
    if (diff > 0) {
      const mod = MODULES[currentModule];
      const onLastSlide = currentSlide === mod.slides.length - 1;
      if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
      nextSlide();
    } else {
      prevSlide();
    }
  }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
