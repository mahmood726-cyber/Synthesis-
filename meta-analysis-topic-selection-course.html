<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meta-Analysis Topic Selection: The Right Question</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active { background: rgba(249,115,22,0.2); border-color: var(--orange); }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: var(--green); }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--orange); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-left-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Confidence Colors */
    .cerqual-high { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(30,39,97,0.2)); border-color: var(--green); }
    .cerqual-moderate { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,39,97,0.2)); border-color: #3b82f6; }
    .cerqual-low { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(30,39,97,0.2)); border-color: var(--orange); }
    .cerqual-very-low { background: linear-gradient(135deg, rgba(197,48,48,0.2), rgba(30,39,97,0.2)); border-color: var(--red); }

    .cerqual-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .cerqual-badge.high { background: var(--green); color: white; }
    .cerqual-badge.moderate { background: #3b82f6; color: white; }
    .cerqual-badge.low { background: var(--orange); color: white; }
    .cerqual-badge.very-low { background: var(--red); color: white; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .decision-option:hover { background: rgba(124,58,237,0.2); border-color: var(--purple); }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Quiz */
    .quiz-container { width: 100%; max-width: 650px; }
    .quiz-question {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      margin-bottom: 1.25rem;
      text-align: center;
    }
    .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      font-size: 0.9rem;
    }
    .quiz-option:hover { background: rgba(212,175,55,0.15); border-color: var(--gold); }
    .quiz-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .quiz-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .quiz-option.disabled { pointer-events: none; }
    .quiz-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .quiz-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }
    .quiz-feedback.show { display: block; }
    .quiz-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .quiz-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: '○'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      .confetti { animation: none; display: none; }
      .xp-popup { transition: none; }
      .slide { transition: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; max-width: 220px; }
    .progress-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      padding: 0;
      appearance: none;
      position: relative;
    }
    .progress-dot::after {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .progress-dot.active::after { background: var(--gold); transform: translate(-50%, -50%) scale(1.4); }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-left: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="course-container">
    <!-- Sidebar -->
    <nav class="sidebar" role="navigation" aria-label="Course navigation">
      <div class="sidebar-header">
        <a href="index.html" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='rgba(212,175,55,0.7)'">&larr; Course Library</a>
        <h1>Topic Selection</h1>
        <p>Choosing the Right Question</p>
      </div>

      <div class="stats-panel">
        <div class="level-display">
          <div class="level-badge" id="levelIcon">QS</div>
          <div class="level-info">
            <div class="level-title" id="levelTitle">Question Seeker</div>
            <div class="level-subtitle">Level <span id="levelNum">1</span></div>
          </div>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
        <div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
        <div class="quick-stats">
          <div class="quick-stat">
            <div class="quick-stat-value" id="correctCount">0</div>
            <div class="quick-stat-label">Correct</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="decisionCount">0</div>
            <div class="quick-stat-label">Decisions</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="synthesisCount">0</div>
            <div class="quick-stat-label">Refined</div>
          </div>
        </div>
      </div>

      <div class="course-progress">
        <div class="course-progress-label">
          <span>Course Progress</span>
          <span id="courseProgressPct">0%</span>
        </div>
        <div class="course-progress-bar">
          <div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="module-list" id="moduleList"></div>

      <div class="badges-panel">
        <div class="badges-title">Achievements</div>
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
      <header class="content-header">
        <div class="breadcrumb">Topic Selection / <span id="currentModule">Module 1</span></div>
        <div class="header-actions">
          <div class="streak-display" id="streakDisplay">
            <span class="streak-flame">ST</span>
            <span class="streak-count" id="streakCount">0</span>
            <span>day streak</span>
          </div>
          <button class="btn" onclick="resetProgress()">Reset</button>
        </div>
      </header>

      <div class="content-body">
        <div class="slides-container" id="slidesContainer"></div>
      </div>
    </main>
  </div>

  <!-- XP Popup -->
  <div class="xp-popup" id="xpPopup" role="status" aria-live="polite" aria-atomic="true">
    <span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>

  <!-- Badge Modal -->
  <div class="badge-modal" id="badgeModal" role="dialog" aria-modal="true" aria-labelledby="badgeModalTitle">
    <div class="badge-modal-content">
      <div class="badge-modal-icon" id="badgeModalIcon">AW</div>
      <div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
      <div class="badge-modal-desc" id="badgeModalDesc">You unlocked a new achievement</div>
      <button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- Combo Counter -->
  <div class="combo-display" id="comboDisplay" role="status" aria-live="polite">COMBO <span id="comboCount">0</span>x</div>

  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu" aria-expanded="false">MENU</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {}
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

let gameState = safeGetStorage('topicSelectionGame', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Question Seeker", icon: "QS", xp: 0 },
  { level: 2, title: "Scope Shaper", icon: "SS", xp: 100 },
  { level: 3, title: "Evidence Scout", icon: "ES", xp: 250 },
  { level: 4, title: "Impact Interpreter", icon: "II", xp: 450 },
  { level: 5, title: "Novelty Hunter", icon: "NH", xp: 700 },
  { level: 6, title: "Bias Sentinel", icon: "BS", xp: 1000 },
  { level: 7, title: "Protocol Forger", icon: "PF", xp: 1400 },
  { level: 8, title: "Topic Architect", icon: "TA", xp: 1900 }
];

const BADGES = [
  { id: "first_question", icon: "FQ", name: "First Question", desc: "Complete your first decision scenario" },
  { id: "scope_shaper", icon: "SS", name: "Scope Shaper", desc: "Complete The Frame module" },
  { id: "evidence_scout", icon: "ES", name: "Evidence Scout", desc: "Complete The Evidence Field module" },
  { id: "impact_guardian", icon: "IG", name: "Impact Guardian", desc: "Complete The Stakeholder module" },
  { id: "novelty_hawk", icon: "NH", name: "Novelty Hawk", desc: "Complete The Echoes module" },
  { id: "bias_sentinel", icon: "BS", name: "Bias Sentinel", desc: "Complete The Mirror module" },
  { id: "topic_forger", icon: "TF", name: "Topic Forger", desc: "Complete The Topic Forge module" },
  { id: "perfect_5", icon: "5x", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "DM", name: "Decision Maker", desc: "Complete 15 decision trees" },
  { id: "finisher", icon: "FN", name: "Course Complete", desc: "Finish the entire course" },
  { id: "streak_3", icon: "S3", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "S7", name: "Weekly Warrior", desc: "Maintain a 7-day streak" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "The Call", subtitle: "Why the right question matters", xp: 140,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "Choosing a Topic for Meta-Analysis", subtitle: "Find the question that deserves your time" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Recognize why topic selection is the highest-stakes decision in a review",
          "Use the Three Gates: decision value, evidence readiness, and contribution",
          "Spot early warning signs of a topic that is not ready",
          "Build a narrative frame that keeps scope and outcomes aligned"
        ],
        tip: "Every concept is anchored in real evidence reversals—CAST, HRT, DECREASE—because judgment comes from seeing how real experts got it wrong."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE RUSH", title: "When the question outran the evidence",
        text: "In early 2020, a treatment became a global headline. Within weeks, dozens of small studies and preprints appeared. Meta-analyses were published faster than trials could finish. Results flipped month to month because study designs, outcomes, and patient severity differed.",
        followup: "By late 2020, large randomized trials reported no meaningful benefit. The early reviews were not wrong in method; the topic itself was too immature and too fragmented. The question had not yet ripened."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Field Snapshot (Simplified)",
        stats: [
          { value: "70+", label: "Studies within 4 months" },
          { value: "3", label: "Design families" },
          { value: "6", label: "Primary outcome definitions" },
          { value: "1", label: "Shared protocol" }
        ],
        caption: "Illustrative counts from early-pandemic treatment literature; numbers simplified for teaching."
      }},
      { type: "concept", theme: "dark", content: {
        title: "The Three Gates of a Good Topic",
        subtitle: "If any gate is closed, do not enter",
        text: "<strong>Decision value:</strong> Someone must act on the answer.<br><br><strong>Evidence readiness:</strong> Enough comparable studies with extractable data.<br><br><strong>Contribution:</strong> The review changes understanding, updates evidence, or resolves conflict.",
        highlight: "A topic can be important but unripe, feasible but irrelevant, or novel but trivial. Pass all three gates."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QS", title: "Scenario: The Headline Trap", xp: 25,
        scenario: "A topic is everywhere in the news. Your scoping search finds 2 small RCTs, 7 preprints, and 4 observational studies with different outcomes and time windows. A hospital leader asks for a pooled answer in two weeks.",
        question: "What is the most responsible response?",
        options: [
          { letter: "A", text: "Run a full meta-analysis now; speed matters most", correct: false },
          { letter: "B", text: "Publish a rapid scoping review and register a living protocol", correct: true },
          { letter: "C", text: "Use only the preprints to move fast", correct: false },
          { letter: "D", text: "Wait and provide no guidance at all", correct: false }
        ],
        feedback: {
          correct: "Correct. The evidence field is immature and inconsistent. A scoping review maps what exists, and a living protocol creates a path to update when stronger trials arrive.",
          incorrect: "Speed cannot substitute for comparability. When outcomes and designs are fragmented, a pooled estimate will be unstable and may mislead decision-makers."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QS", title: "Scenario: Three Gates Check", xp: 30,
        scenario: "You are choosing a topic for the next review cycle. Topic A: 15 RCTs, but five high-quality reviews were published last year. Topic B: 2 small trials in a rare disease, outcomes differ. Topic C: 6 RCTs on a guideline decision with new harms data and no recent meta-analysis.",
        question: "Which topic passes all three gates?",
        options: [
          { letter: "A", text: "Topic A", correct: false },
          { letter: "B", text: "Topic B", correct: false },
          { letter: "C", text: "Topic C", correct: true },
          { letter: "D", text: "None of them", correct: false }
        ],
        feedback: {
          correct: "Correct. Topic C has decision value, feasible evidence, and a clear contribution (new harms data with no recent review).",
          incorrect: "Topic A fails contribution due to redundancy; Topic B fails evidence readiness. Topic C is the only one that clears all three gates."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Do not rush a question that has not ripened." }},
      { type: "quiz", theme: "dark", content: {
        question: "Why did many early pandemic meta-analyses give unstable answers?",
        options: [
          { text: "The statistical methods were invalid", correct: false },
          { text: "The evidence was immature and outcomes were inconsistent", correct: true },
          { text: "Meta-analysis cannot be used for infectious diseases", correct: false },
          { text: "Randomization was unnecessary", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. The topic was not ready: designs varied, outcomes differed, and many studies were underpowered. A stable answer requires a stable evidence field.",
          incorrect: "The methods were not the main problem. The evidence field was fragmented and immature, so any pooled estimate was likely to change as stronger trials appeared."
        }
      }}
    ]
  },
  {
    id: 2, title: "The Frame", subtitle: "Scope and boundaries", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Frame", subtitle: "Scope is the first method" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Control scope with PICO plus time, design, and setting",
          "Detect scope drift before it dilutes your findings",
          "Separate what is interesting from what is answerable",
          "Practice narrowing without biasing the outcome"
        ],
        tip: "The Cochrane exercise review asked 'Does exercise help depression?' 41 studies, no clear answer. A focused question on supervised aerobic exercise in major depression: 9 studies, actionable conclusion."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE WIDE NET", title: "When breadth becomes fog",
        text: "A team asked: 'Does exercise reduce depression?' They found 45 trials across aerobic, resistance, yoga, tai chi, dance, and mixed programs. Outcomes used 12 scales; follow-up ranged 2 to 52 weeks. The pooled estimate looked promising, but heterogeneity was extreme.",
        followup: "They reframed: 'In adults with major depressive disorder, do supervised aerobic programs of 8-12 weeks improve standardized symptom scores vs usual care?' The evidence set shrank to 9 comparable trials and the conclusion became usable."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Scope Drift Signals",
        stats: [
          { value: "8", label: "Intervention types" },
          { value: "12", label: "Outcome scales" },
          { value: "2-52", label: "Weeks of follow-up" },
          { value: "I2 > 70%", label: "Heterogeneity" }
        ],
        caption: "Simplified snapshot from exercise-depression trials in the literature."
      }},
      { type: "concept", theme: "dark", content: {
        title: "The Scope Dial",
        subtitle: "Turn it until it fits",
        text: "Define <strong>Population</strong>, <strong>Intervention</strong>, <strong>Comparator</strong>, <strong>Outcome</strong>, <strong>Time</strong>, <strong>Design</strong>, and <strong>Setting</strong>. Each dial you leave loose widens uncertainty.",
        highlight: "Broad questions create confusing answers. Narrow questions create usable answers."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Boundary Checklist",
        items: [
          "Population is explicit (age, condition, severity, setting)",
          "Intervention is defined (dose, format, supervision)",
          "Comparator is realistic (usual care, placebo, active)",
          "Primary outcome is chosen and measured consistently",
          "Time window aligns with the decision",
          "Design inclusion is justified (RCTs only or mixed)"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: The Time Window", xp: 25,
        scenario: "Your review is meant to inform a 6-month rehabilitation decision after surgery. Trials report outcomes at 2, 6, and 12 months.",
        question: "What is the best way to set the primary time window?",
        options: [
          { letter: "A", text: "Use the earliest time point for all studies", correct: false },
          { letter: "B", text: "Pre-specify 6 months as primary and treat other windows as secondary", correct: true },
          { letter: "C", text: "Average all time points together", correct: false },
          { letter: "D", text: "Choose the time point with the largest effect after seeing results", correct: false }
        ],
        feedback: {
          correct: "Correct. The time window should match the decision. Pre-specifying 6 months protects against cherry-picking and keeps the evidence aligned with the real-world choice.",
          incorrect: "Time windows change effect size. Without pre-specifying the primary time point, you risk bias and a mismatch with the decision the review is meant to inform."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Narrow the Frame", xp: 25,
        scenario: "Your draft question is: 'Do mental health apps improve mental health?'",
        question: "Which revision best tightens scope without biasing the answer?",
        options: [
          { letter: "A", text: "Keep it broad to avoid missing anything", correct: false },
          { letter: "B", text: "Adults with generalized anxiety using app-based CBT vs waitlist, 8-12 weeks", correct: true },
          { letter: "C", text: "Only include apps that show benefit in pilot studies", correct: false },
          { letter: "D", text: "Limit to any digital tool for any mental health outcome", correct: false }
        ],
        feedback: {
          correct: "Correct. Option B tightens population, intervention, comparator, and time without preselecting for benefit. That makes the evidence comparable and the answer actionable.",
          incorrect: "A tight frame does not bias results; it makes them interpretable. Options A and D are too broad, and C is biased because it preselects favorable evidence."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The frame shapes the story." }},
      { type: "quiz", theme: "dark", content: {
        question: "You find six different depression scales across trials. What is the best next step?",
        options: [
          { text: "Drop all trials using uncommon scales", correct: false },
          { text: "Define a primary outcome scale or use standardized mean difference", correct: true },
          { text: "Include all scales equally without adjustment", correct: false },
          { text: "Switch the topic to anxiety instead", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. Define the primary outcome or use standardized mean differences to align scales. Scope is not just about topic; it is about outcome consistency.",
          incorrect: "Outcome inconsistency is a scope problem. You need a strategy for alignment, not a random exclusion or a topic switch."
        }
      }}
    ]
  },
  {
    id: 3, title: "The Evidence Field", subtitle: "Feasibility and harvest", xp: 150,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Evidence Field", subtitle: "Is the field ready to be harvested?" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Run a scoping search that reveals feasibility",
          "Judge whether studies are comparable enough to pool",
          "Decide between meta-analysis, scoping review, or living review",
          "Avoid false precision from thin evidence"
        ],
        tip: "Before the Cochrane mask review, a scoping search revealed 67 existing studies—preventing duplicate effort and sharpening the question."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE PROMISE", title: "The rare disease dilemma",
        text: "A team wanted to meta-analyze a new therapy for a rare neuromuscular disease. Two small trials existed (n=38 and n=25). One measured a 6-minute walk test, the other used a functional rating scale. Follow-up windows differed.",
        followup: "Pooling produced a number but not a meaningful answer. The team published a scoping review and registered a living protocol, ready to update when new trials appear."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Feasibility Snapshot",
        stats: [
          { value: "2", label: "Randomized trials" },
          { value: "63", label: "Total participants" },
          { value: "0", label: "Shared outcomes" },
          { value: "18", label: "Months to next trial" }
        ],
        caption: "Simplified feasibility map from rare-disease trial registries."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Feasibility Triage",
        subtitle: "Ask before you pool",
        text: "A topic is feasible when you can answer: <br><br>1) At least 3 comparable studies? <br>2) Outcomes measured in compatible ways? <br>3) Effect sizes extractable? <br>4) Time windows similar enough to interpret?",
        highlight: "A beautiful statistic built on thin evidence is still thin."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Mixing Designs", xp: 25,
        scenario: "Your scoping search finds 3 RCTs and 5 observational studies on the same intervention, with different confounding risks.",
        question: "How should you handle study designs?",
        options: [
          { letter: "A", text: "Pool all studies together to maximize sample size", correct: false },
          { letter: "B", text: "Analyze RCTs separately and compare with observational findings", correct: true },
          { letter: "C", text: "Exclude RCTs because they are fewer", correct: false },
          { letter: "D", text: "Exclude observational studies without explanation", correct: false }
        ],
        feedback: {
          correct: "Correct. Different designs carry different bias structures. Separate analyses preserve interpretability and allow comparison without false precision.",
          incorrect: "Pooling incompatible designs can mask bias and produce misleading certainty. Handle designs separately and report differences transparently."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Choose the Right Review", xp: 30,
        scenario: "Your scoping search finds 1 RCT and 3 small observational studies. Outcomes differ and data are missing for two studies.",
        question: "What is the best next move?",
        options: [
          { letter: "A", text: "Proceed with a random-effects meta-analysis", correct: false },
          { letter: "B", text: "Publish a scoping review and register a living protocol", correct: true },
          { letter: "C", text: "Exclude the RCT and meta-analyze only observational studies", correct: false },
          { letter: "D", text: "Change the outcome until pooling works", correct: false }
        ],
        feedback: {
          correct: "Correct. The evidence base is too thin and inconsistent. A scoping review maps the field and a living protocol prepares you for future trials.",
          incorrect: "Pooling does not fix inconsistency or missing data. If feasibility criteria fail, the honest answer is to map the evidence and wait."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Feasibility Checklist",
        items: [
          "At least 3 comparable studies with similar outcomes",
          "Effect sizes and variances are extractable",
          "Study designs are not fundamentally incompatible",
          "Follow-up windows are aligned with the question",
          "Key subgroup data are available if needed",
          "Enough time and access to data to complete extraction"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Extractable Data", xp: 25,
        scenario: "You find 4 RCTs with the same outcome, but 2 report only medians without variance and the authors do not respond.",
        question: "What is the most defensible approach?",
        options: [
          { letter: "A", text: "Impute variances without documentation and pool all 4", correct: false },
          { letter: "B", text: "Pool only the 2 extractable trials and transparently report the limitation", correct: true },
          { letter: "C", text: "Invent a conversion formula and proceed without sensitivity checks", correct: false },
          { letter: "D", text: "Abandon the topic entirely", correct: false }
        ],
        feedback: {
          correct: "Correct. If key statistics are missing, you can only pool what is extractable and must report the limitation. Sensitivity analyses are possible if you justify any imputation.",
          incorrect: "Unverifiable imputation can create false precision. When data are missing, transparency and defensible choices matter more than a larger pooled N."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "Which condition most strongly suggests a topic is NOT ready for meta-analysis?",
        options: [
          { text: "Three small trials with compatible outcomes", correct: false },
          { text: "Multiple outcomes with a clear primary endpoint", correct: false },
          { text: "Only one study per outcome and no comparable measures", correct: true },
          { text: "Two trials plus a large ongoing trial", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. Without comparable outcomes, a pooled estimate is not meaningful. Feasibility fails when the evidence cannot be aligned.",
          incorrect: "Feasibility is about comparability and extractable data, not just the number of studies."
        }
      }}
    ]
  },
  {
    id: 4, title: "The Stakeholder", subtitle: "Impact and decision-use", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Stakeholder", subtitle: "A topic must serve a decision" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Align the question with a real decision and audience",
          "Prioritize patient-important outcomes over surrogates",
          "Recognize when trade-offs define the topic",
          "Translate evidence into practical thresholds"
        ],
        tip: "The GRADE guidelines specify: state who will use the evidence. A review for clinicians differs from one for policymakers."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "THE DECISION", title: "Aspirin for primary prevention",
        text: "For years, aspirin was assumed to prevent first heart attacks. Large trials and meta-analyses later showed small absolute reductions in nonfatal events but increased major bleeding. The net benefit depended on baseline risk and patient preferences.",
        followup: "The question that mattered was not 'Does aspirin change biomarkers?' but 'Do benefits outweigh harms for this population?' Topic selection turned evidence into a decision."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Benefit vs Harm (Illustrative)",
        stats: [
          { value: "0.5%", label: "Nonfatal MI reduction" },
          { value: "0.4%", label: "Major bleeding increase" },
          { value: "0.0%", label: "All-cause mortality change" },
          { value: "Risk", label: "Depends on baseline" }
        ],
        caption: "Illustrative ranges from large primary-prevention trials; simplified for teaching."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Decision Map",
        subtitle: "Who needs the answer and why?",
        text: "Name the stakeholder, the decision point, and the threshold: <br><br>? Clinicians: prescribe or not? <br>? Patients: accept trade-offs? <br>? Policymakers: fund or restrict? <br><br>Then choose outcomes that reflect what they value.",
        highlight: "If no one will act differently based on the answer, the topic is low-impact."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "IG", title: "Scenario: Outcome Alignment", xp: 25,
        scenario: "A guideline panel must decide whether to recommend screening for Condition X. Your proposed review focuses on changes in a lab biomarker.",
        question: "What is the best revision?",
        options: [
          { letter: "A", text: "Keep biomarkers because they change quickly", correct: false },
          { letter: "B", text: "Focus on patient-important outcomes (symptoms, hospitalization, mortality)", correct: true },
          { letter: "C", text: "Limit to short-term outcomes only", correct: false },
          { letter: "D", text: "Remove harms to keep the review simpler", correct: false }
        ],
        feedback: {
          correct: "Correct. Decision-makers need outcomes that matter to patients and systems, not just laboratory signals.",
          incorrect: "Biomarkers can mislead if they do not translate into outcomes people care about. High-impact topics must prioritize patient-important outcomes and harms."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "IG", title: "Scenario: Threshold Matters", xp: 25,
        scenario: "A hospital system will adopt an intervention only if it prevents at least 1 hospitalization per 100 patients per year. Trials report relative risk reductions without absolute rates.",
        question: "What should your topic framing prioritize?",
        options: [
          { letter: "A", text: "Only relative effect sizes to simplify reporting", correct: false },
          { letter: "B", text: "Absolute risk differences or number needed to treat", correct: true },
          { letter: "C", text: "Surrogate outcomes to increase precision", correct: false },
          { letter: "D", text: "Exclude harms to keep focus on benefit", correct: false }
        ],
        feedback: {
          correct: "Correct. Decision thresholds are absolute. Framing the topic to include baseline risk and absolute effects makes the review usable for the decision.",
          incorrect: "Relative effects can hide the practical impact. If a decision has a threshold, your topic must capture absolute effects and harms."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The question must serve a decision." }},
      { type: "quiz", theme: "dark", content: {
        question: "What most strongly makes a topic high-impact?",
        options: [
          { text: "It is popular on social media", correct: false },
          { text: "It informs a real decision with trade-offs", correct: true },
          { text: "It has the highest effect size", correct: false },
          { text: "It is easy to complete quickly", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. Impact comes from decisions and trade-offs, not popularity. A small effect can be high-impact if it changes practice.",
          incorrect: "Popularity and speed are not impact. The best topics change decisions or resolve trade-offs that matter to people."
        }
      }}
    ]
  },
  {
    id: 5, title: "The Echoes", subtitle: "Novelty and redundancy", xp: 150,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "The Echoes", subtitle: "Avoid repeating the same answer" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Detect when a topic is saturated with reviews",
          "Differentiate between update, replication, and redundancy",
          "Define a genuine contribution before you start",
          "Use overlap checks to justify a new review"
        ],
        tip: "By 2020, there were 500+ systematic reviews on vitamin D. Most added nothing. PROSPERO registration now helps prevent such waste."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE CROWD", title: "When reviews multiply but answers do not",
        text: "By 2021, mindfulness for anxiety had a flood of meta-analyses. Many pooled the same small set of trials but reported different conclusions. Policymakers saw contradiction, not clarity, because inclusion criteria and outcomes varied.",
        followup: "A new review only made sense when it added a clear contribution: updated trials, stricter bias assessment, or a different population."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Redundancy Snapshot",
        stats: [
          { value: "12", label: "Core trials" },
          { value: "22", label: "Meta-analyses" },
          { value: "90%", label: "Trial overlap" },
          { value: "4", label: "Effect metrics used" }
        ],
        caption: "Simplified snapshot from heavily reviewed behavioral topics."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Contribution Types",
        subtitle: "How to justify a new review",
        text: "A review is justified when it provides: <br><br>? <strong>Update:</strong> new trials change the estimate <br>? <strong>Reframe:</strong> a new population or setting <br>? <strong>Method upgrade:</strong> better bias tools or models <br>? <strong>Living review:</strong> fast-changing evidence",
        highlight: "If you cannot name the contribution in one sentence, the topic is likely redundant."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Novelty Test",
        items: [
          "Is the most recent high-quality review outdated?",
          "Are there new trials that could shift conclusions?",
          "Does your review answer a different population or setting?",
          "Will your methods improve on prior reviews?",
          "Have you checked overlap with existing reviews?"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "NH", title: "Scenario: Overlap Check", xp: 25,
        scenario: "You identify a high-quality review from last year. Your proposed review would include 18 of the same 20 trials and use the same outcomes.",
        question: "What is the best next step?",
        options: [
          { letter: "A", text: "Proceed anyway; more reviews increase confidence", correct: false },
          { letter: "B", text: "Stop unless you can define a new contribution", correct: true },
          { letter: "C", text: "Change the outcome after seeing trial results", correct: false },
          { letter: "D", text: "Exclude the two overlapping trials to appear novel", correct: false }
        ],
        feedback: {
          correct: "Correct. Without a clear contribution, a near-duplicate review adds noise. You need new evidence, a new population, or a method upgrade to justify proceeding.",
          incorrect: "High overlap without a new contribution creates redundancy. The goal is clarity, not volume."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "NH", title: "Scenario: Update or Redo?", xp: 25,
        scenario: "The last review on Topic Y was published in 2019 (15 trials). Since then, 6 new RCTs and a new risk-of-bias tool have appeared.",
        question: "What is the most defensible approach?",
        options: [
          { letter: "A", text: "Publish a new review without referencing the old one", correct: false },
          { letter: "B", text: "Conduct an update or living review with explicit comparison to prior results", correct: true },
          { letter: "C", text: "Avoid reviewing the topic entirely", correct: false },
          { letter: "D", text: "Repeat the old methods to stay consistent", correct: false }
        ],
        feedback: {
          correct: "Correct. The best contribution is an update that integrates new trials and improved methods while acknowledging prior results.",
          incorrect: "A new review must justify its contribution. Ignoring prior work or repeating old methods adds noise, not clarity."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "Which situation most justifies a new meta-analysis?",
        options: [
          { text: "Many similar reviews exist and no new trials have appeared", correct: false },
          { text: "A high-quality review is recent and comprehensive", correct: false },
          { text: "New trials and improved methods could change conclusions", correct: true },
          { text: "The topic is trending in the media", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. A genuine contribution comes from new evidence or improved methodology that could shift the answer.",
          incorrect: "Popularity does not justify redundancy. Without new evidence or better methods, the same review only multiplies confusion."
        }
      }}
    ]
  },
  {
    id: 6, title: "The Mirror", subtitle: "Bias and framing traps", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Mirror", subtitle: "Topic framing can hide as well as reveal" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Recognize how framing choices can introduce bias",
          "Include harms and trade-offs from the start",
          "Protect the question with protocol and transparency",
          "Identify conflicts that shape topic selection"
        ],
        tip: "The PRISMA checklist includes an 'Eligibility criteria' section—your explicit mirror showing what was included and excluded."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE FRAME", title: "COX-2 pain drugs and the missing outcome",
        text: "Early reviews of COX-2 pain drugs emphasized short-term pain relief and excluded longer follow-up. The pooled result showed clear benefit.",
        followup: "Later trials and surveillance revealed increased cardiovascular events, leading to withdrawals and warnings. The harm was not invisible; it was outside the chosen frame."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Framing Traps",
        subtitle: "How bias enters before analysis",
        text: "Common traps include: <br><br>? Excluding harms or long-term outcomes <br>? Choosing comparators that make the intervention look better <br>? Restricting populations to those most likely to benefit <br>? Shifting the primary outcome after seeing results",
        highlight: "If the frame is biased, no method can fully fix it."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "Scenario: Sponsor Pressure", xp: 30,
        scenario: "A sponsor suggests excluding trials that report serious adverse events because they are 'not the focus of the review.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Accept to keep the scope tight", correct: false },
          { letter: "B", text: "Include harms as pre-specified outcomes and document the decision", correct: true },
          { letter: "C", text: "Exclude harms but mention them in discussion", correct: false },
          { letter: "D", text: "Remove the sponsor from the author list", correct: false }
        ],
        feedback: {
          correct: "Correct. Harms belong in the frame. Pre-specifying them protects the review from selective reporting and preserves trust.",
          incorrect: "Excluding harms creates a biased frame. Transparency and pre-specification are the only defensible response."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Bias Guardrails",
        items: [
          "Declare funding and conflicts early",
          "Pre-specify outcomes, including harms",
          "Justify exclusions with transparent criteria",
          "Register a protocol before extraction",
          "Plan sensitivity analyses for risky assumptions"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "Scenario: Outcome Switch", xp: 25,
        scenario: "Midway through extraction, you notice a secondary outcome shows a larger benefit than your pre-specified primary outcome.",
        question: "What is the most defensible action?",
        options: [
          { letter: "A", text: "Switch the primary outcome to highlight the larger effect", correct: false },
          { letter: "B", text: "Keep the pre-specified primary outcome; report the secondary transparently", correct: true },
          { letter: "C", text: "Remove the original primary outcome entirely", correct: false },
          { letter: "D", text: "Delay protocol registration until after analysis", correct: false }
        ],
        feedback: {
          correct: "Correct. Pre-specification protects against selective emphasis. You can report secondary outcomes, but switching primary outcomes after seeing data is a framing bias.",
          incorrect: "Changing primary outcomes post hoc undermines trust. The integrity of the review depends on sticking to the pre-specified frame."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "A question can hide as well as reveal." }},
      { type: "quiz", theme: "dark", content: {
        question: "What is framing bias in topic selection?",
        options: [
          { text: "Using a random-effects model", correct: false },
          { text: "Choosing a scope that systematically excludes harms or unfavorable outcomes", correct: true },
          { text: "Including too many studies", correct: false },
          { text: "Publishing the protocol", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Correct. Framing bias occurs when the question is constructed to favor a result, often by excluding harms or difficult outcomes.",
          incorrect: "Framing bias is about how the question is built, not about statistical models or protocol registration."
        }
      }}
    ]
  },
  {
    id: 7, title: "The Topic Forge", subtitle: "Capstone and synthesis", xp: 180,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "The Topic Forge", subtitle: "Craft the question that holds" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Assemble a complete topic statement",
          "Apply the Three Gates in one decision",
          "Practice choosing among competing topics",
          "Leave with a reusable template"
        ],
        tip: "This capstone uses contrast and return (ring structure) to complete the narrative."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE STORY", title: "Two teams, two questions",
        text: "Two review teams started on the same day. Team A chose a broad, popular topic and wrote the protocol in a week. Team B paused to map the evidence, define outcomes, and identify decision-makers.",
        followup: "Months later, Team A had a pooled estimate no one could use. Team B delivered a focused answer that changed a guideline. The difference was not effort but framing."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Topic Statement Template",
        subtitle: "Fill every blank",
        text: "In <strong>[population]</strong>, does <strong>[intervention]</strong> vs <strong>[comparator]</strong> improve <strong>[primary outcome]</strong> at <strong>[time window]</strong>, and what harms are tracked?",
        highlight: "If you cannot fill every blank, the question is not ready."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Topic Readiness Test",
        items: [
          "Three Gates pass: decision value, evidence readiness, contribution",
          "PICO + time + design + setting are explicit",
          "Primary outcome and harms are pre-specified",
          "Feasibility confirmed by scoping search",
          "Contribution sentence is clear",
          "Protocol can be registered without major unknowns"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TF", title: "Scenario: Draft the Topic Statement", xp: 30,
        scenario: "You must write the topic statement for a review on hypertension management in older adults.",
        question: "Which statement is most ready to register?",
        options: [
          { letter: "A", text: "Do blood pressure drugs help older people?", correct: false },
          { letter: "B", text: "In adults 65+, does thiazide therapy vs ACE inhibitors reduce stroke at 12 months, and what harms occur?", correct: true },
          { letter: "C", text: "Which treatment is best for hypertension?", correct: false },
          { letter: "D", text: "Do any antihypertensives improve blood pressure?", correct: false }
        ],
        feedback: {
          correct: "Correct. This statement specifies population, intervention, comparator, outcome, time window, and harms. It is ready for protocol registration.",
          incorrect: "A topic statement must specify population, intervention, comparator, outcome, time, and harms. Vague questions are not ready for a protocol."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TF", title: "Scenario: Choose the Strongest Topic", xp: 40,
        scenario: "Pick the topic most ready for meta-analysis based on the evidence snapshot.",
        question: "Which topic passes all three gates?",
        options: [
          { letter: "A", text: "All digital health interventions for all chronic diseases", correct: false },
          { letter: "B", text: "Telemonitoring in heart failure (RCTs, 12-month readmissions, harms pre-specified)", correct: true },
          { letter: "C", text: "New gene therapy for a rare disease with one small trial", correct: false },
          { letter: "D", text: "Any supplement for fatigue in any population", correct: false }
        ],
        feedback: {
          correct: "Correct. Topic B is specific, feasible, and decision-relevant. The evidence base is clear enough to pool and the outcomes match the decision.",
          incorrect: "The strongest topic is specific, feasible, and decision-relevant. Broad or immature topics fail at least one gate."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Ask the question that can be answered." }},
      { type: "quiz", theme: "dark", content: {
        question: "Which gate is most likely to fail when a topic is popular but saturated with reviews?",
        options: [
          { text: "Decision value", correct: false },
          { text: "Evidence readiness", correct: false },
          { text: "Contribution", correct: true },
          { text: "Comparator clarity", correct: false }
        ],
        xp: 30,
        feedback: {
          correct: "Correct. When many high-quality reviews already exist, the contribution gate is closed unless you add new evidence or methods.",
          incorrect: "Popularity does not guarantee contribution. If existing reviews already answer the question, the contribution gate is closed."
        }
      }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('topicSelectionGame', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [] };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  document.getElementById('badgeModal').classList.add('show');
  if (celebrate) triggerConfetti();
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  document.getElementById('badgeModal').classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle, .hamburger, .mobile-menu-btn'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.synthesisCount || 0;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="badge-item ${earned ? 'earned' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${locked ? 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">T ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="Previous slide">←</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn" onclick="nextSlide()" aria-label="Next slide">→</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">← → arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} ${slide.content.warning ? 'warning' : ''} ${slide.content.teal ? 'teal' : ''} animate" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="decision-option ${isSelected ? 'selected' : ''} ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${answered ? 'disabled' : ''}"
                     onclick="answerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'Correct!' : 'Not quite'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
          </div>
        </div>
      </div>`;
      break;

    case 'quiz':
      const qid = `quiz_${moduleIndex}_${index}`;
      const qAnswered = gameState.answeredQuestions[qid];
      html += `<div class="content">
        <div class="quiz-container animate">
          <div class="quiz-question">${slide.content.question}</div>
          <div class="quiz-options">
            ${slide.content.options.map((opt, oi) => {
              const isSelected = qAnswered === oi;
              const showCorrect = qAnswered !== undefined && opt.correct;
              const showIncorrect = qAnswered !== undefined && isSelected && !opt.correct;
              return `
                <div class="quiz-option ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${qAnswered !== undefined ? 'disabled' : ''}"
                     onclick="answerQuiz('${qid}', ${oi}, ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${qAnswered !== undefined ? 'true' : 'false'}">
                  ${opt.text}
                </div>
              `;
            }).join('')}
          </div>
          <div class="quiz-feedback ${qAnswered !== undefined ? 'show' : ''} ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}
          </div>
        </div>
      </div>`;
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  container.querySelector('.nav-btn').disabled = currentSlide === 0;
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;
  gameState.synthesisCount = (gameState.synthesisCount || 0) + 1;

  if (gameState.decisionsCompleted === 1) awardBadge('first_question');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 15) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
  }
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

function answerQuiz(qid, choice, correct, xp) {
  if (gameState.answeredQuestions[qid] !== undefined) return;
  gameState.answeredQuestions[qid] = choice;

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
  } else {
    consecutiveCorrect = 0;
  }
  saveGame();
  renderSlides();
  updateComboDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 2) awardBadge('scope_shaper');
    if (mod.id === 3) awardBadge('evidence_scout');
    if (mod.id === 4) awardBadge('impact_guardian');
    if (mod.id === 5) awardBadge('novelty_hawk');
    if (mod.id === 6) awardBadge('bias_sentinel');
    if (mod.id === 7) awardBadge('topic_forger');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  }
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('badgeModal').classList.remove('show');
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }
  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('button, a, input, textarea, select');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }
  if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
  else if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
});

document.addEventListener('keydown', (e) => {
  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option') || e.target.classList.contains('quiz-option')) && e.key === 'Enter') {
    e.target.click();
  }
});

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) { diff > 0 ? nextSlide() : prevSlide(); }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
