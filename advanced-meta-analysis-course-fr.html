<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Advanced Meta-Analysis: Beyond the Basics</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&amp;family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
if (typeof Plotly === 'undefined') {
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id*="plot"], [id*="chart"], .plotly-graph-div, .js-plotly-plot').forEach(function(el) {
      el.innerHTML = '<div style="padding:2rem;text-align:center;background:#2a2a4a;border:1px dashed #D4AF37;border-radius:8px;color:#FAF8F5;margin:1rem 0;"><p style="font-size:1.1rem;margin-bottom:0.5rem;">Interactive chart unavailable offline</p><p style="font-size:0.85rem;opacity:0.7;">Connect to the internet to load interactive Plotly.js visualizations</p></div>';
    });
  });
}
</script>
<style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f5b6a;
      --purple: #7c3aed;
      --orange: #f59e0b;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }
    .course-container { display: flex; height: 100vh; overflow: hidden; }
    .sidebar {
      width: 320px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-header { padding: 1.5rem; border-bottom: 1px solid rgba(212,175,55,0.2); }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.4rem; font-weight: 700; color: var(--gold); margin-bottom: 0.25rem;
    }
    .sidebar-header p { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
    .sidebar-badge {
      display: inline-block; padding: 0.25rem 0.5rem;
      background: linear-gradient(135deg, var(--purple), #9333ea);
      border-radius: 4px; font-size: 0.65rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.5rem;
    }
    .module-list { flex: 1; overflow-y: auto; padding: 1rem 0; }
    .module-item {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.65rem 1.25rem; cursor: pointer; transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-number {
      width: 26px; height: 26px; border-radius: 50%;
      background: rgba(255,255,255,0.1); display: flex;
      align-items: center; justify-content: center;
      font-size: 0.75rem; font-weight: 600; flex-shrink: 0;
    }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.85rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.5); }
    .sidebar-footer { padding: 1rem; border-top: 1px solid rgba(212,175,55,0.2); }
    .progress-dashboard-btn {
      width: 100%; padding: 0.75rem;
      background: rgba(212,175,55,0.15); border: 1px solid rgba(212,175,55,0.3);
      border-radius: 8px; color: var(--gold); font-weight: 600; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;
    }
    .progress-bar-container { margin-top: 0.75rem; }
    .progress-label { font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 0.25rem; }
    .progress-bar { height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--purple), var(--gold)); border-radius: 3px; transition: width 0.3s; }
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .top-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(212,175,55,0.15);
    }
    .module-indicator { font-size: 0.9rem; color: rgba(255,255,255,0.7); }
    .overall-progress { font-size: 0.8rem; color: var(--gold); margin-left: 1rem; }
    .top-bar-actions { display: flex; gap: 0.75rem; }
    .top-bar-btn {
      padding: 0.5rem 1rem; background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 6px;
      color: var(--cream); font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
    }
    .top-bar-btn:hover { background: rgba(255,255,255,0.15); }
    .top-bar-btn.primary { background: var(--purple); border-color: var(--purple); }
    .slide-container { flex: 1; overflow-y: auto; padding: 2rem; }
    .slide { display: none; max-width: 1000px; margin: 0 auto; }
    .slide.active { display: block; }

    /* Storytelling Styles */
    .rhetoric-question {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.6rem; font-style: italic; color: var(--gold);
      text-align: center; padding: 2rem; line-height: 1.5;
      border-top: 1px solid rgba(212,175,55,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.3);
      margin: 1.5rem 0;
    }
    .contrast-container { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0; }
    .contrast-box {
      padding: 1.25rem; border-radius: 12px;
    }
    .contrast-box.wrong {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.1));
      border-left: 4px solid var(--red);
    }
    .contrast-box.right {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.1));
      border-left: 4px solid var(--green);
    }
    .contrast-title { font-weight: 700; margin-bottom: 0.5rem; }
    .contrast-box.wrong .contrast-title { color: var(--red); }
    .contrast-box.right .contrast-title { color: var(--green); }
    .oath-statement {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.4rem; color: var(--cream); text-align: center;
      padding: 1.5rem; background: rgba(0,0,0,0.3);
      border-radius: 8px; margin: 1rem 0; line-height: 1.6;
    }
    .oath-statement em { color: var(--gold); font-style: normal; }
    .revelation-sequence {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 12px; padding: 1.5rem; margin: 1rem 0;
    }
    .revelation-step {
      padding: 1rem; margin: 0.5rem 0;
      border-left: 3px solid rgba(255,255,255,0.2);
      transition: all 0.3s;
    }
    .revelation-step.revealed {
      border-left-color: var(--gold);
      background: rgba(212,175,55,0.1);
    }
    .revelation-step .step-number {
      font-size: 0.75rem; color: var(--gold);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.5rem;
    }
    .cycle-return {
      background: linear-gradient(135deg, rgba(124,58,237,0.2), rgba(212,175,55,0.1));
      border: 2px dashed rgba(212,175,55,0.4);
      border-radius: 12px; padding: 1.25rem; margin: 1.5rem 0;
      text-align: center;
    }
    .cycle-return .principle-recall {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.3rem; font-style: italic; color: var(--gold);
    }
    .vivid-consequence {
      background: linear-gradient(135deg, rgba(197,48,48,0.2), rgba(0,0,0,0.3));
      border-radius: 12px; padding: 1.5rem; margin: 1rem 0;
      border-left: 5px solid var(--red);
    }
    .vivid-consequence .death-toll {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.5rem; font-weight: 700; color: var(--red);
      text-align: center; margin: 1rem 0;
    }
    .vivid-consequence .toll-label {
      text-align: center; font-size: 0.9rem; color: rgba(255,255,255,0.7);
    }

    /* Standard content styles */
    .principle-display { text-align: center; margin-bottom: 2rem; }
    .principle-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2rem; font-style: italic; color: var(--gold); line-height: 1.4;
    }
    .slide-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.2rem; color: var(--gold); margin-bottom: 1.5rem; text-align: center;
    }
    .slide-content {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 12px; padding: 2rem;
    }
    .story-box {
      background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--purple);
      border-radius: 0 12px 12px 0; padding: 1.5rem; margin-bottom: 1.5rem;
    }
    .story-label {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--purple); margin-bottom: 0.5rem;
    }
    .story-text { font-size: 1.1rem; line-height: 1.7; color: var(--cream); }
    .story-hook {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.3rem; font-style: italic; color: var(--gold);
      margin-top: 1rem; padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    .method-box {
      background: linear-gradient(135deg, rgba(15,91,106,0.15), rgba(30,39,97,0.1));
      border-left: 4px solid var(--teal);
      border-radius: 0 12px 12px 0; padding: 1.5rem; margin: 1.5rem 0;
    }
    .method-label {
      font-size: 0.75rem; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--teal); margin-bottom: 0.5rem;
    }
    .method-content h3 { color: var(--cream); margin-bottom: 1rem; font-size: 1.2rem; }
    .method-content ul { margin-left: 1.5rem; color: rgba(255,255,255,0.85); }
    .method-content li { margin-bottom: 0.5rem; line-height: 1.5; }
    .tool-panel {
      background: var(--light-cream);
      border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; color: var(--text);
    }
    .tool-header {
      display: flex; align-items: center; gap: 0.75rem;
      margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--purple);
    }
    .tool-icon { font-size: 1.5rem; }
    .tool-title { font-weight: 700; font-size: 1.1rem; color: var(--navy); }
    .tool-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
    .tool-control { display: flex; flex-direction: column; gap: 0.25rem; }
    .tool-control label { font-size: 0.8rem; font-weight: 600; color: var(--navy); }
    .tool-control input, .tool-control select {
      padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9rem;
    }
    .tool-btn {
      padding: 0.6rem 1.25rem; background: var(--purple); color: white;
      border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
    }
    .tool-btn:hover { background: #6d28d9; }
    .plot-area { width: 100%; min-height: 400px; background: white; border-radius: 8px; }

    /* Warning boxes */
    .warning-box {
      background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(30,39,97,0.1));
      border: 2px solid var(--orange);
      border-radius: 12px; padding: 1.25rem; margin: 1rem 0;
    }
    .warning-box .warning-title {
      display: flex; align-items: center; gap: 0.5rem;
      font-weight: 700; color: var(--orange); margin-bottom: 0.5rem;
    }

    /* Clinical guide box */
    .clinical-guide {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.1));
      border: 2px solid var(--green);
      border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;
    }
    .clinical-guide .guide-title {
      display: flex; align-items: center; gap: 0.5rem;
      font-weight: 700; color: var(--green); margin-bottom: 1rem;
      font-size: 1.1rem;
    }
    .clinical-checklist { list-style: none; margin: 0; padding: 0; }
    .clinical-checklist li {
      padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; align-items: flex-start; gap: 0.5rem;
    }
    .clinical-checklist li::before {
      content: "‚úì"; color: var(--green); font-weight: 700;
    }

    /* Story deep dive */
    .story-deep {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.15));
      border-left: 4px solid var(--purple);
      border-radius: 0 16px 16px 0; padding: 1.5rem; margin: 1.5rem 0;
    }
    .story-timeline { position: relative; padding-left: 2rem; margin: 1rem 0; }
    .story-timeline::before {
      content: ''; position: absolute; left: 8px; top: 0; bottom: 0;
      width: 2px; background: rgba(255,255,255,0.2);
    }
    .timeline-event { position: relative; margin-bottom: 1.25rem; padding-left: 1rem; }
    .timeline-event::before {
      content: ''; position: absolute; left: -1.5rem; top: 0.35rem;
      width: 12px; height: 12px; border-radius: 50%;
      background: var(--gold); border: 2px solid rgba(255,255,255,0.3);
    }
    .timeline-event.crisis::before { background: var(--red); }
    .timeline-event.revelation::before { background: var(--green); }
    .timeline-year { font-weight: 700; color: var(--gold); font-size: 0.85rem; }
    .timeline-text { color: rgba(255,255,255,0.9); line-height: 1.5; margin-top: 0.25rem; }
    .real-data-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 12px; padding: 1.25rem; margin: 1rem 0;
    }
    .real-data-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1rem; padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .real-data-source { font-size: 0.75rem; color: rgba(255,255,255,0.6); }
    .real-data-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
    .real-data-stat { display: flex; flex-direction: column; }
    .real-data-stat .value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.4rem; font-weight: 700; color: var(--gold);
    }
    .real-data-stat .label { font-size: 0.8rem; color: rgba(255,255,255,0.7); }

    /* Quiz styles */
    .quiz-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0;
    }
    .quiz-question { font-size: 1.1rem; margin-bottom: 1rem; line-height: 1.5; }
    .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .quiz-option {
      padding: 0.75rem 1rem; background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .quiz-option:hover { background: rgba(255,255,255,0.1); }
    .quiz-option.selected { border-color: var(--gold); background: rgba(212,175,55,0.1); }
    .quiz-option.correct { border-color: var(--green); background: rgba(34,197,94,0.15); }
    .quiz-option.incorrect { border-color: var(--red); background: rgba(239,68,68,0.1); }
    .quiz-check-btn {
      margin-top: 1rem; padding: 0.75rem 1.5rem;
      background: var(--gold); color: var(--navy);
      border: none; border-radius: 6px; font-weight: 600; cursor: pointer;
    }
    .quiz-explanation {
      margin-top: 1rem; padding: 1rem;
      background: rgba(212,175,55,0.1); border-radius: 8px; display: none;
    }
    .quiz-explanation.visible { display: block; }

    /* Decision tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(30,39,97,0.1), rgba(20,27,61,0.15));
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 16px; padding: 1.5rem; margin: 1.5rem 0;
    }
    .decision-node {
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;
    }
    .decision-node.active { border-color: var(--gold); background: rgba(212,175,55,0.15); }
    .decision-question { font-size: 1.1rem; font-weight: 600; color: var(--cream); margin-bottom: 1rem; }
    .decision-branches { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-branch {
      display: flex; align-items: center; gap: 0.75rem;
      padding: 0.75rem 1rem; background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15); border-radius: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .decision-branch:hover { background: rgba(255,255,255,0.1); border-color: var(--gold); }
    .decision-branch.selected { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .branch-arrow {
      width: 24px; height: 24px; border-radius: 50%;
      background: rgba(212,175,55,0.3); display: flex;
      align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;
    }
    .decision-outcome {
      margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none;
    }
    .decision-outcome.visible { display: block; animation: fadeIn 0.3s ease; }
    .decision-outcome.good { background: rgba(34,197,94,0.15); border-left: 4px solid var(--green); }
    .decision-outcome.bad { background: rgba(197,48,48,0.15); border-left: 4px solid var(--red); }
    .decision-outcome.neutral { background: rgba(245,158,11,0.15); border-left: 4px solid var(--orange); }

    /* Scenario */
    .scenario-panel {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid rgba(124,58,237,0.4);
      border-radius: 16px; padding: 1.5rem; margin: 1.5rem 0;
    }
    .scenario-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
    .scenario-icon { font-size: 1.5rem; }
    .scenario-title { font-weight: 700; font-size: 1.1rem; color: var(--cream); }
    .scenario-situation {
      background: rgba(0,0,0,0.2); padding: 1rem;
      border-radius: 8px; margin-bottom: 1rem; line-height: 1.6;
    }
    .scenario-question { font-weight: 600; color: var(--gold); margin-bottom: 1rem; }
    .scenario-choices { display: flex; flex-direction: column; gap: 0.5rem; }
    .scenario-choice {
      display: flex; align-items: flex-start; gap: 0.75rem;
      padding: 0.75rem 1rem; background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15); border-radius: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .scenario-choice:hover { background: rgba(255,255,255,0.1); border-color: rgba(124,58,237,0.5); }
    .scenario-choice.correct { background: rgba(34,197,94,0.15); border-color: var(--green); }
    .scenario-choice.incorrect { background: rgba(239,68,68,0.1); border-color: var(--red); }
    .choice-letter {
      width: 24px; height: 24px; border-radius: 50%;
      background: rgba(124,58,237,0.3); display: flex;
      align-items: center; justify-content: center;
      font-weight: 700; font-size: 0.8rem; flex-shrink: 0;
    }
    .scenario-result { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; }
    .scenario-result.visible { display: block; }
    .scenario-result.good { background: rgba(34,197,94,0.15); border: 1px solid rgba(34,197,94,0.3); }
    .scenario-result.bad { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); }
    .scenario-result.neutral { background: rgba(245,158,11,0.15); border: 1px solid rgba(245,158,11,0.3); }

    /* Navigation */
    .slide-nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: rgba(0,0,0,0.2);
      border-top: 1px solid rgba(212,175,55,0.15);
    }
    .nav-btn {
      padding: 0.75rem 1.5rem; background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;
      color: var(--cream); font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .nav-btn:hover { background: rgba(255,255,255,0.15); }
    .nav-btn.primary { background: var(--gold); border-color: var(--gold); color: var(--navy); }
    .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .slide-counter { font-size: 0.9rem; color: rgba(255,255,255,0.6); text-align: center; }

    /* Dashboard */
    .dashboard-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .dashboard-overlay.open { display: flex; }
    .dashboard-panel {
      background: var(--light-cream); border-radius: 16px;
      width: 90%; max-width: 600px; max-height: 80vh;
      overflow-y: auto; color: var(--text);
    }
    .dashboard-header {
      padding: 1.5rem; background: linear-gradient(135deg, var(--purple), var(--teal));
      color: white; border-radius: 16px 16px 0 0; position: relative;
    }
    .dashboard-header h2 { font-family: 'Cormorant Garamond', Georgia, serif; margin-bottom: 0.5rem; }
    .close-btn {
      position: absolute; top: 1rem; right: 1rem;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,0.2); border: none;
      color: white; font-size: 1.2rem; cursor: pointer;
    }
    .dashboard-content { padding: 1.5rem; }
    .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    .stat-card { text-align: center; padding: 1rem; background: #f7fafc; border-radius: 8px; }
    .stat-card .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--navy); }
    .stat-card .stat-label { font-size: 0.75rem; color: var(--light-text); text-transform: uppercase; }

    /* Glossary */
    .glossary-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .glossary-overlay.open { display: flex; }
    .glossary-panel {
      background: var(--light-cream); border-radius: 16px;
      width: 90%; max-width: 700px; max-height: 80vh;
      overflow-y: auto; color: var(--text);
    }
    .glossary-header {
      padding: 1.5rem; background: var(--navy);
      color: white; border-radius: 16px 16px 0 0; position: relative;
    }
    .glossary-search {
      width: 100%; padding: 0.75rem; border: none;
      border-radius: 8px; font-size: 1rem; margin-top: 1rem;
    }
    .glossary-content { padding: 1.5rem; }
    .glossary-term { padding: 1rem 0; border-bottom: 1px solid #eee; }
    .glossary-term strong { color: var(--purple); }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-in { animation: fadeIn 0.4s ease; }
    .mobile-menu-toggle{display:none;position:fixed;top:12px;left:12px;z-index:1001;background:#1E2761;border:1px solid #D4AF37;color:#D4AF37;width:40px;height:40px;border-radius:8px;font-size:1.2rem;cursor:pointer;align-items:center;justify-content:center;}
    @media(max-width:768px){.mobile-menu-toggle{display:flex;}.sidebar{transform:translateX(-100%);transition:transform 0.3s ease;position:fixed;z-index:1000;height:100vh;}.sidebar.open{transform:translateX(0);}.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:999;}.sidebar-overlay.show{display:block;}}
    .skip-link{position:absolute;top:-40px;left:0;background:#D4AF37;color:#1E2761;padding:8px 16px;z-index:100;transition:top 0.3s;font-family:'Source Sans Pro',sans-serif;text-decoration:none;font-weight:600;}.skip-link:focus{top:0;}

    /* Focus-visible styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    button:focus-visible,
    a:focus-visible,
    [role="button"]:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
    }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
    }
  </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<button aria-expanded="false" aria-label="Toggle navigation menu" class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
<div class="sidebar-overlay" onclick="document.querySelector('.sidebar').classList.remove('open');this.classList.remove('show');"></div>
<div class="course-container">
<nav class="sidebar">
<div class="sidebar-header">
<a href="index.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;">‚Üê Course Library</a>
<h1>Advanced Meta-Analysis</h1>
<p>Au-del√† des bases</p>
<span class="sidebar-badge">Advanced Level</span>
</div>
<div aria-label="Navigation dans les cours" class="module-list" id="moduleList"></div>
<div class="sidebar-footer">
<button class="progress-dashboard-btn" onclick="openDashboard()">
<span>üìä Progress Dashboard</span>
<span id="sidebarPoints">0 pts</span>
</button>
<div class="progress-bar-container">
<div class="progress-label">Progress: <span id="progressPercent">0%</span></div>
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>
</div>
</div>
</nav>
<main class="main-content" id="main-content">
<div class="top-bar">
<div>
<span class="module-indicator" id="moduleIndicator">Module 0¬†: La passerelle</span>
<span class="overall-progress" id="overallProgress">Overall: 0%</span>
</div>
<div class="top-bar-actions">
<button class="top-bar-btn" onclick="openGlossary()">üìñ Glossary</button>
<button class="top-bar-btn primary" onclick="goToNextModule()">Next Module ‚Üí</button>
</div>
</div>
<div class="slide-container" id="slideContainer"></div>
<div class="slide-nav">
<button class="nav-btn" id="prevBtn" onclick="prevSlide()">‚Üê Previous</button>
<div class="slide-counter">
<span id="slideCounter">1 / 10</span>
</div>
<button class="nav-btn primary" id="nextBtn" onclick="nextSlide()">Next ‚Üí</button>
</div>
</main>
</div>
<!-- Dashboard -->
<div class="dashboard-overlay" id="progressDashboard">
<div class="dashboard-panel">
<div class="dashboard-header">
<button class="close-btn" onclick="closeDashboard()">√ó</button>
<h2>Your Progress</h2>
<p id="levelBadge">Level 1: Apprentice Methodologist</p>
</div>
<div class="dashboard-content">
<div class="stat-grid">
<div class="stat-card">
<div class="stat-value" id="totalPoints">0</div>
<div class="stat-label">Points</div>
</div>
<div class="stat-card">
<div class="stat-value" id="modulesCompleted">0/9</div>
<div class="stat-label">Modules</div>
</div>
<div class="stat-card">
<div class="stat-value" id="toolsUsed">0</div>
<div class="stat-label">Tools Used</div>
</div>
</div>
</div>
</div>
</div>
<!-- Glossary -->
<div class="glossary-overlay" id="glossaryOverlay">
<div class="glossary-panel">
<div class="glossary-header">
<button class="close-btn" onclick="closeGlossary()">√ó</button>
<h2>Glossary of Terms</h2>
<input class="glossary-search" id="glossarySearch" oninput="filterGlossary()" placeholder="Search terms..." type="text"/>
</div>
<div class="glossary-content" id="glossaryContent"></div>
</div>
</div>
<script>
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.sidebar-overlay');
  const toggle = document.querySelector('.mobile-menu-toggle');
  if (!sidebar) return;
  const isOpen = sidebar.classList.toggle('open');
  if (overlay) overlay.classList.toggle('show', isOpen);
  if (toggle) toggle.setAttribute('aria-expanded', String(isOpen));
}

// ============================================================
// GLOSSARY DATA
// ============================================================
const glossaryTerms = [
  { term: "Network Meta-Analysis (NMA)", def: "Une m√©thode statistique qui combine des preuves directes et indirectes pour comparer plusieurs traitements simultan√©ment, m√™me lorsqu'il n'existe pas d'essais comparatifs." },
  { term: "Transitivity", def: "L'hypoth√®se selon laquelle les patients dans diff√©rentes comparaisons sont suffisamment similaires (√©changeables) pour que les comparaisons indirectes via des comparateurs partag√©s soient valides. Il ne s'agit PAS d'une propri√©t√© math√©matique¬†: il s'agit de populations de patients." },
  { term: "Consistency", def: "Accord entre les preuves directes (issues d'essais comparatifs) et les preuves indirectes (d√©duites via le r√©seau). Une incoh√©rence signale des probl√®mes potentiels." },
  { term: "SUCRA", def: "Surface sous la courbe de classement cumulatif. Une m√©trique de classement bas√©e sur les probabilit√©s dans NMA. AVERTISSEMENT¬†: peut √™tre trompeur lorsque les traitements ont des intervalles cr√©dibles qui se chevauchent." },
  { term: "IPD Meta-Analysis", def: "M√©ta-analyse des donn√©es individuelles des patients. Utilise des donn√©es brutes au niveau des patients au lieu de r√©sum√©s publi√©s. Norme de r√©f√©rence pour la d√©tection des effets de sous-groupes." },
  { term: "One-stage vs Two-stage", def: "Two approaches to IPD analysis. One-stage models all patients together; two-stage analyzes each study then combines. One-stage better separates within-study from across-study effects." },
  { term: "Ecological Fallacy", def: "L'erreur consistant √† supposer que les associations au niveau de l'√©tude refl√®tent les relations au niveau du patient. Une √©tude men√©e aupr√®s de patients plus √¢g√©s montrant des effets moindres ne signifie pas que les personnes √¢g√©es en b√©n√©ficient moins." },
  { term: "HSROC", def: "Courbe ROC r√©capitulative hi√©rarchique. Mod√©lise la courbe ROC sous-jacente dans la m√©ta-analyse de l'exactitude des tests de diagnostic, en tenant compte de la variation du seuil entre les √©tudes." },
  { term: "Bivariate Model", def: "Dans la m√©ta-analyse DTA, mod√©lise conjointement la sensibilit√© et la sp√©cificit√©, en reconnaissant qu'elles sont corr√©l√©es (n√©gativement) entre les √©tudes en raison des diff√©rences de seuil." },
  { term: "Prior Distribution", def: "Dans l'analyse bay√©sienne, repr√©sente ce que nous croyions avant de voir les donn√©es. Combin√© avec la probabilit√© (donn√©es) pour produire une valeur post√©rieure (croyance mise √† jour)." },
  { term: "Posterior Distribution", def: "Dans l'analyse bay√©sienne, la distribution de probabilit√© mise √† jour apr√®s avoir combin√© les croyances ant√©rieures avec les donn√©es observ√©es. Permet des d√©clarations de probabilit√© directes." },
  { term: "MASEM", def: "Mod√©lisation d'√©quations structurelles m√©ta-analytiques. Regroupe les matrices de corr√©lation entre les √©tudes, puis ajuste le SEM pour tester les voies th√©oriques et la m√©diation." },
  { term: "Dose-Response Meta-Analysis", def: "Mod√©lise la relation entre l'exposition/le niveau de dose et le r√©sultat, plut√¥t que de simples comparaisons ¬´¬†expos√©/non expos√©¬†¬ª." },
  { term: "Greenland-Longnecker Method", def: "Technique d'AM dose-r√©ponse qui prend correctement en compte la corr√©lation entre les estimations sp√©cifiques √† la dose au sein des √©tudes partageant une r√©f√©rence commune. groupe." },
  { term: "Umbrella Review", def: "Une revue syst√©matique des revues/m√©ta-analyses syst√©matiques. √âvalue le chevauchement, l'accord et applique des crit√®res de cr√©dibilit√© pour cartographier un paysage de preuves." },
  { term: "GRADE-NMA / CINeMA", def: "Extensions de GRADE pour la m√©ta-analyse de r√©seau. Ajoutez des domaines d'intransitivit√© et d'incoh√©rence aux cinq domaines GRADE standard." },
  { term: "Prediction Interval", def: "Plage dans laquelle le v√©ritable effet dans une NOUVELLE √©tude/un NOUVEAU contexte se situerait probablement. Plus large que l'intervalle de confiance, car il int√®gre l'h√©t√©rog√©n√©it√©." },
  { term: "Node-splitting", def: "Technique to check NMA consistency by comparing direct vs indirect estimates for each comparison separately." }
];

// ============================================================
// ADVANCED PRINCIPLES - NARRATIVE STORYTELLING STYLE
// ============================================================
const advancedPrinciples = [
  { num: 1, text: "The network reveals what pairs cannot see", short: "Network" },
  { num: 2, text: "In each patient lies a truth the average conceals", short: "IPD" },
  { num: 3, text: "To diagnose is not to treat; the curve tells what the number hides", short: "DTA" },
  { num: 4, text: "Ce que vous saviez auparavant a sa place dans la table des preuves", short: "Bayesian" },
  { num: 5, text: "La voie √©claire ce que le point final obscurcit", short: "MASEM" },
  { num: 6, text: "La dose fait le poison et le rem√®de", short: "Dose-Response" },
  { num: 7, text: "Pour synth√©tiser des synth√®ses, il faut d'abord savoir quoi vous ne savez pas", short: "Umbrella" }
];

// ============================================================
// MODULES DATA - NARRATIVE STORYTELLING STYLE
// ============================================================
const modules = [
  // MODULE 0: THE GATEWAY
  {
    id: 0,
    title: "The Gateway",
    subtitle: "Beyond Pairwise Comparison",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "Advanced Meta-Analysis",
          subtitle: "M√©thodes de synth√®se de preuves complexes",
          text: "Vous ma√Ætrisez les bases. Apprenez maintenant les m√©thodes qui r√©pondent √† des questions que les bases ne peuvent pas aborder."
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "N'avez-vous pas pens√© au clinicien qui a √©t√© confront√© √† vingt et un antid√©presseurs et aucun moyen de choisir entre eux¬†?"
        }
      },
      {
        type: 'story',
        content: {
          label: "L'HISTOIRE DU CHOIX IMPOSSIBLE",
          text: "In 2009, a psychiatrist stood before her patient. Twenty-one antidepressants lay available. Traditional meta-analyses compared each to placebo‚Äîbut placebo was not the question. She needed to know: which drug for THIS patient? Five hundred trials existed. None compared all twenty-one. The evidence was scattered across isolated pairwise prisons, each trial a locked cell that could not speak to its neighbors.",
          hook: "Et si les cellules pouvaient √™tre connect√©es¬†? Et si les preuves comparant A √† B et B √† C pouvaient parler de A contre C ? C'est la promesse que vous apprendrez √† tenir."
        }
      },
      {
        type: 'content',
        content: {
          title: "Les sept principes avanc√©s",
          sections: [
            {
              heading: "What You Will Master:",
              items: [
                "1. LE R√âSEAU ‚Äî Lorsque les paires ne peuvent pas voir, le r√©seau r√©v√®le",
                "2. L'INDIVIDU ‚Äî Chez chaque patient se trouve la v√©rit√© que la moyenne cache",
                "3. LE DIAGNOSTIC ‚Äî La courbe raconte ce que cache le chiffre unique",
                "4. LE PRIOR ‚Äî Ce que vous saviez avant appartient √† la table",
                "5. LA VOIE ‚Äî Les m√©canismes comptent, pas seulement les points finaux",
                "6. LA DOSE ‚Äî La forme de la courbe, pas seulement les avantages ou les inconv√©nients",
                "7. THE UMBRELLA ‚Äî Synthesis of syntheses requires humility"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Avant de commencer",
          sections: [
            {
              heading: "Prerequisites ‚Äî Do not proceed without these:",
              items: [
                "‚úì Vous comprenez la m√©ta-analyse des effets fixes et al√©atoires",
                "‚úì You can interpret forest plots, funnel plots, heterogeneity metrics",
                "‚úì Vous connaissez le cadre GRADE pour l'√©valuation de la certitude",
                "‚úì Vous avez effectu√© une recherche syst√©matique et le risque de biais √©valuation",
                "‚úì Vous ressentez le poids de la responsabilit√© qui accompagne la synth√®se"
              ]
            }
          ]
        }
      },
      {
        type: 'oath',
        content: {
          text: "By the <em>522 trials</em> that Cipriani synthesized, by the <em>450,000 women</em> whose data EBCTCG gathered, by the <em>50,000 deaths</em> that flawed synthesis has caused ‚Äî you will learn these methods not for cleverness, but for the patients whose lives depend on your rigor."
        }
      }
    ]
  },

  // MODULE 1: THE NETWORK
  {
    id: 1,
    title: "The Network",
    subtitle: "Network Meta-Analysis",
    principle: 0,
    slides: [
      {
        type: 'principle',
        content: {
          text: "The network reveals what pairs cannot see"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "N'avez-vous pas r√©fl√©chi √† la fa√ßon dont Cipriani a class√© 21 antid√©presseurs, alors qu'aucun essai ne les a tous compar√©s¬†? Chaque m√©dicament a √©t√© test√© contre un placebo, et le placebo a √©tabli un lien entre ce que les essais comparatifs n'ont jamais fait."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA R√âV√âLATION¬†: LE R√âSEAU DE CIPRIANI",
          source: "Lancet 2018; 391:1357-1366 | 522 trials | 116,477 patients",
          timeline: [
            { year: "The Darkness", text: "Twenty-one antidepressants. Hundreds of trials. No single study compared them all. Clinicians prescribed by habit, by marketing, by guess.", type: "normal" },
            { year: "2009", text: "Cipriani relie 117 essais via des comparateurs partag√©s. Le premier r√©seau r√©v√®le : certains m√©dicaments sont clairement meilleurs. Le classement impossible devient possible.", type: "revelation" },
            { year: "2018", text: "The network expands: 522 trials, 116,477 patients. Every drug compared to every other. Agomelatine, escitalopram, mirtazapine rise. Reboxetine, trazodone fall.", type: "revelation" },
            { year: "The Light", text: "Guidelines worldwide update. Patients receive better drugs. What individual trials could never show, the network revealed.", type: "revelation" }
          ],
          realData: {
            trials: "522 double-blind RCTs",
            patients: "116,477",
            treatments: "21 antidepressants",
            topEfficacy: "Amitriptyline (OR 2.13)",
            topTolerability: "Agomelatine (dropout OR 0.84)"
          },
          hook: "Consider: No single trial compared amitriptyline to agomelatine. Yet through the network of shared comparators, their relative merits emerged. The network saw what no pair could see."
        }
      },
      {
        type: 'contrast',
        content: {
          title: "Two Understandings of Transitivity",
          wrong: {
            title: "L'erreur math√©matique",
            text: "If A > B and B > C, then A > C. Simple algebra! Just connect the comparisons mathematically."
          },
          right: {
            title: "LA VRAIE COMPR√âHENSION",
            text: "La transitivit√© concerne les PATIENTS, pas les chiffres. Les patients des essais A-vs-B sont-ils √©changeables avec les patients des essais B-vs-C¬†? Auraient-ils pu √™tre inscrits dans l‚Äôun ou l‚Äôautre ? Sinon, la connexion √©choue."
          }
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA VIOLATION DE TRANSITIVIT√â¬†: THROMBOLYTIQUE",
          source: "D√©fini¬†: Caldwell et al. BMJ 2005 ‚Äî Le cas qui a d√©fini l'intransitivit√©",
          timeline: [
            { year: "The Setup", text: "M√©ta-analyse en r√©seau des thrombolytiques pour l'IM aigu. Plusieurs m√©dicaments compar√©s √† la streptokinase (SK), certains les uns aux autres. Le r√©seau devrait r√©v√©ler le meilleur agent.", type: "normal" },
            { year: "The Finding", text: "Preuve directe¬†: le tPA vs SK dans les essais ISIS-3 et GISSI-2 n'ont montr√© AUCUNE diff√©rence. Des preuves indirectes provenant d'autres comparaisons sugg√®rent que le tPA est MIEUX que le SK.", type: "normal" },
            { year: "The Explanation", text: "ISIS-3 et GISSI-2 ont administr√© du tPA sous forme de perfusion lente sans h√©parine. D'autres essais ont utilis√© du tPA acc√©l√©r√© AVEC de l'h√©parine. Le ¬´¬†m√™me traitement¬†¬ª √©tait en fait des traitements DIFF√âRENTS.", type: "crisis" },
            { year: "The Lesson", text: "Transitivity failed because trial designs differed systematically. Patients weren't exchangeable‚Äîprotocols weren't comparable. The network's indirect path saw a DIFFERENT drug.", type: "revelation" }
          ],
          realData: {
            directRR: "tPA vs SK direct: RR 1.00 (0.91-1.10)",
            indirectRR: "tPA vs SK indirect: RR 0.77 (0.65-0.92)",
            inconsistency: "p = 0.007 for disagreement",
            cause: "Protocol differences (infusion rate, heparin use)"
          },
          hook: "Le r√©seau a vu ce qui n'√©tait pas l√† car il a connect√© des essais qui NE DEVRAIENT PAS l'√™tre. La transitivit√© concerne la comparabilit√© clinique, et non la connexion statistique."
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "Conducting Network Meta-Analysis",
          sections: [
            {
              heading: "√âtape 1¬†: Cartographier le r√©seau",
              text: "Identify all treatments. Define what counts as 'same' (doses? formulations?). Draw the network: nodes are treatments, edges are direct comparisons. A dense network with many connections is strong. A sparse star (all vs placebo) relies heavily on transitivity."
            },
            {
              heading: "Step 2: Assess Transitivity (BEFORE analysis)",
              text: "Plot patient characteristics across comparisons. Do A-vs-B trials enroll similar patients as B-vs-C trials? Check: age, severity, comorbidities, setting, outcome timing. If they differ systematically, the network may mislead."
            },
            {
              heading: "√âtape 3¬†: Ajuster le mod√®le",
              text: "Effets al√©atoires pour tenir compte de l'h√©t√©rog√©n√©it√©. Les approches bay√©siennes g√®rent naturellement la structure hi√©rarchique complexe. Le mod√®le estime TOUTES les comparaisons par paires simultan√©ment."
            },
            {
              heading: "Step 4: Check Consistency (AFTER analysis)",
              text: "Node-splitting: For each comparison with both direct and indirect evidence, compare them. If they disagree substantially, transitivity is violated somewhere. Report the disagreement‚Äîdon't hide it."
            },
            {
              heading: "√âtape 5¬†: Classer avec humilit√©",
              text: "SUCRA ou les scores P r√©sument les classements. MAIS¬†: les classements avec des intervalles cr√©dibles qui se chevauchent ne sont PAS significativement diff√©rents. Indiquez la distribution post√©rieure compl√®te. Ne pr√©tendez jamais que ¬´ le m√©dicament X est le meilleur ¬ª lorsque l'incertitude s'√©tend sur plusieurs rangs."
            }
          ]
        }
      },
      {
        type: 'warning',
        content: {
          title: "‚ö†Ô∏è LE PI√àGE DE SUCRA",
          text: "SUCRA values can look decisive when they're not. Drug A: SUCRA 78%. Drug B: SUCRA 72%. The naive say 'A is better!' But if their 95% credible intervals for rank both span 1-8, the difference is noise. ALWAYS examine the rank probability distribution. NEVER report SUCRA without credible intervals."
        }
      },
      {
        type: 'tool-network',
        content: {
          id: 'network-visualizer',
          title: "Network Geometry Visualizer",
          description: "Build and analyze treatment networks. See how connections enable indirect comparisons."
        }
      },
      {
        type: 'decision-tree',
        content: {
          title: "Le dilemme de l'incoh√©rence",
          situation: "You've completed a network meta-analysis of five blood pressure medications. Node-splitting reveals a problem: Direct evidence for Drug A vs B: RR 0.72 (0.60-0.87) ‚Äî A strongly better. Indirect evidence for Drug A vs B: RR 1.15 (0.95-1.39) ‚Äî B possibly better. These estimates point in OPPOSITE directions.",
          nodes: [
            {
              id: 'start',
              question: "Vous avez d√©couvert une incoh√©rence majeure. Votre classement place le m√©dicament A au premier rang. Que faites-vous¬†?",
              branches: [
                { id: 'a', text: "Rapportez le classement¬†: l'estimation mitig√©e √©quilibre tout", nextNode: 'ignore' },
                { id: 'b', text: "Investigate why direct and indirect disagree", nextNode: 'investigate' },
                { id: 'c', text: "Report only direct evidence ‚Äî indirect is clearly wrong", nextNode: 'direct_only' }
              ]
            },
            {
              id: 'ignore',
              type: 'outcome',
              consequence: 'bad',
              title: "The Reckoning",
              text: "Your NMA is published. Three years later, a large head-to-head trial confirms A vs B: RR 1.18 ‚Äî matching the INDIRECT estimate. Your ranking was wrong. Why? The A-vs-placebo trials enrolled healthier patients than B-vs-placebo trials. Transitivity was violated. The network lied because you didn't listen to its warning.",
              realCase: "Les v√©ritables NMA ont √©t√© annul√©es lorsque l'incoh√©rence a √©t√© ignor√©e. La contradiction interne du r√©seau √©tait un appel √† l'enqu√™te."
            },
            {
              id: 'investigate',
              question: "You examine the trials. Discovery: Direct A vs B trials enrolled mild hypertension (BP 140-160). Indirect path used severe hypertension (BP > 180). The PATIENTS differed.",
              branches: [
                { id: 'd', text: "Transitivity is violated ‚Äî stratify by severity", nextNode: 'stratify' },
                { id: 'e', text: "Direct evidence has fewer patients ‚Äî trust indirect", nextNode: 'wrong_choice' }
              ]
            },
            {
              id: 'stratify',
              type: 'outcome',
              consequence: 'good',
              title: "La v√©rit√© nuanc√©e",
              text: "You report: 'In mild hypertension (direct evidence): A superior to B, RR 0.72. In severe hypertension (indirect evidence): B may be superior, RR 0.87.' The network revealed effect modification. Your stratified analysis becomes a guide for personalized treatment.",
              realCase: "Cipriani's antidepressant NMA found efficacy rankings differed by baseline severity ‚Äî visible only through careful exploration of inconsistency."
            },
            {
              id: 'wrong_choice',
              type: 'outcome',
              consequence: 'bad',
              title: "Le jeu des chiffres",
              text: "Plus de patients ne signifie pas de meilleures preuves. La voie indirecte compte plus de patients mais repose sur la transitivit√©. Si les patients diff√®rent, plus de donn√©es signifient des donn√©es plus biais√©es, et non de meilleures donn√©es. Vous avez confondu pr√©cision et validit√©.",
              realCase: "Les essais DECREASE ont recrut√© des milliers de personnes et ont √©t√© fabriqu√©s de toutes pi√®ces. La taille de l'√©chantillon ne garantit rien de la v√©rit√©."
            },
            {
              id: 'direct_only',
              type: 'outcome',
              consequence: 'neutral',
              title: "La retraite prudente",
              text: "Vous signalez uniquement les r√©sultats par paires, reconnaissant que les hypoth√®ses de la NMA n'ont pas √©t√© respect√©es. Votre article est moins percutant mais plus honn√™te. La question clinique reste ouverte, mais vous n'avez pas apport√© de fausse r√©ponse. Parfois, le r√©seau nous apprend ce que nous ne pouvons pas encore savoir.",
              realCase: "Some methodologists argue this is correct when transitivity fails. Others argue exploring WHY it fails is more valuable."
            }
          ]
        }
      },
      {
        type: 'clinical-guide',
        content: {
          title: "How to Read an NMA for Clinical Practice",
          items: [
            "Trouvez la TABLE DE LIGUE¬†: elle montre toutes les comparaisons par paires. Lisez les lignes et les colonnes.",
            "Check CONSISTENCY: Look for node-splitting results. Major disagreements = less trustworthy.",
            "Examine RANKINGS with skepticism: Look at credible intervals, not just SUCRA. If treatments' intervals overlap, they're clinically similar.",
            "Note NETWORK GEOMETRY: Star networks (all vs placebo) rely heavily on transitivity. Well-connected networks are more robust.",
            "Consider TRANSITIVITY: Were similar patients enrolled across comparisons? If the paper doesn't discuss this, be cautious.",
            "Apply GRADE-NMA / CINeMA: Rate certainty using domains including intransitivity and incoherence."
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "Le r√©seau r√©v√®le ce que les paires ne peuvent pas voir, mais uniquement lorsque les patients des comparaisons sont √©changeables. Le r√©seau est aussi fort que son hypoth√®se la plus faible."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "In network meta-analysis, 'inconsistency' refers to:",
          options: [
            { id: 'a', text: "Heterogeneity in effect sizes across trials of the same comparison", correct: false },
            { id: 'b', text: "D√©saccord entre les preuves directes et indirectes pour la m√™me comparaison", correct: true },
            { id: 'c', text: "Variation in sample sizes across the network", correct: false },
            { id: 'd', text: "Differences in outcome definitions across trials", correct: false }
          ],
          explanation: "Inconsistency is the disagreement between what direct head-to-head trials tell us and what we infer through the network. When direct and indirect evidence conflict, transitivity may be violated ‚Äî the network's connections may not be valid. This is different from heterogeneity (variation within a comparison) and signals potential problems with the network's structure."
        }
      }
    ]
  },

  // MODULE 2: THE INDIVIDUAL (IPD)
  {
    id: 2,
    title: "The Individual",
    subtitle: "IPD Meta-Analysis",
    principle: 1,
    slides: [
      {
        type: 'principle',
        content: {
          text: "In each patient lies a truth the average conceals"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "N'avez-vous pas r√©fl√©chi √† la fa√ßon dont l'EBCTCG a d√©couvert que le b√©n√©fice du tamoxif√®ne doublait chez les patients ER-positifs - une v√©rit√© invisible dans les r√©sum√©s publi√©s, r√©v√©l√©s uniquement lorsqu'ils ont obtenu des donn√©es sur 37 000 individus. les femmes¬†?"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "L'√âTAT D'OR¬†: EBCTCG",
          source: "Early Breast Cancer Trialists' Collaborative Group | 460+ trials | 450,000+ women",
          timeline: [
            { year: "1985", text: "Richard Peto propose l'impossible¬†: collecter des donn√©es individuelles sur les patientes de TOUS les essais sur le cancer du sein dans le monde. Les collaborateurs rient. La logistique d√©fie l'imagination.", type: "normal" },
            { year: "1988", text: "First overview published. 28,000 women, 61 trials. IPD reveals what aggregate could not: Tamoxifen works ONLY in ER-positive tumors. Aggregate said 'tamoxifen works.' IPD said 'for WHOM.'", type: "revelation" },
            { year: "1995", text: "Polychemotherapy overview: 18,000 women. Age matters: chemo reduces mortality 27% under age 50, only 11% over 50. Published trials showed 'average' benefit. IPD showed differential truth.", type: "revelation" },
            { year: "Today", text: "460+ trials, 450,000+ women. The definitive source for breast cancer treatment evidence. What Peto's impossible vision became: proof that individual data reveals what aggregates hide.", type: "revelation" }
          ],
          realData: {
            trials: "460+ worldwide",
            patients: "450,000+ individual records",
            tamoxifen_ER_pos: "HR 0.61 (strong benefit)",
            tamoxifen_ER_neg: "HR 0.97 (no benefit)",
            invisible: "Cet effet de sous-groupe √©tait INVISIBLE dans les donn√©es agr√©g√©es"
          },
          hook: "Consider the woman with ER-negative breast cancer who took tamoxifen for five years because aggregate meta-analysis said 'it works.' IPD revealed: for her, it worked not at all. The aggregate concealed what the individual data would have shown."
        }
      },
      {
        type: 'contrast',
        content: {
          title: "Deux types de preuves",
          wrong: {
            title: "AGGREGATE DATA",
            text: "R√©sum√©s publi√©s. Num√©ros au niveau des √©tudes. Vous connaissez la moyenne de chaque √©tude, mais vous ne savez pas qui en a b√©n√©fici√© ou qui a subi un pr√©judice. L'individu est effac√©."
          },
          right: {
            title: "DONN√âES INDIVIDUELLES DU PATIENT",
            text: "Raw records for every patient. Age, sex, severity, comorbidities, outcomes. You can ask: who benefits? Who is harmed? Does age modify effect? Time-varying patterns? The individual speaks."
          }
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PI√àGE √âCOLOGIQUE¬†: CHOLEST√âROL ET CHD",
          source: "Robinson & Goodman, Int J Epidemiol 1977 ‚Äî The classic demonstration",
          timeline: [
            { year: "The Data", text: "International comparison: Countries with higher average serum cholesterol have higher coronary heart disease rates. The correlation is strong (r=0.8). Seems conclusive.", type: "normal" },
            { year: "The Fallacy", text: "Researchers concluded: Higher cholesterol causes CHD at the individual level. Policy promoted population-wide cholesterol lowering.", type: "normal" },
            { year: "The Problem", text: "Au sein des pays, l'association au niveau individuel √©tait PLUS FAIBLE. Les pays diff√©raient en termes de r√©gime alimentaire, d‚Äôexercice, de soins de sant√© et de g√©n√©tique. La corr√©lation au niveau national a captur√© la confusion, et non la causalit√©.", type: "crisis" },
            { year: "The Lesson", text: "Les √©tudes avec un taux de cholest√©rol moyen plus √©lev√© ont port√© sur des populations pr√©sentant de BEAUCOUP de diff√©rences, et pas seulement le taux de cholest√©rol. La corr√©lation globale a surestim√© l'effet individuel de 2 √† 3 fois.", type: "revelation" }
          ],
          realData: {
            ecologicalCorr: "r = 0.80 (country-level)",
            individualCorr: "r = 0.35 (within-country, IPD)",
            inflation: "~2,3x surestimation du point de vue √©cologique",
            confounders: "Smoking, SES, diet patterns, healthcare access"
          },
          hook: "L'agr√©gat parlait fort, mais il mentait. Ce n'est qu'en examinant les individus au sein des √©tudes que nous pouvons s√©parer le signal du bruit confus."
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "Analyse IPD en une √©tape ou en deux √©tapes",
          sections: [
            {
              heading: "Two-Stage Approach",
              text: "Stage 1: Analyze each trial separately. Get study-specific effect estimates. Stage 2: Meta-analyze these estimates like traditional MA. Familiar, but for interactions, it can conflate within-study and across-study associations."
            },
            {
              heading: "One-Stage Approach",
              text: "Mod√©lisez tous les patients simultan√©ment. Patients nich√©s dans les √©tudes. L'effet du traitement varie selon l'√©tude (al√©atoire). Interactions estim√©es au niveau des patients dans les √©tudes. Plus puissant pour d√©tecter les modifications d'effet. L'approche recommand√©e lorsque les interactions sont importantes."
            },
            {
              heading: "La distinction critique",
              text: "Interaction DANS L'√âTUDE¬†: Comparaison des patients plus jeunes et plus √¢g√©s DANS chaque essai. C‚Äôest causal ‚Äì la randomisation le prot√®ge. Association ACROSS-STUDY¬†:¬†essais men√©s aupr√®s de patients plus jeunes montrant des effets plus importants. C‚Äôest √©cologique ‚Äì c‚Äôest confondant. Une √©tape les s√©pare. Deux √©tapes peuvent les confondre."
            },
            {
              heading: "When to Use Which",
              text: "Effets principaux uniquement¬†? Les deux approches donnent des r√©sultats similaires. Interactions en sous-groupes¬†? Une √©tape pr√©f√©r√©e. Effets variables dans le temps (courbes de survie) ? Une √©tape requise. Donn√©es mixtes (certaines IPD, certaines agr√©g√©es)¬†? Il existe des m√©thodes sp√©ciales en deux √©tapes."
            }
          ]
        }
      },
      {
        type: 'tool-ipd',
        content: {
          id: 'ipd-simulator',
          title: "IPD vs Aggregate Simulator",
          description: "See how subgroup effects visible in IPD can vanish in aggregate analysis"
        }
      },
      {
        type: 'scenario',
        content: {
          title: "Le sous-groupe cach√©",
          situation: "You've obtained IPD from 8 cancer drug trials (N=4,800). The published aggregate meta-analysis shows HR 0.82 (0.74-0.91) ‚Äî the drug works. Your IPD analysis reveals:\n\nAge < 65: HR 0.68 (0.58-0.80) ‚Äî strong benefit\nAge ‚â• 65: HR 1.05 (0.91-1.21) ‚Äî NO benefit, possible harm\nInteraction p-value: 0.003\n\nThe drug is approved for all ages based on aggregate analysis.",
          question: "Que faites-vous de ce r√©sultat¬†?",
          choices: [
            {
              id: 'a',
              text: "Report it prominently ‚Äî this changes clinical practice",
              consequence: 'good',
              result: "Votre analyse IPD r√©v√®le ce que les donn√©es globales dissimulaient. Le HR ¬´ moyen ¬ª de 0,82 masquait les dommages potentiels chez les patients plus √¢g√©s. Vous signalez la d√©couverte. Examen des agences de r√©glementation. Mise √† jour des lignes directrices. Les patients √¢g√©s sont √©pargn√©s par un m√©dicament qui ne les aide pas. C'est pourquoi l'IPD existe."
            },
            {
              id: 'b',
              text: "Report as exploratory only ‚Äî age wasn't pre-specified",
              consequence: 'neutral',
              result: "Technical correctness, but the interaction is strong (p=0.003), biologically plausible (drug metabolism differs by age), and consistent across trials. By underreporting, clinicians continue prescribing to patients who gain nothing. The conservative framing has clinical cost."
            },
            {
              id: 'c',
              text: "Ne signalez pas¬†: ce sont les donn√©es agr√©g√©es qui ont √©t√© approuv√©es",
              consequence: 'bad',
              result: "L'agr√©gat √©tait erron√©¬†‚Äì¬†pas erron√© en moyenne, mais erron√© pour des patients sp√©cifiques. Les patients √¢g√©s re√ßoivent un m√©dicament qui ne les aide pas et provoque des effets secondaires. Vous aviez les donn√©es pour le montrer. IPD a √©t√© collect√© pr√©cis√©ment pour trouver ces v√©rit√©s. Vous l'avez enterr√©."
            }
          ],
          correct: 'a'
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "Dans chaque patient se cache une v√©rit√© que la moyenne cache. La m√©ta-analyse IPD laisse la parole aux individus."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "The main advantage of one-stage IPD meta-analysis over two-stage is:",
          options: [
            { id: 'a', text: "It's computationally faster", correct: false },
            { id: 'b', text: "It properly separates within-study from across-study interactions", correct: true },
            { id: 'c', text: "It doesn't require individual patient data", correct: false },
            { id: 'd', text: "It always gives more precise estimates", correct: false }
          ],
          explanation: "One-stage analysis models patient-level data directly, allowing it to distinguish within-study interactions (comparing younger vs older patients WITHIN each trial ‚Äî this is causally interpretable) from across-study associations (trials with younger patients showing larger effects ‚Äî this may be ecological confounding). Two-stage approaches can conflate these, leading to misleading subgroup conclusions."
        }
      }
    ]
  },

  // MODULE 3: THE DIAGNOSIS (DTA)
  {
    id: 3,
    title: "The Diagnosis",
    subtitle: "Diagnostic Test Accuracy",
    principle: 2,
    slides: [
      {
        type: 'principle',
        content: {
          text: "To diagnose is not to treat; the curve tells what the number hides"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not considered that D-dimer has '95% sensitivity' for pulmonary embolism ‚Äî yet two meta-analyses reported different specificities, because they pooled studies using different thresholds? The number deceived; the curve would have spoken truth."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "L'√âP√âE √Ä DOUBLE TRANCHANT : D-DIMER POUR PE",
          source: "Multiple DTA meta-analyses 2004-2015",
          timeline: [
            { year: "The Promise", text: "D-dimer: a simple blood test for pulmonary embolism. High sensitivity ‚Äî if negative, PE is 'ruled out.' Emergency physicians embrace it.", type: "normal" },
            { year: "The Numbers", text: "Meta-analyses report: Sensitivity 95%, Specificity 40%. Clinicians celebrate: 'We can safely rule out PE!'", type: "normal" },
            { year: "The Problem", text: "Mais sensibilit√© et sp√©cificit√© COMPROMIS. Diff√©rents seuils donnent diff√©rentes paires. Les √©tudes ont utilis√© des seuils diff√©rents. Les 95¬†%/40¬†% regroup√©s √©taient une moyenne de pommes et d'oranges.", type: "crisis" },
            { year: "The Truth", text: "Au seuil donnant une sensibilit√© de 99¬†% (exclusion v√©ritablement ¬´¬†s√ªre¬†¬ª), la sp√©cificit√© tombe √† 15¬†%. La plupart des tests positifs deviennent des FAUX positifs. Des angiographies tomodensitom√©triques pour presque tout le monde.", type: "crisis" },
            { year: "The Method", text: "HSROC et des mod√®les bivari√©s √©mergent. Ils ne regroupent pas les chiffres ‚Äì ils mod√©lisent la COURBE. Ils r√©v√®lent : il n‚Äôy a pas de sensibilit√©/sp√©cificit√© unique. Il n'y a qu'un compromis.", type: "revelation" }
          ],
          realData: {
            test: "D-dim√®res pour l'embolie pulmonaire",
            sensitivity_range: "80-99% depending on threshold",
            specificity_range: "10-60% depending on threshold",
            tradeoff: "Higher sensitivity = lower specificity",
            clinical_impact: "Threshold choice determines false positive burden"
          },
          hook: "Un test avec une ¬´ sensibilit√© de 95 % ¬ª semble excellent. Mais que se passerait-il si ces 95 % √©taient accompagn√©s d‚Äôune sp√©cificit√© de 20 % ? Huit des dix tests positifs seraient FAUX. Le num√©ro unique tromp√©. La courbe aurait montr√© la v√©rit√©."
        }
      },
      {
        type: 'tool-roc',
        content: {
          id: 'sroc-curve',
          title: "Interactive SROC Curve",
          description: "D√©couvrez comment la sensibilit√© et la sp√©cificit√© s'√©quilibrent. Faites glisser le seuil et observez les deux changements."
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "HSROC et mod√®les bivari√©s",
          sections: [
            {
              heading: "Why Standard MA Fails for DTA",
              text: "Chaque √©tude peut utiliser des seuils diff√©rents. La mise en commun de la sensibilit√© d'√©tudes √† diff√©rents seuils n'a aucun sens : vous faites la moyenne de diff√©rents points sur diff√©rentes courbes. Le r√©sultat n'est pas un v√©ritable point de fonctionnement."
            },
            {
              heading: "Bivariate Random Effects Model",
              text: "Mod√®le logit(Sens) et logit(Spec) CONJOINTEMENT. Ils sont corr√©l√©s n√©gativement dans les √©tudes (effet de seuil). Estimez leur distribution conjointe. Le r√©sultat est un point r√©capitulatif AVEC sa r√©gion de confiance ‚Äî pas seulement deux chiffres."
            },
            {
              heading: "HSROC (Hierarchical Summary ROC)",
              text: "Model the underlying ROC curve directly. Parameters: accuracy (how good overall), threshold (where on the curve), shape (symmetry). Produces a CURVE, not a point. Better for comparing tests that use different thresholds."
            },
            {
              heading: "Interpr√©tation pour les cliniciens",
              text: "DON'T report just 'Sens 90%, Spec 70%.' Report the curve. Show the prediction region. Ask: At what threshold do we get the sensitivity we need? What specificity comes with it? What's the PPV in our population's prevalence?"
            }
          ]
        }
      },
      {
        type: 'vivid-consequence',
        content: {
          title: "LA CATASTROPHE PPV",
          text: "A screening test with 85% sensitivity and 92% specificity. Sounds excellent. But the cancer prevalence in the screening population is 0.5%. Calculate:\n\nIn 100,000 people: 500 have cancer, 99,500 don't.\nTrue positives: 500 √ó 0.85 = 425\nFalse positives: 99,500 √ó 0.08 = 7,960\n\nPositive Predictive Value = 425 / (425 + 7,960) = 5%",
          toll: "95%",
          tollLabel: "of positive screening tests are FALSE ALARMS"
        }
      },
      {
        type: 'clinical-guide',
        content: {
          title: "DTA for Clinical Decision Rules",
          items: [
            "D-dimer doesn't stand alone ‚Äî it follows Wells score or PERC rule",
            "Le test modifie la probabilit√© pr√©-test, ne r√©pond pas oui/non",
            "High sensitivity for RULE-OUT (negative test = stop testing)",
            "High specificity for RULE-IN (positive test = act on it)",
            "Le PPV d√©pend de la pr√©valence de VOTRE population - pas la population de m√©ta-analyse",
            "Ask: What happens to false positives? (CT radiation, contrast injury, anxiety)"
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "La courbe indique ce que cache le nombre. Il n'y a pas de sensibilit√© unique¬†: seulement le compromis au seuil que vous avez choisi."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Two meta-analyses of the same diagnostic test report: Study A: Sensitivity 90%, Specificity 70%. Study B: Sensitivity 75%, Specificity 90%. The most likely explanation is:",
          options: [
            { id: 'a', text: "One meta-analysis made an error", correct: false },
            { id: 'b', text: "Diff√©rents seuils ont √©t√© utilis√©s dans les √©tudes incluses", correct: true },
            { id: 'c', text: "Les tests sont en fait diff√©rents", correct: false },
            { id: 'd', text: "Random sampling variation", correct: false }
          ],
          explanation: "This is the classic THRESHOLD EFFECT. Both meta-analyses may be 'correct' but are summarizing different points on the same ROC curve. Meta-analysis A pooled studies using lower thresholds (more sensitive, less specific). Meta-analysis B pooled studies using higher thresholds. HSROC models explicitly account for this by modeling the underlying curve rather than pooling arbitrary points."
        }
      }
    ]
  },

  // Additional modules would continue here...
  // For brevity, I'll include the framework for the remaining modules

  // MODULE 4: THE PRIOR (Bayesian)
  {
    id: 4,
    title: "The Prior",
    subtitle: "Bayesian Meta-Analysis",
    principle: 3,
    slides: [
      {
        type: 'principle',
        content: {
          text: "What you knew before has a place at the table of evidence"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not considered the magnesium debate ‚Äî where seven trials showed OR 0.44 for mortality, then ISIS-4 with 58,000 patients showed OR 1.06? The frequentist discarded the seven. The Bayesian asked: why should we forget what we learned?"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE DEBATE: MAGNESIUM AND THE MEGA-TRIAL",
          source: "ISIS-4 (Lancet 1995) vs prior meta-analysis | The Bayesian battleground",
          timeline: [
            { year: "1991", text: "Seven small trials suggest IV magnesium reduces mortality in MI. Meta-analysis: OR 0.44 (0.27-0.71). A 56% reduction! Hope rises.", type: "normal" },
            { year: "1995", text: "ISIS-4 mega-trial: 58,050 patients. OR 1.06 (0.99-1.13). NO benefit. Complete contradiction. The small trials appear wrong.", type: "crisis" },
            { year: "The Debate", text: "Frequentists: ISIS-4 is definitive. Ignore the prior trials. Bayesians: Both are evidence. Combine them properly. The prior deserves its place.", type: "normal" },
            { year: "The Analysis", text: "Bayesian synthesis with informative prior from early trials + ISIS-4 likelihood: Posterior OR ~0.93 (0.79-1.09). Uncertainty remains. Neither 'dramatic benefit' nor 'no effect' is certain.", type: "revelation" }
          ],
          realData: {
            priorMA: "OR 0.44 (0.27-0.71) ‚Äî 7 trials, 1,301 patients",
            isis4: "OR 1.06 (0.99-1.13) ‚Äî 58,050 patients",
            bayesPosterior: "OR ~0.93 (0.79-1.09)",
            tension: "Prior and likelihood severely conflict"
          },
          hook: "The frequentist discards the seven trials: 'ISIS-4 is bigger.' The Bayesian asks: 'Why should we forget what we learned?' Neither approach is wrong ‚Äî but only Bayesian analysis makes the tension explicit."
        }
      },
      {
        type: 'content',
        content: {
          title: "Bayesian Primer ‚Äî The Three Components",
          sections: [
            {
              heading: "THE PRIOR: What you believed before",
              items: [
                "Represents knowledge BEFORE seeing current data",
                "Can be informative (strong belief) or vague (let data speak)",
                "Must be specified and justified ‚Äî not hidden"
              ]
            },
            {
              heading: "THE LIKELIHOOD: What the data says",
              items: [
                "The probability of observing this data given each possible truth",
                "This is what frequentist analysis focuses on exclusively",
                "It's evidence, but not the whole picture"
              ]
            },
            {
              heading: "THE POSTERIOR: Updated belief",
              items: [
                "Prior √ó Likelihood = Posterior (simplified)",
                "Combines what you knew with what you learned",
                "Allows direct probability statements: 'There's 85% probability the effect is beneficial'"
              ]
            }
          ]
        }
      },
      {
        type: 'tool-bayes',
        content: {
          id: 'bayes-visualizer',
          title: "Bayesian Prior-Posterior Explorer",
          description: "Adjust priors and see how they combine with data to form posteriors"
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "Choosing and Justifying Priors",
          sections: [
            {
              heading: "Non-Informative (Vague) Priors",
              text: "Let data 'speak for itself.' Flat distributions. Results approximate frequentist analysis. Safe but wastes prior knowledge. Use when you truly have no prior information."
            },
            {
              heading: "Weakly Informative Priors",
              text: "Rule out implausible values without strong preference. 'Effect unlikely > 2-fold.' Prevents extreme estimates while staying humble. Recommended for routine use."
            },
            {
              heading: "Informative Priors",
              text: "Incorporate specific prior knowledge ‚Äî previous meta-analyses, mechanism, expert belief. Must be pre-specified and justified. Powerful but requires defensible choices."
            },
            {
              heading: "Skeptical Priors",
              text: "For extraordinary claims: center at null, moderate precision. New data must 'overcome' skepticism. Used in FDA Bayesian trials. Protects against false positives."
            },
            {
              heading: "The Golden Rule",
              text: "ALWAYS report sensitivity analysis with different priors. If conclusions depend heavily on prior choice, acknowledge this. Transparency about subjectivity is more honest than hiding it in arbitrary frequentist conventions."
            }
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "What you knew before has a place at the table ‚Äî but you must show it openly, and test whether your conclusion depends on it."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A Bayesian meta-analysis uses an informative prior with mean 0.7 and moderate precision. The data likelihood peaks at 0.4. The posterior will:",
          options: [
            { id: 'a', text: "Peak at exactly 0.55 (the midpoint)", correct: false },
            { id: 'b', text: "Be between 0.4 and 0.7, closer to whichever has more precision", correct: true },
            { id: 'c', text: "Peak at 0.4 because data always overrides priors", correct: false },
            { id: 'd', text: "Peak at 0.7 because priors always dominate", correct: false }
          ],
          explanation: "The posterior is a weighted combination of prior and likelihood, with weights proportional to precision (inverse variance). More precise information pulls harder. If the data are very precise (large N), the posterior shifts toward 0.4. If the prior is very tight (strong belief), it stays near 0.7. The actual location depends on the relative precisions ‚Äî Bayesian analysis makes this explicit."
        }
      }
    ]
  },

  // MODULE 5: THE PATHWAY (MASEM)
  {
    id: 5,
    title: "The Pathway",
    subtitle: "MASEM",
    principle: 4,
    slides: [
      {
        type: 'principle',
        content: {
          text: "The pathway illuminates what the endpoint obscures"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not considered that CBT 'works' for depression ‚Äî yet for decades, training emphasized cognitive restructuring, until MASEM revealed the behavioral component was equally powerful? They knew THAT it worked, but not HOW ‚Äî and trained therapists in half the mechanism."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE BLACK BOX: COGNITIVE THERAPY'S MECHANISMS",
          source: "Cuijpers et al. Psychol Med 2019 ‚Äî The mechanism mystery",
          timeline: [
            { year: "The Success", text: "Meta-analyses confirm: Cognitive Behavioral Therapy (CBT) reduces depression (d = 0.70). Guidelines recommend it. Billions spent training therapists. But HOW does it work?", type: "normal" },
            { year: "The Theory", text: "Beck's model: CBT changes dysfunctional cognitions ‚Üí reduces negative automatic thoughts ‚Üí improves mood. The pathway seems clear.", type: "normal" },
            { year: "The Problem", text: "When researchers tested this: cognitive change explains only 25-35% of improvement. What about the other 65%? Behavioral activation? Alliance? Expectation? The box remained black.", type: "crisis" },
            { year: "The MASEM Solution", text: "Lemmens et al. pooled 12 studies, modeled full pathway. Found: behavioral change (Œ≤=0.41) contributed AS MUCH as cognitive change (Œ≤=0.38). The 'cognitive' in CBT was only half the story.", type: "revelation" }
          ],
          realData: {
            studies: "12 RCTs with mediator data, N = 1,847",
            cognitivePath: "Œ≤ = 0.38 (cognitive mediation)",
            behavioralPath: "Œ≤ = 0.41 (behavioral mediation)",
            directPath: "Œ≤ = 0.15 (unexplained)",
            implication: "Behavioral components may be equally important targets"
          },
          hook: "For decades, CBT training emphasized cognitive restructuring. MASEM revealed the behavioral component was equally powerful. Training programs worldwide are now being revised."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE PUZZLE: HOW DOES MINDFULNESS REDUCE DEPRESSION?",
          source: "Gu et al. (Clin Psychol Rev 2015) + van der Velden et al. (Clin Psychol Rev 2015)",
          timeline: [
            { year: "The Finding", text: "Meta-analyses establish: Mindfulness-based interventions reduce depression relapse. Effect size around d = 0.30-0.50. But HOW? Through what pathway?", type: "normal" },
            { year: "Competing Theories", text: "Theory A: Mindfulness reduces rumination (repetitive negative thinking). Theory B: Mindfulness increases meta-awareness (observing thoughts without fusion). Theory C: Mindfulness enhances emotional regulation. All plausible. All have supporting correlations.", type: "normal" },
            { year: "The MASEM Approach", text: "Pool correlation matrices from 18 studies. Not just 'X predicts Y' but the full web: mindfulness‚Üîrumination‚Üîawareness‚Üîregulation‚Üîdepression. Fit structural equation models to the pooled matrix.", type: "revelation" },
            { year: "The Revelation", text: "Path coefficients reveal: Rumination reduction is the DOMINANT pathway (Œ≤ = -0.42). Meta-awareness contributes but primarily through rumination. Direct mindfulness‚Üídepression path is weak. The mechanism is specified.", type: "revelation" }
          ],
          realData: {
            studies: "18 cross-sectional/longitudinal studies, N = 2,912",
            pooledR: "Mindfulness-Depression r = -0.33",
            pathViaRumination: "Indirect effect Œ≤ = -0.22 (67% of total)",
            directPath: "Direct effect Œ≤ = -0.11 (33% of total)",
            conclusion: "Interventions should target rumination specifically"
          },
          hook: "Traditional meta-analysis would tell you 'mindfulness works.'MASEM vous indique'mindfulness works BY REDUCING RUMINATION.' One informs policy. The other guides intervention design."
        }
      },
      {
        type: 'content',
        content: {
          title: "MASEM ‚Äî The Two-Stage Approach",
          sections: [
            {
              heading: "Stage 1: Pool the Correlation Matrices",
              items: [
                "Extract correlation matrices from each study",
                "Account for different variables measured across studies",
                "Use fixed-effects or random-effects pooling",
                "Handle missing correlations (pairwise available)",
                "Check the pooled matrix is positive-definite (can you actually fit SEM?)"
              ]
            },
            {
              heading: "Stage 2: Fit Structural Equation Model",
              items: [
                "Specify your theoretical model (paths, latent variables)",
                "Estimate path coefficients using pooled correlations",
                "Use harmonic mean N or total N for SEs",
                "Test model fit (RMSEA, CFI, SRMR)",
                "Compare competing models (AIC, chi-square difference)"
              ]
            },
            {
              heading: "What MASEM Can Do",
              items: [
                "Test MEDIATION: Does X affect Y through M?",
                "Test MODERATION (with TSSEM extensions)",
                "Compare path models across subgroups",
                "Quantify indirect effects with confidence intervals",
                "Distinguish correlation from directional influence"
              ]
            }
          ]
        }
      },
      {
        type: 'contrast',
        content: {
          leftTitle: "Traditional Meta-Analysis",
          leftItems: [
            "Asks: Does X predict Y?",
            "Pools effect sizes for one relationship",
            "Cannot distinguish direct from indirect effects",
            "Treats mechanism as a black box",
            "Informs WHETHER to intervene"
          ],
          rightTitle: "MASEM",
          rightItems: [
            "Asks: HOW does X relate to Y?",
            "Pools entire correlation matrices",
            "Decomposes direct and indirect pathways",
            "Maps the mechanism explicitly",
            "Informs WHERE in the pathway to intervene"
          ]
        }
      },
      {
        type: 'tool-masem',
        content: {
          id: 'masem-visualizer',
          title: "MASEM Path Diagram Explorer",
          description: "Build and visualize path models with pooled correlations"
        }
      },
      {
        type: 'vivid-consequence',
        content: {
          title: "THE WRONG PATHWAY DISASTER",
          text: "A workplace wellness program targeted 'employee engagement' to reduce burnout, based on meta-analytic evidence that engagement correlates with lower burnout (r = -0.45). Millions spent on engagement initiatives. Burnout unchanged.\n\nA MASEM analysis later revealed: Engagement and burnout are BOTH downstream of job resources. Engagement doesn't CAUSE less burnout ‚Äî they share a common cause. The intervention targeted a correlate, not a cause.",
          toll: "$2.1M",
          tollLabel: "spent on wrong intervention target"
        }
      },
      {
        type: 'decision-tree',
        content: {
          title: "The MASEM Feasibility Decision",
          situation: "You want to understand HOW leadership style affects team performance. You have 45 studies measuring leadership, team cohesion, psychological safety, and performance. Not all studies measure all variables. You attempt to pool correlation matrices for MASEM.",
          nodes: [
            {
              id: 'start',
              question: "Your pooled correlation matrix is NOT positive-definite. The eigenvalue check fails. What do you do?",
              branches: [
                { id: 'a', text: "Force it positive-definite using nearest PD approximation", nextNode: 'force' },
                { id: 'b', text: "Investigate which correlations are causing the problem", nextNode: 'investigate' },
                { id: 'c', text: "Abandon MASEM and do separate bivariate meta-analyses", nextNode: 'abandon' }
              ]
            },
            {
              id: 'force',
              type: 'outcome',
              consequence: 'bad',
              title: "The Silent Distortion",
              text: "Forcing a matrix to be positive-definite changes the correlations. Your path coefficients are now based on ALTERED data. The indirect effect of leadership through cohesion is 0.28. But the true pooled correlation was impossible ‚Äî perhaps because cohesion and safety are nearly collinear, or because a coding error exists. Your model runs but the numbers are artifacts.",
              realCase: "Cheung (2015) documented MASEM studies where forced PD matrices led to unstable, non-replicable results. The math worked; the meaning didn't."
            },
            {
              id: 'investigate',
              question: "You examine the pairwise correlations. Discovery: Cohesion-Safety correlation is 0.92 in some studies, creating near-collinearity. Also, 3 studies measured 'leadership' very differently (transformational vs transactional).",
              branches: [
                { id: 'd', text: "Remove the problematic studies and re-run", nextNode: 'remove' },
                { id: 'e', text: "Model cohesion and safety as one latent construct", nextNode: 'collapse' },
                { id: 'f', text: "Separate transformational and transactional leadership models", nextNode: 'separate' }
              ]
            },
            {
              id: 'remove',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Data Loss Dilemma",
              text: "You now have 37 studies. The matrix is PD. But you've excluded studies post-hoc. If those 8 studies differ systematically (perhaps they're the highest-quality ones, or from specific contexts), your model is biased. Report the exclusions and sensitivity analyses.",
              realCase: "Systematic exclusion can introduce selection bias. Some MASEM guidelines now require pre-registered exclusion criteria."
            },
            {
              id: 'collapse',
              type: 'outcome',
              consequence: 'good',
              title: "The Theoretical Revision",
              text: "You model 'psychological climate' as a latent factor indicated by both cohesion and safety. The model fits well. Leadership ‚Üí Climate ‚Üí Performance. The indirect effect is 0.34. Your theoretical model evolved based on empirical reality. You report: 'Cohesion and safety were empirically inseparable in these data, suggesting they represent a common psychological climate factor.'",
              realCase: "Viswesvaran et al.'s job satisfaction MASEM collapsed related constructs when empirical correlations exceeded theoretical distinctiveness."
            },
            {
              id: 'separate',
              type: 'outcome',
              consequence: 'good',
              title: "The Split Insight",
              text: "You run two separate MASEMs: one for transformational, one for transactional leadership. Both matrices are PD. Results differ dramatically: Transformational works through inspiration (Œ≤=0.41), transactional through structure (Œ≤=0.29). The pathway DEPENDS on leadership type. One model would have been wrong for half your question.",
              realCase: "Judge & Piccolo's leadership MASEM separated leadership types, finding different mediation pathways for each."
            },
            {
              id: 'abandon',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Honest Retreat",
              text: "You report bivariate meta-analyses: Leadership-Performance r=0.31; Leadership-Cohesion r=0.45; Cohesion-Performance r=0.38. You cannot claim mediation, but you can report the building blocks. Future studies with complete data may enable MASEM. You've avoided false precision.",
              realCase: "Some argue that bivariate MA with explicit theoretical discussion is more honest than forced MASEM with unstable matrices."
            }
          ]
        }
      },
      {
        type: 'clinical-guide',
        content: {
          title: "MASEM Interpretation Checklist",
          items: [
            "CHECK: Is the pooled correlation matrix positive-definite? (If not, SEM cannot be fitted properly)",
            "SPECIFY: Your theoretical model BEFORE running analyses (not data-driven model building)",
            "REPORT: Both direct and indirect effects with confidence intervals",
            "TEST: Model fit ‚Äî CFI > 0.95, RMSEA < 0.06, SRMR < 0.08 as rough guidelines",
            "COMPARE: Alternative models if theory permits multiple structures",
            "ACKNOWLEDGE: Cross-sectional data cannot establish causation ‚Äî only theory does",
            "TRANSLATE: What does the pathway mean for intervention design?"
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "The pathway illuminates what the endpoint obscures. Know not just WHETHER, but HOW ‚Äî for the how determines where to place your intervention."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A MASEM analysis finds: Job demands ‚Üí burnout (Œ≤ = 0.45), burnout ‚Üí performance (Œ≤ = -0.30), and job demands ‚Üí performance (Œ≤ = -0.05, n.s.). The indirect effect of demands on performance through burnout is significant. This suggests:",
          options: [
            { id: 'a', text: "Job demands have no effect on performance", correct: false },
            { id: 'b', text: "Burnout fully mediates the demands-performance relationship", correct: true },
            { id: 'c', text: "The model is incorrectly specified", correct: false },
            { id: 'd', text: "Demands and burnout are the same construct", correct: false }
          ],
          explanation: "This is FULL MEDIATION. The direct path (demands ‚Üí performance) is non-significant, but the indirect path through burnout is significant. Job demands affect performance entirely BY causing burnout. Intervention implication: Don't just reduce demands ‚Äî target burnout recovery mechanisms."
        }
      }
    ]
  },

  // MODULE 6: THE DOSE (Dose-Response)
  {
    id: 6,
    title: "The Dose",
    subtitle: "Dose-Response",
    principle: 5,
    slides: [
      {
        type: 'principle',
        content: {
          text: "The dose makes the poison‚Äîand the cure"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not seen how patients took 325mg of aspirin 'to be safe' ‚Äî until dose-response meta-analysis revealed: 75mg provided all the cardiovascular benefit, and higher doses only added bleeding? The curve had the answer; the simple comparison hid it."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE ASPIRIN CURVE THAT CHANGED CARDIOLOGY",
          source: "Antithrombotic Trialists' Collaboration ‚Äî Lancet 2009",
          timeline: [
            { year: "The Question", text: "Aspirin prevents heart attacks. But how much? Doses varied wildly: 75mg to 1500mg daily. Higher doses = more protection? Or more bleeding?", type: "normal" },
            { year: "The Linear Thinking", text: "Early trials used high doses (900-1500mg). Seemed to work. Cardiologists reasoned: if some is good, more is better. Patients bled.", type: "normal" },
            { year: "The Dose-Response MA", text: "Antithrombotic Trialists pooled 287 studies across dose categories. Applied proper within-study correlation methods. Modeled the CURVE, not just presence vs absence.", type: "revelation" },
            { year: "The Plateau", text: "CVD reduction plateaued at 75-100mg. Higher doses: NO additional benefit, only more GI bleeding. The dose-response curve had a CEILING. 75mg was optimal.", type: "revelation" }
          ],
          realData: {
            at75mg: "RR 0.68 for CVD events",
            at325mg: "RR 0.68 for CVD events (no additional benefit)",
            at1500mg: "RR 0.67 for CVD events (still no better)",
            bleedingAt75: "GI bleed RR 1.5",
            bleedingAt1500: "GI bleed RR 2.8",
            conclusion: "Guidelines now recommend 75-100mg, not higher"
          },
          hook: "For decades, patients took 325mg or more 'to be safe.' The dose-response meta-analysis revealed the truth: they bled more without gaining protection. The curve had spoken ‚Äî but only those who modeled it could hear."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE J-CURVE THAT CONFOUNDED POLICY",
          source: "Alcohol and Cardiovascular Disease ‚Äî Di Castelnuovo et al. (Arch Intern Med 2006)",
          timeline: [
            { year: "The Observation", text: "Individual studies consistently suggest: Moderate drinkers have LOWER CVD mortality than non-drinkers. The 'French Paradox.' Does alcohol protect the heart?", type: "normal" },
            { year: "The Linear Fallacy", text: "Some analysts pool 'any drinking vs none.' OR = 0.75. Alcohol appears protective! Guidelines soften. 'Moderate drinking may be beneficial.'", type: "crisis" },
            { year: "The Dose-Response Analysis", text: "Pool 34 prospective studies with dose categories. Don't compare 'any vs none' ‚Äî model the CURVE. Use restricted cubic splines. Account for Greenland-Longnecker correlation.", type: "normal" },
            { year: "The J-Curve Revealed", text: "Risk decreases from 0 to ~1 drink/day (RR nadir ~0.80). Then RISES. At 4+ drinks/day, RR > 1.0. Heavy drinking is HARMFUL. The 'protection' exists only in a narrow window ‚Äî if it exists at all.", type: "revelation" },
            { year: "The Controversy", text: "Critics note: 'Non-drinkers'incluez les anciens gros buveurs (biais d\'abandon malade). La courbe en J peut √™tre un artefact. Les √©tudes de randomisation mend√©lienne ne trouvent AUCUN effet protecteur. La courbe's shape depends on who you call 'zero.'", type: "crisis" }
          ],
          realData: {
            studies: "34 prospective studies, 1,015,835 participants",
            atZero: "Reference category (RR = 1.0)",
            at1drink: "RR = 0.80 (0.78-0.83)",
            at4drinks: "RR = 1.13 (1.06-1.21)",
            nadir: "~12.5 g/day (about 1 drink)"
          },
          hook: "A simple meta-analysis would say 'drinkers have 25% lower CVD risk.' The dose-response meta-analysis says 'PEUT √äTRE, mais seulement √† 1 verre/jour, et elle s\'inverse avec plus.' Same data, profoundly different policy implications."
        }
      },
      {
        type: 'content',
        content: {
          title: "Dose-Response Meta-Analysis Methods",
          sections: [
            {
              heading: "The Greenland-Longnecker Method",
              items: [
                "Within a study, dose categories are NOT independent",
                "The low-dose group shares a reference with the high-dose group",
                "Standard MA would ignore this correlation ‚Üí wrong SEs",
                "G-L reconstructs the covariance matrix from published tables",
                "Requires: cases, person-time or N, RR and CI for each dose level"
              ]
            },
            {
              heading: "Modeling the Curve Shape",
              items: [
                "LINEAR: Assumes every unit of dose has same effect ‚Äî rarely true",
                "QUADRATIC: Captures U-shaped or inverse-U relationships",
                "RESTRICTED CUBIC SPLINES (RCS): Flexible curves with knots",
                "FRACTIONAL POLYNOMIALS: Data-driven non-linear shapes",
                "The shape IS the finding ‚Äî report and interpret the curve"
              ]
            },
            {
              heading: "Critical Decisions",
              items: [
                "What is 'zero dose'? (Never exposed? Low exposure? Former users?)",
                "How to assign dose values to categories ('1-3 cups' ‚Üí midpoint?)",
                "Where to place spline knots? (Typically 3 knots at 10th, 50th, 90th percentiles)",
                "One-stage vs two-stage approach?"
              ]
            }
          ]
        }
      },
      {
        type: 'tool-dose',
        content: {
          id: 'dose-response-tool',
          title: "Dose-Response Curve Visualizer",
          description: "Explore how different curve shapes change interpretation"
        }
      },
      {
        type: 'vivid-consequence',
        content: {
          title: "THE LINEAR ASSUMPTION KILLS",
          text: "A meta-analysis of vitamin D supplementation and mortality found 'no significant effect' (pooled RR = 0.97, 95% CI: 0.94-1.01). Case closed? No.\n\nDose-response reanalysis revealed: Benefit peaked at 20-40 ng/mL blood levels, then REVERSED at higher levels. The trials gave everyone the SAME dose, pushing some into harmful territory while leaving others deficient. The null overall effect masked a U-shaped curve.",
          toll: "Hidden",
          tollLabel: "harms from one-dose-fits-all policy"
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "Reading and Reporting Dose-Response Curves",
          sections: [
            {
              heading: "Identify the Nadir/Peak",
              text: "Where is maximum benefit (or minimum risk)? This is often the policy-relevant number. 'Optimal intake is approximately X units/day.'"
            },
            {
              heading: "Identify Threshold Effects",
              text: "Is there a dose below which no effect occurs? Above which harm begins? These thresholds define safe/effective ranges."
            },
            {
              heading: "Report the Curve, Not Just Points",
              text: "Show the spline with confidence bands. Readers need to see the SHAPE. A table of 'RR at 1, 2, 3, 4 units' loses the curve information."
            },
            {
              heading: "Test for Non-Linearity",
              text: "Statistical test: Does a non-linear model fit significantly better than linear? If yes, DON'T rapporte l\'estimation lin√©aire - il's misleading."
            },
            {
              heading: "Address Reference Category Issues",
              text: "Who is in the 'zero' group matters enormously. Former users, never users, and minimal users may differ systematically. Sensitivity analysis essential."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          title: "The Reference Group Dilemma",
          situation: "You'r√©alise une m√©ta-analyse dose-r√©ponse de la consommation de caf√© et de la mortalit√© cardiovasculaire. Des √©tudes rapportent un risque pour 0, 1-2, 3-4 et 5+ tasses/jour. Mais les'0 cups'groupes diff√®rent¬†: certains sont'never drinkers,' others include 'former drinkers who quit for health reasons.'",
          nodes: [
            {
              id: 'start',
              question: "Your preliminary analysis shows a J-curve: 0 cups has RR=1.0 (reference), 2-3 cups has RR=0.85 (benefit), 5+ cups has RR=0.95. How do you handle the heterogeneous reference category?",
              branches: [
                { id: 'a', text: "Use 0 cups as reference ‚Äî that's what the studies reported", nextNode: 'naive' },
                { id: 'b', text: "Investigate who is in the '0 cups' category across studies", nextNode: 'investigate' },
                { id: 'c', text: "Use the lowest non-zero consumption category as reference", nextNode: 'shift' }
              ]
            },
            {
              id: 'naive',
              type: 'outcome',
              consequence: 'bad',
              title: "The Sick Quitter Trap",
              text: "Your J-curve is published. Critics point out: Studies including 'former drinkers' in reference show STRONGER protective effects at moderate doses. Why? Former drinkers quit because of illness ‚Äî they're sicker at baseline. You compared healthy moderate drinkers to sick former drinkers, inflating apparent benefit.",
              realCase: "The alcohol J-curve controversy hinged exactly on this: studies excluding former drinkers showed NO cardioprotection. The entire 'moderate drinking benefit' may be sick-quitter bias."
            },
            {
              id: 'investigate',
              question: "You stratify: 15 studies defined '0' as never-drinkers, 12 included former drinkers. In never-drinker studies, the curve is flatter. In former-drinker studies, moderate consumption appears more protective.",
              branches: [
                { id: 'd', text: "Report separate curves and acknowledge the uncertainty", nextNode: 'transparent' },
                { id: 'e', text: "Use only never-drinker studies as primary analysis", nextNode: 'restrict' }
              ]
            },
            {
              id: 'transparent',
              type: 'outcome',
              consequence: 'good',
              title: "The Honest Uncertainty",
              text: "You report both curves with explanation: 'When reference includes only never-drinkers, optimal consumption is 2-3 cups/day with RR 0.90. When former drinkers are included, benefit appears larger (RR 0.82). The difference likely reflects sick-quitter bias rather than true effect modification.'",
              realCase: "Poole et al.'s coffee meta-analysis explicitly stratified by reference definition, showing how conclusions depend on this methodological choice."
            },
            {
              id: 'restrict',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Clean but Limited Analysis",
              text: "Using only 15 never-drinker studies, your curve shows modest benefit peaking at 3 cups (RR 0.92). Effect is smaller than full pooling, but likely less biased. You lose power but gain validity. Report this as primary, with full pooling as sensitivity analysis.",
              realCase: "This approach is increasingly recommended for lifestyle dose-response analyses where 'non-users' are heterogeneous."
            },
            {
              id: 'shift',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Shifted Perspective",
              text: "Using 1 cup/day as reference avoids the sick-quitter problem. Now your curve shows 2-3 cups has RR 0.94 vs 1 cup ‚Äî smaller benefit. But '0 cups' becomes harder to interpret. Different reference, different question, different answer.",
              realCase: "Some nutritional dose-response MAs use 'moderate intake' as reference, avoiding zero-category problems but changing the clinical question entirely."
            }
          ]
        }
      },
      {
        type: 'clinical-guide',
        content: {
          title: "Dose-Response Clinical Translation",
          items: [
            "OPTIMAL DOSE: Where does the curve reach maximum benefit?",
            "CEILING EFFECT: Beyond what dose does no additional benefit accrue?",
            "THRESHOLD OF HARM: At what dose does benefit reverse to harm?",
            "THERAPEUTIC WINDOW: What is the range of beneficial doses?",
            "INDIVIDUAL VARIATION: Curves are AVERAGES ‚Äî individuals may differ",
            "REFERENCE GROUP: Who is 'unexposed'? This affects the ENTIRE curve",
            "BIOLOGICAL PLAUSIBILITY: Does the curve shape make mechanistic sense?"
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "The dose makes the poison‚Äîand the cure. Never ask only 'does it work?' Ask 'how much, and where does benefit become harm?'"
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A dose-response meta-analysis of physical activity and mortality shows: Sedentary (reference), Low (RR=0.80), Moderate (RR=0.65), High (RR=0.64), Very High (RR=0.65). What pattern does this suggest?",
          options: [
            { id: 'a', text: "Linear benefit ‚Äî more is always better", correct: false },
            { id: 'b', text: "Ceiling effect ‚Äî benefit plateaus at moderate activity", correct: true },
            { id: 'c', text: "U-shaped ‚Äî very high activity is harmful", correct: false },
            { id: 'd', text: "No relationship ‚Äî exercise doesn't affect mortality", correct: false }
          ],
          explanation: "This shows a CEILING EFFECT. The benefit of moving from sedentary to low activity is large (20% reduction). From low to moderate, another large gain. But from moderate to high to very high ‚Äî the curve flattens. Policy implication: Focus on getting sedentary people moving, not pushing active people to do more."
        }
      }
    ]
  },

  // MODULE 7: THE UMBRELLA (Meta-Research)
  {
    id: 7,
    title: "The Umbrella",
    subtitle: "Meta-Research",
    principle: 6,
    slides: [
      {
        type: 'principle',
        content: {
          text: "To synthesize syntheses, first know what you do not know"
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not observed that Ioannidis found 264 meta-analyses claiming foods cause or prevent cancer ‚Äî yet when he applied credibility criteria, only 5 (2%) had convincing evidence? The journals were full of 'significant findings.' The truth was nearly empty."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE BIOMARKER GRAVEYARD: 85% DOWNGRADED",
          source: "Ioannidis & Panagiotou, JAMA 2011 ‚Äî The credibility reckoning",
          timeline: [
            { year: "The Promise", text: "Hundreds of meta-analyses claimed: biomarker X predicts disease Y. CRP predicts heart disease! IL-6 predicts cancer! Vitamin D predicts everything! Journals published, guidelines cited.", type: "normal" },
            { year: "The Umbrella", text: "Ioannidis examined 35 meta-analyses of biomarker-disease associations. All had 'statistically significant' pooled results. But how many were CREDIBLE?", type: "normal" },
            { year: "The Criteria", text: "Applied: >1000 cases, p<10‚Åª‚Å∂, I¬≤<50%, no small-study bias, largest study significant. These are MINIMAL standards for believing an association.", type: "normal" },
            { year: "The Reckoning", text: "Only 6 of 35 (17%) met all criteria. 29 (83%) had inflated effects ‚Äî average inflation 1.7x. Most 'proven' biomarker associations were shadows, not signals.", type: "crisis" }
          ],
          realData: {
            metaAnalyzed: "35 biomarker-disease meta-analyses",
            claimed: "100% reported 'significant' associations",
            credible: "Only 6 (17%) met all credibility criteria",
            avgInflation: "1.7-fold overestimate in weak studies",
            implication: "Most biomarker 'discoveries' don't replicate"
          },
          hook: "Every biomarker had a meta-analysis. Every meta-analysis was 'significant.' But when credibility criteria were applied, 83% crumbled. Statistical significance without credibility is a mirage."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "EVERYTHING WE EAT CAUSES CANCER",
          source: "Schoenfeld & Ioannidis (Am J Clin Nutr 2013) + Subsequent umbrella reviews",
          timeline: [
            { year: "The Problem", text: "Nutritional epidemiology produces hundreds of meta-analyses. Coffee causes cancer. Coffee prevents cancer. Red wine protects. Red wine harms. The public is confused. Policy paralyzed.", type: "normal" },
            { year: "The Umbrella Approach", text: "Ioannidis and colleagues systematically review meta-analyses OF food-cancer associations. Not individual studies ‚Äî the meta-analyses themselves. How many are credible?", type: "normal" },
            { year: "The Sobering Findings", text: "Of 264 meta-analyses examined: Most showed 'statistically significant' associations. But credibility assessment revealed: Only 5 had 'convincing' evidence (>1000 cases, p<10‚Åª‚Å∂, low heterogeneity, no bias). The vast majority? Weak, contradictory, likely biased.", type: "revelation" },
            { year: "The Implication", text: "Most published meta-analyses in nutrition are noise, not signal. 'Statistically significant' ‚â† credible. Without credibility criteria, we mistake quantity of evidence for quality.", type: "crisis" },
            { year: "The Pattern", text: "Later umbrella reviews in other fields found similar: 85% of 'significant' biomarker associations downgrade when credibility assessed. Most meta-analyses don't survive scrutiny.", type: "revelation" }
          ],
          realData: {
            metaAnalyzed: "264 meta-analyses of food-cancer associations",
            significant: "~80% reported statistically significant results",
            convincing: "Only 5 (2%) met all credibility criteria",
            suggestive: "18 (7%) met 'suggestive' criteria",
            weak: "91% weak or non-credible evidence"
          },
          hook: "One meta-analysis tells you 'this food causes cancer.'Un examen g√©n√©ral vous indique'of the 50 foods claimed to cause cancer, only 2 claims are credible.' The meta-research level reveals what individual meta-analyses hide."
        }
      },
      {
        type: 'content',
        content: {
          title: "Umbrella Review Methods",
          sections: [
            {
              heading: "What IS an Umbrella Review?",
              items: [
                "A systematic review of systematic reviews and meta-analyses",
                "The unit of analysis is the META-ANALYSIS, not the primary study",
                "Maps the entire evidence landscape on a topic",
                "Identifies agreements, contradictions, and gaps",
                "Applies credibility criteria to distinguish signal from noise"
              ]
            },
            {
              heading: "The Credibility Criteria (Ioannidis et al.)",
              items: [
                "CONVINCING: >1000 cases, p<10‚Åª‚Å∂, I¬≤<50%, no small-study bias, largest study significant",
                "HIGHLY SUGGESTIVE: >1000 cases, p<10‚Åª‚Å∂",
                "SUGGESTIVE: >1000 cases, p<10‚Åª¬≥",
                "WEAK: p<0.05 but fails above criteria",
                "NON-SIGNIFICANT: p‚â•0.05"
              ]
            },
            {
              heading: "The Overlap Problem",
              items: [
                "Multiple meta-analyses include the SAME primary studies",
                "They appear independent but share data",
                "Counting them as separate evidence is double-counting",
                "Use CCA (Corrected Covered Area) to quantify overlap",
                "Slight overlap: <5%, moderate: 6-10%, high: 11-15%, very high: >15%"
              ]
            }
          ]
        }
      },
      {
        type: 'contrast',
        content: {
          leftTitle: "Without Umbrella Review",
          leftItems: [
            "'Meta-analysis shows significant effect'",
            "Cherry-pick the favorable MA",
            "Ignore contradicting MAs",
            "No assessment of credibility",
            "Confuse significance with truth"
          ],
          rightTitle: "With Umbrella Review",
          rightItems: [
            "'Of 12 MAs, only 2 meet credibility criteria'",
            "Map all available syntheses",
            "Explain contradictions systematically",
            "Apply consistent credibility standards",
            "Distinguish strong from weak evidence"
          ]
        }
      },
      {
        type: 'tool-umbrella',
        content: {
          id: 'credibility-tool',
          title: "Evidence Credibility Assessor",
          description: "Apply credibility criteria to evaluate meta-analytic evidence"
        }
      },
      {
        type: 'vivid-consequence',
        content: {
          title: "THE CONTRADICTORY META-ANALYSES TRAP",
          text: "Vitamin E supplementation: One meta-analysis (2004) suggested cardiovascular benefit. Another (2005) found increased all-cause mortality. Same nutrient, opposite conclusions. Policy oscillated. Confusion reigned.\n\nUmbrella review revealed: Different inclusion criteria, different doses combined, massive study overlap. When credibility criteria applied: NO convincing evidence either way. The 'debate' was noise.",
          toll: "Years",
          tollLabel: "of policy confusion from uncritical MA acceptance"
        }
      },
      {
        type: 'method',
        content: {
          label: "THE METHOD",
          title: "Conducting and Interpreting Umbrella Reviews",
          sections: [
            {
              heading: "Quality Assessment (AMSTAR-2)",
              text: "Rate each included meta-analysis for methodological quality. Did they register a protocol? Search comprehensively? Assess risk of bias? Use appropriate methods? Quality varies enormously."
            },
            {
              heading: "Overlap Assessment",
              text: "Create a citation matrix: which primary studies appear in which meta-analyses? Calculate overlap. If very high (>15%), treat overlapping MAs as essentially the same evidence."
            },
            {
              heading: "Concordance Assessment",
              text: "Do the meta-analyses agree? If not, WHY? Different search dates? Different inclusion criteria? Different effect measures? Explain discordance, don't just report it."
            },
            {
              heading: "Credibility Grading",
              text: "Apply the criteria: sample size, statistical significance, heterogeneity, small-study effects, consistency. Grade each association as Convincing, Suggestive, Weak, or Non-credible."
            },
            {
              heading: "Evidence Mapping",
              text: "Present findings visually: a table or figure showing all associations, their grades, and the overall landscape. Readers should see AT A GLANCE what is credible."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          title: "The Conflicting Meta-Analyses Dilemma",
          situation: "You're writing clinical guidelines for statin use in primary prevention. You find 8 meta-analyses on statins and all-cause mortality. Four show significant benefit (RR 0.86-0.91). Four show no significant effect (RR 0.94-1.02). All are published in good journals. Your committee asks: What do we recommend?",
          nodes: [
            {
              id: 'start',
              question: "Eight meta-analyses, split 4-4 on whether statins reduce mortality. How do you proceed?",
              branches: [
                { id: 'a', text: "Majority vote ‚Äî 4 show benefit, 4 don't, so inconclusive", nextNode: 'vote' },
                { id: 'b', text: "Use the largest/most recent meta-analysis", nextNode: 'largest' },
                { id: 'c', text: "Conduct an umbrella review with credibility assessment", nextNode: 'umbrella' }
              ]
            },
            {
              id: 'vote',
              type: 'outcome',
              consequence: 'bad',
              title: "The False Democracy",
              text: "Your 'inconclusive' finding treats a high-quality Cochrane review with 50,000 patients the same as a low-quality MA with 5,000 patients in a predatory journal. The four 'positive' MAs have 85% study overlap ‚Äî they're essentially one evidence base counted four times. Vote-counting ignores quality, overlap, and credibility.",
              realCase: "Vote-counting across MAs was discredited in the 1990s but persists in narrative reviews. It's intellectually lazy and often misleading."
            },
            {
              id: 'largest',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Recency Heuristic",
              text: "The 2022 meta-analysis with 120,000 patients shows RR 0.91 (0.87-0.95). You cite this. But this MA included industry-funded trials with questionable endpoint adjudication, and its 'all-cause mortality' combined different follow-up periods. Size doesn't guarantee quality. The 2019 Cochrane review with 80,000 patients found RR 0.94 (0.89-1.00) using stricter criteria.",
              realCase: "Larger isn't always better. The CTT Collaboration's statin MAs used individual patient data but were criticized for industry involvement and selective reporting."
            },
            {
              id: 'umbrella',
              question: "You conduct an umbrella review: assess AMSTAR-2 quality, calculate overlap (CCA), and apply credibility criteria to the pooled estimates. What do you find?",
              branches: [
                { id: 'd', text: "Two high-quality MAs with low overlap both show modest benefit", nextNode: 'synthesis' },
                { id: 'e', text: "All MAs have critical flaws and massive overlap", nextNode: 'uncertainty' }
              ]
            },
            {
              id: 'synthesis',
              type: 'outcome',
              consequence: 'good',
              title: "The Clarified Picture",
              text: "After AMSTAR-2: Only 3 MAs are high quality. Overlap analysis: CCA = 65% ‚Äî the 8 MAs draw from essentially 2-3 independent evidence bases. Credibility grading: The association grades as 'Suggestive' ‚Äî significant p<10‚Åª¬≥, >1000 events, but I¬≤=45% and some small-study effects. Your guideline states: 'Suggestive evidence of modest mortality benefit (RR ~0.90). Certainty limited by heterogeneity. Individual clinical judgment required.'",
              realCase: "Umbrella reviews of statins by Tonin et al. and others have systematically graded the evidence, providing nuanced recommendations."
            },
            {
              id: 'uncertainty',
              type: 'outcome',
              consequence: 'neutral',
              title: "The Honest Unknown",
              text: "Your umbrella reveals: ALL 8 MAs have critical AMSTAR-2 flaws (no registered protocol, incomplete searches, or no RoB assessment). Overlap is 78% ‚Äî essentially one evidence base recycled. After credibility criteria: 'Weak' evidence grade. Your guideline acknowledges: 'Despite numerous meta-analyses, the evidence base is weaker than quantity suggests. Recommend shared decision-making pending better data.'",
              realCase: "Many clinical questions have dozens of meta-analyses but weak evidence after quality assessment. Quantity ‚â† quality."
            }
          ]
        }
      },
      {
        type: 'clinical-guide',
        content: {
          title: "Using Umbrella Reviews for Practice",
          items: [
            "START with umbrella reviews when they exist ‚Äî they've done the mapping",
            "CHECK the credibility grade before acting on any meta-analytic finding",
            "WEIGHT convincing evidence heavily, suggestive moderately, weak minimally",
            "EXPLAIN contradictions ‚Äî they're usually methodological, not biological",
            "ACKNOWLEDGE the overlap ‚Äî 20 meta-analyses may be only 3 independent evidence bases",
            "UPDATE your priors: Most 'significant' findings in low-quality MAs won't replicate",
            "DEMAND credibility assessment in guidelines ‚Äî not just citation of 'a meta-analysis'"
          ]
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "To synthesize syntheses, first know what you do not know. Most meta-analyses are noise. Credibility criteria separate signal from shadow."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "An umbrella review finds 15 meta-analyses on supplement X and disease Y. Overlap assessment shows CCA = 45%. Ten MAs show significant benefit, five show null results. What should you conclude?",
          options: [
            { id: 'a', text: "Strong evidence of benefit (10 vs 5 positive)", correct: false },
            { id: 'b', text: "The evidence is essentially from one or two independent datasets recycled many times", correct: true },
            { id: 'c', text: "The field is hopelessly contradictory", correct: false },
            { id: 'd', text: "More meta-analyses are needed", correct: false }
          ],
          explanation: "CCA of 45% is VERY HIGH overlap ‚Äî these 15 'independent' meta-analyses are largely analyzing the same primary studies in different combinations. The 10 vs 5 split doesn't represent 15 independent tests ‚Äî it's likely 2-3 independent evidence bases repackaged. You should find the LEAST overlapping, highest quality MAs and weight those, not vote-count all 15."
        }
      }
    ]
  },

  // MODULE 8: THE CAPSTONE
  {
    id: 8,
    title: "The Capstone",
    subtitle: "Integration",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "The Capstone",
          subtitle: "Integration and Oath",
          text: "You have walked through the seven principles. Now we seal them with integration and commitment."
        }
      },
      {
        type: 'rhetoric',
        content: {
          question: "Have you not considered that knowledge without wisdom is a blade without a handle ‚Äî dangerous to the one who wields it?"
        }
      },
      {
        type: 'content',
        content: {
          title: "The Seven Principles Unified",
          sections: [
            {
              heading: "From the Network",
              items: [
                "Indirect evidence has power, but transitivity is its foundation",
                "Never rank treatments without showing uncertainty",
                "Consistency must be tested, not assumed"
              ]
            },
            {
              heading: "From the Individual",
              items: [
                "Aggregate data conceals individual truth",
                "IPD reveals what summary data hides",
                "Ecological fallacy is the price of convenience"
              ]
            },
            {
              heading: "From the Diagnosis",
              items: [
                "The curve tells what the number hides",
                "Sensitivity and specificity trade on a continuum",
                "PPV depends on YOUR population"
              ]
            },
            {
              heading: "From the Prior",
              items: [
                "What you knew before has a place at the table",
                "But you must show it openly",
                "And test whether conclusions depend on it"
              ]
            },
            {
              heading: "From the Pathway",
              items: [
                "Knowing THAT is not knowing HOW",
                "The mechanism guides the intervention",
                "Correlation is not the path"
              ]
            },
            {
              heading: "From the Dose",
              items: [
                "More is not always better",
                "The curve reveals the window",
                "The threshold separates cure from poison"
              ]
            },
            {
              heading: "From the Umbrella",
              items: [
                "Most meta-analyses are noise",
                "Credibility criteria separate signal",
                "Quantity of evidence ‚â† quality of evidence"
              ]
            }
          ]
        }
      },
      {
        type: 'vivid-consequence',
        content: {
          title: "THE WEIGHT OF WHAT WE DO",
          text: "Every number in a meta-analysis represents patients. The pooled effect size is an average across thousands of human lives. The heterogeneity statistic captures how differently real people responded. The confidence interval bounds what we truly know versus what we guess.\n\nWhen we pool carelessly, we deceive. When we ignore heterogeneity, we harm those who differ from the average. When we present certainty we don't have, we lead clinicians to false confidence.",
          toll: "Countless",
          tollLabel: "patients affected by evidence synthesis quality"
        }
      },
      {
        type: 'oath',
        content: {
          text: "I will not pool what should not be combined.<br><br>I will not hide heterogeneity behind an average.<br><br>I will not present certainty I do not have.<br><br>I will trace the pathway, measure the dose, assess the credibility.<br><br>I will remember that behind every data point is a patient, behind every study is a question of truth.<br><br>I will use these methods not for cleverness, not for publication counts, but for the <em>patients</em> whose lives depend on the truths I help uncover."
        }
      },
      {
        type: 'cycle-return',
        content: {
          principle: "You came seeking methods. You leave with principles. The methods will evolve. The principles endure. Apply them wisely, for the evidence you synthesize shapes the care patients receive."
        }
      }
    ]
  }
];

// ============================================================
// INTERACTIVE TOOLS - Real working implementations
// ============================================================

// Bayesian Prior-Posterior Visualizer using Plotly
function renderBayesianTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div class="tool-controls">
      <div class="tool-control">
        <label>Prior Mean</label>
        <input type="number" id="priorMean" value="0" step="0.1" onchange="updateBayesPlot()">
      </div>
      <div class="tool-control">
        <label>Prior SD</label>
        <input type="number" id="priorSD" value="1" step="0.1" min="0.1" onchange="updateBayesPlot()">
      </div>
      <div class="tool-control">
        <label>Data Mean</label>
        <input type="number" id="dataMean" value="0.5" step="0.1" onchange="updateBayesPlot()">
      </div>
      <div class="tool-control">
        <label>Data SE</label>
        <input type="number" id="dataSE" value="0.3" step="0.05" min="0.05" onchange="updateBayesPlot()">
      </div>
    </div>
    <div id="bayesPlot" class="plot-area"></div>
    <div id="bayesInterpretation" style="margin-top:1rem;padding:1rem;background:#f3f4f6;border-radius:8px;font-size:0.9rem;"></div>
  `;

  updateBayesPlot();
}

function updateBayesPlot() {
  const priorMean = parseFloat(document.getElementById('priorMean')?.value || 0);
  const priorSD = parseFloat(document.getElementById('priorSD')?.value || 1);
  const dataMean = parseFloat(document.getElementById('dataMean')?.value || 0.5);
  const dataSE = parseFloat(document.getElementById('dataSE')?.value || 0.3);

  const priorPrec = 1 / (priorSD * priorSD);
  const dataPrec = 1 / (dataSE * dataSE);
  const postPrec = priorPrec + dataPrec;
  const postMean = (priorMean * priorPrec + dataMean * dataPrec) / postPrec;
  const postSD = Math.sqrt(1 / postPrec);

  const x = [];
  for (let i = -3; i <= 3; i += 0.05) x.push(i);

  const gaussian = (xVal, mean, sd) => Math.exp(-0.5 * Math.pow((xVal - mean) / sd, 2)) / (sd * Math.sqrt(2 * Math.PI));

  const priorY = x.map(v => gaussian(v, priorMean, priorSD));
  const likeY = x.map(v => gaussian(v, dataMean, dataSE));
  const postY = x.map(v => gaussian(v, postMean, postSD));

  const maxY = Math.max(...priorY, ...likeY, ...postY);
  const normPrior = priorY.map(v => v / maxY);
  const normLike = likeY.map(v => v / maxY);
  const normPost = postY.map(v => v / maxY);

  Plotly.newPlot('bayesPlot', [
    { x, y: normPrior, name: 'Prior', line: { color: '#6b7280', dash: 'dash' } },
    { x, y: normLike, name: 'Likelihood (Data)', line: { color: '#3b82f6', dash: 'dot' } },
    { x, y: normPost, name: 'Posterior', line: { color: '#22c55e', width: 3 } }
  ], {
    title: 'Bayesian Updating',
    xaxis: { title: 'Effect Size', zeroline: true },
    yaxis: { title: 'Density (normalized)', showticklabels: false },
    legend: { x: 0.02, y: 0.98 },
    margin: { t: 50, r: 20, b: 50, l: 50 }
  }, { responsive: true });

  const interp = document.getElementById('bayesInterpretation');
  if (interp) {
    const priorWeight = (priorPrec / postPrec * 100).toFixed(0);
    const dataWeight = (dataPrec / postPrec * 100).toFixed(0);
    interp.innerHTML = `
      <strong>Posterior mean:</strong> ${postMean.toFixed(3)} (95% CI: ${(postMean - 1.96*postSD).toFixed(3)} to ${(postMean + 1.96*postSD).toFixed(3)})<br>
      <strong>Weight from prior:</strong> ${priorWeight}% | <strong>Weight from data:</strong> ${dataWeight}%<br>
      <em>The posterior is pulled toward whichever source is more precise.</em>
    `;
  }
}

// SROC Curve Interactive Tool
function renderSROCTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div class="tool-controls">
      <div class="tool-control">
        <label>Threshold (0-1)</label>
        <input type="range" id="srocThreshold" min="0" max="1" step="0.01" value="0.5" oninput="updateSROC()">
        <span id="thresholdValue">0.50</span>
      </div>
      <div class="tool-control">
        <label>Prevalence (%)</label>
        <input type="number" id="srocPrevalence" min="0.1" max="50" value="5" step="0.5" onchange="updateSROC()">
      </div>
    </div>
    <div id="srocPlot" class="plot-area"></div>
    <div id="srocStats" style="margin-top:1rem;display:grid;grid-template-columns:repeat(4,1fr);gap:1rem;"></div>
  `;

  updateSROC();
}

function updateSROC() {
  const threshold = parseFloat(document.getElementById('srocThreshold')?.value || 0.5);
  const prevalence = parseFloat(document.getElementById('srocPrevalence')?.value || 5) / 100;

  document.getElementById('thresholdValue').textContent = threshold.toFixed(2);

  // Simulated ROC curve (inverted logistic)
  const fprs = [];
  const tprs = [];
  for (let fpr = 0; fpr <= 1; fpr += 0.01) {
    fprs.push(fpr);
    // Higher AUC curve
    const tpr = 1 / (1 + Math.exp(-5 * (fpr - 0.3)));
    tprs.push(Math.min(1, tpr + 0.1));
  }

  // Current operating point based on threshold
  const currentFPR = 1 - threshold;
  const currentTPR = 1 / (1 + Math.exp(-5 * (currentFPR - 0.3)));
  const sens = Math.min(0.99, currentTPR + 0.1);
  const spec = threshold;

  // Calculate PPV, NPV
  const ppv = (sens * prevalence) / (sens * prevalence + (1 - spec) * (1 - prevalence));
  const npv = (spec * (1 - prevalence)) / (spec * (1 - prevalence) + (1 - sens) * prevalence);

  Plotly.newPlot('srocPlot', [
    { x: fprs, y: tprs, name: 'ROC Curve', line: { color: '#3b82f6', width: 2 } },
    { x: [0, 1], y: [0, 1], name: 'Random', line: { color: '#d1d5db', dash: 'dash' } },
    { x: [1-spec], y: [sens], mode: 'markers', name: 'Current Point', marker: { size: 14, color: '#ef4444' } }
  ], {
    title: 'ROC Curve with Operating Point',
    xaxis: { title: '1 - Specificity (False Positive Rate)', range: [0, 1] },
    yaxis: { title: 'Sensitivity (True Positive Rate)', range: [0, 1] },
    legend: { x: 0.6, y: 0.2 },
    margin: { t: 50, r: 20, b: 50, l: 60 }
  }, { responsive: true });

  document.getElementById('srocStats').innerHTML = `
    <div style="text-align:center;padding:0.5rem;background:#dcfce7;border-radius:8px;">
      <div style="font-size:1.5rem;font-weight:bold;color:#166534;">${(sens*100).toFixed(1)}%</div>
      <div style="font-size:0.75rem;color:#166534;">Sensitivity</div>
    </div>
    <div style="text-align:center;padding:0.5rem;background:#dbeafe;border-radius:8px;">
      <div style="font-size:1.5rem;font-weight:bold;color:#1e40af;">${(spec*100).toFixed(1)}%</div>
      <div style="font-size:0.75rem;color:#1e40af;">Specificity</div>
    </div>
    <div style="text-align:center;padding:0.5rem;background:#fef3c7;border-radius:8px;">
      <div style="font-size:1.5rem;font-weight:bold;color:#92400e;">${(ppv*100).toFixed(1)}%</div>
      <div style="font-size:0.75rem;color:#92400e;">PPV</div>
    </div>
    <div style="text-align:center;padding:0.5rem;background:#f3e8ff;border-radius:8px;">
      <div style="font-size:1.5rem;font-weight:bold;color:#6b21a8;">${(npv*100).toFixed(1)}%</div>
      <div style="font-size:0.75rem;color:#6b21a8;">NPV</div>
    </div>
  `;
}

// Network Visualizer
function renderNetworkTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div style="margin-bottom:1rem;">
      <p style="color:#6b7280;font-size:0.9rem;">This interactive network shows how treatments connect through shared comparators. Click nodes to highlight paths.</p>
    </div>
    <div id="networkPlot" class="plot-area"></div>
    <div id="networkInfo" style="margin-top:1rem;padding:1rem;background:#f3f4f6;border-radius:8px;font-size:0.9rem;"></div>
  `;

  // Example network data
  const treatments = ['Placebo', 'Drug A', 'Drug B', 'Drug C', 'Drug D', 'Drug E'];
  const comparisons = [
    { from: 0, to: 1, trials: 8 },
    { from: 0, to: 2, trials: 12 },
    { from: 0, to: 3, trials: 5 },
    { from: 1, to: 2, trials: 3 },
    { from: 1, to: 4, trials: 2 },
    { from: 2, to: 3, trials: 4 },
    { from: 3, to: 5, trials: 2 },
    { from: 4, to: 5, trials: 1 }
  ];

  // Position nodes in a circle
  const n = treatments.length;
  const nodeX = treatments.map((_, i) => Math.cos(2 * Math.PI * i / n - Math.PI/2));
  const nodeY = treatments.map((_, i) => Math.sin(2 * Math.PI * i / n - Math.PI/2));

  // Create edge traces
  const edgeTraces = comparisons.map(c => ({
    x: [nodeX[c.from], nodeX[c.to], null],
    y: [nodeY[c.from], nodeY[c.to], null],
    mode: 'lines',
    line: { width: c.trials, color: '#93c5fd' },
    hoverinfo: 'text',
    text: `${treatments[c.from]} vs ${treatments[c.to]}: ${c.trials} trials`,
    showlegend: false
  }));

  // Node trace
  const nodeTrace = {
    x: nodeX,
    y: nodeY,
    mode: 'markers+text',
    marker: { size: 30, color: '#3b82f6', line: { width: 2, color: '#1e40af' } },
    text: treatments,
    textposition: 'top center',
    hoverinfo: 'text',
    showlegend: false
  };

  Plotly.newPlot('networkPlot', [...edgeTraces, nodeTrace], {
    title: 'Treatment Network',
    showlegend: false,
    xaxis: { visible: false, range: [-1.5, 1.5] },
    yaxis: { visible: false, range: [-1.5, 1.5], scaleanchor: 'x' },
    margin: { t: 50, r: 20, b: 20, l: 20 }
  }, { responsive: true });

  document.getElementById('networkInfo').innerHTML = `
    <strong>Network summary:</strong> ${treatments.length} treatments, ${comparisons.length} direct comparisons, ${comparisons.reduce((s,c) => s+c.trials, 0)} total trials.<br>
    <strong>Connectivity:</strong> Well-connected network with multiple paths between most treatments.<br>
    <em>Edge thickness represents number of trials. Thick edges = more direct evidence.</em>
  `;
}

// MASEM Path Diagram Visualizer
function renderMASEMTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div style="margin-bottom:1rem;">
      <p style="color:#6b7280;font-size:0.9rem;">Interactive MASEM path diagram. Adjust path coefficients to see how indirect effects change.</p>
    </div>
    <div class="tool-controls">
      <div class="tool-control">
        <label>X ‚Üí M (a path)</label>
        <input type="range" id="pathA" min="0" max="0.9" step="0.05" value="0.5" oninput="updateMASEMPlot()">
        <span id="pathAVal">0.50</span>
      </div>
      <div class="tool-control">
        <label>M ‚Üí Y (b path)</label>
        <input type="range" id="pathB" min="0" max="0.9" step="0.05" value="0.4" oninput="updateMASEMPlot()">
        <span id="pathBVal">0.40</span>
      </div>
      <div class="tool-control">
        <label>X ‚Üí Y direct (c' path)</label>
        <input type="range" id="pathC" min="-0.3" max="0.5" step="0.05" value="0.1" oninput="updateMASEMPlot()">
        <span id="pathCVal">0.10</span>
      </div>
    </div>
    <div id="masemDiagram" style="margin:1.5rem 0;text-align:center;"></div>
    <div id="masemResults" style="padding:1rem;background:#f3f4f6;border-radius:8px;"></div>
  `;

  updateMASEMPlot();
}

function updateMASEMPlot() {
  const a = parseFloat(document.getElementById('pathA').value);
  const b = parseFloat(document.getElementById('pathB').value);
  const c = parseFloat(document.getElementById('pathC').value);

  document.getElementById('pathAVal').textContent = a.toFixed(2);
  document.getElementById('pathBVal').textContent = b.toFixed(2);
  document.getElementById('pathCVal').textContent = c.toFixed(2);

  const indirect = a * b;
  const total = indirect + c;
  const propMediated = total !== 0 ? (indirect / total * 100).toFixed(1) : 0;

  // Draw SVG path diagram
  document.getElementById('masemDiagram').innerHTML = `
    <svg width="400" height="200" viewBox="0 0 400 200">
      <!-- Boxes -->
      <rect x="30" y="80" width="80" height="40" fill="#3b82f6" rx="5"/>
      <text x="70" y="105" text-anchor="middle" fill="white" font-weight="bold">X</text>

      <rect x="160" y="20" width="80" height="40" fill="#8b5cf6" rx="5"/>
      <text x="200" y="45" text-anchor="middle" fill="white" font-weight="bold">M</text>

      <rect x="290" y="80" width="80" height="40" fill="#22c55e" rx="5"/>
      <text x="330" y="105" text-anchor="middle" fill="white" font-weight="bold">Y</text>

      <!-- Arrows -->
      <defs>
        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
          <polygon points="0 0, 10 3.5, 0 7" fill="#374151"/>
        </marker>
      </defs>

      <!-- X to M -->
      <line x1="110" y1="85" x2="160" y2="55" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
      <text x="125" y="60" fill="#374151" font-size="14">a=${a.toFixed(2)}</text>

      <!-- M to Y -->
      <line x1="240" y1="55" x2="290" y2="85" stroke="#374151" stroke-width="2" marker-end="url(#arrowhead)"/>
      <text x="265" y="60" fill="#374151" font-size="14">b=${b.toFixed(2)}</text>

      <!-- X to Y direct -->
      <line x1="110" y1="100" x2="288" y2="100" stroke="#9ca3af" stroke-width="2" stroke-dasharray="5,5" marker-end="url(#arrowhead)"/>
      <text x="200" y="125" fill="#9ca3af" font-size="14">c'=${c.toFixed(2)}</text>
    </svg>
  `;

  const mediationType = c < 0.05 ? 'Full mediation' : indirect > Math.abs(c) ? 'Partial mediation' : 'No significant mediation';

  document.getElementById('masemResults').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
      <div>
        <strong>Indirect effect (a√ób):</strong><br>
        <span style="font-size:1.5rem;color:#8b5cf6;">${indirect.toFixed(3)}</span>
      </div>
      <div>
        <strong>Direct effect (c'):</strong><br>
        <span style="font-size:1.5rem;color:#9ca3af;">${c.toFixed(3)}</span>
      </div>
      <div>
        <strong>Total effect:</strong><br>
        <span style="font-size:1.5rem;color:#22c55e;">${total.toFixed(3)}</span>
      </div>
      <div>
        <strong>% Mediated:</strong><br>
        <span style="font-size:1.5rem;color:#3b82f6;">${propMediated}%</span>
      </div>
    </div>
    <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid #e5e7eb;">
      <strong>Interpretation:</strong> ${mediationType}<br>
      <em>${indirect > 0.1 ? 'Substantial indirect pathway. Interventions on M may be effective.' : 'Weak indirect pathway. M may not be a useful intervention target.'}</em>
    </div>
  `;
}

// Dose-Response Curve Visualizer
function renderDoseResponseTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div style="margin-bottom:1rem;">
      <p style="color:#6b7280;font-size:0.9rem;">Explore different dose-response curve shapes. See how assumptions change interpretation.</p>
    </div>
    <div class="tool-controls">
      <div class="tool-control">
        <label>Curve Shape</label>
        <select id="curveShape" onchange="updateDoseResponsePlot()">
          <option value="linear">Linear</option>
          <option value="jcurve" selected>J-Curve</option>
          <option value="threshold">Threshold</option>
          <option value="ceiling">Ceiling Effect</option>
          <option value="ucurve">U-Curve</option>
        </select>
      </div>
      <div class="tool-control">
        <label>Nadir/Threshold Position</label>
        <input type="range" id="nadirPos" min="1" max="4" step="0.5" value="2" oninput="updateDoseResponsePlot()">
        <span id="nadirPosVal">2</span>
      </div>
    </div>
    <div id="doseResponsePlot" class="plot-area"></div>
    <div id="doseResponseInfo" style="margin-top:1rem;padding:1rem;background:#f3f4f6;border-radius:8px;"></div>
  `;

  updateDoseResponsePlot();
}

function updateDoseResponsePlot() {
  const shape = document.getElementById('curveShape').value;
  const nadir = parseFloat(document.getElementById('nadirPos').value);
  document.getElementById('nadirPosVal').textContent = nadir.toFixed(1);

  const doses = [];
  const rrs = [];
  const lower = [];
  const upper = [];

  for (let d = 0; d <= 6; d += 0.2) {
    doses.push(d);
    let rr, se;

    switch(shape) {
      case 'linear':
        rr = 1 - 0.08 * d;
        se = 0.03;
        break;
      case 'jcurve':
        rr = 1 - 0.15 * d + 0.04 * d * d;
        se = 0.02 + 0.01 * d;
        break;
      case 'threshold':
        rr = d < nadir ? 1 : 1 - 0.15 * (d - nadir);
        se = 0.03;
        break;
      case 'ceiling':
        rr = 1 - 0.25 * (1 - Math.exp(-d / nadir));
        se = 0.02;
        break;
      case 'ucurve':
        rr = 1 + 0.1 * Math.pow(d - nadir, 2) - 0.15;
        se = 0.03;
        break;
    }

    rrs.push(Math.max(0.4, Math.min(1.4, rr)));
    lower.push(Math.max(0.3, rr - 1.96 * se));
    upper.push(Math.min(1.5, rr + 1.96 * se));
  }

  const traceRR = {
    x: doses,
    y: rrs,
    mode: 'lines',
    name: 'Relative Risk',
    line: { color: '#3b82f6', width: 3 }
  };

  const traceCI = {
    x: [...doses, ...doses.slice().reverse()],
    y: [...upper, ...lower.slice().reverse()],
    fill: 'toself',
    fillcolor: 'rgba(59,130,246,0.2)',
    line: { color: 'transparent' },
    name: '95% CI',
    showlegend: true,
    hoverinfo: 'skip'
  };

  const traceRef = {
    x: [0, 6],
    y: [1, 1],
    mode: 'lines',
    line: { color: '#ef4444', width: 1, dash: 'dash' },
    name: 'No effect',
    showlegend: true
  };

  Plotly.newPlot('doseResponsePlot', [traceCI, traceRR, traceRef], {
    title: `Dose-Response Curve (${shape})`,
    xaxis: { title: 'Dose (units/day)', range: [0, 6] },
    yaxis: { title: 'Relative Risk', range: [0.4, 1.4] },
    showlegend: true,
    legend: { x: 0.7, y: 0.95 },
    margin: { t: 50, r: 20, b: 50, l: 60 }
  }, { responsive: true });

  const minRR = Math.min(...rrs);
  const optDose = doses[rrs.indexOf(minRR)];

  const interpretations = {
    linear: 'Linear model assumes constant benefit per unit dose. Often an oversimplification. Higher doses would appear infinitely beneficial.',
    jcurve: `J-curve shows benefit at low doses, harm at high doses. Optimal dose around ${optDose.toFixed(1)} units. Classic pattern for alcohol/CVD, some nutrients.`,
    threshold: `No effect until threshold (${nadir} units), then benefit. Suggests minimum effective dose. Below threshold, intervention is wasted.`,
    ceiling: `Benefit plateaus after ~${nadir} units. Adding more dose provides diminishing returns. Focus on reaching threshold, not maximizing.`,
    ucurve: `Both low AND high doses harmful. Optimal at ${nadir} units. Deficiency and excess both problematic (e.g., vitamin D, BMI).`
  };

  document.getElementById('doseResponseInfo').innerHTML = `
    <strong>Minimum RR:</strong> ${minRR.toFixed(2)} at ${optDose.toFixed(1)} units/day<br><br>
    <strong>Interpretation:</strong> ${interpretations[shape]}<br><br>
    <em style="color:#ef4444;">Warning: A linear model would miss the reversal/plateau. Always test for non-linearity.</em>
  `;
}

// Umbrella Review Credibility Assessment Tool
function renderCredibilityTool(containerId) {
  const container = document.getElementById(containerId);
  if (!container) return;

  container.innerHTML = `
    <div style="margin-bottom:1rem;">
      <p style="color:#6b7280;font-size:0.9rem;">Assess the credibility of meta-analytic evidence using established criteria.</p>
    </div>
    <div class="tool-controls" style="flex-direction:column;">
      <div class="tool-control" style="width:100%;">
        <label>Total cases (or N for continuous)</label>
        <input type="number" id="credCases" value="1500" oninput="updateCredibilityAssessment()">
      </div>
      <div class="tool-control" style="width:100%;">
        <label>P-value (e.g., 0.001)</label>
        <input type="number" id="credPval" value="0.0001" step="0.0001" oninput="updateCredibilityAssessment()">
      </div>
      <div class="tool-control" style="width:100%;">
        <label>I¬≤ heterogeneity (%)</label>
        <input type="number" id="credI2" value="35" min="0" max="100" oninput="updateCredibilityAssessment()">
      </div>
      <div class="tool-control" style="width:100%;">
        <label>Small-study bias detected?</label>
        <select id="credBias" onchange="updateCredibilityAssessment()">
          <option value="no">No</option>
          <option value="yes">Yes</option>
        </select>
      </div>
      <div class="tool-control" style="width:100%;">
        <label>Largest study significant?</label>
        <select id="credLargest" onchange="updateCredibilityAssessment()">
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>
    <div id="credibilityResult" style="margin-top:1.5rem;padding:1.5rem;border-radius:8px;text-align:center;"></div>
    <div id="credibilityChecklist" style="margin-top:1rem;padding:1rem;background:#f8fafc;border-radius:8px;font-size:0.9rem;"></div>
  `;

  updateCredibilityAssessment();
}

function updateCredibilityAssessment() {
  const cases = parseInt(document.getElementById('credCases').value) || 0;
  const pval = parseFloat(document.getElementById('credPval').value) || 1;
  const i2 = parseInt(document.getElementById('credI2').value) || 0;
  const hasBias = document.getElementById('credBias').value === 'yes';
  const largestSig = document.getElementById('credLargest').value === 'yes';

  const checks = {
    cases1000: cases >= 1000,
    pHighlySig: pval < 0.000001,
    pSig: pval < 0.001,
    pMod: pval < 0.05,
    lowHet: i2 < 50,
    noBias: !hasBias,
    largestSig: largestSig
  };

  let grade, color, description;

  if (checks.cases1000 && checks.pHighlySig && checks.lowHet && checks.noBias && checks.largestSig) {
    grade = 'CONVINCING';
    color = '#22c55e';
    description = 'Tous les crit√®res sont remplis. Preuves solides qui peuvent √©clairer la pratique.';
  } else if (checks.cases1000 && checks.pHighlySig) {
    grade = 'HIGHLY SUGGESTIVE';
    color = '#84cc16';
    description = '√âchantillon important et hautement significatif, mais d\'autres crit√®res ne sont pas remplis. Preuves raisonnablement solides.';
  } else if (checks.cases1000 && checks.pSig) {
    grade = 'SUGGESTIVE';
    color = '#f59e0b';
    description = '√âchantillon ad√©quat et significatif, mais probl√®mes d\'h√©t√©rog√©n√©it√© ou de biais. √Ä interpr√©ter avec prudence.';
  } else if (checks.pMod) {
    grade = 'WEAK';
    color = '#ef4444';
    description = 'Statistically significant but fails multiple credibility criteria. Low confidence in the finding.';
  } else {
    grade = 'NON-SIGNIFICANT';
    color = '#6b7280';
    description = 'N\'atteint pas la signification statistique. Aucune preuve cr√©dible d\'un effet.';
  }

  document.getElementById('credibilityResult').innerHTML = `
    <div style="font-size:0.9rem;color:#6b7280;margin-bottom:0.5rem;">EVIDENCE GRADE</div>
    <div style="font-size:2rem;font-weight:bold;color:${color};">${grade}</div>
    <div style="margin-top:0.5rem;color:#374151;">${description}</div>
  `;

  document.getElementById('credibilityChecklist').innerHTML = `
    <strong>Criteria Checklist:</strong>
    <ul style="margin-top:0.5rem;list-style:none;padding:0;">
      <li>${checks.cases1000 ? '‚úÖ' : '‚ùå'} Sample size ‚â• 1,000 cases (${cases.toLocaleString()})</li>
      <li>${checks.pHighlySig ? '‚úÖ' : (checks.pSig ? '‚ö†Ô∏è' : '‚ùå')} P-value < 10‚Åª‚Å∂ (p = ${pval < 0.0001 ? pval.toExponential(1) : pval})</li>
      <li>${checks.lowHet ? '‚úÖ' : '‚ùå'} I¬≤ < 50% (I¬≤ = ${i2}%)</li>
      <li>${checks.noBias ? '‚úÖ' : '‚ùå'} No evidence of small-study bias</li>
      <li>${checks.largestSig ? '‚úÖ' : '‚ùå'} Largest study shows significant effect</li>
    </ul>
    <div style="margin-top:1rem;padding-top:0.5rem;border-top:1px solid #e5e7eb;font-size:0.85rem;color:#6b7280;">
      <em>Based on Ioannidis criteria for umbrella reviews. 'Convincing' ‚âà top 2% of published associations.</em>
    </div>
  `;
}

// ============================================================
// CORE COURSE FUNCTIONALITY
// ============================================================
const STORAGE_KEY = 'advancedMetaAnalysisCourse_v2';

let state = {
  currentModule: 0,
  currentSlide: 0,
  points: 0,
  completedModules: [],
  toolsUsed: [],
  quizAnswered: {}
};

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) state = { ...state, ...JSON.parse(saved) };
  } catch (e) {
    console.warn('Failed to load state, using defaults');
  }
}

function saveState() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  } catch (e) {}
}

function initCourse() {
  loadState();
  renderModuleList();
  renderSlide();
  updateProgress();

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    const tag = e.target.tagName;
    if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || e.target.isContentEditable) return;
    if (e.target.matches('button, a, [role="button"]')) {
        if (e.key === ' ' || e.key === 'Enter') return;
    }
    if (e.key === 'Escape') { closeDashboard(); closeGlossary(); }
    if (e.key === 'ArrowRight') { e.preventDefault(); nextSlide(); }
    if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
  });
}

function renderModuleList() {
  const list = document.getElementById('moduleList');
  list.innerHTML = modules.map((m, i) => `
    <div class="module-item ${i === state.currentModule ? 'active' : ''} ${state.completedModules.includes(i) ? 'completed' : ''}"
         onclick="goToModule(${i})" tabindex="0" role="button" aria-label="Module ${i}: ${m.title}"
         onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();goToModule(${i});}">
      <div class="module-number">${i}</div>
      <div class="module-info">
        <div class="module-title">${m.title}</div>
        <div class="module-subtitle">${m.subtitle}</div>
      </div>
    </div>
  `).join('');
}

function renderSlide() {
  const module = modules[state.currentModule];
  const slide = module.slides[state.currentSlide];
  const container = document.getElementById('slideContainer');

  document.getElementById('moduleIndicator').textContent = `Module ${module.id}: ${module.title}`;
  document.getElementById('slideCounter').textContent = `${state.currentSlide + 1} / ${module.slides.length}`;

  const overallSlides = modules.reduce((s, m) => s + m.slides.length, 0);
  let currentOverall = 0;
  for (let i = 0; i < state.currentModule; i++) currentOverall += modules[i].slides.length;
  currentOverall += state.currentSlide + 1;
  document.getElementById('overallProgress').textContent = `Overall: ${Math.round(currentOverall/overallSlides*100)}%`;

  container.innerHTML = `<div class="slide active animate-in">${renderSlideContent(slide)}</div>`;

  document.getElementById('prevBtn').disabled = state.currentSlide === 0;
  document.getElementById('nextBtn').disabled = state.currentSlide === module.slides.length - 1;

  // Initialize tools if present
  setTimeout(() => {
    if (slide.type === 'tool-bayes') renderBayesianTool(slide.content.id);
    if (slide.type === 'tool-roc') renderSROCTool(slide.content.id);
    if (slide.type === 'tool-network') renderNetworkTool(slide.content.id);
    if (slide.type === 'tool-masem') renderMASEMTool(slide.content.id);
    if (slide.type === 'tool-dose') renderDoseResponseTool(slide.content.id);
    if (slide.type === 'tool-umbrella') renderCredibilityTool(slide.content.id);
  }, 100);
}

function renderSlideContent(slide) {
  switch(slide.type) {
    case 'title':
      return `<div class="slide-content" style="text-align:center;padding:3rem;">
        <h1 class="slide-title" style="font-size:3rem;margin-bottom:1rem;">${slide.content.title}</h1>
        <p style="font-size:1.3rem;color:var(--gold);margin-bottom:2rem;">${slide.content.subtitle}</p>
        <p style="font-size:1.1rem;opacity:0.8;max-width:600px;margin:0 auto;">${slide.content.text}</p>
      </div>`;

    case 'principle':
      return `<div class="principle-display" style="padding:4rem 2rem;">
        <p class="principle-text">"${slide.content.text}"</p>
      </div>`;

    case 'rhetoric':
      return `<div class="rhetoric-question">${slide.content.question}</div>`;

    case 'oath':
      return `<div class="oath-statement">${slide.content.text}</div>`;

    case 'story':
      return `<div class="story-box">
        <div class="story-label">${slide.content.label}</div>
        <div class="story-text">${slide.content.text}</div>
        <div class="story-hook">${slide.content.hook}</div>
      </div>`;

    case 'story-deep':
      return `<div class="story-deep">
        <div class="story-label">${slide.content.label}</div>
        <div class="real-data-source">${slide.content.source}</div>
        <div class="story-timeline">
          ${slide.content.timeline.map(e => `
            <div class="timeline-event ${e.type || ''}">
              <div class="timeline-year">${e.year}</div>
              <div class="timeline-text">${e.text}</div>
            </div>
          `).join('')}
        </div>
        ${slide.content.realData ? `
          <div class="real-data-card">
            <div class="real-data-header"><strong>Real Data</strong></div>
            <div class="real-data-grid">
              ${Object.entries(slide.content.realData).map(([k,v]) => `
                <div class="real-data-stat">
                  <span class="label">${k}:</span>
                  <span class="value">${v}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
        <div class="story-hook">${slide.content.hook}</div>
      </div>`;

    case 'content':
      return `<div class="slide-content">
        <h2 class="slide-title">${slide.content.title}</h2>
        ${slide.content.sections.map(s => `
          <div class="method-box">
            <h3 style="color:var(--gold);margin-bottom:0.75rem;">${s.heading}</h3>
            ${s.items ? `<ul>${s.items.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
            ${s.text ? `<p style="line-height:1.6;">${s.text}</p>` : ''}
          </div>
        `).join('')}
      </div>`;

    case 'method':
      return `<div class="method-box">
        <div class="method-label">${slide.content.label}</div>
        <div class="method-content">
          <h3>${slide.content.title}</h3>
          ${slide.content.sections.map(s => `
            <div style="margin:1rem 0;">
              <strong style="color:var(--gold);">${s.heading}</strong>
              <p style="margin-top:0.5rem;line-height:1.6;">${s.text}</p>
            </div>
          `).join('')}
        </div>
      </div>`;

    case 'contrast':
      // Support both formats: wrong/right with text, or leftTitle/rightTitle with items
      if (slide.content.leftTitle) {
        return `<div class="slide-content">
          <h2 class="slide-title">${slide.content.title || 'Comparison'}</h2>
          <div class="contrast-container">
            <div class="contrast-box wrong">
              <div class="contrast-title">${slide.content.leftTitle}</div>
              <ul style="margin:0;padding-left:1.5rem;">${slide.content.leftItems.map(i => `<li>${i}</li>`).join('')}</ul>
            </div>
            <div class="contrast-box right">
              <div class="contrast-title">${slide.content.rightTitle}</div>
              <ul style="margin:0;padding-left:1.5rem;">${slide.content.rightItems.map(i => `<li>${i}</li>`).join('')}</ul>
            </div>
          </div>
        </div>`;
      }
      return `<div class="slide-content">
        <h2 class="slide-title">${slide.content.title}</h2>
        <div class="contrast-container">
          <div class="contrast-box wrong">
            <div class="contrast-title">${slide.content.wrong.title}</div>
            <p>${slide.content.wrong.text}</p>
          </div>
          <div class="contrast-box right">
            <div class="contrast-title">${slide.content.right.title}</div>
            <p>${slide.content.right.text}</p>
          </div>
        </div>
      </div>`;

    case 'warning':
      return `<div class="warning-box">
        <div class="warning-title">${slide.content.title}</div>
        <p style="line-height:1.6;">${slide.content.text}</p>
      </div>`;

    case 'vivid-consequence':
      return `<div class="vivid-consequence">
        <p style="line-height:1.7;">${slide.content.text}</p>
        <div class="death-toll">${slide.content.toll}</div>
        <div class="toll-label">${slide.content.tollLabel}</div>
      </div>`;

    case 'clinical-guide':
      return `<div class="clinical-guide">
        <div class="guide-title">üè• ${slide.content.title}</div>
        <ul class="clinical-checklist">
          ${slide.content.items.map(i => `<li>${i}</li>`).join('')}
        </ul>
      </div>`;

    case 'cycle-return':
      return `<div class="cycle-return">
        <p style="font-size:0.8rem;color:var(--gold);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:0.5rem;">Return to the Principle</p>
        <p class="principle-recall">"${slide.content.principle}"</p>
      </div>`;

    case 'tool-bayes':
    case 'tool-roc':
    case 'tool-network':
    case 'tool-ipd':
    case 'tool-masem':
    case 'tool-dose':
    case 'tool-umbrella':
      return `<div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîß</span>
          <span class="tool-title">${slide.content.title}</span>
        </div>
        <p style="margin-bottom:1rem;">${slide.content.description}</p>
        <div id="${slide.content.id}"></div>
      </div>`;

    case 'decision-tree':
      return renderDecisionTree(slide.content);

    case 'scenario':
      return renderScenario(slide.content);

    case 'quiz':
      return renderQuiz(slide.content);

    default:
      return `<div class="slide-content"><p>Slide type: ${slide.type}</p></div>`;
  }
}

function renderDecisionTree(content) {
  const firstNode = content.nodes.find(n => n.id === 'start') || content.nodes[0];
  return `
    <div class="decision-tree">
      <h3 style="color:var(--gold);margin-bottom:1rem;font-family:'Cormorant Garamond',serif;font-size:1.4rem;">${content.title}</h3>
      <div class="scenario-situation">${content.situation}</div>
      <div id="decision-container">${renderDecisionNode(firstNode, content.nodes)}</div>
    </div>`;
}

function renderDecisionNode(node, allNodes) {
  if (node.type === 'outcome') {
    return `<div class="decision-outcome visible ${node.consequence}">
      <h4 style="margin-bottom:0.5rem;">${node.title}</h4>
      <p style="margin-bottom:0.5rem;">${node.text}</p>
      ${node.realCase ? `<p style="font-style:italic;opacity:0.8;"><strong>Real case:</strong> ${node.realCase}</p>` : ''}
    </div>`;
  }
  return `<div class="decision-node active">
    <div class="decision-question">${node.question}</div>
    <div class="decision-branches">
      ${node.branches.map(b => `
        <div class="decision-branch" onclick="selectBranch('${b.nextNode}', this)">
          <span class="branch-arrow">‚Üí</span>
          <span>${b.text}</span>
        </div>
      `).join('')}
    </div>
  </div>`;
}

function selectBranch(nextNodeId, element) {
  const module = modules[state.currentModule];
  const slide = module.slides[state.currentSlide];
  const nodes = slide.content.nodes;
  const nextNode = nodes.find(n => n.id === nextNodeId);
  if (nextNode) {
    element.classList.add('selected');
    document.getElementById('decision-container').innerHTML += renderDecisionNode(nextNode, nodes);
    if (nextNode.type === 'outcome' && nextNode.consequence === 'good') addPoints(15);
  }
}

function renderScenario(content) {
  return `<div class="scenario-panel">
    <div class="scenario-header">
      <span class="scenario-icon">üîÄ</span>
      <span class="scenario-title">${content.title}</span>
    </div>
    <div class="scenario-situation">${content.situation}</div>
    <div class="scenario-question">${content.question}</div>
    <div class="scenario-choices">
      ${content.choices.map(c => `
        <div class="scenario-choice" data-id="${c.id}" onclick="selectScenarioChoice('${c.id}', '${c.consequence}', '${content.correct}', this)">
          <span class="choice-letter">${c.id.toUpperCase()}</span>
          <span>${c.text}</span>
        </div>
      `).join('')}
    </div>
    <div id="scenario-result" class="scenario-result"></div>
  </div>`;
}

function selectScenarioChoice(id, consequence, correct, element) {
  document.querySelectorAll('.scenario-choice').forEach(c => {
    c.style.pointerEvents = 'none';
    if (c.dataset.id === correct) c.classList.add('correct');
  });
  if (id !== correct) element.classList.add('incorrect');

  const module = modules[state.currentModule];
  const slide = module.slides[state.currentSlide];
  const choice = slide.content.choices.find(c => c.id === id);

  const result = document.getElementById('scenario-result');
  result.className = `scenario-result visible ${consequence}`;
  result.innerHTML = `<p>${choice.result}</p>`;

  if (consequence === 'good') addPoints(15);
}

function renderQuiz(content) {
  const quizKey = `${state.currentModule}-${state.currentSlide}`;
  const answered = state.quizAnswered[quizKey];

  return `<div class="quiz-container">
    <div class="quiz-question">${content.question}</div>
    <div class="quiz-options">
      ${content.options.map(o => `
        <div class="quiz-option ${answered ? (o.correct ? 'correct' : answered === o.id && !o.correct ? 'incorrect' : '') : ''}"
             data-id="${o.id}" ${answered ? '' : `onclick="selectQuizOption('${o.id}', ${o.correct}, this)"`}
             style="${answered ? 'pointer-events:none;' : ''}">${o.text}</div>
      `).join('')}
    </div>
    <div class="quiz-explanation ${answered ? 'visible' : ''}">${content.explanation}</div>
  </div>`;
}

function selectQuizOption(id, correct, element) {
  const quizKey = `${state.currentModule}-${state.currentSlide}`;
  state.quizAnswered[quizKey] = id;
  saveState();

  document.querySelectorAll('.quiz-option').forEach(o => {
    o.style.pointerEvents = 'none';
    const module = modules[state.currentModule];
    const slide = module.slides[state.currentSlide];
    const opt = slide.content.options.find(op => op.id === o.dataset.id);
    if (opt?.correct) o.classList.add('correct');
  });

  if (!correct) element.classList.add('incorrect');
  document.querySelector('.quiz-explanation').classList.add('visible');

  if (correct) addPoints(20);
}

function addPoints(pts) {
  state.points += pts;
  document.getElementById('sidebarPoints').textContent = `${state.points} pts`;
  saveState();
}

function prevSlide() {
  if (state.currentSlide > 0) {
    state.currentSlide--;
    renderSlide();
    saveState();
  } else if (state.currentModule > 0) {
    state.currentModule--;
    state.currentSlide = modules[state.currentModule].slides.length - 1;
    renderModuleList();
    renderSlide();
    saveState();
  }
}

function nextSlide() {
  const module = modules[state.currentModule];
  if (state.currentSlide < module.slides.length - 1) {
    state.currentSlide++;
    renderSlide();
    saveState();
  } else if (state.currentModule < modules.length - 1) {
    if (!state.completedModules.includes(state.currentModule)) state.completedModules.push(state.currentModule);
    state.currentModule++;
    state.currentSlide = 0;
    renderModuleList();
    renderSlide();
    saveState();
  }
}

function goToModule(index) {
  if (index !== state.currentModule) {
    const prev = modules[state.currentModule];
    if (state.currentSlide === prev.slides.length - 1 && !state.completedModules.includes(state.currentModule)) {
      state.completedModules.push(state.currentModule);
    }
    state.currentModule = index;
    state.currentSlide = 0;
    renderModuleList();
    renderSlide();
    updateProgress();
    saveState();
  }
}

function goToNextModule() {
  if (state.currentModule < modules.length - 1) goToModule(state.currentModule + 1);
}

function updateProgress() {
  const percent = Math.round((state.completedModules.length / modules.length) * 100);
  document.getElementById('progressPercent').textContent = `${percent}%`;
  document.getElementById('progressFill').style.width = `${percent}%`;
}

function openDashboard() {
  document.getElementById('progressDashboard').classList.add('open');
  document.getElementById('totalPoints').textContent = state.points;
  document.getElementById('modulesCompleted').textContent = `${state.completedModules.length}/${modules.length}`;
  document.getElementById('toolsUsed').textContent = state.toolsUsed.length;
}

function closeDashboard() {
  document.getElementById('progressDashboard').classList.remove('open');
}

function openGlossary() {
  document.getElementById('glossaryOverlay').classList.add('open');
  renderGlossary();
}

function closeGlossary() {
  document.getElementById('glossaryOverlay').classList.remove('open');
}

function renderGlossary(filter = '') {
  const filtered = glossaryTerms.filter(t =>
    t.term.toLowerCase().includes(filter.toLowerCase()) ||
    t.def.toLowerCase().includes(filter.toLowerCase())
  );
  document.getElementById('glossaryContent').innerHTML = filtered.map(t => `
    <div class="glossary-term">
      <strong>${t.term}</strong><br>
      <span style="color:#4b5563;">${t.def}</span>
    </div>
  `).join('');
}

function filterGlossary() {
  const query = document.getElementById('glossarySearch').value;
  renderGlossary(query);
}

document.addEventListener('DOMContentLoaded', initCourse);
</script>
</body>
</html>
