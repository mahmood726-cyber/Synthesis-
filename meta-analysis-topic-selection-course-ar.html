<!DOCTYPE html>

<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>اختيار موضوع التحليل التلوي: السؤال الصحيح</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&amp;family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-left: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-right: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-right-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active { background: rgba(249,115,22,0.2); border-color: var(--orange); }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-right: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-right-color: var(--green); }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-right-color: var(--orange); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-right-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Confidence Colors */
    .cerqual-high { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(30,39,97,0.2)); border-color: var(--green); }
    .cerqual-moderate { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,39,97,0.2)); border-color: #3b82f6; }
    .cerqual-low { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(30,39,97,0.2)); border-color: var(--orange); }
    .cerqual-very-low { background: linear-gradient(135deg, rgba(197,48,48,0.2), rgba(30,39,97,0.2)); border-color: var(--red); }

    .cerqual-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .cerqual-badge.high { background: var(--green); color: white; }
    .cerqual-badge.moderate { background: #3b82f6; color: white; }
    .cerqual-badge.low { background: var(--orange); color: white; }
    .cerqual-badge.very-low { background: var(--red); color: white; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-right: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-right: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .decision-option:hover { background: rgba(124,58,237,0.2); border-color: var(--purple); }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Quiz */
    .quiz-container { width: 100%; max-width: 650px; }
    .quiz-question {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      margin-bottom: 1.25rem;
      text-align: center;
    }
    .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: right;
      font-size: 0.9rem;
    }
    .quiz-option:hover { background: rgba(212,175,55,0.15); border-color: var(--gold); }
    .quiz-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .quiz-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .quiz-option.disabled { pointer-events: none; }
    .quiz-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .quiz-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }
    .quiz-feedback.show { display: block; }
    .quiz-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .quiz-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: '○'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      .confetti { animation: none; display: none; }
      .xp-popup { transition: none; }
      .slide { transition: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; max-width: 220px; }
    .progress-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      padding: 0;
      appearance: none;
      position: relative;
    }
    .progress-dot::after {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .progress-dot.active::after { background: var(--gold); transform: translate(-50%, -50%) scale(1.4); }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-right: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }
  </style>
</head>
<body>
<a class="skip-link" href="#main-content">انتقل إلى المحتوى الرئيسي</a>
<div class="course-container">
 الشريط الجانبي 
<nav aria-label="الملاحة بالطبع" class="sidebar" role="navigation">
<div class="sidebar-header">
<a href="index-ar.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;">← مكتبة الدورة</a>
<h1>اختيار الموضوع</h1>
<p>اختيار السؤال المناسب</p>
</div>
<div class="stats-panel">
<div class="level-display">
<div class="level-badge" id="levelIcon">QS</div>
<div class="level-info">
<div class="level-title" id="levelTitle">الباحث عن الأسئلة</div>
<div class="level-subtitle">مستوى <span id="levelNum">1</span></div>
</div>
</div>
<div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
<div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
<div class="quick-stats">
<div class="quick-stat">
<div class="quick-stat-value" id="correctCount">0</div>
<div class="quick-stat-label">صحيح</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="decisionCount">0</div>
<div class="quick-stat-label">القرارات</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="synthesisCount">0</div>
<div class="quick-stat-label">المكرر</div>
</div>
</div>
</div>
<div class="course-progress">
<div class="course-progress-label">
<span>تقدم الدورة</span>
<span id="courseProgressPct">0%</span>
</div>
<div class="course-progress-bar">
<div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
</div>
</div>
<div class="module-list" id="moduleList"></div>
<div class="badges-panel">
<div class="badges-title">الإنجازات</div>
<div class="badges-grid" id="badgesGrid"></div>
</div>
</nav>
 المحتوى الرئيسي 
<main class="main-content" id="main-content">
<header class="content-header">
<div class="breadcrumb">اختيار الموضوع / <span id="currentModule">الوحدة 1</span></div>
<div class="header-actions">
<div class="streak-display" id="streakDisplay">
<span class="streak-flame">ST</span>
<span class="streak-count" id="streakCount">0</span>
<span>خط اليوم</span>
</div>
<button class="btn" onclick="resetProgress()">إعادة ضبط</button>
</div>
</header>
<div class="content-body">
<div class="slides-container" id="slidesContainer"></div>
</div>
</main>
</div>
 XP المنبثقة 
<div aria-atomic="true" aria-live="polite" class="xp-popup" id="xpPopup" role="status">
<span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>
 شارة مشروطة 
<div aria-labelledby="badgeModalTitle" aria-modal="true" class="badge-modal" id="badgeModal" role="dialog">
<div class="badge-modal-content">
<div class="badge-modal-icon" id="badgeModalIcon">AW</div>
<div class="badge-modal-title" id="badgeModalTitle">تم الحصول على الشارة!</div>
<div class="badge-modal-desc" id="badgeModalDesc">لقد فتحت إنجازًا جديدًا</div>
<button class="badge-modal-close" onclick="closeBadgeModal()">مذهل!</button>
</div>
</div>
 حاوية قصاصات الورق 
<div class="confetti-container" id="confettiContainer"></div>
 عداد التحرير والسرد 
<div aria-live="polite" class="combo-display" id="comboDisplay" role="status">COMBO <span id="comboCount">0</span>x</div>
 تبديل الشريط الجانبي المحمول 
<button aria-expanded="false" aria-label="Toggle menu" class="sidebar-toggle" onclick="toggleSidebar()">MENU</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {}
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

let gameState = safeGetStorage('topicSelectionGame', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "الباحث عن الأسئلة", icon: "QS", xp: 0 },
  { level: 2, title: "Scope Shaper", icon: "SS", xp: 100 },
  { level: 3, title: "Evidence Scout", icon: "ES", xp: 250 },
  { level: 4, title: "Impact Interpreter", icon: "II", xp: 450 },
  { level: 5, title: "Novelty Hunter", icon: "NH", xp: 700 },
  { level: 6, title: "Bias Sentinel", icon: "BS", xp: 1000 },
  { level: 7, title: "Protocol Forger", icon: "PF", xp: 1400 },
  { level: 8, title: "Topic Architect", icon: "TA", xp: 1900 }
];

const BADGES = [
  { id: "first_question", icon: "FQ", name: "السؤال الأول", desc: "أكمل سيناريو القرار الأول" },
  { id: "scope_shaper", icon: "SS", name: "Scope Shaper", desc: "أكمل وحدة الإطار" },
  { id: "evidence_scout", icon: "ES", name: "Evidence Scout", desc: "أكمل وحدة حقل الأدلة" },
  { id: "impact_guardian", icon: "IG", name: "Impact Guardian", desc: "أكمل وحدة أصحاب المصلحة" },
  { id: "novelty_hawk", icon: "NH", name: "Novelty Hawk", desc: "أكمل وحدة الأصداء" },
  { id: "bias_sentinel", icon: "BS", name: "Bias Sentinel", desc: "أكمل المرآة الوحدة" },
  { id: "topic_forger", icon: "TF", name: "Topic Forger", desc: "أكمل وحدة Topic Forge" },
  { id: "perfect_5", icon: "5x", name: "Five Star", desc: "احصل على 5 إجابات صحيحة على التوالي" },
  { id: "decision_maker", icon: "DM", name: "Decision Maker", desc: "أكمل 15 شجرة قرار" },
  { id: "finisher", icon: "FN", name: "أكمل الدورة", desc: "أكمل الدورة التدريبية بأكملها" },
  { id: "streak_3", icon: "S3", name: "On Fire", desc: "حافظ على سلسلة متتالية لمدة 3 أيام" },
  { id: "streak_7", icon: "S7", name: "Weekly Warrior", desc: "حافظ على سلسلة متتالية لمدة 7 أيام" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "النداء", subtitle: "لماذا يهم السؤال الصحيح", xp: 140,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "اختيار موضوع للتحليل التلوي", subtitle: "ابحث عن السؤال الذي يستحق الوقت" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "التعرف على سبب كون اختيار الموضوع هو القرار الأكثر خطورة في المراجعة",
          "استخدم البوابات الثلاثة: قيمة القرار، وجاهزية الأدلة، والمساهمة",
          "اكتشاف علامات الإنذار المبكر لموضوع غير جاهز",
          "إنشاء إطار سردي يحافظ على توافق النطاق والنتائج"
        ],
        tip: "يرتكز كل مفهوم على دليل حقيقي الانعكاسات - CAST، HRT، DECREASE - لأن الحكم يأتي من رؤية كيف أخطأ الخبراء الحقيقيون."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "الاندفاع", title: "عندما تجاوز السؤال الأدلة",
        text: "في أوائل عام 2020، أصبح العلاج عنوانًا عالميًا. وفي غضون أسابيع، ظهرت العشرات من الدراسات الصغيرة والمطبوعات الأولية. تم نشر التحليلات التلوية بشكل أسرع من انتهاء التجارب. كانت النتائج تتقلب من شهر لآخر بسبب اختلاف تصميمات الدراسة ونتائجها وشدة المريض.",
        followup: "بحلول أواخر عام 2020، لم تعلن التجارب العشوائية الكبيرة عن أي فائدة ذات معنى. لم تكن المراجعات المبكرة خاطئة في الأسلوب؛ كان الموضوع نفسه غير ناضج للغاية ومجزأ للغاية. السؤال لم ينضج بعد."
      }},
      { type: "stats", theme: "dark", content: {
        title: "لقطة ميدانية (مبسطة)",
        stats: [
          { value: "70+", label: "الدراسات في غضون 4 أشهر" },
          { value: "3", label: "Design families" },
          { value: "6", label: "تعريفات النتائج الأولية" },
          { value: "1", label: "Shared protocol" }
        ],
        caption: "أعداد توضيحية من الأدبيات العلاجية المبكرة للوباء؛ أرقام مبسطة للتدريس."
      }},
      { type: "concept", theme: "dark", content: {
        title: "الأبواب الثلاثة لموضوع جيد",
        subtitle: "إذا تم إغلاق أي بوابة، فلا تدخل",
        text: "<strong>قيمة القرار:</strong> يجب أن يتصرف شخص ما بناءً على الإجابة.<br><br><strong>جاهزية الأدلة:</strong> ما يكفي من الدراسات القابلة للمقارنة مع البيانات القابلة للاستخراج.<br><br><strong>المساهمة:</strong> تغير المراجعة الفهم أو تحدث الأدلة أو تحل الصراع.",
        highlight: "يمكن أن يكون الموضوع مهمًا ولكنه غير ناضج، أو ممكن ولكنه غير ذي صلة، أو جديد ولكنه تافه. قم باجتياز جميع البوابات الثلاثة."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QS", title: "السيناريو: فخ العناوين الرئيسية", xp: 25,
        scenario: "يوجد موضوع في كل مكان في الأخبار. يعثر بحث النطاق الخاص بك على تجربتين معشاة ذات شواهد صغيرة، و7 مطبوعات أولية، و4 دراسات رصدية ذات نتائج ونوافذ زمنية مختلفة. يطلب قائد المستشفى الحصول على إجابة مجمعة خلال أسبوعين.",
        question: "ما هو الرد الأكثر مسؤولية؟",
        options: [
          { letter: "A", text: "قم بإجراء تحليل تلوي كامل الآن؛ السرعة هي الأهم", correct: false },
          { letter: "B", text: "نشر مراجعة سريعة لتحديد النطاق وتسجيل بروتوكول حي", correct: true },
          { letter: "C", text: "استخدم النسخ الأولية فقط للتحرك بسرعة", correct: false },
          { letter: "D", text: "انتظر ولا تقدم أي توجيه على الإطلاق", correct: false }
        ],
        feedback: {
          correct: "صحيح. مجال الأدلة غير ناضج وغير متسق. تحدد مراجعة النطاق ما هو موجود، ويقوم البروتوكول الحي بإنشاء مسار للتحديث عند وصول تجارب أقوى.",
          incorrect: "لا يمكن للسرعة أن تحل محل إمكانية المقارنة. عندما تكون النتائج والتصميمات مجزأة، سيكون التقدير المجمع غير مستقر وقد يضلل صناع القرار."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QS", title: "السيناريو: التحقق من ثلاث بوابات", xp: 30,
        scenario: "أنت تختار موضوعًا لدورة المراجعة التالية. الموضوع أ: 15 تجربة معشاة ذات شواهد، ولكن تم نشر خمس مراجعات عالية الجودة في العام الماضي. الموضوع ب: تجربتان صغيرتان في مرض نادر، تختلف النتائج. الموضوع ج: 6 تجارب معشاة ذات شواهد بشأن قرار توجيهي مع بيانات الأضرار الجديدة وعدم وجود تحليل تلوي حديث.",
        question: "ما هو الموضوع الذي يمر عبر البوابات الثلاثة؟",
        options: [
          { letter: "A", text: "Topic A", correct: false },
          { letter: "B", text: "Topic B", correct: false },
          { letter: "C", text: "Topic C", correct: true },
          { letter: "D", text: "لا أحد منهم", correct: false }
        ],
        feedback: {
          correct: "صحيح. الموضوع ج له قيمة قرار وأدلة ممكنة ومساهمة واضحة (بيانات أضرار جديدة بدون مراجعة حديثة).",
          incorrect: "فشل الموضوع \"أ\" في المساهمة بسبب التكرار؛ الموضوع ب فشل في جاهزية الأدلة. الموضوع ج هو الموضوع الوحيد الذي يمسح جميع البوابات الثلاثة."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "لا تتعجل بسؤال لم ينضج بعد." }},
      { type: "quiz", theme: "dark", content: {
        question: "لماذا قدمت العديد من التحليلات الوصفية المبكرة للجائحة إجابات غير مستقرة؟",
        options: [
          { text: "كانت الأساليب الإحصائية غير صالحة", correct: false },
          { text: "كانت الأدلة غير ناضجة وكانت النتائج غير متناسق", correct: true },
          { text: "لا يمكن استخدام التحليل التلوي للأمراض المعدية", correct: false },
          { text: "التوزيع العشوائي غير ضروري", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. لم يكن الموضوع جاهزًا: فقد تنوعت التصاميم، واختلفت النتائج، وكانت العديد من الدراسات ضعيفة. تتطلب الإجابة الثابتة مجالًا ثابتًا من الأدلة.",
          incorrect: "لم تكن الطرق هي المشكلة الرئيسية. كان مجال الأدلة مجزأ وغير ناضج، لذلك من المرجح أن يتغير أي تقدير مجمع مع ظهور تجارب أقوى."
        }
      }}
    ]
  },
  {
    id: 2, title: "الإطار", subtitle: "النطاق والحدود", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "الإطار", subtitle: "النطاق هو الطريقة الأولى" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "نطاق التحكم باستخدام PICO بالإضافة إلى الوقت والتصميم والوقت الإعداد",
          "اكتشف انحراف النطاق قبل أن يخفف من نتائجك",
          "افصل ما هو مثير للاهتمام عما يمكن الإجابة عليه",
          "تدرب على التضييق دون تحيز النتيجة"
        ],
        tip: "سألت مراجعة تمرين كوكرين \"هل تساعد التمارين الرياضية في علاج الاكتئاب؟\" 41 دراسة، لا توجد إجابة واضحة. سؤال مركز حول التمارين الهوائية الخاضعة للإشراف في حالات الاكتئاب الشديد: 9 دراسات، استنتاج قابل للتنفيذ."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "الشبكة الواسعة", title: "عندما يصبح الاتساع ضبابًا",
        text: "سأل فريق: \"هل تقلل التمارين الرياضية من الاكتئاب؟\" لقد وجدوا 45 تجربة عبر البرامج الهوائية والمقاومة واليوجا والتاي تشي والرقص والبرامج المختلطة. استخدمت النتائج 12 مقياسًا؛ تراوحت المتابعة من 2 إلى 52 أسبوعًا. بدا التقدير المجمع واعدًا، لكن عدم التجانس كان شديدًا.",
        followup: "لقد أعادوا صياغة السؤال التالي: \"في البالغين الذين يعانون من اضطراب اكتئابي كبير، هل تعمل البرامج الهوائية الخاضعة للإشراف لمدة 8-12 أسبوعًا على تحسين درجات الأعراض الموحدة مقابل الرعاية المعتادة؟\" تقلصت مجموعة الأدلة إلى 9 تجارب مماثلة وأصبح الاستنتاج قابلاً للاستخدام."
      }},
      { type: "stats", theme: "dark", content: {
        title: "إشارات انحراف النطاق",
        stats: [
          { value: "8", label: "Intervention types" },
          { value: "12", label: "Outcome scales" },
          { value: "2-52", label: "أسابيع من المتابعة" },
          { value: "I2 > 70%", label: "Heterogeneity" }
        ],
        caption: "لقطة مبسطة من تجارب تمرينات الاكتئاب في الأدبيات."
      }},
      { type: "concept", theme: "dark", content: {
        title: "قرص النطاق",
        subtitle: "قم بتحويلها حتى تناسب",
        text: "حدد <strong>السكان</strong>، <strong>التدخل</strong>، <strong>المقارنة</strong>، <strong>النتيجة</strong>، <strong>الوقت</strong>، <strong>التصميم</strong>، و <strong>الإعداد</strong>. كل قرص تتركه فضفاضًا يزيد من عدم اليقين.",
        highlight: "الأسئلة العامة تخلق إجابات مربكة. الأسئلة الضيقة تخلق إجابات قابلة للاستخدام."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Boundary Checklist",
        items: [
          "السكان واضحون (العمر، الحالة، الخطورة، الإعداد)",
          "يتم تحديد التدخل (الجرعة، الشكل، الإشراف)",
          "المقارنة واقعية (الرعاية المعتادة، العلاج الوهمي، النشط)",
          "يتم اختيار النتيجة الأولية وقياسها بشكل متسق",
          "تتوافق نافذة الوقت مع القرار",
          "إدراج التصميم له ما يبرره (التجارب المعشاة ذات الشواهد فقط أو المختلطة)"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "السيناريو: النافذة الزمنية", xp: 25,
        scenario: "المقصود من مراجعتك هو اتخاذ قرار إعادة التأهيل لمدة 6 أشهر بعد الجراحة. تُبلغ التجارب عن النتائج بعد شهرين و6 و12 شهرًا.",
        question: "ما هي أفضل طريقة لتعيين النافذة الزمنية الأساسية؟",
        options: [
          { letter: "A", text: "استخدم أقرب نقطة زمنية لجميع الدراسات", correct: false },
          { letter: "B", text: "حدد مسبقًا 6 أشهر كأولية وتعامل مع النوافذ الأخرى على أنها ثانوية", correct: true },
          { letter: "C", text: "متوسط جميع النقاط الزمنية معًا", correct: false },
          { letter: "D", text: "اختر النقطة الزمنية ذات التأثير الأكبر بعد الرؤية النتائج", correct: false }
        ],
        feedback: {
          correct: "صحيح. يجب أن تتطابق النافذة الزمنية مع القرار. التحديد المسبق لمدة 6 أشهر يحمي من الانتقاء ويحافظ على توافق الأدلة مع خيار العالم الحقيقي.",
          incorrect: "نوافذ الوقت تغير حجم التأثير. بدون التحديد المسبق للنقطة الزمنية الأساسية، فإنك تخاطر بالتحيز وعدم التطابق مع القرار الذي من المفترض أن تبلغه المراجعة."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "السيناريو: تضييق الإطار", xp: 25,
        scenario: "مسودة سؤالك هي: \"هل تعمل تطبيقات الصحة العقلية على تحسين الصحة العقلية؟\"",
        question: "ما هي المراجعة الأفضل لتضيق النطاق دون تحيز الإجابة؟",
        options: [
          { letter: "A", text: "اجعلها واسعة النطاق لتجنب فقدان أي شيء", correct: false },
          { letter: "B", text: "البالغون الذين يعانون من القلق العام باستخدام العلاج السلوكي المعرفي القائم على التطبيق مقابل قائمة الانتظار، 8-12 أسبوعًا", correct: true },
          { letter: "C", text: "تضمين فقط التطبيقات التي تظهر فائدة في الدراسات التجريبية", correct: false },
          { letter: "D", text: "الحد من استخدام أي أداة رقمية لأي نتيجة تتعلق بالصحة العقلية", correct: false }
        ],
        feedback: {
          correct: "صحيح. يعمل الخيار B على تشديد عدد السكان والتدخل والمقارنة والوقت دون الاختيار المسبق للمنفعة. وهذا يجعل الأدلة قابلة للمقارنة والإجابة قابلة للتنفيذ.",
          incorrect: "الإطار المحكم لا يؤدي إلى تحيز النتائج؛ يجعلها قابلة للتفسير. الخياران (أ) و (د) واسعان جدًا، والخيار (ج) متحيز لأنه يختار مسبقًا الأدلة الإيجابية."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "يشكل الإطار القصة." }},
      { type: "quiz", theme: "dark", content: {
        question: "لقد وجدت ستة مقاييس مختلفة للاكتئاب عبر التجارب. ما هي أفضل خطوة تالية؟",
        options: [
          { text: "أسقط جميع التجارب التي تستخدم مقاييس غير شائعة", correct: false },
          { text: "حدد مقياس النتائج الأولية أو استخدم فرق المتوسط الموحد", correct: true },
          { text: "قم بتضمين جميع المقاييس بالتساوي دون تعديل", correct: false },
          { text: "بدل الموضوع إلى القلق بدلاً من ذلك", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. تحديد النتيجة الأولية أو استخدام فروق متوسطة موحدة لمحاذاة المقاييس. النطاق لا يتعلق فقط بالموضوع؛ يتعلق الأمر باتساق النتائج.",
          incorrect: "يعد عدم تناسق النتائج مشكلة في النطاق. أنت بحاجة إلى استراتيجية للمحاذاة، وليس استبعاد عشوائي أو تبديل الموضوع."
        }
      }}
    ]
  },
  {
    id: 3, title: "حقل الأدلة", subtitle: "الجدوى والحصاد", xp: 150,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "حقل الأدلة", subtitle: "هل الحقل جاهز للحصاد؟" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "قم بإجراء بحث تحديد النطاق الذي يكشف عن الجدوى",
          "الحكم على ما إذا كانت الدراسات قابلة للمقارنة بدرجة كافية تجمع",
          "قرر بين التحليل التلوي، أو مراجعة النطاق، أو المراجعة الحية",
          "تجنب الدقة الزائفة من الأدلة الضعيفة"
        ],
        tip: "قبل مراجعة قناع كوكرين، كشف بحث تحديد النطاق عن 67 دراسة موجودة - مما منع الجهود المكررة وشحذ سؤال."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "الوعد", title: "معضلة الأمراض النادرة",
        text: "أراد فريق إجراء تحليل تلوي لعلاج جديد لمرض عصبي عضلي نادر. توجد تجربتان صغيرتان (العدد = 38 والعدد = 25). قام أحدهما بقياس اختبار المشي لمدة 6 دقائق، بينما استخدم الآخر مقياس التقييم الوظيفي. اختلفت نوافذ المتابعة.",
        followup: "أنتج التجميع رقمًا ولكن ليس إجابة ذات معنى. نشر الفريق مراجعة تحديد النطاق وسجل بروتوكولًا حيًا، جاهزًا للتحديث عند ظهور تجارب جديدة."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Feasibility Snapshot",
        stats: [
          { value: "2", label: "Randomized trials" },
          { value: "63", label: "Total participants" },
          { value: "0", label: "Shared outcomes" },
          { value: "18", label: "الأشهر المتبقية على المحاكمة التالية" }
        ],
        caption: "خريطة جدوى مبسطة من سجلات تجارب الأمراض النادرة."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Feasibility Triage",
        subtitle: "اسأل قبل أن تجمع",
        text: "يكون الموضوع ممكنًا عندما يمكنك الإجابة عليه: <br><br>1) ما لا يقل عن 3 دراسات قابلة للمقارنة؟ <br>2) قياس النتائج بطرق متوافقة؟ <br>3) أحجام التأثير قابلة للاستخراج؟ <br>4) النوافذ الزمنية متشابهة بدرجة كافية للتفسير؟",
        highlight: "إن الإحصائيات الجميلة المبنية على أدلة واهية لا تزال ضعيفة."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "السيناريو: خلط التصاميم", xp: 25,
        scenario: "وجد بحث النطاق الخاص بك 3 تجارب معشاة ذات شواهد و5 دراسات رصدية على نفس التدخل، مع مخاطر مربكة مختلفة.",
        question: "كيف يجب أن تتعامل مع الدراسة التصاميم؟",
        options: [
          { letter: "A", text: "تجميع كافة الدراسات معا لتعظيم حجم العينة", correct: false },
          { letter: "B", text: "تحليل التجارب المعشاة ذات الشواهد بشكل منفصل ومقارنتها بنتائج المراقبة", correct: true },
          { letter: "C", text: "استبعاد التجارب المعشاة ذات الشواهد لأنها أقل", correct: false },
          { letter: "D", text: "استبعاد الدراسات الرصدية دون تفسير", correct: false }
        ],
        feedback: {
          correct: "صحيح. تحمل التصميمات المختلفة هياكل متحيزة مختلفة. تحافظ التحليلات المنفصلة على إمكانية التفسير وتسمح بإجراء مقارنة دون دقة زائفة.",
          incorrect: "يمكن أن يؤدي تجميع التصميمات غير المتوافقة إلى إخفاء التحيز وإنتاج يقين مضلل. تعامل مع التصميمات بشكل منفصل وقم بالإبلاغ عن الاختلافات بشفافية."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "السيناريو: اختر المراجعة الصحيحة", xp: 30,
        scenario: "عثر بحث تحديد النطاق على دراسة واحدة معشاة ذات شواهد و3 دراسات رصدية صغيرة. تختلف النتائج والبيانات مفقودة في دراستين.",
        question: "ما هي الخطوة التالية الأفضل؟",
        options: [
          { letter: "A", text: "تابع التحليل التلوي للتأثيرات العشوائية", correct: false },
          { letter: "B", text: "نشر مراجعة تحديد النطاق وتسجيل بروتوكول حي", correct: true },
          { letter: "C", text: "استبعاد التجارب المعشاة ذات الشواهد والتحليل التلوي الرصدي فقط دراسات", correct: false },
          { letter: "D", text: "قم بتغيير النتيجة حتى يعمل التجميع", correct: false }
        ],
        feedback: {
          correct: "صحيح. قاعدة الأدلة ضعيفة للغاية وغير متسقة. تحدد مراجعة النطاق المجال ويجهزك البروتوكول الحي للتجارب المستقبلية.",
          incorrect: "لا يؤدي التجميع إلى إصلاح عدم الاتساق أو البيانات المفقودة. إذا فشلت معايير الجدوى، فالإجابة الصادقة هي رسم خريطة للأدلة والانتظار."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Feasibility Checklist",
        items: [
          "ما لا يقل عن 3 دراسات قابلة للمقارنة ذات نتائج مماثلة",
          "أحجام التأثير والتباينات قابلة للاستخراج",
          "تصميمات الدراسة ليست في الأساس غير متوافق",
          "تتوافق نوافذ المتابعة مع السؤال",
          "تتوفر بيانات المجموعة الفرعية الرئيسية إذا لزم الأمر",
          "ما يكفي من الوقت والوصول إلى البيانات لإكمال الاستخراج"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "السيناريو: قابل للاستخراج البيانات", xp: 25,
        scenario: "وجدت 4 تجارب معشاة ذات شواهد لها نفس النتيجة، لكن اثنتين منهما أبلغتا فقط عن الوسيطات دون تباين ولم يستجيب المؤلفون.",
        question: "ما هو النهج الأكثر دفاعا؟",
        options: [
          { letter: "A", text: "احتساب الفروق بدون توثيق وتجميع الكل 4", correct: false },
          { letter: "B", text: "قم بتجميع التجربتين القابلتين للاستخراج فقط والإبلاغ عن القيود بشفافية", correct: true },
          { letter: "C", text: "اخترع صيغة تحويل وتابع دون إجراء فحوصات الحساسية", correct: false },
          { letter: "D", text: "ترك الموضوع بالكامل", correct: false }
        ],
        feedback: {
          correct: "صحيح. إذا كانت الإحصائيات الأساسية مفقودة، فيمكنك فقط تجميع ما يمكن استخراجه ويجب الإبلاغ عن القيود. تكون تحليلات الحساسية ممكنة إذا قمت بتبرير أي احتساب.",
          incorrect: "يمكن أن يؤدي الإسناد الذي لا يمكن التحقق منه إلى دقة خاطئة. عندما تكون البيانات مفقودة، تكون الشفافية والاختيارات التي يمكن الدفاع عنها أكثر أهمية من N مجمعة أكبر."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "ما هي الحالة التي تشير بقوة إلى أن الموضوع ليس جاهزًا للتحليل التلوي؟",
        options: [
          { text: "ثلاث تجارب صغيرة مع نتائج متوافقة", correct: false },
          { text: "نتائج متعددة مع نقطة نهاية أساسية واضحة", correct: false },
          { text: "دراسة واحدة فقط لكل نتيجة ولا توجد مقاييس قابلة للمقارنة", correct: true },
          { text: "تجربتان بالإضافة إلى محاكمة جارية كبيرة", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. وبدون نتائج قابلة للمقارنة، فإن التقدير المجمع ليس له معنى. تفشل الجدوى عندما لا يمكن مواءمة الأدلة.",
          incorrect: "تتعلق الجدوى بإمكانية المقارنة والبيانات القابلة للاستخراج، وليس فقط بعدد الدراسات."
        }
      }}
    ]
  },
  {
    id: 4, title: "صاحب المصلحة", subtitle: "التأثير واستخدام القرار", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "صاحب المصلحة", subtitle: "يجب أن يخدم الموضوع القرار" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "مواءمة السؤال مع القرار الحقيقي والجمهور",
          "إعطاء الأولوية للنتائج المهمة للمريض على البدائل",
          "تعرف على متى تحدد المقايضات الموضوع",
          "ترجمة الأدلة إلى العتبات العملية"
        ],
        tip: "تحدد إرشادات GRADE: تحديد من سيستخدم الأدلة. تختلف مراجعة الأطباء عن تلك الخاصة بصانعي السياسات."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "القرار", title: "الأسبرين للوقاية الأولية",
        text: "لسنوات، كان من المفترض أن الأسبرين يمنع النوبات القلبية الأولى. أظهرت التجارب الكبيرة والتحليلات التلوية لاحقًا انخفاضًا مطلقًا صغيرًا في الأحداث غير المميتة ولكنها زادت من النزيف الكبير. ويعتمد صافي الفائدة على المخاطر الأساسية وتفضيلات المريض.",
        followup: "لم يكن السؤال المهم هو \"هل يغير الأسبرين المؤشرات الحيوية؟\" ولكن هل الفوائد تفوق الأضرار بالنسبة لهذه الفئة من السكان؟ أدى اختيار الموضوع إلى تحويل الأدلة إلى قرار."
      }},
      { type: "stats", theme: "dark", content: {
        title: "المنفعة مقابل الضرر (توضيحي)",
        stats: [
          { value: "0.5%", label: "تخفيض MI غير مميت" },
          { value: "0.4%", label: "زيادة كبيرة في النزيف" },
          { value: "0.0%", label: "تغير في الوفيات الناجمة عن جميع الأسباب" },
          { value: "Risk", label: "يعتمد على خط الأساس" }
        ],
        caption: "نطاقات توضيحية من تجارب الوقاية الأولية الكبيرة؛ مبسطة للتدريس."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Decision Map",
        subtitle: "من يحتاج إلى الإجابة ولماذا؟",
        text: "قم بتسمية صاحب المصلحة ونقطة القرار والحد الأدنى: <br><br>؟ الأطباء: يصف أم لا؟ <br>؟ المرضى: قبول المقايضات؟ <br>؟ صناع السياسات: التمويل أم التقييد؟ <br><br>ثم اختر النتائج التي تعكس ما تقدره.",
        highlight: "إذا لم يتصرف أي شخص بشكل مختلف بناءً على الإجابة، فإن الموضوع قليل التأثير."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "IG", title: "السيناريو: محاذاة النتائج", xp: 25,
        scenario: "يجب أن تقرر لجنة الإرشادات ما إذا كانت ستوصي بفحص الحالة X أم لا. تركز المراجعة المقترحة على التغييرات في المختبر علامة حيوية.",
        question: "ما هي أفضل مراجعة؟",
        options: [
          { letter: "A", text: "احتفظ بالمؤشرات الحيوية لأنها تتغير بسرعة", correct: false },
          { letter: "B", text: "ركز على النتائج المهمة للمريض (الأعراض، والاستشفاء، والوفيات)", correct: true },
          { letter: "C", text: "الاقتصار على النتائج قصيرة المدى فقط", correct: false },
          { letter: "D", text: "إزالة الأضرار لإبقاء المراجعة أكثر بساطة", correct: false }
        ],
        feedback: {
          correct: "صحيح. ويحتاج صناع القرار إلى نتائج تهم المرضى والأنظمة، وليس فقط الإشارات المخبرية.",
          incorrect: "يمكن أن تكون المؤشرات الحيوية مضللة إذا لم تترجم إلى نتائج يهتم بها الناس. يجب أن تعطي المواضيع ذات التأثير العالي الأولوية للنتائج والأضرار التي تهم المريض."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "IG", title: "السيناريو: العتبة مهمة", xp: 25,
        scenario: "سيتبنى نظام المستشفى التدخل فقط إذا منع 1 على الأقل الاستشفاء لكل 100 مريض سنويا. تشير التجارب إلى انخفاض نسبي في المخاطر دون معدلات مطلقة.",
        question: "ما الذي يجب أن يعطيه إطار الموضوع الأولوية؟",
        options: [
          { letter: "A", text: "أحجام التأثير النسبية فقط لتبسيط إعداد التقارير", correct: false },
          { letter: "B", text: "فروق المخاطر المطلقة أو العدد المطلوب للعلاج", correct: true },
          { letter: "C", text: "النتائج البديلة لزيادة الدقة", correct: false },
          { letter: "D", text: "استبعاد الأضرار للحفاظ على التركيز على المنفعة", correct: false }
        ],
        feedback: {
          correct: "صحيح. عتبات القرار مطلقة. إن تأطير الموضوع ليشمل المخاطر الأساسية والتأثيرات المطلقة يجعل المراجعة قابلة للاستخدام لاتخاذ القرار.",
          incorrect: "التأثيرات النسبية يمكن أن تخفي التأثير العملي. إذا كان القرار له حد، فيجب أن يلتقط موضوعك التأثيرات والأضرار المطلقة."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "يجب أن يخدم السؤال قرارًا." }},
      { type: "quiz", theme: "dark", content: {
        question: "ما الذي يجعل الموضوع شديد التأثير؟",
        options: [
          { text: "يحظى بشعبية كبيرة على وسائل التواصل الاجتماعي", correct: false },
          { text: "إنه يُبلغ عن قرار حقيقي مع المقايضات", correct: true },
          { text: "وله أعلى حجم تأثير", correct: false },
          { text: "من السهل إكماله بسرعة", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. فالتأثير يأتي من القرارات والمقايضات، وليس من الشعبية. يمكن أن يكون التأثير البسيط عالي التأثير إذا غير الممارسة.",
          incorrect: "الشعبية والسرعة لا تؤثران. أفضل المواضيع هي تغيير القرارات أو حل المفاضلات التي تهم الأشخاص."
        }
      }}
    ]
  },
  {
    id: 5, title: "الأصداء", subtitle: "الحداثة والتكرار", xp: 150,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "الأصداء", subtitle: "تجنب تكرار نفس الإجابة" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "اكتشاف متى يكون الموضوع مشبعًا بالمراجعات",
          "التمييز بين التحديث والتكرار والتكرار",
          "حدد مساهمة حقيقية قبل البدء",
          "استخدم عمليات التحقق من التداخل لتبرير مراجعة جديدة"
        ],
        tip: "بحلول عام 2020، كان هناك أكثر من 500 مراجعة منهجية حول فيتامين د. لم تتم إضافة أي شيء. يساعد تسجيل PROSPERO الآن على منع مثل هذه الهدر."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "الجمهور", title: "عندما تتضاعف المراجعات ولكن الإجابات لا تتضاعف",
        text: "بحلول عام 2021، سيشهد اليقظة الذهنية للقلق سيلًا من التحليلات التلوية. قام العديد منهم بتجميع نفس المجموعة الصغيرة من التجارب ولكنهم قدموا استنتاجات مختلفة. رأى صناع السياسات التناقض، وليس الوضوح، لأن معايير التضمين والنتائج تتباين.",
        followup: "تكون المراجعة الجديدة منطقية فقط عندما تضيف مساهمة واضحة: تجارب محدثة، أو تقييم تحيز أكثر صرامة، أو مجموعة سكانية مختلفة."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Redundancy Snapshot",
        stats: [
          { value: "12", label: "Core trials" },
          { value: "22", label: "Meta-analyses" },
          { value: "90%", label: "Trial overlap" },
          { value: "4", label: "مقاييس التأثير المستخدمة" }
        ],
        caption: "لقطة مبسطة من موضوعات سلوكية تمت مراجعتها بشكل كبير."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Contribution Types",
        subtitle: "كيفية تبرير مراجعة جديدة",
        text: "تكون المراجعة مبررة عندما توفر: <br><br>؟ <strong>تحديث:</strong> التجارب الجديدة تغير التقدير <br>؟ <strong>إعادة الصياغة:</strong> مجموعة سكانية أو إعداد جديد <br>؟ <strong>ترقية الطريقة:</strong> أدوات أو نماذج تحيز أفضل <br>؟ <strong>المراجعة الحية:</strong> الأدلة سريعة التغير",
        highlight: "إذا لم تتمكن من تسمية المساهمة في جملة واحدة، فمن المحتمل أن يكون الموضوع زائدًا عن الحاجة."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Novelty Test",
        items: [
          "هي أحدث مراجعة عالية الجودة قديمة؟",
          "هل هناك تجارب جديدة يمكن أن تغير الاستنتاجات؟",
          "هل تجيب مراجعتك على مجتمع أو إعداد مختلف؟",
          "هل ستتحسن أساليبك مقارنة بالمراجعات السابقة؟",
          "هل قمت بفحص التداخل مع المراجعات الحالية؟"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "NH", title: "السيناريو: التحقق من التداخل", xp: 25,
        scenario: "يمكنك تحديد مراجعة عالية الجودة من العام الماضي. ستتضمن المراجعة المقترحة 18 تجربة من نفس العشرين تجربة وستستخدم نفس النتائج.",
        question: "ما هي أفضل خطوة تالية؟",
        options: [
          { letter: "A", text: "تابع على أية حال؛ المزيد من المراجعات تزيد من الثقة", correct: false },
          { letter: "B", text: "توقف إلا إذا تمكنت من تحديد مساهمة جديدة", correct: true },
          { letter: "C", text: "قم بتغيير النتيجة بعد رؤية نتائج التجربة", correct: false },
          { letter: "D", text: "استبعد التجربتين المتداخلتين لتظهر رواية", correct: false }
        ],
        feedback: {
          correct: "صحيح. وبدون مساهمة واضحة، فإن المراجعة شبه المكررة تضيف ضجيجًا. أنت بحاجة إلى دليل جديد، أو مجتمع جديد، أو ترقية للأسلوب لتبرير المتابعة.",
          incorrect: "يؤدي التداخل العالي بدون مساهمة جديدة إلى التكرار. الهدف هو الوضوح وليس الحجم."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "NH", title: "السيناريو: تحديث أم إعادة؟", xp: 25,
        scenario: "تم نشر المراجعة الأخيرة للموضوع Y في عام 2019 (15 تجربة). منذ ذلك الحين، ظهرت 6 تجارب معشاة ذات شواهد جديدة وأداة جديدة لخطر التحيز.",
        question: "ما هو النهج الأكثر دفاعا؟",
        options: [
          { letter: "A", text: "نشر مراجعة جديدة دون الرجوع إلى المراجعة القديمة", correct: false },
          { letter: "B", text: "إجراء تحديث أو مراجعة حية مع مقارنة صريحة بالنتائج السابقة", correct: true },
          { letter: "C", text: "تجنب مراجعة الموضوع بالكامل", correct: false },
          { letter: "D", text: "كرر الأساليب القديمة للبقاء متسق", correct: false }
        ],
        feedback: {
          correct: "صحيح. أفضل مساهمة هي التحديث الذي يدمج التجارب الجديدة والأساليب المحسنة مع الاعتراف بالنتائج السابقة.",
          incorrect: "يجب أن تبرر المراجعة الجديدة مساهمتها. يؤدي تجاهل العمل السابق أو تكرار الأساليب القديمة إلى إضافة الضجيج وليس الوضوح."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "ما هو الموقف الأكثر تبريرًا لإجراء تحليل تلوي جديد؟",
        options: [
          { text: "توجد العديد من المراجعات المماثلة ولم تظهر أي تجارب جديدة", correct: false },
          { text: "المراجعة عالية الجودة حديثة وشاملة", correct: false },
          { text: "يمكن للتجارب الجديدة والأساليب المحسنة تغيير الاستنتاجات", correct: true },
          { text: "الموضوع شائع في وسائل الإعلام", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. إن المساهمة الحقيقية تأتي من أدلة جديدة أو منهجية محسنة يمكن أن تغير الإجابة.",
          incorrect: "الشعبية لا تبرر التكرار. بدون أدلة جديدة أو طرق أفضل، فإن نفس المراجعة لا تؤدي إلا إلى مضاعفة الارتباك."
        }
      }}
    ]
  },
  {
    id: 6, title: "المرآة", subtitle: "التحيز ومصائد التأطير", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "المرآة", subtitle: "يمكن أن يخفي تأطير الموضوع كما يكشف" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "التعرف على كيف يمكن أن تؤدي اختيارات التأطير إلى التحيز",
          "تضمين الأضرار والمقايضات من البداية",
          "حماية السؤال بالبروتوكول والشفافية",
          "تحديد الصراعات التي تشكل اختيار الموضوع"
        ],
        tip: "تتضمن قائمة مراجعة PRISMA قسم \"معايير الأهلية\" - مرآتك الواضحة التي تعرض ما تم تضمينه وما تم استبعاده."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "الإطار", title: "أدوية الألم COX-2 والنتيجة المفقودة",
        text: "ركزت المراجعات المبكرة لأدوية الألم COX-2 على تخفيف الألم على المدى القصير واستبعدت المتابعة الأطول. أظهرت النتيجة المجمعة فائدة واضحة.",
        followup: "كشفت التجارب والمراقبة اللاحقة عن زيادة في أحداث القلب والأوعية الدموية، مما يؤدي إلى الانسحابات والتحذيرات. ولم يكن الضرر غير مرئي؛ كان خارج الإطار المختار."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Framing Traps",
        subtitle: "كيف يدخل التحيز قبل التحليل",
        text: "تتضمن المصائد الشائعة ما يلي: <br><br>؟ استبعاد الأضرار أو النتائج طويلة المدى؟ اختيار المقارنات التي تجعل التدخل يبدو أفضل؟ هل يقتصر عدد السكان على أولئك الذين من المرجح أن يستفيدوا من ذلك؟ تغيير النتيجة الأولية بعد رؤية النتائج",
        highlight: "إذا كان الإطار متحيزًا، فلا توجد طريقة يمكن إصلاحه بالكامل."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "السيناريو: ضغط الراعي", xp: 30,
        scenario: "يقترح أحد الرعاة استبعاد التجارب التي تبلغ عن أحداث سلبية خطيرة لأنها \"ليست محور المراجعة\".",
        question: "ماذا يجب أن تفعل؟",
        options: [
          { letter: "A", text: "قبول إبقاء النطاق ضيقًا", correct: false },
          { letter: "B", text: "قم بتضمين الأضرار كنتائج محددة مسبقًا وتوثيق النتائج القرار", correct: true },
          { letter: "C", text: "استبعاد الأضرار مع ذكرها في المناقشة", correct: false },
          { letter: "D", text: "إزالة الراعي من قائمة المؤلفين", correct: false }
        ],
        feedback: {
          correct: "صحيح. الأضرار تنتمي إلى الإطار. يؤدي تحديدها مسبقًا إلى حماية المراجعة من التقارير الانتقائية والحفاظ على الثقة.",
          incorrect: "يؤدي استبعاد الأضرار إلى إنشاء إطار متحيز. الشفافية والمواصفات المسبقة هما الاستجابة الوحيدة التي يمكن الدفاع عنها."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Bias Guardrails",
        items: [
          "الإعلان عن التمويل والصراعات مبكرًا",
          "تحديد النتائج مسبقًا، بما في ذلك الأضرار",
          "تبرير الاستثناءات بمعايير شفافة",
          "تسجيل بروتوكول قبل الاستخراج",
          "تخطيط تحليلات الحساسية للافتراضات المحفوفة بالمخاطر"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "السيناريو: تبديل النتائج", xp: 25,
        scenario: "في منتصف عملية الاستخراج، تلاحظ أن النتيجة الثانوية تظهر فائدة أكبر من النتيجة الأولية المحددة مسبقًا.",
        question: "ما هو الإجراء الأكثر قابلية للدفاع؟",
        options: [
          { letter: "A", text: "تبديل النتيجة الأولية لتسليط الضوء على التأثير الأكبر", correct: false },
          { letter: "B", text: "الحفاظ على النتيجة الأولية المحددة مسبقاً؛ الإبلاغ عن الثانوية بشفافية", correct: true },
          { letter: "C", text: "إزالة النتيجة الأولية الأصلية بالكامل", correct: false },
          { letter: "D", text: "تأخير تسجيل البروتوكول حتى بعد التحليل", correct: false }
        ],
        feedback: {
          correct: "صحيح. المواصفات المسبقة تحمي من التركيز الانتقائي. يمكنك الإبلاغ عن النتائج الثانوية، ولكن تبديل النتائج الأولية بعد الاطلاع على البيانات يعد بمثابة تحيز تأطيري.",
          incorrect: "إن تغيير النتائج الأولية بعد ذلك يؤدي إلى تقويض الثقة. تعتمد سلامة المراجعة على الالتزام بالإطار المحدد مسبقًا."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "يمكن إخفاء السؤال وكذلك الكشف عنه." }},
      { type: "quiz", theme: "dark", content: {
        question: "ما هو تأطير التحيز في اختيار الموضوع؟",
        options: [
          { text: "استخدام نموذج التأثيرات العشوائية", correct: false },
          { text: "اختيار نطاق يستبعد بشكل منهجي الأضرار أو النتائج غير المواتية", correct: true },
          { text: "بما في ذلك عدد كبير جدًا من الدراسات", correct: false },
          { text: "نشر البروتوكول", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "صحيح. يحدث تحيز الصياغة عندما يتم إنشاء السؤال لصالح نتيجة ما، غالبًا عن طريق استبعاد الأضرار أو النتائج الصعبة.",
          incorrect: "يتعلق تحيز الصياغة بكيفية بناء السؤال، وليس حول النماذج الإحصائية أو تسجيل البروتوكول."
        }
      }}
    ]
  },
  {
    id: 7, title: "صياغة الموضوع", subtitle: "Capstone و التوليف", xp: 180,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "صياغة الموضوع", subtitle: "صياغة السؤال الذي يحمل" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "تجميع بيان الموضوع الكامل",
          "تطبيق البوابات الثلاثة في قرار واحد",
          "تدرب على الاختيار بين الموضوعات المتنافسة",
          "اترك باستخدام قالب قابل لإعادة الاستخدام"
        ],
        tip: "This capstone uses contrast and return (ring structure) to complete the narrative."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "القصة", title: "فريقان وسؤالان",
        text: "بدأ فريقان للمراجعة في نفس اليوم. اختار الفريق \"أ\" موضوعًا واسعًا وشائعًا وكتب البروتوكول في غضون أسبوع. توقف الفريق \"ب\" مؤقتًا لرسم خريطة للأدلة، وتحديد النتائج، وتحديد صناع القرار.",
        followup: "وبعد أشهر، كان لدى الفريق \"أ\" تقدير مجمع لا يمكن لأحد استخدامه. قدم الفريق \"ب\" إجابة مركزة غيرت المبدأ التوجيهي. لم يكن الفرق مجهودًا بل صياغة."
      }},
      { type: "concept", theme: "dark", content: {
        title: "قالب بيان الموضوع",
        subtitle: "املأ كل فراغ",
        text: "في <strong>[السكان]</strong>، هل يعمل <strong>[التدخل]</strong> مقابل <strong>[comparator]</strong> على تحسين <strong>[النتيجة الأولية]</strong> في <strong>[النافذة الزمنية]</strong>، وما هي الأضرار التي يتم تتبعها؟",
        highlight: "إذا لم تتمكن من ملء كل الفراغات، فالسؤال ليس جاهزًا."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "اختبار جاهزية الموضوع",
        items: [
          "اجتياز ثلاث بوابات: قيمة القرار، وجاهزية الأدلة، والمساهمة",
          "PICO + الوقت + التصميم + الإعداد واضحة",
          "النتائج الأولية والأضرار محددة مسبقًا",
          "تم تأكيد الجدوى من خلال بحث النطاق",
          "جملة المساهمة واضحة",
          "يمكن تسجيل البروتوكول بدون أشياء مجهولة رئيسية"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TF", title: "السيناريو: صياغة بيان الموضوع", xp: 30,
        scenario: "يجب عليك كتابة بيان الموضوع لمراجعة إدارة ارتفاع ضغط الدم لدى كبار السن البالغين.",
        question: "ما هو البيان الأكثر استعدادا للتسجيل؟",
        options: [
          { letter: "A", text: "هل تساعد أدوية ضغط الدم كبار السن؟", correct: false },
          { letter: "B", text: "في البالغين الذين تزيد أعمارهم عن 65 عامًا، هل يقلل العلاج بالثيازيد مقابل مثبطات الإنزيم المحول للأنجيوتنسين من السكتة الدماغية عند 12 شهرًا، وما هي الأضرار التي تحدث؟", correct: true },
          { letter: "C", text: "ما هو العلاج الأفضل لارتفاع ضغط الدم؟", correct: false },
          { letter: "D", text: "هل تعمل أي أدوية خافضة للضغط على تحسين ضغط الدم؟", correct: false }
        ],
        feedback: {
          correct: "صحيح. يحدد هذا البيان عدد السكان والتدخل والمقارنة والنتيجة والنافذة الزمنية والأضرار. إنه جاهز لتسجيل البروتوكول.",
          incorrect: "يجب أن يحدد بيان الموضوع السكان والتدخل والمقارنة والنتيجة والوقت والأضرار. الأسئلة الغامضة ليست جاهزة للبروتوكول."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TF", title: "السيناريو: اختر الموضوع الأقوى", xp: 40,
        scenario: "اختر الموضوع الأكثر جاهزية للتحليل التلوي بناءً على لمحة من الأدلة.",
        question: "ما هو الموضوع الذي يمر عبر البوابات الثلاثة؟",
        options: [
          { letter: "A", text: "جميع التدخلات الصحية الرقمية لجميع الأمراض المزمنة", correct: false },
          { letter: "B", text: "المراقبة عن بعد في حالات قصور القلب (التجارب المعشاة ذات الشواهد، وإعادة القبول لمدة 12 شهرًا، والأضرار المحددة مسبقًا)", correct: true },
          { letter: "C", text: "علاج جيني جديد لمرض نادر مع تجربة واحدة صغيرة", correct: false },
          { letter: "D", text: "أي مكمل للإرهاق في أي مجموعة سكانية", correct: false }
        ],
        feedback: {
          correct: "صحيح. الموضوع ب محدد وممكن وذو صلة بالقرار. قاعدة الأدلة واضحة بما يكفي لتجميعها وتتوافق النتائج مع القرار.",
          incorrect: "الموضوع الأقوى هو الموضوع المحدد والممكن والمتعلق بالقرار. المواضيع العامة أو غير الناضجة تفشل في بوابة واحدة على الأقل."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "اطرح سؤالاً يمكن الإجابة عليه." }},
      { type: "quiz", theme: "dark", content: {
        question: "ما البوابة التي من المرجح أن تفشل عندما يكون موضوع ما شائعًا ولكنه مشبع بالمراجعات؟",
        options: [
          { text: "Decision value", correct: false },
          { text: "Evidence readiness", correct: false },
          { text: "Contribution", correct: true },
          { text: "Comparator clarity", correct: false }
        ],
        xp: 30,
        feedback: {
          correct: "صحيح. عند وجود العديد من المراجعات عالية الجودة بالفعل، يتم إغلاق بوابة المساهمة ما لم تقم بإضافة أدلة أو طرق جديدة.",
          incorrect: "الشعبية لا تضمن المساهمة. إذا كانت المراجعات الموجودة تجيب بالفعل على السؤال، فسيتم إغلاق بوابة المساهمة."
        }
      }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('topicSelectionGame', gameState);
}

function resetProgress() {
  if (confirm('هل تريد إعادة تعيين كل التقدم والإنجازات؟')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [] };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  document.getElementById('badgeModal').classList.add('show');
  if (celebrate) triggerConfetti();
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  document.getElementById('badgeModal').classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle, .hamburger, .mobile-menu-btn'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.synthesisCount || 0;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="عنصر الشارة ${حصلت عليه؟ 'كسب' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="عنصر الوحدة ${i === currentModule ? 'نشط' : ''} ${مكتمل؟ 'مكتمل' : ''} ${مقفل؟ 'مقفل' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${مقفل؟ 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">T ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="شرائح الوحدة ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="العرض: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="الشريحة السابقة">←</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i ===currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="انتقل إلى الشريحة ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn" onclick="nextSlide()" aria-label="الشريحة التالية">→</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">← → arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="Slide ${theme} ${index ===currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="عنوان الرسوم المتحركة الذهبي">${slide.content.title}</h1><p class="تأخير الرسوم المتحركة للترجمة -1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="تأخير الرسوم المتحركة للترجمة -1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="Story-box ${slide.content.success ? 'النجاح' : ''} ${slide.content.warning ؟ 'تحذير' : ''} ${slide.content.teal ؟ 'teal' : ''} تحريك" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="عنوان الرسوم المتحركة الذهبي">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="تأخير الرسوم المتحركة للترجمة -1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid تأخير الرسوم المتحركة-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="العنوان الفرعي تأخير الرسوم المتحركة-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} بطاقة الرسوم المتحركة">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="تأخير الرسوم المتحركة للترجمة -1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="${theme === 'light' ? '' : 'navy-bg'} تأخير الرسوم المتحركة -2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="تحذير مربع القصة تأخير الرسوم المتحركة -3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="تأخير الرسوم المتحركة للجدول الزمني -2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="عنوان الرسوم المتحركة الذهبي">${slide.content.title}</h2>
        <div class="قائمة التحقق من تأخير الرسوم المتحركة -1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="خيار القرار ${isSelected ? 'محدد' : ''} ${showCorrect ? 'صحيح' : ''} ${showIncorrect ؟ \"غير صحيح\" : ''} ${إجابة ؟ 'عاجز' : ''}"
                     onclick="AnswerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'صحيح' : 'خطأ'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'صحيح!' : 'ليس تمامًا'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
          </div>
        </div>
      </div>`;
      break;

    case 'quiz':
      const qid = `quiz_${moduleIndex}_${index}`;
      const qAnswered = gameState.answeredQuestions[qid];
      html += `<div class="content">
        <div class="quiz-container animate">
          <div class="quiz-question">${slide.content.question}</div>
          <div class="quiz-options">
            ${slide.content.options.map((opt, oi) => {
              const isSelected = qAnswered === oi;
              const showCorrect = qAnswered !== undefined && opt.correct;
              const showIncorrect = qAnswered !== undefined && isSelected && !opt.correct;
              return `
                <div class="خيار الاختبار ${showCorrect ? 'صحيح' : ''} ${showIncorrect ؟ 'غير صحيح' : ''} ${qAnswered !== غير محدد؟ 'disabled' : ''}"
                     onclick="answerQuiz('${qid}', ${oi}, ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'صحيح' : 'خطأ'}"
                     aria-disabled="${qAnswered !== غير محدد؟ \"صحيح\": \"كاذب\"}">
                  ${opt.text}
                </div>
              `;
            }).join('')}
          </div>
          <div class="تعليقات الاختبار ${qAnswered !== غير محدد ? 'show' : ''} ${qAnswered !== غير محدد && Slide.content.options[qAnswered]?.صحيح؟ 'صحيح' : 'غير صحيح'} زر" role="alert" aria-live="polite">
            ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}
          </div>
        </div>
      </div>`;
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  container.querySelector('.nav-btn').disabled = currentSlide === 0;
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;
  gameState.synthesisCount = (gameState.synthesisCount || 0) + 1;

  if (gameState.decisionsCompleted === 1) awardBadge('first_question');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 15) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
  }
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

function answerQuiz(qid, choice, correct, xp) {
  if (gameState.answeredQuestions[qid] !== undefined) return;
  gameState.answeredQuestions[qid] = choice;

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
  } else {
    consecutiveCorrect = 0;
  }
  saveGame();
  renderSlides();
  updateComboDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 2) awardBadge('scope_shaper');
    if (mod.id === 3) awardBadge('evidence_scout');
    if (mod.id === 4) awardBadge('impact_guardian');
    if (mod.id === 5) awardBadge('novelty_hawk');
    if (mod.id === 6) awardBadge('bias_sentinel');
    if (mod.id === 7) awardBadge('topic_forger');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  }
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.getElementById('badgeModal').classList.remove('show');
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }
  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('، أ، الإدخال، منطقة النص، حدد');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }
  if (e.key === 'ArrowLeft' || e.key === ' ') { e.preventDefault(); nextSlide(); }
  else if (e.key === 'ArrowRight') { e.preventDefault(); prevSlide(); }
});

document.addEventListener('keydown', (e) => {
  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option') || e.target.classList.contains('quiz-option')) && e.key === 'Enter') {
    e.target.click();
  }
});

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) { diff > 0 ? nextSlide() : prevSlide(); }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
