<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Examens g√©n√©raux¬†:¬†l'examen des avis</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&amp;family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .xp-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      to { left: 100%; }
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .course-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      min-width: 44px;
      min-height: 44px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active {
      background: rgba(249,115,22,0.2);
      border-color: var(--orange);
      animation: flamePulse 1.5s ease-in-out infinite;
    }
    @keyframes flamePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; touch-action: pan-x pan-y; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }
    .slide.gold-bg { background: linear-gradient(135deg, #92702a 0%, #5c4520 100%); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: #4CAF50; }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--gold); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-left-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .decision-option:hover {
      background: rgba(124,58,237,0.2);
      border-color: var(--purple);
      transform: translateX(4px);
    }
    .decision-option:active {
      transform: scale(0.98);
    }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: 'o'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    @keyframes badgeBounce {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    .badge-modal.show .badge-modal-icon {
      animation: badgeBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .confetti { display: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:active { transform: scale(0.95); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; max-width: 280px; }
    .progress-dot {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      padding: 0;
      appearance: none;
      position: relative;
    }
    .progress-dot::after {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .progress-dot.active::after { width: 14px; height: 14px; background: var(--gold); transform: translate(-50%, -50%); }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-left: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }

    /* Course Completion Overlay */
    .completion-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
    .completion-overlay.show { display: flex; }
    .completion-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 450px;
      width: 90%;
    }
    .completion-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--gold); }
    .completion-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .completion-subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
    }
    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .completion-stat {
      text-align: center;
    }
    .completion-stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .completion-stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }
    .completion-actions { display: flex; gap: 0.75rem; justify-content: center; }

    /* Level Up Modal */
    .level-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1003;
    }
    .level-modal.show { display: flex; }
    .level-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 380px;
      width: 90%;
      animation: levelModalPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes levelModalPop {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .level-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: levelIconPulse 1s ease-in-out infinite;
    }
    @keyframes levelIconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    .level-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .level-modal-level {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3rem;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 0.25rem;
    }
    .level-modal-name {
      font-size: 1.2rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 1024px) and (min-width: 769px) {
      .sidebar { width: 280px; }
    }

    /* Small mobile improvements */
    @media (max-width: 480px) {
      .decision-option {
        padding: 1rem 1.25rem;
        font-size: 0.95rem;
      }
    }

    /* Landscape orientation handling */
    @media (orientation: landscape) and (max-height: 500px) {
      .slide-content { padding: 1rem; }
      .slide .title { font-size: 1.5rem; }
      .slide-nav { padding: 0.5rem; }
    }

    /* Safe area insets for notched devices */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .sidebar {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
      .slide-nav {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<div class="course-container">
<!-- Sidebar -->
<nav aria-label="Navigation dans les cours" class="sidebar" role="navigation">
<div class="sidebar-header">
<a href="index.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;">‚Üê Course Library</a>
<h1>Umbrella Reviews</h1>
<p>L'examen des avis</p>
</div>
<div class="stats-panel">
<div class="level-display">
<div class="level-badge" id="levelIcon">RR</div>
<div class="level-info">
<div class="level-title" id="levelTitle">Review Reader</div>
<div class="level-subtitle">Level <span id="levelNum">1</span></div>
</div>
</div>
<div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
<div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
<div class="quick-stats">
<div class="quick-stat">
<div class="quick-stat-value" id="correctCount">0</div>
<div class="quick-stat-label">Correct</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="decisionCount">0</div>
<div class="quick-stat-label">Decisions</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="synthesisCount">0</div>
<div class="quick-stat-label">Reviews</div>
</div>
</div>
</div>
<div class="course-progress">
<div class="course-progress-label">
<span>Course Progress</span>
<span id="courseProgressPct">0%</span>
</div>
<div class="course-progress-bar">
<div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
</div>
</div>
<div class="module-list" id="moduleList" role="list"></div>
<div class="badges-panel">
<div class="badges-title">Achievements</div>
<div class="badges-grid" id="badgesGrid"></div>
</div>
</nav>
<!-- Main Content -->
<main class="main-content" id="main-content">
<header class="content-header">
<div class="breadcrumb">Umbrella Reviews / <span id="currentModule">Module 1</span></div>
<div class="header-actions">
<div class="streak-display" id="streakDisplay">
<span aria-hidden="true" class="streak-flame">üî•</span>
<span class="streak-count" id="streakCount">0</span>
<span>day streak</span>
</div>
<button class="btn" onclick="resetProgress()">Reset</button>
</div>
</header>
<div class="content-body">
<div class="slides-container" id="slidesContainer"></div>
</div>
</main>
</div>
<!-- XP Popup -->
<div aria-atomic="true" aria-live="polite" class="xp-popup" id="xpPopup" role="status">
<span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>
<!-- Badge Modal -->
<div aria-labelledby="badgeModalTitle" aria-modal="true" class="badge-modal" id="badgeModal" role="dialog">
<div class="badge-modal-content">
<div class="badge-modal-icon" id="badgeModalIcon">AW</div>
<div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
<div class="badge-modal-desc" id="badgeModalDesc">Vous avez d√©bloqu√© un nouveau succ√®s</div>
<button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
</div>
</div>
<!-- Confetti Container -->
<div class="confetti-container" id="confettiContainer"></div>
<!-- Combo Counter -->
<div aria-live="polite" class="combo-display" id="comboDisplay" role="status">COMBO <span id="comboCount">0</span>x</div>
 Superposition d'ach√®vement de cours 
<div class="completion-overlay" id="completionOverlay">
<div class="completion-content">
<div class="completion-icon">üèÜ</div>
<div class="completion-title">Course Complete!</div>
<div class="completion-subtitle">You have mastered umbrella reviews.</div>
<div class="completion-stats">
<div class="completion-stat">
<div class="completion-stat-value" id="completionXP">0</div>
<div class="completion-stat-label">Total XP</div>
</div>
<div class="completion-stat">
<div class="completion-stat-value" id="completionBadges">0</div>
<div class="completion-stat-label">Badges Earned</div>
</div>
<div class="completion-stat">
<div class="completion-stat-value" id="completionLevel">1</div>
<div class="completion-stat-label">Final Level</div>
</div>
</div>
<div class="completion-actions">
<button class="btn primary" onclick="downloadCertificate()">Download Certificate</button>
<button class="btn" onclick="reviewBadges()">Review Badges</button>
<button class="btn" onclick="closeCompletion()">Close</button>
</div>
</div>
</div>
<!-- Level Up Modal -->
<div aria-hidden="true" aria-labelledby="levelModalTitle" aria-modal="true" class="level-modal" id="levelModal" role="dialog">
<div class="level-modal-content">
<div class="level-modal-icon">üéñÔ∏è</div>
<div class="level-modal-title" id="levelModalTitle">Level Up!</div>
<div class="level-modal-level" id="levelModalLevel">Level 2</div>
<div class="level-modal-name" id="levelModalName">Search Scout</div>
<button class="btn primary" onclick="closeLevelModal()">Continue</button>
</div>
</div>
<!-- Mobile Sidebar Toggle -->
<button aria-expanded="false" aria-label="Toggle menu" class="sidebar-toggle" onclick="toggleSidebar()">MENU</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {},
  consecutiveCorrect: 0,
  courseCompleted: false
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

// Migration from old storage key to versioned key
(function migrateStorage() {
  try {
    const oldData = localStorage.getItem('umbrellaReviewGame');
    if (oldData && !localStorage.getItem('umbrellaReviewGame_v1')) {
      localStorage.setItem('umbrellaReviewGame_v1', oldData);
      localStorage.removeItem('umbrellaReviewGame');
    }
  } catch (e) {}
})();

let gameState = safeGetStorage('umbrellaReviewGame_v1', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Review Reader", icon: "RR", xp: 0 },
  { level: 2, title: "Search Scout", icon: "SS", xp: 120 },
  { level: 3, title: "Quality Assessor", icon: "QA", xp: 300 },
  { level: 4, title: "Overlap Analyst", icon: "OA", xp: 520 },
  { level: 5, title: "Evidence Synthesizer", icon: "ES", xp: 780 },
  { level: 6, title: "Gap Mapper", icon: "GM", xp: 1050 },
  { level: 7, title: "Reporting Expert", icon: "RE", xp: 1350 },
  { level: 8, title: "Umbrella Master", icon: "UM", xp: 1700 }
];

const BADGES = [
  { id: "canopy_explorer", icon: "\u{1F333}", name: "Canopy Explorer", desc: "Terminer le module 1¬†: La Canop√©e" },
  { id: "first_scenario", icon: "\u{1F3AF}", name: "First Scenario", desc: "Terminez votre premier sc√©nario de d√©cision" },
  { id: "harvest_expert", icon: "\u{1F33E}", name: "Harvest Expert", desc: "Terminer le module R√©colte" },
  { id: "quality_judge", icon: "\u{1F50D}", name: "Quality Judge", desc: "Terminer le module Objectif" },
  { id: "overlap_detective", icon: "\u{1F50E}", name: "Overlap Detective", desc: "Terminer le module Chevauchement" },
  { id: "evidence_weaver", icon: "\u{1F9F5}", name: "Evidence Weaver", desc: "Terminer la synth√®se module" },
  { id: "gap_finder", icon: "\u{1F5FA}", name: "Gap Finder", desc: "Terminer le module Carte" },
  { id: "report_champion", icon: "\u{1F4DC}", name: "Report Champion", desc: "Terminer le module Rapport" },
  { id: "perfect_5", icon: "\u{2B50}", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "\u{1F9E0}", name: "Decision Maker", desc: "Terminer les 21 sc√©narios de d√©cision" },
  { id: "finisher", icon: "\u{1F3C6}", name: "Course Complete", desc: "Terminer l'int√©gralit√© du cours" },
  { id: "streak_3", icon: "\u{1F525}", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "\u{1F4AA}", name: "Weekly Warrior", desc: "Maintain a 7-day streak" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "The Canopy", subtitle: "Pourquoi un examen ne suffit pas", xp: 160,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "Umbrella Reviews", subtitle: "Quand un examen syst√©matique ne suffit pas suffisant" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Explain why multiple systematic reviews on the same topic create confusion",
          "D√©finir une revue g√©n√©rale et en quoi elle diff√®re d'une revue syst√©matique standard",
          "Identifier quand une revue g√©n√©rale est le bon choix de conception",
          "Reconna√Ætre les √©tapes principales d'un flux de travail de revue g√©n√©rale"
        ],
        tip: "Une revue g√©n√©rale ne regroupe pas les √©tudes primaires. Il regroupe les conclusions des revues syst√©matiques."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE FLOOD", title: "When five reviews gave five answers",
        text: "Un panel de lignes directrices a trouv√© cinq revues syst√©matiques sur la m√™me intervention. Trois ont d√©clar√© que cela fonctionnait, un √©tait incertain et un a mis en garde contre un danger. Chacun a utilis√© des dates de recherche, des crit√®res d‚Äôinclusion et des outils de qualit√© diff√©rents. Le panel n'a pas pu d√©cider √† qui faire confiance.",
        followup: "Un examen g√©n√©ral existe pr√©cis√©ment pour ce moment¬†: se tenir au-dessus des examens individuels et √©valuer l'ensemble du paysage."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE PAIR", title: "Two teams, two strategies",
        text: "Team A conducted a sixth systematic review on the same topic, adding to the noise. Team B conducted an umbrella review: they mapped all existing reviews, assessed their quality, checked for overlap, and synthesized conclusions across them.",
        followup: "L'√©quipe B a produit un document unique expliquant pourquoi les examens √©taient en d√©saccord et quelles conclusions √©taient dignes de confiance.",
        warning: true
      }},
      { type: "stats", theme: "dark", content: {
        title: "Les preuves Paysage",
        stats: [
          { value: "8000+", label: "Systematic reviews published yearly" },
          { value: "multiple", label: "Revues par question clinique" },
          { value: "30-50%", label: "Overlap in primary studies across SRs" },
          { value: "growing", label: "Besoin d'une synth√®se des preuves √† grande √©chelle" }
        ],
        caption: "Chiffres approximatifs issus d'√©tudes bibliom√©triques."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Qu'est-ce qu'une revue g√©n√©rale",
        subtitle: "Une revue syst√©matique des √©tudes syst√©matiques revues",
        text: "Une revue g√©n√©rale (√©galement appel√©e aper√ßu des revues ou m√©ta-revue) identifie, √©value et synth√©tise syst√©matiquement les r√©sultats de plusieurs revues syst√©matiques sur un sujet connexe. L'unit√© d'analyse est la revue syst√©matique elle-m√™me, et non l'√©tude principale.",
        highlight: "La revue g√©n√©rale ne refait pas le travail original. Il les √©value, les compare et les cartographie."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Quand choisir une revue g√©n√©rale",
        items: [
          "Multiple systematic reviews already exist on the topic",
          "Reviews reach discordant conclusions",
          "Decision makers need a single trustworthy summary",
          "Vous devez cartographier les lacunes en mati√®re de preuves sur une question vaste",
          "Les ressources sont insuffisantes pour refaire toutes les √©tudes primaires"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Scenario: Design Choice", xp: 25,
        scenario: "Un minist√®re de la Sant√© demande des preuves sur la vitamine D et les infections respiratoires. Il existe d√©j√† douze revues syst√©matiques avec des conclusions variables.",
        question: "Quel est le plan d'√©tude le plus appropri√©¬†?",
        options: [
          { letter: "A", text: "Effectuer une treizi√®me revue syst√©matique", correct: false },
          { letter: "B", text: "Effectuer une revue g√©n√©rale des douze", correct: true },
          { letter: "C", text: "Choisir la revue la plus r√©cente seulement", correct: false },
          { letter: "D", text: "Narrative opinion piece", correct: false }
        ],
        feedback: {
          correct: "Correct. Lorsqu'il existe plusieurs SR avec des conclusions variables, une revue g√©n√©rale les synth√©tise et les √©value syst√©matiquement.",
          incorrect: "L'ajout d'un autre SR √† un champ encombr√© augmente le bruit. Une revue g√©n√©rale organise les preuves existantes."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Sc√©nario¬†: Unit√© d'analyse", xp: 25,
        scenario: "Un chercheur planifie une revue g√©n√©rale. Ils extraient les donn√©es de chaque ECR trouv√© dans les revues syst√©matiques incluses.",
        question: "Quel est le probl√®me¬†?",
        options: [
          { letter: "A", text: "Rien, c'est la proc√©dure correcte", correct: false },
          { letter: "B", text: "L'unit√© d'analyse doit √™tre le SR, pas l'ECR.", correct: true },
          { letter: "C", text: "They should only include meta-analyses", correct: false },
          { letter: "D", text: "They need more RCTs", correct: false }
        ],
        feedback: {
          correct: "Correct. Dans une revue g√©n√©rale, la revue syst√©matique est l‚Äôunit√© d‚Äôanalyse. L'extraction des donn√©es d'√©tude primaires s'effectue selon une conception diff√©rente.",
          incorrect: "Les revues parapluie analysent les revues syst√©matiques comme leur unit√©. Le retour aux √©tudes primaires modifie la conception en une SR traditionnelle ou une nouvelle analyse."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RR", title: "Scenario: Too Few Reviews", xp: 25,
        scenario: "Only one systematic review exists on a rare disease intervention.",
        question: "Devriez-vous effectuer un examen global¬†?",
        options: [
          { letter: "A", text: "Yes, any topic can have an umbrella review", correct: false },
          { letter: "B", text: "No, an umbrella review requires multiple SRs to compare", correct: true },
          { letter: "C", text: "Only if the single SR is low quality", correct: false },
          { letter: "D", text: "Only if the disease is common enough", correct: false }
        ],
        feedback: {
          correct: "Correct. Les revues g√©n√©rales sont con√ßues pour comparer et synth√©tiser plusieurs SR. Avec un seul, mettez √† jour ou reproduisez le SR √† la place.",
          incorrect: "An umbrella review needs multiple systematic reviews to fulfill its purpose of cross-review synthesis."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "When reviews multiply, the umbrella gathers them." }}
    ]
  },
  {
    id: 2, title: "The Harvest", subtitle: "Recherche et s√©lection d'avis", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Harvest", subtitle: "Rassemblez tous les avis pertinents" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Design a search strategy targeting systematic reviews",
          "Apply eligibility criteria specific to umbrella reviews",
          "Handle borderline study designs (scoping reviews, rapid reviews)",
          "Document selection with a modified PRISMA flow"
        ],
        tip: "La r√©colte dans une revue g√©n√©rale ne consiste pas √† trouver des essais. Il s'agit de trouver les revues qui ont d√©j√† trouv√© les essais."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE NET", title: "Lorsque la recherche a manqu√© la moiti√© des revues",
        text: "Une revue g√©n√©rale a recherch√© uniquement MEDLINE et a manqu√© les revues syst√©matiques publi√©es dans les bases de donn√©es r√©gionales, Cochrane et les revues enregistr√©es aupr√®s de PROSPERO avec leurs r√©sultats. La synth√®se finale √©tait incompl√®te et biais√©e en faveur des revues de langue anglaise.",
        followup: "Searching for systematic reviews requires the same rigor as searching for primary studies: multiple databases, grey literature, and hand-searching reference lists of included reviews.",
        warning: true
      }},
      { type: "stats", theme: "dark", content: {
        title: "Search Sources for Systematic Reviews",
        stats: [
          { value: "MEDLINE", label: "Core biomedical database" },
          { value: "Cochrane", label: "Largest SR repository" },
          { value: "Epistemonikos", label: "SR-specific database" },
          { value: "PROSPERO", label: "SR protocol registry" }
        ],
        caption: "Key sources; additional databases depend on the topic."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Strat√©gie de recherche pour les revues",
        subtitle: "Filtre pour le bon plan d'√©tude",
        text: "Utilisez des filtres de recherche valid√©s pour les revues syst√©matiques et les m√©ta-analyses. Combinez les termes du sujet avec des filtres m√©thodologiques. Consultez les bases de donn√©es sp√©cifiques √† SR comme Epistemonikos et la base de donn√©es Cochrane des revues syst√©matiques. Filtrez PROSPERO pour les avis termin√©s mais non publi√©s.",
        highlight: "Un avis manqu√© est une perspective manqu√©e. Une recherche compl√®te n'est pas facultative."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Harvest Checklist",
        items: [
          "Search at least three major databases with SR filters",
          "Inclure la biblioth√®que Cochrane et Epistemonikos",
          "Check PROSPERO for registered reviews",
          "Hand-search reference lists of included reviews",
          "Define clear eligibility criteria before screening"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Sc√©nario¬†: examen de la port√©e", xp: 25,
        scenario: "Lors de la s√©lection, vous trouvez une √©tude de la port√©e bien men√©e qui cartographie les preuves sur votre sujet mais ne regroupe pas les effets. tailles.",
        question: "Devriez-vous l'inclure dans votre √©valuation du parapluie¬†?",
        options: [
          { letter: "A", text: "Yes, include all review types", correct: false },
          { letter: "B", text: "Exclude it; umbrella reviews include only systematic reviews", correct: true },
          { letter: "C", text: "Include it but label it differently", correct: false },
          { letter: "D", text: "Include only its reference list", correct: false }
        ],
        feedback: {
          correct: "Correct. Les revues g√©n√©rales comprennent g√©n√©ralement uniquement des revues syst√©matiques (avec ou sans m√©ta-analyse). Les examens de cadrage utilisent des m√©thodes et des normes de qualit√© diff√©rentes.",
          incorrect: "Les examens de cadrage suivent une m√©thodologie diff√©rente et ne peuvent pas √™tre √©valu√©s avec des outils de qualit√© SR comme AMSTAR 2."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Sc√©nario¬†: examen obsol√®te", xp: 25,
        scenario: "Un examen syst√©matique de 2008 r√©pond √† vos crit√®res d'√©ligibilit√© mais a √©t√© remplac√© par une version mise √† jour de 2022.",
        question: "Comment devez-vous g√©rer cela¬†?",
        options: [
          { letter: "A", text: "Include both versions as separate entries", correct: false },
          { letter: "B", text: "Include only the most recent version", correct: true },
          { letter: "C", text: "Exclude both to avoid double counting", correct: false },
          { letter: "D", text: "Merge them into one entry", correct: false }
        ],
        feedback: {
          correct: "Correct. Lorsqu'une revue a √©t√© officiellement mise √† jour, incluez uniquement la version la plus r√©cente pour √©viter de compter deux fois la m√™me base de donn√©es probantes.",
          incorrect: "L'inclusion des deux versions entra√Ænerait une double comptabilisation des m√™mes √©tudes primaires. La version mise √† jour remplace l'originale."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Protocol Screening", xp: 25,
        scenario: "Vous trouvez une inscription PROSPERO pour une revue syst√©matique qui correspond parfaitement √† votre sujet mais n'a pas de r√©sultats publi√©s.",
        question: "Que devez-vous faire¬†?",
        options: [
          { letter: "A", text: "Incluez le protocole comme revue termin√©e", correct: false },
          { letter: "B", text: "Contactez les auteurs pour v√©rifier les publications non publi√©es. r√©sultats", correct: true },
          { letter: "C", text: "Ignore it entirely", correct: false },
          { letter: "D", text: "Attendre ind√©finiment la publication", correct: false }
        ],
        feedback: {
          correct: "Corriger. Contacter les auteurs peut r√©v√©ler des critiques termin√©es mais non publi√©es, r√©duisant ainsi le biais de publication dans votre revue g√©n√©rale.",
          incorrect: "Registered but unpublished reviews may contain important evidence. Author contact is a standard step to reduce bias."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Une r√©colte qui manque des critiques passe √† c√¥t√© de la v√©rit√©." }}
    ]
  },
  {
    id: 3, title: "The Lens", subtitle: "L'√©valuation de la qualit√© avec AMSTAR 2", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Lens", subtitle: "Not all reviews deserve equal trust" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply AMSTAR 2 to assess the methodological quality of included SRs",
          "Distinguish critical from non-critical domains",
          "Assign overall confidence ratings: high, moderate, low, critically low",
          "Use quality assessment to weight conclusions, not just exclude reviews"
        ],
        tip: "AMSTAR 2 n'est pas un score. Il s'agit d'un jugement structur√© qui classe la confiance dans les r√©sultats de la revue."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE FLAW", title: "When a flawed review drove policy",
        text: "Une revue syst√©matique sans risque d'√©valuation de biais et une recherche incompl√®te a √©t√© cit√©e par une ligne directrice nationale. Une revue g√©n√©rale a montr√© plus tard que cette revue avait un niveau de confiance extr√™mement faible sur AMSTAR 2, tandis que trois revues de meilleure qualit√© sont parvenues √† la conclusion oppos√©e.",
        followup: "Sans √©valuation de la qualit√©, la revue la plus bruyante l'emporte. Gr√¢ce √† lui, l'√©valuation la plus fiable m√®ne."
      }},
      { type: "concept", theme: "dark", content: {
        title: "AMSTAR 2¬†:¬†l'outil standard",
        subtitle: "16 items, 7 critical domains",
        text: "AMSTAR 2 evaluates systematic review methodology across 16 items. Seven are designated critical: protocol registration, comprehensive search, justification for exclusions, risk of bias assessment, appropriate meta-analytic methods, consideration of risk of bias in interpreting results, and assessment of publication bias.",
        highlight: "A single critical flaw drops the overall rating. Two or more critical flaws means critically low confidence."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "AMSTAR 2 Critical Domains",
        items: [
          "Protocole enregistr√© avant le d√©but de l'examen",
          "Comprehensive literature search performed",
          "Justification fournie pour l'exclusion des √©tudes individuelles",
          "Risque de biais √©valu√© pour les √©tudes incluses",
          "M√©thodes appropri√©es utilis√©es pour la m√©ta-analyse",
          "Risk of bias considered when interpreting results",
          "Publication bias assessed and discussed"
        ]
      }},
      { type: "amstar16", theme: "dark", content: {
        title: "AMSTAR 2: All 16 Items",
        subtitle: "7 Critical (starred) and 9 Non-critical items",
        critical: [
          { num: 2, text: "Protocole enregistr√© avant le d√©but de l'examen" },
          { num: 4, text: "Comprehensive literature search strategy" },
          { num: 7, text: "Justification pour l'exclusion des √©tudes individuelles √©tudes" },
          { num: 9, text: "Satisfactory technique for assessing risk of bias" },
          { num: 11, text: "M√©thodes m√©ta-analytiques appropri√©es" },
          { num: 13, text: "Risk of bias considered when interpreting results" },
          { num: 15, text: "Publication bias assessed and discussed" }
        ],
        nonCritical: [
          { num: 1, text: "Research questions include PICO components" },
          { num: 3, text: "Revoir les m√©thodes √©tablies avant la r√©alisation" },
          { num: 5, text: "S√©lection des √©tudes effectu√©e en double" },
          { num: 6, text: "Extraction des donn√©es effectu√©e en double" },
          { num: 8, text: "Description ad√©quate des √©tudes incluses √©tudes" },
          { num: 10, text: "Les sources de financement des √©tudes incluses ont √©t√© signal√©es" },
          { num: 12, text: "Impact of risk of bias on meta-analysis assessed" },
          { num: 14, text: "L'h√©t√©rog√©n√©it√© discut√©e et expliqu√©e" },
          { num: 16, text: "Conflicts of interest reported and managed" }
        ]
      }},
      { type: "stats", theme: "dark", content: {
        title: "Confidence Rating Scale",
        stats: [
          { value: "High", label: "No or one non-critical weakness" },
          { value: "Moderate", label: "More than one non-critical weakness" },
          { value: "Low", label: "One critical flaw with/without non-critical" },
          { value: "Crit. Low", label: "More than one critical flaw" }
        ],
        caption: "Based on the AMSTAR 2 classification scheme by Shea et al. 2017."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Missing Risk of Bias", xp: 25,
        scenario: "Une revue syst√©matique incluse dans votre revue g√©n√©rale n'a √©valu√© le risque de biais dans aucune de ses √©tudes principales.",
        question: "Qu'est-ce que l'AMSTAR 2 implication¬†?",
        options: [
          { letter: "A", text: "Non-critical weakness only", correct: false },
          { letter: "B", text: "Critical flaw, drops confidence to low or critically low", correct: true },
          { letter: "C", text: "Aucun impact si la m√©ta-analyse a √©t√© effectu√©e correctement", correct: false },
          { letter: "D", text: "Exclure enti√®rement l'avis", correct: false }
        ],
        feedback: {
          correct: "Correct. Risk of bias assessment is a critical domain. Its absence constitutes a critical flaw.",
          incorrect: "Risk of bias assessment is one of the seven critical domains in AMSTAR 2. Missing it is a critical flaw."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Quality Exclusion", xp: 25,
        scenario: "Tous les avis inclus, sauf un, ont une note critique faible sur AMSTAR 2. Le reste est not√© √©lev√©.",
        question: "Comment devez-vous g√©rer cela dans votre synth√®se¬†?",
        options: [
          { letter: "A", text: "Exclude all critically low reviews", correct: false },
          { letter: "B", text: "Include all but weight conclusions by quality rating", correct: true },
          { letter: "C", text: "Faites la moyenne de tous les r√©sultats de mani√®re √©gale", correct: false },
          { letter: "D", text: "Ne signalez que l'examen de haute qualit√©", correct: false }
        ],
        feedback: {
          correct: "Correct. Umbrella reviews should include all eligible reviews but use quality ratings to contextualize findings and weight conclusions.",
          incorrect: "Excluding low-quality reviews risks bias. Include them but clearly note how quality affects the strength of conclusions."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "QA", title: "Scenario: Dual Assessment", xp: 25,
        scenario: "Deux √©valuateurs ne sont pas d'accord sur la question de savoir si un examen syst√©matique r√©pond au crit√®re AMSTAR 2 pour une recherche compl√®te.",
        question: "Quel est le meilleur r√©solution¬†?",
        options: [
          { letter: "A", text: "Accept the more generous rating", correct: false },
          { letter: "B", text: "Discuter, appliquer les r√®gles de d√©cision et documenter la r√©solution", correct: true },
          { letter: "C", text: "Exclure l'examen pour √©viter le d√©saccord", correct: false },
          { letter: "D", text: "Let a third person decide without seeing the assessments", correct: false }
        ],
        feedback: {
          correct: "Corriger. Les d√©saccords doivent √™tre r√©solus par une discussion avec des r√®gles de d√©cision pr√©d√©finies et la r√©solution document√©e.",
          incorrect: "La r√©solution transparente avec la documentation maintient l'int√©grit√© de l'√©valuation de la qualit√©."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "L'objectif qui ignore la qualit√© amplifie l'erreur." }}
    ]
  },
  {
    id: 4, title: "The Overlap", subtitle: "Lorsque les avis partagent la m√™me chose. √©tudes", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Overlap", subtitle: "The hidden problem of double counting" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Explain why primary study overlap matters in umbrella reviews",
          "Calculate the Corrected Covered Area to quantify overlap",
          "Apply strategies to manage moderate and high overlap",
          "Report overlap transparently"
        ],
        tip: "Si cinq revues incluent chacune les trois m√™mes ECR, vous ne disposez pas de cinq √©l√©ments de preuve ind√©pendants. Vous disposez d'une base de donn√©es compt√©e cinq fois."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE ECHO", title: "Lorsque les m√™mes patients ont √©t√© compt√©s trois fois",
        text: "Une revue g√©n√©rale a regroup√© les r√©sultats de quatre revues syst√©matiques. √Ä l‚Äôinsu des auteurs, trois des quatre revues incluaient le m√™me grand ECR. Le r√©sultat regroup√© reposait presque enti√®rement sur un seul essai compt√© plusieurs fois, cr√©ant une fausse impression de pr√©cision.",
        followup: "La d√©tection de chevauchement n'est pas facultative. Sans cela, les examens g√©n√©raux amplifient les √©chos au lieu des preuves."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Overlap Thresholds (CCA)",
        stats: [
          { value: "0-5%", label: "Slight overlap" },
          { value: "6-10%", label: "Moderate overlap" },
          { value: "11-15%", label: "High overlap" },
          { value: ">15%", label: "Very high overlap" }
        ],
        caption: "Corrected Covered Area thresholds by Pieper et al. 2014."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Corrected Covered Area (CCA)",
        subtitle: "Une m√©trique de chevauchement des √©tudes primaires",
        text: "The CCA measures the degree to which the same primary studies appear across multiple systematic reviews. Build a citation matrix listing all primary studies (rows) against all included SRs (columns). Formula: CCA = (N &minus; r) / (r &times; c &minus; r), where N = total citations across all SRs, r = number of unique primary studies, and c = number of included SRs.",
        highlight: "Un chevauchement √©lev√© signifie que vos examens ne sont pas ind√©pendants. Traitez leurs r√©sultats comme corr√©l√©s et non additifs."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Overlap Management",
        items: [
          "Build a citation matrix of primary studies across SRs",
          "Calculate the Corrected Covered Area",
          "Rapportez le degr√© de chevauchement et ses implications",
          "Consider using only the most comprehensive or most recent SR per comparison",
          "Ne regroupez jamais les r√©sultats de SR fortement chevauchants comme s'ils √©taient ind√©pendants"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Scenario: Very High Overlap", xp: 25,
        scenario: "Votre matrice de citation r√©v√®le un CCA de 22¬†%. La plupart des revues partagent les m√™mes cinq ECR principaux.",
        question: "Quelle est la meilleure approche pour la synth√®se¬†?",
        options: [
          { letter: "A", text: "Regroupez tous les r√©sultats des revues sous forme d'estimations ind√©pendantes", correct: false },
          { letter: "B", text: "Select the most comprehensive SR or conduct a de novo meta-analysis", correct: true },
          { letter: "C", text: "Ignorez le chevauchement et poursuivez", correct: false },
          { letter: "D", text: "Supprimez les √©tudes qui se chevauchent de toutes les revues", correct: false }
        ],
        feedback: {
          correct: "Correct. With very high overlap, pooling is misleading. Select the most comprehensive review or return to primary data.",
          incorrect: "Un chevauchement tr√®s √©lev√© signifie que les revues ne sont pas des sources ind√©pendantes. La mise en commun cr√©erait une fausse pr√©cision."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Sc√©nario¬†: Construire la matrice", xp: 25,
        scenario: "Deux de vos critiques incluses ne r√©pertorient pas les r√©f√©rences d'√©tudes individuelles dans leurs parcelles ou tableaux forestiers.",
        question: "Comment devez-vous g√©rer cela pour la matrice de citation¬†?",
        options: [
          { letter: "A", text: "Ne supposez aucun chevauchement pour celles-ci avis", correct: false },
          { letter: "B", text: "Extract references from reference lists or contact authors", correct: true },
          { letter: "C", text: "Exclure ces avis de l'examen g√©n√©ral", correct: false },
          { letter: "D", text: "Skip the citation matrix entirely", correct: false }
        ],
        feedback: {
          correct: "Corriger. Des efforts doivent √™tre faits pour identifier les √©tudes incluses √† partir des listes de r√©f√©rences ou en contactant les auteurs.",
          incorrect: "La matrice de citation n√©cessite de savoir quelles √©tudes chaque SR inclus. Les donn√©es manquantes doivent √™tre recherch√©es et non suppos√©es."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "OA", title: "Scenario: Slight Overlap", xp: 25,
        scenario: "Votre DPA est de 3¬†%. Chaque revue a utilis√© un ensemble largement unique d'√©tudes primaires en raison de dates de recherche et de crit√®res d'inclusion diff√©rents.",
        question: "Comment cela affecte-t-il votre synth√®se¬†?",
        options: [
          { letter: "A", text: "Vous pouvez traiter les revues comme largement ind√©pendantes", correct: true },
          { letter: "B", text: "Vous ne devez toujours s√©lectionner qu'une seule revue", correct: false },
          { letter: "C", text: "Overlap is always a fatal problem", correct: false },
          { letter: "D", text: "Vous devez combiner toutes les √©tudes primaires √† la place", correct: false }
        ],
        feedback: {
          correct: "Correct. Un l√©ger chevauchement signifie que les examens fournissent des preuves largement ind√©pendantes. La synth√®se peut se d√©rouler avec la prudence appropri√©e.",
          incorrect: "Un l√©ger chevauchement est acceptable. La cl√© est de la mesurer, de la signaler et d'interpr√©ter les r√©sultats en cons√©quence."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Comptez les preuves une fois, pas l'√©cho." }}
    ]
  },
  {
    id: 5, title: "The Synthesis", subtitle: "Tisser des preuves √† travers les avis", xp: 170,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "The Synthesis", subtitle: "De plusieurs avis √† une seule r√©ponse" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Choose between narrative and quantitative synthesis approaches",
          "Understand when re-analysis of primary data is justified",
          "Pr√©senter des r√©sultats discordants de mani√®re transparente",
          "Apply GRADE or a similar framework to rate certainty across reviews"
        ],
        tip: "C'est dans la synth√®se que la revue g√©n√©rale gagne sa valeur¬†: transformer des signaux contradictoires en un jugement structur√©."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE WEAVE", title: "When three meta-analyses disagreed",
        text: "Trois revues syst√©matiques ont chacune effectu√© une m√©ta-analyse sur la m√™me intervention. L‚Äôun a trouv√© un b√©n√©fice significatif, un autre n‚Äôa trouv√© aucun effet et un autre a trouv√© une tendance au pr√©judice. L'examen g√©n√©ral a retrac√© la discordance √† diff√©rents crit√®res d'inclusion, au risque de gestion des biais et aux mod√®les statistiques.",
        followup: "La synth√®se n'a pas choisi de gagnant. Il explique pourquoi ils ne sont pas d'accord et quels choix m√©thodologiques sont √† l'origine de la diff√©rence.",
        warning: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Synthesis Approaches",
        subtitle: "Faire correspondre la m√©thode aux donn√©es",
        text: "La synth√®se narrative compare les r√©sultats des analyses √† l'aide de tableaux structur√©s. La r√©analyse quantitative regroupe les donn√©es de l'√©tude primaire lorsque le chevauchement est faible et que les donn√©es sont accessibles. Une approche hybride compile les r√©sultats au niveau des revues et utilise des graphiques forestiers pour afficher visuellement la concordance et la discordance.",
        highlight: "Ne regroupez jamais les r√©sultats d'√©valuations qui se chevauchent comme s'il s'agissait d'√©tudes ind√©pendantes."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Synthesis Checklist",
        items: [
          "Compilez tous les r√©sultats des revues c√¥te √† c√¥te avec des notes de qualit√©",
          "Identify sources of discordance (scope, methods, dates, bias handling)",
          "Rapportez la direction, l'ampleur et la pr√©cision pour chacun. examen",
          "Apply GRADE or equivalent to assess certainty of evidence",
          "Present both concordant and discordant findings transparently"
        ]
      }},
      { type: "stats", theme: "dark", content: {
        title: "Discordance Drivers",
        stats: [
          { value: "scope", label: "Different PICO definitions" },
          { value: "search", label: "Different databases or dates" },
          { value: "bias", label: "Diff√©rents outils de qualit√©" },
          { value: "analysis", label: "Different statistical models" }
        ],
        caption: "Common reasons reviews on the same topic disagree."
      }},
      { type: "grade5", theme: "dark", content: {
        title: "GRADE¬†: les cinq domaines",
        subtitle: "Rate certainty by assessing each domain",
        domains: [
          { name: "Risk of Bias", desc: "Limitations dans la conception ou l'ex√©cution de l'√©tude qui peuvent biaiser les r√©sultats" },
          { name: "Inconsistency", desc: "H√©t√©rog√©n√©it√© inexpliqu√©e des r√©sultats √† travers √©tudes" },
          { name: "Indirectness", desc: "Les preuves ne s'appliquent pas directement √† la question (population, intervention, comparateur, r√©sultat)" },
          { name: "Imprecision", desc: "Wide confidence intervals due to small sample size or few events" },
          { name: "Publication Bias", desc: "Publication s√©lective d'√©tudes bas√©es sur les r√©sultats" }
        ],
        note: "Each domain can downgrade certainty from high to moderate, low, or very low."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Pooling Decision", xp: 25,
        scenario: "Vous avez six SR inclus avec un chevauchement mod√©r√© (CCA 9 %). Quatre ont utilis√© une m√©ta-analyse √† effets al√©atoires avec des crit√®res PICO similaires.",
        question: "Pouvez-vous regrouper leurs r√©sultats de m√©ta-analyse¬†?",
        options: [
          { letter: "A", text: "Yes, pool all six review-level estimates", correct: false },
          { letter: "B", text: "No, use narrative synthesis with a structured comparison table", correct: true },
          { letter: "C", text: "Regrouper uniquement les quatre avec des m√©thodes similaires, en ignorant les chevauchements", correct: false },
          { letter: "D", text: "Conduct a meta-analysis of meta-analyses without checking overlap", correct: false }
        ],
        feedback: {
          correct: "Corriger. En cas de chevauchement mod√©r√©, la mise en commun des estimations au niveau de l‚Äôexamen risque d‚Äô√™tre comptabilis√©e deux fois. La synth√®se narrative avec comparaison structur√©e est plus s√ªre.",
          incorrect: "Un chevauchement mod√©r√© signifie que les revues partagent des √©tudes primaires. La mise en commun de leurs r√©sultats donnerait un poids excessif √† ces √©tudes partag√©es."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: Discordance Explained", xp: 25,
        scenario: "Two high-quality SRs disagree: one finds benefit, the other no effect. You trace the discordance to a single large trial included in one but not the other.",
        question: "Comment devez-vous signaler cela¬†?",
        options: [
          { letter: "A", text: "Rejeter l'examen sans proc√®s", correct: false },
          { letter: "B", text: "Expliquez la source de la discordance et pr√©sentez les deux r√©sultats avec leur contexte", correct: true },
          { letter: "C", text: "Faire la moyenne des deux r√©sultats", correct: false },
          { letter: "D", text: "Exclude both reviews", correct: false }
        ],
        feedback: {
          correct: "Correct. Transparent reporting of discordance sources is a core function of umbrella reviews.",
          incorrect: "Les avis g√©n√©raux ajoutent de la valeur en expliquant pourquoi les avis ne sont pas d'accord, et non en cachant le d√©saccord."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ES", title: "Scenario: GRADE in Umbrella Reviews", xp: 25,
        scenario: "Vous souhaitez √©valuer la certitude globale des preuves dans vos avis inclus. Plusieurs revues ont utilis√© diff√©rentes approches de GRADE.",
        question: "Quelle est l‚Äôapproche recommand√©e ?",
        options: [
          { letter: "A", text: "Faire la moyenne des notes GRADE de chaque avis", correct: false },
          { letter: "B", text: "Appliquer GRADE de mani√®re ind√©pendante sur la base des meilleures donn√©es primaires disponibles", correct: true },
          { letter: "C", text: "Utilisez la note GRADE la plus √©lev√©e de tous les avis", correct: false },
          { letter: "D", text: "Skip certainty assessment in umbrella reviews", correct: false }
        ],
        feedback: {
          correct: "Correct. Les revues g√©n√©rales doivent appliquer GRADE ou √©quivalent de mani√®re ind√©pendante, en tenant compte de la base de donn√©es probantes la plus fiable et de la qualit√© des revues incluses.",
          incorrect: "La moyenne ou la s√©lection des notes GRADE ne sont pas valides. L‚Äô√©quipe g√©n√©rale d‚Äôexamen doit formuler son propre jugement de certitude."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "La synth√®se r√©v√®le le signal sous le bruit." }}
    ]
  },
  {
    id: 6, title: "The Map", subtitle: "Lacunes, concordance et visualisation", xp: 170,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Map", subtitle: "See what is known and what is missing" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Cr√©er une carte des preuves montrant o√π les preuves sont fortes ou faibles",
          "Identify research gaps that future reviews or trials should address",
          "Visualize concordance and discordance across reviews",
          "Use structured tables and harvest plots to communicate findings"
        ],
        tip: "Une analyse globale qui r√©sume uniquement les r√©sultats passe √† c√¥t√© de sa plus grande force : r√©v√©ler la forme du paysage des donn√©es probantes."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE BLANK", title: "Quand la carte a r√©v√©l√© l'√©cart",
        text: "Une revue g√©n√©rale sur l'exercice et la sant√© mentale a trouv√© douze revues sur la d√©pression mais aucune sur le trouble bipolaire. La carte des preuves a rendu cette lacune visible dans un seul chiffre, d√©clenchant un appel de financement pour la recherche qui a conduit √† trois nouveaux essais.",
        followup: "L‚Äôabsence de preuve constitue en soi une constatation. La carte le rend visible.",
        warning: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Evidence Mapping",
        subtitle: "Structurer le paysage",
        text: "An evidence map cross-tabulates populations, interventions, comparisons, and outcomes against the number and quality of available reviews. Cells with many high-quality reviews show strong evidence; empty cells reveal gaps. Harvest plots display direction and strength of effects across reviews at a glance.",
        highlight: "La carte n'est pas une d√©coration. C'est l'outil de d√©cision."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Mapping Checklist",
        items: [
          "Define the matrix dimensions (population, intervention, outcome)",
          "Remplissez chaque cellule avec le nombre et la qualit√© des avis",
          "Mark cells with discordant findings",
          "Highlight empty cells as research gaps",
          "Utiliser des outils visuels (parcelles de r√©colte, trac√©s √† bulles) pour la communication"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Priority Setting", xp: 25,
        scenario: "Votre carte des preuves montre une cellule avec quatre examens de qualit√© extr√™mement faible et aucun examen de haute qualit√©. La question clinique est importante.",
        question: "Quelle est la recommandation prioritaire ?",
        options: [
          { letter: "A", text: "Accepter les preuves extr√™mement faibles comme √©tant suffisantes", correct: false },
          { letter: "B", text: "Recommander une revue syst√©matique de haute qualit√© pour combler les lacunes", correct: true },
          { letter: "C", text: "Recommend more umbrella reviews", correct: false },
          { letter: "D", text: "Ignorer compl√®tement la cellule", correct: false }
        ],
        feedback: {
          correct: "Correct. Les cellules avec uniquement des √©valuations de faible qualit√© repr√©sentent des preuves qui existent mais auxquelles on ne peut pas faire confiance. Une nouvelle RS rigoureuse est la priorit√©.",
          incorrect: "Les avis de tr√®s mauvaise qualit√© ne r√©pondent pas √† la question de mani√®re fiable. L‚Äô√©cart r√©side dans la qualit√© et non dans la quantit√©."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Concordance Display", xp: 25,
        scenario: "Six revues trouvent toutes un b√©n√©fice significatif pour la m√™me paire intervention-r√©sultat, mais la taille de l'effet varie de petite √† grande.",
        question: "Comment devez-vous afficher cela dans la carte des preuves¬†?",
        options: [
          { letter: "A", text: "Marquez la cellule comme concordante avec une note sur la plage de tailles d'effet", correct: true },
          { letter: "B", text: "Mark it as discordant because effect sizes differ", correct: false },
          { letter: "C", text: "Report only the median effect size", correct: false },
          { letter: "D", text: "Laissez la cellule vide", correct: false }
        ],
        feedback: {
          correct: "Correct. La concordance de direction avec la variation d'ampleur est une constatation courante et importante. Signalez √† la fois l‚Äôaccord et la plage.",
          incorrect: "Les avis qui s‚Äôaccordent sur l‚Äôorientation mais diff√®rent en termes d‚Äôampleur sont concordants sur la question cl√©, la pr√©cision variant selon les m√©thodes."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "GM", title: "Scenario: Empty Cell", xp: 25,
        scenario: "Votre carte de donn√©es comporte une colonne enti√®re de population sans examens syst√©matiques¬†: les enfants de moins de cinq ans.",
        question: "Que faut-il conclure ?",
        options: [
          { letter: "A", text: "L'intervention ne fonctionne pas dans cette population", correct: false },
          { letter: "B", text: "Evidence is absent, flag as a research gap, avoid making effectiveness claims", correct: true },
          { letter: "C", text: "Extrapoler √† partir de donn√©es sur les adultes", correct: false },
          { letter: "D", text: "Supprimer la population de la carte", correct: false }
        ],
        feedback: {
          correct: "Corriger. L‚Äôabsence de preuve n‚Äôest pas une preuve d‚Äôabsence. Signalez l'√©cart et recommandez des recherches futures.",
          incorrect: "Les cellules vides signifient que la question n'a pas re√ßu de r√©ponse, et non que la r√©ponse est n√©gative."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "La carte montre non seulement ce que nous savons, mais aussi ce que nous devons encore apprendre." }}
    ]
  },
  {
    id: 7, title: "The Report", subtitle: "Normes, pi√®ges et cl√¥ture", xp: 200,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "The Report", subtitle: "Bouclez la boucle avec un reporting transparent" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply reporting guidelines for umbrella reviews (PRIOR, PRISMA adaptations)",
          "Avoid the most common pitfalls in published umbrella reviews",
          "Decide when an umbrella review adds value versus when a new SR is needed",
          "Retour au sc√©nario d'ouverture avec une r√©ponse structur√©e"
        ],
        tip: "Ring structure: we return to the five conflicting reviews from Module 1. Now you have the tools to resolve them."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "THE RETURN", title: "Le panel des lignes directrices, revisit√©",
        text: "The panel that faced five conflicting reviews now has an umbrella review. It shows that three of the five reviews had critically low quality, overlap was high, and the two trustworthy reviews agreed on a moderate benefit with low certainty. The panel has a clear, justified basis for its recommendation.",
        followup: "L'examen parapluie n'a pas produit de nouvelles donn√©es. Il a organis√© les preuves existantes en un jugement digne de confiance.",
        success: true
      }},
      { type: "concept", theme: "dark", content: {
        title: "Reporting Standards",
        subtitle: "PRIOR et PRISMA adapt√©",
        text: "The Preferred Reporting Items for Overviews of Reviews (PRIOR) statement provides a checklist for transparent reporting of umbrella reviews. Key items include explicit description of overlap assessment, quality appraisal methods, synthesis approach, and certainty of evidence assessment. When PRIOR is unavailable, a PRISMA adaptation with umbrella-specific modifications is acceptable.",
        highlight: "A well-reported umbrella review enables others to judge its trustworthiness. Poor reporting defeats its purpose."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Common Pitfalls to Avoid",
        items: [
          "Failing to assess or report primary study overlap",
          "Using AMSTAR 2 as a numeric score instead of a confidence classification",
          "Regroupement des r√©sultats d'examens qui se chevauchent sans ajustement",
          "Ignoring discordance or reporting only concordant findings",
          "Omettre une carte de preuves structur√©e ou une analyse des lacunes"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Missing Overlap Report", xp: 35,
        scenario: "Un √©valuateur sugg√®re de supprimer la matrice de citation et le CCA du manuscrit pour gagner de la place. L'√©diteur est d'accord.",
        question: "Quelle est la r√©ponse correcte¬†?",
        options: [
          { letter: "A", text: "Agree, overlap is minor detail", correct: false },
          { letter: "B", text: "Keep the overlap assessment, move to supplement if needed", correct: true },
          { letter: "C", text: "Remove it and mention overlap in one sentence", correct: false },
          { letter: "D", text: "Remplacez-la par une d√©claration indiquant que le chevauchement √©tait faible", correct: false }
        ],
        feedback: {
          correct: "Correct. Overlap assessment is a core methodological requirement. If space is limited, move it to a supplement but never omit it.",
          incorrect: "L'√©valuation du chevauchement est fondamentale pour la validit√© d'un examen g√©n√©ral. Cela doit √™tre signal√©, au minimum dans des documents suppl√©mentaires."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Umbrella vs. New SR", xp: 35,
        scenario: "Une √©quipe de recherche souhaite √©tudier l'effet d'une nouvelle classe de m√©dicaments. Il existe deux SR de mauvaise qualit√©, tous deux avec des recherches incompl√®tes.",
        question: "Devraient-ils mener une revue g√©n√©rale ou une nouvelle revue syst√©matique¬†?",
        options: [
          { letter: "A", text: "Examen global des deux SR existants", correct: false },
          { letter: "B", text: "Une nouvelle revue syst√©matique rigoureuse", correct: true },
          { letter: "C", text: "Both simultaneously", correct: false },
          { letter: "D", text: "Les preuves ne sont pas non plus suffisant", correct: false }
        ],
        feedback: {
          correct: "Correct. Avec seulement deux SR de mauvaise qualit√©, un examen g√©n√©ral reposerait sur des bases fragiles. Une nouvelle SR bien men√©e a plus de valeur.",
          incorrect: "Une revue g√©n√©rale n'est aussi solide que les revues qu'elle inclut. Lorsque la base de donn√©es probantes existante est petite et faible, une nouvelle RS est le bon choix."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RE", title: "Scenario: Final Judgment", xp: 35,
        scenario: "Your umbrella review includes ten SRs. Seven are concordant (moderate benefit), two are discordant (no benefit), and one reports harm. Overlap is moderate. The seven concordant reviews are mostly high quality; the discordant ones are critically low quality.",
        question: "Quelle est la conclusion appropri√©e¬†?",
        options: [
          { letter: "A", text: "Definitive benefit, ignore the discordant reviews", correct: false },
          { letter: "B", text: "B√©n√©fice mod√©r√© probable avec une certitude mod√©r√©e, en notant la discordance avec les √©valuations de moindre qualit√©", correct: true },
          { letter: "C", text: "No conclusion possible due to discordance", correct: false },
          { letter: "D", text: "Harm signal overrides all other findings", correct: false }
        ],
        feedback: {
          correct: "Correct. La synth√®se p√®se la qualit√©, la concordance et le chevauchement. Des preuves concordantes de haute qualit√© √©tayent une conclusion tout en reconnaissant de mani√®re transparente les discordances.",
          incorrect: "Les analyses globales int√®grent la qualit√©, la concordance et le chevauchement pour former un jugement structur√©, et non un simple d√©compte des votes."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "When reviews multiply, the umbrella gathers them." }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = gameState.consecutiveCorrect || 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('umbrellaReviewGame_v1', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [], consecutiveCorrect: 0 };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
  const modal = document.getElementById('levelModal');
  document.getElementById('levelModalLevel').textContent = `Level ${levelData.level}`;
  document.getElementById('levelModalName').textContent = levelData.title;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');

  // Auto-close after 3 seconds
  setTimeout(() => {
    closeLevelModal();
  }, 3000);
}

function closeLevelModal() {
  const modal = document.getElementById('levelModal');
  if (modal) {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  const modal = document.getElementById('badgeModal');
  modal.classList.add('show');
  if (celebrate) triggerConfetti();

  // Focus trap
  const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
  if (focusableElements.length > 0) {
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    firstFocusable.focus();

    // Remove any existing focus trap listener
    if (modal._focusTrapHandler) {
      modal.removeEventListener('keydown', modal._focusTrapHandler);
    }

    modal._focusTrapHandler = function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
      if (e.key === 'Escape') {
        closeBadgeModal();
      }
    };
    modal.addEventListener('keydown', modal._focusTrapHandler);
  }
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  const modal = document.getElementById('badgeModal');
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    modal._focusTrapHandler = null;
  }
  modal.classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.completedModules.length;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="badge-item ${earned ? 'earned' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${locked ? 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">Time ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn prev" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="Previous slide">&lt;</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn next" onclick="nextSlide()" aria-label="Next slide">&gt;</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">Left / Right arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} ${slide.content.warning ? 'warning' : ''} ${slide.content.teal ? 'teal' : ''} animate" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'amstar16':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <p class="subtitle animate delay-1">${slide.content.subtitle}</p>
        <div style="display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;max-width:900px;margin-top:1rem" class="animate delay-2">
          <div style="flex:1;min-width:280px;background:rgba(239,68,68,0.15);border:2px solid var(--red);border-radius:8px;padding:1rem">
            <h3 style="color:var(--red);font-size:0.9rem;margin-bottom:0.75rem;font-weight:700">CRITICAL ITEMS (7)</h3>
            ${slide.content.critical.map(item => `
              <div style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.35rem 0;font-size:0.85rem">
                <span style="color:var(--red);font-weight:700;min-width:24px">${item.num}*</span>
                <span>${item.text}</span>
              </div>
            `).join('')}
          </div>
          <div style="flex:1;min-width:280px;background:rgba(34,197,94,0.1);border:2px solid var(--green);border-radius:8px;padding:1rem">
            <h3 style="color:var(--green);font-size:0.9rem;margin-bottom:0.75rem;font-weight:700">NON-CRITICAL ITEMS (9)</h3>
            ${slide.content.nonCritical.map(item => `
              <div style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.35rem 0;font-size:0.85rem">
                <span style="color:var(--green);font-weight:700;min-width:24px">${item.num}</span>
                <span>${item.text}</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>`;
      break;

    case 'grade5':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <p class="subtitle animate delay-1">${slide.content.subtitle}</p>
        <div style="display:flex;flex-direction:column;gap:0.6rem;max-width:700px;margin-top:1rem" class="animate delay-2">
          ${slide.content.domains.map((domain, idx) => `
            <div style="display:flex;align-items:flex-start;gap:0.75rem;background:rgba(124,58,237,0.15);border-left:4px solid var(--purple);border-radius:0 8px 8px 0;padding:0.75rem 1rem">
              <div style="width:28px;height:28px;background:var(--purple);border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.85rem;flex-shrink:0">${idx + 1}</div>
              <div>
                <div style="font-weight:700;color:var(--gold);font-size:0.95rem">${domain.name}</div>
                <div style="font-size:0.85rem;opacity:0.9">${domain.desc}</div>
              </div>
            </div>
          `).join('')}
        </div>
        <p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:1rem;max-width:600px">${slide.content.note}</p>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="decision-option ${isSelected ? 'selected' : ''} ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${answered ? 'disabled' : ''}"
                     onclick="answerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'Correct!' : 'Not quite'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
            ${answered && !(slide.content.options.find(o => o.letter === answered)?.correct) ? `<div style="margin-top:0.5rem;font-size:0.8rem;color:var(--orange);font-weight:600;">Partial credit: +${Math.floor(slide.content.xp * 0.2)} XP</div>` : ''}
          </div>
        </div>
      </div>`;
      break;

    default:
      html += '<div class="slide-content"><p>Unknown slide type</p></div>';
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  const prevBtn = container.querySelector('.nav-btn.prev');
  const nextBtn = container.querySelector('.nav-btn.next');
  if (prevBtn) prevBtn.disabled = currentSlide === 0;
  if (nextBtn) {
    const onLastSlide = currentSlide === MODULES[currentModule].slides.length - 1;
    nextBtn.disabled = onLastSlide && gameState.completedModules.includes(MODULES[currentModule].id);
  }
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;

  if (gameState.decisionsCompleted === 1) awardBadge('first_scenario');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 21) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
    addXP(Math.floor(xp * 0.2));
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 1) awardBadge('canopy_explorer');
    if (mod.id === 2) awardBadge('harvest_expert');
    if (mod.id === 3) awardBadge('quality_judge');
    if (mod.id === 4) awardBadge('overlap_detective');
    if (mod.id === 5) awardBadge('evidence_weaver');
    if (mod.id === 6) awardBadge('gap_finder');
    if (mod.id === 7) awardBadge('report_champion');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  } else if (gameState.completedModules.length === MODULES.length && !gameState.courseCompleted) {
    gameState.courseCompleted = true;
    saveGame();
    showCourseCompletion();
  }
}

function showCourseCompletion() {
  document.getElementById('completionXP').textContent = gameState.xp;
  document.getElementById('completionBadges').textContent = gameState.badges.length;
  document.getElementById('completionLevel').textContent = gameState.level;
  document.getElementById('completionOverlay').classList.add('show');
  triggerConfetti();
}

function closeCompletion() {
  document.getElementById('completionOverlay').classList.remove('show');
}

function reviewBadges() {
  document.getElementById('completionOverlay').classList.remove('show');
  // Scroll to badges panel and highlight it
  const badgesPanel = document.querySelector('.badges-panel');
  if (badgesPanel) {
    badgesPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    badgesPanel.style.transition = 'box-shadow 0.3s ease';
    badgesPanel.style.boxShadow = '0 0 20px 5px rgba(212,175,55,0.6)';
    setTimeout(() => {
      badgesPanel.style.boxShadow = '';
    }, 2000);
  }
}

function downloadCertificate() {
  const courseName = 'Umbrella Reviews: Synthesis of Syntheses';
  const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const level = LEVELS[gameState.level - 1] || LEVELS[0];
  const badgeCount = gameState.badges.length;
  const totalXP = gameState.xp;

  const certHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate of Completion - ${courseName}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Sans Pro', sans-serif; background: #f5f5f5; padding: 20px; }
    .certificate {
      max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #1E2761 0%, #141B3D 100%);
      border: 8px solid #D4AF37; border-radius: 12px; padding: 60px 50px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .cert-header { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 1rem; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 10px; }
    .cert-title { font-family: 'Cormorant Garamond', serif; color: #FAF8F5; font-size: 3rem; font-weight: 700; margin-bottom: 30px; }
    .cert-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 40px; }
    .cert-course { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 2rem; font-weight: 600; margin-bottom: 15px; padding: 20px; border-top: 1px solid rgba(212,175,55,0.3); border-bottom: 1px solid rgba(212,175,55,0.3); }
    .cert-stats { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
    .cert-stat { text-align: center; }
    .cert-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: #D4AF37; font-weight: 700; }
    .cert-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.1em; }
    .cert-date { color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-top: 40px; }
    .cert-footer { margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(212,175,55,0.2); }
    .cert-issuer { color: rgba(255,255,255,0.5); font-size: 0.85rem; }
    .cert-badge { display: inline-block; margin-top: 15px; padding: 8px 20px; background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.4); border-radius: 20px; color: #D4AF37; font-size: 0.9rem; }
    @media print {
      body { background: white; padding: 0; }
      .certificate { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="certificate">
    <div class="cert-header">Synthesis Course Collection</div>
    <div class="cert-title">Certificate of Completion</div>
    <div class="cert-subtitle">This certifies successful completion of</div>
    <div class="cert-course">${courseName}</div>
    <div class="cert-stats">
      <div class="cert-stat">
        <div class="cert-stat-value">${totalXP.toLocaleString()}</div>
        <div class="cert-stat-label">Total XP Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${badgeCount}</div>
        <div class="cert-stat-label">Badges Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${level.title}</div>
        <div class="cert-stat-label">Final Level</div>
      </div>
    </div>
    <div class="cert-date">Completed on ${completionDate}</div>
    <div class="cert-footer">
      <div class="cert-issuer">Synthesis Course Collection ‚Äî Evidence Synthesis & Meta-Analysis Training</div>
      <div class="cert-badge">Verified Completion</div>
    </div>
  </div>
  <script>window.onload = () => window.print();<\/script>
</body>
</html>`;

  const blob = new Blob([certHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Certificate-Umbrella-Reviews-Course.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeBadgeModal();
    document.getElementById('completionOverlay').classList.remove('show');
    closeLevelModal();
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }

  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option')) && (e.key === 'Enter' || e.key === ' ')) {
    e.preventDefault();
    e.target.click();
    return;
  }

  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('button, a, input, textarea, select');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }

  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    const mod = MODULES[currentModule];
    const onLastSlide = currentSlide === mod.slides.length - 1;
    if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
    nextSlide();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    prevSlide();
  }
});

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) {
    if (diff > 0) {
      const mod = MODULES[currentModule];
      const onLastSlide = currentSlide === mod.slides.length - 1;
      if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
      nextSlide();
    } else {
      prevSlide();
    }
  }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
