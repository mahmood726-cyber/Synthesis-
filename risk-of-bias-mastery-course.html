<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Risk of Bias Mastery: The Hidden Threats</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      min-width: 44px;
      min-height: 44px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active { background: rgba(249,115,22,0.2); border-color: var(--orange); }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: var(--green); }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--orange); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-left-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Confidence Colors */
    .cerqual-high { background: linear-gradient(135deg, rgba(34,197,94,0.2), rgba(30,39,97,0.2)); border-color: var(--green); }
    .cerqual-moderate { background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(30,39,97,0.2)); border-color: #3b82f6; }
    .cerqual-low { background: linear-gradient(135deg, rgba(245,158,11,0.2), rgba(30,39,97,0.2)); border-color: var(--orange); }
    .cerqual-very-low { background: linear-gradient(135deg, rgba(197,48,48,0.2), rgba(30,39,97,0.2)); border-color: var(--red); }

    .cerqual-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .cerqual-badge.high { background: var(--green); color: white; }
    .cerqual-badge.moderate { background: #3b82f6; color: white; }
    .cerqual-badge.low { background: var(--orange); color: white; }
    .cerqual-badge.very-low { background: var(--red); color: white; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .decision-option:hover { background: rgba(124,58,237,0.2); border-color: var(--purple); }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Quiz */
    .quiz-container { width: 100%; max-width: 650px; }
    .quiz-question {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      margin-bottom: 1.25rem;
      text-align: center;
    }
    .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      font-size: 0.9rem;
    }
    .quiz-option:hover { background: rgba(212,175,55,0.15); border-color: var(--gold); }
    .quiz-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .quiz-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .quiz-option.disabled { pointer-events: none; }
    .quiz-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .quiz-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }
    .quiz-feedback.show { display: block; }
    .quiz-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .quiz-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: 'o'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      .confetti { animation: none; display: none; }
      .xp-popup { transition: none; }
      .slide { transition: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; max-width: 220px; }
    .progress-dot {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      padding: 0;
      appearance: none;
      background: transparent;
    }
    .progress-dot::after {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-muted, #ccc);
      transition: all 0.2s ease;
    }
    .progress-dot.active::after,
    .progress-dot.completed::after {
      background: var(--gold);
      width: 14px;
      height: 14px;
    }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-left: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="course-container">
    <!-- Sidebar -->
    <nav class="sidebar" role="navigation" aria-label="Course navigation">
      <div class="sidebar-header">
        <a href="index.html" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='rgba(212,175,55,0.7)'">&larr; Course Library</a>
        <h1>Risk of Bias</h1>
        <p>Foundation Skill for Every Review</p>
      </div>

      <div class="stats-panel">
        <div class="level-display">
          <div class="level-badge" id="levelIcon">BS</div>
          <div class="level-info">
            <div class="level-title" id="levelTitle">Bias Sentinel</div>
            <div class="level-subtitle">Level <span id="levelNum">1</span></div>
          </div>
        </div>
        <div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
        <div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
        <div class="quick-stats">
          <div class="quick-stat">
            <div class="quick-stat-value" id="correctCount">0</div>
            <div class="quick-stat-label">Correct</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="decisionCount">0</div>
            <div class="quick-stat-label">Decisions</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="synthesisCount">0</div>
            <div class="quick-stat-label">Judgments</div>
          </div>
        </div>
      </div>

      <div class="course-progress">
        <div class="course-progress-label">
          <span>Course Progress</span>
          <span id="courseProgressPct">0%</span>
        </div>
        <div class="course-progress-bar">
          <div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <div class="module-list" id="moduleList"></div>

      <div class="badges-panel">
        <div class="badges-title">Achievements</div>
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content" id="main-content">
      <header class="content-header">
        <div class="breadcrumb">Risk of Bias / <span id="currentModule">Module 1</span></div>
        <div class="header-actions">
          <div class="streak-display" id="streakDisplay">
            <span class="streak-flame">ST</span>
            <span class="streak-count" id="streakCount">0</span>
            <span>day streak</span>
          </div>
          <button class="btn" onclick="resetProgress()">Reset</button>
        </div>
      </header>

      <div class="content-body">
        <div class="slides-container" id="slidesContainer"></div>
      </div>
    </main>
  </div>

  <!-- XP Popup -->
  <div class="xp-popup" id="xpPopup" role="status" aria-live="polite" aria-atomic="true">
    <span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>

  <!-- Badge Modal -->
  <div class="badge-modal" id="badgeModal" role="dialog" aria-modal="true" aria-labelledby="badgeModalTitle">
    <div class="badge-modal-content">
      <div class="badge-modal-icon" id="badgeModalIcon">AW</div>
      <div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
      <div class="badge-modal-desc" id="badgeModalDesc">You unlocked a new achievement</div>
      <button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- Combo Counter -->
  <div class="combo-display" id="comboDisplay" role="status" aria-live="polite">COMBO <span id="comboCount">0</span>x</div>

  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu" aria-expanded="false">MENU</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {},
  consecutiveCorrect: 0
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

// Migration from old storage key to versioned key
(function migrateStorage() {
  try {
    const oldData = localStorage.getItem('riskBiasMasteryGame');
    if (oldData && !localStorage.getItem('riskBiasMasteryGame_v1')) {
      localStorage.setItem('riskBiasMasteryGame_v1', oldData);
      localStorage.removeItem('riskBiasMasteryGame');
    }
  } catch (e) {}
})();

let gameState = safeGetStorage('riskBiasMasteryGame_v1', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Bias Sentinel", icon: "BS", xp: 0 },
  { level: 2, title: "Allocation Guard", icon: "AG", xp: 120 },
  { level: 3, title: "Blinding Watch", icon: "BW", xp: 300 },
  { level: 4, title: "Attrition Auditor", icon: "AA", xp: 520 },
  { level: 5, title: "Reporting Tracker", icon: "RT", xp: 780 },
  { level: 6, title: "Confounding Analyst", icon: "CA", xp: 1050 },
  { level: 7, title: "RoB Judge", icon: "RJ", xp: 1350 },
  { level: 8, title: "Master of Bias", icon: "MB", xp: 1700 }
];

const BADGES = [
  { id: "first_judgment", icon: "FJ", name: "First Judgment", desc: "Complete your first decision scenario" },
  { id: "allocation_guard", icon: "AG", name: "Allocation Guard", desc: "Complete The Allocation module" },
  { id: "blinding_watch", icon: "BW", name: "Blinding Watch", desc: "Complete The Blindfold module" },
  { id: "attrition_auditor", icon: "AA", name: "Attrition Auditor", desc: "Complete The Missing Trail module" },
  { id: "reporting_tracker", icon: "RT", name: "Reporting Tracker", desc: "Complete The Hidden Outcome module" },
  { id: "confounding_analyst", icon: "CA", name: "Confounding Analyst", desc: "Complete The Confounded Path module" },
  { id: "judgment_master", icon: "RJ", name: "Judgment Master", desc: "Complete The Judgment module" },
  { id: "perfect_5", icon: "5X", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "DM", name: "Decision Maker", desc: "Complete 14 decision trees" },
  { id: "finisher", icon: "FN", name: "Course Complete", desc: "Finish the entire course" },
  { id: "streak_3", icon: "S3", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "S7", name: "Weekly Warrior", desc: "Maintain a 7-day streak" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "The Opening", subtitle: "Why bias changes everything", xp: 140,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "Risk of Bias Mastery", subtitle: "See the hidden threats before they shape the answer" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Define risk of bias as a threat to causal truth",
          "Recognize when impressive results are built on weak foundations",
          "Use story, contrast, and refrain to sharpen judgment",
          "Practice decision trees on real cases"
        ],
        tip: "We use narrative techniques: contrast, refrains, and mirrored endings to train disciplined judgment."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE MIRROR", title: "Hormone therapy and the polished answer",
        text: "For years, observational studies suggested hormone therapy lowered heart disease risk. The story was simple and elegant. Then the Womens Health Initiative trial enrolled about 16000 women and was stopped early for harm. The direction flipped.",
        followup: "The lesson was not that trials are always right. The lesson was that bias can polish a mirror until it looks like truth. Risk of bias decides whether the mirror reflects reality or decoration."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Case Snapshot",
        stats: [
          { value: "16000", label: "WHI participants (approx)" },
          { value: "1", label: "Large RCT reversed direction" },
          { value: "2", label: "Evidence streams in conflict" },
          { value: "Early", label: "Trial stopped for harm" }
        ],
        caption: "Numbers simplified for teaching."
      }},
      { type: "concept", theme: "dark", content: {
        title: "What Risk of Bias Is",
        subtitle: "Not bad methods, but distorted truth",
        text: "Risk of bias is the chance a study design, conduct, or reporting pushes results away from the truth. It is about internal validity, not prestige or sample size.",
        highlight: "A large biased study can mislead more than a small honest one."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "Scenario: Conflicting Evidence", xp: 25,
        scenario: "You have 6 observational studies suggesting benefit and 1 large randomized trial showing harm.",
        question: "Which judgment best reflects risk of bias principles?",
        options: [
          { letter: "A", text: "Average all results to be fair", correct: false },
          { letter: "B", text: "Prioritize the randomized trial for causal claims", correct: true },
          { letter: "C", text: "Exclude the trial because it conflicts", correct: false },
          { letter: "D", text: "Assume observational studies are more realistic", correct: false }
        ],
        feedback: {
          correct: "Correct. When causal inference is the goal, lower risk of bias designs carry more weight. Conflicts should be explained, not averaged away.",
          incorrect: "Risk of bias is about causal credibility. When designs differ, you must weigh evidence by bias risk, not just volume."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BS", title: "Scenario: The Polished Mirror", xp: 25,
        scenario: "A very large dataset shows a strong association, but the exposure is self-selected and outcomes are self-reported.",
        question: "What is the most defensible response?",
        options: [
          { letter: "A", text: "High confidence because sample size is large", correct: false },
          { letter: "B", text: "Flag serious risk of bias from confounding and measurement", correct: true },
          { letter: "C", text: "Ignore bias if the effect is large", correct: false },
          { letter: "D", text: "Assume randomization is unnecessary", correct: false }
        ],
        feedback: {
          correct: "Correct. Large size does not fix confounding or measurement bias. Risk of bias must be assessed before trusting effect size.",
          incorrect: "Sample size can reduce random error, but it cannot repair systematic bias."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "The mirror can shine and still lie." }}
    ]
  },
  {
    id: 2, title: "The Allocation", subtitle: "Selection bias and concealment", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Allocation", subtitle: "Who enters the path and who is held back" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Separate random sequence from allocation concealment",
          "Detect predictable assignment and recruitment bias",
          "Use baseline balance as a warning sign, not proof",
          "Make a clear low or high risk judgment"
        ],
        tip: "CAST trial's random allocation ensured groups were comparable—allowing the shocking conclusion that the drugs killed patients."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE GATE", title: "When the next assignment is known",
        text: "Early trials often used alternation or date of birth. Clinicians could guess who would get the new treatment and who would not. Subtle choices followed.",
        followup: "Random sequence without concealment is a gate left open. The right method is both: truly random and truly hidden."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Selection Bias Checklist",
        subtitle: "Two questions that must both be yes",
        text: "1) Was the sequence random? <br><br>2) Was allocation concealed from recruiters?",
        highlight: "If either answer is no, the gate is compromised."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "AG", title: "Scenario: Predictable Assignment", xp: 25,
        scenario: "Participants are assigned by odd or even medical record number.",
        question: "What is the risk of bias for randomization?",
        options: [
          { letter: "A", text: "Low risk because it is simple", correct: false },
          { letter: "B", text: "High risk because assignment is predictable", correct: true },
          { letter: "C", text: "Some concerns only", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Predictable assignment allows manipulation, even unintentionally. This is high risk for selection bias.",
          incorrect: "Simplicity is not randomness. If clinicians can predict allocation, selection bias is likely."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "AG", title: "Scenario: The Envelope Test", xp: 25,
        scenario: "The trial uses sealed envelopes, but they are not opaque and are opened before consent.",
        question: "How should allocation concealment be judged?",
        options: [
          { letter: "A", text: "Low risk because envelopes were used", correct: false },
          { letter: "B", text: "High risk because concealment was broken", correct: true },
          { letter: "C", text: "Some concerns only", correct: false },
          { letter: "D", text: "Unclear", correct: false }
        ],
        feedback: {
          correct: "Correct. If recruiters can see the next assignment before consent, concealment fails and selection bias is likely.",
          incorrect: "Envelopes are only as good as their opacity and timing. Predictability means high risk."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "A fair gate is hidden from the chooser." }}
    ]
  },
  {
    id: 3, title: "The Blindfold", subtitle: "Performance and detection bias", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Blindfold", subtitle: "When knowing changes what is seen" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Distinguish blinding of participants, providers, and assessors",
          "Recognize when subjective outcomes inflate effects",
          "Use objective outcomes to reduce bias when blinding fails",
          "Assign risk of bias for measurement" 
        ],
        tip: "In the DECREASE trials, lack of blinding allowed investigators to unconsciously favor the treatment—contributing to data fraud."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE WITNESS", title: "Pain trials and the open label lift",
        text: "Open label pain trials often report larger effects than blinded trials. When expectations are visible, outcomes shift, especially when measures are subjective.",
        followup: "This is why sham controls and blinded assessment matter. A blindfold does not make a study perfect, but it protects the outcome from hope and disappointment."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Blinding Map",
        subtitle: "Who can be influenced?",
        text: "Participants, providers, and outcome assessors can each introduce bias. The more subjective the outcome, the more blinding matters.",
        highlight: "No blinding plus subjective outcomes is a high risk signal."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BW", title: "Scenario: Subjective Outcome", xp: 25,
        scenario: "Participants are unblinded and the primary outcome is self reported pain score.",
        question: "How should detection bias be judged?",
        options: [
          { letter: "A", text: "Low risk because pain is real", correct: false },
          { letter: "B", text: "High risk because outcome is subjective and unblinded", correct: true },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Not applicable", correct: false }
        ],
        feedback: {
          correct: "Correct. Subjective outcomes without blinding are at high risk of detection bias.",
          incorrect: "The outcome may be real, but expectations can still inflate scores."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "BW", title: "Scenario: Objective Outcome", xp: 25,
        scenario: "Participants are unblinded, but the outcome is all cause mortality verified by registry.",
        question: "What is the most defensible judgment?",
        options: [
          { letter: "A", text: "Low risk for detection bias", correct: true },
          { letter: "B", text: "High risk because no blinding", correct: false },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Objective outcomes are less susceptible to detection bias even without blinding.",
          incorrect: "Blinding matters, but objective outcomes can still be low risk for measurement bias."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "What is seen depends on who can see it." }}
    ]
  },
  {
    id: 4, title: "The Missing Trail", subtitle: "Attrition and incomplete data", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Missing Trail", subtitle: "When the path loses travelers" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Identify when missing data can change conclusions",
          "Use intention to treat as protection against bias",
          "Detect differential dropout between groups",
          "Judge risk when assumptions are unsupported"
        ],
        tip: "In the rosiglitazone trials, patients who dropped out were sicker—making the drug appear safer than it was."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE GAPS", title: "Weight loss programs and the quiet exits",
        text: "A trial reported large weight loss among completers, but 35 percent dropped out of the intervention group. The published result looked strong.",
        followup: "When missing data is uneven, the ending may be written by who stayed, not by what worked."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Attrition Signals",
        subtitle: "Who left and why",
        text: "Look for: overall dropout, imbalance between groups, and reasons linked to outcomes.",
        highlight: "High or unequal dropout without sensitivity analysis is a bias red flag."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "AA", title: "Scenario: Unequal Dropout", xp: 25,
        scenario: "Dropout is 10 percent in control and 35 percent in intervention, with no analysis of missing outcomes.",
        question: "How should attrition bias be rated?",
        options: [
          { letter: "A", text: "Low risk because some data remain", correct: false },
          { letter: "B", text: "High risk because missingness is imbalanced", correct: true },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Large, imbalanced dropout without justification or sensitivity analysis is high risk.",
          incorrect: "When missingness differs between groups, the result can be distorted."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "AA", title: "Scenario: Intention to Treat", xp: 25,
        scenario: "A trial reports only per protocol analysis, excluding 20 percent of randomized participants.",
        question: "What is the best judgment?",
        options: [
          { letter: "A", text: "Low risk if results are significant", correct: false },
          { letter: "B", text: "Some concerns or high risk depending on exclusions", correct: true },
          { letter: "C", text: "No risk because exclusions are allowed", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Excluding randomized participants can bias results. If exclusions are substantial or related to outcomes, risk is high.",
          incorrect: "Per protocol can be valid for some questions, but it raises bias risk for effectiveness estimates."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Those who left still shape the result." }}
    ]
  },
  {
    id: 5, title: "The Hidden Outcome", subtitle: "Selective reporting", xp: 160,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "The Hidden Outcome", subtitle: "When the record is edited" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Compare published outcomes to the protocol",
          "Detect outcome switching and selective reporting",
          "Judge risk when only favorable outcomes appear",
          "Understand why registries matter"
        ],
        tip: "Study 329 hid suicide attempts in adolescents. What was selectively reported changed global prescribing."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE EDIT", title: "Study 329 and the rewritten ending",
        text: "Study 329 tested paroxetine in adolescents. The published paper reported benefit, but later reanalysis showed primary outcomes were negative and harms were underreported.",
        followup: "This was not a small detail. It was a different story. Selective reporting can make a trial appear to answer a question it did not answer."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Reporting Bias Check",
        subtitle: "Compare plan and publication",
        text: "Ask: Were all prespecified outcomes reported? Were time points changed? Were new outcomes introduced without justification?",
        highlight: "When the plan and the paper disagree, risk rises."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RT", title: "Scenario: Outcome Switching", xp: 25,
        scenario: "A trial registry lists depression score at 12 weeks as primary, but the paper reports 6 week anxiety score as primary.",
        question: "How should reporting bias be rated?",
        options: [
          { letter: "A", text: "Low risk because a positive outcome was found", correct: false },
          { letter: "B", text: "High risk due to outcome switching", correct: true },
          { letter: "C", text: "Some concerns only", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Switching primary outcomes after seeing data is a high risk signal for selective reporting.",
          incorrect: "Outcome switching breaks the contract between protocol and publication."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RT", title: "Scenario: Missing Harms", xp: 25,
        scenario: "The protocol lists adverse events, but the paper reports none and provides no table.",
        question: "What is the best judgment?",
        options: [
          { letter: "A", text: "Low risk if efficacy is strong", correct: false },
          { letter: "B", text: "High risk because harms are selectively omitted", correct: true },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Omitted harms are selective reporting. Risk of bias increases when prespecified harms are missing.",
          incorrect: "Selective omission of harms can flip the balance of benefits and risks."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "What is not reported still speaks." }}
    ]
  },
  {
    id: 6, title: "The Confounded Path", subtitle: "Bias in observational evidence", xp: 170,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Confounded Path", subtitle: "When causes are mixed with choices" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Identify confounding and indication bias",
          "Recognize time related bias and immortal time",
          "Judge observational evidence with clear standards",
          "Decide when results are credible enough to pool"
        ],
        tip: "The WHI trial appeared straightforward until post-hoc analyses revealed the timing hypothesis—hidden complexity."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE TURN", title: "Beta carotene and lung cancer",
        text: "Observational studies suggested beta carotene protected against lung cancer. Large trials in smokers later showed increased lung cancer risk and were stopped early.",
        followup: "The confounders were strong: people who choose supplements differ in many ways from those who do not. When choices drive exposure, bias follows."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Confounding Signals",
        subtitle: "When cause and choice mingle",
        text: "Look for differences in baseline risk, care access, and health behavior. Check how confounders were measured and adjusted.",
        highlight: "Unmeasured confounding can reverse the apparent effect."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "CA", title: "Scenario: Indication Bias", xp: 25,
        scenario: "Sicker patients are more likely to receive the intervention in routine care studies.",
        question: "How should risk of bias be judged?",
        options: [
          { letter: "A", text: "Low risk if sample size is large", correct: false },
          { letter: "B", text: "High risk unless confounding is convincingly addressed", correct: true },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Not applicable", correct: false }
        ],
        feedback: {
          correct: "Correct. Indication bias can overwhelm the signal. Without strong adjustment, risk is high.",
          incorrect: "Large size does not fix confounding. The key is whether confounders are measured and controlled."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "CA", title: "Scenario: Immortal Time", xp: 25,
        scenario: "Exposure is defined after a period during which patients must survive to be classified as treated.",
        question: "What does this imply?",
        options: [
          { letter: "A", text: "Low risk because it is common", correct: false },
          { letter: "B", text: "High risk due to immortal time bias", correct: true },
          { letter: "C", text: "Some concerns", correct: false },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. Immortal time creates a false survival advantage and is a serious bias risk.",
          incorrect: "Timing of exposure is crucial. Misclassifying person time can create a misleading benefit."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "When choice leads the path, causation fades." }}
    ]
  },
  {
    id: 7, title: "The Judgment", subtitle: "Putting it all together", xp: 190,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "The Judgment", subtitle: "Summarize risk without fear or favor" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply domain judgments to an overall risk of bias",
          "Justify decisions with transparent reasons",
          "Use sensitivity analysis to test conclusions",
          "Leave with a repeatable decision script"
        ],
        tip: "Ring structure closes the lesson where it began: the mirror and the truth."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "THE RETURN", title: "Two reviews, one honest",
        text: "Two teams reviewed the same intervention. One rated all trials low risk because the results looked clean. The other documented allocation leaks, missing data, and outcome switching. Their conclusion was cautious and changed the guideline.",
        followup: "The goal is not pessimism. It is precision. The most useful review is the one that names uncertainty clearly."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Overall Judgment",
        subtitle: "A simple decision script",
        text: "If any domain is high risk and directly affects the primary outcome, overall risk is high. If concerns are moderate and unlikely to change direction, overall risk may be some concerns.",
        highlight: "Judgment must be reasoned, not averaged."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RJ", title: "Scenario: Overall Risk", xp: 35,
        scenario: "A trial has low risk in randomization, high risk in missing data, and the primary outcome is sensitive to missingness.",
        question: "What is the overall risk of bias?",
        options: [
          { letter: "A", text: "Low risk", correct: false },
          { letter: "B", text: "Some concerns", correct: false },
          { letter: "C", text: "High risk", correct: true },
          { letter: "D", text: "Cannot judge", correct: false }
        ],
        feedback: {
          correct: "Correct. A high risk domain that directly affects the primary outcome drives overall judgment.",
          incorrect: "Overall risk is not an average. It is a judgment about whether bias can change the answer."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "RJ", title: "Scenario: Sensitivity Check", xp: 35,
        scenario: "Your meta analysis includes 3 low risk trials and 4 high risk trials. The pooled effect disappears when high risk trials are removed.",
        question: "What is the most defensible conclusion?",
        options: [
          { letter: "A", text: "Report the full pooled effect as final", correct: false },
          { letter: "B", text: "Report primary conclusion based on low risk trials", correct: true },
          { letter: "C", text: "Exclude low risk trials to keep sample size", correct: false },
          { letter: "D", text: "Ignore the sensitivity analysis", correct: false }
        ],
        feedback: {
          correct: "Correct. Sensitivity analyses test robustness. If the effect depends on high risk trials, conclusions must reflect that uncertainty.",
          incorrect: "If results change when high risk trials are removed, the safer conclusion relies on the more credible evidence."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Name the bias, and the answer becomes clear." }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = gameState.consecutiveCorrect || 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('riskBiasMasteryGame_v1', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [] };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  const modal = document.getElementById('badgeModal');
  modal.classList.add('show');
  if (celebrate) triggerConfetti();

  // Focus trap
  const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
  if (focusableElements.length > 0) {
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    firstFocusable.focus();

    // Remove any existing focus trap listener
    if (modal._focusTrapHandler) {
      modal.removeEventListener('keydown', modal._focusTrapHandler);
    }

    modal._focusTrapHandler = function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
      if (e.key === 'Escape') {
        closeBadgeModal();
      }
    };
    modal.addEventListener('keydown', modal._focusTrapHandler);
  }
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  const modal = document.getElementById('badgeModal');
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    modal._focusTrapHandler = null;
  }
  modal.classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle, .hamburger, .mobile-menu-btn'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.synthesisCount || 0;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="badge-item ${earned ? 'earned' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${locked ? 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">T ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="Previous slide">&lt;</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn" onclick="nextSlide()" aria-label="Next slide">&gt;</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">Left / Right arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} ${slide.content.warning ? 'warning' : ''} ${slide.content.teal ? 'teal' : ''} animate" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="decision-option ${isSelected ? 'selected' : ''} ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${answered ? 'disabled' : ''}"
                     onclick="answerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'Correct!' : 'Not quite'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
          </div>
        </div>
      </div>`;
      break;

    case 'quiz':
      const qid = `quiz_${moduleIndex}_${index}`;
      const qAnswered = gameState.answeredQuestions[qid];
      html += `<div class="content">
        <div class="quiz-container animate">
          <div class="quiz-question">${slide.content.question}</div>
          <div class="quiz-options">
            ${slide.content.options.map((opt, oi) => {
              const isSelected = qAnswered === oi;
              const showCorrect = qAnswered !== undefined && opt.correct;
              const showIncorrect = qAnswered !== undefined && isSelected && !opt.correct;
              return `
                <div class="quiz-option ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${qAnswered !== undefined ? 'disabled' : ''}"
                     onclick="answerQuiz('${qid}', ${oi}, ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${qAnswered !== undefined ? 'true' : 'false'}">
                  ${opt.text}
                </div>
              `;
            }).join('')}
          </div>
          <div class="quiz-feedback ${qAnswered !== undefined ? 'show' : ''} ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}
          </div>
        </div>
      </div>`;
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  container.querySelector('.nav-btn').disabled = currentSlide === 0;
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;
  gameState.synthesisCount = (gameState.synthesisCount || 0) + 1;

  if (gameState.decisionsCompleted === 1) awardBadge('first_judgment');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 14) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

function answerQuiz(qid, choice, correct, xp) {
  if (gameState.answeredQuestions[qid] !== undefined) return;
  gameState.answeredQuestions[qid] = choice;

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
  } else {
    consecutiveCorrect = 0;
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 2) awardBadge('allocation_guard');
    if (mod.id === 3) awardBadge('blinding_watch');
    if (mod.id === 4) awardBadge('attrition_auditor');
    if (mod.id === 5) awardBadge('reporting_tracker');
    if (mod.id === 6) awardBadge('confounding_analyst');
    if (mod.id === 7) awardBadge('judgment_master');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  }
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeBadgeModal();
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }
  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('button, a, input, textarea, select');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }
  if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
  else if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
});

// Second keydown handler removed (first handler covers role="button" elements)

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) { diff > 0 ? nextSlide() : prevSlide(); }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
