<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>META-SPRINT: 40 Days to Trustworthy Evidence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=Source+Sans+Pro:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* ====== SIDEBAR ====== */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    /* Gamification Stats Panel */
    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }

    /* Badges Panel */
    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      min-width: 44px;
      min-height: 44px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: help;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }

    /* ====== MAIN CONTENT ====== */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active { background: rgba(249,115,22,0.2); border-color: var(--orange); }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* ====== SLIDES ====== */
    .slides-container { flex: 1; position: relative; overflow: hidden; touch-action: pan-y pinch-zoom; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card.red-border { border: 2px solid var(--red); }
    .card.green-border { border: 2px solid var(--green); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: var(--green); }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--orange); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Epic Story Box */
    .story-box.epic {
      background: linear-gradient(135deg, rgba(20,27,61,0.95), rgba(0,0,0,0.9));
      border-left: 4px solid var(--gold);
      border-top: 1px solid rgba(212,175,55,0.3);
      border-right: 1px solid rgba(212,175,55,0.2);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      padding: 1.5rem;
      position: relative;
    }
    .story-box.epic::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gold), transparent);
    }
    .story-box.epic .story-label { color: var(--gold); font-size: 0.65rem; letter-spacing: 0.15em; }
    .story-box.epic .story-text { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 1.05rem; line-height: 1.7; }
    .story-box.epic .story-moral {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
      font-style: italic;
      color: var(--gold);
      font-size: 0.95rem;
    }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-box.light { background: var(--light-cream); color: var(--navy); border: 1px solid var(--gold); }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-item.phase-a { border-left-color: var(--purple); }
    .timeline-item.phase-b { border-left-color: #3b82f6; }
    .timeline-item.phase-c { border-left-color: var(--orange); }
    .timeline-item.phase-d { border-left-color: var(--green); }
    .timeline-item.phase-e { border-left-color: var(--red); }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 22px;
      height: 22px;
      background: var(--gold);
      color: var(--navy);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.75rem;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; line-height: 1.4; }

    /* Lessons */
    .lesson-item { display: flex; align-items: flex-start; gap: 0.75rem; margin: 0.5rem 0; max-width: 700px; }
    .lesson-number {
      background: var(--gold);
      color: var(--navy);
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.85rem;
      flex-shrink: 0;
    }
    .lesson-content h4 { font-size: 1rem; font-weight: 700; margin-bottom: 0.2rem; }
    .lesson-content p { font-size: 0.85rem; opacity: 0.8; }

    /* ====== DECISION TREE ====== */
    .decision-tree {
      width: 100%;
      max-width: 700px;
      background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(30,39,97,0.25));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 0.75rem 0;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .decision-option:hover { background: rgba(124,58,237,0.2); border-color: var(--purple); }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* ====== PREDICTION ====== */
    .prediction-panel {
      width: 100%;
      max-width: 700px;
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(30,39,97,0.25));
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 0.75rem 0;
      text-align: center;
    }
    .prediction-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .prediction-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.3rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .prediction-subtitle { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .prediction-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .predict-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border: 2px solid;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: rgba(0,0,0,0.2);
    }
    .predict-btn.benefit { border-color: var(--green); color: var(--green); }
    .predict-btn.benefit:hover { background: rgba(34,197,94,0.2); }
    .predict-btn.neutral { border-color: var(--light-text); color: var(--light-text); }
    .predict-btn.neutral:hover { background: rgba(148,163,184,0.2); }
    .predict-btn.harm { border-color: var(--red); color: var(--red); }
    .predict-btn.harm:hover { background: rgba(239,68,68,0.2); }
    .predict-btn.selected { transform: scale(1.02); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
    .prediction-result {
      margin-top: 1rem;
      padding: 0.75rem;
      border-radius: 8px;
      display: none;
    }
    .prediction-result.show { display: block; }
    .prediction-result.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .prediction-result.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }

    /* ====== QUIZ ====== */
    .quiz-container { width: 100%; max-width: 650px; }
    .quiz-question {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      margin-bottom: 1.25rem;
      text-align: center;
    }
    .quiz-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
      font-size: 0.9rem;
    }
    .quiz-option:hover { background: rgba(212,175,55,0.15); border-color: var(--gold); }
    .quiz-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .quiz-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .quiz-option.disabled { pointer-events: none; }
    .quiz-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
      font-size: 0.9rem;
    }
    .quiz-feedback.show { display: block; }
    .quiz-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .quiz-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }

    /* Crisis box */
    .crisis-box {
      background: linear-gradient(135deg, rgba(124,58,237,0.2), rgba(30,39,97,0.3));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
    }
    .crisis-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .crisis-number {
      width: 36px;
      height: 36px;
      background: var(--purple);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.1rem;
    }
    .crisis-title { font-family: 'Cormorant Garamond', serif; font-size: 1.15rem; font-weight: 700; }
    .crisis-day { font-size: 0.75rem; color: var(--purple); }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Earned Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti - respects reduced motion */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .confetti { display: none; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }
    .combo-display.big { transform: scale(1.2); }

    /* Key Takeaway Card */
    .takeaway-card {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2));
      border: 1px solid var(--green);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .takeaway-card .takeaway-icon {
      display: inline-block;
      background: var(--green);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      text-align: center;
      line-height: 24px;
      font-size: 0.8rem;
      margin-right: 0.5rem;
    }
    .takeaway-card .takeaway-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--green);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.35rem;
    }
    .takeaway-card .takeaway-text {
      font-size: 0.9rem;
      line-height: 1.5;
      font-style: italic;
    }

    /* Module Time Estimate */
    .module-time {
      font-size: 0.55rem;
      color: rgba(255,255,255,0.4);
      display: flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.15rem;
    }

    /* Enhanced Focus States for Keyboard Navigation */
    .decision-option:focus-visible,
    .quiz-option:focus-visible,
    .predict-btn:focus-visible {
      outline: 3px solid var(--gold);
      outline-offset: 2px;
    }
    .nav-btn:focus-visible,
    .btn:focus-visible {
      outline: 3px solid var(--gold);
      outline-offset: 2px;
    }

    /* Progress within module */
    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    /* Citation Link Style */
    .citation-link {
      font-size: 0.7rem;
      color: var(--gold);
      opacity: 0.7;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      margin-top: 0.5rem;
    }
    .citation-link:hover { opacity: 1; text-decoration: underline; }

    /* Mobile Sidebar Toggle */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 3px; flex-wrap: wrap; max-width: 220px; }
    .progress-dot {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
    }
    .progress-dot::after {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--text-muted, rgba(255,255,255,0.25));
      transition: all 0.2s ease;
    }
    .progress-dot.active::after,
    .progress-dot.completed::after {
      background: var(--gold);
      width: 14px;
      height: 14px;
    }

    /* Course Progress Bar */
    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list {
      list-style: none;
      padding: 0;
    }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before {
      content: '‚óã';
      color: #3b82f6;
      font-weight: bold;
    }
    .objectives-list li.completed::before {
      content: '‚óè';
      color: var(--green);
    }

    /* Module Summary */
    .summary-box {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.25));
      border: 2px solid var(--green);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      text-align: center;
    }
    .summary-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .summary-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.4rem;
      color: var(--green);
      margin-bottom: 0.5rem;
    }
    .summary-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin: 1rem 0;
    }
    .summary-stat {
      text-align: center;
    }
    .summary-stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }
    .summary-stat-label {
      font-size: 0.75rem;
      opacity: 0.7;
    }
    .summary-next {
      margin-top: 1rem;
      padding: 0.75rem 1.5rem;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .summary-next:hover { transform: scale(1.05); }

    /* Badge Progress Tooltip */
    .badge-progress {
      font-size: 0.55rem;
      color: rgba(255,255,255,0.4);
      position: absolute;
      bottom: -2px;
      right: -2px;
      background: var(--deep-navy);
      padding: 0 3px;
      border-radius: 3px;
    }
    .badge-item { position: relative; }

    /* Glossary Panel */
    .glossary-toggle {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 50px;
      height: 50px;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 50%;
      font-size: 1.3rem;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      z-index: 500;
      transition: all 0.2s;
    }
    .glossary-toggle:hover { transform: scale(1.1); }
    .glossary-panel {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 350px;
      max-height: 70vh;
      background: var(--deep-navy);
      border: 1px solid var(--gold);
      border-radius: 12px 0 0 0;
      transform: translateY(100%);
      transition: transform 0.3s ease;
      z-index: 501;
      display: flex;
      flex-direction: column;
    }
    .glossary-panel.open { transform: translateY(0); }
    .glossary-header {
      padding: 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .glossary-header h3 {
      font-family: 'Cormorant Garamond', serif;
      color: var(--gold);
      margin: 0;
    }
    .glossary-close {
      background: none;
      border: none;
      color: var(--cream);
      font-size: 1.2rem;
      cursor: pointer;
    }
    .glossary-content {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    .glossary-item {
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .glossary-term {
      font-weight: 700;
      color: var(--gold);
      font-size: 0.9rem;
    }
    .glossary-def {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.8);
      margin-top: 0.25rem;
    }

    /* Streak Warning */
    .streak-warning {
      background: rgba(239,68,68,0.2);
      border: 1px solid var(--red);
      color: var(--red);
      animation: pulse-warning 2s infinite;
    }
    @keyframes pulse-warning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Perfect Module Bonus */
    .perfect-bonus {
      background: linear-gradient(135deg, var(--gold), #fbbf24);
      color: var(--navy);
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      animation: shine 2s infinite;
    }
    @keyframes shine {
      0%, 100% { box-shadow: 0 0 10px rgba(212,175,55,0.5); }
      50% { box-shadow: 0 0 20px rgba(212,175,55,0.8); }
    }

    /* Focus States for Accessibility */
    .decision-option:focus,
    .quiz-option:focus,
    .predict-btn:focus,
    .btn:focus,
    .nav-btn:focus {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
    }

    /* Print Stylesheet */
    @media print {
      .sidebar, .slide-nav, .stats-panel, .badges-panel, .glossary-toggle, .glossary-panel, .header-actions { display: none !important; }
      .main-content { width: 100%; }
      .slide { position: relative !important; page-break-inside: avoid; padding: 1rem; }
      .slide.active, .slide { opacity: 1 !important; visibility: visible !important; display: block !important; }
      .module-slides { display: block !important; }
    }

    /* Responsive */
    @media (max-width: 900px) {
      .sidebar { width: 70px; }
      .sidebar-header h1, .sidebar-header p, .module-title, .module-subtitle, .module-xp,
      .stats-panel, .badges-panel, .course-progress { display: none; }
      .module-item { padding: 0.6rem; justify-content: center; }
      .glossary-panel { width: 100%; border-radius: 12px 12px 0 0; }
      .progress-dot { width: 44px; height: 44px; }
      .progress-dot::after { width: 8px; height: 8px; }
      .progress-dot.active::after,
      .progress-dot.completed::after { width: 10px; height: 10px; }
    }

    /* Touch feedback */
    @media (hover: none) {
      .decision-option:active { background: rgba(124,58,237,0.3); }
      .quiz-option:active { background: rgba(212,175,55,0.2); }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .confetti { display: none; }
    }

    /* Skip to content link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 0.5rem 1rem;
      z-index: 10000;
      font-weight: 600;
      text-decoration: none;
      border-radius: 0 0 8px 0;
    }
    .skip-link:focus {
      top: 0;
    }

    /* Course completion modal */
    .completion-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
    .completion-modal.show { display: flex; }
    .completion-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 3px solid var(--gold);
      border-radius: 20px;
      padding: 2.5rem;
      text-align: center;
      max-width: 450px;
      animation: completion-pop 0.5s ease;
    }
    @keyframes completion-pop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); opacity: 1; }
    }
    .completion-trophy { font-size: 5rem; margin-bottom: 1rem; }
    .completion-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .completion-subtitle { font-size: 1rem; opacity: 0.8; margin-bottom: 1.5rem; }
    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .completion-stat { text-align: center; }
    .completion-stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--gold);
    }
    .completion-stat-label { font-size: 0.75rem; opacity: 0.7; }
    .completion-close {
      padding: 0.75rem 2rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
    }

    /* Review mistakes button */
    .review-mistakes-btn {
      position: fixed;
      bottom: 1.5rem;
      left: 1.5rem;
      padding: 0.6rem 1rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid var(--red);
      color: var(--red);
      border-radius: 8px;
      font-size: 0.8rem;
      cursor: pointer;
      z-index: 500;
      display: none;
    }
    .review-mistakes-btn.show { display: block; }
    .review-mistakes-btn:hover { background: rgba(239,68,68,0.3); }

    /* Review panel */
    .review-panel {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      z-index: 1003;
      overflow-y: auto;
      padding: 2rem;
    }
    .review-panel.show { display: block; }
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    .review-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--red);
    }
    .review-close {
      background: none;
      border: 1px solid var(--cream);
      color: var(--cream);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .review-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
    }
    .review-module { font-size: 0.75rem; color: var(--gold); margin-bottom: 0.5rem; }
    .review-question { font-weight: 600; margin-bottom: 0.75rem; }
    .review-your-answer { color: var(--red); font-size: 0.9rem; margin-bottom: 0.5rem; }
    .review-correct-answer { color: var(--green); font-size: 0.9rem; margin-bottom: 0.75rem; }
    .review-explanation { font-size: 0.85rem; opacity: 0.8; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 6px; }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to content</a>
  <div class="course-container">
    <!-- SIDEBAR -->
    <nav class="sidebar" aria-label="Course navigation">
      <div class="sidebar-header">
        <a href="index.html" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;" onmouseover="this.style.color='#D4AF37'" onmouseout="this.style.color='rgba(212,175,55,0.7)'">&larr; Course Library</a>
        <h1>META-SPRINT</h1>
        <p>40 Days to Trustworthy Evidence</p>
      </div>

      <!-- Course Progress -->
      <div class="course-progress">
        <div class="course-progress-label">
          <span>Course Progress</span>
          <span id="courseProgressPct">0%</span>
        </div>
        <div class="course-progress-bar">
          <div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Gamification Stats -->
      <div class="stats-panel">
        <div class="level-display">
          <div class="level-badge" id="levelIcon" role="img" aria-label="Level icon">üìä</div>
          <div class="level-info">
            <div class="level-title" id="levelTitle">Novice Analyst</div>
            <div class="level-subtitle">Level <span id="levelNum">1</span></div>
          </div>
        </div>
        <div class="xp-bar" role="progressbar" aria-label="XP progress">
          <div class="xp-fill" id="xpFill" style="width: 0%"></div>
        </div>
        <div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
        <div class="quick-stats">
          <div class="quick-stat">
            <div class="quick-stat-value" id="correctCount">0</div>
            <div class="quick-stat-label">Correct</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="decisionCount">0</div>
            <div class="quick-stat-label">Decisions</div>
          </div>
          <div class="quick-stat">
            <div class="quick-stat-value" id="predictCount">0</div>
            <div class="quick-stat-label">Predictions</div>
          </div>
        </div>
      </div>

      <div class="module-list" id="moduleList" role="list"></div>

      <!-- Badges -->
      <div class="badges-panel">
        <div class="badges-title">Achievements</div>
        <div class="badges-grid" id="badgesGrid"></div>
      </div>
    </nav>

    <!-- MAIN -->
    <div class="main-content">
      <div class="content-header">
        <div class="breadcrumb">META-SPRINT / <span id="currentModule">Introduction</span></div>
        <div class="header-actions">
          <div class="streak-display" id="streakDisplay">
            <span class="streak-flame">üî•</span>
            <span class="streak-count" id="streakCount">0</span>
            <span style="font-size:0.7rem;opacity:0.7">streak</span>
          </div>
          <button class="btn" onclick="resetProgress()">Reset</button>
          <button class="btn primary" onclick="nextSlide()">Continue ‚Üí</button>
        </div>
      </div>
      <div class="content-body">
        <div class="slides-container" id="main-content"></div>
      </div>
    </div>
  </div>

  <!-- XP Popup -->
  <div class="xp-popup" id="xpPopup">
    <span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>

  <!-- Badge Modal -->
  <div class="badge-modal" id="badgeModal" role="dialog" aria-modal="true" aria-labelledby="badgeModalTitle">
    <div class="badge-modal-content">
      <div class="badge-modal-icon" id="badgeModalIcon">üèÜ</div>
      <div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
      <div class="badge-modal-desc" id="badgeModalDesc">You unlocked a new achievement</div>
      <button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div class="confetti-container" id="confettiContainer"></div>

  <!-- Combo Counter -->
  <div class="combo-display" id="comboDisplay">üî• <span id="comboCount">0</span>x Combo!</div>

  <!-- Mobile Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle menu" aria-expanded="false">‚ò∞</button>
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Glossary Toggle -->
  <button class="glossary-toggle" onclick="toggleGlossary()" aria-label="Open glossary" title="Quick Reference">üìñ</button>

  <!-- Glossary Panel -->
  <div class="glossary-panel" id="glossaryPanel" role="dialog" aria-label="Glossary">
    <div class="glossary-header">
      <h3>Quick Reference</h3>
      <button class="glossary-close" onclick="toggleGlossary()" aria-label="Close glossary">√ó</button>
    </div>
    <div class="glossary-content">
      <div class="glossary-item">
        <div class="glossary-term">DoD (Definition of Done)</div>
        <div class="glossary-def">Binary gate checklist. All items must pass before proceeding to next phase.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">PICOS</div>
        <div class="glossary-def">Population, Intervention, Comparator, Outcomes, Study design - framework for research questions.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">Provenance</div>
        <div class="glossary-def">The audit trail showing exactly where a number came from (e.g., "Table 2, p.1234").</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">Red-Team</div>
        <div class="glossary-def">Daily adversarial checking by 2 rotating members to catch errors in extraction.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">CondGO</div>
        <div class="glossary-def">Emergency protocol: 72 hours to fix a failed DoD gate or terminate with documented reasons.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">Surrogate Outcome</div>
        <div class="glossary-def">A measurable marker (e.g., cholesterol) used as proxy for patient-important outcomes (e.g., death).</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">FREEZE (Day 34)</div>
        <div class="glossary-def">Scope lock - no new studies can be added after this point.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">I¬≤ (I-squared)</div>
        <div class="glossary-def">Heterogeneity statistic. Low <30%, Moderate 30-60%, High >60%.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">Analysis Capsule</div>
        <div class="glossary-def">Complete reproducible package: code, data, instructions. Anyone can run and get identical results.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">Consult Pack</div>
        <div class="glossary-def">Structured document with options, evidence, and trade-offs for team decision-making.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">PROSPERO</div>
        <div class="glossary-def">International registry for systematic review protocols. Timestamps your pre-specified methods.</div>
      </div>
      <div class="glossary-item">
        <div class="glossary-term">PRISMA</div>
        <div class="glossary-def">Reporting guideline for systematic reviews. Includes the flow diagram showing study selection.</div>
      </div>
    </div>
  </div>

  <!-- Course Completion Modal -->
  <div class="completion-modal" id="completionModal" role="dialog" aria-label="Course completed">
    <div class="completion-content">
      <div class="completion-trophy">üèÜ</div>
      <div class="completion-title">Course Complete!</div>
      <div class="completion-subtitle">You've mastered the META-SPRINT methodology</div>
      <div class="completion-stats">
        <div class="completion-stat">
          <div class="completion-stat-value" id="finalXP">0</div>
          <div class="completion-stat-label">Total XP</div>
        </div>
        <div class="completion-stat">
          <div class="completion-stat-value" id="finalCorrect">0</div>
          <div class="completion-stat-label">Correct Answers</div>
        </div>
        <div class="completion-stat">
          <div class="completion-stat-value" id="finalBadges">0</div>
          <div class="completion-stat-label">Badges Earned</div>
        </div>
      </div>
      <p style="font-size:0.9rem;opacity:0.7;margin-bottom:1rem">Go forth and produce trustworthy evidence!</p>
      <div class="completion-actions" style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
        <button class="btn primary" onclick="downloadCertificate()">Download Certificate</button>
        <button class="completion-close" onclick="closeCompletionModal()">Continue</button>
      </div>
    </div>
  </div>

  <!-- Review Mistakes Button -->
  <button class="review-mistakes-btn" id="reviewMistakesBtn" onclick="showReviewPanel()" aria-label="Review incorrect answers">
    üìù Review Mistakes
  </button>

  <!-- Review Panel -->
  <div class="review-panel" id="reviewPanel" role="dialog" aria-label="Review incorrect answers">
    <div class="review-header">
      <div class="review-title">üìù Review Your Mistakes</div>
      <button class="review-close" onclick="closeReviewPanel()">Close</button>
    </div>
    <div id="reviewContent"></div>
  </div>

<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  predictionsCorrect: 0,
  predictionsTotal: 0,
  badges: [],
  completedModules: [],
  perfectModules: [],
  answeredQuestions: {},
  consecutiveCorrect: 0
};

// Safe localStorage with fallback
function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    console.warn('localStorage unavailable, using session storage');
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {
    console.warn('Could not save to localStorage');
  }
}

// Migration from old storage key to versioned key
(function migrateStorage() {
  try {
    const oldData = localStorage.getItem('metasprintGame');
    if (oldData && !localStorage.getItem('metasprintGame_v1')) {
      localStorage.setItem('metasprintGame_v1', oldData);
      localStorage.removeItem('metasprintGame');
    }
  } catch (e) {}
})();

let gameState = safeGetStorage('metasprintGame_v1', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Novice Analyst", icon: "üìä", xp: 0 },
  { level: 2, title: "Protocol Apprentice", icon: "üìã", xp: 100 },
  { level: 3, title: "Search Specialist", icon: "üîç", xp: 250 },
  { level: 4, title: "Extraction Expert", icon: "üìù", xp: 450 },
  { level: 5, title: "Analysis Adept", icon: "üìà", xp: 700 },
  { level: 6, title: "Quality Guardian", icon: "üõ°Ô∏è", xp: 1000 },
  { level: 7, title: "Evidence Master", icon: "üèÜ", xp: 1400 },
  { level: 8, title: "Meta-Analysis Sage", icon: "üëë", xp: 1900 }
];

const BADGES = [
  { id: "first_blood", icon: "üéØ", name: "First Blood", desc: "Answer your first question correctly" },
  { id: "perfect_5", icon: "‚≠ê", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "‚öñÔ∏è", name: "Decision Maker", desc: "Complete 10 decision trees" },
  { id: "oracle", icon: "üîÆ", name: "The Oracle", desc: "Predict 5 outcomes correctly" },
  { id: "protocol_pro", icon: "üìã", name: "Protocol Pro", desc: "Complete Phase A module" },
  { id: "search_savant", icon: "üîç", name: "Search Savant", desc: "Complete Phase B module" },
  { id: "data_detective", icon: "üïµÔ∏è", name: "Data Detective", desc: "Complete Phase C module" },
  { id: "stats_wizard", icon: "üßô", name: "Stats Wizard", desc: "Complete Phase D module" },
  { id: "finisher", icon: "üèÅ", name: "Finisher", desc: "Complete the entire course" },
  { id: "streak_3", icon: "üî•", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "üí´", name: "Weekly Warrior", desc: "Maintain a 7-day streak" },
  { id: "colchicine_hero", icon: "üíä", name: "Colchicine Hero", desc: "Complete the case study" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "Why META-SPRINT?", subtitle: "The cost of bad evidence", xp: 150,
    slides: [
      { type: "title", theme: "dark", content: { title: "Why META-SPRINT?", subtitle: "The cost of getting it wrong" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand why bad evidence causes real harm",
          "Learn from the CAST tragedy and Poldermans fraud",
          "Recognize surrogate outcome traps",
          "Understand what provenance verification means"
        ],
        tip: "This module sets the stage for everything that follows."
      }},
      { type: "prediction", theme: "dark", content: {
        icon: "üîÆ", title: "Make Your Prediction",
        subtitle: "In the 1980s, drugs were developed to suppress irregular heartbeats (PVCs) after heart attacks. The drugs successfully fixed ECG readings. What do you think happened to death rates?",
        options: [
          { id: "benefit", label: "üíö Deaths decreased", text: "The drugs saved lives" },
          { id: "neutral", label: "‚ö™ No change", text: "Deaths stayed the same" },
          { id: "harm", label: "‚ù§Ô∏è Deaths increased", text: "The drugs caused harm" }
        ],
        answer: "harm",
        xp: 30
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The CAST Tragedy", title: "50,000 Deaths",
        text: "The drugs that 'fixed' the ECG <strong>tripled</strong> death rates. 50,000 Americans died from drugs that made their monitors look better.",
        followup: "Suppressing PVCs was a surrogate outcome‚Äîit looked like benefit but masked real harm."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìä", title: "Scenario: The Impressive Numbers",
        xp: 25,
        scenario: "A new diabetes drug shows it reduces HbA1c (blood sugar marker) by 40% more than standard treatment. The manufacturer wants to fast-track approval based on this 'impressive efficacy data.'",
        question: "What should regulators demand?",
        options: [
          { letter: "A", text: "Approve it‚Äî40% better HbA1c is significant", correct: false },
          { letter: "B", text: "Require trials showing reduced heart attacks, strokes, or death", correct: true },
          { letter: "C", text: "Approve with post-marketing monitoring", correct: false },
          { letter: "D", text: "Request larger HbA1c trials for confirmation", correct: false }
        ],
        feedback: {
          correct: "Correct! HbA1c is a surrogate like PVCs. The CAST tragedy taught us: surrogates can improve while patients die. Demand patient-important outcomes.",
          incorrect: "HbA1c is a surrogate marker. CAST showed us that 'fixing' lab values can mask fatal harm. Always demand patient-important outcomes: death, heart attack, stroke."
        }
      }},
      { type: "stats", theme: "dark", content: {
        title: "The Scale of Evidence Failures",
        stats: [
          { value: "50,000", label: "CAST drug deaths" },
          { value: "800,000", label: "Poldermans fraud deaths" },
          { value: "70%", label: "Studies unreproducible" }
        ],
        caption: "These aren't rare disasters. They're predictable results of broken processes."
      }},
      { type: "story", theme: "dark", content: {
        label: "The Vioxx Reckoning", title: "The Memo They Tried to Hide",
        text: "In 1996, Merck scientists discovered their painkiller Vioxx caused heart attacks. They wrote internal memos. They calculated the excess deaths. They did <strong>nothing</strong>. For eight years, doctors prescribed Vioxx while Merck executives debated how to spin the data.",
        followup: "When the truth emerged in 2004: 88,000 Americans had suffered heart attacks. 38,000 died. One internal email read: 'The cardiovascular events are clearly there.' They knew. They waited. People died."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìß", title: "Scenario: The Internal Signal",
        xp: 25,
        scenario: "You're a researcher at a pharmaceutical company. Your analysis shows your blockbuster drug increases cardiac events by 31%. Your manager suggests 'waiting for more data' and 'exploring alternative interpretations' before escalating.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Wait for more data as suggested", correct: false },
          { letter: "B", text: "Report the findings immediately to the safety board", correct: true },
          { letter: "C", text: "Run alternative analyses to see if the signal disappears", correct: false },
          { letter: "D", text: "Document your concerns in an email but take no action", correct: false }
        ],
        feedback: {
          correct: "Correct! The Vioxx lesson: 'waiting for more data' while people die is a decision that kills. Safety signals require immediate escalation.",
          incorrect: "Every day of delay has a body count. Vioxx's internal memos showed they knew‚Äîbut 'waiting for more data' killed 38,000 people. Report safety signals immediately."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Tamiflu Deception", title: "¬£473 Million for Hidden Data",
        text: "In 2009, governments stockpiled Tamiflu for pandemic flu. The UK spent ¬£473 million. The evidence? Manufacturer-funded trials showing 'reduced complications.' The catch? Roche refused to release the full trial data for <strong>five years</strong>.",
        followup: "When researchers finally obtained the raw data, they found: No evidence Tamiflu reduced hospitalizations. No evidence it prevented complications. Half a billion pounds spent on a promise that couldn't be verified."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚ö†Ô∏è", title: "Scenario: The Poldermans Data",
        xp: 25,
        scenario: "You're reviewing a meta-analysis and notice one researcher contributed 15 of the 40 included studies. His data shows dramatically better results than others. No one has verified his raw data exists.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Include all studies‚Äîthey passed peer review", correct: false },
          { letter: "B", text: "Request provenance verification for his studies", correct: true },
          { letter: "C", text: "Exclude his studies without explanation", correct: false },
          { letter: "D", text: "Average his results with others to reduce impact", correct: false }
        ],
        feedback: {
          correct: "Correct! Provenance verification asks 'Can I trace this number to its source?' Poldermans' fraud killed 800,000 because no one asked this question.",
          incorrect: "Not quite. Peer review doesn't verify raw data exists. You need provenance‚Äîthe trail from number to source document."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Theranos Deception", title: "One Drop of Blood, Billions in Lies",
        text: "In 2003, a 19-year-old Stanford dropout named <strong>Elizabeth Holmes</strong> made a promise that captivated the world: revolutionary blood tests from a single drop. No more needles. No more vials. Investors poured in $700 million. Walgreens signed a deal to put Theranos machines in 8,200 stores. Holmes graced magazine covers. Her company was valued at $9 billion.",
        followup: "The technology never worked. Not once. Theranos ran patient samples on competitors' machines, then hid the results. When the lies unraveled in 2015, the damage was done: <strong>thousands of patients received incorrect diagnoses</strong>. Cancer missed. HIV false positives. Treatment decisions based on fabricated data. Holmes is now serving 11 years in federal prison. The lesson: extraordinary claims without verifiable evidence aren't innovation‚Äîthey're fraud."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ü©∏", title: "Scenario: The Revolutionary Technology",
        xp: 25,
        scenario: "A startup claims their AI can detect 50 cancers from a single blood draw with 99% accuracy. They've raised $500 million. Celebrity endorsements abound. But they refuse to publish their validation data, citing 'trade secrets.' A hospital system wants to deploy it immediately.",
        question: "What should the hospital demand before deployment?",
        options: [
          { letter: "A", text: "Trust the FDA approval and deploy", correct: false },
          { letter: "B", text: "Require independent validation on their own patient population", correct: true },
          { letter: "C", text: "Start with a small pilot based on the company's data", correct: false },
          { letter: "D", text: "Wait for peer-reviewed publications", correct: false }
        ],
        feedback: {
          correct: "Correct! Theranos had FDA approval for one test while lying about dozens of others. Independent validation on YOUR patients is non-negotiable. Trade secrets that hide validation data are red flags.",
          incorrect: "Theranos fooled Walgreens, investors, and patients. The lesson: no independent validation, no deployment. 'Trust us' is not evidence."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The OxyContin Catastrophe", title: "The Pill That Built an Epidemic",
        text: "In 1996, Purdue Pharma launched OxyContin with a bold claim: their new opioid was <strong>'less than 1% addictive.'</strong> They cited a brief letter to the editor in a 1980 New England Journal of Medicine‚Äîfive sentences about hospital patients, not outpatient prescriptions. Sales reps repeated the claim 500,000 times to doctors. Purdue spent $200 million marketing it as safe.",
        followup: "The Sackler family knew. Internal documents showed they tracked addiction reports. They knew their 12-hour pill was wearing off early, driving patients to take more. They did the math: more pills, more profit. By 2021: <strong>500,000 Americans dead from opioid overdoses</strong>. Purdue pleaded guilty to federal charges‚Äîtwice. The Sacklers paid $6 billion but admitted no personal wrongdoing. One misrepresented paragraph. Half a million graves."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üíä", title: "Scenario: The Citation Chase",
        xp: 25,
        scenario: "A drug rep claims their new painkiller has 'minimal addiction risk, proven in the literature.' They hand you a reference. You find it's a 5-sentence letter to the editor from 1980 studying hospitalized patients, not the outpatient population you treat.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "It's in NEJM, so it's credible enough", correct: false },
          { letter: "B", text: "Demand RCTs with addiction as a pre-specified outcome in relevant populations", correct: true },
          { letter: "C", text: "Prescribe cautiously and monitor patients yourself", correct: false },
          { letter: "D", text: "Wait for colleagues to report problems first", correct: false }
        ],
        feedback: {
          correct: "Correct! The OxyContin tragedy started with a 5-sentence letter misrepresented as proof. Letters aren't evidence. Demand real trials with relevant outcomes in relevant populations.",
          incorrect: "Purdue built an empire on a 5-sentence letter. 'It's published' doesn't mean 'it's evidence.' The population, design, and outcomes must match your clinical question."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Surgisphere Scandal", title: "The Database That Never Existed",
        text: "In May 2020, the world was desperate for COVID-19 answers. Then <strong>The Lancet</strong> published a bombshell: hydroxychloroquine increased deaths in COVID patients. The study claimed data from 96,000 patients across 671 hospitals on six continents. The WHO halted trials. Countries banned the drug. The paper had one problem: <strong>the data was fabricated</strong>.",
        followup: "Surgisphere, a tiny company with 11 employees, claimed to have a global hospital database larger than any healthcare system on Earth. One employee was a science fiction author. Another was an adult content model. When journalists asked for verification, the company couldn't produce a single hospital contract. Both The Lancet and NEJM retracted their Surgisphere papers within weeks. During a pandemic, fabricated data hijacked global health policy. The peer reviewers never asked: 'Can we see proof this database exists?'"
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üè•", title: "Scenario: The Impossibly Large Dataset",
        xp: 25,
        scenario: "A paper claims to analyze 200,000 patients from 1,500 hospitals across 47 countries, collected by a company you've never heard of with 6 employees. The results would change treatment guidelines. Peer reviewers approved it.",
        question: "Before citing this in your systematic review, what should you verify?",
        options: [
          { letter: "A", text: "If it's in a top journal, the peer review was sufficient", correct: false },
          { letter: "B", text: "Contact the data company and request documentation of hospital partnerships", correct: true },
          { letter: "C", text: "Check if other researchers have cited it positively", correct: false },
          { letter: "D", text: "Look for statistical anomalies in the published tables", correct: false }
        ],
        feedback: {
          correct: "Correct! Surgisphere fooled The Lancet and NEJM during a pandemic. Provenance verification‚Äî'prove this data exists'‚Äîwould have caught it. Prestigious journals are not provenance.",
          incorrect: "The Lancet and NEJM were fooled. Peer review doesn't verify databases exist. Before trusting extraordinary data, verify the source can prove it's real."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Fen-Phen Disaster", title: "The Diet Pills That Destroyed Hearts",
        text: "In 1992, a researcher combined two FDA-approved drugs‚Äîfenfluramine and phentermine‚Äîfor weight loss. The combination was never tested together. The results seemed miraculous: patients lost weight effortlessly. Doctors prescribed it to <strong>6 million Americans</strong>. Weight loss clinics sprouted everywhere. Women's magazines celebrated the breakthrough.",
        followup: "Then the Mayo Clinic noticed something terrifying. Young, healthy women were developing a rare heart valve disease. One cardiologist saw 24 cases in a single year‚Äîhe'd seen only a handful in his entire career. The FDA investigated: <strong>30% of fen-phen users had abnormal heart valves</strong>. The combination was destroying hearts. By the time it was pulled in 1997, the damage was catastrophic. American Home Products paid $13 billion in settlements. The lesson: combining 'safe' drugs without testing the combination is not science‚Äîit's an uncontrolled experiment on patients."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üíî", title: "Scenario: The Off-Label Combination",
        xp: 25,
        scenario: "A colleague shows you impressive weight loss results from combining two approved drugs in a way that was never tested in trials. 'They're both FDA-approved, so the combination must be safe.' They want to publish a case series and recommend the protocol.",
        question: "What is the critical flaw in this reasoning?",
        options: [
          { letter: "A", text: "Case series are too small for publication", correct: false },
          { letter: "B", text: "Drug interactions can create harms not present in either drug alone", correct: true },
          { letter: "C", text: "Off-label use requires special FDA permission", correct: false },
          { letter: "D", text: "Weight loss drugs are too controversial", correct: false }
        ],
        feedback: {
          correct: "Correct! Fen-phen combined two 'safe' drugs into a heart-destroying combination. Drug interactions aren't predictable from individual profiles. Untested combinations require their own trials.",
          incorrect: "Fenfluramine was 'safe.' Phentermine was 'safe.' Together, they destroyed heart valves in 30% of users. Combinations need their own evidence‚Äîassumptions kill."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The DES Tragedy", title: "The Drug That Haunted Three Generations",
        text: "In 1938, scientists synthesized DES‚Äîa synthetic estrogen. By 1941, doctors were prescribing it to pregnant women to prevent miscarriages. It seemed logical: estrogen supports pregnancy. <strong>5 million American women</strong> took it between 1940 and 1971. Nobody ran a controlled trial. Nobody tracked the babies.",
        followup: "In 1971, a physician noticed something impossible: <strong>young women in their teens and twenties were developing a rare vaginal cancer</strong> that typically struck women over 50. He traced it back: their mothers had all taken DES during pregnancy. The drug hadn't caused immediate harm‚Äîit had planted a time bomb in the womb. DES daughters had higher rates of infertility, miscarriage, and cancer. DES granddaughters‚Äîthe third generation‚Äîshowed elevated cancer risks too. One untested assumption. Three generations of harm. The first controlled trial of DES, run in 1953, showed it <strong>didn't even prevent miscarriages</strong>‚Äîthe original indication was worthless."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ü§∞", title: "Scenario: The Logical Treatment",
        xp: 25,
        scenario: "A biologically plausible treatment for pregnancy complications has been used for 15 years with no obvious immediate harms. No controlled trials exist. A colleague says, 'We've used it on thousands of patients‚Äîif it caused problems, we'd know by now.'",
        question: "What critical assumption does this reasoning miss?",
        options: [
          { letter: "A", text: "15 years isn't long enough to judge safety", correct: false },
          { letter: "B", text: "Pregnancy exposures can cause harms that only appear decades later in offspring", correct: true },
          { letter: "C", text: "Observational experience is never valid", correct: false },
          { letter: "D", text: "Colleagues might be hiding adverse events", correct: false }
        ],
        feedback: {
          correct: "Correct! DES taught us the cruelest lesson: pregnancy exposures can cause cancers that appear 20-30 years later in children and grandchildren. 'No immediate harm' is not 'no harm.'",
          incorrect: "DES seemed safe for 30 years‚Äîuntil their daughters started developing cancer as teenagers. Some harms take decades to manifest. Long-term follow-up of offspring is essential for pregnancy exposures."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Bad evidence kills. META-SPRINT exists to produce evidence you can trust." }},
      { type: "quiz", theme: "dark", content: {
        question: "Why did the CAST drugs increase deaths despite 'working' on ECGs?",
        options: [
          { text: "The ECG readings were measured incorrectly", correct: false },
          { text: "Suppressing PVCs was a surrogate, not a real outcome", correct: true },
          { text: "The sample sizes were too small", correct: false },
          { text: "The drugs were contaminated", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Exactly. PVC suppression was a surrogate outcome‚Äîit looked like benefit but masked real harm.",
          incorrect: "The drugs worked exactly as intended on ECGs. The problem was 'fixed' ECGs didn't mean saved lives."
        }
      }}
    ]
  },
  {
    id: 2, title: "The 40-Day Framework", subtitle: "Five phases, five gates", xp: 120,
    slides: [
      { type: "title", theme: "dark", content: { title: "40 Days, 5 Gates", subtitle: "A structured sprint to trustworthy evidence" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Learn the five phases of META-SPRINT",
          "Understand Definition of Done (DoD) gates",
          "Know the team structure and daily time commitment"
        ],
        tip: "The framework overview - you'll learn each phase in detail later."
      }},
      { type: "timeline", theme: "dark", content: {
        title: "The Five Phases",
        items: [
          { days: "Days 1-3", title: "Phase A: Protocol", desc: "Lock your question and methods", phase: "a" },
          { days: "Days 4-10", title: "Phase B: Search", desc: "Find and filter literature", phase: "b" },
          { days: "Days 11-28", title: "Phase C: Extraction", desc: "Pull data with verification", phase: "c" },
          { days: "Days 29-33", title: "Phase D: Analysis", desc: "Run and verify analysis", phase: "d" },
          { days: "Days 34-40", title: "Phase E: Submit", desc: "Write, audit, submit", phase: "e" }
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üö™", title: "Scenario: The 'Almost Done' Gate",
        xp: 25,
        scenario: "It's Day 3. Your team has completed 7 of 8 DoD-A checklist items. The missing item: protocol registration on PROSPERO is 'pending review' (usually takes 24-48 hours).",
        question: "Should you pass DoD-A?",
        options: [
          { letter: "A", text: "Yes‚Äî7/8 is close enough, proceed to search", correct: false },
          { letter: "B", text: "No‚Äîwait for registration before passing gate", correct: true },
          { letter: "C", text: "Yes‚Äîregister later and backdate the protocol", correct: false },
          { letter: "D", text: "Skip registration‚Äîit's just bureaucracy", correct: false }
        ],
        feedback: {
          correct: "Correct! Gates are binary: pass or fail. 'Almost done' with protocol isn't done. Incomplete PICOS led to 50,000 CAST deaths.",
          incorrect: "Gates are binary. No partial credit. Registration timestamps your promises‚Äîwithout it, you can't prove you didn't change outcomes after seeing data."
        }
      }},
      { type: "concept", theme: "dark", content: {
        title: "Definition of Done (DoD)",
        subtitle: "Binary gates: Pass or Fail",
        text: "Each phase ends with a DoD gate‚Äîa checklist that must be 100% complete. No partial credit. No 'almost done.'",
        highlight: "The CAST lesson: 'Almost done' with protocol isn't done."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Guidelines That Killed", title: "800,000 Deaths from One Fraudster",
        text: "For years, clinical guidelines recommended beta-blockers before surgery to prevent heart attacks. The evidence? Largely from Don Poldermans‚Äîthe researcher who contributed 15 studies to the meta-analysis. His data showed dramatic benefits. His data was fabricated.",
        followup: "When the fraud was discovered and his studies removed, the math changed. Beta-blockers didn't prevent heart attacks during surgery‚Äîthey caused them. Researchers calculated: following guidelines based on Poldermans' fraud may have killed <strong>800,000 patients</strong> over a decade. One man's lies. Global guidelines. Mass harm."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìã", title: "Scenario: The Dominant Contributor",
        xp: 25,
        scenario: "You're updating a clinical guideline. Your systematic review includes 40 studies. One researcher contributed 15 of them‚Äîand his studies show dramatically larger effects than everyone else's. His work has never been independently replicated.",
        question: "What should the guideline committee do?",
        options: [
          { letter: "A", text: "Include all studies‚Äîpeer review ensures quality", correct: false },
          { letter: "B", text: "Run sensitivity analysis with and without his studies", correct: true },
          { letter: "C", text: "Exclude his studies as obvious outliers", correct: false },
          { letter: "D", text: "Weight his studies lower due to 'heterogeneity'", correct: false }
        ],
        feedback: {
          correct: "Correct! Sensitivity analysis would have shown Poldermans' outsized influence. When one researcher dominates a field, verify their work independently before basing guidelines on it.",
          incorrect: "The Poldermans lesson: one dominant contributor can corrupt an entire field. Sensitivity analysis (with/without their studies) reveals dangerous dependencies."
        }
      }},
      { type: "stats", theme: "light", content: {
        title: "The META-SPRINT Numbers",
        stats: [
          { value: "40", label: "Days total" },
          { value: "5", label: "Quality gates" },
          { value: "12", label: "Team members" },
          { value: "2h", label: "Max daily work" }
        ]
      }},
      { type: "quiz", theme: "dark", content: {
        question: "What happens if a DoD gate fails?",
        options: [
          { text: "You can proceed anyway with a warning", correct: false },
          { text: "You must fix all items before proceeding", correct: true },
          { text: "You skip to the next phase and return later", correct: false },
          { text: "The project is automatically cancelled", correct: false }
        ],
        xp: 15,
        feedback: {
          correct: "Right! Gates are non-negotiable. All items must pass before moving forward.",
          incorrect: "Gates are binary‚Äîyou cannot proceed until all items are complete. This prevents errors from compounding."
        }
      }}
    ]
  },
  {
    id: 3, title: "Phase A: Protocol", subtitle: "Days 1-3: Lock your promises", xp: 180,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "Phase A: Protocol", subtitle: "Days 1-3: Lock your promises before you see the data" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand why protocol registration prevents outcome switching",
          "Learn to write unambiguous PICOS criteria",
          "Master the DoD-A checklist requirements",
          "Recognize the danger of surrogate outcomes"
        ],
        tip: "Complete all decision scenarios to earn the Protocol Pro badge!"
      }},
      { type: "story", theme: "dark", content: {
        label: "The Outcome Switching Epidemic", title: "31% of Trials Cheat",
        text: "A PLOS study found 31% of trials changed their primary outcomes between registration and publication‚Äîalways in directions that made results look better."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üîÑ", title: "Scenario: The Tempting Switch",
        xp: 25,
        scenario: "Your meta-analysis protocol specified 'all-cause mortality' as the primary outcome. After extraction, you find only 4 studies report mortality, but 12 report 'cardiovascular events.' Your advisor suggests switching primary outcomes 'since the data supports it better.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Switch to cardiovascular events‚Äîmore data is better", correct: false },
          { letter: "B", text: "Keep mortality as primary, add CV events as secondary", correct: true },
          { letter: "C", text: "Report both as co-primary outcomes", correct: false },
          { letter: "D", text: "Revise the protocol and re-register before proceeding", correct: false }
        ],
        feedback: {
          correct: "Correct! Protocol protects you from yourself. 31% of trials switch outcomes‚Äîthat's how negative trials become 'positive.' Keep your original primary.",
          incorrect: "Switching outcomes after seeing data is exactly how 31% of trials cheat. Your protocol is your promise. CV events can be secondary analysis."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The HRT Reversal", title: "Two Million Women",
        text: "For forty years, doctors prescribed hormone replacement therapy to prevent heart disease in menopausal women. Observational studies showed 50% fewer heart attacks. It seemed obvious. It was wrong.",
        followup: "In 2002, the Women's Health Initiative RCT was stopped early. HRT <strong>increased</strong> heart attacks by 29%. Increased strokes by 41%. Increased breast cancer by 26%. Two million women had been taking a drug that harmed them, prescribed based on evidence that looked good but wasn't."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¨", title: "Scenario: The Observational Temptation",
        xp: 25,
        scenario: "You're writing a protocol for a systematic review on a new intervention. 50 observational studies show dramatic benefit. Only 3 small RCTs exist with mixed results. Your team suggests focusing only on observational studies 'where the data is stronger.'",
        question: "How should you structure the protocol?",
        options: [
          { letter: "A", text: "Include only observational studies‚Äîlarger sample sizes", correct: false },
          { letter: "B", text: "Analyze RCTs and observational separately, RCTs primary", correct: true },
          { letter: "C", text: "Pool RCTs and observational studies together", correct: false },
          { letter: "D", text: "Exclude observational studies entirely", correct: false }
        ],
        feedback: {
          correct: "Correct! HRT observational studies showed 50% benefit; the RCT showed 29% harm. Confounding bias in observational studies can create illusions. RCTs must be primary.",
          incorrect: "The HRT reversal: observational studies said 'benefit,' the RCT said 'harm.' Healthy women chose HRT‚Äîconfounding created an illusion. RCTs break confounding."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Story of Study 329", title: "Ghostwritten Lies",
        text: "In 2001, SmithKline Beecham published Study 329: paroxetine was 'safe and effective' for adolescent depression. Doctors prescribed it to millions of teenagers. But the published paper was ghostwritten. The actual data showed something else entirely.",
        followup: "The raw data: paroxetine was <strong>no better than placebo</strong> for depression. Worse: it increased suicidal thinking in adolescents by 200%. The ghostwriters had cherry-picked outcomes, hidden adverse events, and turned failure into success. It took 14 years to get the truth published."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìã", title: "Scenario: The Timepoint Dilemma",
        xp: 30,
        scenario: "You're writing the protocol for a colchicine meta-analysis. Trials report MACE at 30 days, 90 days, 1 year, and 3 years. Two team members disagree: one wants 'longest follow-up,' another wants 'fixed 1-year for all.'",
        question: "What's the best approach?",
        options: [
          { letter: "A", text: "Use longest follow-up per trial (maximizes data)", correct: false },
          { letter: "B", text: "Use fixed 1-year for all (cleaner comparison)", correct: false },
          { letter: "C", text: "Write a specific rule: 'Longest ‚â•1 year, else longest available'", correct: true },
          { letter: "D", text: "Decide later when you see what data exists", correct: false }
        ],
        feedback: {
          correct: "Excellent! A specific, pre-specified rule prevents ambiguity. Option C balances data maximization with interpretability.",
          incorrect: "Both A and B have merit, but they're still ambiguous. A specific rule like 'longest ‚â•1 year where available, else longest available' prevents disagreement during extraction."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "DoD-A Checklist",
        items: [
          "PICOS + inclusion/exclusion defined",
          "Primary outcome specified",
          "Timepoint rule documented",
          "Model choice (fixed/random)",
          "Sensitivity set defined",
          "Secondary outcomes labelled exploratory",
          "Protocol registered (PROSPERO/protocols.io)",
          "Signed by Integrator + non-integrator"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¨", title: "Scenario: The Surrogate Trap",
        xp: 25,
        scenario: "Your clinical advisor suggests using 'cholesterol reduction' as the primary outcome because more trials report it. But your original question was about 'cardiovascular death.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Switch to cholesterol‚Äîmore data is better", correct: false },
          { letter: "B", text: "Keep cardiovascular death as primary", correct: true },
          { letter: "C", text: "Use both as co-primary outcomes", correct: false },
          { letter: "D", text: "Add cholesterol as exploratory sensitivity", correct: false }
        ],
        feedback: {
          correct: "Correct! The CAST tragedy taught us: surrogate outcomes (like cholesterol) can mask real harm. Keep patient-important outcomes primary.",
          incorrect: "Cholesterol is a surrogate‚Äîit can improve while patients die (as in CAST). The Vioxx lesson: stick to patient-important outcomes."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Macchiarini Scandal", title: "The Surgeon Who Implanted Death",
        text: "Paolo Macchiarini was called a miracle worker. The Italian surgeon claimed he could grow synthetic tracheas and implant them in dying patients. <strong>The Lancet</strong> published his 'breakthroughs.' The Karolinska Institute‚Äîhome of the Nobel Prize‚Äîhired him. Patients flew from around the world seeking his revolutionary procedure.",
        followup: "One by one, his patients died. Of the eight who received his synthetic tracheas, <strong>seven died</strong>‚Äîmost within two years, suffocating as the plastic scaffolds disintegrated inside their throats. Karolinska's own doctors raised alarms. They were ignored. When a documentary exposed the truth, investigators found: falsified ethics approvals, fabricated patient outcomes, and co-authors who had never seen the data. The prestigious institute that awards the Nobel Prize had harbored a fraud who killed patients for fame. The Lancet retracted multiple papers. Macchiarini was convicted of assault. The lesson: prestige protects nothing. Only verification protects patients."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üèõÔ∏è", title: "Scenario: The Prestigious Innovator",
        xp: 25,
        scenario: "A celebrated surgeon at a world-famous institution publishes revolutionary results in top journals. His technique could save thousands. Junior colleagues express concerns about patient outcomes, but senior leadership dismisses them as jealousy. A documentary crew requests interviews.",
        question: "What should the institution do?",
        options: [
          { letter: "A", text: "Protect the surgeon's reputation‚Äîbad press harms everyone", correct: false },
          { letter: "B", text: "Immediately audit all patient outcomes with independent reviewers", correct: true },
          { letter: "C", text: "Wait for peer-reviewed rebuttals before acting", correct: false },
          { letter: "D", text: "Let the surgeon respond to critics in his own publications", correct: false }
        ],
        feedback: {
          correct: "Correct! Karolinska's greatest failure was ignoring internal warnings to protect prestige. Independent outcome audits‚Äînot reputation management‚Äîprotect patients. Junior colleagues often see what leaders don't.",
          incorrect: "The Karolinska Institute chose reputation over patients. Seven people died. When insiders raise concerns, audit immediately. Prestige is not evidence of safety."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Hwang Woo-suk Fraud", title: "The Pride of a Nation, Built on Lies",
        text: "In 2004, South Korean scientist <strong>Hwang Woo-suk</strong> announced he had cloned human embryos and created patient-specific stem cells‚Äîa breakthrough that could cure Parkinson's, diabetes, and paralysis. He was a national hero. The government issued postage stamps in his honor. Schools taught his achievements. His papers in <strong>Science</strong> were celebrated as Nobel-worthy.",
        followup: "A junior researcher noticed the photos looked wrong. The same cells appeared in multiple images, supposedly from different experiments. When Science investigated, the fa√ßade crumbled: the breakthrough data was fabricated. Hwang had pressured junior researchers‚Äîmostly women‚Äîto donate eggs under ethically questionable conditions. He had fabricated results to meet impossible expectations. The 'cloned' stem cells never existed. South Korea's national pride evaporated overnight. Hwang was convicted of embezzlement and bioethics violations. He had spent $40 million in government funds on research that produced nothing but lies."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¨", title: "Scenario: The National Priority",
        xp: 25,
        scenario: "Your country's leading scientist claims a revolutionary breakthrough. The government is funding a massive expansion. International competitors are racing to replicate. A junior lab member quietly tells you the image data looks manipulated, but fears retaliation for speaking up.",
        question: "What is the correct first step?",
        options: [
          { letter: "A", text: "Protect the whistleblower's identity while requesting independent image analysis", correct: true },
          { letter: "B", text: "Confront the senior scientist directly with the concerns", correct: false },
          { letter: "C", text: "Wait for international labs to attempt replication", correct: false },
          { letter: "D", text: "Report to government funders immediately", correct: false }
        ],
        feedback: {
          correct: "Correct! Image forensics by independent analysts‚Äîwithout exposing the whistleblower‚Äîis the safe path. Hwang's fraud was caught by image analysis. Junior researchers who speak up need protection.",
          incorrect: "Direct confrontation endangers whistleblowers and allows evidence destruction. Hwang's fraud was caught by image analysis showing duplicated cells. Independent forensics, then escalation."
        }
      }},
      { type: "concept", theme: "light", content: {
        title: "The Two-Signature Rule",
        subtitle: "Why two people must sign",
        text: "The Poldermans fraud succeeded because one researcher controlled everything. Single points of authority enable fraud.",
        highlight: "Two signatures means two people verified."
      }},
      { type: "quiz", theme: "dark", content: {
        question: "Why must the protocol be registered BEFORE DoD-A passes?",
        options: [
          { text: "It's a journal requirement only", correct: false },
          { text: "It timestamps your promises before seeing data", correct: true },
          { text: "It makes the review look more professional", correct: false },
          { text: "It's optional for non-Cochrane reviews", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Exactly! Registration creates a timestamp. Without it, you can't prove you didn't change outcomes after seeing what worked.",
          incorrect: "Registration timestamps your pre-specified methods. 31% of trials change outcomes‚Äîregistration proves you didn't."
        }
      }}
    ]
  },
  {
    id: 4, title: "Phase B: Search", subtitle: "Days 4-10: Document everything", xp: 150,
    slides: [
      { type: "title", theme: "dark", content: { title: "Phase B: Search & Screen", subtitle: "Days 4-10: Systematic, documented, reproducible" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand why search strings must be saved verbatim",
          "Learn calibration requirements for dual screening",
          "Master PRISMA reporting requirements",
          "Know when exclusion reasons are required"
        ],
        tip: "Complete this module to earn the Search Savant badge!"
      }},
      { type: "story", theme: "dark", content: {
        label: "The Cochrane Retraction", title: "Every Character Matters",
        text: "A Cochrane review was retracted when auditors couldn't reproduce the search. 'We used PubMed' is not a method."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üíæ", title: "Scenario: The Reconstructed Search",
        xp: 25,
        scenario: "You're at Day 8. A team member admits they didn't save the exact search string from last week‚Äîbut they 'remember most of it' and have reconstructed it. The search yielded 2,400 results then; the reconstructed search yields 2,380.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Accept it‚Äî20 missing records won't matter", correct: false },
          { letter: "B", text: "Re-run and document the new search as the official one", correct: true },
          { letter: "C", text: "Use the reconstructed search and note it in limitations", correct: false },
          { letter: "D", text: "Contact the database to get search history", correct: false }
        ],
        feedback: {
          correct: "Correct! A search that can't be reproduced isn't evidence. Document the new search as official, note the deviation, and proceed with transparent methods.",
          incorrect: "The Cochrane retraction: 'We used PubMed' isn't a method. You need the exact string, exact date, exact filters. Start fresh with documented methods."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Buried Trials", title: "Where Did 74 Studies Go?",
        text: "In 2008, researchers searched for all registered trials of antidepressants. They found 74 trials. Then they searched for publications. Only 38 had been published. The other 36? Buried. Hidden. Gone.",
        followup: "Every single buried trial showed negative results. Every published trial showed positive results. The published literature told doctors: 'Antidepressants work 94% of the time.' The truth: they worked 51% of the time. Half the evidence had simply vanished."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üîé", title: "Scenario: The Missing Registrations",
        xp: 25,
        scenario: "Your search of published literature finds 12 trials on a new drug‚Äîall positive. You check trial registries and find 8 additional registered trials that were never published. The company says the unpublished trials had 'data quality issues.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Include only the 12 published trials‚Äîthey have usable data", correct: false },
          { letter: "B", text: "Request unpublished data from registry contacts and FDA", correct: true },
          { letter: "C", text: "Note the 8 missing trials as a limitation", correct: false },
          { letter: "D", text: "Exclude the drug from your review due to bias concerns", correct: false }
        ],
        feedback: {
          correct: "Correct! The buried trials lesson: 48% of antidepressant data was hidden. Request unpublished data from registries, FDA, authors. Half the truth is a lie.",
          incorrect: "36 of 74 antidepressant trials were buried‚Äîall negative. Published-only evidence showed 94% efficacy; true efficacy was 51%. Always hunt for unpublished data."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Reboxetine Scandal", title: "The Drug That Never Worked",
        text: "Reboxetine was approved in Europe for depression. Published trials showed it worked. Doctors prescribed it. Then researchers obtained the unpublished data. <strong>74% of the patient data had never been published.</strong>",
        followup: "The hidden data showed: Reboxetine was no better than placebo. It was worse than other antidepressants. It had more side effects. Patients suffered for years on a drug that regulators approved based on cherry-picked evidence."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üîç", title: "Scenario: The Screening Disagreement",
        xp: 25,
        scenario: "Your two screeners independently reviewed 50 title/abstracts for calibration. They agreed on only 28 (56% agreement). The target is ‚â•80%.",
        question: "What should happen next?",
        options: [
          { letter: "A", text: "Proceed anyway‚Äî56% is acceptable for complex topics", correct: false },
          { letter: "B", text: "Discuss disagreements, revise criteria, re-calibrate on new 25", correct: true },
          { letter: "C", text: "Have a third person break all ties", correct: false },
          { letter: "D", text: "Switch to single-screener with random verification", correct: false }
        ],
        feedback: {
          correct: "Right! Low agreement means your criteria are ambiguous. Discuss, revise, repeat until you reach ‚â•80%.",
          incorrect: "56% agreement means your criteria are ambiguous. You're essentially screening randomly. Discuss, revise, re-calibrate."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "DoD-B Checklist",
        items: [
          "Search strings saved verbatim",
          "Search dates + limits recorded",
          "Dedup method recorded",
          "Screening calibration (‚â•80%)",
          "PRISMA counts live",
          "Screening log exportable"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìä", title: "Scenario: The PRISMA Puzzle",
        xp: 25,
        scenario: "Your PRISMA shows: Identified: 2,400 | After dedup: 1,800 | Screened: 1,800 | Full-text: 150 | Included: 45. A peer reviewer asks: 'What happened to the 1,650 excluded at screening?'",
        question: "What's the correct response?",
        options: [
          { letter: "A", text: "'They didn't meet criteria'‚Äîno need for details", correct: false },
          { letter: "B", text: "Provide counts by exclusion reason", correct: false },
          { letter: "C", text: "Explain that screening exclusions don't need reasons", correct: true },
          { letter: "D", text: "Go back and document each exclusion reason", correct: false }
        ],
        feedback: {
          correct: "Correct! Title/abstract screening exclusions don't require individual reasons (too many). Full-text exclusions DO need documented reasons.",
          incorrect: "Screening exclusions (title/abstract) don't require individual reasons‚Äîthere are too many. But FULL-TEXT exclusions must have documented reasons."
        }
      }},
      { type: "stats", theme: "dark", content: {
        title: "PRISMA Requirements",
        stats: [
          { value: "100%", label: "Numbers add up" },
          { value: "Every", label: "Full-text exclusion documented" },
          { value: "Zero", label: "Black boxes" }
        ]
      }},
      { type: "story", theme: "dark", content: {
        label: "The Missing Half", title: "Neurontin's Secret Studies",
        text: "Pfizer promoted Neurontin for bipolar disorder, migraines, and pain‚Äîuses never approved by the FDA. Internal documents revealed they had commissioned studies. When results were negative, the studies simply... disappeared.",
        followup: "Published literature showed Neurontin worked for off-label uses. Unpublished literature showed it didn't. Doctors saw only half the evidence and made the obvious‚Äîwrong‚Äîconclusion. Pfizer paid $430 million in fines. But the patients who received ineffective treatment? They paid more."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìÅ", title: "Scenario: The Company Offer",
        xp: 25,
        scenario: "A pharmaceutical company offers to share their 'complete internal database' for your systematic review. They promise all trial data‚Äîbut only if you sign a confidentiality agreement preventing you from publishing any individual trial results without their approval.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Accept‚Äîgetting the data is what matters", correct: false },
          { letter: "B", text: "Accept but note the restriction in your methods", correct: false },
          { letter: "C", text: "Decline and request data through official channels instead", correct: true },
          { letter: "D", text: "Accept for this review, fight for transparency later", correct: false }
        ],
        feedback: {
          correct: "Correct! Neurontin's lesson: companies hide what they don't want seen. Confidentiality agreements can be weaponized. Request data through FDA, EMA, or AllTrials instead.",
          incorrect: "The Neurontin scandal: companies suppressed negative trials. Confidentiality agreements give them veto power over what you report. Maintain independence."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "Why must search dates be recorded?",
        options: [
          { text: "For the journal's records", correct: false },
          { text: "Databases update daily‚Äîyour date is your timestamp", correct: true },
          { text: "To calculate how long the search took", correct: false },
          { text: "It's optional metadata", correct: false }
        ],
        xp: 15,
        feedback: {
          correct: "Exactly! A search on Monday finds different studies than Tuesday. Your dates define what universe you searched.",
          incorrect: "Databases update constantly. Your search date is the timestamp of what literature universe you searched."
        }
      }}
    ]
  },
  {
    id: 5, title: "Phase C: Extraction", subtitle: "Days 11-28: Provenance for every number", xp: 200,
    slides: [
      { type: "title", theme: "dark", content: { title: "Phase C: Extraction", subtitle: "Days 11-28: Every number needs a source" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand what provenance means and why it matters",
          "Learn the Red-Team daily checking system",
          "Handle conflicting numbers with pre-specified rules",
          "Recognize the COLCOT near-disaster pattern"
        ],
        tip: "The COLCOT case study shows how one swapped arm nearly reversed conclusions."
      }},
      { type: "prediction", theme: "dark", content: {
        icon: "üîÆ", title: "The COLCOT Trial",
        subtitle: "The largest trial (n=4,745) in a colchicine meta-analysis. The extractor pulls data from Figure 3 showing colchicine vs placebo events. Quick forest plot shows colchicine INCREASES events, while all other trials show benefit. What happened?",
        options: [
          { id: "benefit", label: "üìä Statistical fluke", text: "Random variation‚Äîinclude as-is" },
          { id: "neutral", label: "‚ùì Data entry error", text: "Wrong numbers typed" },
          { id: "harm", label: "üîÑ Arms swapped", text: "Intervention/control mixed up" }
        ],
        answer: "harm",
        xp: 30
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The COLCOT Near-Disaster", title: "One Swapped Arm",
        text: "The extractor assumed left bar = intervention. It was right = intervention. One error in one critical field would have reversed the entire conclusion.",
        followup: "The Red-Team daily check caught this. That's why influential studies get verified."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¥", title: "Scenario: Red-Team Finds an Error",
        xp: 30,
        scenario: "Red-team checker Fatima finds the COLCOT arms are swapped. This is the largest trial (40% of total weight). The extractor defends: 'The figure was ambiguous.'",
        question: "What should happen?",
        options: [
          { letter: "A", text: "Fix with provenance from Table 2, log correction", correct: true },
          { letter: "B", text: "Exclude COLCOT‚Äîtoo risky to include", correct: false },
          { letter: "C", text: "Expand audit to ALL studies immediately", correct: false },
          { letter: "D", text: "Ask the original authors to clarify", correct: false }
        ],
        feedback: {
          correct: "Correct! Fix with provenance (Table 2 confirms allocation), log the correction. Single clear-cause error doesn't require expanded audit.",
          incorrect: "Don't exclude good data or over-expand audit for a single clear-cause error. Fix with provenance, log it, and brief the extractor."
        }
      }},
      { type: "concept", theme: "dark", content: {
        title: "The Red-Team System",
        subtitle: "Daily adversarial checking",
        text: "Every day from Day 11, 2 rotating team members spend 12-15 minutes checking auto-selected studies.",
        highlight: "The Boldt Detection: His fraud (90+ studies) was caught when a red-team noticed impossible recruitment rates."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Boldt Disaster", title: "Ninety Studies of Lies",
        text: "Joachim Boldt was the most prolific researcher in anesthesia. He published over 90 studies on colloid fluids. His work shaped clinical guidelines worldwide. Then someone noticed: one hospital claimed to recruit 800 patients in conditions that only affected 200 patients per year.",
        followup: "Investigation revealed: No ethics approval existed. Patient records couldn't be found. Co-authors had never seen the data. <strong>Ninety studies</strong> were retracted‚Äîthe largest fraud in medical history. Clinical guidelines had to be rewritten. The question that would have stopped him? 'Can you show me the source documents?'"
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¢", title: "Scenario: The Impossible Numbers",
        xp: 25,
        scenario: "During extraction, you notice a study recruited 450 patients with a rare condition from a single hospital in 18 months. Published epidemiology suggests that hospital sees about 50 such patients per year.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Include the study‚Äîrecruitment success varies", correct: false },
          { letter: "B", text: "Flag for verification: check ethics approval and patient records", correct: true },
          { letter: "C", text: "Exclude as a statistical outlier", correct: false },
          { letter: "D", text: "Email the authors to clarify recruitment methods", correct: false }
        ],
        feedback: {
          correct: "Correct! Boldt was caught because recruitment rates were impossible. When numbers don't make sense, verify source documents exist before including the study.",
          incorrect: "This is how Boldt was caught: 800 patients from conditions affecting 200/year. Impossible numbers signal potential fraud. Verify ethics approval and raw data exist."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Wakefield Fraud", title: "12 Children, 12 Million Harmed",
        text: "In 1998, Andrew Wakefield published a study of 12 children linking MMR vaccine to autism. Vaccination rates plummeted. Measles outbreaks returned. Children died from preventable disease.",
        followup: "It took 12 years to prove the fraud. Wakefield had been paid ¬£435,643 by lawyers to produce evidence for lawsuits. He had manipulated data. He had undisclosed conflicts. But for a decade, his 12-patient study outweighed millions of patients in honest research. One fraudulent paper. Thousands of preventable infections."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìù", title: "Scenario: The Missing Provenance",
        xp: 25,
        scenario: "An extractor recorded 'events: 45/230' for a study but didn't note the source (table/figure/page). When you check the PDF, you find events reported in Table 2 (45/230), Figure 1 (42/228), and text (43/225).",
        question: "What's the correct action?",
        options: [
          { letter: "A", text: "Use any number‚Äîthey're close enough", correct: false },
          { letter: "B", text: "Use the most conservative estimate (42/228)", correct: false },
          { letter: "C", text: "Contact the authors to clarify", correct: false },
          { letter: "D", text: "Apply pre-specified hierarchy (e.g., Table > Figure > Text)", correct: true }
        ],
        feedback: {
          correct: "Correct! Your protocol should specify a hierarchy for conflicting numbers. Apply it consistently and document the source.",
          incorrect: "You need a pre-specified rule for this situation. 'Most conservative' is a rule, but it should be in your protocol. Without provenance, you can't verify anything."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "DoD-C Checklist",
        items: [
          "Extraction template frozen",
          "RoB tool + decision rules written",
          "Critical fields verified by second person",
          "Overlap rules applied",
          "Arbitration process operating"
        ]
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Reuben Anesthesia Fraud", title: "The Most Prolific Faker in Medicine",
        text: "Scott Reuben was anesthesiology's rising star. Between 1996 and 2008, he published prolifically on postoperative pain management. His studies shaped how surgeons treated patients after operations. Drug companies funded his research. <strong>Pfizer paid him consulting fees</strong> while he published studies showing their drugs worked brilliantly.",
        followup: "In 2009, an anonymous tip led to investigation. Reuben hadn't just manipulated data‚Äî<strong>he had never enrolled a single patient</strong>. Studies claiming to follow hundreds of patients were pure invention. He fabricated everything: consent forms, patient records, outcomes. Twenty-one papers were retracted. Clinical guidelines based on his 'research' had to be rewritten. The patients who received treatment recommendations based on his fabrications? They were experiments in a trial that never happened, with no informed consent, following protocols invented by a liar."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üë§", title: "Scenario: The Prolific Researcher",
        xp: 25,
        scenario: "You notice one researcher has published 15 trials in your field in 3 years‚Äîmore than any department could realistically conduct. All show positive results for drugs made by his funders. No other center has replicated his findings. His institution has never audited his data.",
        question: "What should you do before including his studies in your review?",
        options: [
          { letter: "A", text: "Include them‚Äîthey're peer-reviewed and published", correct: false },
          { letter: "B", text: "Request verification of ethics approval and patient enrollment records", correct: true },
          { letter: "C", text: "Run sensitivity analysis with and without his studies", correct: false },
          { letter: "D", text: "Weight his studies lower due to potential bias", correct: false }
        ],
        feedback: {
          correct: "Correct! Reuben published 21 fabricated trials over 12 years. No one checked if patients existed. Request ethics board documentation and enrollment verification‚Äîfabricators can't produce them.",
          incorrect: "Scott Reuben invented 21 studies with imaginary patients. Peer review didn't catch it. Sensitivity analysis doesn't detect fabrication. Verify the patients existed."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The VIGOR Deception", title: "The Three Heart Attacks They Hid",
        text: "Merck knew Vioxx caused heart attacks. Their own trial‚ÄîVIGOR‚Äîshowed it clearly. But the published paper in the <strong>New England Journal of Medicine</strong> had a secret: Merck scientists had chosen a data cutoff date that excluded <strong>three additional heart attacks</strong> that occurred in the Vioxx group.",
        followup: "Those three heart attacks mattered. Including them would have changed the safety signal from 'possibly concerning' to 'clearly dangerous.' Instead, the published paper suggested the increased heart attacks might be because the comparison drug (naproxen) was protective‚Äînot because Vioxx was deadly. The NEJM editors only learned of the missing data years later. They published an 'expression of concern,' calling it 'inaccurate and incomplete.' By then, tens of thousands had suffered heart attacks. The data cutoff wasn't a scientific decision. It was a marketing decision disguised as methodology."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìÖ", title: "Scenario: The Strategic Cutoff",
        xp: 25,
        scenario: "You're extracting data and notice a trial's data cutoff date was 2 weeks before the study's stated end date. The methods don't explain why. Events occurring after the cutoff aren't reported. The timing conveniently coincides with when safety signals would have become statistically significant.",
        question: "What should you document and request?",
        options: [
          { letter: "A", text: "Use the published data‚Äîthe authors chose their cutoff", correct: false },
          { letter: "B", text: "Note unexplained cutoff in Risk of Bias; request complete data from authors/FDA", correct: true },
          { letter: "C", text: "Exclude the study for incomplete reporting", correct: false },
          { letter: "D", text: "Impute likely events based on trends before cutoff", correct: false }
        ],
        feedback: {
          correct: "Correct! The VIGOR cutoff hid three heart attacks that changed everything. Document unexplained cutoffs as high risk of bias and actively seek complete data from registries or FDA.",
          incorrect: "Merck's VIGOR cutoff wasn't methodology‚Äîit was concealment. Unexplained cutoffs are red flags. Document the risk and pursue complete data through official channels."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "What is 'provenance' in META-SPRINT?",
        options: [
          { text: "The country where a study was conducted", correct: false },
          { text: "A citation showing where a number came from", correct: true },
          { text: "The funding source of a trial", correct: false },
          { text: "The date a study was published", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Right! Provenance like 'Table 2, p.1234' creates an audit trail. No provenance = no trust.",
          incorrect: "Provenance means the exact source: 'Table 2, p.1234.' It's your evidence trail for every extracted number."
        }
      }},
      { type: "summary", theme: "green-bg", content: {
        summary: "You've mastered extraction fundamentals: provenance, Red-Team checking, and handling conflicting data. Next: making your analysis reproducible."
      }}
    ]
  },
  {
    id: 6, title: "Phase D: Analysis", subtitle: "Days 29-33: Reproducible results", xp: 180,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "Phase D: Analysis", subtitle: "Days 29-33: If you can't reproduce it, neither can anyone else" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand rerun equivalence tolerances",
          "Learn to handle analysis discrepancies",
          "Know how to document influential studies",
          "Master the concept of analysis capsules"
        ],
        tip: "Reproducibility is non-negotiable. Complete this for the Stats Wizard badge!"
      }},
      { type: "stats", theme: "dark", content: {
        title: "The Reproducibility Crisis",
        stats: [
          { value: "70%", label: "Failed to reproduce others" },
          { value: "50%", label: "Failed to reproduce self" }
        ],
        caption: "Nature (2016): Most researchers can't reproduce published findings."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Amgen Reality Check", title: "47 of 53 Failed",
        text: "In 2012, Amgen scientists tried to reproduce 53 'landmark' cancer studies‚Äîpapers that had shaped cancer research, launched clinical trials, and consumed billions in funding. They worked directly with original authors. They used the same methods.",
        followup: "Result: <strong>47 of 53 studies could not be reproduced.</strong> 89% failure rate. Years of research built on foundations that didn't exist. Clinical trials started based on findings that weren't real. The cancer research community had been chasing phantoms."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¨", title: "Scenario: The Landmark Paper",
        xp: 25,
        scenario: "A 'landmark' preclinical study from a top journal forms the basis for a new treatment. Three replication attempts by independent labs have failed. The original authors say the replicators 'lacked the technical expertise.' No one has seen the original raw data.",
        question: "How should guidelines treat this evidence?",
        options: [
          { letter: "A", text: "Trust the original‚Äîit's in a top journal", correct: false },
          { letter: "B", text: "Downgrade certainty until reproducibility is demonstrated", correct: true },
          { letter: "C", text: "Weight original and replications equally", correct: false },
          { letter: "D", text: "Wait for a fourth replication attempt", correct: false }
        ],
        feedback: {
          correct: "Correct! The Amgen lesson: 89% of landmark cancer studies couldn't be reproduced. If it can't be replicated, it's not evidence‚Äîit's a hypothesis.",
          incorrect: "47 of 53 landmark studies failed to reproduce. Journal prestige doesn't equal truth. Unreproducible findings should never form the basis of treatment guidelines."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Duke Scandal", title: "The Genius Who Never Was",
        text: "Anil Potti at Duke University developed a genomic test to personalize cancer treatment. His papers were published in top journals. Clinical trials enrolled patients. He was celebrated as a visionary.",
        followup: "Then two statisticians noticed: the data was impossible. Gene signatures were backwards. Spreadsheets had been manipulated. Potti had invented his credentials. Over 100 cancer patients had been enrolled in trials based on fraudulent science. Some received treatments that harmed them based on data that never existed."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üîÑ", title: "Scenario: The Rerun Mismatch",
        xp: 30,
        scenario: "Audit 2: Two analysts independently rerun the analysis. Analyst A: I¬≤=34.2%. Analyst B: I¬≤=31.8%. The tolerance is 1%. Difference: 2.4%.",
        question: "What should happen?",
        options: [
          { letter: "A", text: "Average the results‚Äîboth are reasonable", correct: false },
          { letter: "B", text: "Use the more conservative estimate", correct: false },
          { letter: "C", text: "Line-by-line comparison to find the discrepancy", correct: true },
          { letter: "D", text: "Trigger CondGO (emergency mode)", correct: false }
        ],
        feedback: {
          correct: "Correct! Line-by-line comparison found one SE rounded to 2 decimals instead of 4. Fix the source, rerun, verify match.",
          incorrect: "Don't average or accept mismatch. Find the source of discrepancy. In this case: one SE was rounded incorrectly."
        }
      }},
      { type: "concept", theme: "dark", content: {
        title: "Rerun Equivalence Tolerances",
        subtitle: "Two runs must match exactly",
        checkpoints: [
          { day: "Study count", event: "Exactly identical" },
          { day: "Effect sizes", event: "‚â§0.001 (log scale)" },
          { day: "Pooled effect", event: "‚â§0.001" },
          { day: "I¬≤ heterogeneity", event: "Within 1%" }
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìà", title: "Scenario: The Influential Study",
        xp: 25,
        scenario: "Leave-one-out analysis shows that removing the COLCOT trial changes the pooled RR from 0.65 (significant) to 0.78 (still significant). COLCOT contributes 40% of the weight.",
        question: "What should you document?",
        options: [
          { letter: "A", text: "Nothing‚Äîresult is still significant", correct: false },
          { letter: "B", text: "Document that COLCOT is influential but robust", correct: true },
          { letter: "C", text: "Exclude COLCOT as an outlier", correct: false },
          { letter: "D", text: "Downgrade certainty to VERY LOW", correct: false }
        ],
        feedback: {
          correct: "Correct! Document influential studies and note that conclusions are robust. Don't exclude good data just because it's influential.",
          incorrect: "You must document influential studies. Here, removing COLCOT changes magnitude but not direction‚Äîthat's a robust finding. Don't exclude good data."
        }
      }},
      { type: "checklist", theme: "dark", content: {
        title: "DoD-D Checklist",
        items: [
          "Capsule runs end-to-end",
          "Forest + heterogeneity outputs",
          "Sensitivity set executed",
          "Influential studies documented",
          "Audit 2 completed",
          "Rerun equivalence satisfied"
        ]
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The BMP-2 Cover-Up", title: "Paid Authors, Hidden Harms",
        text: "Medtronic paid $210 million to surgeons who wrote papers about their bone growth product BMP-2. Every published paper said it was safe and effective. Every paper was written by authors with undisclosed financial ties. None reported the adverse events that Medtronic knew about.",
        followup: "When independent researchers obtained FDA adverse event reports, they found: <strong>10-50x higher complication rates</strong> than published papers claimed. Cancers. Sterility. Chronic pain. The published literature was a marketing document. The real evidence was in FDA files no one had read."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üí∞", title: "Scenario: The Consulting Fees",
        xp: 25,
        scenario: "You're extracting data from 15 studies on a medical device. You notice all 15 lead authors have received consulting fees from the manufacturer. The amounts range from $50,000 to $500,000 per author. All 15 studies show benefit; no harms are reported.",
        question: "What should you document in your review?",
        options: [
          { letter: "A", text: "Nothing‚Äîdisclosed conflicts aren't bias", correct: false },
          { letter: "B", text: "Document conflicts and check FDA adverse event database", correct: true },
          { letter: "C", text: "Exclude all studies due to conflict of interest", correct: false },
          { letter: "D", text: "Run sensitivity analysis by funding source", correct: false }
        ],
        feedback: {
          correct: "Correct! BMP-2 lesson: all published papers hid harms that FDA reports revealed. Always cross-check industry-funded device/drug studies against regulatory databases.",
          incorrect: "The BMP-2 cover-up: $210M paid to authors who reported no harms; FDA data showed 10-50x higher complication rates. Industry conflicts require regulatory cross-checking."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Metal-on-Metal Hip Disaster", title: "The Joints That Poisoned Patients",
        text: "In the 2000s, device manufacturers promised a revolution: metal-on-metal hip implants that would last forever. DePuy's ASR hip was the flagship. <strong>93,000 patients</strong> worldwide received them. The company cited laboratory testing showing excellent wear characteristics. Surgeons believed the marketing.",
        followup: "Inside patients' bodies, reality was different. The metal surfaces ground against each other, releasing cobalt and chromium ions into tissues. Patients developed <strong>metallosis</strong>‚Äîmetal poisoning causing tissue death, bone destruction, and chronic pain. Some developed neurological symptoms as cobalt reached their brains. The failure rate reached <strong>40% at 5 years</strong>‚Äîcatastrophic for a device meant to last decades. DePuy had internal data showing problems but kept selling. When the hip was finally recalled in 2010, Johnson & Johnson paid $2.5 billion in settlements. The laboratory tests that 'proved' safety had never predicted what happens inside a living, moving human body."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "ü¶¥", title: "Scenario: The Laboratory Evidence",
        xp: 25,
        scenario: "A new surgical implant shows excellent results in laboratory wear testing and animal studies. The manufacturer wants to skip large-scale human trials and go directly to market with post-marketing surveillance. 'The bench testing proves it works,' they argue.",
        question: "What is the critical flaw in this reasoning?",
        options: [
          { letter: "A", text: "Animal studies should be longer before human use", correct: false },
          { letter: "B", text: "Laboratory conditions cannot replicate the biological environment inside patients", correct: true },
          { letter: "C", text: "Post-marketing surveillance is sufficient for rare harms", correct: false },
          { letter: "D", text: "Bench testing is only valid for drugs, not devices", correct: false }
        ],
        feedback: {
          correct: "Correct! Metal-on-metal hips passed every lab test‚Äîthen poisoned patients with metal ions no simulator predicted. The body is not a laboratory. Human trials in real conditions are irreplaceable.",
          incorrect: "DePuy's lab tests showed the hip would last forever. Inside patients, it destroyed tissue and released metal ions. Lab conditions ‚â† biological reality. Large human trials with long follow-up are essential."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Essure Disaster", title: "The Permanent Contraception That Destroyed Lives",
        text: "Bayer's Essure promised women permanent contraception without surgery‚Äîtiny metal coils inserted through the cervix that would block the fallopian tubes. The <strong>FDA approved it based on 2 years of data from 518 women</strong>. What could go wrong with a simple, non-surgical procedure?",
        followup: "Thousands of women reported devices migrating through their bodies, perforating organs, causing chronic pain, autoimmune reactions, and‚Äîdevastatingly‚Äî<strong>unintended pregnancies, including ectopic pregnancies that can be fatal</strong>. Women needed hysterectomies to remove devices they'd been told were 'permanent solutions.' A Facebook group for Essure victims grew to over 30,000 members. The FDA eventually added a black box warning, then restricted sales. Bayer stopped selling it in 2018. The lesson: 2 years of follow-up in 518 women was never enough to detect rare complications from a permanent implant. Approval timelines should match device permanence."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚ö†Ô∏è", title: "Scenario: The Permanent Device",
        xp: 25,
        scenario: "A permanent implantable device is seeking FDA approval based on 3-year follow-up in 600 patients. The device is meant to remain in patients for life. No serious adverse events have been reported yet. The company argues this proves long-term safety.",
        question: "What should regulators require before approval?",
        options: [
          { letter: "A", text: "Post-marketing surveillance with mandatory reporting", correct: false },
          { letter: "B", text: "Follow-up duration proportional to intended implant life; registry with long-term tracking", correct: true },
          { letter: "C", text: "Approval is appropriate‚Äî3 years is standard for devices", correct: false },
          { letter: "D", text: "Additional laboratory durability testing", correct: false }
        ],
        feedback: {
          correct: "Correct! Essure was approved on 2-year data for a permanent device. Complications emerged over years. Permanent implants need follow-up proportional to their permanence‚Äîand mandatory long-term registries.",
          incorrect: "Essure's 2-year data missed complications that destroyed women's health. A permanent device needs proportionally long follow-up. Post-marketing surveillance catches problems too late."
        }
      }},
      { type: "quiz", theme: "dark", content: {
        question: "What is an 'analysis capsule'?",
        options: [
          { text: "A summary of key findings", correct: false },
          { text: "Code + data + instructions that anyone can run", correct: true },
          { text: "The forest plot output", correct: false },
          { text: "A compressed data file", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Exactly! A capsule is everything needed to reproduce your analysis. Code, data, environment‚Äîall versioned.",
          incorrect: "A capsule is a complete reproducible package: code, data, instructions. Anyone can run it and get identical results."
        }
      }}
    ]
  },
  {
    id: 7, title: "Phase E & CondGO", subtitle: "Days 34-40: Ship or emergency", xp: 180,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "Phase E: Submission", subtitle: "Days 34-40: The FREEZE and CondGO" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Understand the FREEZE and why it's essential",
          "Learn when CondGO is triggered",
          "Know the three CondGO exit options",
          "Master the DoD-E final checklist"
        ],
        tip: "The emergency protocol that prevents 'we'll deal with it later' disasters."
      }},
      { type: "concept", theme: "dark", content: {
        title: "The FREEZE (Day 34)",
        subtitle: "No new studies after this point",
        text: "Scope is locked. Only corrections to existing data allowed.",
        highlight: "The BMP Scandal: Industry kept 'finding' new studies that favored their product. Freeze prevents weaponized scope creep."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìö", title: "Scenario: New Study After Freeze",
        xp: 25,
        scenario: "It's Day 36. A colleague sends you a newly published RCT that fits your criteria perfectly. It's a large, high-quality trial.",
        question: "What do you do?",
        options: [
          { letter: "A", text: "Add it‚Äîquality evidence shouldn't be excluded", correct: false },
          { letter: "B", text: "Note it as a limitation, don't add", correct: true },
          { letter: "C", text: "Add it but run sensitivity with/without", correct: false },
          { letter: "D", text: "Request deadline extension to include it", correct: false }
        ],
        feedback: {
          correct: "Correct! After freeze, note new studies as limitations. Adding them opens the door to selective inclusion.",
          incorrect: "Freeze means freeze. Adding 'just this one good study' is exactly how scope creep corrupts reviews. Note as limitation."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Avandia Timeline", title: "Seven Years of Silence",
        text: "GSK saw cardiovascular signals in 2000. They chose to 'watch and wait' with no deadline. Seven years later, Nissen's meta-analysis exposed the harm.",
        followup: "CondGO exists because 'we'll deal with it eventually' kills people."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚è∞", title: "Scenario: The Indefinite Review",
        xp: 25,
        scenario: "Your systematic review found a potential safety signal: Drug X shows 28% increased cardiac events compared to placebo. Your supervisor suggests 'keeping the finding internal until we gather more data' with no specific timeline.",
        question: "What should you insist on?",
        options: [
          { letter: "A", text: "Agree‚Äîpremature publication could cause panic", correct: false },
          { letter: "B", text: "Set a fixed deadline: publish or escalate within 30 days", correct: true },
          { letter: "C", text: "Share with the drug manufacturer for their input first", correct: false },
          { letter: "D", text: "Run additional analyses to confirm the signal", correct: false }
        ],
        feedback: {
          correct: "Correct! The Avandia lesson: 'watch and wait with no deadline' killed 83,000 people. CondGO principle: safety signals need hard deadlines, not open-ended deliberation.",
          incorrect: "GSK 'watched and waited' on Avandia for seven years. 83,000 heart attacks later, we learned: indefinite timelines kill. Set hard deadlines for safety decisions."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Full Avandia Story", title: "The Spreadsheet They Buried",
        text: "In 1999, GlaxoSmithKline's own analysis showed Avandia increased heart attacks by 31%. A company statistician created a spreadsheet. Executives saw it. They calculated the liability. They kept selling.",
        followup: "For seven years, Avandia remained a blockbuster drug. $3 billion per year in sales. The spreadsheet stayed hidden. When Steven Nissen published his meta-analysis in 2007, the world learned what GSK had known since 1999: Avandia caused an estimated <strong>83,000 heart attacks</strong>. The delay wasn't oversight‚Äîit was a decision."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìà", title: "Scenario: The Business Decision",
        xp: 25,
        scenario: "Your analysis shows a drug increases adverse events by 25%. The drug generates $2 billion in annual revenue. Legal calculates that potential lawsuits might cost $500 million. A senior executive suggests the 'math favors continued sales.'",
        question: "What is the ethical response?",
        options: [
          { letter: "A", text: "This is a business decision, not a scientific one", correct: false },
          { letter: "B", text: "Report the finding to regulators immediately", correct: true },
          { letter: "C", text: "Seek independent confirmation before acting", correct: false },
          { letter: "D", text: "Add warnings to the label and continue sales", correct: false }
        ],
        feedback: {
          correct: "Correct! The Avandia spreadsheet showed harm in 1999. GSK did the 'math' and kept selling. The ethical answer is never about revenue‚Äîit's about patient safety.",
          incorrect: "GSK calculated liability vs. revenue and chose sales. 83,000 heart attacks later: the 'business decision' was mass harm. Safety findings require immediate regulatory disclosure."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Thalidomide Lesson", title: "10,000 Children",
        text: "In 1957, a German company marketed thalidomide as a safe sleeping pill for pregnant women. 'No evidence of harm,' they said. They hadn't looked for harm. They hadn't required evidence. They had assumed.",
        followup: "Within four years: 10,000 children born with severe limb deformities. Many more died before birth. One woman, Frances Kelsey at the FDA, had demanded proper evidence before approving it in America. She was called 'bureaucratic.' Her skepticism saved thousands of American children. Evidence isn't bureaucracy. Evidence is protection."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üö®", title: "Scenario: CondGO Trigger",
        xp: 30,
        scenario: "Day 33. DoD-D fails: Audit 2 found that reruns don't match within tolerance, and you can't identify the source of discrepancy after 4 hours.",
        question: "What happens now?",
        options: [
          { letter: "A", text: "Extend the deadline by a week", correct: false },
          { letter: "B", text: "Trigger CondGO: 72 hours to fix or decide", correct: true },
          { letter: "C", text: "Submit anyway with a note about discrepancy", correct: false },
          { letter: "D", text: "Abandon the project", correct: false }
        ],
        feedback: {
          correct: "Correct! CondGO gives exactly 72 hours to fix using allowed actions, or make a termination decision.",
          incorrect: "CondGO is triggered. 72 hours, bounded actions only. No extensions. Fix it or face the decision to stop."
        }
      }},
      { type: "concept", theme: "dark", content: {
        title: "CondGO Rules",
        subtitle: "72 hours, bounded actions",
        allowed: ["Correct extraction errors", "Fix conversions", "Resolve overlaps", "Repair audit pack"],
        forbidden: ["New outcomes", "Post-hoc subgroups", "New studies after freeze"]
      }},
      { type: "checklist", theme: "dark", content: {
        title: "DoD-E Checklist",
        items: [
          "PRISMA checklist complete",
          "All appendices complete",
          "Two reruns equivalent",
          "Clinical Summary included",
          "Deviation log complete",
          "GRADE assessment done",
          "Audit-Grade Index: 9/9"
        ]
      }},
      { type: "quiz", theme: "dark", content: {
        question: "What are the CondGO exit options?",
        options: [
          { text: "Continue, Pause, or Restart", correct: false },
          { text: "Pass, Submit minimal, or Terminate", correct: true },
          { text: "Extend 24h, 48h, or 72h", correct: false },
          { text: "There are no exits‚Äîyou must fix it", correct: false }
        ],
        xp: 20,
        feedback: {
          correct: "Right! PASS (fixed), Submit minimal version, or Terminate with Failure Log. No middle ground.",
          incorrect: "CondGO has exactly three exits: fix it (PASS), submit minimal version, or terminate and archive with Failure Log."
        }
      }}
    ]
  },
  {
    id: 8, title: "Case: Colchicine Review", subtitle: "4 crises, 0 failures", xp: 250,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Colchicine Review", subtitle: "A 40-day sprint with 4 crises and 0 failures" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "See META-SPRINT in action through a real case",
          "Learn how each crisis was resolved",
          "Understand why the system worked",
          "Apply lessons to your own reviews"
        ],
        tip: "This case study ties everything together. Earn the Colchicine Hero badge!"
      }},
      { type: "stats", theme: "dark", content: {
        title: "The Question",
        subtitle: "Does colchicine reduce cardiac events after heart attack?",
        stats: [
          { value: "8", label: "RCTs" },
          { value: "11,774", label: "Patients" },
          { value: "40", label: "Days" },
          { value: "4", label: "Crises" }
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "1Ô∏è‚É£", title: "Crisis 1: The Timepoint Dilemma",
        xp: 25,
        scenario: "Day 2. Trials report MACE at 30 days, 90 days, 1 year, 3 years. Protocol says 'longest follow-up' but reviewers disagree on interpretation.",
        question: "How would you resolve this?",
        options: [
          { letter: "A", text: "Vote on which interpretation to use", correct: false },
          { letter: "B", text: "Prepare Consult Pack with options and trade-offs", correct: true },
          { letter: "C", text: "Let the Integrator decide alone", correct: false },
          { letter: "D", text: "Use both interpretations as sensitivity", correct: false }
        ],
        feedback: {
          correct: "Correct! The Consult Pack forces structured thinking. They chose: 'Longest ‚â•1 year, else longest available.'",
          incorrect: "A Consult Pack was prepared with evidence and options. 15 minutes of structured discussion prevented hours of rework."
        }
      }},
      { type: "decision", theme: "red-bg", content: {
        icon: "2Ô∏è‚É£", title: "Crisis 2: The Swapped Arms",
        xp: 30,
        scenario: "Day 14. Red-team pulls COLCOT (n=4,745). Forest plot shows colchicine INCREASES events‚Äîopposite of all other trials. Investigation reveals: Figure 3 bars were unlabeled, extractor assumed wrong direction.",
        question: "What saved this review?",
        options: [
          { letter: "A", text: "The Integrator's intuition", correct: false },
          { letter: "B", text: "The Red-Team daily micro-check", correct: true },
          { letter: "C", text: "Peer review before publication", correct: false },
          { letter: "D", text: "Statistical outlier detection", correct: false }
        ],
        feedback: {
          correct: "Exactly! The Red-Team system caught what collaborative review would have missed. Influential studies get adversarial checking.",
          incorrect: "The Red-Team daily check caught this. Fatima noticed COLCOT's direction was opposite‚Äîimpossible if the drug truly worked differently in one trial."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "3Ô∏è‚É£", title: "Crisis 3: The Post-Hoc Idea",
        xp: 25,
        scenario: "Day 22. Clinical advisor suggests: 'Three trials used 0.5mg, five used 1mg. Shouldn't you analyze by dose?' He's probably right scientifically.",
        question: "What's the correct response?",
        options: [
          { letter: "A", text: "Change primary analysis to split by dose", correct: false },
          { letter: "B", text: "Ignore the suggestion‚Äîtoo late to change", correct: false },
          { letter: "C", text: "Add as exploratory sensitivity, label post-hoc", correct: true },
          { letter: "D", text: "Go back and add dose to the protocol", correct: false }
        ],
        feedback: {
          correct: "Perfect! Good ideas after Day 3 go in sensitivity, clearly labelled post-hoc. Primary analysis stays protected.",
          incorrect: "The protocol protects you from yourself. Add it as SENSITIVITY analysis, label it 'exploratory, post-hoc.'"
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "4Ô∏è‚É£", title: "Crisis 4: The Rerun Mismatch",
        xp: 25,
        scenario: "Day 31. Audit 2 reruns: Analyst A gets I¬≤=34.2%, Analyst B gets I¬≤=31.8%. Tolerance is 1%. Difference: 2.4%.",
        question: "What was the root cause?",
        options: [
          { letter: "A", text: "Different software versions", correct: false },
          { letter: "B", text: "One SE rounded to 2 decimals instead of 4", correct: true },
          { letter: "C", text: "Different random seeds", correct: false },
          { letter: "D", text: "Typo in study inclusion", correct: false }
        ],
        feedback: {
          correct: "Right! Line-by-line found Nidorf 2020 SE: 0.0847 vs 0.08. A 0.0047 difference created 2.4% I¬≤ change.",
          incorrect: "Line-by-line comparison found one SE was rounded to 2 decimals (0.08) instead of 4 (0.0847). 'Close enough' isn't."
        }
      }},
      { type: "stats", theme: "green-bg", content: {
        title: "The Result",
        stats: [
          { value: "RR 0.65", label: "95% CI: 0.49‚Äì0.88" },
          { value: "I¬≤ 34%", label: "Low-moderate" },
          { value: "9/9", label: "Audit-Grade" }
        ],
        caption: "Colchicine reduces major cardiac events by ~35%. The system caught all 4 crises."
      }},
      { type: "lesson", theme: "dark", content: {
        title: "Why the System Worked",
        lessons: [
          { title: "Crisis 1 ‚Üí Consult Pack", desc: "Structured discussion prevented rework" },
          { title: "Crisis 2 ‚Üí Red-Team", desc: "Adversarial checking caught the swap" },
          { title: "Crisis 3 ‚Üí Deviation Log", desc: "Good ideas captured safely" },
          { title: "Crisis 4 ‚Üí Rerun Tolerance", desc: "Precision requirements caught silent errors" }
        ]
      }},
      { type: "story", theme: "dark", content: {
        label: "The VIGOR Trial", title: "The Missing Heart Attacks",
        text: "In 2000, Merck published the VIGOR trial for Vioxx. The paper showed a 4-fold increase in heart attacks compared to naproxen. But here's what they didn't tell you: three more heart attacks occurred <strong>after the data cutoff</strong>. Merck scientists knew about them. They didn't include them.",
        followup: "Why did it matter? Including those three heart attacks would have changed the risk ratio from concerning to alarming. Instead, the published paper suggested the difference might be because naproxen protected hearts‚Äînot because Vioxx damaged them. The data cutoff date was a decision. That decision cost lives."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚úÇÔ∏è", title: "Scenario: The Convenient Cutoff",
        xp: 25,
        scenario: "You're extracting data from a trial. The protocol specified follow-up to 12 months. The published paper reports 6-month data only. A footnote says 'additional events occurred after 6 months but were not included in the primary analysis.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Use the 6-month data as published", correct: false },
          { letter: "B", text: "Contact authors to obtain complete follow-up data", correct: true },
          { letter: "C", text: "Exclude the study due to selective reporting", correct: false },
          { letter: "D", text: "Note the discrepancy in your risk of bias assessment", correct: false }
        ],
        feedback: {
          correct: "Correct! The VIGOR lesson: data cutoffs can hide safety signals. Three missing heart attacks changed Vioxx from 'concerning' to 'alarming.' Always seek complete data.",
          incorrect: "The VIGOR trial excluded post-cutoff heart attacks that would have changed conclusions. Convenient cutoffs can hide critical safety signals. Obtain complete data."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Hormone Test Tragedy", title: "Primodos and the Children It Damaged",
        text: "In the 1960s and 70s, doctors prescribed <strong>Primodos</strong>‚Äîa high-dose hormone pill‚Äîas a pregnancy test. Take two pills; if you bleed, you're not pregnant. Simple. Convenient. Millions of women used it. <strong>No one ran trials to check if it harmed unborn babies.</strong>",
        followup: "Then the birth defects appeared. Cleft palates. Heart malformations. Limb abnormalities. Women who had taken Primodos and were actually pregnant‚Äîthe test had failed‚Äîgave birth to damaged children. Decades later, researchers analyzed the data: exposure to Primodos was associated with a <strong>40% increase in congenital abnormalities</strong>. The manufacturer had received reports of problems for years. They kept selling. An official UK review in 2017 found 'clear evidence' of an association. The lesson: 'it seems to work' is not evidence. 'It seems safe' is not safety data. Pregnancy exposures demand the highest burden of proof."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üß™", title: "Scenario: The Convenient Test",
        xp: 25,
        scenario: "A new home pregnancy test uses a novel chemical that provides results in seconds rather than minutes. It's been used by millions with no apparent acute harms. However, some women test early enough that the chemical might affect developing embryos in those who are actually pregnant.",
        question: "What evidence should exist before widespread marketing?",
        options: [
          { letter: "A", text: "Absence of reported harms is sufficient for a diagnostic test", correct: false },
          { letter: "B", text: "Long-term follow-up of pregnancy outcomes in exposed women vs. controls", correct: true },
          { letter: "C", text: "Animal teratology studies are sufficient for short exposures", correct: false },
          { letter: "D", text: "Post-marketing surveillance will detect any problems", correct: false }
        ],
        feedback: {
          correct: "Correct! Primodos damage wasn't detected for decades because no one tracked pregnancy outcomes. Any exposure during potential pregnancy needs systematic outcome tracking‚Äînot passive surveillance.",
          incorrect: "Primodos harmed babies for years while 'no one noticed.' Pregnancy exposures need proactive outcome tracking. Post-marketing surveillance fails for birth defects‚Äîthe connection is hard to prove later."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Baycol Catastrophe", title: "The Statin That Dissolved Muscles",
        text: "In 1997, Bayer launched cerivastatin (Baycol) to compete in the lucrative statin market. It was the most potent statin ever‚Äîlowering cholesterol more effectively than competitors. Bayer pushed aggressive dosing. They promoted combining it with gemfibrozil for even greater cholesterol reduction. Sales reached $500 million annually.",
        followup: "Patients started dying. Their muscles were dissolving‚Äîa condition called <strong>rhabdomyolysis</strong>. Breakdown products overwhelmed kidneys. By the time Bayer withdrew Baycol in 2001, at least <strong>100 patients had died and over 1,500 were hospitalized</strong>. Internal documents revealed Bayer knew the risk was higher than competitors. They knew the gemfibrozil combination was especially dangerous. They kept promoting both. The 'most effective' statin became the deadliest. More aggressive isn't always better‚Äîsometimes it's fatal."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìà", title: "Scenario: The Aggressive Approach",
        xp: 25,
        scenario: "A new drug shows more powerful effects than existing treatments at higher doses. The manufacturer wants to market the highest effective dose as standard. Competitors use lower doses with good safety profiles. Some early reports mention serious muscle-related adverse events.",
        question: "What should guide dosing recommendations?",
        options: [
          { letter: "A", text: "Maximum efficacy should be the goal‚Äîthat's why patients take medication", correct: false },
          { letter: "B", text: "Lowest effective dose with systematic safety monitoring; investigate all serious events", correct: true },
          { letter: "C", text: "Match competitor dosing for market positioning", correct: false },
          { letter: "D", text: "Let prescribers choose based on patient cholesterol levels", correct: false }
        ],
        feedback: {
          correct: "Correct! Baycol's aggressive dosing killed patients. Muscle events were warning signals. The safest effective dose‚Äînot the most powerful‚Äîshould be standard. Early serious events demand investigation, not dismissal.",
          incorrect: "Baycol was the 'most potent' statin‚Äîand the deadliest. More isn't better when the margin between efficacy and toxicity narrows. Early serious adverse events are signals, not noise."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Near Miss", title: "What If We Hadn't Checked?",
        text: "In the colchicine review, COLCOT contributed 40% of the total weight. If the swapped arms had gone undetected, the meta-analysis would have concluded: <strong>'Colchicine appears to INCREASE cardiac events.'</strong> The opposite of reality.",
        followup: "Doctors might have withheld an effective treatment. Patients who could have been helped would have been denied. One extraction error, undetected, could have reversed clinical practice. The Red-Team check took 15 minutes. The cost of missing it? Incalculable."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚öñÔ∏è", title: "Scenario: The 15-Minute Question",
        xp: 25,
        scenario: "Your team is behind schedule. The largest trial (45% of total weight) hasn't been Red-Team verified. Someone suggests skipping it 'because the extraction was done by our most experienced person.'",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Skip it‚Äîexperience reduces error rates", correct: false },
          { letter: "B", text: "Verify it‚Äîinfluential studies always get checked", correct: true },
          { letter: "C", text: "Spot-check one data point instead of full verification", correct: false },
          { letter: "D", text: "Trust but add a note about limited verification time", correct: false }
        ],
        feedback: {
          correct: "Correct! The colchicine near-miss: 15 minutes of Red-Team checking caught an error that would have reversed conclusions. Experience doesn't eliminate errors‚Äîverification does.",
          incorrect: "The COLCOT error was made by an experienced extractor. The Red-Team check took 15 minutes. Skipping verification of influential studies risks catastrophic errors."
        }
      }}
    ]
  },
  {
    id: 9, title: "Final Assessment", subtitle: "Prove your mastery", xp: 300,
    slides: [
      { type: "title", theme: "dark", content: { title: "Final Assessment", subtitle: "Apply everything you've learned" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Apply META-SPRINT principles to complex scenarios",
          "Demonstrate understanding of protocol integrity",
          "Handle crisis situations correctly",
          "Uphold ethical reporting standards"
        ],
        tip: "Three challenging scenarios. Answer all correctly for the perfect module bonus!"
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üéØ", title: "Final Scenario 1: The Protocol Pressure",
        xp: 40,
        scenario: "Your supervisor wants to start screening tomorrow. Protocol is drafted but not yet registered on PROSPERO (takes 24-48h). 'Just start‚Äîwe can register later.'",
        question: "What do you do?",
        options: [
          { letter: "A", text: "Start screening‚Äîregistration is just paperwork", correct: false },
          { letter: "B", text: "Wait for registration before any data collection", correct: true },
          { letter: "C", text: "Start screening but don't record results yet", correct: false },
          { letter: "D", text: "Submit to a faster registry service", correct: false }
        ],
        feedback: {
          correct: "Correct! Registration timestamps your promises. Starting before registration enables outcome switching‚Äîthe 31% problem.",
          incorrect: "Registration must happen BEFORE any data collection. This prevents the 31% outcome switching problem."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî•", title: "Final Scenario 2: The Crisis",
        xp: 40,
        scenario: "Day 33. Your rerun shows RR=0.72. Collaborator's shows RR=0.68. Both significant but outside tolerance. You have 6 hours until DoD-D deadline.",
        question: "What's your first action?",
        options: [
          { letter: "A", text: "Average to 0.70 and proceed", correct: false },
          { letter: "B", text: "Line-by-line input comparison", correct: true },
          { letter: "C", text: "Trigger CondGO immediately", correct: false },
          { letter: "D", text: "Ask both analysts to re-run again", correct: false }
        ],
        feedback: {
          correct: "Correct! Line-by-line comparison finds the discrepancy source. In 6 hours, you might fix it without needing CondGO.",
          incorrect: "First: find the source of discrepancy. Line-by-line comparison. Most mismatches have fixable causes."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "‚öñÔ∏è", title: "Final Scenario 3: The Ethical Edge",
        xp: 40,
        scenario: "Your meta-analysis shows Drug X is harmful (RR 1.35, CI 1.10-1.65). The pharmaceutical company that funded your review asks you to 'reframe' it as 'not significantly beneficial.'",
        question: "How do you respond?",
        options: [
          { letter: "A", text: "They're technically correct‚Äîreframe as requested", correct: false },
          { letter: "B", text: "Report the finding accurately: harm detected", correct: true },
          { letter: "C", text: "Compromise: say 'insufficient evidence of benefit'", correct: false },
          { letter: "D", text: "Add sensitivity analyses until harm disappears", correct: false }
        ],
        feedback: {
          correct: "Correct! RR 1.35 with CI excluding 1.0 is harm. Report it accurately. The Avandia story: suppressing harm signals kills patients.",
          incorrect: "RR 1.35 (CI 1.10-1.65) = statistically significant HARM. Report it accurately. The Avandia scandal: silence killed tens of thousands."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Cost of Waiting", title: "What Silence Buys",
        text: "Between 2000 and 2004, while Merck debated what to do about Vioxx, <strong>25,000 people died</strong> from heart attacks caused by a drug they trusted. Between 1999 and 2007, while GSK buried the Avandia spreadsheet, <strong>83,000 people suffered heart attacks</strong> from a diabetes drug that was supposed to help them.",
        followup: "These weren't accidents. They weren't unknowable. They were the predictable result of systems without deadlines, evidence without verification, and people who decided that 'wait and see' was safer than 'stop and check.' Every day of delay had a body count."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üìÖ", title: "Scenario: The Comfortable Delay",
        xp: 30,
        scenario: "Your systematic review found clear evidence of harm. Your institution wants to 'wait for peer review feedback' before making any public statements. The peer review process typically takes 6-12 months.",
        question: "What should you do?",
        options: [
          { letter: "A", text: "Wait for peer review‚Äîproper process matters", correct: false },
          { letter: "B", text: "Post a preprint immediately while pursuing publication", correct: true },
          { letter: "C", text: "Share findings privately with key opinion leaders", correct: false },
          { letter: "D", text: "Accelerate peer review by submitting to multiple journals", correct: false }
        ],
        feedback: {
          correct: "Correct! Vioxx: 4 years of 'waiting' = 25,000 deaths. Avandia: 7 years = 83,000 heart attacks. When evidence shows harm, delay is not neutral‚Äîit's harmful. Preprint immediately.",
          incorrect: "Vioxx and Avandia: 'waiting' killed over 100,000 people combined. When evidence shows harm, every day of delay has a body count. Preprint findings immediately."
        }
      }},
      { type: "story", theme: "green-bg", content: {
        label: "The Other Path", title: "Frances Kelsey's 19 Months",
        text: "In 1960, the FDA received an application to approve thalidomide in America. One reviewer‚ÄîFrances Kelsey‚Äîrefused to approve it. The manufacturer pressured her. Her colleagues questioned her. She held firm for <strong>19 months</strong>, demanding evidence of safety.",
        followup: "While she waited, 10,000 children were born with deformities in countries that had approved the drug. American children were spared‚Äînot by luck, but by one person who demanded proof before action. Kelsey proved that asking for evidence isn't obstruction. It's protection. META-SPRINT exists to make that protection systematic."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üõ°Ô∏è", title: "Scenario: The Pressure to Approve",
        xp: 30,
        scenario: "You're reviewing a new treatment. The manufacturer says your 'excessive demands for evidence' are delaying access to a potentially life-saving drug. Your colleagues suggest you're 'being too cautious.' Industry lawyers hint at legal action for 'obstruction.'",
        question: "What should guide your decision?",
        options: [
          { letter: "A", text: "Speed up approval‚Äîpatients are waiting", correct: false },
          { letter: "B", text: "Maintain evidence standards regardless of pressure", correct: true },
          { letter: "C", text: "Compromise with conditional approval", correct: false },
          { letter: "D", text: "Escalate to supervisors to share responsibility", correct: false }
        ],
        feedback: {
          correct: "Correct! Frances Kelsey was called 'bureaucratic' for 19 months while 10,000 children in other countries were harmed. She saved thousands of American children. Evidence standards save lives.",
          incorrect: "Kelsey was pressured for 19 months to approve thalidomide. Her 'obstruction' saved thousands of children. Pressure and urgency are not evidence. Standards protect patients."
        }
      }},
      { type: "story", theme: "red-bg", content: {
        label: "The Rezulin Disaster", title: "The Diabetes Drug That Destroyed Livers",
        text: "In 1997, Warner-Lambert launched troglitazone (Rezulin) as a revolutionary diabetes treatment. The FDA approved it despite a medical officer's objections about liver toxicity signals. <strong>Within months, reports of liver failure poured in.</strong> The UK banned it in December 1997. Japan banned it in 2000.",
        followup: "The FDA kept Rezulin on the American market until March 2000‚Äî<strong>three years after the UK acted</strong>. During those three years, at least 90 Americans died of liver failure from a drug banned elsewhere. FDA's own scientists had warned of the danger. They were overruled. When Rezulin was finally withdrawn, internal documents revealed Warner-Lambert had hidden early liver toxicity data and downplayed risks. The gap between the UK ban and US withdrawal: three years. The cost: dozens of preventable deaths. Different regulators, same data, vastly different responses."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üåç", title: "Scenario: The Regulatory Divergence",
        xp: 30,
        scenario: "A drug you're reviewing in a meta-analysis was withdrawn in Europe for safety concerns 2 years ago but remains available in your country. Local regulators cite 'insufficient evidence of harm in our population.' European trials showed clear liver toxicity signals.",
        question: "How should this affect your systematic review?",
        options: [
          { letter: "A", text: "Use only data from your country‚Äîregulatory decisions vary", correct: false },
          { letter: "B", text: "Include all data and prominently report the regulatory divergence in discussion", correct: true },
          { letter: "C", text: "Exclude the drug entirely due to safety concerns", correct: false },
          { letter: "D", text: "Trust your local regulators' interpretation", correct: false }
        ],
        feedback: {
          correct: "Correct! Rezulin killed Americans for 3 years after the UK acted. Your review should include all safety data and highlight regulatory divergences. Readers need complete information, not filtered by geographic borders.",
          incorrect: "Rezulin was banned in UK in 1997; Americans died until 2000. Regulatory decisions aren't evidence‚Äîthey're interpretations. Include all data and report divergences so readers can judge."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Ketek Scandal", title: "The Antibiotic Built on Fabricated Trials",
        text: "In 2004, the FDA approved telithromycin (Ketek) for respiratory infections. The approval relied heavily on a large trial‚ÄîStudy 3014‚Äîconducted by Dr. Anne Kirkman-Campbell. She enrolled <strong>407 patients in just 9 months</strong> from a solo practice. Impossible numbers, but the FDA didn't question them.",
        followup: "Dr. Kirkman-Campbell was later convicted of fraud. She had <strong>fabricated patient enrollment entirely</strong>‚Äîsome 'patients' were relatives who never had infections. But her fake data had already supported FDA approval. When real-world use began, Ketek caused liver failures, some fatal. An FDA reviewer had flagged Study 3014's impossible enrollment before approval‚Äîshe was overruled. The drug that was approved based partly on invented patients went on to harm real ones. The question no one asked: 'How can one doctor enroll 400 patients in conditions that would take a large hospital years?'"
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üî¢", title: "Scenario: The Super-Enroller",
        xp: 30,
        scenario: "A pivotal drug trial includes data from a solo practitioner who enrolled 350 patients in 6 months‚Äîmore than the next 10 sites combined. Site monitoring reports are marked 'satisfactory.' The trial shows strong efficacy.",
        question: "What verification should occur before regulatory decisions?",
        options: [
          { letter: "A", text: "Site monitoring passed, so the data is verified", correct: false },
          { letter: "B", text: "Audit source documents: patient records, consent forms, medical histories", correct: true },
          { letter: "C", text: "Run the analysis with and without this site's data", correct: false },
          { letter: "D", text: "Contact the investigator for explanation of high enrollment", correct: false }
        ],
        feedback: {
          correct: "Correct! Kirkman-Campbell passed site monitoring while fabricating 407 patients. Source document verification‚Äîactual patient records‚Äîwould have caught her. Self-reported enrollment data and 'satisfactory' monitoring mean nothing.",
          incorrect: "Dr. Kirkman-Campbell's site passed monitoring. Her patients didn't exist. Source document audits‚Äînot self-reports‚Äîcatch fabrication. Impossible enrollment rates demand verification of original records."
        }
      }},
      { type: "story", theme: "dark", content: {
        label: "The Promise", title: "What Trustworthy Evidence Creates",
        text: "In 1987, the ISIS-2 trial showed aspirin reduces death after heart attack by 23%. The evidence was solid. The methods were transparent. The data was verifiable. Since then, aspirin after heart attack has saved an estimated <strong>100,000 lives per year</strong>.",
        followup: "That's what honest evidence creates: treatments that work, given to people who need them, saving lives that would otherwise be lost. Every protocol you register, every number you verify, every gate you pass‚Äîyou're building the foundation for the next ISIS-2. The next treatment that actually works. The next million lives saved."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "üåü", title: "Scenario: Your First Review",
        xp: 30,
        scenario: "You're about to start your first systematic review. A senior colleague offers advice: 'Don't worry too much about all these protocols and checklists. Just do good work and the evidence will speak for itself.'",
        question: "How should you respond?",
        options: [
          { letter: "A", text: "Follow their advice‚Äîexperience beats process", correct: false },
          { letter: "B", text: "Follow META-SPRINT rigorously‚Äîsystems prevent disasters", correct: true },
          { letter: "C", text: "Adapt the process to your specific situation", correct: false },
          { letter: "D", text: "Use a lighter version for your first review, then improve", correct: false }
        ],
        feedback: {
          correct: "Correct! Good intentions don't prevent errors. ISIS-2's aspirin evidence saved 100,000 lives/year because it was rigorous. Poldermans' fraud killed 800,000 because no one verified. Systems, not intentions, protect patients.",
          incorrect: "'Good work' without systems led to Poldermans, CAST, Vioxx, Avandia. ISIS-2 saved millions because of rigorous methods. The difference between 100,000 saved and 800,000 killed is systematic verification."
        }
      }},
      { type: "stats", theme: "green-bg", content: {
        title: "Course Complete!",
        stats: [
          { value: "5", label: "Phases mastered" },
          { value: "5", label: "Gates understood" },
          { value: "8", label: "Modules completed" },
          { value: "‚àû", label: "Patients protected" }
        ],
        caption: "You now understand how to produce evidence that saves lives."
      }},
      { type: "refrain", theme: "black", content: { text: "Go build trust. 40 days. 5 gates. Evidence that matters." }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = gameState.consecutiveCorrect || 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('metasprintGame_v1', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [], perfectModules: [], consecutiveCorrect: 0 };
    consecutiveCorrect = 0;
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== GLOSSARY =====
function toggleGlossary() {
  document.getElementById('glossaryPanel').classList.toggle('open');
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== MODULE QUESTION TRACKING =====
function getModuleQuestionIds(moduleIndex) {
  const mod = MODULES[moduleIndex];
  const ids = [];
  mod.slides.forEach((slide, si) => {
    if (slide.type === 'decision') ids.push(`dec_${moduleIndex}_${si}`);
    if (slide.type === 'quiz') ids.push(`quiz_${moduleIndex}_${si}`);
    if (slide.type === 'prediction') ids.push(`pred_${moduleIndex}_${si}`);
  });
  return ids;
}

function checkPerfectModule(moduleIndex) {
  const mod = MODULES[moduleIndex];
  const questionIds = getModuleQuestionIds(moduleIndex);
  if (questionIds.length === 0) return false;

  let allCorrect = true;
  questionIds.forEach(id => {
    const answer = gameState.answeredQuestions[id];
    if (answer === undefined || answer === null) { allCorrect = false; return; }

    // Find the slide and check if answer was correct
    const parts = id.split('_');
    const slideIndex = parseInt(parts[2]);
    const slide = mod.slides[slideIndex];

    if (slide.type === 'decision') {
      const correctOpt = slide.content.options.find(o => o.correct);
      if (answer !== correctOpt?.letter) allCorrect = false;
    } else if (slide.type === 'quiz') {
      const correctIdx = slide.content.options.findIndex(o => o.correct);
      if (answer !== correctIdx) allCorrect = false;
    } else if (slide.type === 'prediction') {
      if (answer !== slide.content.answer) allCorrect = false;
    }
  });

  return allCorrect;
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
  showBadgeModal({ icon: levelData.icon, name: `Level ${levelData.level}`, desc: levelData.title });
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function awardBadgeIfNew(id, icon, name, desc) {
  if (gameState.badges.includes(id)) return;
  gameState.badges.push(id);
  saveGame();
  showBadgeModal({ icon, name, desc });
  updateBadges();
}

function showBadgeModal(badge) {
  const modal = document.getElementById('badgeModal');
  // Remove any existing focus trap handler before adding a new one
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
  }
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  modal.classList.add('show');
  triggerConfetti();

  // Focus trap for accessibility
  const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
  if (focusableElements.length > 0) {
    focusableElements[0].focus();
  }
  const trapHandler = function(e) {
    if (e.key === 'Escape') {
      closeBadgeModal();
      return;
    }
    if (e.key === 'Tab') {
      const firstFocusable = focusableElements[0];
      const lastFocusable = focusableElements[focusableElements.length - 1];
      if (e.shiftKey && document.activeElement === firstFocusable) {
        e.preventDefault();
        lastFocusable.focus();
      } else if (!e.shiftKey && document.activeElement === lastFocusable) {
        e.preventDefault();
        firstFocusable.focus();
      }
    }
  };
  modal._focusTrapHandler = trapHandler;
  modal.addEventListener('keydown', trapHandler);
}

function closeBadgeModal() {
  const modal = document.getElementById('badgeModal');
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    delete modal._focusTrapHandler;
  }
  modal.classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  // Respect reduced motion preference
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;

  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#7c3aed'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO COUNTER =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');

  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');

    // Animate for big combos
    if (consecutiveCorrect >= 5) {
      comboEl.classList.add('big');
      setTimeout(() => comboEl.classList.remove('big'), 300);
    }
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebarOverlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle, .hamburger, .mobile-menu-btn'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('predictCount').textContent = gameState.predictionsCorrect;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    let progress = '';

    // Show progress for certain badges
    if (!earned) {
      if (b.id === 'oracle') progress = `${gameState.predictionsCorrect}/5`;
      if (b.id === 'decision_maker') progress = `${gameState.decisionsCompleted}/10`;
      if (b.id === 'streak_3') progress = `${Math.min(gameState.streak, 3)}/3`;
      if (b.id === 'streak_7') progress = `${Math.min(gameState.streak, 7)}/7`;
      if (b.id === 'finisher') progress = `${gameState.completedModules.length}/${MODULES.length}`;
    }

    return `
      <button class="badge-item ${earned ? 'earned' : ''}" data-tooltip="${b.name}: ${b.desc}" aria-label="${b.name}: ${b.desc}${earned ? ' (Earned)' : ''}">
        ${b.icon}
        ${progress && !earned ? `<span class="badge-progress">${progress}</span>` : ''}
      </button>
    `;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    // Estimate ~1.5 min per slide
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           role="button"
           tabindex="${locked ? -1 : 0}"
           aria-label="${mod.title}${completed ? ' (completed)' : ''}${locked ? ' (locked)' : ''}">
        <div class="module-number">${completed ? '‚úì' : (locked ? 'üîí' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">‚è±Ô∏è ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('main-content');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn" onclick="prevSlide()" aria-label="Previous slide" ${currentSlide === 0 ? 'disabled' : ''}>‚Üê</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn" onclick="nextSlide()" aria-label="Next slide">‚Üí</button>
      </div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">üéØ</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'summary':
      const modXP = MODULES[moduleIndex]?.xp || 0;
      const isPerfect = checkPerfectModule(moduleIndex);
      html += `<div class="content">
        <div class="summary-box animate">
          <div class="summary-icon">üéâ</div>
          <div class="summary-title">Module Complete!</div>
          <div class="summary-stats">
            <div class="summary-stat">
              <div class="summary-stat-value">+${modXP}</div>
              <div class="summary-stat-label">XP Earned</div>
            </div>
            <div class="summary-stat">
              <div class="summary-stat-value">${gameState.correctAnswers}</div>
              <div class="summary-stat-label">Total Correct</div>
            </div>
          </div>
          ${isPerfect ? `<div class="perfect-bonus animate delay-1">‚≠ê PERFECT MODULE +${Math.round(modXP * 0.5)} XP ‚≠ê</div>` : ''}
          <p class="subtitle" style="margin-top:1rem;font-size:0.85rem">${slide.content.summary || 'Great work! Continue to the next module.'}</p>
          <button class="summary-next animate delay-2" onclick="nextSlide()">Continue to Next Module ‚Üí</button>
        </div>
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} animate" role="article" aria-label="Case study: ${slide.content.label}">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'lesson':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        <div class="animate delay-1">
          ${slide.content.lessons.map((l, i) => `
            <div class="lesson-item">
              <div class="lesson-number">${i + 1}</div>
              <div class="lesson-content"><h4>${l.title}</h4><p>${l.desc}</p></div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'timeline':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="timeline animate delay-1">
          ${slide.content.items.map(item => `
            <div class="timeline-item phase-${item.phase || ''}">
              <div class="timeline-days">${item.days}</div>
              <div class="timeline-content">
                <div class="timeline-title">${item.title}</div>
                <div class="timeline-desc">${item.desc}</div>
              </div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">‚úì</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
        ${slide.content.allowed ? `
          <div class="card green-border animate delay-2" style="margin-top:0.75rem">
            <div class="card-label" style="color:var(--green)">‚úì Allowed</div>
            <ul style="margin-left:1.25rem;font-size:0.9rem">${slide.content.allowed.map(a => `<li>${a}</li>`).join('')}</ul>
          </div>
          <div class="card red-border animate delay-3">
            <div class="card-label" style="color:var(--red)">‚úó Forbidden</div>
            <ul style="margin-left:1.25rem;font-size:0.9rem">${slide.content.forbidden.map(f => `<li>${f}</li>`).join('')}</ul>
          </div>
        ` : ''}
      </div>`;
      break;

    case 'takeaway':
      html += `<div class="content">
        <div class="takeaway-card animate">
          <div class="takeaway-label"><span class="takeaway-icon">üí°</span>Key Takeaway</div>
          <p class="takeaway-text">${slide.content.text}</p>
        </div>
      </div>`;
      break;

    case 'prediction':
      const pid = `pred_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[pid];
      html += `<div class="content">
        <div class="prediction-panel animate" id="${pid}_panel">
          <div class="prediction-icon">${slide.content.icon}</div>
          <div class="prediction-title">${slide.content.title}</div>
          <p class="prediction-subtitle">${slide.content.subtitle}</p>
          <div class="prediction-buttons" id="${pid}_buttons">
            ${slide.content.options.map(opt => `
              <button class="predict-btn ${opt.id === 'benefit' ? 'benefit' : opt.id === 'harm' ? 'harm' : 'neutral'} ${answered === opt.id ? 'selected' : ''}"
                      onclick="makePrediction('${pid}', '${opt.id}', '${slide.content.answer}', ${slide.content.xp})"
                      ${answered ? 'disabled' : ''}>
                ${opt.label}<br><small>${opt.text}</small>
              </button>
            `).join('')}
          </div>
          <div class="prediction-result ${answered ? 'show' : ''} ${answered === slide.content.answer ? 'correct' : 'incorrect'}" id="${pid}_result">
            ${answered === slide.content.answer ? '‚úì Your intuition was right!' : answered ? '‚úó The data surprised you‚Äîgood to know!' : ''}
          </div>
        </div>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const decAnswered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div><div class="decision-title">${slide.content.title}</div></div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options" id="${did}_options">
            ${slide.content.options.map((opt, oi) => `
              <div class="decision-option ${decAnswered === opt.letter ? (opt.correct ? 'correct' : 'incorrect') : ''} ${decAnswered && opt.correct ? 'correct' : ''} ${decAnswered ? 'disabled' : ''}"
                   onclick="makeDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                   tabindex="${decAnswered ? -1 : 0}"
                   role="button"
                   aria-label="Option ${opt.letter}: ${opt.text}"
                   onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();makeDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp});}">
                <div class="option-letter">${opt.letter}</div>
                <div class="option-text">${opt.text}</div>
              </div>
            `).join('')}
          </div>
          <div class="decision-feedback ${decAnswered ? 'show' : ''} ${decAnswered && slide.content.options.find(o => o.letter === decAnswered)?.correct ? 'correct' : 'incorrect'}" id="${did}_feedback">
            <div class="feedback-title">${decAnswered && slide.content.options.find(o => o.letter === decAnswered)?.correct ? '‚úì Correct!' : '‚úó Not quite'}</div>
            <div class="feedback-text">${decAnswered && slide.content.options.find(o => o.letter === decAnswered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
          </div>
        </div>
      </div>`;
      break;

    case 'quiz':
      const qid = `quiz_${moduleIndex}_${index}`;
      const qAnswered = gameState.answeredQuestions[qid];
      html += `<div class="content">
        <div class="quiz-container animate">
          <p class="quiz-question">${slide.content.question}</p>
          <div class="quiz-options" id="${qid}_options">
            ${slide.content.options.map((opt, i) => `
              <div class="quiz-option ${qAnswered === i ? (opt.correct ? 'correct' : 'incorrect') : ''} ${qAnswered !== undefined && opt.correct ? 'correct' : ''} ${qAnswered !== undefined ? 'disabled' : ''}"
                   onclick="answerQuiz('${qid}', ${i}, ${opt.correct}, ${slide.content.xp || 20})">
                ${opt.text}
              </div>
            `).join('')}
          </div>
          <div class="quiz-feedback ${qAnswered !== undefined ? 'show' : ''} ${qAnswered !== undefined && slide.content.options[qAnswered]?.correct ? 'correct' : 'incorrect'}" id="${qid}_feedback">
            ${qAnswered !== undefined ? (slide.content.options[qAnswered]?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect) : ''}
          </div>
        </div>
      </div>`;
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const moduleSlides = document.querySelector(`.module-slides[data-module="${currentModule}"]`);
  if (!moduleSlides) return;
  moduleSlides.querySelectorAll('.slide').forEach((slide, i) => slide.classList.toggle('active', i === currentSlide));
  const counter = moduleSlides.querySelector('.slide-counter');
  if (counter) counter.textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  moduleSlides.querySelectorAll('.progress-dot').forEach((dot, i) => dot.classList.toggle('active', i === currentSlide));
  const prevBtn = moduleSlides.querySelector('.nav-btn:first-child');
  if (prevBtn) prevBtn.disabled = currentSlide === 0;
}

// ===== INTERACTIONS =====
function makePrediction(pid, choice, answer, xp) {
  if (gameState.answeredQuestions[pid]) return;
  gameState.answeredQuestions[pid] = choice;
  gameState.predictionsTotal++;

  const correct = choice === answer;
  if (correct) {
    gameState.predictionsCorrect++;
    addXP(xp);
    if (gameState.predictionsCorrect >= 5) awardBadge('oracle');
  }
  saveGame();
  renderSlides();
}

function makeDecision(did, choice, correct, xp) {
  if (gameState.answeredQuestions[did]) return;
  gameState.answeredQuestions[did] = choice;
  gameState.decisionsCompleted++;

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (gameState.correctAnswers === 1) awardBadge('first_blood');
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 10) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateReviewButton();
  updateComboDisplay();
}

function answerQuiz(qid, choice, correct, xp) {
  if (gameState.answeredQuestions[qid] !== undefined) return;
  gameState.answeredQuestions[qid] = choice;

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (gameState.correctAnswers === 1) awardBadge('first_blood');
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
  } else {
    consecutiveCorrect = 0;
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateReviewButton();
  updateComboDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Check for perfect module (all questions correct)
    if (checkPerfectModule(currentModule) && !gameState.perfectModules.includes(mod.id)) {
      gameState.perfectModules.push(mod.id);
      const bonusXP = Math.round(mod.xp * 0.5);
      addXP(bonusXP);
      showPerfectBonus(bonusXP);
    }

    // Check for module-specific badges
    if (mod.id === 3) awardBadge('protocol_pro');
    if (mod.id === 4) awardBadge('search_savant');
    if (mod.id === 5) awardBadge('data_detective');
    if (mod.id === 6) awardBadge('stats_wizard');
    if (mod.id === 8) awardBadge('colchicine_hero');
    if (gameState.completedModules.length === MODULES.length) {
      awardBadge('finisher');
      setTimeout(showCompletionModal, 500);
    }

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  }
}

function showPerfectBonus(xp) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').innerHTML = `+${xp}<br><small style="font-size:0.8rem">PERFECT!</small>`;
  popup.classList.add('show');
  setTimeout(() => {
    popup.classList.remove('show');
    document.getElementById('xpAmount').textContent = '+0';
  }, 2000);
}

// ===== CERTIFICATE DOWNLOAD =====
function downloadCertificate() {
  const courseName = 'META-SPRINT: 40 Days to Trustworthy Evidence';
  const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const level = LEVELS[gameState.level - 1] || LEVELS[0];
  const badgeCount = gameState.badges.length;
  const totalXP = gameState.xp;

  const certHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate of Completion - ${courseName}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Sans Pro', sans-serif; background: #f5f5f5; padding: 20px; }
    .certificate {
      max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #1E2761 0%, #141B3D 100%);
      border: 8px solid #D4AF37; border-radius: 12px; padding: 60px 50px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .cert-header { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 1rem; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 10px; }
    .cert-title { font-family: 'Cormorant Garamond', serif; color: #FAF8F5; font-size: 3rem; font-weight: 700; margin-bottom: 30px; }
    .cert-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 40px; }
    .cert-course { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 2rem; font-weight: 600; margin-bottom: 15px; padding: 20px; border-top: 1px solid rgba(212,175,55,0.3); border-bottom: 1px solid rgba(212,175,55,0.3); }
    .cert-stats { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
    .cert-stat { text-align: center; }
    .cert-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: #D4AF37; font-weight: 700; }
    .cert-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.1em; }
    .cert-date { color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-top: 40px; }
    .cert-footer { margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(212,175,55,0.2); }
    .cert-issuer { color: rgba(255,255,255,0.5); font-size: 0.85rem; }
    .cert-badge { display: inline-block; margin-top: 15px; padding: 8px 20px; background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.4); border-radius: 20px; color: #D4AF37; font-size: 0.9rem; }
    @media print {
      body { background: white; padding: 0; }
      .certificate { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="certificate">
    <div class="cert-header">Synthesis Course Collection</div>
    <div class="cert-title">Certificate of Completion</div>
    <div class="cert-subtitle">This certifies successful completion of</div>
    <div class="cert-course">${courseName}</div>
    <div class="cert-stats">
      <div class="cert-stat">
        <div class="cert-stat-value">${totalXP.toLocaleString()}</div>
        <div class="cert-stat-label">Total XP Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${badgeCount}</div>
        <div class="cert-stat-label">Badges Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${level.title}</div>
        <div class="cert-stat-label">Final Level</div>
      </div>
    </div>
    <div class="cert-date">Completed on ${completionDate}</div>
    <div class="cert-footer">
      <div class="cert-issuer">Synthesis Course Collection ‚Äî Evidence Synthesis & Meta-Analysis Training</div>
      <div class="cert-badge">Verified Completion</div>
    </div>
  </div>
  <script>window.onload = () => window.print();<\/script>
</body>
</html>`;

  const blob = new Blob([certHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Certificate-META-SPRINT-Course.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  // Close modals with Escape
  if (e.key === 'Escape') {
    closeBadgeModal();
    document.getElementById('glossaryPanel').classList.remove('open');
    document.getElementById('completionModal').classList.remove('show');
    document.getElementById('reviewPanel').classList.remove('show');
    // Close mobile sidebar
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }
  // Keyboard support for interactive elements (check first to avoid intercepting their keys)
  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option') || e.target.classList.contains('quiz-option')) && (e.key === 'Enter' || e.key === ' ')) {
    e.preventDefault();
    e.target.click();
    return;
  }
  // Don't navigate if review panel is open
  if (document.getElementById('reviewPanel').classList.contains('show')) return;
  // Navigation
  if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); nextSlide(); }
  else if (e.key === 'ArrowLeft') { e.preventDefault(); prevSlide(); }
});

// ===== TOUCH/SWIPE =====
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', (e) => {
  touchStartX = e.changedTouches[0].screenX;
}, { passive: true });

document.addEventListener('touchend', (e) => {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
}, { passive: true });

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  if (Math.abs(diff) < swipeThreshold) return;

  if (diff > 0) {
    // Swipe left = next; guard against swiping past last slide of completed module
    const mod = MODULES[currentModule];
    if (currentSlide >= mod.slides.length - 1 && gameState.completedModules.includes(mod.id)) return;
    nextSlide();
  } else {
    // Swipe right = prev
    prevSlide();
  }
}

// ===== STREAK WARNING =====
function checkStreakWarning() {
  const today = new Date().toDateString();
  const streakEl = document.getElementById('streakDisplay');
  if (gameState.lastActive && gameState.lastActive !== today && gameState.streak > 0) {
    // User has a streak but hasn't engaged today
    const lastDate = new Date(gameState.lastActive);
    const now = new Date();
    const hoursSince = (now - lastDate) / (1000 * 60 * 60);
    if (hoursSince > 20 && hoursSince < 48) {
      // Streak at risk!
      streakEl.classList.add('streak-warning');
      streakEl.title = 'Complete a lesson today to keep your streak!';
    }
  }
}

// ===== COMPLETION MODAL =====
function showCompletionModal() {
  document.getElementById('finalXP').textContent = gameState.xp;
  document.getElementById('finalCorrect').textContent = gameState.correctAnswers;
  document.getElementById('finalBadges').textContent = gameState.badges.length;
  document.getElementById('completionModal').classList.add('show');
  triggerConfetti();
  setTimeout(triggerConfetti, 500);
  setTimeout(triggerConfetti, 1000);
}

function closeCompletionModal() {
  document.getElementById('completionModal').classList.remove('show');
}

// ===== REVIEW MISTAKES =====
function updateReviewButton() {
  const mistakes = getIncorrectAnswers();
  const btn = document.getElementById('reviewMistakesBtn');
  if (mistakes.length > 0) {
    btn.classList.add('show');
    btn.textContent = `üìù Review ${mistakes.length} Mistake${mistakes.length > 1 ? 's' : ''}`;
  } else {
    btn.classList.remove('show');
  }
}

function getIncorrectAnswers() {
  const mistakes = [];
  MODULES.forEach((mod, mi) => {
    mod.slides.forEach((slide, si) => {
      if (slide.type === 'decision') {
        const did = `dec_${mi}_${si}`;
        const answer = gameState.answeredQuestions[did];
        if (answer) {
          const correct = slide.content.options.find(o => o.correct);
          const chosen = slide.content.options.find(o => o.letter === answer);
          if (chosen && !chosen.correct) {
            mistakes.push({
              module: mod.title,
              question: slide.content.question,
              scenario: slide.content.scenario,
              yourAnswer: chosen.text,
              correctAnswer: correct.text,
              explanation: slide.content.feedback.correct
            });
          }
        }
      }
      if (slide.type === 'quiz') {
        const qid = `quiz_${mi}_${si}`;
        const answer = gameState.answeredQuestions[qid];
        if (answer !== undefined) {
          const chosen = slide.content.options[answer];
          if (chosen && !chosen.correct) {
            const correct = slide.content.options.find(o => o.correct);
            mistakes.push({
              module: mod.title,
              question: slide.content.question,
              scenario: null,
              yourAnswer: chosen.text,
              correctAnswer: correct.text,
              explanation: slide.content.feedback.correct
            });
          }
        }
      }
    });
  });
  return mistakes;
}

function showReviewPanel() {
  const mistakes = getIncorrectAnswers();
  const content = document.getElementById('reviewContent');

  if (mistakes.length === 0) {
    content.innerHTML = '<p style="text-align:center;opacity:0.7;padding:2rem">No mistakes to review. Great job!</p>';
  } else {
    content.innerHTML = mistakes.map(m => `
      <div class="review-item">
        <div class="review-module">${m.module}</div>
        ${m.scenario ? `<div class="review-question" style="font-size:0.85rem;opacity:0.8;margin-bottom:0.5rem">${m.scenario}</div>` : ''}
        <div class="review-question">${m.question}</div>
        <div class="review-your-answer">‚ùå Your answer: ${m.yourAnswer}</div>
        <div class="review-correct-answer">‚úì Correct: ${m.correctAnswer}</div>
        <div class="review-explanation">${m.explanation}</div>
      </div>
    `).join('');
  }

  document.getElementById('reviewPanel').classList.add('show');
}

function closeReviewPanel() {
  document.getElementById('reviewPanel').classList.remove('show');
}

// ===== INIT =====
renderAll();
checkStreakWarning();
updateReviewButton();
</script>
</body>
</html>
