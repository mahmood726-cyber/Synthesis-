HTML
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Metodos de Meta-Analisis: De la Pregunta a la Conclusion</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&amp;family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
 Plotly para gr√°ficos interactivos 
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
if (typeof Plotly === 'undefined') {
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id*="plot"], [id*="chart"], .plotly-graph-div, .js-plotly-plot').forEach(function(el) {
      el.innerHTML = '<div style="padding:2rem;text-align:center;background:#2a2a4a;border:1px dashed #D4AF37;border-radius:8px;color:#FAF8F5;margin:1rem 0;"><p style="font-size:1.1rem;margin-bottom:0.5rem;">Grafico interactivo no disponible sin conexion</p><p style="font-size:0.85rem;opacity:0.7;">Conectese a internet para cargar las visualizaciones interactivas de Plotly.js</p></div>';
    });
  });
}
</script>
<style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f5b6a;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    /* ====== COURSE SHELL ====== */
    .course-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* ====== SIDEBAR NAV ====== */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.5rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }

    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 0.25rem;
    }

    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .module-list {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 0;
    }

    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.65rem 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .module-item:hover {
      background: rgba(212,175,55,0.1);
    }

    .module-item.active {
      background: rgba(212,175,55,0.15);
      border-left-color: var(--gold);
    }

    .module-item.completed .module-number {
      background: var(--green);
      color: white;
    }

    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .module-info {
      flex: 1;
      min-width: 0;
    }

    .module-title {
      font-size: 0.85rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .module-subtitle {
      font-size: 0.7rem;
      color: rgba(255,255,255,0.5);
    }

    /* ====== SIDEBAR FOOTER ====== */
    .sidebar-footer {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }

    .progress-dashboard-btn {
      width: 100%;
      padding: 0.75rem;
      background: rgba(212,175,55,0.15);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 8px;
      color: var(--gold);
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }

    .daily-review-btn {
      width: 100%;
      padding: 0.6rem;
      background: rgba(239,68,68,0.15);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      color: #f87171;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .progress-bar-container {
      margin-top: 0.75rem;
    }

    .progress-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.25rem;
    }

    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), #f0c040);
      border-radius: 3px;
      transition: width 0.3s;
    }

    /* ====== MAIN CONTENT ====== */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.2);
      border-bottom: 1px solid rgba(212,175,55,0.15);
    }

    .module-indicator {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.7);
    }

    .top-bar-actions {
      display: flex;
      gap: 0.75rem;
    }

    .top-bar-btn {
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 6px;
      color: var(--cream);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .top-bar-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .top-bar-btn.primary {
      background: var(--teal);
      border-color: var(--teal);
    }

    /* ====== SLIDE AREA ====== */
    .slide-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }

    .slide {
      display: none;
      max-width: 1000px;
      margin: 0 auto;
    }

    .slide.active {
      display: block;
    }

    /* ====== SLIDE STYLES ====== */
    .principle-display {
      text-align: center;
      margin-bottom: 2rem;
    }

    .principle-text {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2rem;
      font-style: italic;
      color: var(--gold);
      line-height: 1.4;
    }

    .slide-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.2rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .slide-content {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(212,175,55,0.15);
      border-radius: 12px;
      padding: 2rem;
    }

    .story-box {
      background: linear-gradient(135deg, rgba(191,45,45,0.1), rgba(30,39,97,0.15));
      border-left: 4px solid var(--red);
      border-radius: 0 12px 12px 0;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .story-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.5rem;
    }

    .story-text {
      font-size: 1.1rem;
      line-height: 1.7;
      color: var(--cream);
    }

    .story-hook {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.3rem;
      font-style: italic;
      color: var(--gold);
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .method-box {
      background: linear-gradient(135deg, rgba(15,91,106,0.15), rgba(30,39,97,0.1));
      border-left: 4px solid var(--teal);
      border-radius: 0 12px 12px 0;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .method-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--teal);
      margin-bottom: 0.5rem;
    }

    .method-content h3 {
      color: var(--cream);
      margin-bottom: 1rem;
      font-size: 1.2rem;
    }

    .method-content ul {
      margin-left: 1.5rem;
      color: rgba(255,255,255,0.85);
    }

    .method-content li {
      margin-bottom: 0.5rem;
      line-height: 1.5;
    }

    /* ====== TOOL PANEL ====== */
    .tool-panel {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      color: var(--text);
    }

    .tool-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid var(--teal);
    }

    .tool-icon {
      font-size: 1.5rem;
    }

    .tool-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--navy);
    }

    .tool-input-group {
      margin-bottom: 1rem;
    }

    .tool-input-group label {
      display: block;
      font-weight: 600;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      color: var(--navy);
    }

    .tool-input-group input,
    .tool-input-group textarea,
    .tool-input-group select {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
    }

    .tool-input-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .tool-btn {
      padding: 0.6rem 1.25rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .tool-btn:hover {
      background: #0a4a57;
    }

    .tool-output {
      margin-top: 1rem;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 8px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    /* ====== SCENARIO PANEL ====== */
    .scenario-panel {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid rgba(124,58,237,0.4);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .scenario-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .scenario-icon {
      font-size: 1.5rem;
    }

    .scenario-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--cream);
    }

    .scenario-situation {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      line-height: 1.6;
    }

    .scenario-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 1rem;
    }

    .scenario-choices {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .scenario-choice {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .scenario-choice:hover {
      background: rgba(255,255,255,0.1);
      border-color: rgba(124,58,237,0.5);
    }

    .scenario-choice.correct {
      background: rgba(34,197,94,0.15);
      border-color: var(--green);
    }

    .scenario-choice.incorrect {
      background: rgba(239,68,68,0.1);
      border-color: var(--red);
    }

    .choice-letter {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(124,58,237,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .scenario-consequence {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }

    .scenario-consequence.visible {
      display: block;
    }

    .scenario-consequence.good {
      background: rgba(34,197,94,0.15);
      border: 1px solid rgba(34,197,94,0.3);
    }

    .scenario-consequence.bad {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
    }

    /* ====== QUIZ ====== */
    .quiz-container {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.2);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .quiz-question {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      line-height: 1.5;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .quiz-option {
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--cream);
      font-family: inherit;
      font-size: inherit;
      text-align: left;
      width: 100%;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .quiz-option:hover {
      background: rgba(255,255,255,0.1);
    }

    .quiz-option:disabled {
      cursor: not-allowed;
      opacity: 0.8;
    }

    .option-letter {
      font-weight: 600;
      color: var(--gold);
      flex-shrink: 0;
    }

    .quiz-option.selected {
      border-color: var(--gold);
      background: rgba(212,175,55,0.1);
    }

    .quiz-option.correct {
      border-color: var(--green);
      background: rgba(34,197,94,0.15);
    }

    .quiz-option.incorrect {
      border-color: var(--red);
      background: rgba(239,68,68,0.1);
    }

    /* ====== NAVIGATION ====== */
    .slide-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: rgba(0,0,0,0.2);
      border-top: 1px solid rgba(212,175,55,0.15);
    }

    .nav-btn {
      padding: 0.75rem 1.5rem;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: var(--cream);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.15);
    }

    .nav-btn.primary {
      background: var(--gold);
      border-color: var(--gold);
      color: var(--navy);
    }

    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .slide-counter {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
    }

    .slide-dots {
      display: flex;
      gap: 6px;
    }

    .slide-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .slide-dot.active {
      background: var(--gold);
    }

    .slide-dot.completed {
      background: var(--green);
    }

    /* ====== PROGRESS DASHBOARD ====== */
    .dashboard-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .dashboard-overlay.open {
      display: flex;
    }

    .dashboard-panel {
      background: var(--light-cream);
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      color: var(--text);
    }

    .dashboard-header {
      padding: 1.5rem;
      background: linear-gradient(135deg, var(--navy), var(--teal));
      color: white;
      border-radius: 16px 16px 0 0;
    }

    .dashboard-header h2 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      margin-bottom: 0.5rem;
    }

    .dashboard-content {
      padding: 1.5rem;
    }

    .stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      text-align: center;
      padding: 1rem;
      background: #f7fafc;
      border-radius: 8px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--navy);
    }

    .stat-label {
      font-size: 0.75rem;
      color: var(--light-text);
      text-transform: uppercase;
    }

    .badge-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .badge {
      padding: 0.4rem 0.8rem;
      background: #e2e8f0;
      border-radius: 999px;
      font-size: 0.8rem;
      color: var(--light-text);
    }

    .badge.earned {
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      font-weight: 600;
    }

    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* ====== DECISION TREE ====== */
    .decision-tree {
      background: linear-gradient(135deg, rgba(30,39,97,0.1), rgba(20,27,61,0.15));
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 16px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .decision-node {
      background: rgba(255,255,255,0.08);
      border: 2px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }

    .decision-node.active {
      border-color: var(--gold);
      background: rgba(212,175,55,0.15);
    }

    .decision-node.completed {
      border-color: var(--green);
      background: rgba(34,197,94,0.1);
    }

    .decision-node.wrong {
      border-color: var(--red);
      background: rgba(197,48,48,0.1);
    }

    .decision-question {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--cream);
      margin-bottom: 1rem;
    }

    .decision-branches {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .decision-branch {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .decision-branch:hover {
      background: rgba(255,255,255,0.1);
      border-color: var(--gold);
    }

    .decision-branch.selected {
      background: rgba(212,175,55,0.2);
      border-color: var(--gold);
    }

    .decision-branch.correct {
      background: rgba(34,197,94,0.2);
      border-color: var(--green);
    }

    .decision-branch.incorrect {
      background: rgba(197,48,48,0.15);
      border-color: var(--red);
    }

    .branch-arrow {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: rgba(212,175,55,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      flex-shrink: 0;
    }

    .decision-outcome {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }

    .decision-outcome.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    .decision-outcome.good {
      background: rgba(34,197,94,0.15);
      border-left: 4px solid var(--green);
    }

    .decision-outcome.bad {
      background: rgba(197,48,48,0.15);
      border-left: 4px solid var(--red);
    }

    .decision-outcome.neutral {
      background: rgba(245,158,11,0.15);
      border-left: 4px solid #f59e0b;
    }

    /* ====== INTERACTIVE PLOTS ====== */
    .plot-container {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1rem;
      margin: 1rem 0;
    }

    .plot-area {
      width: 100%;
      min-height: 350px;
      background: white;
      border-radius: 8px;
    }

    .plot-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.03);
      border-radius: 8px;
    }

    .plot-control-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .plot-control-group label {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--navy);
    }

    .plot-control-group select,
    .plot-control-group input[type="number"] {
      padding: 0.4rem 0.6rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .plot-control-group input[type="range"] {
      width: 100px;
    }

    /* ====== DATA TABLE EDITOR ====== */
    .data-editor {
      background: var(--light-cream);
      border-radius: 12px;
      padding: 1.25rem;
      margin: 1rem 0;
      color: var(--text);
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      margin-bottom: 1rem;
    }

    .data-table th {
      background: var(--navy);
      color: white;
      padding: 0.6rem;
      text-align: left;
      font-weight: 600;
    }

    .data-table td {
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .data-table input {
      width: 100%;
      padding: 0.35rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .data-table input:focus {
      border-color: var(--teal);
      outline: none;
    }

    .data-table .row-actions {
      text-align: center;
    }

    .data-table .delete-row {
      background: transparent;
      border: 1px solid #ddd;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      color: var(--red);
    }

    .add-row-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--teal);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    /* ====== REAL-TIME STATS PANEL ====== */
    .stats-panel {
      background: linear-gradient(135deg, var(--navy), var(--teal));
      border-radius: 12px;
      padding: 1.25rem;
      color: white;
      margin: 1rem 0;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
    }

    .stat-item {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
    }

    .stat-value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }

    .stat-label {
      font-size: 0.75rem;
      opacity: 0.8;
      margin-top: 0.25rem;
    }

    .stat-interpretation {
      margin-top: 1rem;
      padding: 0.75rem;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* ====== STORY DEEP DIVE ====== */
    .story-deep {
      background: linear-gradient(135deg, rgba(191,45,45,0.08), rgba(30,39,97,0.12));
      border-left: 4px solid var(--red);
      border-radius: 0 16px 16px 0;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-timeline {
      position: relative;
      padding-left: 2rem;
      margin: 1rem 0;
    }

    .story-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(255,255,255,0.2);
    }

    .timeline-event {
      position: relative;
      margin-bottom: 1.25rem;
      padding-left: 1rem;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -1.5rem;
      top: 0.35rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--gold);
      border: 2px solid rgba(255,255,255,0.3);
    }

    .timeline-event.crisis::before {
      background: var(--red);
    }

    .timeline-event.revelation::before {
      background: var(--green);
    }

    .timeline-year {
      font-weight: 700;
      color: var(--gold);
      font-size: 0.85rem;
    }

    .timeline-text {
      color: rgba(255,255,255,0.9);
      line-height: 1.5;
      margin-top: 0.25rem;
    }

    /* ====== REAL DATA CARD ====== */
    .real-data-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 12px;
      padding: 1.25rem;
      margin: 1rem 0;
    }

    .real-data-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .real-data-source {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .real-data-stat {
      display: flex;
      align-items: baseline;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .real-data-stat .value {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--gold);
    }

    .real-data-stat .label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
    }

    /* ====== ANIMATIONS ====== */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .animate-in {
      animation: fadeIn 0.4s ease;
    }

    .pulse {
      animation: pulse 2s infinite;
    }

    /* ====== ACCESSIBILITY ====== */
    /* Focus states for all interactive elements */
    button:focus, .module-item:focus, .quiz-option:focus,
    .decision-branch:focus, input:focus, select:focus, a:focus {
      outline: 3px solid var(--gold);
      outline-offset: 2px;
    }

    /* High contrast mode support */
    @media (prefers-contrast: high) {
      :root {
        --gold: #FFD700;
        --cream: #FFFFFF;
      }
    }

    /* Focus-visible styles for keyboard navigation */
    :focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
    }

    :focus:not(:focus-visible) {
      outline: none;
    }

    button:focus-visible,
    a:focus-visible,
    [role="button"]:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 2px solid var(--gold, #D4AF37);
      outline-offset: 2px;
      box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Screen reader only class */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* ====== HAMBURGER MENU ====== */
    .hamburger {
      display: none;
      position: fixed;
      top: 1rem;
      left: 1rem;
      z-index: 1001;
      width: 44px;
      height: 44px;
      background: var(--navy);
      border: 2px solid var(--gold);
      border-radius: 8px;
      cursor: pointer;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }

    .hamburger span {
      display: block;
      width: 22px;
      height: 2px;
      background: var(--gold);
      transition: all 0.3s;
    }

    .hamburger.active span:nth-child(1) {
      transform: rotate(45deg) translate(5px, 5px);
    }

    .hamburger.active span:nth-child(2) {
      opacity: 0;
    }

    .hamburger.active span:nth-child(3) {
      transform: rotate(-45deg) translate(5px, -5px);
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 999;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* ====== RESPONSIVE BREAKPOINTS ====== */

    /* Tablet: 768px */
    @media (max-width: 768px) {
      .hamburger {
        display: flex;
      }

      .sidebar {
        position: fixed;
        left: -320px;
        top: 0;
        height: 100vh;
        z-index: 1000;
        transition: left 0.3s ease;
        width: 280px;
      }

      .sidebar.open {
        left: 0;
      }

      .main-content {
        margin-left: 0;
        width: 100%;
      }

      .top-bar {
        padding-left: 60px;
      }

      .slide-container {
        padding: 1rem;
      }

      .plot-controls {
        flex-direction: column;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .decision-branches {
        gap: 0.75rem;
      }

      .decision-branch {
        padding: 1rem;
        min-height: 48px;
      }

      .quiz-option {
        padding: 1rem;
        min-height: 48px;
      }

      .tool-grid {
        grid-template-columns: 1fr;
      }

      .progress-modal-content {
        width: 95%;
        max-width: none;
        margin: 1rem;
      }
    }

    /* Mobile: 480px */
    @media (max-width: 480px) {
      .sidebar {
        width: 100%;
        left: -100%;
      }

      .top-bar {
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.75rem;
        padding-left: 55px;
      }

      .top-bar-actions {
        order: 3;
        width: 100%;
        justify-content: space-around;
      }

      .top-bar-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.75rem;
      }

      .slide-container {
        padding: 0.75rem;
      }

      .story-deep, .real-data-card {
        padding: 1rem;
      }

      .story-timeline {
        padding-left: 1rem;
      }

      .timeline-event {
        padding: 0.75rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .stat-item {
        padding: 0.75rem;
      }

      .stat-value {
        font-size: 1.4rem;
      }

      .principle-number {
        font-size: 3rem;
      }

      .principle-text {
        font-size: 1.3rem;
      }

      .decision-tree {
        padding: 1rem;
      }

      .decision-node {
        padding: 1rem;
      }

      h2 {
        font-size: 1.4rem;
      }

      h3 {
        font-size: 1.1rem;
      }

      .nav-controls {
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .nav-btn {
        flex: 1;
        min-width: 80px;
        padding: 0.75rem;
      }
    }

    /* ====== CERTIFICATE MODAL ====== */
    .certificate-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .certificate-modal.active {
      display: flex;
    }

    .certificate {
      background: linear-gradient(135deg, #FAF8F5, #F5F0E8);
      border: 8px solid var(--gold);
      border-radius: 8px;
      padding: 3rem;
      max-width: 700px;
      width: 100%;
      text-align: center;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .certificate::before {
      content: '';
      position: absolute;
      inset: 8px;
      border: 2px solid var(--gold);
      border-radius: 4px;
      pointer-events: none;
    }

    .certificate-title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2.5rem;
      color: var(--navy);
      margin-bottom: 0.5rem;
    }

    .certificate-subtitle {
      font-size: 1rem;
      color: var(--light-text);
      margin-bottom: 2rem;
    }

    .certificate-name {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 2rem;
      color: var(--navy);
      margin: 1.5rem 0;
      padding: 0.5rem;
      border-bottom: 2px solid var(--gold);
      display: inline-block;
    }

    .certificate-body {
      font-size: 1rem;
      color: var(--text);
      line-height: 1.6;
      margin-bottom: 2rem;
    }

    .certificate-date {
      font-size: 0.9rem;
      color: var(--light-text);
      margin-top: 2rem;
    }

    .certificate-actions {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 2rem;
    }

    .certificate-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .certificate-btn.primary {
      background: var(--navy);
      color: white;
    }

    .certificate-btn.secondary {
      background: transparent;
      color: var(--navy);
      border: 2px solid var(--navy);
    }

    /* ====== TOOL LIBRARY MODAL ====== */
    .tool-library-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 1500;
      overflow-y: auto;
      padding: 2rem;
    }

    .tool-library-modal.active {
      display: block;
    }

    .tool-library-content {
      max-width: 900px;
      margin: 0 auto;
      background: var(--deep-navy);
      border-radius: 16px;
      border: 1px solid rgba(212,175,55,0.3);
      padding: 2rem;
    }

    .tool-library-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }

    .tool-library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
    }

    .tool-library-item {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .tool-library-item:hover {
      background: rgba(212,175,55,0.1);
      border-color: var(--gold);
    }

    .tool-library-item h4 {
      color: var(--gold);
      margin-bottom: 0.5rem;
    }

    .tool-library-item p {
      font-size: 0.85rem;
      color: rgba(255,255,255,0.7);
    }

    /* ====== DECISION TREE PATH HISTORY ====== */
    .path-history {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .path-step {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      font-size: 0.8rem;
      color: rgba(255,255,255,0.7);
    }

    .path-step::after {
      content: '‚Üí';
      margin-left: 0.5rem;
      color: var(--gold);
    }

    .path-step:last-child::after {
      display: none;
    }

    .undo-btn, .restart-btn {
      padding: 0.5rem 1rem;
      background: rgba(212,175,55,0.2);
      border: 1px solid var(--gold);
      border-radius: 6px;
      color: var(--gold);
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .undo-btn:hover, .restart-btn:hover {
      background: rgba(212,175,55,0.3);
    }

    .tree-controls {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    /* ====== TOAST NOTIFICATIONS ====== */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .toast {
      padding: 0.75rem 1.25rem;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      animation: toastSlideIn 0.3s ease, toastFadeOut 0.3s ease 2.7s forwards;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .toast.badge-toast {
      background: linear-gradient(135deg, #4ade80, #22c55e);
    }

    .toast.level-toast {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes toastFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* ====== SKIP LINK ====== */
    .skip-link {
      position: absolute;
      top: -100px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 0.75rem 1.5rem;
      z-index: 10001;
      font-weight: 600;
      text-decoration: none;
      border-radius: 0 0 8px 0;
    }

    .skip-link:focus {
      top: 0;
    }

    /* ====== NOTIFICATION MODAL ====== */
    .notification-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .notification-modal.active {
      opacity: 1;
      visibility: visible;
    }

    .notification-content {
      background: var(--deep-navy);
      border: 1px solid var(--gold);
      border-radius: 12px;
      padding: 2rem;
      max-width: 400px;
      text-align: center;
    }

    .notification-content h3 {
      color: var(--gold);
      margin-bottom: 1rem;
    }

    .notification-content p {
      color: rgba(255,255,255,0.8);
      margin-bottom: 1.5rem;
    }

    .notification-btn {
      padding: 0.75rem 2rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* ====== PRINT STYLES ====== */
    @media print {
      body {
        background: white !important;
        color: black !important;
      }

      .sidebar, .hamburger, .sidebar-overlay, .top-bar,
      .slide-nav, .dashboard-overlay, .tool-library-modal,
      .toast-container, .nav-btn, .progress-dashboard-btn,
      .daily-review-btn, .tree-controls, .skip-link {
        display: none !important;
      }

      .course-container {
        display: block !important;
      }

      .main-content {
        width: 100% !important;
        padding: 0 !important;
      }

      .slide-container {
        height: auto !important;
        overflow: visible !important;
      }

      .slide {
        display: block !important;
        opacity: 1 !important;
        page-break-after: always;
        padding: 1rem !important;
        background: white !important;
        color: black !important;
      }

      .slide-title, .method-box h3, .method-box h4 {
        color: #1E2761 !important;
      }

      .tool-panel, .quiz-container, .scenario-panel, .decision-tree {
        border: 1px solid #ccc !important;
        background: #f9f9f9 !important;
        color: black !important;
        padding: 1rem !important;
        margin: 1rem 0 !important;
      }

      .tool-btn, .quiz-option, .scenario-choice {
        border: 1px solid #666 !important;
        background: white !important;
        color: black !important;
      }

      .certificate {
        box-shadow: none !important;
        border: 2px solid var(--gold) !important;
      }
    }

    /* ====== REAL-WORLD STORY STYLES ====== */
    .real-world-story {
      background: linear-gradient(135deg, rgba(30,39,97,0.15), rgba(20,27,61,0.2));
      border: 2px solid rgba(212,175,55,0.3);
      border-radius: 16px;
      padding: 2rem;
      margin: 1rem 0;
    }

    .story-rhetorical-question {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.6rem;
      font-style: italic;
      color: var(--gold);
      text-align: center;
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: rgba(212,175,55,0.08);
      border-radius: 12px;
      line-height: 1.5;
    }

    .story-stats-box {
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(212,175,55,0.4);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-stats-header {
      font-weight: 700;
      font-size: 1rem;
      color: var(--gold);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(212,175,55,0.3);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
    }

    .story-stat-item {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
    }

    .story-stat-value {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--cream);
      display: block;
    }

    .story-stat-value.danger {
      color: var(--red);
    }

    .story-stat-value.success {
      color: var(--green);
    }

    .story-stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-top: 0.25rem;
    }

    .story-decision-tree {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .story-decision-header {
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-decision-scenario {
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .story-path {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border-left: 4px solid;
    }

    .story-path.path-wrong {
      background: rgba(197,48,48,0.1);
      border-left-color: var(--red);
    }

    .story-path.path-right {
      background: rgba(34,197,94,0.1);
      border-left-color: var(--green);
    }

    .story-path-label {
      font-weight: 700;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }

    .story-path.path-wrong .story-path-label {
      color: var(--red);
    }

    .story-path.path-right .story-path-label {
      color: var(--green);
    }

    .story-path-content {
      color: rgba(255,255,255,0.85);
      line-height: 1.6;
    }

    .story-path-arrow {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin: 0.5rem 0;
      color: rgba(255,255,255,0.6);
      font-size: 0.9rem;
    }

    .story-revelation {
      background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(212,175,55,0.05));
      border: 2px solid var(--gold);
      border-radius: 12px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }

    .story-revelation-header {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .story-revelation-text {
      color: var(--cream);
      line-height: 1.7;
      font-size: 1.05rem;
    }

    .story-source {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      margin-top: 1rem;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .story-connection {
      margin-top: 1rem;
      padding: 0.75rem 1rem;
      background: rgba(15,91,106,0.2);
      border-left: 3px solid var(--teal);
      border-radius: 0 8px 8px 0;
      font-size: 0.95rem;
      color: rgba(255,255,255,0.9);
    }
  </style>
</head>
<body>
<!-- Toast Notification Container -->
<div aria-atomic="true" aria-live="polite" class="toast-container" id="toastContainer"></div>
 Modalidad de notificaci√≥n (para revisi√≥n diaria, etc.) 
<div aria-modal="true" class="notification-modal" id="notificationModal" role="dialog">
<div class="notification-content">
<h3 id="notificationTitle">Aviso</h3>
<p id="notificationMessage">Mensaje aqui</p>
<button class="notification-btn" onclick="closeNotification()">Aceptar</button>
</div>
</div>
 Saltar enlace para accesibilidad 
<a class="skip-link" href="#main-content">Saltar al contenido principal</a>
<!-- Hamburger Menu Button (Mobile) -->
<button aria-expanded="false" aria-label="Alternar menu de navegacion" class="hamburger" onclick="toggleSidebar()">
<span></span>
<span></span>
<span></span>
</button>
<!-- Sidebar Overlay (Mobile) -->
<div class="sidebar-overlay" onclick="toggleSidebar()"></div>
 Biblioteca de herramientas modal 
<div aria-labelledby="toolLibraryTitle" aria-modal="true" class="tool-library-modal" id="toolLibraryModal" role="dialog">
<div class="tool-library-content">
<div class="tool-library-header">
<h2 id="toolLibraryTitle">üì¶ Biblioteca de Herramientas</h2>
<button aria-label="Cerrar biblioteca de herramientas" class="close-btn" onclick="closeToolLibrary()">√ó</button>
</div>
<div class="tool-library-grid" id="toolLibraryGrid">
<!-- Tools populated by JS -->
</div>
</div>
</div>
<!-- Certificate Modal -->
<div aria-labelledby="certificateTitle" aria-modal="true" class="certificate-modal" id="certificateModal" role="dialog">
<div class="certificate">
<h1 class="certificate-title" id="certificateTitle">Certificado de Finalizacion</h1>
<p class="certificate-subtitle">Curso de Metodos de Meta-Analisis</p>
<p class="certificate-body">Esto certifica que</p>
<div class="certificate-name" id="certificateName">Tu Nombre</div>
<p class="certificate-body">
        ha completado exitosamente el curso integral<br/>
<strong>"De la Pregunta a la Conclusion: Un Curso de Metodos de Meta-Analisis"</strong><br/><br/>
        demostrando competencia en metodologia de revision sistematica, evaluacion del riesgo de sesgo,<br/>
        calculo de tamanos de efecto, analisis de heterogeneidad y clasificacion de certeza de la evidencia.
      </p>
<p class="certificate-date" id="certificateDate"></p>
<div class="certificate-actions">
<button class="certificate-btn primary" onclick="downloadCertificate()">üì• Descargar PDF</button>
<button class="certificate-btn secondary" onclick="closeCertificate()">Cerrar</button>
</div>
</div>
</div>
<div class="course-container">
<!-- SIDEBAR -->
<nav aria-label="Modulos del curso" class="sidebar" id="sidebar">
<div class="sidebar-header">
<a href="index.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;">‚Üê Biblioteca de Cursos</a>
<h1>Metodos de Meta-Analisis</h1>
<p>De la Pregunta a la Conclusion</p>
</div>
<div class="module-list" id="moduleList">
<!-- Modules will be populated by JS -->
</div>
<div class="sidebar-footer">
<button class="progress-dashboard-btn" onclick="openDashboard()">
<span>üìä Panel de Progreso</span>
<span id="sidebarPoints">0 pts</span>
</button>
<button class="daily-review-btn" onclick="startDailyReview()">
<span>üîÑ</span> Repaso Diario
        </button>
<div class="progress-bar-container">
<div class="progress-label">Progreso: <span id="progressPercent">0%</span></div>
<div class="progress-bar">
<div class="progress-fill" id="progressFill" style="width: 0%"></div>
</div>
</div>
</div>
</nav>
<!-- MAIN CONTENT -->
<main class="main-content" id="main-content">
<div class="top-bar">
<div class="module-indicator" id="moduleIndicator">Modulo 0: La Apertura</div>
<div class="top-bar-actions">
<button aria-label="Abrir biblioteca de herramientas" class="top-bar-btn" onclick="openToolLibrary()">üîß Herramientas</button>
<button aria-label="Abrir glosario" class="top-bar-btn" onclick="openGlossary()">üìñ Glosario</button>
<button class="top-bar-btn primary" onclick="goToNextModule()">Siguiente Modulo ‚Üí</button>
</div>
</div>
<div class="slide-container" id="slideContainer">
<!-- Slides will be populated by JS -->
</div>
<div class="slide-nav">
<button class="nav-btn" id="prevBtn" onclick="prevSlide()">‚Üê Anterior</button>
<div class="slide-counter">
<span id="slideCounter">1 / 10</span>
<div class="slide-dots" id="slideDots"></div>
</div>
<button class="nav-btn primary" id="nextBtn" onclick="nextSlide()">Siguiente ‚Üí</button>
</div>
</main>
</div>
<!-- PROGRESS DASHBOARD -->
<div aria-labelledby="dashboardTitle" aria-modal="true" class="dashboard-overlay" id="progressDashboard" role="dialog">
<div class="dashboard-panel">
<div class="dashboard-header" style="position: relative;">
<button aria-label="Cerrar panel" class="close-btn" onclick="closeDashboard()">√ó</button>
<h2 id="dashboardTitle">Tu Progreso</h2>
<p id="levelBadge">Nivel 1: Principiante</p>
</div>
<div class="dashboard-content">
<div class="stat-grid">
<div class="stat-card">
<div class="stat-value" id="totalPoints">0</div>
<div class="stat-label">Puntos</div>
</div>
<div class="stat-card">
<div class="stat-value" id="modulesCompleted">0/15</div>
<div class="stat-label">Modulos</div>
</div>
<div class="stat-card">
<div class="stat-value" id="toolsUsed">0</div>
<div class="stat-label">Herramientas Usadas</div>
</div>
</div>
<h3 style="margin-bottom: 0.75rem;">Insignias</h3>
<div class="badge-grid" id="badgeGrid">
<!-- Badges populated by JS -->
</div>
</div>
</div>
</div>
<script>
// ============================================================
// COURSE DATA
// ============================================================

const STORAGE_KEY = 'metaAnalysisMethodsCourse_es';

const sevenPrinciples = [
  { num: 1, text: "La pregunta determina la respuesta", short: "Pregunta" },
  { num: 2, text: "La pre-especificacion es proteccion", short: "Protocolo" },
  { num: 3, text: "Lo que no buscas, no encontraras", short: "Busqueda" },
  { num: 4, text: "Cada numero necesita una fuente", short: "Extraccion" },
  { num: 5, text: "El sesgo se esconde a plena vista", short: "Evaluacion" },
  { num: 6, text: "El promedio puede mentir", short: "Sintesis" },
  { num: 7, text: "La certeza debe estar justificada", short: "Certeza" }
];

// ============================================================
// BADGES SYSTEM
// ============================================================

const badges = [
  // Insignias de finalizacion de modulos
  { id: 'first_steps', name: 'Primeros Pasos', icon: 'üë£', description: 'Completar Modulo 0: La Apertura', condition: () => gameState.modulesCompleted.includes(0) },
  { id: 'question_master', name: 'Maestro de Preguntas', icon: '‚ùì', description: 'Completar Modulo 1: La Pregunta', condition: () => gameState.modulesCompleted.includes(1) },
  { id: 'protocol_pro', name: 'Profesional del Protocolo', icon: 'üìã', description: 'Completar Modulo 2: El Protocolo', condition: () => gameState.modulesCompleted.includes(2) },
  { id: 'search_sage', name: 'Sabio de la Busqueda', icon: 'üîç', description: 'Completar Modulo 3: La Busqueda', condition: () => gameState.modulesCompleted.includes(3) },
  { id: 'screener', name: 'Evaluador de Estudios', icon: 'üìä', description: 'Completar Modulo 4: La Seleccion', condition: () => gameState.modulesCompleted.includes(4) },
  { id: 'data_detective', name: 'Detective de Datos', icon: 'üîé', description: 'Completar Modulo 5: La Extraccion', condition: () => gameState.modulesCompleted.includes(5) },
  { id: 'bias_hunter', name: 'Cazador de Sesgos', icon: '‚öñÔ∏è', description: 'Completar Modulo 6: Riesgo de Sesgo', condition: () => gameState.modulesCompleted.includes(6) },
  { id: 'effect_expert', name: 'Experto en Efectos', icon: 'üìê', description: 'Completar Modulo 7: Tamanos de Efecto', condition: () => gameState.modulesCompleted.includes(7) },
  { id: 'forest_ranger', name: 'Guardian del Bosque', icon: 'üå≤', description: 'Completar Modulo 8: El Grafico Forest', condition: () => gameState.modulesCompleted.includes(8) },
  { id: 'heterogeneity_hero', name: 'Heroe de la Heterogeneidad', icon: 'üìà', description: 'Completar Modulo 9: Heterogeneidad', condition: () => gameState.modulesCompleted.includes(9) },
  { id: 'pub_bias_pro', name: 'Profesional del Sesgo de Publicacion', icon: 'üîª', description: 'Completar Modulo 10: Sesgo de Publicacion', condition: () => gameState.modulesCompleted.includes(10) },
  { id: 'grade_guru', name: 'Guru GRADE', icon: '‚≠ê', description: 'Completar Modulo 11: GRADE', condition: () => gameState.modulesCompleted.includes(11) },
  { id: 'reporter', name: 'Reportero Experto', icon: 'üìù', description: 'Completar Modulo 12: Reporte', condition: () => gameState.modulesCompleted.includes(12) },
  { id: 'advanced_analyst', name: 'Analista Avanzado', icon: 'üß™', description: 'Completar Modulo 13: Metodos Avanzados', condition: () => gameState.modulesCompleted.includes(13) },
  { id: 'course_graduate', name: 'Graduado del Curso', icon: 'üéì', description: 'Completar todos los modulos', condition: () => gameState.modulesCompleted.length >= 14 },

  // Insignias de uso de herramientas
  { id: 'tool_novice', name: 'Novato en Herramientas', icon: 'üîß', description: 'Usar tu primera herramienta', condition: () => gameState.toolsUsed.length >= 1 },
  { id: 'tool_adept', name: 'Adepto en Herramientas', icon: 'üõ†Ô∏è', description: 'Usar 5 herramientas diferentes', condition: () => gameState.toolsUsed.length >= 5 },
  { id: 'tool_master', name: 'Maestro en Herramientas', icon: '‚öôÔ∏è', description: 'Usar las 11 herramientas', condition: () => gameState.toolsUsed.length >= 11 },

  // Insignias de cuestionarios
  { id: 'quiz_starter', name: 'Iniciador de Cuestionarios', icon: '‚úèÔ∏è', description: 'Responder tu primer cuestionario', condition: () => Object.keys(gameState.quizAnswers).length >= 1 },
  { id: 'quiz_whiz', name: 'Genio de Cuestionarios', icon: 'üß†', description: 'Responder 5 cuestionarios correctamente', condition: () => Object.values(gameState.quizAnswers).filter(a => a.correct).length >= 5 },
  { id: 'perfect_score', name: 'Puntuacion Perfecta', icon: 'üíØ', description: 'Responder 10 cuestionarios correctamente', condition: () => Object.values(gameState.quizAnswers).filter(a => a.correct).length >= 10 },

  // Insignias de puntos
  { id: 'points_100', name: 'Club del Centenario', icon: 'üí∞', description: 'Ganar 100 puntos', condition: () => gameState.points >= 100 },
  { id: 'points_500', name: 'Gran Anotador', icon: 'üèÜ', description: 'Ganar 500 puntos', condition: () => gameState.points >= 500 },
  { id: 'points_1000', name: 'Campeon de Puntos', icon: 'üëë', description: 'Ganar 1000 puntos', condition: () => gameState.points >= 1000 },

  // Insignias de arboles de decision
  { id: 'decision_maker', name: 'Tomador de Decisiones', icon: 'üå≥', description: 'Completar tu primer arbol de decision', condition: () => Object.keys(gameState.decisionTrees).length >= 1 },
  { id: 'path_finder', name: 'Buscador de Caminos', icon: 'üó∫Ô∏è', description: 'Completar 5 arboles de decision', condition: () => Object.keys(gameState.decisionTrees).filter(k => gameState.decisionTrees[k].currentNode !== 'start').length >= 5 }
];

// Umbrales de nivel
const levels = [
  { name: 'Principiante', minPoints: 0 },
  { name: 'Aprendiz', minPoints: 100 },
  { name: 'Practicante', minPoints: 300 },
  { name: 'Experto', minPoints: 600 },
  { name: 'Maestro', minPoints: 1000 },
  { name: 'Gran Maestro', minPoints: 1500 }
];

const modules = [
  {
    id: 0,
    title: "La Apertura",
    subtitle: "Por Que Importan los Metodos",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "De la Pregunta a la Conclusion",
          subtitle: "Un Curso de Metodos de Meta-Analisis",
          text: "Aprende a realizar meta-analisis rigurosos a traves de las historias de quienes se equivocaron."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LOS ORIGENES: DE LA TALIDOMIDA A LA SINTESIS DE EVIDENCIA",
          source: "Lancet 1962 (Talidomida) | BMJ 1972 (Cochrane) | CAST 1989",
          timeline: [
            { year: "1957-61", text: "La talidomida se comercializo como sedante 'completamente seguro' para mujeres embarazadas. Basado en estudios animales y afirmaciones del fabricante. No se requeria evidencia humana sistematica.", type: "normal" },
            { year: "1961", text: "Mas de 10,000 ninos nacieron con defectos congenitos graves. Malformaciones de extremidades, dano a organos, muerte. El medicamento nunca habia sido probado adecuadamente en humanos.", type: "crisis" },
            { year: "1972", text: "Archie Cochrane publica 'Efectividad y Eficiencia': 'Es seguramente una gran critica a nuestra profesion que no hayamos organizado un resumen critico... de todos los ensayos controlados aleatorios.'", type: "revelation" },
            { year: "1980s", text: "Pequenos ensayos muestran que los farmacos antiarritmicos suprimen las CVP despues de infartos. Los meta-analisis los combinan. La logica parece perfecta: suprimir arritmias ‚Üí prevenir muerte.", type: "normal" },
            { year: "1989", text: "El ensayo CAST se detiene: los antiarritmicos TRIPLICAN la mortalidad (RR 3.6, IC 95% 1.7-8.5). Se estima que 50,000 estadounidenses murieron por medicamentos que 'funcionaban' en un sustituto.", type: "crisis" },
            { year: "1993", text: "Se funda la Colaboracion Cochrane. La sintesis sistematica de evidencia se convierte en ciencia. El objetivo: nunca dejar que la talidomida o CAST vuelvan a suceder.", type: "revelation" }
          ],
          realData: {
            endpoint: "El nacimiento de la medicina basada en evidencia",
            drug: "Talidomida: +10,000 defectos congenitos",
            placebo: "CAST: ~50,000 muertes en exceso",
            rr: "Dos catastrofes por evidencia no sistematica",
            ci: "Cochrane fundada para prevenir la tercera",
            nnh: "El costo de no saber como saber"
          },
          hook: "EL GANCHO: Este curso existe porque ninos nacieron sin extremidades y pacientes cardiacos murieron por tratamientos 'efectivos'. La sintesis de evidencia no es academica. Es la frontera entre curar y danar."
        }
      },
      {
        type: 'content',
        content: {
          title: "Lo Que Este Curso Te Ensenara",
          sections: [
            {
              heading: "Los Siete Principios del Meta-Analisis Riguroso",
              items: [
                "1. La pregunta determina la respuesta ‚Äî Formulacion PICO",
                "2. La pre-especificacion es proteccion ‚Äî Registro de protocolo",
                "3. Lo que no buscas, no encontraras ‚Äî Busqueda exhaustiva",
                "4. Cada numero necesita una fuente ‚Äî Integridad de datos",
                "5. El sesgo se esconde a plena vista ‚Äî Evaluacion del riesgo de sesgo",
                "6. El promedio puede mentir ‚Äî Exploracion de heterogeneidad",
                "7. La certeza debe estar justificada ‚Äî Marco GRADE"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Como Funciona Este Curso",
          sections: [
            {
              heading: "Cada Modulo Contiene:",
              items: [
                "üìñ UNA HISTORIA ‚Äî Que salio mal y por que importa",
                "üîß EL METODO ‚Äî Como hacerlo correctamente",
                "‚öôÔ∏è LA HERRAMIENTA ‚Äî Practica interactiva",
                "üîÄ EL ESCENARIO ‚Äî Aplica tu juicio",
                "‚úÖ EL CUESTIONARIO ‚Äî Pon a prueba tu comprension"
              ]
            }
          ]
        }
      },
      {
        type: 'principle',
        content: {
          text: "Los siete principios se repetiran a lo largo del curso. Al final, no solo los conoceras ‚Äî sentiras por que cada uno importa."
        }
      }
    ]
  },
  {
    id: 1,
    title: "La Pregunta",
    subtitle: "Marco PICO",
    principle: 0,
    story: "CAST",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La pregunta determina la respuesta"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA REVERSION: ENSAYO CAST (1989)",
          source: "NEJM 1989; 321:406-412 | PubMed: 2473403",
          timeline: [
            { year: "1970s", text: "Estudios observacionales vinculan las CVP post-IM con muerte cardiaca subita. La cadena mecanistica parece obvia.", type: "normal" },
            { year: "1980s", text: "Los farmacos antiarritmicos de clase I suprimen las CVP en mas del 80%. Logica: suprimir CVP ‚Üí prevenir muerte.", type: "normal" },
            { year: "1987", text: "Comienza el ensayo CAST. 1,727 pacientes aleatorizados a encainida, flecainida o placebo.", type: "normal" },
            { year: "Abr 1989", text: "El DSMB detiene el ensayo temprano. Muerte arritmia: 4.5% vs 1.2%. RR = 3.6 (IC 95%: 1.7-8.5).", type: "crisis" },
            { year: "1989-91", text: "Se estima que mas de 50,000 estadounidenses murieron por estos farmacos 'efectivos'. El desenlace sustituto engan√≥ a todos.", type: "crisis" },
            { year: "Legado", text: "CAST transformo la cardiologia. La FDA ahora requiere desenlaces de mortalidad para farmacos cardiacos.", type: "revelation" }
          ],
          realData: {
            endpoint: "Muerte arritmia o paro cardiaco",
            drug: "56/730 (7.7%)",
            placebo: "22/725 (3.0%)",
            rr: "2.5",
            ci: "1.6-4.0",
            nnh: "22"
          },
          hook: "Preguntaron: '¬øSuprime las arritmias?' (Si, perfectamente.) Debieron preguntar: '¬øAyuda a los pacientes a vivir?' (No. Los mato.)"
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è PUNTO CLAVE: CAST mato a 50,000 personas porque los investigadores midieron el desenlace equivocado. Un desenlace sustituto (supresion de arritmias) se movio en la direccion correcta mientras los pacientes se movian hacia la muerte. Antes de analizar cualquier cosa, pregunta: ¬øMi desenlace realmente importa a los pacientes?"
        }
      },
      {
        type: 'content',
        content: {
          title: "La Pregunta Incorrecta vs. La Pregunta Correcta",
          sections: [
            {
              heading: "Lo Que Preguntaron:",
              items: [
                "Poblacion: Pacientes post-IM con CVP",
                "Intervencion: Encainida/Flecainida",
                "Comparador: Placebo",
                "Desenlace: Supresion de CVP ‚Üê SUSTITUTO"
              ]
            },
            {
              heading: "Lo Que Debieron Preguntar:",
              items: [
                "Poblacion: Pacientes post-IM con CVP",
                "Intervencion: Encainida/Flecainida",
                "Comparador: Placebo",
                "Desenlace: Mortalidad por todas las causas ‚Üê IMPORTANTE PARA EL PACIENTE"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: MARCO PICO",
          title: "Formulando la Pregunta Correcta",
          sections: [
            {
              heading: "P ‚Äî Poblacion",
              text: "¬øA quienes exactamente estas estudiando? Se especifico sobre criterios de inclusion, severidad de la enfermedad, entorno."
            },
            {
              heading: "I ‚Äî Intervencion",
              text: "¬øQue tratamiento, exposicion o prueba? Incluye dosis, duracion, metodo de administracion."
            },
            {
              heading: "C ‚Äî Comparador",
              text: "¬øComparado con que? ¬øPlacebo, control activo, cuidado habitual, sin intervencion?"
            },
            {
              heading: "O ‚Äî Desenlace (Outcome)",
              text: "¬øQue importa a los pacientes? Prioriza: mortalidad > morbilidad > sintomas > sustitutos"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'pico-builder',
          title: "Constructor PICO",
          description: "Practica formulando tu pregunta de investigacion"
        }
      },
      {
        type: 'content',
        content: {
          title: "EL CEMENTERIO: Cuando los Sustitutos Mataron",
          sections: [
            {
              heading: "CAST (1989) ‚Äî Arritmias Cardiacas",
              items: [
                "Sustituto: Supresion de CVP (los farmacos redujeron arritmias en mas del 80%)",
                "Realidad: La mortalidad se TRIPLICO (RR 3.6, IC 95%: 1.7-8.5)",
                "Se estima que 50,000 estadounidenses murieron por farmacos 'efectivos'",
                "LA LECCION: Las arritmias predicen la muerte, pero suprimirlas no la previene"
              ]
            },
            {
              heading: "ATBC (1994) ‚Äî Beta-Caroteno en Fumadores",
              items: [
                "Sustituto: Niveles sanguineos de antioxidantes (aumentaron como se esperaba)",
                "Realidad: El cancer de pulmon AUMENTO un 16% (RR 1.16, IC 95%: 1.02-1.33)",
                "29,133 fumadores finlandeses danados por una vitamina",
                "Fuente: JNCI 1996; PubMed 8901854"
              ]
            },
            {
              heading: "CARET (1996) ‚Äî Beta-Caroteno + Vitamina A",
              items: [
                "Sustituto: La misma logica antioxidante que ATBC",
                "Realidad: El cancer de pulmon AUMENTO un 28% (RR 1.28, IC 95%: 1.04-1.57)",
                "El ensayo se detuvo temprano por DANO ‚Äî los suplementos estaban matando participantes",
                "Fuente: NEJM 1996; DOI 10.1056/NEJM199605023341802"
              ]
            },
            {
              heading: "EL PATRON: La Logica Mecanistica Falla",
              items: [
                "Arritmias ‚Üí muerte, pero los antiarritmicos no ayudan",
                "Estres oxidativo ‚Üí cancer, pero los antioxidantes no ayudan (y pueden danar)",
                "Colesterol ‚Üí enfermedad cardiaca, pero algunos farmacos para colesterol matan",
                "LA PREGUNTA que siempre debes hacer: ¬øMejorar el sustituto realmente ayuda a los pacientes?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'pico_decision_tree',
          title: "La Decision del Farmaco para Diabetes",
          situation: "Eres el metodologo principal de un meta-analisis. Un nuevo farmaco para diabetes de una compan√≠a farmaceutica muestra una impresionante reduccion de HbA1c en 8 ensayos. Quieren la aprobacion de la FDA.",
          nodes: [
            {
              id: 'start',
              question: "La compan√≠a te pide usar la reduccion de HbA1c como desenlace primario. ¬øQue haces?",
              branches: [
                { id: 'a', text: "Aceptar ‚Äî HbA1c es el desenlace estandar para diabetes", nextNode: 'surrogate_trap' },
                { id: 'b', text: "Insistir en desenlaces cardiovasculares", nextNode: 'cv_outcome' },
                { id: 'c', text: "Preguntar que desenlaces tienen datos disponibles", nextNode: 'investigate' }
              ]
            },
            {
              id: 'surrogate_trap',
              type: 'outcome',
              consequence: 'bad',
              title: "La Repeticion de Rosiglitazona",
              text: "Tu meta-analisis muestra una impresionante reduccion de HbA1c: -1.2% (IC 95%: -1.4 a -1.0). La FDA aprueba. Tres anos despues, un meta-analisis independiente de desenlaces CV encuentra OR 1.43 (IC 95%: 1.03-1.98) para IM. El farmaco es retirado. Preguntaste lo incorrecto.",
              realCase: "Este escenario exacto ocurrio con rosiglitazona (Avandia). Nissen & Wolski, NEJM 2007."
            },
            {
              id: 'cv_outcome',
              type: 'outcome',
              consequence: 'good',
              title: "La Pregunta Correcta",
              text: "Tu meta-analisis de desenlaces CV revela: MACE HR 0.86 (IC 95%: 0.74-0.99). No solo el farmaco reduce HbA1c, sino que realmente previene infartos. Lo has distinguido de farmacos daninos en la misma clase.",
              realCase: "Esto es lo que empagliflozina (EMPA-REG) y liraglutida (LEADER) mostraron ‚Äî pero solo porque hicieron la pregunta correcta."
            },
            {
              id: 'investigate',
              question: "Buen pensamiento. Descubres que tienen datos de desenlaces CV pero no fueron pre-especificados como primarios. Dicen 'Podemos hacer esos analisis tambien.' ¬øAhora que?",
              branches: [
                { id: 'd', text: "Agregar desenlaces CV como analisis exploratorio", nextNode: 'exploratory' },
                { id: 'e', text: "Hacer desenlaces CV el desenlace primario pre-especificado en un nuevo protocolo", nextNode: 'cv_outcome' },
                { id: 'f', text: "Proceder con HbA1c ‚Äî los datos CV son post-hoc de todos modos", nextNode: 'surrogate_trap' }
              ]
            },
            {
              id: 'exploratory',
              type: 'outcome',
              consequence: 'neutral',
              title: "Credito Parcial",
              text: "Tu meta-analisis se publica con HbA1c primario y CV secundario/exploratorio. Los revisores notan los hallazgos CV pero no pueden sacar conclusiones firmes porque no fue pre-especificado. La senal esta ahi, pero la evidencia es mas debil de lo que podria ser.",
              realCase: "Muchos meta-analisis tempranos de diabetes tuvieron este problema ‚Äî datos CV valiosos enterrados como analisis exploratorios."
            }
          ]
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "¬øHas considerado que pasa cuando la pregunta misma esta mal?",
          context: "En los 1980s, los investigadores observaron que las contracciones ventriculares prematuras (CVP) despues de infartos predecian muerte subita. La logica parecia hermetica: suprimir CVP, prevenir muerte. Disenaron un ensayo para responder: '¬øLos antiarritmicos que suprimen CVP reducen la muerte subita?' Los farmacos funcionaron hermosamente en el sustituto. Pero hicieron la pregunta equivocada.",
          stats: [
            { value: "80%+", label: "Supresion de CVP", type: "" },
            { value: "3.6x", label: "Aumento de Mortalidad", type: "danger" },
            { value: "~50,000", label: "Estadounidenses Muertos", type: "danger" },
            { value: "1989", label: "Ensayo Detenido", type: "" }
          ],
          source: "Ensayo CAST - NEJM 1989; 321:406-412",
          decisionScenario: "Estas disenando un ensayo para un nuevo farmaco antiarritmico. El farmaco suprime CVP magnificamente en estudios Fase II. Debes elegir tu desenlace primario.",
          pathA: {
            title: "Usar desenlace sustituto (supresion de CVP)",
            steps: [
              "El ensayo muestra 80% de supresion de CVP",
              "El farmaco parece altamente efectivo",
              "La FDA aprueba basado en el sustituto",
              "Millones de pacientes reciben el farmaco",
              "Post-comercializacion: La mortalidad se TRIPLICA",
              "Se estima que 50,000 estadounidenses mueren por tratamiento 'efectivo'"
            ]
          },
          pathB: {
            title: "Insistir en desenlace duro (mortalidad)",
            steps: [
              "El ensayo toma mas tiempo y cuesta mas",
              "Requiere mayor tamano de muestra",
              "El DSMB detiene el ensayo temprano por dano",
              "El farmaco nunca llega al mercado",
              "50,000 vidas salvadas",
              "La verdad se revela antes, no despues, del dano"
            ]
          },
          revelation: "El PICO determina lo que puedes aprender. Una pregunta incorrecta bien respondida es peor que ninguna respuesta. CAST pregunto '¬øSuprime arritmias?' (Si.) Debieron preguntar '¬øAyuda a los pacientes a vivir?' (No ‚Äî los mato.) La pregunta moldea la respuesta, y la pregunta incorrecta moldeo 50,000 muertes.",
          moduleConnection: "Por esto importa PICO. Tu eleccion de desenlace no es tecnica ‚Äî es etica. Cada meta-analisis hereda las fallas de las preguntas que hicieron sus ensayos componentes."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Un meta-analisis pregunta: '¬øEl Farmaco X reduce la presion arterial?' vs '¬øEl Farmaco X reduce accidentes cerebrovasculares e infartos?' ¬øCual enfoque es mas probable que produzca resultados clinicamente utiles?",
          options: [
            { id: 'a', text: "Presion arterial ‚Äî es mas facil de medir", correct: false },
            { id: 'b', text: "Accidentes cerebrovasculares e infartos ‚Äî son lo que importa a los pacientes", correct: true },
            { id: 'c', text: "Ambos son igualmente utiles", correct: false },
            { id: 'd', text: "Ninguno ‚Äî necesitamos mortalidad por todas las causas", correct: false }
          ],
          explanation: "Aunque la mortalidad por todas las causas es ideal, los eventos cardiovasculares son desenlaces importantes para el paciente que la presion arterial (un sustituto) puede o no predecir. SPRINT mostro que el control intensivo de PA redujo eventos CV, pero ACCORD-BP no ‚Äî no puedes saberlo solo por la PA."
        }
      }
    ]
  },
  {
    id: 2,
    title: "El Protocolo",
    subtitle: "Pre-registro",
    principle: 1,
    story: "HRT",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La pre-especificacion es proteccion"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA REVERSION: TRH ‚Äî EL MAYOR CAMBIO EN MEDICINA",
          source: "JAMA 2002; 288:321-333 | WHI Writing Group | PubMed: 12117397",
          timeline: [
            { year: "1960s-80s", text: "Estudios observacionales consistentemente muestran que la TRH reduce EC en 40-50%. La logica biologica es convincente: el estrogeno mejora los perfiles lipidicos.", type: "normal" },
            { year: "1991", text: "NHS (Estudio de Salud de Enfermeras) publica: RR 0.56 (IC 95% 0.40-0.80) para EC. Millones de mujeres inician TRH para 'proteccion cardiaca.'", type: "normal" },
            { year: "1998", text: "El ensayo HERS sorprende al campo: Sin beneficio en mujeres con EC existente. HR 0.99 (0.81-1.22). Pero se descarta ‚Äî 'poblacion equivocada.'", type: "crisis" },
            { year: "Jul 2002", text: "WHI detenido temprano por DANO. EC HR 1.29 (1.02-1.63). Los 30+ estudios observacionales estaban EQUIVOCADOS.", type: "crisis" },
            { year: "La Verdad", text: "Sesgo del usuario saludable: Las mujeres que eligieron TRH eran mas sanas, hacian mas ejercicio, tenian mejores dietas. El 'beneficio' era confusion, no causalidad.", type: "revelation" }
          ],
          realData: {
            endpoint: "Enfermedad coronaria (EC)",
            drug: "164/8506 (1.93%)",
            placebo: "122/8102 (1.51%)",
            rr: "1.29",
            ci: "1.02-1.63",
            nnh: "238"
          },
          hook: "30 estudios observacionales. 40+ meta-analisis. Todos mostrando beneficio. Todos equivocados. Porque ninguno estaba pre-registrado, ninguno podia rendir cuentas por sus elecciones de analisis."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è PUNTO CLAVE: La TRH fue la mayor reversion en la medicina moderna. Millones de mujeres tomaron hormonas creyendo que prevenian enfermedades cardiacas ‚Äî pero la 'evidencia' venia de investigadores que podian cambiar sus analisis despues de ver resultados. El pre-registro bloquea tus decisiones ANTES de ver los datos, haciendo visible el sesgo y posible la rendicion de cuentas."
        }
      },
      {
        type: 'content',
        content: {
          title: "Por Que Importa el Pre-Registro",
          sections: [
            {
              heading: "Sin Pre-Registro:",
              items: [
                "Cambio de desenlace ‚Äî cambiar endpoints despues de ver datos",
                "Pesca de subgrupos ‚Äî probar muchos subgrupos, reportar los 'significativos'",
                "Flexibilidad de analisis ‚Äî probar diferentes modelos hasta que uno 'funcione'",
                "Reporte selectivo ‚Äî publicar positivos, ocultar negativos"
              ]
            },
            {
              heading: "Con Pre-Registro:",
              items: [
                "Desenlace primario bloqueado antes del analisis de datos",
                "Subgrupos pre-especificados con justificacion",
                "Plan de analisis documentado",
                "Todos los resultados deben reportarse"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: REGISTRO EN PROSPERO",
          title: "Creando un Protocolo",
          sections: [
            {
              heading: "Elementos Esenciales:",
              text: "1. Pregunta PICO\n2. Criterios de elegibilidad\n3. Estrategia de busqueda\n4. Plan de extraccion de datos\n5. Herramienta de riesgo de sesgo\n6. Metodo de sintesis\n7. Analisis de subgrupos (pre-especificados)\n8. Analisis de sensibilidad"
            },
            {
              heading: "Donde Registrar:",
              text: "PROSPERO (prospero.york.ac.uk) ‚Äî registro gratuito, internacional y buscable para revisiones sistematicas. El registro crea una marca de tiempo que prueba que tu plan precedio tu analisis."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'protocol_decision_tree',
          title: "La Tentacion del HARKing",
          situation: "Estas realizando un meta-analisis de un nuevo farmaco antihipertensivo. Tu protocolo especifico 'eventos cardiovasculares' como desenlace primario. Despues de extraer datos, notas que el farmaco parece ayudar particularmente a pacientes diabeticos ‚Äî un subgrupo no planificado.",
          nodes: [
            {
              id: 'start',
              question: "Tu coautor quiere destacar el hallazgo del subgrupo diabetico en el resumen. ¬øQue haces?",
              branches: [
                { id: 'a', text: "Agregarlo como hallazgo clave ‚Äî la senal es fuerte", nextNode: 'harking_trap' },
                { id: 'b', text: "Reportar como exploratorio, claramente etiquetado post-hoc", nextNode: 'proper_reporting' },
                { id: 'c', text: "Ejecutar mas subgrupos para ver si el patron se mantiene", nextNode: 'fishing_expedition' }
              ]
            },
            {
              id: 'harking_trap',
              type: 'outcome',
              consequence: 'bad',
              title: "La Trampa del HARKing",
              text: "Has cometido HARKing ‚Äî Hipotetizar Despues de que los Resultados son Conocidos. Tu 'descubrimiento' tiene una tasa de falsos positivos de ~40% debido a pruebas multiples. Cuando un estudio de replicacion falla en confirmarlo, tu credibilidad sufre.",
              realCase: "ISIS-2 mostro famosamente que la aspirina solo funcionaba para Geminis y Libras ‚Äî un falso positivo obvio que ilustra por que los subgrupos post-hoc no son confiables."
            },
            {
              id: 'proper_reporting',
              question: "Buena eleccion. Pero el editor de la revista insiste: 'El hallazgo diabetico es la parte mas interesante. ¬øPuedes hacerlo mas prominente?' ¬øAhora que?",
              branches: [
                { id: 'd', text: "Aceptar enfatizarlo en el titulo/resumen", nextNode: 'editor_pressure' },
                { id: 'e', text: "Explicar las preocupaciones estadisticas y mantener la posicion", nextNode: 'integrity_win' },
                { id: 'f', text: "Retirar e intentar con otra revista", nextNode: 'withdraw' }
              ]
            },
            {
              id: 'fishing_expedition',
              type: 'outcome',
              consequence: 'bad',
              title: "La Expedicion de Pesca",
              text: "Ejecutas 15 analisis de subgrupos. Tres muestran resultados 'significativos' (p < 0.05). Pero con 15 pruebas, esperarias ~1 falso positivo solo por azar. Has encontrado ruido, no senal. Tu meta-analisis se vuelve poco confiable.",
              realCase: "El ensayo ACCORD ejecuto multiples subgrupos ‚Äî encontrando 'beneficio' en algunos y 'dano' en otros. La mayoria eran artefactos estadisticos."
            },
            {
              id: 'editor_pressure',
              type: 'outcome',
              consequence: 'neutral',
              title: "El Compromiso",
              text: "El articulo se publica con el subgrupo diabetico prominente. Los clinicos comienzan a recetar preferencialmente a diabeticos. Anos despues, un ensayo dedicado en diabeticos no muestra beneficio especial. Tu meta-analisis contribuyo a practica clinica equivocada.",
              realCase: "Muchos farmacos mostraron 'beneficios de subgrupo' en meta-analisis que desaparecieron en ensayos dedicados."
            },
            {
              id: 'integrity_win',
              type: 'outcome',
              consequence: 'good',
              title: "La Integridad Cientifica Gana",
              text: "Explicas que los hallazgos exploratorios requieren confirmacion. El articulo se publica con advertencias apropiadas. Un ensayo posterior prueba especificamente la hipotesis diabetica y confirma el hallazgo ‚Äî ahora con pre-especificacion adecuada. Te dan credito por identificar una hipotesis que vale la pena probar.",
              realCase: "Asi es como debe funcionar la ciencia: los hallazgos exploratorios generan hipotesis; los ensayos confirmatorios las prueban."
            },
            {
              id: 'withdraw',
              type: 'outcome',
              consequence: 'neutral',
              title: "La Retirada con Principios",
              text: "Otra revista acepta el articulo con etiquetado exploratorio apropiado. Toma mas tiempo pero mantiene el rigor cientifico. El hallazgo eventualmente se prueba en un ensayo dedicado.",
              realCase: "A veces la eleccion correcta significa aceptar una publicacion mas lenta por mejor ciencia."
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "¬øCual es el proposito principal de registrar un protocolo de revision sistematica en PROSPERO antes de comenzar la extraccion de datos?",
          options: [
            { id: 'a', text: "Reclamar prioridad sobre otros investigadores", correct: false },
            { id: 'b', text: "Prevenir el cambio de desenlaces y el reporte selectivo", correct: true },
            { id: 'c', text: "Obtener aprobacion etica", correct: false },
            { id: 'd', text: "Asegurar tamano de muestra adecuado", correct: false }
          ],
          explanation: "El registro de protocolo crea una marca de tiempo que prueba que tus desenlaces, subgrupos y analisis fueron especificados antes de ver los datos. Esto previene HARKing y p-hacking, que inflan las tasas de falsos positivos."
        }
      }
    ]
  },
  {
    id: 3,
    title: "La Busqueda",
    subtitle: "Encontrando Toda la Evidencia",
    principle: 2,
    story: "Rosiglitazone",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Lo que no buscas, no encontraras"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA REVERSION: ROSIGLITAZONA ‚Äî ESCONDIDA A PLENA VISTA",
          source: "NEJM 2007; 356:2457-2471 | Nissen & Wolski | PubMed: 17517853",
          timeline: [
            { year: "1999", text: "La FDA aprueba rosiglitazona (Avandia) para diabetes basada en reduccion de HbA1c. Se convierte en exito de ventas ‚Äî $3 mil millones/ano.", type: "normal" },
            { year: "2000-06", text: "GSK realiza 42 ensayos. Muchos muestran senales CV preocupantes. La mayoria nunca se publican. Los datos estan en archivos de la FDA y ClinicalTrials.gov.", type: "normal" },
            { year: "May 2007", text: "Nissen busca en presentaciones a la FDA, ClinicalTrials.gov, y pide a GSK datos no publicados. Encuentra lo que otros no vieron.", type: "revelation" },
            { year: "May 2007", text: "Meta-analisis publicado: OR 1.43 (1.03-1.98) para IM. El dano cardiaco era visible en datos no publicados por ANOS.", type: "crisis" },
            { year: "2010-11", text: "La FDA restringe el uso. Reguladores europeos suspenden la comercializacion. Se estiman 47,000 infartos en exceso causados.", type: "crisis" }
          ],
          realData: {
            endpoint: "Infarto de miocardio",
            drug: "86/15,560 (0.55%)",
            placebo: "72/12,283 (0.59%)",
            rr: "1.43",
            ci: "1.03-1.98",
            nnh: "52"
          },
          hook: "La senal estaba ahi en 2000. Tomo 7 anos y un investigador dispuesto a buscar mas alla de PubMed para encontrarla. ¬øCuantos murieron esperando?"
        }
      },
      {
        type: 'content',
        content: {
          title: "Donde se Esconde la Evidencia",
          sections: [
            {
              heading: "Literatura Publicada (Lo Que la Mayoria de Busquedas Encuentran):",
              items: [
                "PubMed/MEDLINE ‚Äî revistas biomedicas",
                "EMBASE ‚Äî enfoque europeo/farmacos",
                "CENTRAL ‚Äî registro de ensayos de Cochrane"
              ]
            },
            {
              heading: "Literatura Gris (Lo Que la Mayoria de Busquedas No Encuentran):",
              items: [
                "ClinicalTrials.gov ‚Äî ensayos registrados, muchos no publicados",
                "Presentaciones FDA/EMA ‚Äî datos regulatorios no en revistas",
                "OMS ICTRP ‚Äî registro internacional de ensayos",
                "Resumenes de conferencias ‚Äî datos preliminares",
                "Tesis/disertaciones ‚Äî resultados negativos a menudo aqui",
                "Datos del fabricante ‚Äî pueden necesitarse solicitudes FOIA"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: BUSQUEDA EXHAUSTIVA",
          title: "Construyendo una Estrategia de Busqueda",
          sections: [
            {
              heading: "Paso 1: Identificar Conceptos",
              text: "Descompone tu PICO en conceptos buscables. Para rosiglitazona + cardiovascular: (rosiglitazona OR Avandia) AND (infarto de miocardio OR ataque cardiaco OR cardiovascular)"
            },
            {
              heading: "Paso 2: Expandir con Sinonimos",
              text: "Usa terminos MeSH, nombres comerciales, nombres genericos, variantes ortograficas. Omite un sinonimo, omites estudios."
            },
            {
              heading: "Paso 3: Buscar en Multiples Fuentes",
              text: "Minimo: MEDLINE + EMBASE + CENTRAL + registros de ensayos + revision de referencias. Mejor: agregar literatura gris, contactar expertos."
            },
            {
              heading: "Paso 4: Documentar Todo",
              text: "Registra cadenas de busqueda exactas, fechas, resultados. La reproducibilidad requiere transparencia."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'search-builder',
          title: "Constructor de Estrategia de Busqueda",
          description: "Construye cadenas de busqueda especificas para bases de datos desde tu PICO"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'search_decision_tree',
          title: "La Caza de Datos Ocultos",
          situation: "Estas meta-analizando un farmaco para diabetes (similar a rosiglitazona). PubMed te da 15 ensayos mostrando beneficio. Pero ClinicalTrials.gov muestra 23 ensayos registrados. Ocho ensayos completados no tienen publicaciones.",
          nodes: [
            {
              id: 'start',
              question: "Has encontrado 8 ensayos faltantes. El plazo es ajustado. ¬øCual es tu primer movimiento?",
              branches: [
                { id: 'a', text: "Proceder con 15 ensayos publicados ‚Äî estan revisados por pares", nextNode: 'proceed_published' },
                { id: 'b', text: "Contactar al fabricante por datos no publicados", nextNode: 'contact_manufacturer' },
                { id: 'c', text: "Buscar documentos de aprobacion de la FDA e informes de comites asesores", nextNode: 'search_fda' }
              ]
            },
            {
              id: 'proceed_published',
              type: 'outcome',
              consequence: 'bad',
              title: "La Repeticion de Rosiglitazona",
              text: "Tu meta-analisis muestra beneficio (RR 0.85, IC 0.78-0.93). Se publica en una revista de alto nivel. Tres anos despues, alguien encuentra los ensayos faltantes en archivos de la FDA. Mostraban DANO. Tu meta-analisis engan√≥ a miles de clinicos.",
              realCase: "Esto es exactamente lo que ocurrio con rosiglitazona. La literatura publicada mostraba beneficio glucemico. Los datos ocultos mostraban dano cardiaco."
            },
            {
              id: 'contact_manufacturer',
              question: "El fabricante responde: 'Podemos compartir datos resumidos pero no datos a nivel de paciente, y tomara 6 meses.' Mientras tanto, tu competidor esta a punto de publicar su meta-analisis usando solo datos publicados.",
              branches: [
                { id: 'd', text: "Apresurarse a publicar primero con datos disponibles", nextNode: 'rush_publish' },
                { id: 'e', text: "Esperar los datos del fabricante, aunque te adelanten", nextNode: 'wait_data' },
                { id: 'f', text: "Publicar ahora pero pre-registrar una actualizacion cuando lleguen los datos", nextNode: 'staged_approach' }
              ]
            },
            {
              id: 'search_fda',
              question: "¬°Encuentras documentos informativos de la FDA! Contienen datos de 6 de los 8 ensayos faltantes. Los datos de seguridad cardiaca son preocupantes ‚Äî eventos elevados en 4 de 6 ensayos. ¬øAhora que?",
              branches: [
                { id: 'g', text: "Incluir los datos de la FDA en tu meta-analisis", nextNode: 'include_fda' },
                { id: 'h', text: "La calidad de datos de la FDA no esta clara ‚Äî quedarse solo con publicados", nextNode: 'proceed_published' },
                { id: 'i', text: "Ejecutar analisis paralelos con y sin datos de la FDA", nextNode: 'sensitivity_analysis' }
              ]
            },
            {
              id: 'rush_publish',
              type: 'outcome',
              consequence: 'bad',
              title: "La Carrera Hacia el Fondo",
              text: "Ganas a tu competidor por 2 meses. Pero ambos meta-analisis estan incompletos. Cuando emergen los datos completos, ambos se muestran sesgados. Tu reputacion de rigor sufre.",
              realCase: "El incentivo academico de publicar primero a menudo entra en conflicto con la necesidad cientifica de ser completo."
            },
            {
              id: 'wait_data',
              type: 'outcome',
              consequence: 'good',
              title: "La Paciencia Gana",
              text: "Tu competidor publica primero con datos incompletos. Tu esperas. Cuando aparece tu meta-analisis completo, revela la senal de seguridad cardiaca que ellos omitieron. Tu articulo se convierte en la referencia definitiva. Las guias clinicas TE citan.",
              realCase: "El meta-analisis de rosiglitazona de Nissen tuvo exito porque espero por datos de la FDA que otros ignoraron."
            },
            {
              id: 'staged_approach',
              type: 'outcome',
              consequence: 'neutral',
              title: "El Punto Medio Pragmatico",
              text: "Publicas hallazgos preliminares con limitaciones claras, pre-registrando una actualizacion. Esto es honesto pero arriesga que los hallazgos preliminares sean sobre-interpretados. Cuando la actualizacion muestra resultados diferentes, algunos lo ven como 'indecision.'",
              realCase: "Las revisiones sistematicas vivas usan este enfoque, pero manejar la comunicacion es desafiante."
            },
            {
              id: 'include_fda',
              type: 'outcome',
              consequence: 'good',
              title: "La Imagen Completa",
              text: "Tu meta-analisis incluye datos de la FDA. El efecto combinado cambia: RR 1.15 (0.98-1.35) ‚Äî ya no muestra beneficio, tendencia hacia dano. Has revelado la verdad oculta en literatura gris. Los reguladores toman nota.",
              realCase: "El analisis de rosiglitazona de Nissen uso datos de la FDA que transformaron un farmaco 'beneficioso' en uno peligroso."
            },
            {
              id: 'sensitivity_analysis',
              type: 'outcome',
              consequence: 'good',
              title: "Transparencia a Traves de Sensibilidad",
              text: "Tu articulo muestra: Solo publicados: RR 0.85 (beneficio). Con datos FDA: RR 1.15 (tendencia a dano). El contraste es marcado. Los lectores pueden ver como el sesgo de publicacion distorsiona la evidencia. Tu articulo se convierte en ejemplo didactico.",
              realCase: "Los mejores meta-analisis muestran como cambian los resultados con diferentes decisiones de inclusion."
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "¬øPor que es esencial buscar en ClinicalTrials.gov aunque tengas una busqueda exhaustiva en MEDLINE?",
          options: [
            { id: 'a', text: "Tiene mejor funcionalidad de busqueda que MEDLINE", correct: false },
            { id: 'b', text: "Contiene ensayos registrados que pueden nunca publicarse", correct: true },
            { id: 'c', text: "Tiene publicaciones mas recientes", correct: false },
            { id: 'd', text: "Es requerido por PRISMA pero no es realmente util", correct: false }
          ],
          explanation: "Aproximadamente el 50% de los ensayos registrados nunca se publican, y los ensayos no publicados tienen mas probabilidad de tener resultados negativos o daninos. ClinicalTrials.gov revela lo que falta en la literatura publicada."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ VERIFICACION DE PROGRESO: Has dominado los FUNDAMENTOS del meta-analisis.\n\n‚úì Modulo 1: La PREGUNTA correcta (PICO) ‚Äî aprendido de la trampa del sustituto de CAST\n‚úì Modulo 2: Registro de PROTOCOLO ‚Äî aprendido del sesgo del usuario saludable de TRH\n‚úì Modulo 3: Busqueda EXHAUSTIVA ‚Äî aprendido de los datos ocultos de rosiglitazona\n\nSiguiente: Aprenderas a SELECCIONAR, EXTRAER y EVALUAR los estudios que encuentres.\n\nLos primeros tres principios te protegen de hacer la pregunta equivocada. Los siguientes cuatro te protegen de obtener la respuesta equivocada."
        }
      }
    ]
  },
  // Modulo 4: La Seleccion
  {
    id: 4,
    title: "La Seleccion",
    subtitle: "Seleccion de Estudios",
    principle: 3,
    story: "Vitamin E",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Cada numero necesita una fuente"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA CONTRADICCION: VITAMINA E ‚Äî ¬øSALVADORA O ASESINA?",
          source: "Annals Int Med 2005; 142:37-46 | Miller et al | PubMed: 15537682",
          timeline: [
            { year: "1993", text: "Datos observacionales de NHANES sugieren que la vitamina E reduce la enfermedad cardiaca. Las ventas de suplementos se disparan a $600M/ano.", type: "normal" },
            { year: "1996-2004", text: "Multiples ECAs completados: ATBC, GISSI, HOPE, HPS. Los resultados son mixtos, confusos.", type: "normal" },
            { year: "2004 (Ene)", text: "Meta-analisis A: Vitamina E 'puede prevenir' ECV. Incluye 7 ensayos con cualquier dosis. RR 0.89 (0.80-0.99).", type: "normal" },
            { year: "2004 (Nov)", text: "Meta-analisis B: Vitamina E AUMENTA la mortalidad a dosis altas (‚â•400 UI). RR 1.04 (1.01-1.07). Usa analisis dosis-respuesta.", type: "crisis" },
            { year: "La Verdad", text: "Mismos ensayos, diferentes criterios de inclusion, conclusiones opuestas. Las elecciones del meta-analista determinaron la respuesta antes de que comenzara el analisis.", type: "revelation" }
          ],
          realData: {
            endpoint: "Mortalidad por todas las causas",
            drug: "Vitamina E dosis alta (‚â•400 UI/d)",
            placebo: "Control",
            rr: "1.04",
            ci: "1.01-1.07",
            nnh: "200"
          },
          hook: "Dos investigadores honestos. Mismo ano. Mismos ensayos. Conclusiones opuestas. La unica diferencia: sus criterios de inclusion. Cada decision de elegibilidad es una hipotesis oculta."
        }
      },
      {
        type: 'content',
        content: {
          title: "Criterios de Elegibilidad: La Tesis Oculta",
          sections: [
            {
              heading: "Lo Que Hacen los Criterios de Inclusion:",
              items: [
                "Definen tu poblacion (¬øque pacientes cuentan?)",
                "Definen intervencion adecuada (¬øque dosis? ¬øduracion?)",
                "Definen comparaciones significativas (¬øque controles?)",
                "Definen evidencia creible (¬øsolo ECAs? ¬øObservacionales?)"
              ]
            },
            {
              heading: "Lo Que Puede Salir Mal:",
              items: [
                "Demasiado amplio: el ruido ahoga la senal",
                "Demasiado estrecho: seleccion conveniente",
                "Criterios vagos: aplicacion inconsistente",
                "Cambios post-hoc: sesgo hacia resultado deseado"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: SELECCION SISTEMATICA",
          title: "De Miles a Incluidos",
          sections: [
            {
              heading: "Paso 1: Operacionalizar Criterios",
              text: "Convierte PICO en reglas de inclusion/exclusion verificables. 'Adultos con diabetes' se convierte en 'Edad ‚â•18, diagnostico de DM1 o DM2 segun criterios ADA, cualquier entorno.'"
            },
            {
              heading: "Paso 2: Seleccion Dual",
              text: "Dos revisores seleccionan independientemente titulos/resumenes, luego textos completos. Calcula acuerdo (kappa). Desacuerdos resueltos por discusion o tercer revisor."
            },
            {
              heading: "Paso 3: Documentar Decisiones",
              text: "Registra razon de cada exclusion. Diagrama de flujo PRISMA muestra: identificados ‚Üí seleccionados ‚Üí elegibles ‚Üí incluidos, con razones de exclusion."
            },
            {
              heading: "Paso 4: Manejar Casos Limite",
              text: "Pre-especifica reglas para situaciones ambiguas. En caso de duda, incluir para revision de texto completo. Reporta analisis de sensibilidad con/sin estudios limite."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'prisma-flow',
          title: "Generador de Diagrama PRISMA",
          description: "Crea un diagrama de flujo PRISMA 2020 documentando tu proceso de seleccion"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'screen_decision_tree',
          title: "El Estudio Limite",
          scenario: "Has seleccionado 2,847 registros para tu meta-analisis de meditacion-ansiedad. 23 estudios estan claramente incluidos. Pero un estudio ‚Äî MBSR con componentes de yoga ‚Äî esta en el limite. Tu protocolo decia 'intervenciones de meditacion' pero no abordaba especificamente programas de mindfulness con componentes mixtos.",
          realCase: "Los meta-analisis de Vitamina E de los 2000s mostraron conclusiones dramaticamente diferentes basadas en criterios de inclusion. Miller et al. incluyo solo ensayos de dosis alta y encontro mortalidad aumentada. Otros, usando criterios mas amplios, no encontraron dano.",
          nodes: {
            start: {
              id: 'start',
              situation: "El estudio limite MBSR (n=89) muestra DME = -0.15 (efecto pequeno). Tus 23 estudios actuales dan DME = -0.42 (p = 0.03). Con este estudio: DME = -0.38 (p = 0.07).",
              question: "¬øTu primer instinto?",
              branches: [
                { id: 'exclude_path', text: "Excluirlo ‚Äî no cumple criterios estrictos", nextNode: 'exclude_consequence' },
                { id: 'include_path', text: "Incluirlo ‚Äî MBSR es suficientemente cercano", nextNode: 'include_consequence' },
                { id: 'investigate_path', text: "Espera ‚Äî deberia revisar mi protocolo primero", nextNode: 'check_protocol' }
              ]
            },
            exclude_consequence: {
              id: 'exclude_consequence',
              situation: "Excluyes el estudio. Tu resultado se vuelve significativo (p = 0.03). El articulo es aceptado. Seis meses despues, un lector escribe: 'Tu tabla suplementaria muestra que 3 otros estudios incluidos tambien tenian componentes de yoga. ¬øPor que se excluyo este?'",
              question: "¬øComo respondes?",
              branches: [
                { id: 'admit_error', text: "Reconocer la inconsistencia", nextNode: 'inconsistency_lesson' },
                { id: 'defend_decision', text: "Defender mi decision original", nextNode: 'defense_fails' }
              ]
            },
            inconsistency_lesson: {
              id: 'inconsistency_lesson',
              situation: "Te das cuenta que aplicaste criterios inconsistentemente ‚Äî manteniendo otros estudios de componentes mixtos mientras excluias este. ¬øEl factor comun? El efecto de este estudio diluia tu resultado.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA ADVERTENCIA: La exclusion post-hoc que convenientemente mejora resultados es una forma de sesgo de seleccion. Las controversias de Vitamina E nos ensenaron: los criterios de inclusion deben aplicarse ciegamente a los resultados. Una vez que ves los datos, no puedes des-verlos."
            },
            defense_fails: {
              id: 'defense_fails',
              situation: "Argumentas que el componente de yoga era 'mas prominente' en este estudio. El lector responde: 'Revise ‚Äî el Estudio 7 en tu analisis tenia 40% de tiempo de yoga. El estudio excluido tenia 30%.' No tienes justificacion objetiva.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: La aplicacion inconsistente de criterios sin documentacion socava todo tu analisis. Asi es como los meta-analisis de Vitamina E perdieron credibilidad ‚Äî los lectores no podian distinguir que exclusiones eran con principios vs. convenientes."
            },
            include_consequence: {
              id: 'include_consequence',
              situation: "Incluyes el estudio. Tu DME combinado = -0.38 (IC 95%: -0.79 a 0.03, p = 0.07). Un revisor escribe: 'El resultado no es estadisticamente significativo. Esto parece un hallazgo negativo.'",
              question: "¬øComo enmarcos esto en tu discusion?",
              branches: [
                { id: 'negative_framing', text: "La meditacion no muestra beneficio significativo para ansiedad", nextNode: 'oversimplified' },
                { id: 'nuanced_framing', text: "Reportar analisis de sensibilidad y discutir decision limite", nextNode: 'transparency_win' }
              ]
            },
            oversimplified: {
              id: 'oversimplified',
              situation: "Tu articulo concluye 'la meditacion no fue efectiva.' Pero el tamano del efecto fue moderado (DME = -0.38) con IC amplio. Un meta-analisis diferente, excluyendo el estudio limite, concluye 'la meditacion es efectiva.' Ahora hay revisiones contradictorias.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REPETICION: Recuerda la historia de Vitamina E ‚Äî diferentes criterios de inclusion llevaron a conclusiones opuestas. Ninguna estaba equivocada, pero ninguna decia toda la verdad. El estatus del estudio limite debio discutirse explicitamente."
            },
            transparency_win: {
              id: 'transparency_win',
              situation: "Tu articulo reporta: 'En analisis primario (24 estudios), DME = -0.38 (p = 0.07). En analisis de sensibilidad excluyendo un estudio limite MBSR, DME = -0.45 (p = 0.03). Las conclusiones son sensibles a esta decision.' Los revisores elogian la transparencia.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: Al mostrar ambos analisis, dejas que los lectores vean la verdad: la evidencia esta en el limite. Algunos encontraran esto insatisfactorio. Pero la incertidumbre honesta supera a la precision falsa. Asi es como debe funcionar el meta-analisis."
            },
            check_protocol: {
              id: 'check_protocol',
              situation: "Revisas tu registro PROSPERO. Dice: 'Intervenciones de meditacion incluyendo programas basados en mindfulness.' MBSR es un programa basado en mindfulness. Pero te das cuenta que no pre-especificaste que hacer con componentes mixtos.",
              question: "¬øCual es tu siguiente paso?",
              branches: [
                { id: 'protocol_amendment', text: "Presentar una enmienda de protocolo y documentar la decision", nextNode: 'good_process' },
                { id: 'retroactive_rule', text: "Decidir ahora basado en los datos", nextNode: 'biased_decision' }
              ]
            },
            good_process: {
              id: 'good_process',
              situation: "Presentas una enmienda: 'Estudios con ‚â•50% de tiempo de meditacion seran incluidos; otros en analisis de sensibilidad.' El estudio limite tiene 70% de tiempo de meditacion. Lo incluyes. Documentas esto ANTES de ver su efecto en tu estimacion combinada.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: La pre-especificacion te protege de ti mismo. Al establecer la regla antes de ver sus consecuencias, eliminas la tentacion de manipular los criterios de inclusion. Este es el Principio 2: 'La pre-especificacion es proteccion.'"
            },
            biased_decision: {
              id: 'biased_decision',
              situation: "Miras los datos primero. El estudio limite diluye tu efecto. Decides excluirlo. Pero ahora tu decision esta contaminada ‚Äî no puedes des-saber que excluirlo hace tu resultado significativo.",
              isEnding: true,
              outcome: 'bad',
              lesson: "EL GANCHO REGRESA: Asi es exactamente como comenzaron las controversias de Vitamina E. Los investigadores tomaron decisiones 'razonables' que resultaron alinearse con sus conclusiones preferidas. La secuencia importa: reglas primero, datos despues."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Dos revisores independientes seleccionan 500 resumenes. El Revisor A incluye 45, el Revisor B incluye 52, y coinciden en 38. ¬øQue sugiere esto?",
          options: [
            { id: 'a', text: "Excelente acuerdo ‚Äî proceder a texto completo", correct: false },
            { id: 'b', text: "Acuerdo moderado ‚Äî discutir desacuerdos, clarificar criterios", correct: true },
            { id: 'c', text: "Acuerdo pobre ‚Äî comenzar de nuevo con nuevos revisores", correct: false },
            { id: 'd', text: "El acuerdo no puede evaluarse con esta informacion", correct: false }
          ],
          explanation: "Esto representa un kappa de aproximadamente 0.65 (acuerdo moderado). Los desacuerdos en 21 resumenes (14+7) necesitan discusion. Frecuentemente, criterios vagos causan inconsistencia ‚Äî clarificarlos mejora la confiabilidad para futuras selecciones."
        }
      }
    ]
  },
  // Modulo 5: La Extraccion
  {
    id: 5,
    title: "La Extraccion",
    subtitle: "Extraccion de Datos",
    principle: 3,
    story: "DECREASE",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Cada numero necesita una fuente"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "EL FRAUDE: DECREASE ‚Äî CUANDO LOS DATOS SON DEMASIADO BUENOS",
          source: "Investigacion Erasmus MC 2012 | Eur Heart J 2014; 35:1972-1973",
          timeline: [
            { year: "1999", text: "Poldermans publica DECREASE-I: ¬°los betabloqueantes reducen la muerte perioperatoria en un 90%! (0.7% vs 3.4%). Los resultados parecen milagrosos.", type: "normal" },
            { year: "2002-09", text: "Se publican DECREASE-II, III, IV. Todos muestran beneficio dramatico. Poldermans lidera comites de guias europeas. Los betabloqueantes se vuelven estandar de cuidado.", type: "normal" },
            { year: "2009", text: "El ensayo POISE (8,351 pacientes) muestra que los betabloqueantes AUMENTAN la mortalidad en cirugia. Contradice DECREASE completamente.", type: "crisis" },
            { year: "2011", text: "Erasmus MC investiga. Encuentra: pacientes fantasma, datos imposibles, formularios de consentimiento falsificados. Poldermans despedido.", type: "crisis" },
            { year: "2013", text: "Cochrane re-analiza sin DECREASE. El beneficio de betabloqueantes desaparece. Las guias basadas en fraude por 12 anos.", type: "revelation" }
          ],
          realData: {
            endpoint: "Muerte cardiaca perioperatoria (fabricada)",
            drug: "1/53 (afirmado)",
            placebo: "9/59 (afirmado)",
            rr: "0.09",
            ci: "0.02-0.66",
            nnh: "N/A ‚Äî LOS DATOS FUERON FABRICADOS"
          },
          hook: "DECREASE mostraba I¬≤ = 0% cuando se agregaba a meta-analisis. La medicina real es desordenada. Cuando la heterogeneidad desaparece, pregunta: ¬øEs esto demasiado perfecto para ser verdad?"
        }
      },
      {
        type: 'content',
        content: {
          title: "Integridad de Datos: Confiar pero Verificar",
          sections: [
            {
              heading: "Senales de Alerta para Datos Problematicos:",
              items: [
                "Resultados demasiado buenos para ser verdad (I¬≤=0% en poblaciones diversas)",
                "Caracteristicas basales perfectamente balanceadas",
                "Medias/DE inverosimiles (ej., DE = media/10 exactamente)",
                "Publicaciones duplicadas con numeros ligeramente diferentes",
                "Datos crudos faltantes a pesar de solicitudes"
              ]
            },
            {
              heading: "La Prueba GRIM:",
              items: [
                "Verifica si las medias reportadas son matematicamente posibles dado N",
                "Ejemplo: Media de 3.47 con N=25 es imposible (25√ó3.47=86.75, no es entero)",
                "Pruebas GRIM fallidas sugieren fabricacion o errores de transcripcion"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: EXTRACCION RIGUROSA",
          title: "Capturando Datos con Precision",
          sections: [
            {
              heading: "Formularios Estandarizados",
              text: "Crea formularios de extraccion con: ID del estudio, caracteristicas de poblacion, detalles de intervencion, definiciones de desenlaces, puntos temporales, estimaciones de efecto, medidas de varianza, items de riesgo de sesgo."
            },
            {
              heading: "Extraccion Dual",
              text: "Dos extractores capturan datos independientemente. Comparan formularios, resuelven discrepancias revisando la fuente. Calcula tasa de error ‚Äî si es alta, re-entrena o simplifica el formulario."
            },
            {
              heading: "Contactando Autores",
              text: "¬øDatos faltantes? Contacta a los autores. Documenta todas las solicitudes y respuestas. Si no hay respuesta despues de 2 intentos, reporta en limitaciones. Considera implicaciones de intencion-de-tratar."
            },
            {
              heading: "Verificacion de Datos",
              text: "Verifica consistencia interna: ¬øLos subgrupos suman al total? ¬øLos porcentajes coinciden con Ns? ¬øEl forest plot coincide con el texto? Ejecuta pruebas GRIM/SPRITE en datos sospechosos."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'extraction-form',
          title: "Constructor de Formulario de Extraccion",
          description: "Crea formularios de extraccion estandarizados para tu revision sistematica"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'extract_decision_tree',
          title: "El Patron Sospechoso",
          scenario: "Estas extrayendo datos para un meta-analisis de estatinas. Un ensayo grande (n=3,200) reporta tasas de IM de exactamente 4.0% tratamiento, 6.0% control. El autor principal ha tenido dos retracciones recientes. Cuando agregas este estudio, I¬≤ cae de 45% a 0%.",
          realCase: "Los ensayos DECREASE de Don Poldermans mostraron que los betabloqueantes reducian la muerte perioperatoria en 90%. Demasiado bueno para ser verdad. En 2012, Erasmus MC encontro pacientes fabricados, consentimientos falsificados y datos imposibles. Las guias habian estado basadas en fraude por 12 anos.",
          nodes: {
            start: {
              id: 'start',
              situation: "El ensayo sospechoso representa el 40% de tu muestra total. Tus otros 8 ensayos muestran resultados heterogeneos (I¬≤=45%). Agregando este ensayo: I¬≤=0%, RR combinado 0.67 (altamente significativo). Sin el: I¬≤=45%, RR combinado 0.78 (apenas significativo).",
              question: "¬øComo procedes?",
              branches: [
                { id: 'trust_path', text: "Incluirlo ‚Äî esta revisado por pares y publicado", nextNode: 'trust_consequence' },
                { id: 'exclude_path', text: "Excluirlo ‚Äî las retracciones significan que el autor es sospechoso", nextNode: 'exclude_consequence' },
                { id: 'investigate_path', text: "Investigar los datos mas cuidadosamente primero", nextNode: 'investigation' }
              ]
            },
            trust_consequence: {
              id: 'trust_consequence',
              situation: "Incluyes el estudio. Tu meta-analisis se publica con resultados fuertes y precisos (I¬≤=0%). Es citado 200 veces. Tres anos despues, el ensayo sospechoso es retractado por fabricacion de datos.",
              question: "¬øQue le pasa a tu meta-analisis?",
              branches: [
                { id: 'update_meta', text: "Publicas una correccion eliminando el ensayo", nextNode: 'damage_done' },
                { id: 'leave_meta', text: "No actualizas ‚Äî es solo uno de nueve ensayos", nextNode: 'contamination' }
              ]
            },
            damage_done: {
              id: 'damage_done',
              situation: "Tu correccion muestra: sin el ensayo fabricado, el efecto es mas debil y heterogeneo. Pero 180 de los 200 articulos que citan usaron tu estimacion inflada original. Las guias fueron actualizadas basadas en tus resultados originales. La practica clinica cambio.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: Como DECREASE, el dano de datos fabricados se extiende mucho mas alla del articulo original. La revision Cochrane de betabloqueantes tuvo que retirarse. Las guias habian recomendado dano. Confia en la revision por pares, pero verifica patrones sospechosos."
            },
            contamination: {
              id: 'contamination',
              situation: "Tu meta-analisis sin corregir continua circulando. Nuevos meta-analisis citan el tuyo como evidencia. Los datos fabricados se propagan a traves de la literatura. Te has convertido en un vector de desinformacion.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA ADVERTENCIA: Los datos fraudulentos no solo afectan un articulo. Como un virus, se replican a traves de citas. DECREASE influencio miles de pacientes antes del descubrimiento. Tu responsabilidad se extiende mas alla de tu propio analisis."
            },
            exclude_consequence: {
              id: 'exclude_consequence',
              situation: "Excluyes basado en el historial del autor. Un revisor pregunta: 'Excluiste un ensayo de 3,200 pacientes basado en el otro trabajo del autor. ¬øTienes evidencia de que ESTE estudio es problematico? Esto parece culpa por asociacion.'",
              question: "¬øComo justificas tu decision?",
              branches: [
                { id: 'admit_bias', text: "Reconocer que esta basado en sospecha, no evidencia", nextNode: 'unfair_exclusion' },
                { id: 'find_evidence', text: "Volver y buscar problemas a nivel de datos", nextNode: 'belated_investigation' }
              ]
            },
            unfair_exclusion: {
              id: 'unfair_exclusion',
              situation: "El revisor rechaza: 'Excluir estudios basados en reputacion del autor en lugar de calidad de datos introduce sesgo. Si no puedes documentar problemas con este estudio especifico, incluyelo con analisis de sensibilidad.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REVELACION GRADUAL: La sospecha no es evidencia. No puedes excluir estudios porque desconfias del autor ‚Äî necesitas documentar problemas con el estudio mismo. El enfoque correcto: investigar primero, luego decidir basado en lo que encuentres."
            },
            belated_investigation: {
              id: 'belated_investigation',
              situation: "Investigas y encuentras: (1) caracteristicas basales imposiblemente balanceadas, (2) DE = media/10 exactamente para todas las variables continuas, (3) no se reportan abandonos a pesar de 2 anos de seguimiento. Ahora tienes preocupaciones documentadas.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: Ahora tienes razones con principios para preocuparte. Incluye el estudio en el analisis primario, conduce analisis de sensibilidad sin el, y documenta las senales de alerta. Deja que los lectores juzguen. Esto es transparencia sobre la incertidumbre."
            },
            investigation: {
              id: 'investigation',
              situation: "Examinas el ensayo sospechoso mas de cerca. ¬øQue revisas primero?",
              question: "Elige tu enfoque de investigacion:",
              branches: [
                { id: 'check_balance', text: "Revisar caracteristicas basales por balance imposible", nextNode: 'baseline_check' },
                { id: 'check_variance', text: "Revisar DE y varianzas por patrones sospechosos", nextNode: 'variance_check' },
                { id: 'check_registry', text: "Comparar con registro de ClinicalTrials.gov", nextNode: 'registry_check' }
              ]
            },
            baseline_check: {
              id: 'baseline_check',
              situation: "Caracteristicas basales: Edad 62.3 vs 62.4, IMC 27.8 vs 27.9, 52.0% vs 52.1% hombres. En 3,200 pacientes, estas son imposiblemente precisas. La aleatorizacion real produce mas variacion. Prueba GRIM: 1,600 √ó 62.3 = 99,680 ‚Äî imposible producir edad 62.3 exactamente.",
              question: "¬øQue concluyes?",
              branches: [
                { id: 'fabrication_flag', text: "Marcar como probable fabricacion ‚Äî documentar y proceder con analisis de sensibilidad", nextNode: 'documented_concern' },
                { id: 'contact_author', text: "Contactar al autor para aclaracion primero", nextNode: 'author_contact' }
              ]
            },
            variance_check: {
              id: 'variance_check',
              situation: "Notas: LDL media 142, DE 14.2. PA sistolica media 138, DE 13.8. HbA1c media 7.2, DE 0.72. Cada DE es exactamente 10% de la media. Esto es estadisticamente inverosimil ‚Äî diferentes variables tienen diferentes distribuciones naturales.",
              isEnding: true,
              outcome: 'good',
              lesson: "EL GANCHO: La prueba SPRITE detecta combinaciones imposibles de medias, DE y tamanos de muestra. Los datos biologicos reales son desordenados. Cuando los patrones son demasiado limpios, la sospecha esta justificada. Documenta esto y conduce analisis de sensibilidad."
            },
            registry_check: {
              id: 'registry_check',
              situation: "ClinicalTrials.gov muestra: el desenlace primario original era 'eventos CV compuestos' (no IM solo), N planeado era 2,400 (no 3,200), y el seguimiento estaba planeado como 1 ano (no 2). Tres desviaciones mayores sin explicacion.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PREGUNTA: ¬øPor que crecio la muestra un 33%? ¬øPor que cambio el desenlace primario? ¬øPor que se extendio el seguimiento? Estas no son prueba de fraude, pero son senales de alerta que requieren explicacion. Compara registros con publicaciones ‚Äî siempre."
            },
            documented_concern: {
              id: 'documented_concern',
              situation: "Incluyes el estudio en el analisis primario, conduces analisis de sensibilidad sin el, y notas: 'Un ensayo (Smith 2008) mostro patrones inusuales de balance basal y varianza que ameritan escrutinio. Las conclusiones son robustas a su exclusion.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: Has hecho tu debida diligencia. No has acusado a nadie de fraude (lo cual requiere investigacion institucional), pero has sido transparente sobre preocupaciones. Los lectores pueden sacar sus propias conclusiones."
            },
            author_contact: {
              id: 'author_contact',
              situation: "Envias email al autor correspondiente preguntando sobre el balance basal. Sin respuesta despues de 3 semanas. Intentas de nuevo. Todavia nada. La institucion del autor no tiene informacion de contacto. El sitio web del laboratorio no se ha actualizado en 4 anos.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REPETICION: Documenta tus intentos. 'Autor contactado dos veces sin respuesta' es informacion importante. Con DECREASE, Poldermans no respondio a consultas por anos. No responder no es prueba de fraude, pero limita la verificacion."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "¬øQue pasa si los datos en tu meta-analisis fueron fabricados?",
          context: "Por mas de una decada, los ensayos DECREASE moldearon la medicina perioperatoria mundialmente. Liderados por Don Poldermans en el Centro Medico Erasmus, estos ensayos mostraron que los betabloqueantes reducian la muerte cardiaca perioperatoria en un asombroso 90%. Las guias alrededor del mundo recomendaban betabloqueantes antes de cirugia no cardiaca. Luego comenzo la investigacion.",
          stats: [
            { value: "90%", label: "Reduccion de Mortalidad Afirmada", type: "" },
            { value: "11", label: "Articulos Retractados", type: "danger" },
            { value: "2011", label: "Poldermans Despedido", type: "" },
            { value: "10,000+", label: "Muertes en Exceso Estimadas", type: "danger" }
          ],
          source: "Investigacion Erasmus MC 2011 | Ensayo POISE - Lancet 2008",
          decisionScenario: "Estas actualizando guias perioperatorias. Los ensayos DECREASE dominan la base de evidencia. Un colega nota que los tamanos de efecto parecen 'demasiado buenos para ser verdad' ‚Äî reducciones de mortalidad del 90% son casi inauditas en cardiologia.",
          pathA: {
            title: "Incluir ensayos DECREASE ‚Äî estan publicados y revisados por pares",
            steps: [
              "Tu meta-analisis muestra beneficio fuerte (OR 0.10)",
              "Las guias recomiendan betabloqueantes para todos los pacientes quirurgicos",
              "Los hospitales adoptan protocolos obligatorios de betabloqueantes",
              "Ensayo POISE (datos reales, n=8,351): los betabloqueantes AUMENTAN mortalidad (HR 1.33)",
              "La investigacion revela que los datos de DECREASE fueron fabricados",
              "Estimadas 10,000+ muertes en exceso por guias basadas en fraude"
            ]
          },
          pathB: {
            title: "Marcar tamanos de efecto imposibles ‚Äî investigar integridad de datos",
            steps: [
              "Notas que 90% de reduccion de mortalidad es biologicamente inverosimil",
              "Solicitas datos crudos a los investigadores (sin respuesta)",
              "Conduces analisis de sensibilidad excluyendo DECREASE",
              "Sin DECREASE: no hay beneficio claro, posible senal de dano",
              "Tus conclusiones cautelosas previenen adopcion generalizada",
              "Cuando POISE publica, tu escepticismo es validado"
            ]
          },
          revelation: "El meta-analisis asume integridad de datos. Cuando esa suposicion falla, todo el edificio colapsa. El fraude DECREASE nos enseno: los tamanos de efecto imposibles son una senal de advertencia. Una reduccion de mortalidad del 90% de un simple betabloqueante debio haber disparado escepticismo, no celebracion. Tu trabajo no es solo combinar numeros ‚Äî es cuestionar si esos numeros merecen existir.",
          moduleConnection: "Por esto la extraccion de datos requiere vigilancia. No eres una calculadora ‚Äî eres un guardian. Cada numero que extraes carga el peso de vidas de pacientes. Verifica, comprueba, y cuando algo parece demasiado bueno para ser verdad, probablemente lo es."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Un ensayo reporta IMC medio de 27.3 kg/m¬≤ (DE 2.1) en un grupo de N=30 pacientes. Usando la prueba GRIM (verificando si 30 √ó 27.3 = 819 es plausible para suma de IMC), ¬øque puedes concluir?",
          options: [
            { id: 'a', text: "La media es imposible ‚Äî fabricacion definitiva", correct: false },
            { id: 'b', text: "La media es posible ‚Äî datos verificados", correct: false },
            { id: 'c', text: "Las pruebas GRIM aplican a conteos/datos discretos, no a medidas continuas como IMC", correct: true },
            { id: 'd', text: "Se necesita mas informacion para aplicar GRIM", correct: false }
          ],
          explanation: "GRIM (Inconsistencia de Medias Relacionada con Granularidad) aplica a datos discretos/de conteo donde los valores deben ser enteros. El IMC es continuo, asi que cualquier media es matematicamente posible. GRIM aplicaria a 'numero de cigarrillos por dia' pero no a peso o altura."
        }
      }
    ]
  },
  // Module 6: The Assess (Risk of Bias)
  {
    id: 6,
    title: "La Evaluacion",
    subtitle: "Riesgo de Sesgo",
    principle: 4,
    story: "ORBITA",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "El sesgo se esconde a plena vista"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA REVELACION: ORBITA ‚Äî EL STENT PLACEBO",
          source: "Lancet 2018; 391:31-40 | Al-Lamee et al | PubMed: 29103656",
          timeline: [
            { year: "1990s-2010s", text: "Cientos de ensayos muestran que la ICP mejora sintomas de angina. Millones de procedimientos realizados anualmente. Los pacientes reportan mejoria dramatica.", type: "normal" },
            { year: "2007", text: "Ensayo COURAGE: la ICP no reduce IM o muerte vs terapia medica. Pero los sintomas mejoraron ‚Äî asi que la ICP continua para alivio de sintomas.", type: "normal" },
            { year: "2015", text: "ORBITA comienza: 200 pacientes con enfermedad de un vaso. La mitad recibe ICP, la mitad simulacion (cateter insertado, sin stent). Ambos grupos cegados.", type: "normal" },
            { year: "2018", text: "Resultados: Tiempo de ejercicio mejoro 28.4s con ICP vs 11.8s con simulacion. Diferencia: 16.6s (IC 95%: -8.9 a 42.0). NO significativo.", type: "crisis" },
            { year: "La Verdad", text: "El 'beneficio' de la ICP para angina estable era efecto placebo. Los ensayos no cegados midieron creencia, no biologia. Cada ensayo previo era de alto riesgo de sesgo.", type: "revelation" }
          ],
          realData: {
            endpoint: "Incremento de tiempo de ejercicio a 6 semanas",
            drug: "ICP: +28.4 segundos",
            placebo: "Simulacion: +11.8 segundos",
            rr: "Dif: 16.6s",
            ci: "-8.9 a 42.0",
            nnh: "p = 0.20 (no significativo)"
          },
          hook: "Sin un control simulado, no estas midiendo el tratamiento. Estas midiendo el ritual ‚Äî el laboratorio de cateterismo, el procedimiento, la recuperacion, la creencia de que algo se hizo."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è PUNTO CLAVE: ORBITA probo que decadas de 'beneficio' de ICP para angina estable era efecto placebo. Millones de stents fueron colocados basados en ensayos no cegados midiendo desenlaces subjetivos. El riesgo de sesgo no es academico ‚Äî es la diferencia entre medir medicina y medir creencia."
        }
      },
      {
        type: 'content',
        content: {
          title: "Los Cinco Dominios del Sesgo (RoB 2)",
          sections: [
            {
              heading: "Dominio 1: Proceso de Aleatorizacion",
              items: [
                "¬øLa secuencia de asignacion fue aleatoria?",
                "¬øLa asignacion estuvo oculta hasta el enrolamiento?",
                "¬øLas diferencias basales fueron debidas al azar?"
              ]
            },
            {
              heading: "Dominio 2: Desviaciones de las Intervenciones Previstas",
              items: [
                "¬øLos participantes/personal estaban cegados?",
                "¬øHubo desviaciones del protocolo?",
                "¬øLas desviaciones probablemente afectaron los desenlaces?"
              ]
            },
            {
              heading: "Dominio 3: Datos de Desenlace Faltantes",
              items: [
                "¬øLos datos de desenlace estaban completos?",
                "¬øLa falta de datos podria estar relacionada con los desenlaces?",
                "¬øSe usaron analisis apropiados?"
              ]
            },
            {
              heading: "Dominios 4-5: Medicion y Seleccion",
              items: [
                "¬øLa medicion del desenlace podria estar influenciada por conocimiento de la intervencion?",
                "¬øLa seleccion del desenlace estuvo influenciada por los resultados?"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: EVALUACION ROB 2",
          title: "Evaluacion Sistematica del Sesgo",
          sections: [
            {
              heading: "Preguntas de Senalizacion",
              text: "Cada dominio tiene 3-5 preguntas de senalizacion respondidas Si/Probablemente Si/Probablemente No/No/Sin Informacion. Estas alimentan los juicios a nivel de dominio."
            },
            {
              heading: "Juicios por Dominio",
              text: "Bajo riesgo: el ensayo probablemente no esta sesgado para este dominio\nAlgunas preocupaciones: plantea dudas sobre la confiabilidad\nAlto riesgo: el dominio probablemente sesga seriamente los resultados"
            },
            {
              heading: "Juicio General",
              text: "Bajo riesgo: bajo riesgo en todos los dominios\nAlgunas preocupaciones: algunas preocupaciones en al menos un dominio\nAlto riesgo: alto riesgo en al menos un dominio, O algunas preocupaciones en multiples dominios"
            },
            {
              heading: "Implicaciones para la Sintesis",
              text: "Estudios de alto riesgo pueden excluirse (estricto) o mantenerse con analisis de sensibilidad (inclusivo). De cualquier forma, el riesgo de sesgo debe informar tu evaluacion de certeza (GRADE)."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'rob2-tool',
          title: "Interfaz de Evaluacion RoB 2",
          description: "Evalua el riesgo de sesgo usando la herramienta RoB 2 de Cochrane"
        }
      },
      {
        type: 'content',
        content: {
          title: "EL PATRON: Cuando la Cirugia Simulada Expone Efectos Placebo",
          sections: [
            {
              heading: "FIDELITY (2013) ‚Äî Cirugia de Menisco de Rodilla",
              items: [
                "146 pacientes con desgarros de menisco ‚Üí reseccion artroscopica vs simulacion",
                "Diferencia en puntaje Lysholm: -1.6 puntos (IC 95%: -7.2 a 4.0)",
                "Uno de los procedimientos ortopedicos mas comunes demostrado no ser mejor que placebo",
                "Fuente: NEJM 2013; PubMed 24369076"
              ]
            },
            {
              heading: "Ensayos Simulados de Vertebroplastia (2009) ‚Äî Tratamiento de Fractura Espinal",
              items: [
                "Dos ensayos: inyeccion de cemento en vertebras fracturadas vs simulacion (solo insercion de aguja)",
                "Diferencia en reduccion del dolor: 0.6 puntos en escala 0-10 (IC 95%: -0.7 a 1.8)",
                "Procedimiento que cuesta $5,000+ funciono igual que insertar una aguja",
                "Fuente: NEJM 2009; PubMed 19657121"
              ]
            },
            {
              heading: "CSAW (2018) ‚Äî Cirugia de Descompresion de Hombro",
              items: [
                "313 pacientes con dolor subacromial ‚Üí cirugia vs artroscopia vs sin tratamiento",
                "Diferencia en Puntaje de Hombro Oxford: -1.3 puntos (IC 95%: -3.9 a 1.3)",
                "300,000 cirugias asi realizadas anualmente en Reino Unido/EE.UU. ‚Äî la mayoria innecesarias",
                "Fuente: Lancet 2018; PMC 5803129"
              ]
            },
            {
              heading: "LA ADVERTENCIA: El Patron se Repite",
              items: [
                "Los ensayos quirurgicos no cegados sobreestiman el beneficio en 30-50%",
                "Los pacientes QUIEREN creer que los procedimientos costosos e invasivos funcionan",
                "Los cirujanos CREEN en su oficio ‚Äî imposible cegarlos",
                "Sin controles simulados, medimos creencia, no biologia"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'rob_decision_tree',
          title: "El Ensayo de Presion Arterial No Cegado",
          scenario: "Estas evaluando un ensayo del nuevo farmaco antihipertensivo X. Ano 1: doble ciego. Anos 2-4: extension de etiqueta abierta. Desenlace primario: eventos CV (adjudicacion cegada). Secundario: calidad de vida, sintomas (recolectado por personal no cegado).",
          realCase: "SYMPLICITY HTN-3 probo la denervacion renal para hipertension resistente. Los ensayos no cegados anteriores mostraron caidas dramaticas de 30 mmHg. ¬øEl ensayo controlado con simulacion? Solo 2.4 mmHg de diferencia. La medicion no cegada habia inflado vastamente el beneficio aparente.",
          nodes: {
            start: {
              id: 'start',
              situation: "El ensayo reporta: El Farmaco X redujo eventos CV en 18% (HR 0.82, p=0.04) y mejoro puntajes de calidad de vida en 12 puntos (p<0.001). Estas haciendo evaluacion RoB 2. Necesitas calificar cada desenlace separadamente.",
              question: "¬øCual desenlace evaluas primero?",
              branches: [
                { id: 'primary_first', text: "Desenlace primario (eventos CV)", nextNode: 'cv_assessment' },
                { id: 'secondary_first', text: "Desenlace secundario (calidad de vida)", nextNode: 'qol_assessment' },
                { id: 'combined_assessment', text: "Calificar el ensayo en general, no por desenlace", nextNode: 'combined_mistake' }
              ]
            },
            combined_mistake: {
              id: 'combined_mistake',
              situation: "Escribes: 'Riesgo de sesgo general: Algunas preocupaciones debido a extension de etiqueta abierta.' Un revisor devuelve tu evaluacion: 'RoB 2 requiere evaluacion especifica por desenlace. Eventos CV con adjudicacion cegada es diferente de CdV con recoleccion no cegada.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "EL GANCHO: El riesgo de sesgo no es una propiedad del ensayo ‚Äî es una propiedad de cada desenlace dentro del ensayo. ORBITA nos enseno: el cegamiento afecta desenlaces subjetivos profundamente pero desenlaces objetivos minimamente. Un juicio no puede capturar esto."
            },
            cv_assessment: {
              id: 'cv_assessment',
              situation: "Para eventos CV: Los eventos fueron adjudicados por un comite cegado a la asignacion de tratamiento. Revisaron registros medicos, ECGs e imagenes sin saber en que brazo estaba el paciente. La extension de etiqueta abierta no afecto su juicio.",
              question: "¬øRiesgo de sesgo para medicion de desenlace CV?",
              branches: [
                { id: 'cv_low', text: "Bajo riesgo ‚Äî la adjudicacion cegada protege el desenlace", nextNode: 'cv_correct' },
                { id: 'cv_some', text: "Algunas preocupaciones ‚Äî pacientes no cegados, podrian reportar sintomas diferente", nextNode: 'cv_overthinking' },
                { id: 'cv_high', text: "Alto riesgo ‚Äî el ensayo fue de etiqueta abierta por 3 anos", nextNode: 'cv_wrong' }
              ]
            },
            cv_correct: {
              id: 'cv_correct',
              situation: "¬°Correcto! Para desenlaces objetivos con evaluacion cegada, la falta de cegamiento de participantes importa menos. Muerte es muerte. IM confirmado por troponinas y ECG es IM. El cegamiento de los adjudicadores es lo que importa.",
              question: "Ahora evalua el desenlace de calidad de vida:",
              branches: [
                { id: 'qol_from_cv', text: "Continuar a evaluacion de CdV", nextNode: 'qol_assessment' }
              ]
            },
            cv_overthinking: {
              id: 'cv_overthinking',
              situation: "Te preocupa que pacientes no cegados podrian reportar dolor de pecho diferente, llevando a mas investigaciones. Esta es una preocupacion teorica, pero el comite de adjudicacion juzgo basado en criterios objetivos (troponinas, ECG), no solo reportes del paciente.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REVELACION GRADUAL: 'Algunas preocupaciones' no esta mal, pero puede ser demasiado cauteloso. La pregunta clave: ¬øpodria el conocimiento de la asignacion afectar la medicion del desenlace? Para eventos CV con adjudicacion cegada usando criterios objetivos, la respuesta probablemente es no."
            },
            cv_wrong: {
              id: 'cv_wrong',
              situation: "Calificaste alto riesgo, pero la adjudicacion era cegada. El estado de etiqueta abierta afecta desenlaces diferentemente. ORBITA mostro: tiempo de ejercicio (objetivo pero dependiente de esfuerzo) fue afectado por placebo; mortalidad no lo seria. El contexto importa.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA PREGUNTA: Preguntate: ¬øComo podria el no-cegamiento afectar ESTE desenlace? Eventos CV confirmados por adjudicadores cegados usando criterios objetivos no pueden ser influenciados por conocimiento del tratamiento del paciente o investigador."
            },
            qol_assessment: {
              id: 'qol_assessment',
              situation: "Para calidad de vida: Una enfermera de investigacion (que sabia la asignacion del paciente) administro el cuestionario. Los pacientes sabian si estaban en Farmaco X o placebo. La enfermera registro respuestas y podia sondear o clarificar respuestas.",
              question: "¬øRiesgo de sesgo para medicion de desenlace CdV?",
              branches: [
                { id: 'qol_low', text: "Bajo riesgo ‚Äî es reportado por paciente, enfermera solo registro", nextNode: 'qol_wrong_low' },
                { id: 'qol_some', text: "Algunas preocupaciones ‚Äî influencia sutil posible", nextNode: 'qol_insufficient' },
                { id: 'qol_high', text: "Alto riesgo ‚Äî desenlace subjetivo, recoleccion no cegada", nextNode: 'qol_correct' }
              ]
            },
            qol_wrong_low: {
              id: 'qol_wrong_low',
              situation: "Considera: la enfermera sabe que el paciente esta en el 'nuevo farmaco prometedor.' Pregunta sobre sintomas. El paciente dice 'quizas un poco mejor.' No cegada, la enfermera podria sondear: '¬øEntonces su energia mejoro?' Cegada, registraria neutralmente.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: Los ensayos no cegados de SYMPLICITY mostraron caidas de PA de 30 mmHg. El ensayo controlado con simulacion mostro 2.4 mmHg. La diferencia no era el procedimiento ‚Äî era el contexto de medicion. Los desenlaces subjetivos requieren cegamiento."
            },
            qol_insufficient: {
              id: 'qol_insufficient',
              situation: "'Algunas preocupaciones' subestima el riesgo. La combinacion de: (1) desenlace subjetivo, (2) paciente no cegado, (3) evaluador no cegado crea claro potencial de sesgo. Este es alto riesgo de libro de texto para Dominio 4 (medicion del desenlace).",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REPETICION: Cada situacion tipo ORBITA ensena la misma leccion. Desenlaces subjetivos + no-cegamiento = alto riesgo de sesgo. 'Algunas preocupaciones' es para situaciones ambiguas. Esta es clara."
            },
            qol_correct: {
              id: 'qol_correct',
              situation: "Calificas alto riesgo para CdV. Tu evaluacion ahora muestra: eventos CV (bajo riesgo), CdV (alto riesgo). El resumen del ensayo afirma 'El Farmaco X mejoro calidad de vida' ‚Äî pero has identificado que esta afirmacion descansa en evidencia de alto riesgo.",
              question: "¬øComo incorporas esto en tu meta-analisis?",
              branches: [
                { id: 'exclude_qol', text: "Excluir el desenlace CdV de la sintesis", nextNode: 'exclusion_option' },
                { id: 'include_downgrade', text: "Incluir pero degradar certeza en GRADE", nextNode: 'best_approach' },
                { id: 'report_both', text: "Reportar solo eventos CV, ignorar CdV", nextNode: 'selective_reporting' }
              ]
            },
            exclusion_option: {
              id: 'exclusion_option',
              situation: "Si excluyes todos los datos de CdV de alto riesgo, puedes no tener nada para sintetizar. La mayoria de estudios de CdV tienen limitaciones similares. La exclusion puede no ser practica.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA ADVERTENCIA: Excluir estudios de alto riesgo es una opcion, pero requiere pre-especificacion. Un mejor enfoque: incluir, pero reportar transparentemente la preocupacion de sesgo y degradar certeza apropiadamente."
            },
            best_approach: {
              id: 'best_approach',
              situation: "Incluyes el estudio, notas alto RoB para CdV, y cuando llegas a la evaluacion GRADE, degradas certeza por riesgo de sesgo. Tu tabla de Resumen de Hallazgos muestra: eventos CV (certeza moderada), CdV (certeza muy baja).",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: La evaluacion RoB fluye hacia GRADE. Alto riesgo de sesgo ‚Üí degradar certeza. Asi funciona el sistema: identificar sesgo, cuantificar incertidumbre, comunicar honestamente. Los lectores ven cuales conclusiones son confiables."
            },
            selective_reporting: {
              id: 'selective_reporting',
              situation: "Al solo reportar eventos CV, has ocultado que el ensayo afirmaba beneficios de CdV en evidencia de alto riesgo. Un lector revisando el ensayo original se preguntara por que omitiste un hallazgo significativo.",
              isEnding: true,
              outcome: 'bad',
              lesson: "EL GANCHO REGRESA: El reporte selectivo de desenlaces es una forma de sesgo. Reporta todos los desenlaces pre-especificados, aunque algunos tengan alto RoB. La solucion es evaluacion transparente, no omision."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "¬øQue pasa cuando ensayos sesgados impulsan tu estimacion combinada?",
          context: "La aprotinina era un farmaco coagulante usado en cirugia cardiaca para reducir sangrado. Por anos, los meta-analisis mostraron que reducia mortalidad. Sesenta y cuatro ensayos apoyaban su uso. Pero la mayoria eran pequenos, no cegados y financiados por industria. La evidencia parecia abrumadora hasta que alguien pregunto: ¬øque pasa si realmente evaluamos el sesgo?",
          stats: [
            { value: "64", label: "Ensayos Mostrando Beneficio", type: "" },
            { value: "Mayoria", label: "Alto Riesgo de Sesgo", type: "danger" },
            { value: "1.53x", label: "Verdadero Riesgo de Mortalidad", type: "danger" },
            { value: "2008", label: "Farmaco Retirado", type: "" }
          ],
          source: "Fergusson et al. NEJM 2008 | Ensayo BART - NEJM 2008; 358:2319-31",
          decisionScenario: "Estas escribiendo un meta-analisis sobre aprotinina para cirugia cardiaca. Tu busqueda encuentra 64 ensayos. La mayoria muestra beneficio de mortalidad. Debes decidir como manejar el riesgo de sesgo.",
          pathA: {
            title: "Incluir todos los ensayos ‚Äî mas datos es mejor",
            steps: [
              "Combinar 64 ensayos sin importar riesgo de sesgo",
              "El meta-analisis muestra claro beneficio de mortalidad",
              "El farmaco continua en uso extendido en cirugia cardiaca",
              "El ensayo BART (apropiadamente aleatorizado, n=2,331) finalmente se ejecuta",
              "BART muestra que aprotinina AUMENTA muerte (RR 1.53)",
              "Ensayo detenido temprano por dano, farmaco retirado mundialmente"
            ]
          },
          pathB: {
            title: "Excluir ensayos de alto riesgo de sesgo ‚Äî calidad sobre cantidad",
            steps: [
              "Evaluar sesgo: mayoria de ensayos pequenos, no cegados, financiados por industria",
              "Excluir ensayos de alto riesgo, combinar solo evidencia de bajo riesgo",
              "El beneficio desaparece cuando se restringe a ensayos de calidad",
              "Recomiendas esperar por ensayo grande independiente",
              "BART confirma tu cautela ‚Äî el farmaco era danino todo el tiempo",
              "Tu analisis riguroso previno dano"
            ]
          },
          revelation: "Basura entra, basura sale. Un meta-analisis no puede arreglar las fallas en sus ensayos componentes. Los 64 ensayos de aprotinina parecian evidencia abrumadora ‚Äî pero eran 64 piezas de evidencia sesgada. Cuando Fergusson evaluo el riesgo de sesgo rigurosamente, el beneficio desaparecio. El ensayo BART probo que el farmaco estaba matando pacientes. La evaluacion del riesgo de sesgo no es quisquillosidad academica ‚Äî es la diferencia entre combinar evidencia y combinar sesgo.",
          moduleConnection: "Por esto importa la evaluacion RoB. Debes evaluar cada ensayo antes de combinar. Un forest plot de 64 ensayos sesgados no es evidencia ‚Äî es ruido organizado. Tu trabajo es separar senal de ruido, y la evaluacion de sesgo es tu herramienta principal."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Un ensayo quirurgico compara cirugia abierta con cirugia laparoscopica. Pacientes y cirujanos no pueden ser cegados. El desenlace primario es mortalidad a 30 dias (de registros de defuncion). ¬øCual es el riesgo de sesgo para medicion de desenlace?",
          options: [
            { id: 'a', text: "Alto riesgo ‚Äî sin cegamiento significa alto sesgo", correct: false },
            { id: 'b', text: "Bajo riesgo ‚Äî mortalidad es objetiva y de registros independientes", correct: true },
            { id: 'c', text: "Algunas preocupaciones ‚Äî la falta de cegamiento siempre genera preocupaciones", correct: false },
            { id: 'd', text: "No se puede evaluar sin conocer metodo de aleatorizacion", correct: false }
          ],
          explanation: "El riesgo de sesgo para medicion de desenlace depende de si el conocimiento de la intervencion podria influenciar la medicion. Muerte de registros administrativos es objetiva y no puede ser influenciada por estado de cegamiento. Desenlaces subjetivos (dolor, funcion) serian de alto riesgo en ensayos no cegados."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ VERIFICACION DE PROGRESO: Has completado la fase de EVALUACION.\n\n‚úì Modulo 4: SELECCIONANDO estudios ‚Äî aprendido de los meta-analisis contradictorios de Vitamina E\n‚úì Modulo 5: EXTRAYENDO datos ‚Äî aprendido de los numeros fabricados de DECREASE\n‚úì Modulo 6: EVALUANDO sesgo ‚Äî aprendido de la revelacion de cirugia simulada de ORBITA\n\nAhora puedes ENCONTRAR estudios, SELECCIONARLOS rigurosamente, EXTRAER datos cuidadosamente, y EVALUAR su confiabilidad.\n\nSiguiente: Aprenderas a SINTETIZAR estudios en estimaciones combinadas e INTERPRETAR que significan esos numeros.\n\nLa parte mas dificil comienza ahora ‚Äî las estadisticas que pueden enganar hasta a expertos."
        }
      }
    ]
  },
  // Modulo 7: El Efecto
  {
    id: 7,
    title: "El Efecto",
    subtitle: "Calculo del Tamano de Efecto",
    principle: 5,
    story: "SSRI",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "El promedio puede mentir"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA CONTROVERSIA: ISRS ‚Äî CUANDO LOS NUMEROS ENGANAN",
          source: "PLoS Medicine 2008; Kirsch et al | JAMA 2010; Fournier et al | PubMed: 18303940",
          timeline: [
            { year: "1987-2007", text: "Los ISRS se convierten en los medicamentos psiquiatricos mas recetados mundialmente. Solo Prozac gana $2.6 mil millones anuales. El tratamiento de la depresion se transforma.", type: "normal" },
            { year: "Feb 2008", text: "Kirsch publica analisis de FDA: los ISRS muestran DME = 0.32. Por debajo del umbral NICE de 0.50 para 'significancia clinica.' Los medios estallan: '¬°Antidepresivos no mejores que placebo!'", type: "crisis" },
            { year: "La Metrica", text: "La DME divide la diferencia cruda por la desviacion estandar. Alta variabilidad ‚Üí pequena DME. HDRS tiene alta variabilidad. La misma mejoria de 3 puntos parece 'trivial' como DME.", type: "normal" },
            { year: "Ene 2010", text: "Fournier re-analiza: Diferencia media = 2.7 puntos HDRS. Para depresion severa (HDRS ‚â•25): DM = 4.4 puntos. Clinicamente significativo por cualquier estandar.", type: "revelation" },
            { year: "La Verdad", text: "Mismos ensayos. Mismos pacientes. DME dijo 'no clinicamente significativo.' Diferencia media dijo 'ayuda a severamente deprimidos.' La metrica eligio la narrativa.", type: "revelation" }
          ],
          realData: {
            endpoint: "Hamilton Depression Rating Scale (HDRS) change",
            drug: "SSRIs pooled",
            placebo: "Placebo pooled",
            rr: "SMD = 0.32 OR Mean Diff = 2.7 points",
            ci: "SMD: 0.24-0.40 | MD: 1.8-3.6",
            nnh: "Different metrics, same data, different stories"
          },
          hook: "LA PREGUNTA: Si un paciente deprimido mejora 3 puntos en una escala de 52 puntos, es eso 'trivial' (DME=0.32) o 'significativo' (volver a la vida normal)? La metrica no puede responder. Solo el paciente puede."
        }
      },
      {
        type: 'content',
        content: {
          title: "Choosing the Right Effect Size",
          sections: [
            {
              heading: "Para resultados binarios:",
              items: [
                "Risk Ratio (RR): intuitive, but can't pool if baseline risk varies greatly",
                "Odds Ratio (OR): mathematical properties allow pooling, but less intuitive",
                "Risk Difference (RD): absolute effect, varies with baseline risk",
                "Hazard Ratio (HR): for time-to-event outcomes"
              ]
            },
            {
              heading: "Para resultados continuos:",
              items: [
                "Mean Difference (MD): same scale ‚Üí easy interpretation",
                "Diferencia de Medias Estandarizada (DME/d de Cohen): diferentes escalas ‚Üí comparables",
                "Razon de Respuesta: razon de medias, cambio porcentual"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: SELECCION DE TAMANO DE EFECTO",
          title: "Emparejando Tamano de Efecto con la Pregunta",
          sections: [
            {
              heading: "Cuando Usar Diferencia de Medias",
              text: "Todos los estudios usan la misma medida de desenlace (ej., todos usan HDRS para depresion). La interpretacion es directa: 'El tratamiento redujo la depresion en 3 puntos.'"
            },
            {
              heading: "Cuando Usar DME",
              text: "Los estudios usan diferentes escalas midiendo el mismo constructo (ej., HDRS vs BDI para depresion). La interpretacion requiere anclaje: DME de 0.5 = 'efecto mediano' en convenciones de Cohen, pero el significado clinico depende del contexto."
            },
            {
              heading: "Cuando Usar Razon de Riesgo",
              text: "Mas comun para desenlaces binarios. Intuitivo: 'El tratamiento reduce el riesgo en 25%' (RR=0.75). Problematico cuando el riesgo basal varia ampliamente entre estudios."
            },
            {
              heading: "Convirtiendo Entre Metricas",
              text: "OR ‚âà RR cuando los desenlaces son raros (<10%). DME ‚âà DM/DE combinada. Los hazard ratios requieren datos individuales de pacientes para conversion precisa."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'effect-calculator',
          title: "Calculadora de Tamano de Efecto",
          description: "Calcula tamanos de efecto desde varios formatos de entrada"
        }
      },
      {
        type: 'content',
        content: {
          title: "EL CEMENTERIO DE BIOMARCADORES: Cuando Grandes Efectos No Importan",
          sections: [
            {
              heading: "Reduccion de Homocisteina ‚Äî NORVIT (2006)",
              items: [
                "El biomarcador: Alta homocisteina ‚Üí 3x riesgo cardiovascular (estudios observacionales)",
                "La intervencion: Vitaminas B reducen dramaticamente la homocisteina (reduccion 30-40%)",
                "El ensayo: 3,749 pacientes post-IM. La homocisteina cayo hermosamente.",
                "El resultado: Compuesto primario RR 1.08 (0.93-1.25). TENDENCIA HACIA DANO.",
                "Fuente: NEJM 2006 NORVIT"
              ]
            },
            {
              heading: "Niacina + Estatina ‚Äî AIM-HIGH (2011) y HPS2-THRIVE (2014)",
              items: [
                "El biomarcador: Niacina aumenta HDL en 25%, reduce trigliceridos en 30%",
                "La esperanza: Agregar niacina a estatinas salvaria mas vidas",
                "AIM-HIGH: HR 1.02 (0.87-1.21) para eventos CV ‚Äî SIN beneficio",
                "HPS2-THRIVE: RR 0.96 (0.90-1.03) para eventos vasculares ‚Äî pero MAS eventos adversos",
                "25,000+ pacientes, miles de millones en costos de farmacos, biomarcadores mejorados, CERO beneficio"
              ]
            },
            {
              heading: "EL PATRON: Tamano de Efecto ‚â† Beneficio Clinico",
              items: [
                "Homocisteina: Gran reduccion (30%) ‚Üí sin beneficio clinico",
                "Colesterol HDL: Gran aumento (25%) ‚Üí sin beneficio clinico",
                "HbA1c: Gran reduccion (ACCORD) ‚Üí mortalidad AUMENTADA",
                "LA LECCION: Un gran efecto en un sustituto no es un beneficio para el paciente"
              ]
            },
            {
              heading: "LA ADVERTENCIA: ¬øQue Metrica Importa?",
              items: [
                "Las farmaceuticas reportan tamanos de efecto de biomarcadores (numeros impresionantes)",
                "Los pacientes se preocupan por mortalidad, hospitalizaciones, calidad de vida",
                "Los meta-analisis deben distinguir: ¬øEstamos combinando sustitutos o desenlaces importantes para pacientes?",
                "Un meta-analisis de reduccion de homocisteina mostraria 'evidencia fuerte' ‚Äî de lo equivocado"
              ]
            }
          ]
        }
      },
      {
        type: 'scenario',
        content: {
          id: 'effect_scenario',
          title: "Las Metricas en Competencia",
          situation: "Estas meta-analizando ensayos de ejercicio para depresion. La mayoria de ensayos reportan puntajes HDRS medios, pero tres ensayos reportan 'tasa de respuesta' (‚â•50% mejoria). Podrias: (1) convertir tasas de respuesta a medias usando aproximaciones, (2) reportar analisis separados, o (3) excluir los tres ensayos.",
          question: "¬øCual es el mejor enfoque?",
          choices: [
            {
              id: 'a',
              text: "Convertir tasas de respuesta a medias aproximadas para incluir todos los ensayos",
              consequence: 'bad',
              result: "Las conversiones introducen error sustancial y asumen distribuciones normales. La aproximacion (DME ‚âà logOR/1.81) tiene amplia incertidumbre. Estas agregando precision que no tienes."
            },
            {
              id: 'b',
              text: "Reportar analisis separados: uno para continuo, uno para binario",
              consequence: 'good',
              result: "¬°Correcto! Esto mantiene la integridad de cada estimacion mientras presenta toda la evidencia disponible. Los lectores ven ambos analisis y pueden evaluar consistencia."
            },
            {
              id: 'c',
              text: "Excluir los tres ensayos para mantener consistencia",
              consequence: 'neutral',
              result: "Aceptable si esta pre-especificado, pero desperdicia datos relevantes. Los tres ensayos pueden contener informacion importante sobre diferentes poblaciones o intensidades de intervencion."
            }
          ],
          correct: 'b',
          principle: 5
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Un ensayo reporta puntajes de dolor medios de 4.2 (DE 2.0) en tratamiento y 5.8 (DE 2.4) en control (menor = mejor, N=50 cada uno). ¬øCual es la DME aproximada (d de Cohen)?",
          options: [
            { id: 'a', text: "-0.73 (favoreciendo tratamiento)", correct: true },
            { id: 'b', text: "-1.60 (favoreciendo tratamiento)", correct: false },
            { id: 'c', text: "+0.73 (favoreciendo control)", correct: false },
            { id: 'd', text: "No se puede calcular sin datos individuales de pacientes", correct: false }
          ],
          explanation: "DME = (Media1 - Media2) / DE combinada. DE combinada ‚âà ‚àö[(2.0¬≤ + 2.4¬≤)/2] ‚âà 2.21. DME = (4.2 - 5.8) / 2.21 = -1.6 / 2.21 ‚âà -0.73. El signo negativo indica que tratamiento tiene puntajes de dolor menores (mejores)."
        }
      }
    ]
  },
  // Modulo 8: La Sintesis
  {
    id: 8,
    title: "La Sintesis",
    subtitle: "Modelos de Meta-Analisis",
    principle: 5,
    story: "ISIS-4",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "El promedio puede mentir"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA LECCION: ISIS-4 ‚Äî CUANDO LOS ESTUDIOS PEQUENOS MIENTEN",
          source: "Lancet 1995; 345:669-685 | ISIS-4 Collaborative | PubMed: 7661937",
          timeline: [
            { year: "1984-91", text: "Siete ensayos pequenos (n=1,301 total) muestran que el magnesio reduce la mortalidad por IM en 55%! OR 0.45 (0.26-0.77). Existe fuerte razonamiento biologico.", type: "normal" },
            { year: "1992", text: "LIMIT-2 (2,316 pacientes) confirma beneficio: OR 0.74 (0.56-0.99). El entusiasmo crece. El meta-analisis muestra beneficio claro.", type: "normal" },
            { year: "1992-94", text: "ISIS-4 enrola 58,050 pacientes ‚Äî el ensayo de IM mas grande jamas realizado. Magnesio vs control.", type: "normal" },
            { year: "1995", text: "Resultados ISIS-4: 7.64% vs 7.24% mortalidad. OR 1.06 (0.99-1.14). SIN beneficio. Los ensayos pequenos estaban EQUIVOCADOS.", type: "crisis" },
            { year: "La Verdad", text: "Los ensayos pequenos sobreestiman efectos. El sesgo de publicacion oculto ensayos pequenos negativos. El meta-analisis 'definitivo' era un artefacto del reporte selectivo.", type: "revelation" }
          ],
          realData: {
            endpoint: "Mortalidad a 5 semanas en IM agudo",
            drug: "2,216/29,011 (7.64%)",
            placebo: "2,103/29,039 (7.24%)",
            rr: "1.06",
            ci: "0.99-1.14",
            nnh: "Sin beneficio (tendencia hacia dano)"
          },
          hook: "Los ensayos pequenos mostraron 55% de reduccion de mortalidad. El mega-ensayo no mostro nada. Por esto necesitamos entender heterogeneidad, funnel plots e intervalos de prediccion ‚Äî no solo estimaciones combinadas."
        }
      },
      {
        type: 'content',
        content: {
          title: "Efectos Fijos vs Aleatorios",
          sections: [
            {
              heading: "Modelo de Efectos Fijos:",
              items: [
                "Asume UN tamano de efecto verdadero subyacente a todos los estudios",
                "Las diferencias entre estudios son solo error de muestreo",
                "Pondera por varianza inversa (estudios mas grandes cuentan mas)",
                "Intervalos de confianza mas estrechos",
                "Apropiado cuando los estudios son identicos en metodos/poblacion"
              ]
            },
            {
              heading: "Modelo de Efectos Aleatorios:",
              items: [
                "Asume DISTRIBUCION de efectos verdaderos entre estudios",
                "Los estudios estiman efectos diferentes (pero relacionados)",
                "Agrega varianza entre estudios (œÑ¬≤) a las ponderaciones",
                "Intervalos de confianza mas amplios (considera heterogeneidad)",
                "Da mas peso a estudios pequenos que efectos fijos"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: ELIGIENDO TU MODELO",
          title: "Cuando Combinar (y Cuando No)",
          sections: [
            {
              heading: "Usa Efectos Fijos Cuando:",
              text: "Los estudios son metodologicamente identicos (mismo protocolo, misma poblacion, mismo marco temporal). Quieres estimar el efecto en este contexto especifico. La heterogeneidad entre estudios es verdaderamente cero o trivial."
            },
            {
              heading: "Usa Efectos Aleatorios Cuando:",
              text: "Los estudios difieren en poblaciones, intervenciones o metodos. Quieres generalizar mas alla de los estudios incluidos. Se espera heterogeneidad (I¬≤ > 0%)."
            },
            {
              heading: "No Combines Cuando:",
              text: "La heterogeneidad es extrema (I¬≤ > 75% sin explicacion). Los estudios miden cosas fundamentalmente diferentes. Mezclar manzanas y naranjas produce ensalada de frutas, no insight."
            },
            {
              heading: "La Advertencia de Efectos Aleatorios:",
              text: "Efectos aleatorios da mas peso a estudios pequenos. Si existe sesgo de publicacion, los estudios pequenos tienen mas probabilidad de estar sesgados. Efectos aleatorios puede amplificar el sesgo."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'forest-plot',
          title: "Constructor de Forest Plot",
          description: "Construye forest plots interactivos con efectos fijos o aleatorios"
        }
      },
      {
        type: 'content',
        content: {
          title: "LA SEDUCCION: Meta-Analisis Acumulativo y Falsa Confianza",
          sections: [
            {
              heading: "La Historia del Magnesio ‚Äî Un Cuento de Advertencia",
              items: [
                "1984: Primer ensayo pequeno muestra que el magnesio reduce la mortalidad por IM en 50%",
                "1985-1991: Seis ensayos pequenos mas confirman beneficio. OR acumulativo 0.45 (0.26-0.77)",
                "1992: LIMIT-2 (2,316 pacientes) agrega a la evidencia. OR ahora 0.56 (0.42-0.76)",
                "Los meta-analistas declaran: 'La evidencia es concluyente. Mas ensayos son no eticos.'"
              ]
            },
            {
              heading: "La Realidad del Mega-Ensayo",
              items: [
                "1995: ISIS-4 enrola 58,050 pacientes ‚Äî mas grande que TODOS los ensayos previos combinados",
                "Resultado: 7.64% vs 7.24% mortalidad. OR 1.06 (0.99-1.14)",
                "El beneficio 'concluyente' del 50% se evaporo completamente",
                "Fuente: Lancet 2002 ensayo MAGIC; PubMed 12401244"
              ]
            },
            {
              heading: "¬øQue Salio Mal?",
              items: [
                "Ensayos pequenos: sesgo de seleccion, sesgo de publicacion, sesgo de optimismo",
                "Meta-analisis acumulativo: dio falsa impresion de convergencia",
                "Cada nuevo ensayo pequeno positivo 'confirmo' resultados sesgados previos",
                "Solo el mega-ensayo tuvo poder para detectar la verdad: SIN EFECTO"
              ]
            },
            {
              heading: "LA REPETICION: Los Estudios Pequenos Mienten, Los Grandes Dicen la Verdad",
              items: [
                "Este patron se repite en medicina: TASTE (aspiracion de trombo), IABP-SHOCK II (bombas de balon)",
                "Los meta-analisis de ensayos pequenos consistentemente sobreestiman beneficios",
                "Cuando los resultados conflictuan por tamano de estudio, confia en los grandes",
                "LA PREGUNTA: ¬øTu meta-analisis esta impulsado por ensayos pequenos, potencialmente sesgados?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'synthesize_decision_tree',
          title: "El Dilema del I¬≤",
          scenario: "Tu meta-analisis de mortalidad de 12 ensayos: RR 0.78 (IC 95% 0.65-0.93, p=0.006). I¬≤ = 82%. Dos ensayos pequenos muestran RR 0.3-0.4. Tres mega-ensayos muestran RR 0.85-0.95. Tu coautor quiere titular la reduccion de mortalidad del 22%.",
          realCase: "ISIS-4: Siete ensayos pequenos (n=1,301) mostraron que el magnesio reducia la mortalidad por IM en 55%. Luego ISIS-4 (n=58,050) mostro OR 1.06. Los estudios pequenos estaban equivocados. Su estimacion combinada era un artefacto del sesgo de publicacion y efectos de estudios pequenos.",
          nodes: {
            start: {
              id: 'start',
              situation: "El forest plot muestra clara heterogeneidad. Estudios pequenos (n<500) se agrupan alrededor de RR 0.35. Estudios grandes (n>2000) se agrupan alrededor de RR 0.90. Efectos aleatorios da mas peso a los estudios pequenos que efectos fijos.",
              question: "¬øCual es tu interpretacion?",
              branches: [
                { id: 'report_pooled', text: "El RR combinado 0.78 es el mejor resumen ‚Äî reportarlo", nextNode: 'pooled_problem' },
                { id: 'investigate_pattern', text: "El patron sugiere efectos de estudios pequenos ‚Äî investigar", nextNode: 'small_study_investigation' },
                { id: 'trust_mega', text: "Confiar en los mega-ensayos ‚Äî tienen estimaciones mas precisas", nextNode: 'mega_trial_bias' }
              ]
            },
            pooled_problem: {
              id: 'pooled_problem',
              situation: "Reportas RR 0.78. Un revisor de revista calcula el intervalo de prediccion: RR 0.32-1.89. 'Tu IC sugiere beneficio, pero tu IP sugiere que el tratamiento podria duplicar la mortalidad en algunos entornos. Esto debe estar en tu resumen.'",
              question: "¬øComo respondes?",
              branches: [
                { id: 'add_pi', text: "Agregar el intervalo de prediccion al resumen", nextNode: 'transparency_path' },
                { id: 'defend_ci', text: "El IC es la metrica convencional ‚Äî el IP es demasiado conservador", nextNode: 'ci_defense_fails' },
                { id: 'reframe_results', text: "Replantear como 'evidencia de heterogeneidad, ninguna estimacion unica posible'", nextNode: 'honest_uncertainty' }
              ]
            },
            transparency_path: {
              id: 'transparency_path',
              situation: "Tu resumen revisado: 'RR 0.78 (IC 95% 0.65-0.93); sin embargo, heterogeneidad sustancial (I¬≤=82%) produjo un intervalo de prediccion de 0.32-1.89, sugiriendo que el beneficio varia ampliamente entre entornos.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: El IC te dice sobre el promedio. El IP te dice sobre el rango. Cuando la heterogeneidad es alta, el IP es la metrica clinicamente relevante. Responde: '¬øQue podria pasar en MI entorno?'"
            },
            ci_defense_fails: {
              id: 'ci_defense_fails',
              situation: "El revisor responde: 'El IC responde la pregunta equivocada. Los clinicos necesitan saber: ¬øfuncionara esto en mi hospital? Con I¬≤=82%, la respuesta es 'tal vez si, tal vez no.' Tu IC crea falsa certeza.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: ISIS-4 nos enseno esta leccion. Los ensayos pequenos dijeron 55% de reduccion de mortalidad. El mega-ensayo dijo 0%. La estimacion combinada de ensayos pequenos era enganosa. La heterogeneidad no es ruido ‚Äî es senal."
            },
            honest_uncertainty: {
              id: 'honest_uncertainty',
              situation: "Tu resumen ahora dice: 'El tratamiento mostro beneficio en analisis combinado (RR 0.78), pero heterogeneidad extrema (I¬≤=82%) impide una estimacion resumen unica. El efecto vario desde RR 0.30 en estudios pequenos hasta 0.95 en mega-ensayos. Se necesita analisis de subgrupos.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: A veces la respuesta honesta es 'no tenemos un solo numero.' Cuando I¬≤ excede 75%, considera si combinar es significativo. La heterogeneidad misma se convierte en el hallazgo."
            },
            small_study_investigation: {
              id: 'small_study_investigation',
              situation: "Examinas los estudios pequenos mostrando RR 0.3-0.4. Ambos eran de un solo centro, ambos publicados por el mismo grupo de investigacion, ambos en revistas de bajo factor de impacto. Uno es de 1998, el otro de 2001. Ninguno ha sido replicado independientemente.",
              question: "¬øQue sugiere este patron?",
              branches: [
                { id: 'pub_bias_suspect', text: "Sesgo de publicacion ‚Äî los ensayos pequenos negativos no fueron publicados", nextNode: 'funnel_analysis' },
                { id: 'fraud_suspect', text: "Posible fraude ‚Äî mismo grupo, efectos inverosimiles", nextNode: 'fraud_investigation' },
                { id: 'true_heterogeneity', text: "Heterogeneidad verdadera ‚Äî diferentes poblaciones responden diferente", nextNode: 'true_het_explore' }
              ]
            },
            funnel_analysis: {
              id: 'funnel_analysis',
              situation: "Tu funnel plot muestra asimetria clara. Prueba de Egger p=0.003. El cuadrante inferior izquierdo (ensayos pequenos negativos) esta vacio. Trim-and-fill imputa 4 estudios 'faltantes', cambiando RR de 0.78 a 0.91 (ya no significativo).",
              question: "¬øComo reportas esto?",
              branches: [
                { id: 'report_both', text: "Reportar estimaciones originales y ajustadas por trim-and-fill", nextNode: 'balanced_reporting' },
                { id: 'dismiss_trim', text: "Trim-and-fill sobrecorrige ‚Äî reportar solo original", nextNode: 'selective_reporting' }
              ]
            },
            balanced_reporting: {
              id: 'balanced_reporting',
              situation: "Tu seccion de resultados muestra: 'Analisis primario: RR 0.78 (0.65-0.93). Evaluacion de sesgo de publicacion: funnel plot asimetrico (Egger p=0.003), RR ajustado por trim-and-fill 0.91 (0.77-1.08). El efecto verdadero probablemente esta entre estas estimaciones.'",
              isEnding: true,
              outcome: 'good',
              lesson: "EL GANCHO REGRESA: Recuerda el analisis de Turner de 2008 ‚Äî 94% de ensayos publicados de antidepresivos eran positivos vs 51% enviados a FDA. Los estudios faltantes cambian todo. Reporta la incertidumbre, no la estimacion conveniente."
            },
            selective_reporting: {
              id: 'selective_reporting',
              situation: "Descartas trim-and-fill como 'demasiado conservador.' Pero la asimetria es real. Los ensayos pequenos negativos faltantes, si se publicaran, cambiarian dramaticamente tu conclusion. Estas reportando una literatura sesgada, no la verdad.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA ADVERTENCIA: Trim-and-fill no es perfecto, pero tampoco lo es ignorar la asimetria del funnel. Cuando p de Egger <0.01, algo esta sistematicamente faltando. Reporta ambas estimaciones y discute las implicaciones honestamente."
            },
            fraud_investigation: {
              id: 'fraud_investigation',
              situation: "Profundizas en los dos estudios atipicos. Ambos reportan DE identicas entre grupos. Las caracteristicas basales estan perfectamente pareadas. El seguimiento es 100% en ambos. Las alarmas de 'demasiado bueno para ser verdad' suenan.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PREGUNTA: DECREASE mostro los mismos patrones. Cuando estudios pequenos impulsan tu resultado de meta-analisis con precision inverosimil, investiga. No puedes probar fraude, pero puedes conducir analisis de sensibilidad excluyendo estudios sospechosos."
            },
            true_het_explore: {
              id: 'true_het_explore',
              situation: "Hipotetizas: quizas los estudios pequenos usaron diferentes poblaciones de pacientes (¬ømas enfermos? ¬øsubgrupos especificos?). Pero revisando caracteristicas: los mega-ensayos en realidad tenian pacientes de MAYOR riesgo. El efecto de estudios pequenos no se explica por la mezcla de casos.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REPETICION: Cuando no puedes explicar heterogeneidad por caracteristicas del estudio, quedan tres explicaciones: azar, sesgo de publicacion, o diferencias metodologicas. Cada una tiene diferentes implicaciones. No asumas heterogeneidad verdadera sin evidencia."
            },
            mega_trial_bias: {
              id: 'mega_trial_bias',
              situation: "Te enfocas en los mega-ensayos: RR ~0.90. Pero tu coautor argumenta: 'Los mega-ensayos enrolan pacientes promedio. Los estudios pequenos podrian haber encontrado poblaciones que verdaderamente se benefician mas. Estas desechando senal importante.'",
              question: "¬øQuien tiene razon?",
              branches: [
                { id: 'mega_right', text: "Los mega-ensayos son mas confiables ‚Äî mayor N significa mejor estimacion", nextNode: 'mega_wins' },
                { id: 'both_valid', text: "Ambos tienen valor ‚Äî se necesita analisis de subgrupos para entender", nextNode: 'subgroup_exploration' }
              ]
            },
            mega_wins: {
              id: 'mega_wins',
              situation: "Reportas solo la estimacion de mega-ensayos. Pero ISIS-4 nos enseno: los mega-ensayos responden una pregunta (efecto promedio en poblacion amplia). Los estudios pequenos podrian responder una pregunta diferente (efecto en poblaciones especificas). Ambos podrian tener 'razon.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REVELACION GRADUAL: ISIS-4 vs estudios pequenos no era necesariamente 'equivocado vs correcto' ‚Äî podria ser 'preguntas diferentes.' Los estudios pequenos estudiaron pacientes dentro de 6 horas del IM. ISIS-4 enrolo hasta 24 horas. El tratamiento temprano podria verdaderamente funcionar mejor."
            },
            subgroup_exploration: {
              id: 'subgroup_exploration',
              situation: "Conduces analisis de subgrupos pre-especificado: tiempo al tratamiento, edad del paciente, severidad de enfermedad. Tiempo al tratamiento muestra interaccion (p=0.02): tratamiento temprano RR 0.65, tratamiento tardio RR 0.98. Los estudios pequenos todos usaron tratamiento temprano.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: La heterogeneidad puede contener informacion. El tratamiento funciona ‚Äî pero solo temprano. ISIS-4 diluyo la senal incluyendo pacientes tardios. El analisis de subgrupos (cuando esta pre-especificado) puede rescatar hallazgos significativos de datos heterogeneos."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "¬øQue pasa si los mismos datos, analizados de dos formas, dan conclusiones opuestas?",
          context: "La administracion temprana de surfactante en infantes prematuros fue estudiada en multiples ensayos. Las revisiones Cochrane sintetizaron la evidencia. Pero un fenomeno fascinante emergio: los mismos ensayos, combinados con diferentes modelos estadisticos, produjeron conclusiones diferentes. Un modelo dijo 'beneficio significativo.' El otro dijo 'no significativo.' Ambos eran tecnicamente correctos. Ambos no podian ser verdad.",
          stats: [
            { value: "p=0.03", label: "Modelo de Efectos Fijos", type: "success" },
            { value: "p=0.12", label: "Modelo de Efectos Aleatorios", type: "" },
            { value: "I¬≤=45%", label: "Heterogeneidad", type: "" },
            { value: "Opuestas", label: "Conclusiones", type: "danger" }
          ],
          source: "Revisiones Neonatales Cochrane | Soll RF, Morley CJ",
          decisionScenario: "Estas analizando ensayos de surfactante para infantes prematuros. Tu meta-analisis muestra heterogeneidad moderada (I¬≤=45%). Debes elegir entre modelos de efectos fijos y aleatorios.",
          pathA: {
            title: "Usar modelo de efectos fijos",
            steps: [
              "Asumir que todos los ensayos estiman un efecto verdadero",
              "Ponderar por varianza inversa (ensayos grandes dominan)",
              "Obtener intervalo de confianza mas estrecho",
              "Resultado: RR 0.82 (IC 95%: 0.69-0.98), p=0.03",
              "Conclusion: Beneficio significativo, recomendar surfactante temprano",
              "Pero asumiste homogeneidad cuando I¬≤=45% sugeria lo contrario"
            ]
          },
          pathB: {
            title: "Usar modelo de efectos aleatorios",
            steps: [
              "Asumir que los ensayos estiman una distribucion de efectos",
              "Agregar varianza entre estudios a las ponderaciones",
              "Obtener intervalo de confianza mas amplio",
              "Resultado: RR 0.82 (IC 95%: 0.64-1.05), p=0.12",
              "Conclusion: No significativo, evidencia insuficiente",
              "Reconociste la variacion, pero perdiste significancia estadistica"
            ]
          },
          revelation: "La eleccion del modelo no es tecnica ‚Äî es filosofica. Efectos fijos pregunta: '¬øCual es EL efecto?' Efectos aleatorios pregunta: '¬øCual es el efecto PROMEDIO entre diferentes entornos?' Cuando existe heterogeneidad, estas son preguntas diferentes con respuestas diferentes. Ningun modelo es 'incorrecto.' Pero pretender que existe homogeneidad cuando no es asi es una mentira que tus estadisticas cuentan.",
          moduleConnection: "Por esto importa la eleccion del modelo. La misma estimacion puntual (RR 0.82) se vuelve significativa o no significativa basado en tus suposiciones. Reporta ambos modelos cuando existe heterogeneidad. Deja que los lectores vean como las conclusiones dependen de suposiciones."
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "¬øQue significa cuando un intervalo de confianza apenas excluye 1.0?",
          context: "En 2007, Steve Nissen publico un meta-analisis de rosiglitazona (Avandia), un farmaco exitoso para diabetes. Cuarenta y dos ensayos. Veintiocho mil pacientes. El forest plot mostro algo perturbador: el odds ratio combinado para infarto de miocardio era 1.43, con un IC 95% de 1.03-1.98. El intervalo de confianza apenas excluia 1.0. Algunos lo descartaron como 'apenas significativo.' Pero Nissen vio un aumento del 43% en infartos.",
          stats: [
            { value: "42", label: "Ensayos Combinados", type: "" },
            { value: "28,000", label: "Pacientes", type: "" },
            { value: "1.43", label: "Odds Ratio para IM", type: "danger" },
            { value: "1.03-1.98", label: "IC 95%", type: "" }
          ],
          source: "Nissen SE, Wolski K. NEJM 2007; 356:2457-71",
          decisionScenario: "Ves el forest plot de rosiglitazona. El IC es 1.03-1.98. El limite inferior apenas excluye 1.0. Tu colega dice 'Es apenas significativo ‚Äî podria ser ruido.'",
          pathA: {
            title: "Enfocarse en significancia estadistica ‚Äî 'apenas' significa incierto",
            steps: [
              "Notar que IC apenas excluye 1.0",
              "Argumentar que el resultado podria ser debido al azar",
              "Recomendar esperar mas datos",
              "El farmaco continua en uso extendido",
              "Miles de IM mas ocurren mientras esperan",
              "Eventualmente la FDA emite advertencia de recuadro negro de todos modos"
            ]
          },
          pathB: {
            title: "Enfocarse en significancia clinica ‚Äî 43% mas infartos importa",
            steps: [
              "La estimacion puntual es 43% de riesgo aumentado de IM",
              "Incluso el limite inferior del IC (3% de aumento) es clinicamente significativo",
              "28,000 pacientes no es un estudio pequeno",
              "Recomendar revision inmediata de FDA",
              "La FDA emite advertencia de recuadro negro",
              "Reguladores europeos retiran el farmaco"
            ]
          },
          revelation: "La significancia estadistica es un umbral. La significancia clinica es un juicio. El forest plot muestra ambos ‚Äî debes ver ambos. Un aumento del 43% en infartos no es 'apenas' nada. Es una senal de que miles de pacientes estan siendo danados. El meta-analisis de Nissen cambio la practica porque el entendio: la pregunta no es '¬øEs p < 0.05?' La pregunta es '¬øEstan siendo danados los pacientes?'",
          moduleConnection: "Por esto importan los forest plots. Te muestran no solo la estimacion combinada, sino la precision y el significado clinico. Un IC de 1.03-1.98 te dice: incluso en el mejor caso, el riesgo de IM esta aumentado. El peor caso es duplicado. Eso no es ruido estadistico ‚Äî eso es un farmaco que no deberia estar en el mercado."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Un meta-analisis de efectos aleatorios da mas peso a estudios pequenos que un analisis de efectos fijos. ¬øPor que esto es potencialmente problematico?",
          options: [
            { id: 'a', text: "Los estudios pequenos tienen mayor error de muestreo", correct: false },
            { id: 'b', text: "Los estudios pequenos tienen mas probabilidad de publicarse si muestran resultados positivos", correct: true },
            { id: 'c', text: "Los estudios pequenos usan metodologia inferior", correct: false },
            { id: 'd', text: "Los estudios pequenos miden desenlaces diferentes", correct: false }
          ],
          explanation: "El sesgo de publicacion afecta desproporcionadamente a estudios pequenos ‚Äî los ensayos pequenos negativos a menudo quedan sin publicar, mientras que los positivos pasan. Al dar mas peso a estudios pequenos, efectos aleatorios puede amplificar este sesgo, produciendo estimaciones combinadas infladas."
        }
      }
    ]
  },
  // Modulo 9: La Heterogeneidad
  {
    id: 9,
    title: "La Heterogeneidad",
    subtitle: "Mas Alla de I-cuadrado",
    principle: 5,
    story: "ACCORD",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "El promedio puede mentir"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA PARADOJA: ACCORD ‚Äî CUANDO LOS PROMEDIOS MATAN",
          source: "NEJM 2008; 358:2545-2559 | ACCORD Study Group | PubMed: 18539917",
          timeline: [
            { year: "1998-2007", text: "Multiples ensayos sugieren que el control intensivo de glucosa (HbA1c < 7%) reduce complicaciones. Los meta-analisis apoyan beneficio.", type: "normal" },
            { year: "2003", text: "ACCORD comienza: 10,251 diabeticos aleatorizados a control intensivo (HbA1c < 6.0%) vs estandar (7.0-7.9%).", type: "normal" },
            { year: "Feb 2008", text: "El DSMB detiene el brazo intensivo temprano. 257 muertes vs 203. HR 1.22 (IC 95%: 1.01-1.46). p = 0.04.", type: "crisis" },
            { year: "La Paradoja", text: "HbA1c se redujo exitosamente (6.4% vs 7.5%). Pero MAS personas murieron. El sustituto mejoro mientras los pacientes empeoraron.", type: "crisis" },
            { year: "La Verdad", text: "Los subgrupos divergieron: pacientes con larga duracion de diabetes, ECV previa, o episodios hipoglucemicos fueron danados. El promedio enmascar√≥ heterogeneidad letal.", type: "revelation" }
          ],
          realData: {
            endpoint: "Mortalidad por todas las causas",
            drug: "257/5,128 (5.0%)",
            placebo: "203/5,123 (4.0%)",
            rr: "1.22",
            ci: "1.01-1.46",
            nnh: "95"
          },
          hook: "El promedio mostro dano. Pero el promedio no es una persona. En algun lugar dentro de ese promedio habia pacientes que se beneficiaron. Y pacientes que murieron. La heterogeneidad no es una molestia ‚Äî es donde se esconde la verdad."
        }
      },
      {
        type: 'content',
        content: {
          title: "Entendiendo las Metricas de Heterogeneidad",
          sections: [
            {
              heading: "I¬≤ ‚Äî Porcentaje de Varianza Debido a Heterogeneidad",
              items: [
                "0%: sin heterogeneidad (diferencias solo por muestreo)",
                "25%: baja heterogeneidad",
                "50%: heterogeneidad moderada",
                "75%+: alta heterogeneidad",
                "Limitacion: depende de precision, no solo variabilidad"
              ]
            },
            {
              heading: "œÑ¬≤ ‚Äî Varianza Entre Estudios",
              items: [
                "Medida absoluta de heterogeneidad",
                "Mismas unidades que tamano de efecto (al cuadrado)",
                "No depende del numero o tamano de estudios",
                "Mas dificil de interpretar directamente"
              ]
            },
            {
              heading: "Intervalo de Prediccion ‚Äî La Metrica Crucial",
              items: [
                "¬øDonde estaria el efecto verdadero en un NUEVO estudio?",
                "Incorpora tanto IC como heterogeneidad",
                "Si cruza nulo, el tratamiento puede no funcionar en todos lados",
                "La pregunta clinicamente relevante"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: EXPLORANDO HETEROGENEIDAD",
          title: "Encontrando la Senal en el Ruido",
          sections: [
            {
              heading: "Inspeccion Visual",
              text: "Mira el forest plot. ¬øLos intervalos de confianza se superponen? ¬øHay valores atipicos? ¬øHay un patron (estudios pequenos vs grandes, viejos vs nuevos)?"
            },
            {
              heading: "Analisis de Subgrupos",
              text: "Comparaciones pre-especificadas: dosis, duracion, poblacion, riesgo de sesgo. Prueba de interaccion (¬øel efecto es diferente entre subgrupos?). Cuidado con pruebas multiples."
            },
            {
              heading: "Meta-Regresion",
              text: "Modela tamano de efecto como funcion de caracteristicas del estudio. Requiere 10+ estudios por covariable. Riesgo de falacia ecologica: asociaciones a nivel de estudio pueden no reflejar nivel de paciente."
            },
            {
              heading: "Analisis de Sensibilidad",
              text: "Dejar-uno-fuera: ¬øun solo estudio impulsa el resultado? Alto vs bajo RoB: ¬øla calidad importa? Fijo vs aleatorio: ¬øla eleccion del modelo cambia la conclusion?"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'heterogeneity-explorer',
          title: "Explorador de Heterogeneidad",
          description: "Visualiza e interpreta I¬≤, œÑ¬≤, e intervalos de prediccion"
        }
      },
      {
        type: 'content',
        content: {
          title: "LA TRAMPA: Falsos Efectos de Clase ‚Äî Fluidos HES en Sepsis",
          sections: [
            {
              heading: "La Suposicion",
              items: [
                "Los fluidos coloides (HES, albumina) mantienen el volumen intravascular mejor que cristaloides",
                "Por decadas, esto se 'sabia' ‚Äî tenia sentido fisiologico",
                "Los meta-analisis combinaron todos los coloides vs cristaloides, asumiendo efecto de clase"
              ]
            },
            {
              heading: "Ensayo 6S (2012) ‚Äî La Primera Grieta",
              items: [
                "798 pacientes con sepsis severa: HES vs acetato de Ringer",
                "Mortalidad a 90 dias: RR 1.17 (IC 95%: 1.01-1.36) ‚Äî HES DANINO",
                "Terapia de reemplazo renal: RR 1.35 (1.01-1.80) ‚Äî HES causo falla renal",
                "Fuente: NEJM 2012; PubMed 22738085"
              ]
            },
            {
              heading: "Ensayo CHEST (2012) ‚Äî Confirmacion",
              items: [
                "7,000 pacientes de UCI: HES vs solucion salina",
                "Mortalidad a 90 dias: RR 1.06 (0.96-1.18) ‚Äî tendencia hacia dano",
                "Reemplazo renal: RR 1.21 (1.00-1.45) ‚Äî dano renal significativo",
                "Fuente: NEJM 2012; DOI 10.1056/NEJMoa1209759"
              ]
            },
            {
              heading: "LA ADVERTENCIA: Los Efectos de Clase Son Hipotesis, No Hechos",
              items: [
                "HES, albumina y otros coloides NO son intercambiables",
                "Un meta-analisis combinando 'todos los coloides' oculto que HES especificamente era danino",
                "La heterogeneidad dentro de una clase de farmaco puede ser de vida o muerte",
                "LA PREGUNTA: Cuando combinas 'Clase de Farmaco X', ¬øestas asumiendo equivalencia que no puedes probar?"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'heterogeneity_decision_tree',
          title: "El Problema del Intervalo de Prediccion",
          scenario: "Farmaco X para prevencion de fracturas: 8 ensayos, RR 0.70 (IC 95% 0.58-0.85). I¬≤ = 68%. Intervalo de prediccion: RR 0.42-1.17. El comite de tu hospital pregunta: '¬øDebemos agregar el Farmaco X al formulario?'",
          realCase: "ACCORD mostro que el control intensivo de glucosa 'funciono' en promedio ‚Äî HbA1c bajo de 8.1% a 6.4%. Pero algunos pacientes murieron. El promedio enmascar√≥ heterogeneidad letal de subgrupos. Conocer el promedio no es suficiente.",
          nodes: {
            start: {
              id: 'start',
              situation: "El presidente del comite dice: 'RR 0.70 significa 30% de reduccion de fracturas. El IC excluye 1.0. Esta es evidencia fuerte. Aprobemoslo.' Tu farmaceutico clinico plantea la preocupacion del intervalo de prediccion.",
              question: "¬øComo explicas el intervalo de prediccion al comite?",
              branches: [
                { id: 'explain_pi', text: "El IP nos dice que esperar en NUESTRO hospital", nextNode: 'pi_explanation' },
                { id: 'support_chair', text: "El presidente tiene razon ‚Äî el IC es lo que importa para 'efecto promedio'", nextNode: 'chair_mistake' },
                { id: 'explore_heterogeneity', text: "Antes de decidir, necesitamos entender POR QUE varian los efectos", nextNode: 'heterogeneity_exploration' }
              ]
            },
            pi_explanation: {
              id: 'pi_explanation',
              situation: "Explicas: 'El IC nos dice que estamos confiados de que el promedio esta entre 0.58-0.85. Pero nuestro hospital no es promedio. El IP nos dice: en un nuevo entorno como el nuestro, el efecto verdadero podria variar desde 58% de reduccion hasta 17% de AUMENTO en fracturas.'",
              question: "El presidente pregunta: '¬øComo puede un farmaco que funciona en promedio danar a algunos pacientes?'",
              branches: [
                { id: 'accord_example', text: "Usar ACCORD como ejemplo ‚Äî beneficio promedio, dano en subgrupo", nextNode: 'accord_lesson' },
                { id: 'technical_explanation', text: "Explicar œÑ¬≤ y varianza entre estudios matematicamente", nextNode: 'lost_committee' },
                { id: 'practical_implications', text: "Enfocarse en lo que esto significa para la decision del formulario", nextNode: 'practical_path' }
              ]
            },
            accord_lesson: {
              id: 'accord_lesson',
              situation: "Explicas ACCORD: 'El control intensivo de glucosa bajo el HbA1c promedio hermosamente. Pero el ensayo fue detenido ‚Äî 257 muertes vs 203. Pacientes con larga duracion de diabetes, ECV previa, o hipoglucemia fueron danados mientras otros se beneficiaron. El promedio enmascar√≥ el dano.'",
              question: "El comite pregunta: '¬øEntonces que hacemos con el Farmaco X?'",
              branches: [
                { id: 'conditional_approval', text: "Aprobar con restricciones ‚Äî identificar quien se beneficia", nextNode: 'smart_approval' },
                { id: 'reject_drug', text: "Rechazar hasta que entendamos la heterogeneidad", nextNode: 'cautious_rejection' }
              ]
            },
            smart_approval: {
              id: 'smart_approval',
              situation: "Propones: 'Aprobar Farmaco X para pacientes que coinciden con los ensayos donde funciono mejor. Mirando el forest plot: ensayos en pacientes de alto riesgo (fractura previa) muestran RR 0.55. Ensayos en pacientes de riesgo moderado muestran RR 0.95.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: La heterogeneidad puede guiar la personalizacion. En lugar de dar a todos tratamiento 'promedio', identifica quien se beneficia mas. Esta es medicina de precision informada por meta-analisis. El IP senalo que una talla no sirve para todos."
            },
            cautious_rejection: {
              id: 'cautious_rejection',
              situation: "El comite retrasa la aprobacion pendiente analisis de subgrupos. Tres meses despues, presentas: 'Farmaco X funciona en pacientes de alto riesgo (RR 0.55) pero no en bajo riesgo (RR 0.98). Debemos aprobar solo para alto riesgo.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: La cautela estaba justificada. La aprobacion universal habria expuesto a pacientes de bajo riesgo a efectos secundarios sin beneficio. El IP cruzando 1.0 era una senal de advertencia de que el farmaco no funcionaba en todos lados."
            },
            lost_committee: {
              id: 'lost_committee',
              situation: "Explicas œÑ¬≤ = 0.15, significando varianza entre estudios en log RR. Los ojos del comite se vidrian. El presidente dice: 'Vamos con el IC significativo.' Tu precision tecnica no se tradujo en mejor toma de decisiones.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA ADVERTENCIA: La correccion tecnica no es suficiente. Los tomadores de decisiones necesitan traduccion clinica. 'El farmaco podria danar a algunos pacientes' es mas claro que 'œÑ¬≤ es alto.' Comunica la incertidumbre en terminos que importen a tu audiencia."
            },
            practical_path: {
              id: 'practical_path',
              situation: "Replanteas: 'Si aprobamos Farmaco X para todos, la mayoria se beneficiara. Pero algunos ‚Äî no sabemos exactamente quienes ‚Äî podrian tener MAS fracturas. ¬øEstamos comodos con esa incertidumbre, o debemos restringir la aprobacion?'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PREGUNTA: El IP no te dice que hacer ‚Äî te dice lo que no sabes. La decision depende de tolerancia al riesgo, reversibilidad del dano, y si puedes identificar quien esta en riesgo. Enmarca la incertidumbre, deja que el comite decida."
            },
            chair_mistake: {
              id: 'chair_mistake',
              situation: "Apoyas al presidente. Farmaco X es aprobado para todos los pacientes. Un ano despues: auditoria muestra tasas de fractura sin cambios en tus pacientes de bajo riesgo, pero dos pacientes de alto riesgo tuvieron eventos adversos. El farmaco no era danino 'en promedio' ‚Äî pero los promedios no tratan pacientes.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: ACCORD mato pacientes porque las decisiones se basaron en promedios. El IC les dijo 'el promedio se beneficia.' La verdad era: algunas personas se benefician, algunas personas mueren. El IP habria senalado esto. Ignoraste la advertencia."
            },
            heterogeneity_exploration: {
              id: 'heterogeneity_exploration',
              situation: "Sugieres: 'Antes de decidir, veamos POR QUE varian los efectos.' Examinas los 8 ensayos. Emerge un patron: 4 ensayos en pacientes de alto riesgo (fractura previa) ‚Äî RR 0.55. 4 ensayos en pacientes de riesgo moderado ‚Äî RR 0.95.",
              question: "¬øQue explica este patron?",
              branches: [
                { id: 'biological_explanation', text: "Pacientes de alto riesgo tienen mas espacio para beneficiarse", nextNode: 'subgroup_insight' },
                { id: 'trial_quality', text: "Quizas los ensayos de alto riesgo tenian problemas metodologicos", nextNode: 'quality_check' },
                { id: 'chance', text: "Podria ser azar con 4 vs 4 ensayos", nextNode: 'credibility_assessment' }
              ]
            },
            subgroup_insight: {
              id: 'subgroup_insight',
              situation: "Plausibilidad biologica: Farmaco X fortalece huesos. Pacientes con fracturas previas tienen huesos mas debiles ‚Äî mas potencial de mejora. Pacientes con huesos ya fuertes no pueden fortalecerse mucho mas. La heterogeneidad refleja biologia, no ruido.",
              question: "¬øComo cambia esto tu recomendacion?",
              branches: [
                { id: 'targeted_therapy', text: "Recomendar Farmaco X solo para pacientes de alto riesgo", nextNode: 'precision_medicine' },
                { id: 'broad_approval', text: "Aun aprobar ampliamente ‚Äî riesgo moderado no es danado", nextNode: 'missed_opportunity' }
              ]
            },
            precision_medicine: {
              id: 'precision_medicine',
              situation: "Tu recomendacion: 'Aprobacion de formulario restringida a pacientes con fractura por fragilidad previa, T-score ‚â§-2.5, o FRAX ‚â•20%.' El comite adopta esto. Los costos de medicamentos disminuyen (menos tratados), los resultados mejoran (tratando respondedores).",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION: El intervalo de prediccion no era un problema ‚Äî era informacion. Al entender la heterogeneidad, convertiste 'efecto promedio' en medicina personalizada. Este es el uso positivo del Principio 6: El promedio puede mentir ‚Äî pero los subgrupos dicen la verdad."
            },
            missed_opportunity: {
              id: 'missed_opportunity',
              situation: "Farmaco X aprobado para todos. Pacientes de alto riesgo se benefician. Pacientes de riesgo moderado toman pastillas diariamente sin beneficio, experimentan efectos secundarios, e incurren costos. Tenias la informacion para hacerlo mejor ‚Äî pero la promediaste.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REPETICION: 'No danino en promedio' no es lo mismo que 'beneficioso para todos.' ACCORD, ISIS-4, e incontables meta-analisis muestran: la heterogeneidad es informacion. Cuando el IP es amplio, pregunta quien se beneficia ‚Äî no trates a todos."
            },
            quality_check: {
              id: 'quality_check',
              situation: "Verificas: los ensayos de alto riesgo tienen bajo RoB (cegamiento apropiado, ocultamiento de asignacion). Los ensayos de riesgo moderado tambien tienen bajo RoB. La calidad del ensayo no explica la diferencia. La modificacion de efecto parece real.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: Antes de confiar en hallazgos de subgrupos, verifica que no esten confundidos por calidad del estudio. Aqui, ambos subgrupos tienen RoB similar. El efecto diferencial es mas probable que sea real cuando la calidad esta balanceada."
            },
            credibility_assessment: {
              id: 'credibility_assessment',
              situation: "Aplicas criterios ICEMAN: ¬øEl subgrupo esta pre-especificado? (Si) ¬øEl efecto es consistente en direccion? (Si) ¬øHay plausibilidad biologica? (Si) ¬øLa prueba de interaccion es significativa? (p = 0.03) Credibilidad: moderada-alta.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: No todos los analisis de subgrupos son iguales. Los criterios ICEMAN ayudan a distinguir modificacion de efecto real de mineria de datos. Cuando multiples criterios se cumplen, puedes actuar cautelosamente sobre el hallazgo del subgrupo."
            }
          }
        }
      },
      {
        type: 'real-world-story',
        content: {
          rhetoricalQuestion: "Siete ensayos pequenos concuerdan. Luego un ensayo grande discrepa. ¬øQuien tiene razon?",
          context: "A principios de los 1990s, el sulfato de magnesio para infarto agudo de miocardio parecia un milagro. Siete ensayos pequenos (n total=1,301) mostraron que el magnesio reducia la mortalidad en 55%. Un meta-analisis declaro la evidencia 'concluyente.' Algunos argumentaron que mas ensayos eran no eticos. Luego vino ISIS-4 ‚Äî un mega-ensayo de 58,050 pacientes. El resultado sorprendio al campo.",
          stats: [
            { value: "OR 0.44", label: "Ensayos Pequenos Combinados", type: "success" },
            { value: "55%", label: "Reduccion de Mortalidad Afirmada", type: "" },
            { value: "OR 1.06", label: "Resultado ISIS-4", type: "danger" },
            { value: "58,050", label: "Pacientes ISIS-4", type: "" }
          ],
          source: "ISIS-4 Collaborative Group. Lancet 1995; 345:669-85",
          decisionScenario: "Estas combinando ensayos de magnesio para IM agudo. Tu meta-analisis de ensayos pequenos muestra OR 0.44 (beneficio fuerte). Luego ISIS-4 publica mostrando OR 1.06 (sin beneficio). La heterogeneidad es masiva.",
          pathA: {
            title: "Asumir homogeneidad ‚Äî combinar todos los ensayos juntos",
            steps: [
              "Incluir tanto ensayos pequenos como ISIS-4 en un analisis",
              "Estimacion combinada: en algun lugar entre 0.44 y 1.06",
              "El resultado es un 'promedio' sin sentido de hallazgos contradictorios",
              "El IC es amplio, la heterogeneidad es extrema",
              "Los clinicos confundidos: ¬øfunciona el magnesio o no?",
              "Nadie aprende POR QUE los ensayos discreparon"
            ]
          },
          pathB: {
            title: "Investigar heterogeneidad ‚Äî encontrar el mensaje en el ruido",
            steps: [
              "Preguntar: ¬øque difiere entre ensayos pequenos e ISIS-4?",
              "Ensayos pequenos: tratamiento dentro de 6 horas del inicio de sintomas",
              "ISIS-4: tratamiento hasta 24 horas despues del inicio de sintomas",
              "Hipotesis: el magnesio funciona temprano pero no tarde",
              "Analisis de subgrupos confirma efecto dependiente del tiempo",
              "Descubres modificacion de efecto, no contradiccion"
            ]
          },
          revelation: "La heterogeneidad no es ruido. Es un mensaje. La estadistica I¬≤ te dice que alguien es diferente ‚Äî tu trabajo es descubrir quien. ISIS-4 no estaba 'equivocado' y los ensayos pequenos no estaban 'equivocados.' Estaban respondiendo preguntas diferentes. El magnesio temprano podria funcionar. El magnesio tardio no. La estimacion combinada oscurecio la verdad que el analisis de subgrupos revelo.",
          moduleConnection: "Por esto importa la exploracion de heterogeneidad. Cuando tu I¬≤ es alto y los estudios conflictuan, tienes tres opciones: (1) combinar de todos modos y obtener un promedio sin sentido, (2) negarte a combinar y desperdiciar datos, o (3) investigar y descubrir lo que tus datos estan tratando de decirte. La opcion 3 usualmente es correcta."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Dos meta-analisis ambos muestran I¬≤ = 50%. Analisis A tiene œÑ¬≤ = 0.02 con RR medio 0.80. Analisis B tiene œÑ¬≤ = 0.50 con RR medio 0.80. ¬øQue te dice esto?",
          options: [
            { id: 'a', text: "Tienen heterogeneidad identica ya que I¬≤ es igual", correct: false },
            { id: 'b', text: "Analisis B tiene mucha mas variabilidad absoluta en efectos verdaderos", correct: true },
            { id: 'c', text: "Analisis A es mas confiable", correct: false },
            { id: 'd', text: "No se puede comparar sin saber el numero de estudios", correct: false }
          ],
          explanation: "I¬≤ es una proporcion (% de varianza debida a heterogeneidad) pero œÑ¬≤ es varianza absoluta entre estudios. Dos analisis pueden tener I¬≤ identico pero œÑ¬≤ muy diferente. Analisis B tiene 25√ó mas heterogeneidad absoluta ‚Äî los efectos verdaderos estan mucho mas dispersos, significando intervalos de prediccion mas amplios y mas incertidumbre sobre cualquier aplicacion especifica."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ VERIFICACION DE PROGRESO: Has dominado la fase de SINTESIS.\n\n‚úì Modulo 7: TAMANOS DE EFECTO ‚Äî aprendido de la controversia de metricas de ISRS\n‚úì Modulo 8: MODELOS DE META-ANALISIS ‚Äî aprendido del engano de estudios pequenos de ISIS-4\n‚úì Modulo 9: HETEROGENEIDAD ‚Äî aprendido de los subgrupos letales de ACCORD\n\nAhora puedes calcular estimaciones combinadas, elegir modelos apropiados e interpretar heterogeneidad.\n\nFase final: ASEGURAMIENTO DE CALIDAD ‚Äî detectando sesgo de publicacion, calificando certeza con GRADE, y reportando transparentemente.\n\nRecuerda: Un hermoso forest plot no significa nada si has combinado basura."
        }
      }
    ]
  },
  // Modulo 10: El Sesgo
  {
    id: 10,
    title: "El Sesgo",
    subtitle: "Sesgo de Publicacion",
    principle: 6,
    story: "Antidepressants",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La certeza debe estar justificada"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA REVELACION: LA DENUNCIA DE TURNER ‚Äî LA MITAD FALTANTE",
          source: "NEJM 2008; 358:252-260 | Turner et al | PubMed: 18199864",
          timeline: [
            { year: "1987-2004", text: "12 antidepresivos aprobados por FDA. Las farmaceuticas envian 74 ensayos a reguladores. La literatura publicada muestra que estos farmacos funcionan maravillosamente.", type: "normal" },
            { year: "2006", text: "Turner, un ex revisor de FDA, obtiene acceso a la base de datos interna de ensayos de FDA. Compara lo que FDA vio vs. lo que los medicos leen.", type: "normal" },
            { year: "El Conteo", text: "FDA recibio 74 ensayos. 38 fueron positivos. 36 fueron negativos o cuestionables. FDA vio 51% positivos. ¬øQue publicaron las revistas?", type: "normal" },
            { year: "La Revelacion", text: "De 38 ensayos positivos: 37 publicados (97%). De 36 ensayos negativos: 14 publicados (39%) ‚Äî y 11 de esos 14 fueron 'girados' para parecer positivos.", type: "crisis" },
            { year: "Ene 2008", text: "Turner publica: La literatura publicada muestra 94% de ensayos positivos. Realidad: 51%. Tamanos de efecto inflados 32%. Medicos recetando basados en un espejismo.", type: "crisis" },
            { year: "La Pregunta", text: "¬øCuantos pacientes fueron danados por farmacos que 'funcionaban' en publicaciones pero no funcionaban en realidad? Nunca lo sabremos. El archivador los mato silenciosamente.", type: "revelation" }
          ],
          realData: {
            endpoint: "Resultados de ensayos segun evaluacion de FDA",
            drug: "74 ensayos enviados a FDA",
            placebo: "Literatura publicada",
            rr: "FDA: 51% positivos | Publicados: 94% positivos",
            ci: "Inflacion de tamano de efecto: +32%",
            nnh: "La brecha entre verdad y literatura"
          },
          hook: "LA ADVERTENCIA: Cada meta-analisis de literatura publicada es un meta-analisis de lo que la industria queria que vieras. El archivador es donde las verdades inconvenientes van a morir. Turner probo lo que todos sospechaban: hemos estado leyendo ficcion disfrazada de ciencia."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è PUNTO CLAVE: Turner probo que 94% de ensayos publicados de antidepresivos mostraron beneficio mientras solo 51% realmente lo hicieron. Los tamanos de efecto fueron inflados en 32%. Cada meta-analisis que lees es un resumen de lo que sobrevivio al archivador ‚Äî y el archivador esta lleno de verdades inconvenientes que nunca vieron la luz."
        }
      },
      {
        type: 'content',
        content: {
          title: "LA LECCION: Cuando Un Solo Ensayo Positivo Impulso Guias ‚Äî PROWESS",
          sections: [
            {
              heading: "El Ensayo Heroe Unico (2001)",
              items: [
                "PROWESS: 1,690 pacientes con sepsis severa. Proteina C Activada (PCA) vs placebo.",
                "Resultado: mortalidad a 28 dias 24.7% vs 30.8%. RR 0.81 (0.70-0.93). p = 0.005.",
                "FDA aprueba. Las guias recomiendan PCA para sepsis severa. Costo: $8,000/tratamiento.",
                "PROWESS se convierte en la UNICA evidencia. No se requiere replicacion."
              ]
            },
            {
              heading: "Las Replicaciones Fallidas (2005-2011)",
              items: [
                "Ensayo ADDRESS (2005): Sepsis de bajo riesgo. Detenido temprano ‚Äî tendencia hacia DANO en algunos subgrupos.",
                "Ensayo RESOLVE (2007): Sepsis pediatrica. Sin beneficio, mas sangrado.",
                "Los meta-analistas seguian combinando: 'En general aun favorece PCA.' PROWESS dominaba cada meta-analisis."
              ]
            },
            {
              heading: "La Prueba Definitiva ‚Äî PROWESS-SHOCK (2012)",
              items: [
                "1,697 pacientes con shock septico. Replicacion rigurosa del PROWESS original.",
                "Resultado: mortalidad a 28 dias 26.4% vs 24.2%. RR 1.09 (0.92-1.28).",
                "SIN BENEFICIO. Farmaco retirado del mercado mundialmente.",
                "Fuente: NEJM 2012; PubMed 22616830"
              ]
            },
            {
              heading: "LA ADVERTENCIA: Dejar-Uno-Fuera Habria Mostrado Esto",
              items: [
                "Cada meta-analisis de PCA estaba impulsado solo por PROWESS",
                "Remover PROWESS ‚Üí no quedaba efecto significativo",
                "Un ensayo no deberia impulsar guias. Un ensayo no deberia impulsar meta-analisis.",
                "LA PREGUNTA: ¬øTu resultado de meta-analisis es robusto a remover el ensayo mas grande/temprano?"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Detectando Sesgo de Publicacion",
          sections: [
            {
              heading: "Funnel Plot",
              items: [
                "Grafica tamano de efecto vs precision (EE o tamano de muestra)",
                "Se espera simetria si no hay sesgo: estudios pequenos se dispersan uniformemente",
                "Asimetria sugiere: sesgo de publicacion, efectos de estudios pequenos, o heterogeneidad verdadera"
              ]
            },
            {
              heading: "Pruebas Estadisticas",
              items: [
                "Prueba de Egger: regresion de efecto sobre EE (intercepto ‚â† 0 sugiere asimetria)",
                "Prueba de Peters: para desenlaces binarios, usa tamano de muestra",
                "Prueba de Begg: correlacion de rangos (menos poderosa)",
                "Nota: todas las pruebas tienen bajo poder con <10 estudios"
              ]
            },
            {
              heading: "Funnels con Contorno Mejorado",
              items: [
                "Sombrear regiones por significancia estadistica",
                "Si estudios faltantes se agrupan en region no significativa ‚Üí sesgo de publicacion probable",
                "Si asimetria abarca zonas de significancia ‚Üí pueden ser otros efectos de estudios pequenos"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: EVALUANDO Y AJUSTANDO",
          title: "Mas Alla del Funnel Plot",
          sections: [
            {
              heading: "Comparar Registrados vs Publicados",
              text: "Busca en ClinicalTrials.gov, ICTRP, presentaciones a FDA. Calcula: % registrados que fueron publicados, % publicados como positivos. Esta es la evidencia mas fuerte."
            },
            {
              heading: "Trim-and-Fill",
              text: "Imputa estudios 'faltantes' para lograr simetria del funnel. Proporciona estimacion combinada ajustada. Limitacion importante: asume que asimetria = sesgo de publicacion (puede sobrecorregir)."
            },
            {
              heading: "Modelos de Seleccion",
              text: "Modela la probabilidad de publicacion como funcion del valor p. Mas sofisticado que trim-and-fill. Requiere suposiciones sobre mecanismo de seleccion."
            },
            {
              heading: "Limitaciones",
              text: "Asimetria ‚â† sesgo de publicacion. Podria ser: heterogeneidad verdadera (estudios pequenos en poblaciones de alto riesgo), diferencias metodologicas, azar (especialmente con pocos estudios). Las pruebas visuales y estadisticas generan hipotesis, no confirman."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'funnel-plot',
          title: "Constructor de Funnel Plot",
          description: "Crea funnel plots con prueba de Egger y mejora de contorno"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'funnel_decision_tree',
          title: "El Funnel Asimetrico",
          scenario: "Meta-analisis de nuevo medicamento: 15 ensayos, RR 0.72 (IC 95% 0.58-0.89). Tu funnel plot muestra clara asimetria. Estudios pequenos se agrupan en el lado positivo. p de Egger = 0.02. Trim-and-fill cambia RR a 0.89 (IC 95% 0.72-1.10, no significativo).",
          realCase: "Estudio de Turner 2008 en NEJM: 74 ensayos de antidepresivos enviados a FDA. La literatura publicada mostro 94% positivos. Verdad: 51% positivos. Tamanos de efecto inflados en 32%. El funnel habria mostrado esto ‚Äî si alguien hubiera mirado.",
          nodes: {
            start: {
              id: 'start',
              situation: "Tu coautor dice: 'El funnel es claramente asimetrico. Debemos reportar la estimacion ajustada de trim-and-fill como nuestro hallazgo principal ‚Äî es mas honesto.' El bioestadistico discrepa: 'Trim-and-fill sobrecorrige. No sabemos si es sesgo de publicacion.'",
              question: "¬øDe que lado te pones?",
              branches: [
                { id: 'support_trimfill', text: "Apoyar al coautor ‚Äî la estimacion ajustada es mas honesta", nextNode: 'trimfill_problems' },
                { id: 'support_stats', text: "Apoyar al bioestadistico ‚Äî la estimacion original es valida", nextNode: 'original_defense' },
                { id: 'both_wrong', text: "Ambos tienen razon parcialmente ‚Äî reportar ambas estimaciones", nextNode: 'balanced_approach' }
              ]
            },
            trimfill_problems: {
              id: 'trimfill_problems',
              situation: "Reportas el RR ajustado 0.89 como tu hallazgo principal. Revisor 2 pregunta: 'Trim-and-fill asume que asimetria equivale a sesgo de publicacion. ¬øQue pasa si la asimetria se debe a heterogeneidad verdadera ‚Äî estudios pequenos enrolando pacientes de mayor riesgo?'",
              question: "¬øComo verificas esto?",
              branches: [
                { id: 'check_contour', text: "Usar funnel plot con contorno mejorado", nextNode: 'contour_analysis' },
                { id: 'check_characteristics', text: "Comparar caracteristicas de pacientes entre tamanos de estudio", nextNode: 'characteristic_check' },
                { id: 'admit_limitation', text: "Reconocer que no podemos distinguir las causas", nextNode: 'honest_limitation' }
              ]
            },
            contour_analysis: {
              id: 'contour_analysis',
              situation: "Tu funnel con contorno mejorado muestra: los estudios 'faltantes' caerian en la zona no significativa (area blanca). Los estudios en la zona significativa (sombreada) estan todos publicados. Este patron sugiere sesgo de publicacion, no heterogeneidad.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: Los funnels con contorno mejorado distinguen sesgo de heterogeneidad. Si los estudios faltantes se agrupan en areas no significativas, el sesgo de publicacion es probable. Si abarcan zonas de significancia, otras explicaciones (heterogeneidad, calidad del estudio) son posibles."
            },
            characteristic_check: {
              id: 'characteristic_check',
              situation: "Verificas: los estudios positivos pequenos tienen caracteristicas basales similares a los estudios neutrales grandes. Sin diferencia sistematica en riesgo del paciente. La asimetria no se explica por mezcla de casos ‚Äî el sesgo de publicacion sigue siendo la explicacion probable.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: Multiples lineas de evidencia convergen en sesgo de publicacion: (1) asimetria del funnel, (2) prueba de Egger, (3) estudios faltantes en zona no significativa, (4) sin explicacion por mezcla de casos. Aun no se puede probar, pero la evidencia se acumula."
            },
            honest_limitation: {
              id: 'honest_limitation',
              situation: "Escribes: 'La asimetria del funnel y la prueba de Egger sugieren potencial sesgo de publicacion. Trim-and-fill ajusta para esto (RR 0.89), pero el ajuste asume que toda la asimetria es sesgo. El efecto verdadero probablemente esta entre 0.72 y 0.89.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PREGUNTA: Cuando no puedes distinguir las causas, encuadra la incertidumbre. 'Efecto entre 0.72-0.89' es menos preciso pero mas honesto que elegir una estimacion. Los lectores pueden juzgar basandose en sus creencias previas sobre el sesgo de publicacion."
            },
            original_defense: {
              id: 'original_defense',
              situation: "Reportas solo RR 0.72. El editor de la revista responde: 'Tu funnel es claramente asimetrico. Las guias ICMJE requieren abordar el sesgo de publicacion. No puedes omitir este analisis.'",
              question: "Que haces?",
              branches: [
                { id: 'add_analysis', text: "Agregar trim-and-fill como analisis de sensibilidad", nextNode: 'proper_reporting' },
                { id: 'argue_editor', text: "Argumentar que la prueba de Egger tiene alta tasa de falsos positivos", nextNode: 'editor_pushback' }
              ]
            },
            proper_reporting: {
              id: 'proper_reporting',
              situation: "Tu manuscrito revisado: 'Analisis primario: RR 0.72 (0.58-0.89). La asimetria del funnel (Egger p=0.02) genera preocupacion por sesgo de publicacion. Analisis de sensibilidad con trim-and-fill: RR 0.89 (0.72-1.10).' Los revisores estan satisfechos.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REPETICION: El analisis de antidepresivos de Turner mostro lo que sucede cuando solo ves datos publicados. Al reportar ambas estimaciones, permites que los lectores vean la incertidumbre. La verdad probablemente esta en algun punto intermedio."
            },
            editor_pushback: {
              id: 'editor_pushback',
              situation: "El editor responde: 'Si, la prueba de Egger tiene limitaciones. Pero tu asimetria es visible y estadisticamente significativa. No reportarla es reporte selectivo en si mismo. O abordas el sesgo de publicacion o no podemos proceder.'",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: Ocultar evidencia de sesgo de publicacion es en si una forma de sesgo. CONSORT y PRISMA requieren funnel plots y evaluacion. La transparencia sobre la incertidumbre no es opcional en las revisiones sistematicas modernas."
            },
            balanced_approach: {
              id: 'balanced_approach',
              situation: "Propones reportar ambos: original como primario (siguiendo el protocolo), trim-and-fill como sensibilidad. Pero tambien haces algo que los demas no sugirieron: verificar los registros de ensayos.",
              question: "Que muestra la comparacion de registros?",
              branches: [
                { id: 'registry_confirms', text: "15 ensayos publicados, pero 23 registrados ‚Äî 8 faltantes", nextNode: 'definitive_bias' },
                { id: 'registry_matches', text: "15 publicados, 15 registrados ‚Äî ningun ensayo faltante", nextNode: 'not_pub_bias' },
                { id: 'registry_unavailable', text: "La mayoria de ensayos son anteriores a requisitos de registro", nextNode: 'uncertain_outcome' }
              ]
            },
            definitive_bias: {
              id: 'definitive_bias',
              situation: "Encuentras 8 ensayos registrados pero no publicados. Contactas a los investigadores. Tres proporcionan datos: todos negativos (RR 0.95-1.10). Agregandolos: el RR combinado se convierte en 0.85 (IC 95% 0.70-1.03). La estimacion original estaba inflada por sesgo de publicacion.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION: Este es el estandar de oro ‚Äî comparar registrados vs publicados. Turner hizo esto para antidepresivos. Tu lo hiciste para tu farmaco. El registro prueba lo que el funnel solo sugeria. Esta es evidencia definitiva de sesgo."
            },
            not_pub_bias: {
              id: 'not_pub_bias',
              situation: "Los 15 ensayos registrados estan publicados. No hay estudios faltantes. La asimetria debe deberse a otra cosa ‚Äî probablemente efectos de estudio pequeno (pacientes de mayor riesgo enrolados, atencion mas variable) en lugar de ensayos negativos suprimidos.",
              question: "Como cambia esto tu interpretacion?",
              branches: [
                { id: 'revise_conclusion', text: "Reportar estimacion original ‚Äî la asimetria no es sesgo de publicacion", nextNode: 'legitimate_small_study' },
                { id: 'still_cautious', text: "Aun reportar trim-and-fill ‚Äî la asimetria es preocupante de todas formas", nextNode: 'overcautious' }
              ]
            },
            legitimate_small_study: {
              id: 'legitimate_small_study',
              situation: "Escribes: 'La asimetria del funnel (Egger p=0.02) podria sugerir sesgo de publicacion, pero la comparacion de registros muestra que todos los ensayos registrados estan publicados. La asimetria probablemente refleja efectos de estudio pequeno (efectos de tratamiento diferenciales en pacientes de alto riesgo en ensayos mas pequenos).'",
              isEnding: true,
              outcome: 'good',
              lesson: "EL GANCHO: No toda asimetria es sesgo de publicacion. Los estudios pequenos a menudo enrolan pacientes mas enfermos que se benefician mas. La comparacion de registros es la prueba definitiva. Sin ella, los funnel plots son sugestivos pero no concluyentes."
            },
            overcautious: {
              id: 'overcautious',
              situation: "Reportas la estimacion ajustada por trim-and-fill a pesar de la evidencia contra sesgo de publicacion. Un metaanalisis competidor reporta la estimacion original con justificacion de registro apropiada. Su resultado se cita como mas preciso. El tuyo parece demasiado cauteloso.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA ADVERTENCIA: Ser demasiado conservador tambien puede ser incorrecto. Si la comparacion de registros exonera el sesgo de publicacion, la 'correccion' trim-and-fill introduce error. Ajusta tu ajuste a la evidencia."
            },
            uncertain_outcome: {
              id: 'uncertain_outcome',
              situation: "La mayoria de ensayos son de 1998-2005, antes de que el registro fuera requerido. No puedes determinar si ensayos negativos fueron conducidos pero no publicados. La evidencia del registro esta incompleta.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REVELACION GRADUAL: Esta es la realidad historica para muchas preguntas. Los ensayos pre-2005 a menudo carecen de registro. Reporta la asimetria del funnel, la prueba de Egger y trim-and-fill. Reconoce que no puedes determinar la causa. Deja que los lectores juzguen."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Tu funnel plot de 8 estudios muestra asimetria con estudios pequenos positivos faltantes. Prueba de Egger p=0.08. Que puedes concluir?",
          options: [
            { id: 'a', text: "No hay sesgo de publicacion ya que la prueba de Egger no es significativa", correct: false },
            { id: 'b', text: "Sesgo de publicacion presente ya que el funnel es asimetrico", correct: false },
            { id: 'c', text: "Poder insuficiente para detectar sesgo ‚Äî la asimetria visual es sugestiva pero no concluyente", correct: true },
            { id: 'd', text: "Necesitas realizar trim-and-fill para determinar si existe sesgo", correct: false }
          ],
          explanation: "Con solo 8 estudios, la prueba de Egger tiene muy bajo poder (<50% incluso con sesgo sustancial). La asimetria visual es sugestiva pero podria ser azar. La conclusion apropiada es incertidumbre ‚Äî reporta la observacion pero reconoce que no puedes confirmar la causa."
        }
      }
    ]
  },
  // Modulo 11: La Certeza (GRADE)
  {
    id: 11,
    title: "La Certeza",
    subtitle: "Marco GRADE",
    principle: 6,
    story: "SPRINT",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La certeza debe estar justificada"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA PARADOJA: SPRINT vs ACCORD ‚Äî EL MISMO TRATAMIENTO, RESPUESTAS OPUESTAS",
          source: "NEJM 2015; 373:2103-2116 (SPRINT) | NEJM 2010; 362:1575-1585 (ACCORD BP)",
          timeline: [
            { year: "2003-2009", text: "ACCORD BP aleatoriza 4,733 diabeticos a control intensivo (<120) vs estandar (<140) de PA. La comunidad de diabetes espera orientacion.", type: "normal" },
            { year: "Mar 2010", text: "Resultados de ACCORD BP: Compuesto primario HR 0.88 (0.73-1.06). NO significativo. Eventos adversos graves AUMENTARON. El control intensivo no ayuda a diabeticos.", type: "crisis" },
            { year: "2010-2015", text: "SPRINT excluye diabeticos (citando ACCORD), enrola 9,361 no diabeticos. Mismo objetivo intensivo (<120). Poblacion diferente.", type: "normal" },
            { year: "Ago 2015", text: "SPRINT detenido TEMPRANO por beneficio. Compuesto CV HR 0.75 (0.64-0.89). Mortalidad total HR 0.73 (0.60-0.90). Titulares: 'Revolucion de PA!'", type: "revelation" },
            { year: "La Paradoja", text: "Mismo tratamiento: control intensivo de PA. SPRINT (no diabeticos): 25% beneficio. ACCORD (diabeticos): sin beneficio, mas dano. La verdad depende de A QUIEN tratas.", type: "revelation" },
            { year: "La Advertencia", text: "Los hospitales aplicaron objetivos SPRINT a TODOS los pacientes incluyendo diabeticos. Pero los diabeticos tenian evidencia ACCORD ‚Äî mostrando sin beneficio. La indirectividad no es abstracta. Es vida o muerte.", type: "crisis" }
          ],
          realData: {
            endpoint: "Compuesto CV primario",
            drug: "SPRINT (no diabeticos): HR 0.75 (0.64-0.89)",
            placebo: "ACCORD BP (diabeticos): HR 0.88 (0.73-1.06)",
            rr: "Misma intervencion, resultados opuestos",
            ci: "SPRINT: beneficio significativo | ACCORD: nulo",
            nnh: "El contexto es todo"
          },
          hook: "LA PREGUNTA: Un paciente diabetico pregunta sobre control intensivo de PA. Citas SPRINT. Pero SPRINT excluyo diabeticos DEBIDO a ACCORD. Has aplicado evidencia a la poblacion exacta que fue disenada para evitar. Esto es indirectividad ‚Äî y GRADE existe para detectarla."
        }
      },
      {
        type: 'content',
        content: {
          title: "GRADE: Calificando la Certeza de la Evidencia",
          sections: [
            {
              heading: "Punto de Partida:",
              items: [
                "Los ECAs comienzan en certeza ALTA",
                "Los estudios observacionales comienzan en certeza BAJA"
              ]
            },
            {
              heading: "Cinco Razones para Bajar la Calificacion:",
              items: [
                "1. Riesgo de sesgo (falta de cegamiento, desercion, etc.)",
                "2. Inconsistencia (heterogeneidad sin explicacion)",
                "3. Indirectividad (P, I, C u O diferente de tu pregunta)",
                "4. Imprecision (IC amplio, muestra pequena, pocos eventos)",
                "5. Sesgo de publicacion (estudios faltantes)"
              ]
            },
            {
              heading: "Tres Razones para Subir (para observacionales):",
              items: [
                "1. Efecto grande (RR >2 o <0.5)",
                "2. Gradiente dosis-respuesta",
                "3. Todos los confusores plausibles reducirian el efecto"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: HACIENDO JUICIOS GRADE",
          title: "De la Evidencia a la Certeza",
          sections: [
            {
              heading: "Riesgo de Sesgo",
              text: "Baja la calificacion si la mayoria de la evidencia es de estudios con alto RdS. Considera que dominios importan mas para este desenlace (el cegamiento es crucial para desenlaces subjetivos, menos para mortalidad)."
            },
            {
              heading: "Indirectividad",
              text: "Baja la calificacion si: la poblacion difiere de tu objetivo, la intervencion difiere (dosis, duracion, formulacion), el comparador no es relevante, los desenlaces son subrogados. Las exclusiones de SPRINT crean indirectividad para diabeticos."
            },
            {
              heading: "Imprecision",
              text: "Baja la calificacion si: el IC 95% incluye tanto beneficio apreciable como dano, o incluye sin efecto y beneficio/dano apreciable. Considera umbrales de decision clinica, no solo significancia estadistica."
            },
            {
              heading: "Niveles Finales de Certeza",
              text: "ALTA: muy confiado en la estimacion\nMODERADA: moderadamente confiado, el efecto verdadero probablemente cercano\nBAJA: confianza limitada, el efecto verdadero puede diferir sustancialmente\nMUY BAJA: muy poca confianza, el efecto verdadero probablemente sustancialmente diferente"
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'grade-builder',
          title: "Constructor de Evaluacion GRADE",
          description: "Construye tablas de Resumen de Hallazgos con calificaciones de certeza GRADE"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'grade_decision_tree',
          title: "El Paciente Diabetico",
          scenario: "Tu hospital adopta control intensivo de PA basado en SPRINT (<120 sistolica) para todos los pacientes. Una colega pregunta sobre su paciente diabetico de 68 anos con ERC etapa 3. SPRINT excluyo diabeticos y uso medicion automatica de PA que tu no tienes.",
          realCase: "SPRINT fue un ensayo historico. Pero ACCORD BP (que INCLUYO diabeticos) encontro que el control intensivo de PA NO redujo eventos CV y AUMENTO eventos adversos. Misma intervencion, poblacion diferente, conclusion opuesta.",
          nodes: {
            start: {
              id: 'start',
              situation: "El oficial de calidad del hospital dice: 'SPRINT mostro 25% de reduccion en eventos CV con control intensivo. Este paciente diabetico deberia obtener el mismo beneficio.' Tu colega es esceptica.",
              question: "Como evaluas la aplicabilidad de SPRINT?",
              branches: [
                { id: 'apply_sprint', text: "SPRINT es la mejor evidencia ‚Äî aplicarla a todos los hipertensos", nextNode: 'application_problem' },
                { id: 'check_exclusions', text: "Primero verificar: fue este tipo de paciente excluido de SPRINT?", nextNode: 'exclusion_discovery' },
                { id: 'find_direct_evidence', text: "Buscar ensayos que INCLUYERON diabeticos", nextNode: 'accord_discovery' }
              ]
            },
            application_problem: {
              id: 'application_problem',
              situation: "Aplicas control intensivo. Seis meses despues: el paciente tiene episodios hipotensivos, caidas, y desarrolla lesion renal aguda requiriendo hospitalizacion. Te preguntas: 'Predijo SPRINT esto?'",
              question: "Revisas los criterios de exclusion de SPRINT. Que encuentras?",
              branches: [
                { id: 'discover_exclusions', text: "SPRINT excluyo diabeticos, ictus previo, TFGe <20", nextNode: 'late_realization' },
                { id: 'check_accord', text: "Encuentras que ACCORD BP estudio diabeticos especificamente", nextNode: 'accord_contrast' }
              ]
            },
            late_realization: {
              id: 'late_realization',
              situation: "Te das cuenta: SPRINT excluyo exactamente a los pacientes como el tuyo. Los criterios de exclusion no eran arbitrarios ‚Äî los investigadores sospechaban que estos pacientes podrian responder diferente. Tenian razon.",
              isEnding: true,
              outcome: 'bad',
              lesson: "LA CONSECUENCIA: Los criterios de exclusion en ensayos son a menudo senales. SPRINT excluyo diabeticos porque ACCORD BP ya habia mostrado que el control intensivo de PA no les ayudaba. Aplicar SPRINT a poblaciones excluidas ignora contexto crucial."
            },
            accord_contrast: {
              id: 'accord_contrast',
              situation: "ACCORD BP (4,733 diabeticos): control intensivo vs estandar de PA. Compuesto primario: HR 0.88 (IC 95% 0.73-1.06), NO significativo. Eventos adversos graves: significativamente mayores con control intensivo. Lo opuesto de SPRINT.",
              isEnding: true,
              outcome: 'bad',
              lesson: "EL GANCHO: Misma intervencion (control intensivo de PA), poblacion diferente (diabeticos vs no diabeticos), conclusion opuesta. Por esto importa la indirectividad en GRADE. Los pacientes diabeticos necesitaban evidencia especifica para diabeticos."
            },
            exclusion_discovery: {
              id: 'exclusion_discovery',
              situation: "Verificas los criterios de elegibilidad de SPRINT. Exclusiones mayores: (1) Diabetes, (2) Ictus previo, (3) Insuficiencia cardiaca sintomatica, (4) TFGe <20. El paciente de tu colega cumple el criterio de exclusion #1.",
              question: "Como afecta esto tu calificacion de certeza GRADE?",
              branches: [
                { id: 'moderate_rating', text: "MODERADA ‚Äî un criterio de exclusion, aun razonablemente aplicable", nextNode: 'moderate_insufficient' },
                { id: 'low_rating', text: "BAJA ‚Äî los diabeticos fueron especificamente excluidos, indirectividad seria", nextNode: 'proper_grade' },
                { id: 'check_why', text: "Antes de calificar, preguntar: POR QUE fueron excluidos los diabeticos?", nextNode: 'exclusion_reason' }
              ]
            },
            moderate_insufficient: {
              id: 'moderate_insufficient',
              situation: "Calificas MODERADA y recomiendas control intensivo. Un colega cardiologo senala: 'ACCORD BP estudio exactamente esta poblacion y no encontro beneficio. Tu evaluacion GRADE deberia considerar esa evidencia DIRECTA, no solo la evidencia INDIRECTA de SPRINT.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA REPETICION: La indirectividad GRADE no es solo sobre distancia de tu pregunta ‚Äî es sobre si existe MEJOR evidencia. Para diabeticos, ACCORD BP es evidencia directa. SPRINT es indirecta. La evidencia directa supera a la indirecta."
            },
            proper_grade: {
              id: 'proper_grade',
              situation: "Calificas certeza BAJA para aplicar SPRINT a diabeticos. Tu justificacion GRADE: 'Indirectividad seria ‚Äî diabeticos explicitamente excluidos. ACCORD BP (evidencia directa para diabeticos) no encontro beneficio. No se puede extrapolar SPRINT a esta poblacion.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: La indirectividad GRADE te obliga a preguntar: es esta evidencia realmente sobre MI paciente? Cuando los criterios de exclusion coinciden con tu paciente, la respuesta es 'no.' Encuentra evidencia directa o baja sustancialmente."
            },
            exclusion_reason: {
              id: 'exclusion_reason',
              situation: "Investigas: SPRINT excluyo diabeticos PORQUE evidencia previa (ACCORD BP) ya habia mostrado que el control intensivo de PA no les beneficiaba. La exclusion no era arbitraria ‚Äî estaba basada en evidencia.",
              question: "Que te dice esto sobre aplicar SPRINT a diabeticos?",
              branches: [
                { id: 'cannot_extrapolate', text: "SPRINT no puede extrapolarse ‚Äî hay evidencia contraria directa", nextNode: 'correct_understanding' },
                { id: 'sprint_better', text: "Quizas el enfoque de SPRINT fue mejor que el de ACCORD", nextNode: 'protocol_differences' }
              ]
            },
            correct_understanding: {
              id: 'correct_understanding',
              situation: "Explicas al oficial de calidad: 'No podemos aplicar SPRINT a diabeticos. Fueron excluidos porque ACCORD no mostro beneficio en diabeticos. Aplicar protocolos SPRINT a poblaciones excluidas contradice la propia logica de diseno del ensayo.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: Los criterios de exclusion a menudo codifican evidencia previa. Entender POR QUE una poblacion fue excluida revela lo que ya sabemos sobre ellos. SPRINT no estudio diabeticos porque ya sabiamos la respuesta."
            },
            protocol_differences: {
              id: 'protocol_differences',
              situation: "Comparas: SPRINT uso medicion automatica de PA (tipicamente 5-10 mmHg menor que lecturas clinicas). ACCORD uso mediciones clinicas estandar. Un objetivo de '120' en SPRINT es como '125-130' en clinicas reales. Pero incluso considerando esto, ACCORD no mostro beneficio.",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA ADVERTENCIA: Las diferencias de protocolo importan. El 120 de SPRINT no es lo mismo que el 120 de tu clinica. Pero el problema mayor: ACCORD abordo diabeticos directamente. Los detalles metodologicos no pueden hacer que la poblacion excluida de SPRINT de repente este incluida."
            },
            accord_discovery: {
              id: 'accord_discovery',
              situation: "Buscas 'control intensivo presion arterial diabetes ECA' y encuentras ACCORD BP. 4,733 diabeticos tipo 2. Intensivo (<120) vs estandar (<140). Compuesto primario: HR 0.88 (0.73-1.06). Ictus: HR 0.59 (0.39-0.89). Eventos adversos: significativamente mayores.",
              question: "Como interpretas ACCORD BP?",
              branches: [
                { id: 'no_benefit', text: "Desenlace primario negativo ‚Äî el control intensivo no ayuda a diabeticos", nextNode: 'nuanced_interpretation' },
                { id: 'stroke_benefit', text: "El ictus se redujo ‚Äî existe algun beneficio", nextNode: 'outcome_tradeoff' },
                { id: 'both_results', text: "Reportar ambos ‚Äî primario negativo, ictus positivo, danos aumentados", nextNode: 'complete_picture' }
              ]
            },
            nuanced_interpretation: {
              id: 'nuanced_interpretation',
              situation: "Reportas: 'ACCORD BP, la evidencia directa para diabeticos, encontro que el control intensivo de PA no redujo el compuesto CV primario. Aplicar objetivos SPRINT a diabeticos no esta respaldado por evidencia directa.'",
              isEnding: true,
              outcome: 'good',
              lesson: "LA PROTECCION: El desenlace primario es para lo que el ensayo fue disenado y tiene poder para detectar. Los desenlaces secundarios generan hipotesis. Un desenlace primario negativo es el mensaje principal, incluso si los secundarios muestran senales."
            },
            outcome_tradeoff: {
              id: 'outcome_tradeoff',
              situation: "Enfatizas la reduccion de ictus (HR 0.59). Pero el oficial de calidad nota: 'El desenlace primario fue negativo. Los eventos adversos graves fueron mayores. Estas seleccionando un desenlace secundario mientras ignoras los danos.'",
              isEnding: true,
              outcome: 'neutral',
              lesson: "LA PREGUNTA: Cuando los desenlaces primarios son negativos pero los secundarios positivos, resiste la tentacion de enfocarte en hallazgos positivos. GRADE requiere evaluar todo el perfil de evidencia, incluyendo danos. El balance importa."
            },
            complete_picture: {
              id: 'complete_picture',
              situation: "Tu evaluacion: 'Para diabeticos, control intensivo de PA: compuesto CV HR 0.88 (0.73-1.06, no significativo), ictus HR 0.59 (0.39-0.89, significativo), eventos adversos graves significativamente mayores. Balance incierto. SPRINT no aplica ‚Äî ACCORD es la evidencia directa.'",
              question: "Tu colega pregunta: 'Entonces que hago con mi paciente?'",
              branches: [
                { id: 'standard_target', text: "El objetivo estandar (<140) esta respaldado ‚Äî menos agresivo", nextNode: 'clinical_recommendation' },
                { id: 'shared_decision', text: "Discutir compensaciones ‚Äî algunos pacientes podrian aceptar riesgos por beneficio en ictus", nextNode: 'individualized_care' }
              ]
            },
            clinical_recommendation: {
              id: 'clinical_recommendation',
              situation: "Recomiendas objetivo estandar de PA (<140) basado en ACCORD. El paciente logra 138/85 sin efectos adversos. Dos anos despues: sin eventos CV, sin caidas, funcion renal estable. El objetivo apropiado segun evidencia funciono.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION: La certeza GRADE no es academica ‚Äî guia decisiones reales. Certeza BAJA para SPRINT‚Üídiabeticos significo: no aplicar protocolos SPRINT. La evidencia directa de ACCORD respaldo un enfoque diferente. El paciente se beneficio de la evaluacion correcta de evidencia."
            },
            individualized_care: {
              id: 'individualized_care',
              situation: "Discutes con el paciente: 'El control agresivo de PA podria reducir el riesgo de ictus pero aumenta otros riesgos. Dadas tus prioridades...' El paciente, habiendo tenido un familiar con ictus, elige control moderadamente intensivo (125-130) con monitoreo cercano.",
              isEnding: true,
              outcome: 'good',
              lesson: "LA REVELACION GRADUAL: Cuando la evidencia es incierta (certeza BAJA), las preferencias del paciente importan mas. GRADE no te dice que hacer ‚Äî te dice que tan confiado estar. La incertidumbre crea espacio para la toma de decisiones compartida."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Estas calificando certeza GRADE para un metaanalisis de 8 ECAs (n=12,000) que muestra que el Farmaco X reduce mortalidad (RR 0.85, IC 95% 0.78-0.93). I¬≤ = 0%, sin sesgo de publicacion detectado, bajo riesgo de sesgo. Que certeza?",
          options: [
            { id: 'a', text: "ALTA ‚Äî ECAs sin preocupaciones en todos los dominios", correct: true },
            { id: 'b', text: "MODERADA ‚Äî deberia bajar por imprecision dado el ancho del IC", correct: false },
            { id: 'c', text: "MODERADA ‚Äî deberia bajar por potencial confusion residual", correct: false },
            { id: 'd', text: "BAJA ‚Äî la mortalidad es un desenlace muy dificil para estar seguro", correct: false }
          ],
          explanation: "Esto cumple criterios para certeza ALTA: ECAs (comienzan alto), bajo RdS, sin inconsistencia (I¬≤=0%), sin indirectividad mencionada, estimacion precisa (IC excluye tanto 1.0 como efectos grandes), sin sesgo de publicacion. Cada dominio es satisfactorio, asi que no hay reduccion."
        }
      }
    ]
  },
  // Modulo 12: El Reporte
  {
    id: 12,
    title: "El Reporte",
    subtitle: "PRISMA 2020",
    principle: 6,
    story: "Reproducibility",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La certeza debe estar justificada"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA CRISIS: LA AUDITORIA DE GLASZIOU ‚Äî SISTEMATICAS SOLO DE NOMBRE",
          source: "BMC Medicine 2014; 12:37 | Glasziou et al | PubMed: 24571522",
          timeline: [
            { year: "2000s", text: "Las revisiones sistematicas se convierten en el 'estandar de oro' de la evidencia. Cochrane produce miles. Las guias las exigen. La MBE descansa en sus cimientos.", type: "normal" },
            { year: "2014", text: "Glasziou reune un equipo para replicar 18 revisiones sistematicas influyentes. Tienen los articulos. Siguen las secciones de metodos. Intentan reproducir los resultados.", type: "normal" },
            { year: "El Intento", text: "Los miembros del equipo siguen los metodos declarados de cada revision exactamente. Ejecutan las busquedas. Aplican los criterios. Extraen los datos. Combinan las estimaciones.", type: "normal" },
            { year: "El Fracaso", text: "Completamente reproducibles: 2 de 18 (11%). Parcialmente reproducibles: 5 de 18 (28%). NO reproducibles: 11 de 18 (61%). Los cimientos se desmoronan.", type: "crisis" },
            { year: "Las Causas", text: "Estrategias de busqueda incompletas o faltantes. Criterios de elegibilidad ambiguos. Extraccion de datos indefinida. Metodos estadisticos poco claros. 'Sistematica' era una etiqueta, no una practica.", type: "crisis" },
            { year: "La Consecuencia", text: "Si no podemos reproducir una revision, no podemos verificarla. Si no podemos verificarla, no podemos confiar en ella. 61% de la evidencia 'estandar de oro' era inverificable.", type: "revelation" }
          ],
          realData: {
            endpoint: "Reproducibilidad de revisiones sistematicas",
            drug: "18 revisiones influyentes evaluadas",
            placebo: "Intento de replicacion completa",
            rr: "Completamente reproducibles: 11% (2/18)",
            ci: "Parcialmente: 28% | Fallaron: 61%",
            nnh: "La mayoria de revisiones 'sistematicas' no pueden verificarse"
          },
          hook: "LA REPETICION: Cada principio que hemos ensenado ‚Äî preespecificacion, busqueda exhaustiva, extraccion transparente, sintesis clara ‚Äî existe porque sin ellos, nadie puede verificar tu trabajo. Y el trabajo que no puede verificarse no puede ser confiable. PRISMA 2020 no es burocracia. Es responsabilidad."
        }
      },
      {
        type: 'content',
        content: {
          title: "EL DANO: Cuando las Revisiones Irreproducibles Mataron",
          sections: [
            {
              heading: "La Catastrofe de Betabloqueadores Cochrane (2014)",
              items: [
                "Revision Cochrane de betabloqueadores perioperatorios: 'Reduce mortalidad' ‚Äî impulso guias mundialmente",
                "Basada principalmente en ensayos DECREASE de Poldermans (despues probado fraudulento)",
                "Cuando DECREASE fue removido: el beneficio DESAPARECIO, la tendencia hacia DANO permanecio",
                "Cochrane tuvo que RETIRAR la revision. Las guias habian recomendado dano por 12 anos.",
                "Cuantos pacientes quirurgicos murieron por datos fraudulentos amplificados por una revision 'sistematica'?"
              ]
            },
            {
              heading: "El Escandalo de Tamiflu (2009-2014)",
              items: [
                "Cochrane reviso oseltamivir (Tamiflu) para influenza. Los gobiernos almacenaron $9 mil millones.",
                "La revision original dependio de resumenes del fabricante ‚Äî no reportes completos de ensayos",
                "Cuando Cochrane exigio Reportes de Estudios Clinicos completos: Roche demoro 4 ANOS",
                "Veredicto final: Tamiflu redujo sintomas por 17 horas. NO redujo hospitalizaciones.",
                "$9 mil millones gastados en un farmaco cuyos beneficios fueron exagerados por reporte incompleto"
              ]
            },
            {
              heading: "EL PATRON: La Irreproducibilidad Permite el Dano",
              items: [
                "Si la revision de betabloqueadores hubiera requerido datos completos de ensayos, el fraude DECREASE se habria detectado",
                "Si la revision de Tamiflu hubiera requerido Reportes de Estudios Clinicos desde el inicio, la exageracion habria sido visible",
                "Metodos irreproducibles ‚Üí sesgo indetectable ‚Üí guias basadas en espejismos ‚Üí dano al paciente",
                "PRISMA existe porque los metodos vagos permiten que el fraude y el sesgo se escondan a plena vista"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "PRISMA 2020: La Lista de Verificacion de 27 Items",
          sections: [
            {
              heading: "Titulo y Resumen (Items 1-2)",
              items: [
                "Identificar como revision sistematica/metaanalisis en el titulo",
                "Resumen estructurado con toda la informacion clave"
              ]
            },
            {
              heading: "Metodos (Items 3-15)",
              items: [
                "Registro y acceso al protocolo",
                "Criterios de elegibilidad para estudios",
                "Fuentes de informacion y fechas",
                "Estrategia de busqueda completa (al menos una base de datos)",
                "Procesos de seleccion, extraccion y RdS",
                "Medidas de efecto y metodos de sintesis"
              ]
            },
            {
              heading: "Resultados (Items 16-23)",
              items: [
                "Diagrama de flujo de seleccion de estudios",
                "Caracteristicas de estudios incluidos",
                "Riesgo de sesgo dentro y entre estudios",
                "Resultados de sintesis e investigaciones de heterogeneidad"
              ]
            },
            {
              heading: "Discusion y Otros (Items 24-27)",
              items: [
                "Interpretacion en contexto de otra evidencia",
                "Limitaciones a nivel de estudio y revision",
                "Financiamiento y conflictos de interes"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "EL METODO: REPORTE TRANSPARENTE",
          title: "Haciendo tu Revision Reproducible",
          sections: [
            {
              heading: "Reporte de Estrategia de Busqueda",
              text: "Proporciona cadenas de busqueda completas para TODAS las bases de datos. Incluye fecha de busqueda. Reporta cualquier limite aplicado (idioma, fecha, tipo de publicacion). Pon estrategias completas en suplemento si son muy largas."
            },
            {
              heading: "Flujo de Estudios",
              text: "Diagrama de flujo PRISMA mostrando: registros identificados, duplicados removidos, tamizados, evaluados para elegibilidad, incluidos. Para exclusiones en etapa de texto completo, proporciona razones para cada uno."
            },
            {
              heading: "Transparencia de Datos",
              text: "Incluye forest plots para todos los desenlaces. Proporciona datos de estudios individuales en tablas o suplemento. Comparte formularios de extraccion, juicios de RdS con justificaciones, y codigo de analisis si es posible."
            },
            {
              heading: "Revisiones Vivas",
              text: "Considera si tu revision deberia actualizarse periodicamente (revision viva) o es una instantanea unica. Indica la frecuencia de actualizacion prevista y los disparadores."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'prisma-checklist',
          title: "Generador de Lista PRISMA",
          description: "Genera una lista de verificacion PRISMA 2020 completada para tu revision"
        }
      },
      {
        type: 'scenario',
        content: {
          id: 'report_scenario',
          title: "El Limite de Palabras",
          situation: "Tu revista tiene un limite de 3,500 palabras. Tu estrategia de busqueda completa es de 800 palabras. Tus juicios detallados de RdS son 600 palabras. El cumplimiento completo de PRISMA excederia el limite en 40%. El editor dice 'haz recortes.'",
          question: "Que recortas?",
          choices: [
            {
              id: 'a',
              text: "Abreviar estrategia de busqueda ‚Äî los lectores no replican busquedas realmente",
              consequence: 'bad',
              result: "La busqueda ES el metodo. Sin ella, nadie puede verificar que buscaste exhaustivamente. Pon la estrategia completa en un suplemento ‚Äî nunca la omitas."
            },
            {
              id: 'b',
              text: "Mover metodos detallados a suplemento, mantener resumen en texto principal",
              consequence: 'good',
              result: "Correcto! PRISMA permite materiales suplementarios. El texto principal resume; el suplemento contiene busqueda completa, juicios de RdS, lista de estudios excluidos, analisis de sensibilidad. Todo permanece disponible."
            },
            {
              id: 'c',
              text: "Recortar los metodos ‚Äî los lectores solo les importan los resultados y conclusiones",
              consequence: 'bad',
              result: "Sin metodos, los resultados son ininterpretables. Como sabrian los lectores si omitiste estudios, categorizaste mal el sesgo, o manipulaste subgrupos? Los metodos permiten la confianza."
            }
          ],
          correct: 'b',
          principle: 6
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Cual elemento es MAS esencial para replicar una revision sistematica?",
          options: [
            { id: 'a', text: "La estrategia de busqueda completa para al menos una base de datos", correct: true },
            { id: 'b', text: "Las calificaciones de certeza GRADE para cada desenlace", correct: false },
            { id: 'c', text: "Los forest plots mostrando estimaciones combinadas", correct: false },
            { id: 'd', text: "La discusion de limitaciones", correct: false }
          ],
          explanation: "La estrategia de busqueda es la base de la reproducibilidad. Sin saber exactamente que buscaste, como y cuando, nadie puede verificar tu identificacion de estudios. GRADE, forest plots y discusion son importantes pero dependen de la identificacion correcta de estudios primero."
        }
      }
    ]
  },
  // Modulo 13: El Proyecto Final
  {
    id: 13,
    title: "El Proyecto Final",
    subtitle: "Recorrido Completo",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "El Proyecto Final",
          subtitle: "Aplica Todo lo que Has Aprendido",
          text: "Ahora realizaras un mini metaanalisis desde la pregunta hasta la conclusion, usando las herramientas de todos los modulos anteriores."
        }
      },
      {
        type: 'content',
        content: {
          title: "Tu Asignacion",
          sections: [
            {
              heading: "La Pregunta:",
              items: [
                "Reduce la aspirina los eventos cardiovasculares en prevencion primaria?"
              ]
            },
            {
              heading: "Haras:",
              items: [
                "1. Formular PICO usando el Constructor PICO",
                "2. Desarrollar una estrategia de busqueda usando el Constructor de Busqueda",
                "3. Tamizar registros proporcionados usando la herramienta de Flujo PRISMA",
                "4. Extraer datos de 5 resumenes de ensayos proporcionados",
                "5. Evaluar riesgo de sesgo usando RoB 2",
                "6. Calcular tamanos de efecto",
                "7. Construir un forest plot (efectos fijos y aleatorios)",
                "8. Evaluar heterogeneidad e intervalos de prediccion",
                "9. Crear un funnel plot y evaluar sesgo de publicacion",
                "10. Calificar certeza usando GRADE",
                "11. Reportar hallazgos usando lista de verificacion PRISMA"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Conjunto de Datos: Ensayos de Aspirina en Prevencion Primaria",
          sections: [
            {
              heading: "Estudio 1: Estudio de Salud de los M√©dicos (1989)",
              items: [
                "N=22,071 medicos varones",
                "Aspirina 325mg cada dos dias vs placebo",
                "Eventos IM: 139/11,037 (1.26%) vs 239/11,034 (2.17%)",
                "RR = 0.58 (0.47-0.72)"
              ]
            },
            {
              heading: "Estudio 2: Estudio de Salud de la Mujer (2005)",
              items: [
                "N=39,876 profesionales de salud mujeres",
                "Aspirina 100mg cada dos dias vs placebo",
                "Eventos IM: 198/19,934 (0.99%) vs 193/19,942 (0.97%)",
                "RR = 1.02 (0.84-1.25)"
              ]
            },
            {
              heading: "Estudio 3: ASPREE (2018)",
              items: [
                "N=19,114 ancianos (>70)",
                "Aspirina 100mg diario vs placebo",
                "Eventos CV: 448/9,525 (4.7%) vs 474/9,589 (4.9%)",
                "RR = 0.95 (0.83-1.08)"
              ]
            },
            {
              heading: "Estudio 4: ARRIVE (2018)",
              items: [
                "N=12,546 riesgo CV moderado",
                "Aspirina 100mg diario vs placebo",
                "Eventos IM: 98/6,270 (1.56%) vs 108/6,276 (1.72%)",
                "RR = 0.91 (0.69-1.19)"
              ]
            },
            {
              heading: "Estudio 5: ASCEND (2018)",
              items: [
                "N=15,480 diabeticos",
                "Aspirina 100mg diario vs placebo",
                "Eventos vasculares graves: 658/7,740 (8.5%) vs 743/7,740 (9.6%)",
                "RR = 0.88 (0.79-0.97)"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Puntos de Verificacion del Proyecto Final",
          sections: [
            {
              heading: "‚úì PUNTO 1: Formulacion PICO",
              items: [
                "Usa la herramienta Constructor PICO",
                "VERIFICA: Tu desenlace es IMPORTANTE PARA EL PACIENTE (no un subrogado)",
                "AUTOEVALUACION: Aprobarian las victimas de CAST tu eleccion de desenlace?"
              ]
            },
            {
              heading: "‚úì PUNTO 2: Evaluacion de Riesgo de Sesgo",
              items: [
                "Usa la herramienta RoB 2 para LOS 5 estudios",
                "VERIFICA: Calificaste cada DESENLACE por separado (recuerda ORBITA)",
                "AUTOEVALUACION: Podria el desenmascaramiento afectar tu medicion del desenlace?"
              ]
            },
            {
              heading: "‚úì PUNTO 3: Forest Plot y Heterogeneidad",
              items: [
                "Usa el Constructor de Forest Plot ‚Äî prueba AMBOS efectos fijos y aleatorios",
                "Usa el Explorador de Heterogeneidad",
                "VERIFICA: Calculaste el INTERVALO DE PREDICCION (no solo el IC)",
                "AUTOEVALUACION: Tu IP cruza 1.0? Que significa eso para la practica clinica?"
              ]
            },
            {
              heading: "‚úì PUNTO 4: Evaluacion de Sesgo de Publicacion",
              items: [
                "Usa el Constructor de Funnel Plot",
                "VERIFICA: Ejecutaste la prueba de Egger y la interpretaste correctamente",
                "AUTOEVALUACION: Hay ensayos registrados que no estan publicados? (Recuerda el 94% vs 51% de Turner)"
              ]
            },
            {
              heading: "‚úì PUNTO 5: Calificacion de Certeza GRADE",
              items: [
                "Usa el Constructor GRADE",
                "VERIFICA: Consideraste INDIRECTIVIDAD (Recuerda SPRINT vs ACCORD-BP)",
                "VERIFICA: Bajaste apropiadamente por heterogeneidad si I¬≤>50%",
                "AUTOEVALUACION: Apostarias tu carrera en esta calificacion de certeza?"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Entregables del Proyecto Final",
          sections: [
            {
              heading: "Productos Requeridos (entregar los 5):",
              items: [
                "1. Tabla PICO con justificacion de jerarquia de desenlaces",
                "2. Tabla de semaforo RoB 2 para los 5 estudios",
                "3. Forest plot con AMBOS IC e intervalo de prediccion etiquetados",
                "4. Funnel plot con resultado de prueba de Egger anotado",
                "5. Tabla de Resumen de Hallazgos GRADE"
              ]
            },
            {
              heading: "Preguntas Clave a Responder:",
              items: [
                "Cual es el RR combinado? (reporta con IC 95% E intervalo de prediccion)",
                "Cual es I¬≤? Que significa para la aplicacion clinica?",
                "Hay evidencia de sesgo de publicacion? Como lo evaluaste?",
                "Cual es tu certeza GRADE? Justifica cada calificacion de dominio.",
                "Que recomiendas para la practica clinica? Para QUIEN?"
              ]
            },
            {
              heading: "Resumen de 250 Palabras",
              items: [
                "Antecedentes: Por que importa esta pregunta?",
                "Metodos: Como buscaste, seleccionaste, evaluaste sesgo, sintetizaste?",
                "Resultados: RR combinado, IC, IP, I¬≤, certeza GRADE",
                "Conclusion: Que deberian HACER los clinicos con esta evidencia?"
              ]
            }
          ]
        }
      },
      {
        type: 'principle',
        content: {
          text: "Los siete principios te guian. La pregunta da forma a la respuesta. La preespecificacion protege. La busqueda exhaustiva encuentra la verdad. Cada numero necesita verificacion. El sesgo se esconde a plena vista. El promedio puede mentir. La certeza debe estar justificada."
        }
      }
    ]
  },
  // Modulo 14: Evaluacion Final
  {
    id: 14,
    title: "Evaluacion Final",
    subtitle: "Pon a Prueba tu Conocimiento",
    principle: null,
    slides: [
      {
        type: 'title',
        content: {
          title: "Evaluacion Final",
          subtitle: "Examen Integral",
          text: "Esta evaluacion cubre todos los modulos. Necesitas 70% para aprobar. Toma tu tiempo ‚Äî no hay limite de tiempo."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL P1: El ensayo CAST encontro que los farmacos antiarritmicos que suprimian exitosamente las CVPs en realidad aumentaban la mortalidad. Esta reversion ocurrio porque los estudios originales usaron que desenlace problematico?",
          options: [
            { id: 'a', text: "Desenlace compuesto", correct: false },
            { id: 'b', text: "Desenlace subrogado (supresion de CVP en lugar de mortalidad)", correct: true },
            { id: 'c', text: "Desenlace autorreportado", correct: false },
            { id: 'd', text: "Desenlace de tiempo al evento", correct: false }
          ],
          explanation: "CAST ejemplifica la trampa del subrogado: la supresion de CVP (biomarcador) parecia un proxy razonable para mortalidad, pero los farmacos que mejor suprimian las CVP en realidad aumentaban la muerte. Principio 1: 'La pregunta da forma a la respuesta.'"
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL P2: Estas a mitad de un metaanalisis cuando notas una diferencia de subgrupo interesante que no esta en tu protocolo. Cual es la accion mas apropiada?",
          options: [
            { id: 'a', text: "Agregarla como analisis primario", correct: false },
            { id: 'b', text: "Reportarla como exploratoria, generadora de hipotesis, con advertencias apropiadas", correct: true },
            { id: 'c', text: "Ignorarla completamente", correct: false },
            { id: 'd', text: "Enmendar tu registro PROSPERO para incluirla como preespecificada", correct: false }
          ],
          explanation: "Los hallazgos post-hoc pueden reportarse pero deben etiquetarse claramente como exploratorios. Agregarlos al analisis primario es HARKing. Ignorarlos desperdicia informacion. Enmendar PROSPERO despues del analisis es enganoso."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL P3: Tu funnel plot muestra asimetria con estudios pequenos positivos faltantes. Prueba de Egger p=0.04. Cual afirmacion es mas precisa?",
          options: [
            { id: 'a', text: "Se confirma sesgo de publicacion ‚Äî usar estimacion ajustada por trim-and-fill", correct: false },
            { id: 'b', text: "Asimetria detectada ‚Äî podria ser sesgo de publicacion, efectos de estudio pequeno, o heterogeneidad. Comparar ensayos registrados vs publicados para evidencia mas fuerte", correct: true },
            { id: 'c', text: "Sin sesgo de publicacion ya que la asimetria del funnel tiene muchas causas", correct: false },
            { id: 'd', text: "Necesitas mas estudios para sacar cualquier conclusion", correct: false }
          ],
          explanation: "La asimetria del funnel es sugestiva pero no confirmatoria. El estandar de oro es comparar registros de ensayos con publicaciones. La prueba de Egger detecta asimetria, no su causa."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL P4: Un metaanalisis muestra RR 0.75 (IC 95% 0.65-0.87) con intervalo de prediccion 0.52-1.08. Que le dice esto a un clinico sobre aplicar este tratamiento?",
          options: [
            { id: 'a', text: "El tratamiento es efectivo ‚Äî el IC excluye 1.0", correct: false },
            { id: 'b', text: "El tratamiento no es efectivo ‚Äî el intervalo de prediccion cruza 1.0", correct: false },
            { id: 'c', text: "En promedio el tratamiento ayuda, pero en algunos entornos futuros podria no funcionar", correct: true },
            { id: 'd', text: "Los resultados son demasiado heterogeneos para interpretar", correct: false }
          ],
          explanation: "El IC nos dice que el efecto promedio es probablemente beneficioso. El intervalo de prediccion nos dice que un nuevo estudio (nuevo entorno) podria mostrar efectos desde 0.52 (gran beneficio) hasta 1.08 (ligero dano). Ambas piezas importan."
        }
      },
      {
        type: 'quiz',
        content: {
          question: "FINAL P5: Estas calificando certeza para la aplicabilidad de SPRINT a un paciente diabetico con ERC. SPRINT excluyo tanto diabeticos como ERC avanzada. Que dominio GRADE aplica?",
          options: [
            { id: 'a', text: "Riesgo de sesgo", correct: false },
            { id: 'b', text: "Inconsistencia", correct: false },
            { id: 'c', text: "Indirectividad", correct: true },
            { id: 'd', text: "Imprecision", correct: false }
          ],
          explanation: "La indirectividad aborda la pregunta: 'Esta evidencia aplica a MI poblacion/intervencion/comparacion/desenlace?' Cuando tu paciente fue excluido del ensayo, la evidencia es indirecta para el."
        }
      },
      {
        type: 'content',
        content: {
          title: "Felicidades!",
          sections: [
            {
              heading: "Has Completado el Curso de Metodos de Metaanalisis",
              items: [
                "‚úì Aprendiste a formular preguntas PICO que importan",
                "‚úì Comprendiste la importancia del prerregistro",
                "‚úì Dominaste la busqueda exhaustiva",
                "‚úì Practicaste tamizaje y extraccion sistematicos",
                "‚úì Aplicaste evaluacion de riesgo de sesgo",
                "‚úì Calculaste e interpretaste tamanos de efecto",
                "‚úì Construiste e interpretaste forest plots",
                "‚úì Exploraste heterogeneidad mas alla de I¬≤",
                "‚úì Detectaste y evaluaste sesgo de publicacion",
                "‚úì Aplicaste el marco de certeza GRADE",
                "‚úì Comprendiste los estandares de reporte PRISMA"
              ]
            },
            {
              heading: "Los Siete Principios",
              text: "Recuerda: La pregunta da forma a la respuesta. La preespecificacion es proteccion. Lo que no buscas, no encontraras. Cada numero necesita una fuente. El sesgo se esconde a plena vista. El promedio puede mentir. La certeza debe estar justificada."
            }
          ]
        }
      }
    ]
  }
];

// ============================================================
// STATE MANAGEMENT
// ============================================================

let currentModule = 0;
let currentSlide = 0;
let gameState = {
  points: 0,
  earnedBadges: [],
  toolsUsed: [],
  modulesCompleted: [],
  scenariosCompleted: {},
  decisionTrees: {},
  quizAnswers: {}
};

// ============================================================
// INITIALIZATION
// ============================================================

document.addEventListener('DOMContentLoaded', () => {
  loadProgress();
  renderModuleList();
  renderSlides();
  goToModule(0);
  updateLevelBadge();
  checkBadges();
});

function renderModuleList() {
  const list = document.getElementById('moduleList');
  list.innerHTML = modules.map(m => `
    <div class="module-item ${m.id === currentModule ? 'active' : ''} ${gameState.modulesCompleted.includes(m.id) ? 'completed' : ''}"
         data-module="${m.id}" onclick="goToModule(${m.id})"
         role="button" tabindex="0" ${m.id === currentModule ? 'aria-current="true"' : ''}
         aria-label="Module ${m.id}: ${m.title}${gameState.modulesCompleted.includes(m.id) ? ' (completed)' : ''}">
      <div class="module-number" aria-hidden="true">${m.id}</div>
      <div class="module-info">
        <div class="module-title">${m.title}</div>
        <div class="module-subtitle">${m.subtitle}</div>
      </div>
    </div>
  `).join('');
}

function renderSlides() {
  const container = document.getElementById('slideContainer');
  const module = modules[currentModule];

  container.innerHTML = module.slides.map((slide, idx) => {
    let content = '';

    switch(slide.type) {
      case 'title':
        content = `
          <h1 class="slide-title">${slide.content.title}</h1>
          <p style="text-align: center; font-size: 1.2rem; color: var(--gold); margin-bottom: 2rem;">${slide.content.subtitle}</p>
          <div class="slide-content">
            <p style="font-size: 1.1rem; line-height: 1.8; text-align: center;">${slide.content.text}</p>
          </div>
        `;
        break;

      case 'principle-display':
        content = `
          <div class="principle-display">
            <div class="principle-text">"${slide.content.principle}"</div>
          </div>
        `;
        break;

      case 'story':
        content = `
          <div class="story-box">
            <div class="story-label">${slide.content.label}</div>
            <div class="story-text">${slide.content.text}</div>
            <div class="story-hook">"${slide.content.hook}"</div>
          </div>
        `;
        break;

      case 'story-deep':
        content = `
          <div class="story-deep">
            <div class="story-label">${slide.content.label}</div>
            ${slide.content.source ? `<div class="real-data-source">üìö Source: ${slide.content.source}</div>` : ''}

            <div class="story-timeline">
              ${slide.content.timeline.map(event => `
                <div class="timeline-event ${event.type || ''}">
                  <div class="timeline-year">${event.year}</div>
                  <div class="timeline-text">${event.text}</div>
                </div>
              `).join('')}
            </div>

            ${slide.content.realData ? `
              <div class="real-data-card">
                <div class="real-data-header">
                  <strong>üìä Los Datos que Cambiaron Todo</strong>
                </div>
                <div class="real-data-stat">
                  <span class="label">Desenlace:</span>
                  <span style="color: var(--gold);">${slide.content.realData.endpoint}</span>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1rem 0;">
                  <div class="real-data-stat">
                    <span class="value" style="color: var(--red);">${slide.content.realData.drug}</span>
                    <span class="label">Farmaco</span>
                  </div>
                  <div class="real-data-stat">
                    <span class="value">${slide.content.realData.placebo}</span>
                    <span class="label">Placebo</span>
                  </div>
                </div>
                <div class="real-data-stat">
                  <span class="value" style="color: var(--red);">RR ${slide.content.realData.rr}</span>
                  <span class="label">(IC 95%: ${slide.content.realData.ci})</span>
                </div>
                ${slide.content.realData.nnh ? `
                  <div class="real-data-stat" style="margin-top: 0.5rem;">
                    <span class="value">${slide.content.realData.nnh}</span>
                    <span class="label">NND (numero necesario para danar)</span>
                  </div>
                ` : ''}
              </div>
            ` : ''}

            <div class="story-hook" style="margin-top: 1.5rem; font-size: 1.15rem;">
              "${slide.content.hook}"
            </div>
          </div>
        `;
        break;

      case 'decision-tree':
        content = renderDecisionTree(slide.content);
        break;

      case 'real-world-story':
        content = `
          <div class="real-world-story">
            <div class="story-rhetorical-question">${slide.content.rhetoricalQuestion}</div>

            ${slide.content.context ? `<p style="color: rgba(255,255,255,0.85); line-height: 1.7; margin-bottom: 1.5rem;">${slide.content.context}</p>` : ''}

            <div class="story-stats-box">
              <div class="story-stats-header">
                <span>THE REAL DATA</span>
              </div>
              <div class="story-stats-grid">
                ${slide.content.stats.map(stat => `
                  <div class="story-stat-item">
                    <span class="story-stat-value ${stat.type || ''}">${stat.value}</span>
                    <span class="story-stat-label">${stat.label}</span>
                  </div>
                `).join('')}
              </div>
              ${slide.content.source ? `<div class="story-source">Source: ${slide.content.source}</div>` : ''}
            </div>

            <div class="story-decision-tree">
              <div class="story-decision-header">
                <span>THE DECISION</span>
              </div>
              <div class="story-decision-scenario">${slide.content.decisionScenario}</div>

              <div class="story-path path-wrong">
                <div class="story-path-label">PATH A: ${slide.content.pathA.title}</div>
                <div class="story-path-content">
                  ${slide.content.pathA.steps.map(step => `
                    <div class="story-path-arrow">&#8594; ${step}</div>
                  `).join('')}
                </div>
              </div>

              <div class="story-path path-right">
                <div class="story-path-label">PATH B: ${slide.content.pathB.title}</div>
                <div class="story-path-content">
                  ${slide.content.pathB.steps.map(step => `
                    <div class="story-path-arrow">&#8594; ${step}</div>
                  `).join('')}
                </div>
              </div>
            </div>

            <div class="story-revelation">
              <div class="story-revelation-header">
                <span>THE REVELATION</span>
              </div>
              <div class="story-revelation-text">${slide.content.revelation}</div>
            </div>

            ${slide.content.moduleConnection ? `
              <div class="story-connection">
                <strong>Connection to this module:</strong> ${slide.content.moduleConnection}
              </div>
            ` : ''}
          </div>
        `;
        break;

      case 'content':
        content = `
          <h2 class="slide-title">${slide.content.title}</h2>
          <div class="slide-content">
            ${slide.content.sections.map(s => `
              <div class="method-box">
                <h3>${s.heading}</h3>
                ${s.items ? `<ul>${s.items.map(i => `<li>${i}</li>`).join('')}</ul>` : ''}
                ${s.text ? `<p style="line-height: 1.7; color: rgba(255,255,255,0.85);">${s.text}</p>` : ''}
              </div>
            `).join('')}
          </div>
        `;
        break;

      case 'method':
        content = `
          <div class="method-box">
            <div class="method-label">${slide.content.label}</div>
            <h2 style="color: var(--cream); margin-bottom: 1rem;">${slide.content.title}</h2>
            ${slide.content.sections.map(s => `
              <div style="margin-bottom: 1rem;">
                <h4 style="color: var(--gold); margin-bottom: 0.5rem;">${s.heading}</h4>
                <p style="color: rgba(255,255,255,0.85); line-height: 1.6; white-space: pre-line;">${s.text}</p>
              </div>
            `).join('')}
          </div>
        `;
        break;

      case 'tool':
        content = renderTool(slide.content);
        break;

      case 'scenario':
        content = renderScenario(slide.content);
        break;

      case 'quiz':
        content = renderQuiz(slide.content, idx);
        break;

      case 'principle':
        content = `
          <div class="slide-content" style="text-align: center; padding: 3rem;">
            <p style="font-size: 1.3rem; line-height: 1.8; color: var(--cream);">${slide.content.text}</p>
          </div>
        `;
        break;
    }

    return `<div class="slide ${idx === 0 ? 'active' : ''}" data-slide="${idx}">${content}</div>`;
  }).join('');

  updateSlideNav();
}

// ============================================================
// TOOLS
// ============================================================

function renderTool(tool) {
  if (tool.id === 'pico-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîß</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Poblacion (Quien?)</label>
          <input type="text" id="pico-p" placeholder="ej., Adultos con diabetes tipo 2">
        </div>
        <div class="tool-input-group">
          <label>Intervencion (Que tratamiento?)</label>
          <input type="text" id="pico-i" placeholder="ej., Inhibidores SGLT2">
        </div>
        <div class="tool-input-group">
          <label>Comparador (Comparado con?)</label>
          <input type="text" id="pico-c" placeholder="ej., Placebo o cuidado estandar">
        </div>
        <div class="tool-input-group">
          <label>Desenlace (Que importa a los pacientes?)</label>
          <input type="text" id="pico-o" placeholder="ej., Muerte cardiovascular, hospitalizacion por insuficiencia cardiaca">
        </div>

        <button class="tool-btn" onclick="generatePICO()">Generar Pregunta de Investigacion</button>

        <div class="tool-output" id="pico-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'search-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîç</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Terminos de Poblacion</label>
          <input type="text" id="search-pop" placeholder="ej., diabetes, diabetico, DM2">
        </div>
        <div class="tool-input-group">
          <label>Terminos de Intervencion</label>
          <input type="text" id="search-int" placeholder="ej., rosiglitazona, Avandia, tiazolidinediona">
        </div>
        <div class="tool-input-group">
          <label>Terminos de Desenlace</label>
          <input type="text" id="search-out" placeholder="ej., infarto de miocardio, ataque cardiaco, cardiovascular">
        </div>

        <button class="tool-btn" onclick="generateSearch()">Generar Estrategia de Busqueda</button>

        <div class="tool-output" id="search-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'prisma-flow') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìä</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>Registros de bases de datos</label>
            <input type="number" id="prisma-db" value="2847">
          </div>
          <div class="tool-input-group">
            <label>Registros de otras fuentes</label>
            <input type="number" id="prisma-other" value="156">
          </div>
          <div class="tool-input-group">
            <label>Duplicados removidos</label>
            <input type="number" id="prisma-dup" value="423">
          </div>
          <div class="tool-input-group">
            <label>Registros tamizados</label>
            <input type="number" id="prisma-screen" value="2580">
          </div>
          <div class="tool-input-group">
            <label>Registros excluidos (titulo/resumen)</label>
            <input type="number" id="prisma-excl1" value="2489">
          </div>
          <div class="tool-input-group">
            <label>Texto completo evaluado</label>
            <input type="number" id="prisma-ft" value="91">
          </div>
          <div class="tool-input-group">
            <label>Texto completo excluido</label>
            <input type="number" id="prisma-excl2" value="68">
          </div>
          <div class="tool-input-group">
            <label>Estudios incluidos</label>
            <input type="number" id="prisma-incl" value="23">
          </div>
        </div>

        <button class="tool-btn" onclick="generatePRISMA()">Generar Diagrama de Flujo</button>

        <div class="tool-output" id="prisma-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'extraction-form') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìã</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>ID del Estudio / Primer Autor (Ano)</label>
          <input type="text" id="extract-id" placeholder="ej., Garcia 2021">
        </div>
        <div class="tool-input-group">
          <label>Poblacion (N, caracteristicas)</label>
          <input type="text" id="extract-pop" placeholder="ej., N=500 adultos con DM2, edad media 62">
        </div>
        <div class="tool-input-group">
          <label>Detalles de intervencion</label>
          <input type="text" id="extract-int" placeholder="ej., Farmaco X 100mg diario por 12 semanas">
        </div>
        <div class="tool-input-group">
          <label>Detalles del comparador</label>
          <input type="text" id="extract-comp" placeholder="ej., Placebo, apariencia identica">
        </div>
        <div class="tool-input-group">
          <label>Desenlace (eventos/total o media ¬± DE)</label>
          <input type="text" id="extract-out" placeholder="ej., IM: 23/250 vs 45/250">
        </div>
        <div class="tool-input-group">
          <label>Duracion de seguimiento</label>
          <input type="text" id="extract-followup" placeholder="ej., 24 meses">
        </div>

        <button class="tool-btn" onclick="generateExtraction()">Agregar a Tabla de Extraccion</button>

        <div class="tool-output" id="extraction-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'rob2-tool') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚öñÔ∏è</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>ID del Estudio</label>
          <input type="text" id="rob-id" placeholder="ej., Garcia 2021">
        </div>

        <div style="margin: 1rem 0;">
          <strong>Dominio 1: Aleatorizacion</strong>
          <select id="rob-d1" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Riesgo bajo</option>
            <option value="some">Algunas preocupaciones</option>
            <option value="high">Riesgo alto</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Dominio 2: Desviaciones de intervenciones</strong>
          <select id="rob-d2" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Riesgo bajo</option>
            <option value="some">Algunas preocupaciones</option>
            <option value="high">Riesgo alto</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Dominio 3: Datos de desenlace faltantes</strong>
          <select id="rob-d3" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Riesgo bajo</option>
            <option value="some">Algunas preocupaciones</option>
            <option value="high">Riesgo alto</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Dominio 4: Medicion del desenlace</strong>
          <select id="rob-d4" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Riesgo bajo</option>
            <option value="some">Algunas preocupaciones</option>
            <option value="high">Riesgo alto</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Dominio 5: Seleccion del resultado reportado</strong>
          <select id="rob-d5" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem;">
            <option value="low">Riesgo bajo</option>
            <option value="some">Algunas preocupaciones</option>
            <option value="high">Riesgo alto</option>
          </select>
        </div>

        <button class="tool-btn" onclick="generateRoB()">Calcular Riesgo de Sesgo General</button>

        <div class="tool-output" id="rob-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'effect-calculator') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üî¢</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Tipo de efecto</label>
          <select id="effect-type" onchange="updateEffectInputs()" style="width: 100%; padding: 0.5rem;">
            <option value="binary">Binario (eventos/N para cada grupo)</option>
            <option value="continuous">Continuo (media, DE, N)</option>
          </select>
        </div>

        <div id="binary-inputs">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="tool-input-group">
              <label>Eventos tratamiento</label>
              <input type="number" id="eff-e1" value="23">
            </div>
            <div class="tool-input-group">
              <label>N tratamiento</label>
              <input type="number" id="eff-n1" value="250">
            </div>
            <div class="tool-input-group">
              <label>Eventos control</label>
              <input type="number" id="eff-e2" value="45">
            </div>
            <div class="tool-input-group">
              <label>N control</label>
              <input type="number" id="eff-n2" value="250">
            </div>
          </div>
        </div>

        <div id="continuous-inputs" style="display: none;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="tool-input-group">
              <label>Media tratamiento</label>
              <input type="number" step="0.01" id="eff-m1" value="4.2">
            </div>
            <div class="tool-input-group">
              <label>DE tratamiento</label>
              <input type="number" step="0.01" id="eff-sd1" value="2.0">
            </div>
            <div class="tool-input-group">
              <label>N tratamiento</label>
              <input type="number" id="eff-cn1" value="50">
            </div>
            <div class="tool-input-group">
              <label>Media control</label>
              <input type="number" step="0.01" id="eff-m2" value="5.8">
            </div>
            <div class="tool-input-group">
              <label>DE control</label>
              <input type="number" step="0.01" id="eff-sd2" value="2.4">
            </div>
            <div class="tool-input-group">
              <label>N control</label>
              <input type="number" id="eff-cn2" value="50">
            </div>
          </div>
        </div>

        <button class="tool-btn" onclick="calculateEffect()">Calcular Tamano de Efecto</button>

        <div class="tool-output" id="effect-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'forest-plot') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üå≤</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Cargar Conjunto de Datos de Ejemplo</label>
          <select id="forest-preset" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem;" onchange="loadForestPreset()">
            <option value="">‚Äî Selecciona un conjunto de datos real ‚Äî</option>
            <option value="aspirin">Aspirina para Prevencion Primaria (ASCEND, ASPREE, ARRIVE)</option>
            <option value="cast">CAST: Antiarritmicos (la historia que inicio todo)</option>
            <option value="magnesium">Magnesio en IM (ISIS-4 vs ensayos pequenos)</option>
            <option value="ssri">ISRS vs Placebo (ejemplo de sesgo de publicacion)</option>
            <option value="hrt">TRH y EC (observacional vs ECA)</option>
          </select>
        </div>

        <div class="tool-input-group">
          <label>Estudios (uno por linea: Nombre, RR, ICInferior, ICSuperior)</label>
          <textarea id="forest-data" rows="8" placeholder="Estudio1, 0.75, 0.58, 0.97
Estudio2, 0.82, 0.65, 1.03
Estudio3, 0.90, 0.78, 1.04">PHS 1989, 0.58, 0.47, 0.72
WHS 2005, 1.02, 0.84, 1.25
ASPREE 2018, 0.95, 0.83, 1.08
ARRIVE 2018, 0.91, 0.69, 1.19
ASCEND 2018, 0.88, 0.79, 0.97</textarea>
        </div>

        <div class="tool-input-group">
          <label>Modelo</label>
          <select id="forest-model" style="width: 100%; padding: 0.5rem;">
            <option value="random">Efectos aleatorios (DerSimonian-Laird)</option>
            <option value="fixed">Efecto fijo (Varianza Inversa)</option>
          </select>
        </div>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button class="tool-btn" onclick="generateForest()">üå≤ Forest Plot</button>
          <button class="tool-btn" onclick="generateFunnelFromForest()" style="background: var(--navy);">üìä Funnel Plot</button>
        </div>

        <div id="forest-output" style="display: none; margin-top: 1rem;"></div>
      </div>
    `;
  }

  if (tool.id === 'heterogeneity-explorer') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üìà</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>RR combinado (o ingresa desde forest plot)</label>
          <input type="number" step="0.01" id="het-rr" value="0.85">
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>IC 95% Inferior</label>
            <input type="number" step="0.01" id="het-lower" value="0.72">
          </div>
          <div class="tool-input-group">
            <label>IC 95% Superior</label>
            <input type="number" step="0.01" id="het-upper" value="1.00">
          </div>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div class="tool-input-group">
            <label>I¬≤ (%)</label>
            <input type="number" id="het-i2" value="68">
          </div>
          <div class="tool-input-group">
            <label>œÑ¬≤ (tau-cuadrado)</label>
            <input type="number" step="0.001" id="het-tau2" value="0.045">
          </div>
        </div>
        <div class="tool-input-group">
          <label>Numero de estudios</label>
          <input type="number" id="het-k" value="5">
        </div>

        <button class="tool-btn" onclick="calculateHeterogeneity()">Calcular Intervalo de Prediccion</button>

        <div class="tool-output" id="het-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'funnel-plot') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">üîª</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Estudios (uno por linea: Nombre, logRR, EE)</label>
          <textarea id="funnel-data" rows="6" placeholder="Estudio1, -0.29, 0.12
Estudio2, 0.02, 0.10">PHS 1989, -0.54, 0.11
WHS 2005, 0.02, 0.10
ASPREE 2018, -0.05, 0.07
ARRIVE 2018, -0.09, 0.14
ASCEND 2018, -0.13, 0.05</textarea>
        </div>

        <button class="tool-btn" onclick="generateFunnel()">Generar Funnel Plot y Ejecutar Prueba de Egger</button>

        <div id="funnel-output" style="display: none; margin-top: 1rem;"></div>
      </div>
    `;
  }

  if (tool.id === 'grade-builder') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚≠ê</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div class="tool-input-group">
          <label>Desenlace</label>
          <input type="text" id="grade-outcome" value="Eventos cardiovasculares">
        </div>

        <div class="tool-input-group">
          <label>Diseno de estudio</label>
          <select id="grade-design" style="width: 100%; padding: 0.5rem;">
            <option value="rct">ECAs (comienza ALTA)</option>
            <option value="obs">Observacional (comienza BAJA)</option>
          </select>
        </div>

        <div style="margin: 1rem 0;">
          <strong>Bajar por:</strong>
          <div style="margin-top: 0.5rem;">
            <label><input type="checkbox" id="grade-rob"> Riesgo de sesgo</label><br>
            <label><input type="checkbox" id="grade-incon"> Inconsistencia</label><br>
            <label><input type="checkbox" id="grade-indir"> Indirectividad</label><br>
            <label><input type="checkbox" id="grade-imprec"> Imprecision</label><br>
            <label><input type="checkbox" id="grade-pub"> Sesgo de publicacion</label>
          </div>
        </div>

        <button class="tool-btn" onclick="calculateGRADE()">Calcular Certeza</button>

        <div class="tool-output" id="grade-output" style="display: none;"></div>
      </div>
    `;
  }

  if (tool.id === 'prisma-checklist') {
    return `
      <div class="tool-panel">
        <div class="tool-header">
          <span class="tool-icon">‚úì</span>
          <span class="tool-title">${tool.title}</span>
        </div>
        <p style="margin-bottom: 1rem; color: var(--light-text);">${tool.description}</p>

        <div style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem;">
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="1"> 1. Titulo identifica como revision sistematica</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="2"> 2. Resumen estructurado</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="3"> 3. Justificacion declarada</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="4"> 4. Objetivos declarados (PICO)</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="5"> 5. Protocolo registrado</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="6"> 6. Criterios de elegibilidad</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="7"> 7. Fuentes de informacion</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="8"> 8. Estrategia de busqueda (completa para ‚â•1 base de datos)</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="9"> 9. Proceso de seleccion</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="10"> 10. Proceso de extraccion de datos</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="11"> 11. Medidas de efecto</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="12"> 12. Metodos de sintesis</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="13"> 13. Metodo de evaluacion de RdS</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="14"> 14. Metodo de evaluacion de certeza</label>
          </div>
          <div style="margin-bottom: 0.5rem;">
            <label><input type="checkbox" class="prisma-item" data-item="15"> 15. Diagrama de flujo</label>
          </div>
        </div>

        <button class="tool-btn" onclick="calculatePRISMA()">Calcular Completitud</button>

        <div class="tool-output" id="prisma-checklist-output" style="display: none;"></div>
      </div>
    `;
  }

  return `<div class="tool-panel"><p>Tool: ${tool.id}</p></div>`;
}

function generatePICO() {
  const p = document.getElementById('pico-p').value || '[Population]';
  const i = document.getElementById('pico-i').value || '[Intervention]';
  const c = document.getElementById('pico-c').value || '[Comparator]';
  const o = document.getElementById('pico-o').value || '[Outcome]';

  const output = document.getElementById('pico-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Tu Pregunta de Investigacion:</strong>

En ${p}, ¬ø${i} comparado con ${c} mejora ${o}?

<strong>Tabla PICO:</strong>
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ P (Poblacion)   ‚îÇ ${p.substring(0,30)}${p.length > 30 ? '...' : ''}
‚îÇ I (Intervencion)‚îÇ ${i.substring(0,30)}${i.length > 30 ? '...' : ''}
‚îÇ C (Comparador)  ‚îÇ ${c.substring(0,30)}${c.length > 30 ? '...' : ''}
‚îÇ O (Desenlace)   ‚îÇ ${o.substring(0,30)}${o.length > 30 ? '...' : ''}
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

<strong>Verificacion de Jerarquia de Desenlaces:</strong>
${o.toLowerCase().includes('muerte') || o.toLowerCase().includes('mortalidad') ? '‚úì Desenlace de mortalidad ‚Äî excelente!' :
  o.toLowerCase().includes('evento') || o.toLowerCase().includes('hospitalizacion') ? '‚úì Evento clinico ‚Äî buen desenlace importante para el paciente' :
  '‚ö†Ô∏è Considera si este es un desenlace subrogado o importante para el paciente'}
  `;

  awardPoints(25, 'Herramienta PICO usada');
  trackToolUse('pico-builder');
}

function generateSearch() {
  const pop = document.getElementById('search-pop').value || 'diabetes';
  const int = document.getElementById('search-int').value || 'drug';
  const out = document.getElementById('search-out').value || 'outcome';

  const popTerms = pop.split(',').map(t => t.trim()).filter(t => t);
  const intTerms = int.split(',').map(t => t.trim()).filter(t => t);
  const outTerms = out.split(',').map(t => t.trim()).filter(t => t);

  const output = document.getElementById('search-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Estrategia de Busqueda MEDLINE:</strong>

1. Poblacion:
   (${popTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

2. Intervencion:
   (${intTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

3. Desenlace:
   (${outTerms.map(t => `"${t}"[tiab]`).join(' OR ')})

4. Combinado:
   #1 AND #2 AND #3

<strong>Tambien Buscar:</strong>
‚ñ° EMBASE (sintaxis diferente)
‚ñ° CENTRAL (ensayos Cochrane)
‚ñ° ClinicalTrials.gov
‚ñ° WHO ICTRP
‚ñ° Listas de referencias de estudios incluidos
  `;

  awardPoints(25, 'Constructor de busqueda usado');
  trackToolUse('search-builder');
}

function generatePRISMA() {
  const db = parseInt(document.getElementById('prisma-db').value) || 0;
  const other = parseInt(document.getElementById('prisma-other').value) || 0;
  const dup = parseInt(document.getElementById('prisma-dup').value) || 0;
  const screen = parseInt(document.getElementById('prisma-screen').value) || 0;
  const excl1 = parseInt(document.getElementById('prisma-excl1').value) || 0;
  const ft = parseInt(document.getElementById('prisma-ft').value) || 0;
  const excl2 = parseInt(document.getElementById('prisma-excl2').value) || 0;
  const incl = parseInt(document.getElementById('prisma-incl').value) || 0;

  const output = document.getElementById('prisma-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Diagrama de Flujo PRISMA 2020</strong>

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           IDENTIFICACION                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Registros de bases de datos: ${db.toLocaleString().padStart(6)}              ‚îÇ
‚îÇ Registros de otras fuentes: ${other.toLocaleString().padStart(4)}               ‚îÇ
‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                   ‚îÇ
‚îÇ Total registros: ${(db + other).toLocaleString().padStart(6)}                    ‚îÇ
‚îÇ Duplicados removidos: ${dup.toLocaleString().padStart(6)}                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           TAMIZAJE                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Registros tamizados: ${screen.toLocaleString().padStart(6)}                   ‚îÇ
‚îÇ Registros excluidos: ${excl1.toLocaleString().padStart(6)}                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           ELEGIBILIDAD                           ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Texto completo evaluado: ${ft.toLocaleString().padStart(5)}                  ‚îÇ
‚îÇ Texto completo excluido: ${excl2.toLocaleString().padStart(5)}                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ           INCLUIDOS                              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Estudios en revision: ${incl.toLocaleString().padStart(6)}                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

<strong>Tasas de Rendimiento:</strong>
‚Ä¢ Rendimiento tamizaje titulo/resumen: ${((ft/screen)*100).toFixed(1)}%
‚Ä¢ Tasa de inclusion texto completo: ${((incl/ft)*100).toFixed(1)}%
‚Ä¢ Rendimiento general base de datos: ${((incl/db)*100).toFixed(2)}%
  `;

  awardPoints(25, 'Flujo PRISMA generado');
  trackToolUse('prisma-flow');
}

let extractedStudies = [];

function generateExtraction() {
  const study = {
    id: document.getElementById('extract-id').value || 'Unknown',
    pop: document.getElementById('extract-pop').value || '-',
    int: document.getElementById('extract-int').value || '-',
    comp: document.getElementById('extract-comp').value || '-',
    out: document.getElementById('extract-out').value || '-',
    followup: document.getElementById('extract-followup').value || '-'
  };

  extractedStudies.push(study);

  const output = document.getElementById('extraction-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Tabla de Extraccion de Datos (${extractedStudies.length} estudios)</strong>

${extractedStudies.map((s, i) => `
Estudio ${i+1}: ${s.id}
‚îú‚îÄ Poblacion: ${s.pop}
‚îú‚îÄ Intervencion: ${s.int}
‚îú‚îÄ Comparador: ${s.comp}
‚îú‚îÄ Desenlace: ${s.out}
‚îî‚îÄ Seguimiento: ${s.followup}
`).join('\n')}

<strong>Siguiente:</strong> Ingresa otro estudio o procede a la evaluacion de riesgo de sesgo.
  `;

  // Clear inputs for next study
  document.getElementById('extract-id').value = '';
  document.getElementById('extract-pop').value = '';
  document.getElementById('extract-int').value = '';
  document.getElementById('extract-comp').value = '';
  document.getElementById('extract-out').value = '';
  document.getElementById('extract-followup').value = '';

  awardPoints(15, 'Estudio extraido');
  trackToolUse('extraction-form');
}

function generateRoB() {
  const id = document.getElementById('rob-id').value || 'Study';
  const d1 = document.getElementById('rob-d1').value;
  const d2 = document.getElementById('rob-d2').value;
  const d3 = document.getElementById('rob-d3').value;
  const d4 = document.getElementById('rob-d4').value;
  const d5 = document.getElementById('rob-d5').value;

  const domains = [d1, d2, d3, d4, d5];
  let overall = 'Riesgo bajo';

  const highCount = domains.filter(d => d === 'high').length;
  const someCount = domains.filter(d => d === 'some').length;

  if (highCount > 0) {
    overall = 'Riesgo alto';
  } else if (someCount >= 2) {
    overall = 'Algunas preocupaciones (multiples dominios)';
  } else if (someCount === 1) {
    overall = 'Algunas preocupaciones';
  }

  const getColor = (val) => val === 'low' ? 'üü¢' : val === 'some' ? 'üü°' : 'üî¥';
  const getLabel = (val) => val === 'low' ? 'bajo' : val === 'some' ? 'algunas preocupaciones' : 'alto';

  const output = document.getElementById('rob-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Evaluacion de Riesgo de Sesgo: ${id}</strong>

${getColor(d1)} Dominio 1 (Aleatorizacion): ${getLabel(d1)}
${getColor(d2)} Dominio 2 (Desviaciones): ${getLabel(d2)}
${getColor(d3)} Dominio 3 (Datos faltantes): ${getLabel(d3)}
${getColor(d4)} Dominio 4 (Medicion): ${getLabel(d4)}
${getColor(d5)} Dominio 5 (Seleccion): ${getLabel(d5)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
GENERAL: ${overall === 'Riesgo bajo' ? 'üü¢' : overall.includes('alto') ? 'üî¥' : 'üü°'} ${overall}

<strong>Interpretacion:</strong>
${overall === 'Riesgo bajo' ?
  'Es improbable que el estudio tenga sesgo serio. Los resultados pueden ponderarse apropiadamente.' :
  overall.includes('alto') ?
  'El estudio tiene limitaciones serias. Considera analisis de sensibilidad excluyendolo.' :
  'El estudio genera algunas preocupaciones. Reportar en tabla; puede bajar certeza GRADE.'}
  `;

  awardPoints(20, 'Evaluacion RdS completada');
  trackToolUse('rob2-tool');
}

function updateEffectInputs() {
  const type = document.getElementById('effect-type').value;
  document.getElementById('binary-inputs').style.display = type === 'binary' ? 'block' : 'none';
  document.getElementById('continuous-inputs').style.display = type === 'continuous' ? 'block' : 'none';
}

function calculateEffect() {
  const type = document.getElementById('effect-type').value;
  const output = document.getElementById('effect-output');
  output.style.display = 'block';

  if (type === 'binary') {
    const e1 = parseInt(document.getElementById('eff-e1').value);
    const n1 = parseInt(document.getElementById('eff-n1').value);
    const e2 = parseInt(document.getElementById('eff-e2').value);
    const n2 = parseInt(document.getElementById('eff-n2').value);

    const r1 = e1 / n1;
    const r2 = e2 / n2;
    const rr = r1 / r2;
    const logRR = Math.log(rr);
    const seLogRR = Math.sqrt(1/e1 - 1/n1 + 1/e2 - 1/n2);
    const lowerRR = Math.exp(logRR - 1.96 * seLogRR);
    const upperRR = Math.exp(logRR + 1.96 * seLogRR);

    const or = (e1 * (n2 - e2)) / (e2 * (n1 - e1));
    const seLogOR = Math.sqrt(1/e1 + 1/(n1-e1) + 1/e2 + 1/(n2-e2));
    const lowerOR = Math.exp(Math.log(or) - 1.96 * seLogOR);
    const upperOR = Math.exp(Math.log(or) + 1.96 * seLogOR);

    const rd = r1 - r2;
    const seRD = Math.sqrt(r1*(1-r1)/n1 + r2*(1-r2)/n2);
    const lowerRD = rd - 1.96 * seRD;
    const upperRD = rd + 1.96 * seRD;

    output.innerHTML = `
<strong>Calculos de Tamano de Efecto (Desenlace Binario)</strong>

Tratamiento: ${e1}/${n1} (${(r1*100).toFixed(1)}%)
Control: ${e2}/${n2} (${(r2*100).toFixed(1)}%)

<strong>Riesgo Relativo (RR):</strong> ${rr.toFixed(2)} (IC 95%: ${lowerRR.toFixed(2)}-${upperRR.toFixed(2)})
  log(RR) = ${logRR.toFixed(3)}, EE = ${seLogRR.toFixed(3)}

<strong>Odds Ratio (OR):</strong> ${or.toFixed(2)} (IC 95%: ${lowerOR.toFixed(2)}-${upperOR.toFixed(2)})

<strong>Diferencia de Riesgo (DR):</strong> ${(rd*100).toFixed(1)}% (IC 95%: ${(lowerRD*100).toFixed(1)}% a ${(upperRD*100).toFixed(1)}%)
  NNT = ${Math.abs(Math.round(1/rd))} ${rd < 0 ? '(beneficio)' : '(dano)'}

<strong>Interpretacion:</strong>
${rr < 1 ? `El tratamiento reduce eventos en ${((1-rr)*100).toFixed(0)}% relativo al control.` :
  rr > 1 ? `El tratamiento aumenta eventos en ${((rr-1)*100).toFixed(0)}% relativo al control.` :
  'Sin diferencia entre grupos.'}
    `;
  } else {
    const m1 = parseFloat(document.getElementById('eff-m1').value);
    const sd1 = parseFloat(document.getElementById('eff-sd1').value);
    const cn1 = parseInt(document.getElementById('eff-cn1').value);
    const m2 = parseFloat(document.getElementById('eff-m2').value);
    const sd2 = parseFloat(document.getElementById('eff-sd2').value);
    const cn2 = parseInt(document.getElementById('eff-cn2').value);

    const md = m1 - m2;
    const pooledSD = Math.sqrt(((cn1-1)*sd1*sd1 + (cn2-1)*sd2*sd2) / (cn1 + cn2 - 2));
    const seMD = Math.sqrt(sd1*sd1/cn1 + sd2*sd2/cn2);
    const lowerMD = md - 1.96 * seMD;
    const upperMD = md + 1.96 * seMD;

    const smd = md / pooledSD;
    const seSMD = Math.sqrt((cn1 + cn2)/(cn1 * cn2) + smd*smd/(2*(cn1 + cn2)));
    const lowerSMD = smd - 1.96 * seSMD;
    const upperSMD = smd + 1.96 * seSMD;

    let effectSize = 'negligible';
    if (Math.abs(smd) >= 0.8) effectSize = 'large';
    else if (Math.abs(smd) >= 0.5) effectSize = 'medium';
    else if (Math.abs(smd) >= 0.2) effectSize = 'small';

    output.innerHTML = `
<strong>Calculos de Tamano de Efecto (Desenlace Continuo)</strong>

Tratamiento: media = ${m1.toFixed(2)}, DE = ${sd1.toFixed(2)}, N = ${cn1}
Control: media = ${m2.toFixed(2)}, DE = ${sd2.toFixed(2)}, N = ${cn2}
DE combinada = ${pooledSD.toFixed(2)}

<strong>Diferencia de Medias (DM):</strong> ${md.toFixed(2)} (IC 95%: ${lowerMD.toFixed(2)} a ${upperMD.toFixed(2)})
  EE = ${seMD.toFixed(3)}

<strong>Diferencia de Medias Estandarizada (DME/d de Cohen):</strong>
  d = ${smd.toFixed(2)} (IC 95%: ${lowerSMD.toFixed(2)} a ${upperSMD.toFixed(2)})
  EE = ${seSMD.toFixed(3)}

<strong>Interpretacion (convenciones de Cohen):</strong>
  Tamano de efecto: ${effectSize === 'large' ? 'grande' : effectSize === 'medium' ? 'mediano' : effectSize === 'small' ? 'pequeno' : 'insignificante'} (|d| ${Math.abs(smd).toFixed(2)})
  ${smd < 0 ? 'El grupo de tratamiento tiene puntuaciones MAS BAJAS que el control.' :
    smd > 0 ? 'El grupo de tratamiento tiene puntuaciones MAS ALTAS que el control.' :
    'Sin diferencia entre grupos.'}
    `;
  }

  awardPoints(25, 'Tamano de efecto calculado');
  trackToolUse('effect-calculator');
}

function generateForest() {
  const data = document.getElementById('forest-data').value;
  const model = document.getElementById('forest-model').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    return {
      name: parts[0],
      rr: parseFloat(parts[1]),
      lower: parseFloat(parts[2]),
      upper: parseFloat(parts[3]),
      logRR: Math.log(parseFloat(parts[1])),
      se: (Math.log(parseFloat(parts[3])) - Math.log(parseFloat(parts[2]))) / (2 * 1.96)
    };
  });

  // Calculate pooled effect (inverse variance)
  let sumW = 0, sumWY = 0, sumW2 = 0;
  const weights = [];
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    weights.push(w);
    sumW += w;
    sumWY += w * s.logRR;
    sumW2 += w * w;
  });

  const pooledLogRR = sumWY / sumW;
  const pooledRR = Math.exp(pooledLogRR);

  // Q statistic and heterogeneity
  let Q = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    Q += w * Math.pow(s.logRR - pooledLogRR, 2);
  });

  const df = studies.length - 1;
  const I2 = Math.max(0, ((Q - df) / Q) * 100);
  const tau2 = Math.max(0, (Q - df) / (sumW - sumW2/sumW));

  // Random effects pooled
  let sumWr = 0, sumWYr = 0;
  const weightsRE = [];
  studies.forEach(s => {
    const wr = 1 / (s.se * s.se + tau2);
    weightsRE.push(wr);
    sumWr += wr;
    sumWYr += wr * s.logRR;
  });
  const pooledLogRRr = sumWYr / sumWr;
  const pooledRRr = Math.exp(pooledLogRRr);
  const sePooledRE = Math.sqrt(1 / sumWr);
  const lowerPooledRE = Math.exp(pooledLogRRr - 1.96 * sePooledRE);
  const upperPooledRE = Math.exp(pooledLogRRr + 1.96 * sePooledRE);

  const sePooledFE = Math.sqrt(1 / sumW);
  const lowerPooledFE = Math.exp(pooledLogRR - 1.96 * sePooledFE);
  const upperPooledFE = Math.exp(pooledLogRR + 1.96 * sePooledFE);

  const usedWeights = model === 'random' ? weightsRE : weights;
  const totalWeight = usedWeights.reduce((a, b) => a + b, 0);
  const weightPct = usedWeights.map(w => (w / totalWeight) * 100);

  const usedRR = model === 'random' ? pooledRRr : pooledRR;
  const usedLower = model === 'random' ? lowerPooledRE : lowerPooledFE;
  const usedUpper = model === 'random' ? upperPooledRE : upperPooledFE;

  // Prediction interval (using proper t-distribution)
  const piDF = Math.max(1, studies.length - 2);
  const tCrit = getTCritical(piDF);
  const sePooled = model === 'random' ? sePooledRE : sePooledFE;
  const piWidth = tCrit * Math.sqrt(tau2 + sePooled*sePooled);
  const piLower = Math.exp((model === 'random' ? pooledLogRRr : pooledLogRR) - piWidth);
  const piUpper = Math.exp((model === 'random' ? pooledLogRRr : pooledLogRR) + piWidth);

  // === BUILD INTERACTIVE PLOTLY FOREST PLOT ===
  const output = document.getElementById('forest-output');
  output.style.display = 'block';

  // Create plot container
  output.innerHTML = `
    <div id="forestPlotArea" style="width:100%; height:${Math.max(300, studies.length * 35 + 120)}px;"></div>
    <div class="stats-panel" style="margin-top:1rem;">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">${usedRR.toFixed(2)}</div>
          <div class="stat-label">Pooled RR</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${usedLower.toFixed(2)}-${usedUpper.toFixed(2)}</div>
          <div class="stat-label">95% CI</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${I2.toFixed(1)}%</div>
          <div class="stat-label">I¬≤ heterogeneity</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${piLower.toFixed(2)}-${piUpper.toFixed(2)}</div>
          <div class="stat-label">Prediction Interval</div>
        </div>
      </div>
      <div class="stat-interpretation">
        <strong>Interpretation:</strong> ${usedLower > 1 ? '‚ö†Ô∏è Treatment INCREASES risk (statistically significant).' :
          usedUpper < 1 ? '‚úì Treatment REDUCES risk (statistically significant).' :
          '‚óã No statistically significant effect (CI crosses 1.0).'}
        ${I2 > 50 ? '<br><strong>Warning:</strong> High heterogeneity (I¬≤ > 50%) ‚Äî consider exploring sources of variation.' : ''}
        ${piLower < 1 && piUpper > 1 ? '<br><strong>Note:</strong> Prediction interval crosses null ‚Äî true effect in a new study could go either direction.' : ''}
      </div>
    </div>
  `;

  // Check if Plotly is loaded
  if (typeof Plotly !== 'undefined') {
    const yValues = studies.map((s, i) => studies.length - i);
    const studyNames = studies.map(s => s.name);

    // Study points trace
    const studyTrace = {
      x: studies.map(s => s.rr),
      y: yValues,
      mode: 'markers',
      type: 'scatter',
      marker: {
        size: weightPct.map(w => Math.max(8, Math.min(24, w * 1.5))),
        color: '#1E2761',
        symbol: 'square',
        line: { color: '#0d1b2a', width: 1 }
      },
      error_x: {
        type: 'data',
        symmetric: false,
        array: studies.map(s => s.upper - s.rr),
        arrayminus: studies.map(s => s.rr - s.lower),
        color: '#1E2761',
        thickness: 2,
        width: 4
      },
      text: studies.map((s, i) => `${s.name}<br>RR: ${s.rr.toFixed(2)} (${s.lower.toFixed(2)}-${s.upper.toFixed(2)})<br>Weight: ${weightPct[i].toFixed(1)}%`),
      hoverinfo: 'text',
      name: 'Studies'
    };

    // Pooled effect diamond
    const pooledTrace = {
      x: [usedRR],
      y: [0],
      mode: 'markers',
      type: 'scatter',
      marker: {
        size: 16,
        color: '#D4AF37',
        symbol: 'diamond',
        line: { color: '#8B7500', width: 2 }
      },
      error_x: {
        type: 'data',
        symmetric: false,
        array: [usedUpper - usedRR],
        arrayminus: [usedRR - usedLower],
        color: '#D4AF37',
        thickness: 3,
        width: 0
      },
      text: [`Pooled (${model})<br>RR: ${usedRR.toFixed(2)} (${usedLower.toFixed(2)}-${usedUpper.toFixed(2)})`],
      hoverinfo: 'text',
      name: 'Pooled'
    };

    // Null effect line
    const nullLine = {
      x: [1, 1],
      y: [-0.5, studies.length + 0.5],
      mode: 'lines',
      type: 'scatter',
      line: { color: '#888', width: 1, dash: 'dash' },
      hoverinfo: 'skip',
      showlegend: false
    };

    // Prediction interval
    const piTrace = {
      x: [piLower, piUpper],
      y: [-0.5, -0.5],
      mode: 'lines+markers',
      type: 'scatter',
      line: { color: '#888', width: 1, dash: 'dot' },
      marker: { size: 6, color: '#888', symbol: 'line-ns-open' },
      text: [`Prediction Interval: ${piLower.toFixed(2)}-${piUpper.toFixed(2)}`],
      hoverinfo: 'text',
      name: 'Prediction Interval'
    };

    const layout = {
      xaxis: {
        title: 'Risk Ratio (log scale)',
        type: 'log',
        showgrid: true,
        gridcolor: '#eee',
        zeroline: false,
        tickvals: [0.25, 0.5, 1, 2, 4],
        ticktext: ['0.25', '0.5', '1', '2', '4']
      },
      yaxis: {
        tickvals: [...yValues, 0],
        ticktext: [...studyNames, `<b>Pooled (${model})</b>`],
        showgrid: false,
        zeroline: false
      },
      annotations: [
        { x: 0.5, y: -0.08, xref: 'paper', yref: 'paper', text: '‚Üê Favors Treatment', showarrow: false, font: { size: 10, color: '#22c55e' } },
        { x: 0.95, y: -0.08, xref: 'paper', yref: 'paper', text: 'Favors Control ‚Üí', showarrow: false, font: { size: 10, color: '#C53030' } }
      ],
      showlegend: false,
      margin: { l: 150, r: 50, t: 30, b: 60 },
      paper_bgcolor: 'white',
      plot_bgcolor: 'white',
      hovermode: 'closest'
    };

    Plotly.newPlot('forestPlotArea', [nullLine, studyTrace, pooledTrace, piTrace], layout, { responsive: true });
  } else {
    // Fallback to text-based plot if Plotly not loaded
    output.innerHTML += '<p style="color:#888; padding:1rem;">Plotly not loaded. Showing text summary only.</p>';
  }

  awardPoints(50, 'Forest plot generado');
  trackToolUse('forest-plot');
}

// ============================================================
// FUNNEL PLOT FROM FOREST DATA (INTERACTIVE - Plotly)
// ============================================================

function generateFunnelFromForest() {
  const data = document.getElementById('forest-data').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    const rr = parseFloat(parts[1]);
    const lower = parseFloat(parts[2]);
    const upper = parseFloat(parts[3]);
    const logRR = Math.log(rr);
    const se = (Math.log(upper) - Math.log(lower)) / (2 * 1.96);
    return { name: parts[0], rr, lower, upper, logRR, se };
  });

  // Calculate pooled effect
  let sumW = 0, sumWY = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
  });
  const pooledLogRR = sumWY / sumW;

  // Egger's test (simplified)
  const n = studies.length;
  const precision = studies.map(s => 1 / s.se);
  const standardized = studies.map(s => s.logRR / s.se);

  const meanP = precision.reduce((a, b) => a + b, 0) / n;
  const meanS = standardized.reduce((a, b) => a + b, 0) / n;

  let num = 0, denP = 0;
  for (let i = 0; i < n; i++) {
    num += (precision[i] - meanP) * (standardized[i] - meanS);
    denP += Math.pow(precision[i] - meanP, 2);
  }
  const slope = num / denP;
  const intercept = meanS - slope * meanP;

  // SE of intercept (simplified)
  let residualSS = 0;
  for (let i = 0; i < n; i++) {
    const predicted = intercept + slope * precision[i];
    residualSS += Math.pow(standardized[i] - predicted, 2);
  }
  const mse = residualSS / (n - 2);
  const seIntercept = Math.sqrt(mse * (1/n + meanP*meanP/denP));
  const tStat = intercept / seIntercept;
  const eggerDF = Math.max(1, n - 2);
  // Use t-distribution for proper p-value (more accurate than normal for small samples)
  const pValue = 2 * (1 - tCDF(Math.abs(tStat), eggerDF));

  const output = document.getElementById('forest-output');
  output.style.display = 'block';

  output.innerHTML = `
    <div id="funnelPlotArea" style="width:100%; height:350px; margin-bottom:1rem;"></div>
    <div class="stats-panel">
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value">${intercept.toFixed(3)}</div>
          <div class="stat-label">Egger's Intercept</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${pValue.toFixed(4)}</div>
          <div class="stat-label">P-value</div>
        </div>
        <div class="stat-item">
          <div class="stat-value">${pValue < 0.1 ? '‚ö†Ô∏è Yes' : '‚úì No'}</div>
          <div class="stat-label">Asymmetry?</div>
        </div>
      </div>
      <div class="stat-interpretation">
        <strong>Interpretation:</strong> ${pValue < 0.1 ?
          '‚ö†Ô∏è Funnel plot asymmetry detected (Egger p < 0.1). This could indicate publication bias, small-study effects, or heterogeneity.' :
          '‚úì No significant asymmetry detected. However, note that Egger\'s test has limited power with few studies (< 10).'
        }
        ${n < 10 ? '<br><strong>Caution:</strong> With only ' + n + 'En los estudios, las pruebas de asimetr√≠a del embudo tienen un poder estad√≠stico bajo.' : ''}
      </div>
    </div>
  `;

  if (typeof Plotly !== 'undefined') {
    const maxSE = Math.max(...studies.map(s => s.se)) * 1.2;

    // Create funnel shape (95% CI region)
    const seRange = Array.from({length: 50}, (_, i) => (i / 49) * maxSE);
    const lowerBound = seRange.map(se => Math.exp(pooledLogRR - 1.96 * se));
    const upperBound = seRange.map(se => Math.exp(pooledLogRR + 1.96 * se));

    const funnelTrace = {
      x: [...lowerBound, ...upperBound.reverse()],
      y: [...seRange, ...seRange.reverse()],
      fill: 'toself',
      fillcolor: 'rgba(30,39,97,0.1)',
      line: { color: 'transparent' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const pooledLine = {
      x: [Math.exp(pooledLogRR), Math.exp(pooledLogRR)],
      y: [0, maxSE],
      mode: 'lines',
      line: { color: '#D4AF37', width: 2, dash: 'dash' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const nullLine = {
      x: [1, 1],
      y: [0, maxSE],
      mode: 'lines',
      line: { color: '#888', width: 1, dash: 'dot' },
      hoverinfo: 'skip',
      showlegend: false
    };

    const studyPoints = {
      x: studies.map(s => s.rr),
      y: studies.map(s => s.se),
      mode: 'markers',
      type: 'scatter',
      marker: { size: 10, color: '#1E2761', line: { color: '#0d1b2a', width: 1 } },
      text: studies.map(s => `${s.name}<br>RR: ${s.rr.toFixed(2)}<br>SE: ${s.se.toFixed(3)}`),
      hoverinfo: 'text',
      name: 'Studies'
    };

    const layout = {
      xaxis: { title: 'Risk Ratio (log scale)', type: 'log', showgrid: true, gridcolor: '#eee' },
      yaxis: { title: 'Standard Error', autorange: 'reversed', showgrid: true, gridcolor: '#eee' },
      showlegend: false,
      margin: { l: 60, r: 30, t: 30, b: 50 },
      paper_bgcolor: 'white',
      plot_bgcolor: 'white'
    };

    Plotly.newPlot('funnelPlotArea', [funnelTrace, pooledLine, nullLine, studyPoints], layout, { responsive: true });
  }

  awardPoints(50, 'Funnel plot generado');
  trackToolUse('funnel-plot');
}

// Normal CDF approximation
function normalCDF(x) {
  const a1 =  0.254829592, a2 = -0.284496736, a3 =  1.421413741;
  const a4 = -1.453152027, a5 =  1.061405429, p  =  0.3275911;
  const sign = x < 0 ? -1 : 1;
  x = Math.abs(x) / Math.sqrt(2);
  const t = 1.0 / (1.0 + p * x);
  const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);
  return 0.5 * (1.0 + sign * y);
}

// T-distribution critical values (two-tailed 95%, df 1-30 and approximation for larger)
const tCriticalValues = {
  1: 12.706, 2: 4.303, 3: 3.182, 4: 2.776, 5: 2.571,
  6: 2.447, 7: 2.365, 8: 2.306, 9: 2.262, 10: 2.228,
  11: 2.201, 12: 2.179, 13: 2.160, 14: 2.145, 15: 2.131,
  16: 2.120, 17: 2.110, 18: 2.101, 19: 2.093, 20: 2.086,
  21: 2.080, 22: 2.074, 23: 2.069, 24: 2.064, 25: 2.060,
  26: 2.056, 27: 2.052, 28: 2.048, 29: 2.045, 30: 2.042
};

function getTCritical(df) {
  if (df <= 0) return 12.706;
  if (df <= 30) return tCriticalValues[df] || tCriticalValues[Math.round(df)];
  // For df > 30, use approximation approaching 1.96
  return 1.96 + 2.4 / df;
}

// T-distribution CDF approximation (for p-value calculation)
function tCDF(t, df) {
  // Use regularized incomplete beta function approximation
  const x = df / (df + t * t);
  const a = df / 2;
  const b = 0.5;
  // For |t| > 0, use beta function approximation
  if (Math.abs(t) < 1e-10) return 0.5;
  const betaIncomplete = incompleteBeta(x, a, b);
  return t > 0 ? 1 - 0.5 * betaIncomplete : 0.5 * betaIncomplete;
}

// Incomplete beta function approximation using continued fractions
function incompleteBeta(x, a, b) {
  if (x === 0) return 0;
  if (x === 1) return 1;
  // Use series expansion for small x
  const bt = Math.exp(
    lgamma(a + b) - lgamma(a) - lgamma(b) +
    a * Math.log(x) + b * Math.log(1 - x)
  );
  if (x < (a + 1) / (a + b + 2)) {
    return bt * betaCF(x, a, b) / a;
  } else {
    return 1 - bt * betaCF(1 - x, b, a) / b;
  }
}

// Continued fraction for incomplete beta
function betaCF(x, a, b) {
  const maxIter = 100, eps = 1e-10;
  let am = 1, bm = 1, az = 1;
  const qab = a + b, qap = a + 1, qam = a - 1;
  let bz = 1 - qab * x / qap;
  for (let m = 1; m <= maxIter; m++) {
    const em = m, tem = em + em;
    let d = em * (b - m) * x / ((qam + tem) * (a + tem));
    const ap = az + d * am;
    const bp = bz + d * bm;
    d = -(a + em) * (qab + em) * x / ((a + tem) * (qap + tem));
    const app = ap + d * az;
    const bpp = bp + d * bz;
    const aold = az;
    am = ap / bpp; bm = bp / bpp;
    az = app / bpp; bz = 1;
    if (Math.abs(az - aold) < eps * Math.abs(az)) break;
  }
  return az;
}

// Log gamma function (Lanczos approximation)
function lgamma(x) {
  const g = 7;
  const c = [0.99999999999980993, 676.5203681218851, -1259.1392167224028,
    771.32342877765313, -176.61502916214059, 12.507343278686905,
    -0.13857109526572012, 9.9843695780195716e-6, 1.5056327351493116e-7];
  if (x < 0.5) {
    return Math.log(Math.PI / Math.sin(Math.PI * x)) - lgamma(1 - x);
  }
  x -= 1;
  let a = c[0];
  for (let i = 1; i < g + 2; i++) a += c[i] / (x + i);
  const t = x + g + 0.5;
  return 0.5 * Math.log(2 * Math.PI) + (x + 0.5) * Math.log(t) - t + Math.log(a);
}

// ============================================================
// PRESET DATASETS (Real-world meta-analysis data)
// ============================================================

const forestPresets = {
  aspirin: {
    name: "Aspirina para la prevenci√≥n primaria",
    description: "Major trials of aspirin for cardiovascular prevention in people without prior CVD",
    data: `PHS 1989, 0.58, 0.47, 0.72
BDT 1988, 0.97, 0.87, 1.09
TPT 1998, 0.80, 0.61, 1.05
HOT 1998, 0.85, 0.73, 0.99
PPP 2001, 0.71, 0.48, 1.04
WHS 2005, 1.02, 0.84, 1.25
POPADAD 2008, 0.98, 0.76, 1.26
JPAD 2008, 0.80, 0.58, 1.10
AAA 2010, 1.08, 0.86, 1.36
JPPP 2014, 0.94, 0.77, 1.15
ARRIVE 2018, 0.96, 0.81, 1.13
ASCEND 2018, 0.88, 0.79, 0.97
ASPREE 2018, 0.95, 0.83, 1.08`
  },
  cast: {
    name: "CAST: Antiarrhythmic Drugs After MI",
    description: "El juicio que mat√≥ a m√°s de 50.000 estadounidenses: hacer la pregunta equivocada",
    data: `Encainide 1989, 2.38, 1.59, 3.57
Flecainide 1989, 2.64, 1.60, 4.36
Moricizine 1992, 1.69, 1.10, 2.58`
  },
  magnesium: {
    name: "Magnesium in Acute MI",
    description: "Small trials vs mega-trial ‚Äî the danger of small-study effects",
    data: `Morton 1984, 0.09, 0.01, 1.54
Rasmussen 1986, 0.25, 0.07, 0.89
Smith 1986, 0.45, 0.09, 2.13
Abraham 1987, 0.75, 0.31, 1.78
Feldstedt 1988, 0.56, 0.23, 1.36
Ceremuzynski 1989, 0.25, 0.06, 1.10
Shechter 1990, 0.16, 0.04, 0.69
LIMIT-2 1992, 0.74, 0.56, 0.99
ISIS-4 1995, 1.06, 0.99, 1.14`
  },
  ssri: {
    name: "SSRIs vs Placebo (Published vs All Trials)",
    description: "Turner 2008: Publication bias in antidepressant trials",
    data: `Published + Positive, 0.65, 0.58, 0.73
Published + Negative, 0.92, 0.80, 1.06
Unpublished + Negative, 0.95, 0.86, 1.05
Unpublished + Questionable, 0.88, 0.77, 1.01`
  },
  hrt: {
    name: "HRT and Coronary Heart Disease",
    description: "Observational studies suggested benefit, but RCTs showed harm",
    data: `NHS 1985, 0.50, 0.30, 0.80
Framingham 1985, 0.50, 0.30, 0.90
NHANES 1987, 0.66, 0.46, 0.96
Uppsala 1988, 0.90, 0.70, 1.20
Rancho 1991, 0.59, 0.35, 0.99
NHS 1991, 0.56, 0.40, 0.80
Leisure World 1996, 0.62, 0.50, 0.76
WHI 2002, 1.29, 1.02, 1.63
HERS 1998, 0.99, 0.81, 1.22`
  }
};

function loadForestPreset() {
  const preset = document.getElementById('forest-preset').value;
  if (!preset || !forestPresets[preset]) return;

  const data = forestPresets[preset];
  document.getElementById('forest-data').value = data.data;

  // Show info about the dataset
  const output = document.getElementById('forest-output');
  output.style.display = 'block';
  output.innerHTML = `
    <div style="background: rgba(30,39,97,0.15); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <strong style="color: var(--navy);">üìö ${data.name}</strong>
      <p style="margin-top: 0.5rem; color: var(--light-text); font-size: 0.9rem;">${data.description}</p>
      <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--teal);">Click "Forest Plot" or "Funnel Plot" to analyze this data.</p>
    </div>
  `;
}

// ============================================================
// INTERACTIVE DATA TABLE EDITOR
// ============================================================

function addStudyRow() {
  const table = document.getElementById('study-data-table');
  if (!table) return;

  const tbody = table.querySelector('tbody');
  const rowCount = tbody.children.length + 1;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" value="Study ${rowCount}" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="1.00" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="0.80" onchange="updateForestData()"></td>
    <td><input type="number" step="0.01" value="1.25" onchange="updateForestData()"></td>
    <td class="row-actions"><button class="delete-row" onclick="deleteStudyRow(this)">‚úï</button></td>
  `;
  tbody.appendChild(row);
  updateForestData();
}

function deleteStudyRow(btn) {
  const row = btn.closest('tr');
  if (row) {
    row.remove();
    updateForestData();
  }
}

function updateForestData() {
  const table = document.getElementById('study-data-table');
  if (!table) return;

  const rows = table.querySelectorAll('tbody tr');
  const lines = [];

  rows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length >= 4) {
      const name = inputs[0].value;
      const rr = inputs[1].value;
      const lower = inputs[2].value;
      const upper = inputs[3].value;
      lines.push(`${name}, ${rr}, ${lower}, ${upper}`);
    }
  });

  const textarea = document.getElementById('forest-data');
  if (textarea) {
    textarea.value = lines.join('\n');
  }
}

// Legacy text forest for compatibility
function generateForestLegacy() {
  const data = document.getElementById('forest-data').value;
  const model = document.getElementById('forest-model').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    return {
      name: parts[0],
      rr: parseFloat(parts[1]),
      lower: parseFloat(parts[2]),
      upper: parseFloat(parts[3]),
      logRR: Math.log(parseFloat(parts[1])),
      se: (Math.log(parseFloat(parts[3])) - Math.log(parseFloat(parts[2]))) / (2 * 1.96)
    };
  });

  let sumW = 0, sumWY = 0, sumW2 = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
    sumW2 += w * w;
  });

  const pooledLogRR = sumWY / sumW;
  const pooledRR = Math.exp(pooledLogRR);

  let Q = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    Q += w * Math.pow(s.logRR - pooledLogRR, 2);
  });

  const df = studies.length - 1;
  const I2 = Math.max(0, ((Q - df) / Q) * 100);
  const tau2 = Math.max(0, (Q - df) / (sumW - sumW2/sumW));

  let sumWr = 0, sumWYr = 0;
  studies.forEach(s => {
    const wr = 1 / (s.se * s.se + tau2);
    sumWr += wr;
    sumWYr += wr * s.logRR;
  });
  const pooledLogRRr = sumWYr / sumWr;
  const pooledRRr = Math.exp(pooledLogRRr);
  const sePooledRE = Math.sqrt(1 / sumWr);
  const lowerPooledRE = Math.exp(pooledLogRRr - 1.96 * sePooledRE);
  const upperPooledRE = Math.exp(pooledLogRRr + 1.96 * sePooledRE);

  const sePooledFE = Math.sqrt(1 / sumW);
  const lowerPooledFE = Math.exp(pooledLogRR - 1.96 * sePooledFE);
  const upperPooledFE = Math.exp(pooledLogRR + 1.96 * sePooledFE);

  const usedRR = model === 'random' ? pooledRRr : pooledRR;
  const usedLower = model === 'random' ? lowerPooledRE : lowerPooledFE;
  const usedUpper = model === 'random' ? upperPooledRE : upperPooledFE;

  const minLog = Math.log(0.3);
  const maxLog = Math.log(2.0);
  const range = maxLog - minLog;
  const width = 50;

  const getPos = (rr) => Math.round(((Math.log(rr) - minLog) / range) * width);
  const nullPos = getPos(1.0);

  let forestText = `
<strong>Forest Plot (${model === 'random' ? 'Efectos Aleatorios' : 'Efecto Fijo'})</strong>

                              0.3   0.5     1.0    1.5  2.0
Estudio              RR (IC 95%)  ‚îÇ${' '.repeat(nullPos-1)}‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº${'‚îÄ'.repeat(width)}‚î§
`;

  studies.forEach(s => {
    const pos = getPos(s.rr);
    const lowerPos = Math.max(0, getPos(s.lower));
    const upperPos = Math.min(width, getPos(s.upper));

    let line = ' '.repeat(width + 1);
    line = line.substring(0, lowerPos) + '‚îú' + '‚îÄ'.repeat(Math.max(0, upperPos - lowerPos - 1)) + '‚î§' + line.substring(upperPos + 1);
    line = line.substring(0, pos) + '‚ñ†' + line.substring(pos + 1);

    const name = (s.name + ' '.repeat(15)).substring(0, 15);
    const ci = `${s.rr.toFixed(2)} (${s.lower.toFixed(2)}-${s.upper.toFixed(2)})`;
    forestText += `${name}  ${ci.padEnd(16)} ‚îÇ${line}‚îÇ\n`;
  });

  const pooledPos = getPos(usedRR);
  const pooledLowerPos = Math.max(0, getPos(usedLower));
  const pooledUpperPos = Math.min(width, getPos(usedUpper));
  let pooledLine = ' '.repeat(width + 1);
  pooledLine = pooledLine.substring(0, pooledLowerPos) + '<' + '‚ïê'.repeat(Math.max(0, pooledUpperPos - pooledLowerPos - 1)) + '>' + pooledLine.substring(pooledUpperPos + 1);
  pooledLine = pooledLine.substring(0, pooledPos) + '‚óÜ' + pooledLine.substring(pooledPos + 1);

  forestText += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº${'‚îÄ'.repeat(width)}‚î§
Combinado (${model === 'random' ? 'aleat' : 'fijo'}) ${usedRR.toFixed(2)} (${usedLower.toFixed(2)}-${usedUpper.toFixed(2)})   ‚îÇ${pooledLine}‚îÇ

<strong>Heterogeneidad:</strong>
Q = ${Q.toFixed(2)}, gl = ${df}, p ${Q > df * 2 ? '< 0.05' : '‚â• 0.05'}
I¬≤ = ${I2.toFixed(1)}% ${I2 < 25 ? '(baja)' : I2 < 50 ? '(moderada)' : I2 < 75 ? '(sustancial)' : '(considerable)'}
œÑ¬≤ = ${tau2.toFixed(4)}

<strong>Interpretacion:</strong>
${usedLower > 1 ? 'El tratamiento AUMENTA eventos (estadisticamente significativo).' :
  usedUpper < 1 ? 'El tratamiento REDUCE eventos (estadisticamente significativo).' :
  'Sin efecto estadisticamente significativo (IC cruza 1.0).'}
`;

  const output = document.getElementById('forest-output');
  output.style.display = 'block';
  output.innerHTML = `<pre style="font-family: monospace; font-size: 0.8rem; overflow-x: auto;">${forestText}</pre>`;

  awardPoints(50, 'Forest plot generado');
  trackToolUse('forest-plot');
}

function calculateHeterogeneity() {
  const rr = parseFloat(document.getElementById('het-rr').value);
  const lower = parseFloat(document.getElementById('het-lower').value);
  const upper = parseFloat(document.getElementById('het-upper').value);
  const i2 = parseFloat(document.getElementById('het-i2').value);
  const tau2 = parseFloat(document.getElementById('het-tau2').value);
  const k = parseInt(document.getElementById('het-k').value);

  const logRR = Math.log(rr);
  const tau = Math.sqrt(tau2);

  // Prediction interval (approximate)
  const tCrit = k > 2 ? 2.0 + 4.0/(k-2) : 4.3; // Approximation
  const sePooled = (Math.log(upper) - Math.log(lower)) / (2 * 1.96);
  const piWidth = tCrit * Math.sqrt(tau2 + sePooled*sePooled);
  const piLower = Math.exp(logRR - piWidth);
  const piUpper = Math.exp(logRR + piWidth);

  const output = document.getElementById('het-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Analisis de Heterogeneidad</strong>

Efecto combinado: RR ${rr.toFixed(2)} (IC 95%: ${lower.toFixed(2)}-${upper.toFixed(2)})
Numero de estudios: ${k}

<strong>Metricas de heterogeneidad:</strong>
‚Ä¢ I¬≤ = ${i2.toFixed(1)}%
  ${i2 < 25 ? '‚Üí Heterogeneidad baja' :
    i2 < 50 ? '‚Üí Heterogeneidad moderada' :
    i2 < 75 ? '‚Üí Heterogeneidad sustancial' :
    '‚Üí Heterogeneidad considerable'}

‚Ä¢ œÑ¬≤ = ${tau2.toFixed(4)}
‚Ä¢ œÑ = ${tau.toFixed(3)} (DE de efectos verdaderos en escala logaritmica)

<strong>Intervalo de Prediccion 95%:</strong>
RR ${piLower.toFixed(2)} a ${piUpper.toFixed(2)}

${piLower < 1 && piUpper > 1 ?
  '‚ö†Ô∏è CRITICO: El intervalo de prediccion cruza 1.0\nEn algunos entornos futuros, el tratamiento podria no funcionar o causar dano.' :
  piUpper < 1 ?
  '‚úì Intervalo de prediccion debajo de 1.0 ‚Äî tratamiento probablemente beneficioso en todos los entornos.' :
  '‚ö†Ô∏è Intervalo de prediccion arriba de 1.0 ‚Äî el tratamiento puede causar dano en algunos entornos.'}

<strong>Interpretacion clinica:</strong>
El intervalo de confianza te dice: "El efecto promedio es probablemente ${rr.toFixed(2)}."
El intervalo de prediccion te dice: "Un nuevo estudio probablemente encontraria un efecto entre ${piLower.toFixed(2)} y ${piUpper.toFixed(2)}."

${i2 > 50 ? '\n‚ö†Ô∏è Con I¬≤ > 50%, explora fuentes de heterogeneidad mediante analisis de subgrupos o meta-regresion.' : ''}
  `;

  awardPoints(25, 'Heterogeneidad analizada');
  trackToolUse('heterogeneity-explorer');
}

function generateFunnel() {
  const data = document.getElementById('funnel-data').value;

  const studies = data.split('\n').filter(l => l.trim()).map(line => {
    const parts = line.split(',').map(p => p.trim());
    return {
      name: parts[0],
      logRR: parseFloat(parts[1]),
      se: parseFloat(parts[2])
    };
  });

  // Calculate pooled effect for reference line
  let sumW = 0, sumWY = 0;
  studies.forEach(s => {
    const w = 1 / (s.se * s.se);
    sumW += w;
    sumWY += w * s.logRR;
  });
  const pooledLogRR = sumWY / sumW;

  // Egger's test (simplified regression)
  const meanSE = studies.reduce((a, s) => a + s.se, 0) / studies.length;
  let sumXY = 0, sumX2 = 0, sumY = 0, sumX = 0;
  studies.forEach(s => {
    const y = s.logRR / s.se;  // standardized effect
    const x = 1 / s.se;  // precision
    sumXY += x * y;
    sumX2 += x * x;
    sumY += y;
    sumX += x;
  });

  const n = studies.length;
  const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
  const intercept = (sumY - slope * sumX) / n;
  const seIntercept = Math.abs(intercept) / 2; // Simplified approximation
  const t = intercept / seIntercept;
  const pValue = n > 3 ? Math.min(1, 2 * Math.exp(-0.7 * Math.abs(t))) : 1; // Very rough approximation

  // Build text funnel plot
  const width = 50;
  const height = 12;
  const minX = -0.8, maxX = 0.4;
  const minY = 0, maxY = 0.2;

  const getXPos = (logRR) => Math.round(((logRR - minX) / (maxX - minX)) * width);
  const getYPos = (se) => Math.round((1 - (se - minY) / (maxY - minY)) * height);

  let grid = Array(height + 1).fill().map(() => Array(width + 1).fill(' '));

  // Add reference line
  const refPos = getXPos(pooledLogRR);
  for (let y = 0; y <= height; y++) {
    if (refPos >= 0 && refPos <= width) grid[y][refPos] = '‚îÇ';
  }

  // Add studies
  studies.forEach((s, i) => {
    const x = getXPos(s.logRR);
    const y = getYPos(s.se);
    if (x >= 0 && x <= width && y >= 0 && y <= height) {
      grid[y][x] = String.fromCharCode(65 + i); // A, B, C, etc.
    }
  });

  let funnelText = `
<strong>Funnel Plot</strong>

EE (precision)
${minY.toFixed(2)} ‚îå${'‚îÄ'.repeat(width)}‚îê
`;

  for (let y = 0; y <= height; y++) {
    const seVal = minY + (1 - y/height) * (maxY - minY);
    const label = y % 4 === 0 ? seVal.toFixed(2) : '    ';
    funnelText += `${label} ‚îÇ${grid[y].join('')}‚îÇ\n`;
  }

  funnelText += `${maxY.toFixed(2)} ‚îî${'‚îÄ'.repeat(width)}‚îò
      ${minX.toFixed(1)}${' '.repeat(Math.round(width/2) - 6)}0.0${' '.repeat(Math.round(width/2) - 6)}${maxX.toFixed(1)}
                    log(RR)

<strong>Leyenda:</strong> ${studies.map((s, i) => `${String.fromCharCode(65 + i)}=${s.name}`).join(', ')}
Linea de referencia en log(RR) combinado = ${pooledLogRR.toFixed(3)}

<strong>Prueba de Egger para Asimetria del Funnel Plot:</strong>
Intercepto = ${intercept.toFixed(3)}
${Math.abs(intercept) > 1 ? '‚ö†Ô∏è Asimetria detectada (intercepto se desvia de 0)' : '‚úì Sin evidencia fuerte de asimetria'}

<strong>Interpretacion:</strong>
${Math.abs(intercept) > 1.5 ?
  'La asimetria del funnel sugiere posible sesgo de publicacion, efectos de estudio pequeno, o heterogeneidad. Compara ensayos registrados vs publicados.' :
  Math.abs(intercept) > 0.8 ?
  'Alguna asimetria presente. Podria ser sesgo de publicacion u otros efectos de estudio pequeno. Interpretar con precaucion.' :
  'El funnel aparece razonablemente simetrico. Evidencia limitada de sesgo de publicacion (aunque las pruebas tienen bajo poder con pocos estudios).'}

<strong>Precaucion:</strong> Con ${n} estudios, las pruebas estadisticas para asimetria tienen poder limitado.
La inspeccion visual y comparacion con registros de ensayos son mas informativos.
  `;

  const output = document.getElementById('funnel-output');
  output.style.display = 'block';
  output.innerHTML = `<pre style="font-family: monospace; font-size: 0.75rem; overflow-x: auto;">${funnelText}</pre>`;

  awardPoints(30, 'Funnel plot generado');
  trackToolUse('funnel-plot');
}

function calculateGRADE() {
  const outcome = document.getElementById('grade-outcome').value;
  const design = document.getElementById('grade-design').value;
  const rob = document.getElementById('grade-rob').checked;
  const incon = document.getElementById('grade-incon').checked;
  const indir = document.getElementById('grade-indir').checked;
  const imprec = document.getElementById('grade-imprec').checked;
  const pub = document.getElementById('grade-pub').checked;

  let level = design === 'rct' ? 4 : 2; // RCTs start HIGH (4), obs starts LOW (2)
  const downgrades = [];

  if (rob) { level--; downgrades.push('Riesgo de sesgo (-1)'); }
  if (incon) { level--; downgrades.push('Inconsistencia (-1)'); }
  if (indir) { level--; downgrades.push('Indirectividad (-1)'); }
  if (imprec) { level--; downgrades.push('Imprecision (-1)'); }
  if (pub) { level--; downgrades.push('Sesgo de publicacion (-1)'); }

  level = Math.max(1, level); // Minimo es MUY BAJA (1)

  const levels = {
    4: { name: 'ALTA', symbol: '‚äï‚äï‚äï‚äï', meaning: 'Muy confiado en la estimacion del efecto' },
    3: { name: 'MODERADA', symbol: '‚äï‚äï‚äï‚óã', meaning: 'Moderadamente confiado; el efecto verdadero probablemente cercano' },
    2: { name: 'BAJA', symbol: '‚äï‚äï‚óã‚óã', meaning: 'Confianza limitada; el efecto verdadero puede diferir sustancialmente' },
    1: { name: 'MUY BAJA', symbol: '‚äï‚óã‚óã‚óã', meaning: 'Muy poca confianza; el efecto verdadero probablemente muy diferente' }
  };

  const result = levels[level];

  const output = document.getElementById('grade-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Evaluacion de Certeza GRADE</strong>

Desenlace: ${outcome}
Nivel inicial: ${design === 'rct' ? 'ALTA (ECAs)' : 'BAJA (Observacional)'}

<strong>Reducciones aplicadas:</strong>
${downgrades.length > 0 ? downgrades.map(d => '‚Ä¢ ' + d).join('\n') : '‚Ä¢ Ninguna'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
CERTEZA FINAL: ${result.symbol} ${result.name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

<strong>Que significa esto:</strong>
${result.meaning}

<strong>Para la practica clinica:</strong>
${level === 4 ? 'Confianza fuerte en la estimacion. Las guias pueden hacer recomendaciones fuertes.' :
  level === 3 ? 'Confianza moderada. Recomendaciones posibles pero pueden cambiar con evidencia futura.' :
  level === 2 ? 'Confianza baja. Las recomendaciones deben ser debiles/condicionales. Se necesita mas investigacion.' :
  'Confianza muy baja. Cualquier estimacion es muy incierta. Las decisiones deben considerar los valores del paciente y el contexto fuertemente.'}
  `;

  awardPoints(25, 'Evaluacion GRADE completada');
  trackToolUse('grade-builder');
}

function calculatePRISMA() {
  const items = document.querySelectorAll('.prisma-item:checked').length;
  const total = document.querySelectorAll('.prisma-item').length;
  const pct = Math.round((items / total) * 100);

  const output = document.getElementById('prisma-checklist-output');
  output.style.display = 'block';
  output.innerHTML = `
<strong>Cumplimiento PRISMA 2020</strong>

Items completados: ${items}/${total}
Completitud: ${pct}%

${'‚ñà'.repeat(Math.round(pct/5))}${'‚ñë'.repeat(20 - Math.round(pct/5))} ${pct}%

<strong>Evaluacion:</strong>
${pct >= 90 ? '‚úì Excelente reporte. Cumple estandares PRISMA.' :
  pct >= 70 ? '‚ö†Ô∏è Buen reporte con algunas brechas. Considera abordar items faltantes.' :
  pct >= 50 ? '‚ö†Ô∏è Reporte moderado. Varios items clave faltantes.' :
  '‚ö†Ô∏è Brechas sustanciales en el reporte. Revisa las guias PRISMA.'}

<strong>Items criticos para reproducibilidad:</strong>
‚Ä¢ Estrategia de busqueda completa (al menos una base de datos)
‚Ä¢ Diagrama de flujo PRISMA
‚Ä¢ Evaluaciones de riesgo de sesgo
‚Ä¢ Medidas de efecto y metodos de sintesis

Faltar estos items limita severamente la capacidad de otros para verificar o replicar tu revision.
  `;

  awardPoints(20, 'Lista PRISMA evaluada');
  trackToolUse('prisma-checklist');
}

// ============================================================
// SCENARIOS
// ============================================================

function renderScenario(scenario) {
  const completed = gameState.scenariosCompleted[scenario.id];

  return `
    <div class="scenario-panel" id="scenario-${scenario.id}">
      <div class="scenario-header">
        <span class="scenario-icon">üîÄ</span>
        <span class="scenario-title">${scenario.title}</span>
      </div>
      <div class="scenario-situation">${scenario.situation}</div>
      <div class="scenario-question">${scenario.question}</div>
      <div class="scenario-choices">
        ${scenario.choices.map(c => `
          <div class="scenario-choice ${completed === c.id ? (c.id === scenario.correct ? 'correct' : 'incorrect') : ''} ${completed && c.id === scenario.correct ? 'correct' : ''}"
               onclick="${completed ? '' : `selectScenario('${scenario.id}', '${c.id}')`}"
               style="${completed ? 'pointer-events: none;' : ''}">
            <span class="choice-letter">${c.id.toUpperCase()}</span>
            <span>${c.text}</span>
          </div>
        `).join('')}
      </div>
      <div class="scenario-consequence ${completed ? 'visible' : ''} ${completed ? scenario.choices.find(c => c.id === completed)?.consequence : ''}" id="consequence-${scenario.id}">
        ${completed ? scenario.choices.find(c => c.id === completed)?.result : ''}
      </div>
    </div>
  `;
}

function selectScenario(scenarioId, choiceId) {
  // Find the scenario
  let scenario;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'scenario' && s.content.id === scenarioId) {
        scenario = s.content;
      }
    });
  });

  if (!scenario || gameState.scenariosCompleted[scenarioId]) return;

  gameState.scenariosCompleted[scenarioId] = choiceId;

  const choice = scenario.choices.find(c => c.id === choiceId);
  const isCorrect = choiceId === scenario.correct;

  // Update UI
  const choices = document.querySelectorAll(`#scenario-${scenarioId} .scenario-choice`);
  choices.forEach(el => {
    el.style.pointerEvents = 'none';
    const letter = el.querySelector('.choice-letter').textContent.toLowerCase();
    if (letter === scenario.correct) {
      el.classList.add('correct');
    } else if (letter === choiceId) {
      el.classList.add('incorrect');
    }
  });

  const consequence = document.getElementById(`consequence-${scenarioId}`);
  consequence.textContent = choice.result;
  consequence.className = `scenario-consequence visible ${choice.consequence}`;

  // Award points
  if (isCorrect) {
    awardPoints(30, 'Decision de escenario correcta');
  } else {
    awardPoints(10, 'Escenario intentado');
  }

  saveProgress();
}

// ============================================================
// DECISION TREES (Interactive Branching Narratives)
// ============================================================

function renderDecisionTree(tree) {
  const treeState = gameState.decisionTrees || {};
  const currentPath = treeState[tree.id] || { currentNode: 'start', history: [] };

  // Build path history display
  const pathHistory = currentPath.history.length > 0 ? `
    <div class="path-history" id="path-history-${tree.id}">
      <span class="path-step">Start</span>
      ${currentPath.history.map((step, i) => {
        const node = tree.nodes[step.node] || tree.nodes.find(n => n.id === step.node);
        const branchText = node && node.branches ?
          (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
          step.branch;
        return `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
      }).join('')}
    </div>
  ` : '';

  // Tree controls (undo and restart)
  const treeControls = currentPath.history.length > 0 ? `
    <div class="tree-controls" id="tree-controls-${tree.id}">
      <button class="undo-btn" onclick="undoDecisionBranch('${tree.id}')" aria-label="Undo last choice">
        ‚Ü∂ Undo Last Choice
      </button>
      <button class="restart-btn" onclick="resetDecisionTree('${tree.id}')" aria-label="Start over">
        ‚Ü©Ô∏è Start Over
      </button>
    </div>
  ` : '';

  return `
    <div class="decision-tree" id="tree-${tree.id}" role="region" aria-label="Decision scenario: ${tree.title}">
      <div class="scenario-header">
        <span class="scenario-icon" aria-hidden="true">üå≥</span>
        <span class="scenario-title">${tree.title}</span>
      </div>
      ${tree.realCase ? `
        <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(197,48,48,0.1); border-left: 3px solid var(--red); border-radius: 0 8px 8px 0;">
          <strong style="color: var(--red);">üìö Real Case:</strong>
          <span style="color: rgba(255,255,255,0.9);">${tree.realCase}</span>
        </div>
      ` : ''}
      <div class="scenario-situation" style="margin-bottom: 1rem;">${tree.scenario || tree.situation}</div>

      ${pathHistory}

      <div id="tree-nodes-${tree.id}">
        ${renderDecisionNode(tree, currentPath.currentNode, tree.id)}
      </div>

      ${treeControls}
    </div>
  `;
}

function renderDecisionNode(tree, nodeId, treeId) {
  // Handle both array-style and object-style node storage
  let node;
  if (Array.isArray(tree.nodes)) {
    node = tree.nodes.find(n => n.id === nodeId);
  } else {
    node = tree.nodes[nodeId];
  }

  if (!node) return '<p style="color: var(--red);">Node not found: ' + nodeId + '</p>';

  // Check if this is an ending node (has isEnding flag or type === 'outcome')
  const isEnding = node.isEnding || node.type === 'outcome';
  const outcome = node.outcome || node.consequence;

  if (isEnding) {
    return `
      <div class="decision-node ${outcome === 'good' ? 'completed' : outcome === 'bad' ? 'wrong' : 'active'}">
        <div class="decision-question" style="color: ${outcome === 'good' ? 'var(--green)' : outcome === 'bad' ? 'var(--red)' : 'var(--gold)'};">
          ${outcome === 'good' ? '‚úì Good Outcome' : outcome === 'bad' ? '‚úó Poor Outcome' : '‚óã Neutral Outcome'}
        </div>
        ${node.situation ? `<p style="color: rgba(255,255,255,0.9); line-height: 1.7; margin-bottom: 1rem;">${node.situation}</p>` : ''}
        ${node.text ? `<p style="color: rgba(255,255,255,0.9); line-height: 1.7; margin-bottom: 1rem;">${node.text}</p>` : ''}
        ${node.lesson ? `
          <div style="margin-top: 1rem; padding: 1rem; background: rgba(212,175,55,0.1); border-left: 3px solid var(--gold); border-radius: 0 8px 8px 0;">
            <strong style="color: var(--gold);">üí° Lesson:</strong>
            <p style="color: rgba(255,255,255,0.9); margin-top: 0.5rem; line-height: 1.6;">${node.lesson}</p>
          </div>
        ` : ''}
        ${node.realCase ? `
          <div style="margin-top: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px; font-size: 0.9rem;">
            <strong style="color: var(--gold);">üìö Real Case:</strong>
            <span style="color: rgba(255,255,255,0.8);">${node.realCase}</span>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Regular decision node with branches
  return `
    <div class="decision-node active" role="group" aria-label="Decision point">
      ${node.situation ? `<p style="color: rgba(255,255,255,0.85); margin-bottom: 1rem; line-height: 1.6;">${node.situation}</p>` : ''}
      <div class="decision-question">${node.question}</div>
      <div class="decision-branches" role="list">
        ${(node.branches || []).map((branch, idx) => `
          <button class="decision-branch" role="listitem"
                  onclick="selectDecisionBranch('${treeId}', '${nodeId}', '${branch.id}', '${branch.nextNode}')"
                  aria-label="Option ${idx + 1}: ${branch.text}">
            <span class="branch-arrow" aria-hidden="true">${String.fromCharCode(65 + idx)}</span>
            <span>${branch.text}</span>
          </button>
        `).join('')}
      </div>
    </div>
  `;
}

function selectDecisionBranch(treeId, currentNodeId, branchId, nextNodeId) {
  // Find the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (!tree) return;

  // Update state
  if (!gameState.decisionTrees) gameState.decisionTrees = {};
  if (!gameState.decisionTrees[treeId]) {
    gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  }

  const treeState = gameState.decisionTrees[treeId];
  treeState.history.push({ node: currentNodeId, branch: branchId });
  treeState.currentNode = nextNodeId;

  // Check if outcome (handle both array and object node storage)
  let nextNode;
  if (Array.isArray(tree.nodes)) {
    nextNode = tree.nodes.find(n => n.id === nextNodeId);
  } else {
    nextNode = tree.nodes[nextNodeId];
  }

  const isEnding = nextNode && (nextNode.isEnding || nextNode.type === 'outcome');
  const outcome = nextNode ? (nextNode.outcome || nextNode.consequence) : null;

  if (isEnding) {
    if (outcome === 'good') {
      awardPoints(40, 'Camino de decision optimo');
    } else if (outcome === 'neutral') {
      awardPoints(20, 'Camino de decision aceptable');
    } else {
      awardPoints(10, 'Arbol de decision completado');
    }
  }

  // Re-render the node area
  const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
  if (nodesContainer) {
    nodesContainer.innerHTML = renderDecisionNode(tree, nextNodeId, treeId);
  }

  // Update or add path history
  const treeContainer = document.getElementById(`tree-${treeId}`);
  let pathHistory = document.getElementById(`path-history-${treeId}`);

  if (!pathHistory && treeContainer) {
    pathHistory = document.createElement('div');
    pathHistory.className = 'path-history';
    pathHistory.id = `path-history-${treeId}`;
    const scenarioSituation = treeContainer.querySelector('.scenario-situation');
    if (scenarioSituation) {
      scenarioSituation.after(pathHistory);
    }
  }

  if (pathHistory) {
    let pathHtml = '<span class="path-step">Start</span>';
    treeState.history.forEach(step => {
      let node;
      if (Array.isArray(tree.nodes)) {
        node = tree.nodes.find(n => n.id === step.node);
      } else {
        node = tree.nodes[step.node];
      }
      const branchText = node && node.branches ?
        (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
        step.branch;
      pathHtml += `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
    });
    pathHistory.innerHTML = pathHtml;
  }

  // Update or add tree controls
  let treeControls = document.getElementById(`tree-controls-${treeId}`);
  if (!treeControls && treeContainer) {
    treeControls = document.createElement('div');
    treeControls.className = 'tree-controls';
    treeControls.id = `tree-controls-${treeId}`;
    treeControls.innerHTML = `
      <button class="undo-btn" onclick="undoDecisionBranch('${treeId}')" aria-label="Undo last choice">
        ‚Ü∂ Undo Last Choice
      </button>
      <button class="restart-btn" onclick="resetDecisionTree('${treeId}')" aria-label="Start over">
        ‚Ü©Ô∏è Start Over
      </button>
    `;
    treeContainer.appendChild(treeControls);
  }

  saveProgress();
}

function resetDecisionTree(treeId) {
  if (gameState.decisionTrees && gameState.decisionTrees[treeId]) {
    gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  }

  // Find and re-render the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (tree) {
    const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
    if (nodesContainer) {
      nodesContainer.innerHTML = renderDecisionNode(tree, 'start', treeId);
    }

    // Remove path history
    const pathHistory = document.getElementById(`path-history-${treeId}`);
    if (pathHistory) pathHistory.remove();

    // Remove tree controls
    const treeControls = document.getElementById(`tree-controls-${treeId}`);
    if (treeControls) treeControls.remove();

    // Remove any standalone restart button
    const restartBtn = document.querySelector(`#tree-${treeId} .restart-btn`);
    if (restartBtn) restartBtn.remove();
  }

  saveProgress();
}

function undoDecisionBranch(treeId) {
  if (!gameState.decisionTrees || !gameState.decisionTrees[treeId]) return;

  const treeState = gameState.decisionTrees[treeId];
  if (treeState.history.length === 0) return;

  // Pop the last decision
  const lastStep = treeState.history.pop();
  treeState.currentNode = lastStep.node;

  // Find and re-render the tree
  let tree;
  modules.forEach(m => {
    m.slides.forEach(s => {
      if (s.type === 'decision-tree' && s.content.id === treeId) {
        tree = s.content;
      }
    });
  });

  if (tree) {
    const nodesContainer = document.getElementById(`tree-nodes-${treeId}`);
    if (nodesContainer) {
      nodesContainer.innerHTML = renderDecisionNode(tree, treeState.currentNode, treeId);
    }

    // Update path history
    const pathHistory = document.getElementById(`path-history-${treeId}`);
    if (pathHistory) {
      if (treeState.history.length === 0) {
        pathHistory.remove();
        // Also remove tree controls
        const treeControls = document.getElementById(`tree-controls-${treeId}`);
        if (treeControls) treeControls.remove();
      } else {
        // Rebuild path history
        let pathHtml = '<span class="path-step">Start</span>';
        treeState.history.forEach(step => {
          let node;
          if (Array.isArray(tree.nodes)) {
            node = tree.nodes.find(n => n.id === step.node);
          } else {
            node = tree.nodes[step.node];
          }
          const branchText = node && node.branches ?
            (node.branches.find(b => b.id === step.branch) || {}).text || step.branch :
            step.branch;
          pathHtml += `<span class="path-step" title="${branchText}">${branchText.substring(0, 25)}${branchText.length > 25 ? '...' : ''}</span>`;
        });
        pathHistory.innerHTML = pathHtml;
      }
    }
  }

  saveProgress();
}

// ============================================================
// QUIZZES
// ============================================================

function renderQuiz(quiz, slideIdx) {
  const quizId = `quiz-${currentModule}-${slideIdx}`;

  return `
    <div class="quiz-container" id="${quizId}" role="group" aria-labelledby="${quizId}-question">
      <div class="quiz-question" id="${quizId}-question">${quiz.question}</div>
      <div class="quiz-options" role="radiogroup" aria-label="Answer choices">
        ${quiz.options.map((opt, idx) => `
          <button class="quiz-option" role="radio" aria-checked="false"
                  onclick="selectQuizOption('${quizId}', '${opt.id}', ${opt.correct})"
                  data-option-id="${opt.id}">
            <span class="option-letter" aria-hidden="true">${String.fromCharCode(65 + idx)}.</span>
            ${opt.text}
          </button>
        `).join('')}
      </div>
      <div class="quiz-feedback" id="${quizId}-feedback" role="alert" aria-live="polite" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 8px;"></div>
    </div>
  `;
}

function selectQuizOption(quizId, optionId, isCorrect) {
  const container = document.getElementById(quizId);
  const options = container.querySelectorAll('.quiz-option');
  const feedback = document.getElementById(`${quizId}-feedback`);

  // Track the quiz answer
  gameState.quizAnswers[quizId] = {
    selected: optionId,
    correct: isCorrect,
    timestamp: Date.now()
  };

  // Disable all options and update ARIA
  options.forEach(opt => {
    opt.disabled = true;
    opt.setAttribute('aria-disabled', 'true');
  });

  // Find the quiz data
  let module = modules[currentModule];
  let quiz;
  module.slides.forEach(s => {
    if (s.type === 'quiz') quiz = s.content;
  });

  if (quiz) {
    // Mark options using data-option-id attribute matching
    options.forEach((opt, index) => {
      const thisOptData = quiz.options[index];
      const thisOptId = opt.getAttribute('data-option-id') || ['a', 'b', 'c', 'd'][index];

      if (thisOptId === optionId) {
        // This is the selected option
        opt.classList.add(isCorrect ? 'correct' : 'incorrect');
        opt.setAttribute('aria-checked', 'true');
      }

      // Always show the correct answer
      if (thisOptData && thisOptData.correct) {
        opt.classList.add('correct');
      }
    });

    feedback.innerHTML = `
      <strong>${isCorrect ? '‚úì Correct!' : '‚úó Not quite.'}</strong><br><br>
      ${quiz.explanation}
    `;
    feedback.style.display = 'block';
    feedback.style.background = isCorrect ? 'rgba(34,197,94,0.15)' : 'rgba(239,68,68,0.1)';
    feedback.style.border = `1px solid ${isCorrect ? 'var(--green)' : 'var(--red)'}`;
  }

  if (isCorrect) {
    awardPoints(20, 'Quiz correcto');
  }

  checkBadges();
  saveProgress();
}

// ============================================================
// NAVIGATION
// ============================================================

function goToModule(moduleId) {
  currentModule = moduleId;
  currentSlide = 0;
  renderSlides();
  updateModuleList();
  updateSlideNav();
  document.getElementById('moduleIndicator').textContent = `Module ${moduleId}: ${modules[moduleId].title}`;
}

function goToNextModule() {
  if (currentModule < modules.length - 1) {
    markModuleComplete(currentModule);
    goToModule(currentModule + 1);
  }
}

function nextSlide() {
  const module = modules[currentModule];
  if (currentSlide < module.slides.length - 1) {
    currentSlide++;
    updateSlideDisplay();
  } else if (currentModule < modules.length - 1) {
    markModuleComplete(currentModule);
    goToModule(currentModule + 1);
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideDisplay();
  } else if (currentModule > 0) {
    goToModule(currentModule - 1);
    currentSlide = modules[currentModule].slides.length - 1;
    updateSlideDisplay();
  }
}

function updateSlideDisplay() {
  const slides = document.querySelectorAll('.slide');
  slides.forEach((s, i) => {
    s.classList.toggle('active', i === currentSlide);
  });
  updateSlideNav();
}

function updateSlideNav() {
  const module = modules[currentModule];
  document.getElementById('slideCounter').textContent = `${currentSlide + 1} / ${module.slides.length}`;
  document.getElementById('prevBtn').disabled = currentModule === 0 && currentSlide === 0;
  document.getElementById('nextBtn').textContent =
    currentSlide === module.slides.length - 1 && currentModule < modules.length - 1 ? 'Siguiente Modulo ‚Üí' : 'Siguiente ‚Üí';
}

function updateModuleList() {
  document.querySelectorAll('.module-item').forEach(el => {
    const isActive = parseInt(el.dataset.module) === currentModule;
    el.classList.toggle('active', isActive);
    if (isActive) {
      el.setAttribute('aria-current', 'true');
    } else {
      el.removeAttribute('aria-current');
    }
  });
}

// ============================================================
// GAMIFICATION
// ============================================================

function awardPoints(points, reason) {
  const oldPoints = gameState.points;
  gameState.points += points;
  updateSidebarPoints();
  showToast(`+${points} pts`, reason);
  checkLevelUp(oldPoints, gameState.points);
  checkBadges();
  saveProgress();
}

function trackToolUse(toolId) {
  if (!gameState.toolsUsed.includes(toolId)) {
    gameState.toolsUsed.push(toolId);
    checkBadges();
  }
  saveProgress();
}

function markModuleComplete(moduleId) {
  if (!gameState.modulesCompleted.includes(moduleId)) {
    gameState.modulesCompleted.push(moduleId);
    awardPoints(100, 'Modulo completado');
    renderModuleList();
    checkBadges();
    checkCourseCompletion();
  }
  saveProgress();
  updateProgress();
}

function updateSidebarPoints() {
  document.getElementById('sidebarPoints').textContent = gameState.points + ' pts';
}

function updateProgress() {
  const pct = Math.round((gameState.modulesCompleted.length / modules.length) * 100);
  document.getElementById('progressPercent').textContent = pct + '%';
  document.getElementById('progressFill').style.width = pct + '%';
}

// ============================================================
// TOAST NOTIFICATIONS
// ============================================================

function showToast(title, message, type = 'points') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}-toast`;
  toast.innerHTML = `<span>${title}</span><span style="opacity:0.8;font-weight:400;"> ${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// ============================================================
// NOTIFICATION MODAL
// ============================================================

function showNotification(title, message) {
  document.getElementById('notificationTitle').textContent = title;
  document.getElementById('notificationMessage').textContent = message;
  document.getElementById('notificationModal').classList.add('active');
}

function closeNotification() {
  document.getElementById('notificationModal').classList.remove('active');
}

// ============================================================
// BADGE SYSTEM
// ============================================================

function checkBadges() {
  let newBadgesEarned = false;
  badges.forEach(badge => {
    if (!gameState.earnedBadges.includes(badge.id) && badge.condition()) {
      gameState.earnedBadges.push(badge.id);
      showToast(`${badge.icon} ${badge.name}`, 'Badge earned!', 'badge');
      newBadgesEarned = true;
    }
  });
  if (newBadgesEarned) {
    saveProgress();
  }
}

function renderBadges() {
  const grid = document.getElementById('badgeGrid');
  grid.innerHTML = badges.map(badge => {
    const earned = gameState.earnedBadges.includes(badge.id);
    return `
      <div class="badge ${earned ? 'earned' : ''}" title="${badge.description}">
        <span>${badge.icon}</span> ${badge.name}
      </div>
    `;
  }).join('');
}

// ============================================================
// LEVEL SYSTEM
// ============================================================

function getCurrentLevel() {
  let currentLevel = levels[0];
  for (const level of levels) {
    if (gameState.points >= level.minPoints) {
      currentLevel = level;
    }
  }
  return currentLevel;
}

function checkLevelUp(oldPoints, newPoints) {
  const oldLevel = levels.filter(l => oldPoints >= l.minPoints).pop();
  const newLevel = levels.filter(l => newPoints >= l.minPoints).pop();
  if (newLevel && oldLevel && newLevel.name !== oldLevel.name) {
    showToast(`‚¨ÜÔ∏è Subiste de Nivel!`, `Ahora eres ${newLevel.name}`, 'level');
    updateLevelBadge();
  }
}

function updateLevelBadge() {
  const level = getCurrentLevel();
  document.getElementById('levelBadge').textContent = `Nivel: ${level.name}`;
}

// ============================================================
// DASHBOARD
// ============================================================

function openDashboard() {
  document.getElementById('totalPoints').textContent = gameState.points;
  document.getElementById('modulesCompleted').textContent = `${gameState.modulesCompleted.length}/${modules.length}`;
  document.getElementById('toolsUsed').textContent = gameState.toolsUsed.length;
  updateLevelBadge();
  renderBadges();
  const dashboard = document.getElementById('progressDashboard');
  dashboard.classList.add('open');
  // Focus trap
  const closeBtn = dashboard.querySelector('.close-btn');
  if (closeBtn) closeBtn.focus();
}

function closeDashboard() {
  document.getElementById('progressDashboard').classList.remove('open');
}

function startDailyReview() {
  // Simple spaced repetition - show random quiz from completed modules
  if (gameState.modulesCompleted.length < 2) {
    showNotification('Repaso Diario Bloqueado', 'Completa al menos 2 modulos para desbloquear el Repaso Diario!');
    return;
  }
  const completedWithQuiz = gameState.modulesCompleted.filter(id => {
    return modules[id] && modules[id].slides.some(s => s.type === 'quiz');
  });
  if (completedWithQuiz.length === 0) {
    showNotification('Sin Cuestionarios Aun', 'No hay cuestionarios disponibles para repasar todavia. Sigue aprendiendo!');
    return;
  }
  const randomModuleId = completedWithQuiz[Math.floor(Math.random() * completedWithQuiz.length)];
  goToModule(randomModuleId);
  // Navigate to quiz slide
  const quizIndex = modules[randomModuleId].slides.findIndex(s => s.type === 'quiz');
  if (quizIndex >= 0) {
    currentSlide = quizIndex;
    renderSlides();
  }
}

// ============================================================
// SIDEBAR TOGGLE (Mobile)
// ============================================================

function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const hamburger = document.querySelector('.hamburger');
  const overlay = document.querySelector('.sidebar-overlay');

  sidebar.classList.toggle('open');
  hamburger.classList.toggle('active');
  overlay.classList.toggle('active');

  const isOpen = sidebar.classList.contains('open');
  hamburger.setAttribute('aria-expanded', isOpen);
}

// ============================================================
// TOOL LIBRARY
// ============================================================

const toolLibraryItems = [
  { id: 'pico-builder', name: 'Constructor PICO', description: 'Estructura tu pregunta de investigacion con Poblacion, Intervencion, Comparador, Resultado', module: 1 },
  { id: 'search-builder', name: 'Constructor de Estrategia de Busqueda', description: 'Crea cadenas de busqueda para bases de datos con operadores booleanos', module: 3 },
  { id: 'prisma-flow', name: 'Generador de Flujo PRISMA', description: 'Crea diagramas de flujo PRISMA 2020 para tu revision', module: 4 },
  { id: 'extraction-form', name: 'Formulario de Extraccion de Datos', description: 'Formularios estandarizados para extraer datos de estudios', module: 5 },
  { id: 'rob2-tool', name: 'Evaluacion RoB 2', description: 'Evalua el riesgo de sesgo usando la herramienta Cochrane RoB 2', module: 6 },
  { id: 'effect-calculator', name: 'Calculadora de Tamano de Efecto', description: 'Calcula RR, OR, DME y otros tamanos de efecto', module: 7 },
  { id: 'forest-plot', name: 'Constructor de Grafico Forest', description: 'Graficos forest interactivos con efectos fijos/aleatorios', module: 8 },
  { id: 'heterogeneity-explorer', name: 'Explorador de Heterogeneidad', description: 'Visualiza I¬≤, œÑ¬≤ e intervalos de prediccion', module: 9 },
  { id: 'funnel-plot', name: 'Constructor de Grafico de Embudo', description: 'Graficos de embudo con prueba de Egger para sesgo de publicacion', module: 10 },
  { id: 'grade-builder', name: 'Evaluacion GRADE', description: 'Construye tablas de Resumen de Hallazgos con calificaciones GRADE', module: 11 },
  { id: 'prisma-checklist', name: 'Lista de Verificacion PRISMA', description: 'Lista de verificacion completa de reporte PRISMA 2020', module: 12 }
];

function openToolLibrary() {
  const modal = document.getElementById('toolLibraryModal');
  const grid = document.getElementById('toolLibraryGrid');

  grid.innerHTML = toolLibraryItems.map(tool => `
    <div class="tool-library-item" onclick="goToTool('${tool.id}', ${tool.module})" role="button" tabindex="0" aria-label="Abrir ${tool.name}">
      <h4>${tool.name}</h4>
      <p>${tool.description}</p>
      <small style="color: var(--gold); margin-top: 0.5rem; display: block;">Modulo ${tool.module}</small>
    </div>
  `).join('');

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';

  // Focus trap
  modal.querySelector('.close-btn').focus();
}

function closeToolLibrary() {
  const modal = document.getElementById('toolLibraryModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function goToTool(toolId, moduleId) {
  closeToolLibrary();
  goToModule(moduleId);
  // Find the tool slide
  const toolIndex = modules[moduleId].slides.findIndex(s => s.type === 'tool' && s.content.id === toolId);
  if (toolIndex >= 0) {
    currentSlide = toolIndex;
    renderSlides();
  }
}

// ============================================================
// GLOSSARY
// ============================================================

const glossaryTerms = {
  'I¬≤': 'Porcentaje de variabilidad en las estimaciones de efecto debido a heterogeneidad en lugar de error de muestreo. 0% = sin heterogeneidad, 75%+ = alta heterogeneidad.',
  'œÑ¬≤ (tau-cuadrado)': 'Varianza entre estudios en meta-analisis de efectos aleatorios. Mide la heterogeneidad absoluta en las mismas unidades que el tamano de efecto al cuadrado.',
  'Intervalo de Prediccion': 'Rango donde el 95% de los efectos verdaderos en estudios futuros caerian. A diferencia del IC (efecto promedio), el IP muestra variabilidad entre entornos.',
  'Razon de Riesgo (RR)': 'Razon del riesgo en tratamiento vs control: RR = (a/n‚ÇÅ) / (c/n‚ÇÇ). RR < 1 indica que el tratamiento reduce el riesgo.',
  'Razon de Momios (OR)': 'Razon de momios: OR = (a√ód) / (b√óc). Se usa cuando el resultado es comun o para estudios de casos y controles.',
  'DME': 'Diferencia de Medias Estandarizada (d de Cohen). Tamano de efecto para resultados continuos en diferentes escalas: DME = (M‚ÇÅ-M‚ÇÇ) / DE_combinada.',
  'PICO': 'Poblacion, Intervencion, Comparador, Resultado. Marco para estructurar preguntas de revision sistematica.',
  'RoB 2': 'Herramienta Cochrane de Riesgo de Sesgo 2. Evalua el sesgo en 5 dominios: aleatorizacion, desviaciones, datos faltantes, medicion, seleccion.',
  'GRADE': 'Clasificacion de Recomendaciones, Evaluacion, Desarrollo y Valoraciones. Marco para calificar la certeza en la evidencia.',
  'Prueba de Egger': 'Prueba estadistica para asimetria del grafico de embudo. Valor p significativo (<0.1) sugiere posible sesgo de publicacion.',
  'Sesgo de Publicacion': 'Tendencia a publicar resultados positivos/significativos mas que resultados negativos/nulos, distorsionando la sintesis de evidencia.',
  'Efecto Fijo': 'Modelo que asume un tamano de efecto verdadero unico. Toda la variabilidad es error de muestreo. Pondera solo por varianza inversa.',
  'Efectos Aleatorios': 'Modelo que asume distribucion de efectos verdaderos. Agrega varianza entre estudios (œÑ¬≤) a los pesos. ICs mas conservadores.',
  'NNT': 'Numero Necesario a Tratar. Numero de pacientes a tratar para un resultado bueno adicional: NNT = 1/RRA.',
  'Grafico Forest': 'Representacion grafica de resultados de meta-analisis mostrando efectos individuales de estudios, ICs, pesos y estimacion combinada.'
};

function openGlossary() {
  const terms = Object.entries(glossaryTerms).map(([term, def]) =>
    `<div style="margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
      <strong style="color: var(--gold);">${term}</strong>
      <p style="margin-top: 0.5rem; color: rgba(255,255,255,0.8); font-size: 0.9rem;">${def}</p>
    </div>`
  ).join('');

  const modal = document.createElement('div');
  modal.className = 'tool-library-modal active';
  modal.id = 'glossaryModal';
  modal.innerHTML = `
    <div class="tool-library-content" style="max-height: 80vh; overflow-y: auto;">
      <div class="tool-library-header">
        <h2>üìñ Glosario de Terminos</h2>
        <button class="close-btn" onclick="this.closest('.tool-library-modal').remove(); document.body.style.overflow='';">&times;</button>
      </div>
      <div>${terms}</div>
    </div>
  `;
  document.body.appendChild(modal);
  document.body.style.overflow = 'hidden';
}

// ============================================================
// CERTIFICATE
// ============================================================

function checkCourseCompletion() {
  // Check if all modules are completed
  if (gameState.modulesCompleted.length >= modules.length - 1) { // -1 for module 0
    showCertificate();
  }
}

function showCertificate() {
  const modal = document.getElementById('certificateModal');
  const dateEl = document.getElementById('certificateDate');
  const nameEl = document.getElementById('certificateName');

  // Get stored name or prompt
  let userName = localStorage.getItem('metaMethodsUserName_es');
  if (!userName) {
    userName = prompt('Felicitaciones por completar el curso! Ingresa tu nombre para el certificado:') || 'Participante del Curso';
    localStorage.setItem('metaMethodsUserName_es', userName);
  }

  nameEl.textContent = userName;
  dateEl.textContent = `Completado el ${new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}`;

  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeCertificate() {
  const modal = document.getElementById('certificateModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

function downloadCertificate() {
  // Create printable version
  const cert = document.querySelector('.certificate');
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
    <head>
      <title>Certificado del Curso de Metodos de Meta-Analisis</title>
      <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&display=swap" rel="stylesheet">
      <style>
        body { font-family: 'Source Sans Pro', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; background: #f5f5f5; }
        .certificate { background: linear-gradient(135deg, #FAF8F5, #F5F0E8); border: 8px solid #D4AF37; border-radius: 8px; padding: 3rem; max-width: 700px; text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
        .certificate::before { content: ''; position: absolute; inset: 8px; border: 2px solid #D4AF37; border-radius: 4px; pointer-events: none; }
        .certificate-title { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 2.5rem; color: #1E2761; margin-bottom: 0.5rem; }
        .certificate-subtitle { color: #718096; margin-bottom: 2rem; }
        .certificate-name { font-family: 'Cormorant Garamond', Georgia, serif; font-size: 2rem; color: #1E2761; margin: 1.5rem 0; padding: 0.5rem; border-bottom: 2px solid #D4AF37; display: inline-block; }
        .certificate-body { color: #2D3748; line-height: 1.6; margin-bottom: 1rem; }
        .certificate-date { color: #718096; margin-top: 2rem; }
        @media print { body { background: white; } .certificate { box-shadow: none; } }
      </style>
    </head>
    <body>
      ${cert.outerHTML.replace(/<div class="certificate-actions">[\s\S]*?<\/div>/, '')}
      <script>window.onload = function() { window.print(); }<\/script>
    </body>
    </html>
  `);
  printWindow.document.close();
}

// ============================================================
// PERSISTENCE
// ============================================================

function saveProgress() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      currentModule,
      currentSlide,
      gameState
    }));
  } catch (e) {
    console.log('Could not save progress');
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      // Restore game state with schema validation
      if (data.gameState) {
        gameState = {
          points: data.gameState.points || 0,
          earnedBadges: data.gameState.earnedBadges || [],
          toolsUsed: data.gameState.toolsUsed || [],
          modulesCompleted: data.gameState.modulesCompleted || [],
          scenariosCompleted: data.gameState.scenariosCompleted || {},
          decisionTrees: data.gameState.decisionTrees || {},
          quizAnswers: data.gameState.quizAnswers || {}
        };
      }
      // Restore position with bounds checking
      if (typeof data.currentModule === 'number' && data.currentModule >= 0 && data.currentModule < modules.length) {
        currentModule = data.currentModule;
      }
      if (typeof data.currentSlide === 'number' && data.currentSlide >= 0) {
        currentSlide = Math.min(data.currentSlide, modules[currentModule].slides.length - 1);
      }
      updateSidebarPoints();
      updateProgress();
    }
  } catch (e) {
    console.log('Could not load progress:', e);
  }
}

// ============================================================
// KEYBOARD NAVIGATION
// ============================================================

document.addEventListener('keydown', (e) => {
  // Handle Escape key to close modals
  if (e.key === 'Escape') {
    if (document.getElementById('progressDashboard').classList.contains('open')) {
      closeDashboard();
    }
    if (document.getElementById('notificationModal').classList.contains('active')) {
      closeNotification();
    }
    if (document.getElementById('toolLibraryModal').classList.contains('active')) {
      closeToolLibrary();
    }
    if (document.getElementById('certificateModal').classList.contains('active')) {
      closeCertificate();
    }
    return;
  }

  // Handle Enter/Space on module items
  if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('module-item')) {
    e.preventDefault();
    const moduleId = parseInt(e.target.dataset.module);
    if (!isNaN(moduleId)) {
      goToModule(moduleId);
    }
    return;
  }

  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

  if (e.key === 'ArrowRight') {
    nextSlide();
  } else if (e.key === 'ArrowLeft') {
    prevSlide();
  }
});
</script>
</body>
</html>
