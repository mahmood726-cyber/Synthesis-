<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Living Reviews: Future of the Field</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&amp;family=Source+Sans+Pro:wght@300;400;600;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root {
      --navy: #1E2761;
      --deep-navy: #141B3D;
      --gold: #D4AF37;
      --cream: #FAF8F5;
      --light-cream: #FFFFFF;
      --text: #2D3748;
      --light-text: #718096;
      --red: #C53030;
      --green: #22c55e;
      --teal: #0f766e;
      --purple: #7c3aed;
      --orange: #f59e0b;
      --transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      height: 100%;
      font-family: 'Source Sans Pro', sans-serif;
      background: var(--deep-navy);
      color: var(--cream);
    }

    .course-container { display: flex; height: 100vh; overflow: hidden; }

    /* Skip Link */
    .skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--gold);
      color: var(--navy);
      padding: 8px 16px;
      z-index: 10000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus { top: 0; }

    /* Sidebar */
    .sidebar {
      width: 300px;
      background: linear-gradient(180deg, var(--deep-navy) 0%, #0a0f1a 100%);
      border-right: 1px solid rgba(212,175,55,0.2);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }

    .sidebar-header {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      text-align: center;
    }
    .sidebar-header h1 {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .sidebar-header p {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }

    .stats-panel {
      padding: 1rem;
      background: rgba(212,175,55,0.1);
      border-bottom: 1px solid rgba(212,175,55,0.2);
    }
    .level-display {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .level-badge {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--gold), #f0c040);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 8px rgba(212,175,55,0.4);
    }
    .level-info { flex: 1; }
    .level-title { font-weight: 700; font-size: 0.9rem; color: var(--gold); }
    .level-subtitle { font-size: 0.7rem; color: rgba(255,255,255,0.6); }
    .xp-bar {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 0.5rem;
    }
    .xp-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      border-radius: 4px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .xp-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }
    @keyframes shimmer {
      to { left: 100%; }
    }
    .xp-text {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      text-align: right;
      margin-top: 0.25rem;
    }
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
    }
    .quick-stat {
      background: rgba(0,0,0,0.2);
      padding: 0.5rem;
      border-radius: 6px;
      text-align: center;
    }
    .quick-stat-value {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gold);
    }
    .quick-stat-label {
      font-size: 0.6rem;
      color: rgba(255,255,255,0.5);
    }

    .course-progress {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(212,175,55,0.2);
      background: rgba(0,0,0,0.2);
    }
    .course-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 0.35rem;
    }
    .course-progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      overflow: hidden;
    }
    .course-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--green), #22d3ee);
      border-radius: 3px;
      transition: width 0.5s ease;
      position: relative;
      overflow: hidden;
    }
    .course-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    .module-list { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
    .module-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }
    .module-item:hover { background: rgba(212,175,55,0.1); }
    .module-item.active { background: rgba(212,175,55,0.15); border-left-color: var(--gold); }
    .module-item.completed .module-number { background: var(--green); color: white; }
    .module-item.locked { opacity: 0.5; cursor: not-allowed; }
    .module-number {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    .module-item.active .module-number { background: var(--gold); color: var(--navy); }
    .module-info { flex: 1; min-width: 0; }
    .module-title { font-size: 0.8rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .module-subtitle { font-size: 0.65rem; color: rgba(255,255,255,0.5); }
    .module-xp { font-size: 0.6rem; color: var(--gold); }
    .module-time { font-size: 0.55rem; color: rgba(255,255,255,0.4); display: flex; align-items: center; gap: 0.25rem; margin-top: 0.15rem; }

    .badges-panel {
      padding: 1rem;
      border-top: 1px solid rgba(212,175,55,0.2);
    }
    .badges-title { font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 0.5rem; }
    .badges-grid { display: flex; flex-wrap: wrap; gap: 0.35rem; }
    .badge-item {
      width: 32px;
      height: 32px;
      min-width: 44px;
      min-height: 44px;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-family: inherit;
      color: inherit;
      padding: 0;
      opacity: 0.3;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }
    .badge-item.earned { opacity: 1; background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .badge-item:hover::after,
    .badge-item:focus::after,
    .badge-item:focus-visible::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--navy);
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.6rem;
      white-space: nowrap;
      z-index: 100;
    }
    .badge-item:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Main Content */
    .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .content-header {
      padding: 0.75rem 1.5rem;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(212,175,55,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .breadcrumb { font-size: 0.85rem; color: rgba(255,255,255,0.6); }
    .breadcrumb span { color: var(--gold); }
    .header-actions { display: flex; gap: 0.5rem; align-items: center; }
    .streak-display {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(239,68,68,0.2);
      border: 1px solid rgba(239,68,68,0.4);
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.8rem;
    }
    .streak-display.active {
      background: rgba(249,115,22,0.2);
      border-color: var(--orange);
      animation: flamePulse 1.5s ease-in-out infinite;
    }
    @keyframes flamePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    .streak-flame { font-size: 1rem; }
    .streak-count { font-weight: 700; color: var(--orange); }

    .btn {
      padding: 0.5rem 1rem;
      border: 1px solid rgba(212,175,55,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: var(--cream);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { background: rgba(212,175,55,0.2); border-color: var(--gold); }
    .btn.primary { background: var(--gold); color: var(--navy); border-color: var(--gold); font-weight: 600; }

    .content-body { flex: 1; overflow: hidden; display: flex; }

    /* Slides */
    .slides-container { flex: 1; position: relative; overflow: hidden; touch-action: pan-x pan-y; }
    .module-slides { display: none; width: 100%; height: 100%; }
    .module-slides.active { display: block; }

    .slide {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      padding: 2rem 2rem 4rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition), visibility var(--transition);
      overflow-y: auto;
    }
    .slide.active { opacity: 1; visibility: visible; }
    .slide.dark { background: var(--deep-navy); }
    .slide.light { background: var(--cream); color: var(--text); }
    .slide.black { background: #000; }
    .slide.red-bg { background: linear-gradient(135deg, #7f1d1d, #450a0a); }
    .slide.green-bg { background: linear-gradient(135deg, #14532d, #052e16); }
    .slide.purple-bg { background: linear-gradient(135deg, #4c1d95, #2e1065); }
    .slide.orange-bg { background: linear-gradient(135deg, #9a3412, #431407); }
    .slide.teal-bg { background: linear-gradient(135deg, #0f766e, #042f2e); }
    .slide.gold-bg { background: linear-gradient(135deg, #92702a 0%, #5c4520 100%); }

    .slide-progress-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), var(--orange));
      transition: width 0.3s ease;
      z-index: 50;
    }

    .serif { font-family: 'Cormorant Garamond', Georgia, serif; }
    .title {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.8rem, 4vw, 3rem);
      font-weight: 700;
      margin-bottom: 1rem;
      line-height: 1.2;
      text-align: center;
    }
    .title.gold { color: var(--gold); }
    .title.navy { color: var(--navy); }
    .subtitle {
      font-size: clamp(0.9rem, 2vw, 1.3rem);
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
      text-align: center;
    }
    .slide.light .subtitle { color: var(--light-text); }

    .big-number {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(4rem, 12vw, 8rem);
      font-weight: 700;
      line-height: 1;
    }
    .big-number.gold { color: var(--gold); }
    .big-number.red { color: var(--red); }

    .refrain {
      font-family: 'Cormorant Garamond', Georgia, serif;
      font-size: clamp(1.3rem, 3vw, 2rem);
      font-style: italic;
      color: var(--gold);
      text-align: center;
      max-width: 700px;
    }

    .content { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 850px; }

    /* Cards */
    .card {
      background: var(--light-cream);
      border: 1px solid var(--gold);
      padding: 1.25rem 1.5rem;
      margin: 0.5rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 8px;
    }
    .card.navy-bg { background: var(--navy); color: var(--cream); }
    .card-label {
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--gold);
      letter-spacing: 0.05em;
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .card-text { font-size: 0.95rem; line-height: 1.6; }
    .card.navy-bg .card-text { color: var(--cream); }

    /* Story box */
    .story-box {
      background: linear-gradient(135deg, rgba(197,48,48,0.15), rgba(30,39,97,0.2));
      border-left: 4px solid var(--red);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 750px;
      width: 100%;
      border-radius: 0 8px 8px 0;
    }
    .story-box.success { background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(30,39,97,0.2)); border-left-color: #4CAF50; }
    .story-box.warning { background: linear-gradient(135deg, rgba(245,158,11,0.15), rgba(30,39,97,0.2)); border-left-color: var(--gold); }
    .story-box.teal { background: linear-gradient(135deg, rgba(15,118,110,0.15), rgba(30,39,97,0.2)); border-left-color: var(--teal); }
    .story-label {
      font-size: 0.7rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--red);
      margin-bottom: 0.4rem;
      text-transform: uppercase;
    }
    .story-box.success .story-label { color: var(--green); }
    .story-box.warning .story-label { color: var(--orange); }
    .story-box.teal .story-label { color: var(--teal); }
    .story-text { font-size: 0.95rem; line-height: 1.6; }

    /* Stats */
    .stats-grid {
      display: flex;
      gap: 0.75rem;
      margin: 1rem 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .stat-box {
      background: var(--navy);
      color: var(--cream);
      padding: 1rem 1.25rem;
      text-align: center;
      min-width: 120px;
      border-radius: 8px;
    }
    .stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(1.3rem, 2.5vw, 2rem);
      font-weight: 700;
    }
    .stat-value.gold { color: var(--gold); }
    .stat-value.red { color: var(--red); }
    .stat-value.green { color: var(--green); }
    .stat-label { font-size: 0.75rem; opacity: 0.8; margin-top: 0.2rem; }

    /* Timeline */
    .timeline { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .timeline-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border-left: 4px solid var(--gold);
    }
    .timeline-days { font-weight: 700; font-size: 0.8rem; min-width: 70px; color: var(--gold); }
    .timeline-content { flex: 1; }
    .timeline-title { font-weight: 600; font-size: 0.9rem; }
    .timeline-desc { font-size: 0.75rem; opacity: 0.7; }

    /* Checklist */
    .checklist { display: flex; flex-direction: column; gap: 0.4rem; width: 100%; max-width: 650px; }
    .checklist-item {
      display: flex;
      align-items: flex-start;
      gap: 0.6rem;
      padding: 0.6rem 0.75rem;
      background: rgba(255,255,255,0.05);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .check-icon {
      width: 20px;
      height: 20px;
      background: var(--green);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: white;
      flex-shrink: 0;
    }
    .checklist-text { font-size: 0.9rem; }

    /* Decision Tree */
    .decision-tree {
      background: linear-gradient(135deg, rgba(124,58,237,0.1), rgba(30,39,97,0.2));
      border: 2px solid var(--purple);
      border-radius: 12px;
      padding: 1.25rem;
      width: 100%;
      max-width: 700px;
    }
    .decision-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .decision-icon {
      width: 40px;
      height: 40px;
      background: var(--purple);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .decision-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .decision-xp {
      margin-left: auto;
      background: rgba(212,175,55,0.2);
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      color: var(--gold);
      font-weight: 600;
    }
    .decision-scenario {
      background: rgba(0,0,0,0.2);
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    .decision-question {
      font-weight: 600;
      color: var(--gold);
      margin-bottom: 0.75rem;
      font-size: 1rem;
    }
    .decision-options { display: flex; flex-direction: column; gap: 0.5rem; }
    .decision-option {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: rgba(255,255,255,0.05);
      border: 2px solid rgba(255,255,255,0.15);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .decision-option:hover {
      background: rgba(124,58,237,0.2);
      border-color: var(--purple);
      transform: translateX(4px);
    }
    .decision-option:active {
      transform: scale(0.98);
    }
    .decision-option.selected { background: rgba(124,58,237,0.3); border-color: var(--purple); }
    .decision-option.correct { background: rgba(34,197,94,0.2); border-color: var(--green); }
    .decision-option.incorrect { background: rgba(239,68,68,0.15); border-color: var(--red); }
    .decision-option.disabled { pointer-events: none; opacity: 0.7; }
    .decision-option:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .option-letter {
      width: 24px;
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      flex-shrink: 0;
    }
    .decision-option.correct .option-letter { background: var(--green); color: white; }
    .decision-option.incorrect .option-letter { background: var(--red); color: white; }
    .option-text { font-size: 0.9rem; }
    .decision-feedback {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 8px;
      display: none;
    }
    .decision-feedback.show { display: block; }
    .decision-feedback.correct { background: rgba(34,197,94,0.2); border: 1px solid var(--green); }
    .decision-feedback.incorrect { background: rgba(239,68,68,0.15); border: 1px solid var(--red); }
    .feedback-title { font-weight: 700; margin-bottom: 0.5rem; }
    .feedback-text { font-size: 0.9rem; line-height: 1.5; }

    /* Learning Objectives */
    .objectives-box {
      background: linear-gradient(135deg, rgba(59,130,246,0.15), rgba(30,39,97,0.25));
      border: 2px solid #3b82f6;
      border-radius: 12px;
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
    }
    .objectives-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    .objectives-icon {
      width: 36px;
      height: 36px;
      background: #3b82f6;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    .objectives-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-weight: 700;
      color: #60a5fa;
    }
    .objectives-list { list-style: none; padding: 0; }
    .objectives-list li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.4rem 0;
      font-size: 0.9rem;
    }
    .objectives-list li::before { content: 'o'; color: #3b82f6; font-weight: bold; }

    /* Animation */
    .slide.active .animate { animation: fadeUp 0.5s ease-out forwards; }
    .slide.active .animate.delay-1 { animation-delay: 0.1s; }
    .slide.active .animate.delay-2 { animation-delay: 0.2s; }
    .slide.active .animate.delay-3 { animation-delay: 0.3s; }
    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate { opacity: 0; }

    /* XP Popup */
    .xp-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: linear-gradient(135deg, var(--gold), #f0c040);
      color: var(--navy);
      padding: 1.5rem 2.5rem;
      border-radius: 12px;
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      z-index: 1000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      transition: transform 0.3s ease;
    }
    .xp-popup.show { transform: translate(-50%, -50%) scale(1); }
    .xp-popup .xp-amount { font-size: 3rem; display: block; }

    /* Badge Modal */
    .badge-modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1001;
    }
    .badge-modal.show { display: flex; }
    @keyframes badgeBounce {
      0% { transform: scale(0); opacity: 0; }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); opacity: 1; }
    }
    .badge-modal.show .badge-modal-icon {
      animation: badgeBounce 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .badge-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2rem;
      text-align: center;
      max-width: 350px;
    }
    .badge-modal-icon { font-size: 4rem; margin-bottom: 1rem; }
    .badge-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.5rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .badge-modal-desc { font-size: 0.9rem; opacity: 0.8; margin-bottom: 1rem; }
    .badge-modal-close {
      padding: 0.5rem 1.5rem;
      background: var(--gold);
      color: var(--navy);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }

    /* Confetti */
    .confetti-container {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 999;
      overflow: hidden;
    }
    .confetti {
      position: absolute;
      width: 10px; height: 10px;
      opacity: 0;
      animation: confetti-fall 3s ease-out forwards;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .confetti { display: none; }
    }

    /* Nav */
    .slide-nav {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      padding: 0.75rem 1rem 1.25rem;
      z-index: 100;
      pointer-events: none;
    }
    .nav-btn {
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      font-size: 1.1rem;
      cursor: pointer;
      opacity: 0.6;
      transition: all 0.2s;
      padding: 0.4rem 0.6rem;
      border-radius: 6px;
      pointer-events: auto;
    }
    .nav-btn:hover { opacity: 1; background: rgba(0,0,0,0.7); border-color: var(--gold); }
    .nav-btn:active { transform: scale(0.95); }
    .nav-btn:disabled { opacity: 0.2; cursor: not-allowed; }
    .nav-btn:focus-visible { outline: 3px solid var(--gold); outline-offset: 2px; }
    .nav-center { display: flex; flex-direction: column; align-items: center; gap: 0.2rem; pointer-events: auto; }
    .slide-counter { font-size: 0.7rem; opacity: 0.5; }
    .progress-dots { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; max-width: 280px; }
    .progress-dot {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      padding: 0;
      appearance: none;
      position: relative;
    }
    .progress-dot::after {
      content: '';
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.2s;
    }
    .progress-dot.active::after { width: 14px; height: 14px; background: var(--gold); transform: translate(-50%, -50%); }
    .progress-dot:focus-visible { outline: 2px solid var(--gold); outline-offset: 2px; }

    /* Mobile */
    @media (max-width: 768px) {
      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1000;
        transition: left 0.3s ease;
      }
      .sidebar.open { left: 0; }
      .sidebar-toggle {
        display: flex;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 1001;
        width: 40px;
        height: 40px;
        background: var(--gold);
        color: var(--navy);
        border: none;
        border-radius: 8px;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        cursor: pointer;
      }
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.show { display: block; }
    }
    @media (min-width: 769px) {
      .sidebar-toggle { display: none; }
      .sidebar-overlay { display: none !important; }
    }

    /* Combo Counter */
    .combo-display {
      position: fixed;
      top: 80px;
      right: 20px;
      background: linear-gradient(135deg, var(--orange), #ef4444);
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-weight: 700;
      font-size: 0.9rem;
      z-index: 500;
      transform: scale(0);
      transition: transform 0.3s ease;
      box-shadow: 0 4px 15px rgba(239,68,68,0.4);
    }
    .combo-display.show { transform: scale(1); }

    /* Quote Block */
    .quote-block {
      background: linear-gradient(135deg, rgba(15,118,110,0.2), rgba(30,39,97,0.2));
      border-left: 4px solid var(--teal);
      padding: 1.25rem;
      margin: 0.75rem 0;
      max-width: 700px;
      width: 100%;
      border-radius: 0 8px 8px 0;
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.1rem;
      font-style: italic;
    }
    .quote-attribution {
      margin-top: 0.75rem;
      font-size: 0.85rem;
      font-style: normal;
      color: var(--teal);
    }

    /* Course Completion Overlay */
    .completion-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }
    .completion-overlay.show { display: flex; }
    .completion-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 450px;
      width: 90%;
    }
    .completion-icon { font-size: 3rem; margin-bottom: 1rem; color: var(--gold); }
    .completion-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
    }
    .completion-subtitle {
      font-size: 1rem;
      color: rgba(255,255,255,0.7);
      margin-bottom: 1.5rem;
    }
    .completion-stats {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .completion-stat {
      text-align: center;
    }
    .completion-stat-value {
      font-family: 'Cormorant Garamond', serif;
      font-size: 2rem;
      font-weight: 700;
      color: var(--gold);
    }
    .completion-stat-label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.6);
    }
    .completion-actions { display: flex; gap: 0.75rem; justify-content: center; }

    /* Level Up Modal */
    .level-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1003;
    }
    .level-modal.show { display: flex; }
    .level-modal-content {
      background: linear-gradient(135deg, var(--deep-navy), #0a0f1a);
      border: 2px solid var(--gold);
      border-radius: 16px;
      padding: 2.5rem;
      text-align: center;
      max-width: 400px;
      width: 90%;
      animation: levelModalPop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    @keyframes levelModalPop {
      0% { transform: scale(0); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
    .level-modal-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      animation: levelIconPulse 1s ease-in-out infinite;
    }
    @keyframes levelIconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    .level-modal-title {
      font-family: 'Cormorant Garamond', serif;
      font-size: 1.8rem;
      color: var(--gold);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .level-modal-level {
      font-family: 'Cormorant Garamond', serif;
      font-size: 3rem;
      font-weight: 700;
      color: var(--cream);
      margin-bottom: 0.25rem;
    }
    .level-modal-name {
      font-size: 1.2rem;
      color: var(--gold);
      margin-bottom: 1.5rem;
      font-weight: 600;
    }

    /* Tablet breakpoint */
    @media (max-width: 1024px) and (min-width: 769px) {
      .sidebar { width: 280px; }
    }

    /* Small mobile improvements */
    @media (max-width: 480px) {
      .decision-option {
        padding: 1rem 1.25rem;
        font-size: 0.95rem;
      }
    }

    /* Landscape orientation handling */
    @media (orientation: landscape) and (max-height: 500px) {
      .slide-content { padding: 1rem; }
      .slide .title { font-size: 1.5rem; }
      .slide-nav { padding: 0.5rem; }
    }

    /* Safe area insets for notched devices */
    @supports (padding-bottom: env(safe-area-inset-bottom)) {
      .sidebar {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
      .slide-nav {
        padding-bottom: max(1rem, env(safe-area-inset-bottom));
      }
    }
  </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<div class="course-container">
<!-- Sidebar -->
<nav aria-label="Navigazione del corso" class="sidebar" role="navigation">
<div class="sidebar-header">
<a href="index.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;">‚Üê Course Library</a>
<h1>Living Reviews</h1>
<p>Future of the Field (COVID proved it)</p>
</div>
<div class="stats-panel">
<div class="level-display">
<div class="level-badge" id="levelIcon">SK</div>
<div class="level-info">
<div class="level-title" id="levelTitle">Seed Keeper</div>
<div class="level-subtitle">Level <span id="levelNum">1</span></div>
</div>
</div>
<div class="xp-bar"><div class="xp-fill" id="xpFill" style="width: 0%"></div></div>
<div class="xp-text"><span id="xpCurrent">0</span> / <span id="xpNeeded">100</span> XP</div>
<div class="quick-stats">
<div class="quick-stat">
<div class="quick-stat-value" id="correctCount">0</div>
<div class="quick-stat-label">Correct</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="decisionCount">0</div>
<div class="quick-stat-label">Decisions</div>
</div>
<div class="quick-stat">
<div class="quick-stat-value" id="synthesisCount">0</div>
<div class="quick-stat-label">Updates</div>
</div>
</div>
</div>
<div class="course-progress">
<div class="course-progress-label">
<span>Course Progress</span>
<span id="courseProgressPct">0%</span>
</div>
<div class="course-progress-bar">
<div class="course-progress-fill" id="courseProgressFill" style="width: 0%"></div>
</div>
</div>
<div class="module-list" id="moduleList" role="list"></div>
<div class="badges-panel">
<div class="badges-title">Achievements</div>
<div class="badges-grid" id="badgesGrid"></div>
</div>
</nav>
<!-- Main Content -->
<main class="main-content" id="main-content">
<header class="content-header">
<div class="breadcrumb">Living Reviews / <span id="currentModule">Module 1</span></div>
<div class="header-actions">
<div class="streak-display" id="streakDisplay">
<span aria-hidden="true" class="streak-flame">üî•</span>
<span class="streak-count" id="streakCount">0</span>
<span>day streak</span>
</div>
<button class="btn" onclick="resetProgress()">Reset</button>
</div>
</header>
<div class="content-body">
<div class="slides-container" id="slidesContainer"></div>
</div>
</main>
</div>
<!-- XP Popup -->
<div aria-atomic="true" aria-live="polite" class="xp-popup" id="xpPopup" role="status">
<span class="xp-amount" id="xpAmount">+25</span>
    XP
  </div>
<!-- Badge Modal -->
<div aria-labelledby="badgeModalTitle" aria-modal="true" class="badge-modal" id="badgeModal" role="dialog">
<div class="badge-modal-content">
<div class="badge-modal-icon" id="badgeModalIcon">AW</div>
<div class="badge-modal-title" id="badgeModalTitle">Badge Earned!</div>
<div class="badge-modal-desc" id="badgeModalDesc">Hai sbloccato un nuovo obiettivo</div>
<button class="badge-modal-close" onclick="closeBadgeModal()">Awesome!</button>
</div>
</div>
<!-- Confetti Container -->
<div class="confetti-container" id="confettiContainer"></div>
<!-- Combo Counter -->
<div aria-live="polite" class="combo-display" id="comboDisplay" role="status">COMBO <span id="comboCount">0</span>x</div>
 Sovrapposizione del completamento del corso 
<div class="completion-overlay" id="completionOverlay">
<div class="completion-content">
<div class="completion-icon">üèÜ</div>
<div class="completion-title">Course Complete!</div>
<div class="completion-subtitle">You have mastered living reviews.</div>
<div class="completion-stats">
<div class="completion-stat">
<div class="completion-stat-value" id="completionXP">0</div>
<div class="completion-stat-label">Total XP</div>
</div>
<div class="completion-stat">
<div class="completion-stat-value" id="completionBadges">0</div>
<div class="completion-stat-label">Badges Earned</div>
</div>
<div class="completion-stat">
<div class="completion-stat-value" id="completionLevel">1</div>
<div class="completion-stat-label">Final Level</div>
</div>
</div>
<div class="completion-actions">
<button class="btn primary" onclick="downloadCertificate()">Download Certificate</button>
<button class="btn" onclick="reviewBadges()">Review Badges</button>
<button class="btn" onclick="closeCompletion()">Close</button>
</div>
</div>
</div>
<!-- Level Up Modal -->
<div aria-hidden="true" aria-labelledby="levelModalTitle" aria-modal="true" class="level-modal" id="levelModal" role="dialog">
<div class="level-modal-content">
<div class="level-modal-icon">üéñÔ∏è</div>
<div class="level-modal-title" id="levelModalTitle">Level Up!</div>
<div class="level-modal-level" id="levelModalLevel">Level 2</div>
<div class="level-modal-name" id="levelModalName">Signal Scout</div>
<button class="btn primary" onclick="closeLevelModal()">Continue</button>
</div>
</div>
<!-- Mobile Sidebar Toggle -->
<button aria-expanded="false" aria-label="Toggle menu" class="sidebar-toggle" onclick="toggleSidebar()">MENU</button>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<script>
// ===== GAMIFICATION STATE =====
const DEFAULT_STATE = {
  xp: 0,
  level: 1,
  streak: 0,
  lastActive: null,
  correctAnswers: 0,
  decisionsCompleted: 0,
  synthesisCount: 0,
  badges: [],
  completedModules: [],
  answeredQuestions: {},
  consecutiveCorrect: 0,
  courseCompleted: false
};

function safeGetStorage(key, fallback) {
  try {
    const item = localStorage.getItem(key);
    return item ? JSON.parse(item) : fallback;
  } catch (e) {
    return fallback;
  }
}

function safeSetStorage(key, value) {
  try {
    localStorage.setItem(key, JSON.stringify(value));
  } catch (e) {}
}

// Migration from old storage key to versioned key
(function migrateStorage() {
  try {
    const oldData = localStorage.getItem('livingReviewGame');
    if (oldData && !localStorage.getItem('livingReviewGame_v1')) {
      localStorage.setItem('livingReviewGame_v1', oldData);
      localStorage.removeItem('livingReviewGame');
    }
  } catch (e) {}
})();

let gameState = safeGetStorage('livingReviewGame_v1', DEFAULT_STATE);

const LEVELS = [
  { level: 1, title: "Seed Keeper", icon: "SK", xp: 0 },
  { level: 2, title: "Signal Scout", icon: "SS", xp: 120 },
  { level: 3, title: "Protocol Anchor", icon: "PA", xp: 300 },
  { level: 4, title: "Screening Builder", icon: "SB", xp: 520 },
  { level: 5, title: "Threshold Judge", icon: "TJ", xp: 780 },
  { level: 6, title: "Version Steward", icon: "VS", xp: 1050 },
  { level: 7, title: "Sustainability Lead", icon: "SL", xp: 1350 },
  { level: 8, title: "Living Review Master", icon: "LM", xp: 1700 }
];

const BADGES = [
  { id: "first_update", icon: "\u{1F3AF}", name: "First Update", desc: "Completa il tuo primo scenario decisionale" },
  { id: "signal_scout", icon: "\u{1F4E1}", name: "Signal Scout", desc: "Completa il modulo The Pulse" },
  { id: "protocol_anchor", icon: "\u{2693}", name: "Protocol Anchor", desc: "Completa il modulo Anchor" },
  { id: "screening_builder", icon: "\u{1F3D7}", name: "Screening Builder", desc: "Completa il modulo The Funnel" },
  { id: "threshold_judge", icon: "\u{2696}", name: "Threshold Judge", desc: "Completa The Trigger modulo" },
  { id: "version_steward", icon: "\u{1F4DD}", name: "Version Steward", desc: "Completa il modulo Record" },
  { id: "sustainability_lead", icon: "\u{267B}", name: "Sustainability Lead", desc: "Completa il modulo Balance" },
  { id: "perfect_5", icon: "\u{2B50}", name: "Five Star", desc: "Get 5 correct answers in a row" },
  { id: "decision_maker", icon: "\u{1F9E0}", name: "Decision Maker", desc: "Completa 18 alberi decisionali" },
  { id: "finisher", icon: "\u{1F3C6}", name: "Course Complete", desc: "Termina l'intero corso" },
  { id: "streak_3", icon: "\u{1F525}", name: "On Fire", desc: "Maintain a 3-day streak" },
  { id: "streak_7", icon: "\u{1F4AA}", name: "Weekly Warrior", desc: "Maintain a 7-day streak" }
];

// ===== MODULES DATA =====
const MODULES = [
  {
    id: 1, title: "The Wake", subtitle: "COVID ha mostrato il futuro", xp: 140,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "Living Reviews", subtitle: "Il campo che mai dorme" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Explain why static reviews fail in fast moving evidence",
          "Definisci una revisione vivente e la sua promessa fondamentale",
          "Utilizza storia, contrasto e ritornello per costruire giudizio",
          "Practice real world decisions from COVID cases"
        ],
        tip: "Utilizziamo contrasto, finali speculari e brevi ritornelli per fissare la lezione."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE SURGE", title: "Quando le prove crescevano di settimana in settimana settimana",
        text: "Le prime evidenze sul COVID sono cresciute pi√π velocemente di qualsiasi ciclo di revisione. Il numero di preprint √® aumentato, le prove sono state lanciate e le linee guida hanno richiesto aggiornamenti settimanali. Le revisioni statiche erano obsolete prima della stampa.",
        followup: "Living reviews answered the moment: update as new trials arrive, publish each version, and keep a continuous trail of decisions."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE PAIR", title: "Two teams, two clocks",
        text: "Il team A ha pubblicato una revisione statica e l'ha bloccata. Il team B ha pubblicato una recensione vivente e aggiornamenti con versione. Sei mesi dopo, la squadra A fu citata ma sbagliata. Il team B √® stato citato meno spesso ma √® rimasto attuale.",
        followup: "The contrast is the lesson: speed without updates becomes error; updates without trace become noise."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Case Snapshot",
        stats: [
          { value: "1000+", label: "COVID trials registered (early 2020)" },
          { value: "weeks", label: "Crescita delle prove misurata in settimane" },
          { value: "rapid", label: "Guidance needed" },
          { value: "versions", label: "Living updates published" }
        ],
        caption: "Conteggi semplificati per l'insegnamento."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Che cos'√® una revisione vivente",
        subtitle: "Una revisione con un battito cardiaco",
        text: "A La revisione vivente √® una revisione sistematica che viene continuamente aggiornata man mano che appaiono nuove prove. Utilizza sorveglianza continua, screening rapido e pubblicazione di versioni in modo che la risposta rimanga aggiornata.",
        highlight: "La promessa non √® solo la velocit√†. Si tratta di un cambiamento tracciabile."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Predisposizione alla revisione in tempo reale",
        items: [
          "Evidence is changing fast or expected to change",
          "Le decisioni dipendono dalle prove attuali",
          "A team can sustain ongoing updates",
          "The protocol defines update rules",
          "Versioning will be public and traceable"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SK", title: "Scenario: Static or Living", xp: 25,
        scenario: "A new outbreak is producing trials every week. The guideline panel meets monthly.",
        question: "Quale modello di revisione si adatta alla decisione?",
        options: [
          { letter: "A", text: "Traditional review every two years", correct: false },
          { letter: "B", text: "Revisione in tempo reale con aggiornamenti pianificati", correct: true },
          { letter: "C", text: "Nessuna revisione fino all'epidemia termina", correct: false },
          { letter: "D", text: "Narrative summary only", correct: false }
        ],
        feedback: {
          correct: "Corretto. Le prove in rapido cambiamento richiedono una revisione vivente con aggiornamenti frequenti.",
          incorrect: "Le revisioni statiche sono in ritardo rispetto alle prove veloci. Esistono revisioni viventi esattamente per questo scenario."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SK", title: "Scenario: The Promise", xp: 25,
        scenario: "A team claims their living review is updated annually.",
        question: "Qual ‚Äã‚Äã√® il problema principale?",
        options: [
          { letter: "A", text: "Gli aggiornamenti annuali sono troppo lenti per una revisione vivente", correct: true },
          { letter: "B", text: "Annual updates are too frequent", correct: false },
          { letter: "C", text: "Living reviews must be daily", correct: false },
          { letter: "D", text: "Update timing does not matter", correct: false }
        ],
        feedback: {
          correct: "Esatto. Le revisioni in tempo reale sono definite da aggiornamenti frequenti e reattivi, non in base all'abitudine del calendario.",
          incorrect: "Le revisioni in tempo reale sono progettate per tenere il passo con le nuove prove, non solo aggiornarsi secondo un programma annuale."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SK", title: "Scenario: Readiness Triage", xp: 25,
        scenario: "Un argomento ha una crescita lenta delle prove e una bassa urgenza decisionale. Una piccola squadra √® gi√† al limite.",
        question: "Dovrebbe essere una recensione dal vivo?",
        options: [
          { letter: "A", text: "Yes, all reviews should be living", correct: false },
          { letter: "B", text: "No, a standard update cycle is enough", correct: true },
          { letter: "C", text: "Only if media attention is high", correct: false },
          { letter: "D", text: "Solo se sono incluse le prestamp", correct: false }
        ],
        feedback: {
          correct: "Esatto. Le revisioni viventi sono giustificate quando la velocit√† delle prove e l'urgenza della decisione lo richiedono.",
          incorrect: "Le revisioni viventi richiedono molte risorse e dovrebbero essere riservate ad argomenti in rapido movimento o ad alto impatto."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Quando le prove si muovono, la revisione deve muoversi." }}
    ]
  },
  {
    id: 2, title: "The Pulse", subtitle: "Sorveglianza e segnali", xp: 150,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Pulse", subtitle: "Trova nuove prove prima che trovino te" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Design an ongoing search strategy",
          "Utilizza registri e avvisi per il rilevamento precoce",
          "Set cadence based on evidence velocity",
          "Scopri quando il polso √® troppo debole per living"
        ],
        tip: "La sorveglianza dell'influenza del CDC ha rilevato l'H1N1 nel 2009 settimane prima dei metodi tradizionali, perch√© hanno osservato continuamente, non annualmente."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE WATCH", title: "When registries speak before journals",
        text: "Durante il COVID, i registri degli studi hanno segnalato i risultati settimane prima della pubblicazione. I team che hanno monitorato i registri si sono aggiornati pi√π velocemente ed hanno evitato punti ciechi.",
        followup: "Il polso non √® solo nei diari. √à presente in preprint, registri e rapporti normativi."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Signal Map",
        stats: [
          { value: "registries", label: "Early trial signals" },
          { value: "preprints", label: "Rapid dissemination" },
          { value: "journals", label: "Peer reviewed record" },
          { value: "alerts", label: "Automated monitoring" }
        ],
        caption: "Sources listed by typical signal speed."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Surveillance Sources",
        subtitle: "Build a layered net",
        text: "Minimum layers: database searches, trial registries, preprint alerts, and targeted journal scans.",
        highlight: "A living review fails when its net has holes."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Pulse Plan",
        items: [
          "Definire fonti e frequenza",
          "Use alerts for new trials",
          "Log all searches and updates",
          "Impostare una cadenza che corrisponda alla velocit√† delle prove",
          "Rivedere il polso trimestralmente"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Cadence Choice", xp: 25,
        scenario: "A topic adds one small trial every six months.",
        question: "What cadence fits a living review?",
        options: [
          { letter: "A", text: "Ricerca settimanale e aggiornamento", correct: false },
          { letter: "B", text: "Monthly surveillance with quarterly update", correct: true },
          { letter: "C", text: "Daily surveillance with weekly update", correct: false },
          { letter: "D", text: "No surveillance", correct: false }
        ],
        feedback: {
          correct: "Corretto. La cadenza dovrebbe corrispondere alla velocit√† delle prove. In questo caso la sorveglianza mensile con aggiornamenti trimestrali √® ragionevole.",
          incorrect: "Too frequent wastes resources; too slow misses signals. Cadence should fit the evidence rate."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Hidden Source", xp: 25,
        scenario: "La tua revisione si basa solo su studi pubblicati, ma diversi risultati chiave vengono visualizzati per primi in un registro.",
        question: "Qual √® la soluzione migliore?",
        options: [
          { letter: "A", text: "Attendere solo i diari", correct: false },
          { letter: "B", text: "Add registry monitoring and preprint alerts", correct: true },
          { letter: "C", text: "Ignore registries due to quality concerns", correct: false },
          { letter: "D", text: "Fermare i vivi revisione", correct: false }
        ],
        feedback: {
          correct: "Correct. Living reviews need multiple sources to detect evidence early.",
          incorrect: "Excluding registries creates blind spots and delays updates."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SS", title: "Scenario: Signal Triage", xp: 25,
        scenario: "Una prestampa riporta un grande effetto, ma i metodi non sono chiari e la revisione tra pari √® in sospeso.",
        question: "Come dovrebbe rispondere la revisione in tempo reale?",
        options: [
          { letter: "A", text: "Update conclusions immediately", correct: false },
          { letter: "B", text: "Contrassegna il segnale e attendi la verifica", correct: true },
          { letter: "C", text: "Ignore preprints entirely", correct: false },
          { letter: "D", text: "Rimuovi precedente prove", correct: false }
        ],
        feedback: {
          correct: "Correct. Living reviews can note signals while keeping conclusions tied to verified evidence.",
          incorrect: "Preprints can be valuable signals, but conclusions should wait for adequate validation."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Il guardiano che dorme perde il segnale." }}
    ]
  },
  {
    id: 3, title: "The Anchor", subtitle: "Protocollo e governo", xp: 160,
    slides: [
      { type: "title", theme: "purple-bg", content: { title: "The Anchor", subtitle: "Living does not mean drifting" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Register a living protocol with update rules",
          "Define governance and decision authority",
          "Control scope changes without bias",
          "Version every change transparently"
        ],
        tip: "Una nave si muove, ma la sua ancora regge. Il tuo protocollo √® l'ancora."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE ANCHOR", title: "When scope drift erases trust",
        text: "Una revisione vivente ha ampliato la sua popolazione dopo aver visto i risultati. La nuova versione sembrava pi√π forte ma ha perso credibilit√†.",
        followup: "Vivere significa aggiornare le prove, non riscrivere la domanda. La disciplina del protocollo protegge la fiducia."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Protocol Essentials",
        subtitle: "Scrivi le regole prima della tempesta",
        text: "Definisci trigger di aggiornamento, ruoli, diritti decisionali e regole di versione. Pianificare come gestire le modifiche all'ambito e i nuovi risultati.",
        highlight: "A living review without rules is a moving target."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Anchor Checklist",
        items: [
          "L'ambito e i risultati sono bloccati",
          "I trigger di aggiornamento vengono scritti",
          "Decision authority is defined",
          "Le modifiche al protocollo vengono modificate",
          "I conflitti vengono documentato"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "PA", title: "Scenario: Scope Change", xp: 25,
        scenario: "Nuovi studi aggiungono una popolazione diversa non presente nel protocollo.",
        question: "Cosa dovresti fare?",
        options: [
          { letter: "A", text: "Aggiungi immediatamente la popolazione", correct: false },
          { letter: "B", text: "Modifica il protocollo con giustificazione e versione", correct: true },
          { letter: "C", text: "Ignora il studi", correct: false },
          { letter: "D", text: "Change outcomes instead", correct: false }
        ],
        feedback: {
          correct: "Correct. Protocol changes must be explicit, justified, and versioned.",
          incorrect: "Silent changes erode trust and create reporting bias."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "PA", title: "Scenario: Governance", xp: 25,
        scenario: "Due autori non sono d'accordo sul fatto che nuove prove cambino la conclusione.",
        question: "What governance rule helps most?",
        options: [
          { letter: "A", text: "No rule, decide ad hoc", correct: false },
          { letter: "B", text: "Predefined decision lead and documented vote", correct: true },
          { letter: "C", text: "Let the most senior author decide quietly", correct: false },
          { letter: "D", text: "Delay all updates", correct: false }
        ],
        feedback: {
          correct: "Correct. Clear governance reduces conflict and ensures consistent decisions.",
          incorrect: "Living reviews need clear decision rules to avoid inconsistency."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "L'ancora mantiene onesta la nave in movimento." }}
    ]
  },
  {
    id: 4, title: "The Funnel", subtitle: "Screening ed estrazione", xp: 160,
    slides: [
      { type: "title", theme: "green-bg", content: { title: "The Funnel", subtitle: "Dall'ondata alle prove" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Design rapid screening with quality control",
          "Use automation without losing traceability",
          "Keep extraction consistent across versions",
          "Gestire il carico di lavoro e la deriva"
        ],
        tip: "Cochrane COVID reviews screened 20,000+ records monthly. Without strict funnel criteria, the signal drowns in noise."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE FILTER", title: "When speed broke accuracy",
        text: "Una revisione vivente ha utilizzato singoli screener per tenere il passo. Errori accumulati e prove chiave perse.",
        followup: "Fast √® utile solo se corretto. L'automazione e i doppi controlli mantengono il funnel onesto."
      }},
      { type: "stats", theme: "dark", content: {
        title: "Workload Snapshot",
        stats: [
          { value: "hundreds", label: "records per week" },
          { value: "hours", label: "screening time per update" },
          { value: "two", label: "controlla le decisioni critiche" },
          { value: "audit", label: "trail required" }
        ],
        caption: "Orders of magnitude only."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Funnel Rules",
        subtitle: "Velocit√† con protezioni",
        text: "Utilizza il doppio screening per le decisioni critiche, l'assistenza della macchina per l'assegnazione delle priorit√† e un chiaro audit trail per ogni aggiornamento.",
        highlight: "Se non riesci a rintracciarlo, non puoi fidarti it."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SB", title: "Scenario: Single Screener", xp: 25,
        scenario: "Sei in ritardo sulla tabella di marcia. Il team suggerisce uno screening singolo per recuperare il ritardo.",
        question: "Qual √® la scelta migliore?",
        options: [
          { letter: "A", text: "Switch to single screening for all records", correct: false },
          { letter: "B", text: "Use single screening only after validation checks", correct: true },
          { letter: "C", text: "Drop screening and include all", correct: false },
          { letter: "D", text: "Stop updates entirely", correct: false }
        ],
        feedback: {
          correct: "Correct. If single screening is used, it must be validated and targeted.",
          incorrect: "Speed without safeguards increases error risk."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SB", title: "Scenario: Extraction Drift", xp: 25,
        scenario: "New extractors interpret outcomes differently across versions.",
        question: "What prevents drift?",
        options: [
          { letter: "A", text: "No change, let judgment vary", correct: false },
          { letter: "B", text: "Utilizzare un dizionario dati bloccato e una calibrazione", correct: true },
          { letter: "C", text: "Let software decide outcomes", correct: false },
          { letter: "D", text: "Reduce outcome fields to avoid conflict", correct: false }
        ],
        feedback: {
          correct: "Correct. A shared extraction guide and calibration keep versions consistent.",
          incorrect: "Living reviews require stable extraction rules to avoid silent shifts."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SB", title: "Scenario: Automation Threshold", xp: 25,
        scenario: "Un modello di macchina classifica gli studi con l'85% di richiamo alla convalida.",
        question: "How should the team use it?",
        options: [
          { letter: "A", text: "Let the model exclude all low ranked records", correct: false },
          { letter: "B", text: "Utilizzarlo per stabilire le priorit√† con gli esseri umani checks", correct: true },
          { letter: "C", text: "Ignora completamente il modello", correct: false },
          { letter: "D", text: "Utilizzalo solo per l'estrazione dei dati", correct: false }
        ],
        feedback: {
          correct: "Corretto. L'automazione pu√≤ valutare il lavoro, ma le esclusioni richiedono revisione umana e audit trail.",
          incorrect: "I modelli possono aiutare, ma non sostituiscono le decisioni di revisione trasparenti."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "A fast funnel still needs a strong filter." }}
    ]
  },
  {
    id: 5, title: "The Trigger", subtitle: "When to update", xp: 170,
    slides: [
      { type: "title", theme: "red-bg", content: { title: "The Trigger", subtitle: "Decidi quando cambia la risposta" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Set update thresholds and decision rules",
          "Use new evidence to test effect direction",
          "Evita i falsi allarmi provenienti da piccoli studi",
          "Align triggers with stakeholder needs"
        ],
        tip: "La storia della terapia ormonale sostitutiva √® cambiata quando √® stato sperimentato il WHI sono arrivati i dati. Le recensioni viventi ti consentono di aggiornare il finale non appena compaiono nuovi capitoli."
      }},
      { type: "story", theme: "red-bg", content: {
        label: "THE TURN", title: "Steroids in severe COVID",
        text: "Le prime prove erano incerte. Quindi un ampio studio su piattaforma ha riportato una riduzione della mortalit√† nei casi pi√π gravi. La guida √® cambiata rapidamente e le revisioni aggiornate sono state aggiornate.",
        followup: "Triggers should capture when a new trial changes confidence or direction."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Trigger Rules",
        subtitle: "Rendere l'aggiornamento prevedibile",
        text: "Common triggers: new large trial, change in effect direction, change in certainty, or new harm signal.",
        highlight: "Se non √® possibile indicare il trigger, gli aggiornamenti diventano arbitrari."
      }},
      { type: "checklist", theme: "dark", content: {
        title: "Trigger Ladder",
        items: [
          "New large trial",
          "Direction changes",
          "Certainty changes",
          "New harm signal",
          "Stakeholder request"
        ]
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TJ", title: "Scenario: piccolo studio", xp: 25,
        scenario: "Un nuovo studio con 40 partecipanti mostra un grande effetto, ma gli intervalli di confidenza sono ampio.",
        question: "Dovresti aggiornare immediatamente?",
        options: [
          { letter: "A", text: "Yes, any new study triggers update", correct: false },
          { letter: "B", text: "Only if it changes certainty or direction based on rules", correct: true },
          { letter: "C", text: "Non aggiornare mai per studi di piccole dimensioni", correct: false },
          { letter: "D", text: "Update only if media attention is high", correct: false }
        ],
        feedback: {
          correct: "Correct. Living reviews need explicit trigger rules so updates are meaningful.",
          incorrect: "Without thresholds, updates become noise rather than signal."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TJ", title: "Scenario: Harm Signal", xp: 25,
        scenario: "Un avviso di sicurezza segnala un aumento degli eventi avversi per l'intervento.",
        question: "Qual √® la risposta giusta?",
        options: [
          { letter: "A", text: "Wait until more trials are published", correct: false },
          { letter: "B", text: "Aggiornare per includere il danno segnalare e rivalutare la certezza", correct: true },
          { letter: "C", text: "Remove harms to keep focus on benefits", correct: false },
          { letter: "D", text: "Interrompere completamente la revisione", correct: false }
        ],
        feedback: {
          correct: "Corretto. I segnali di danno sono fattori scatenanti ad alta priorit√† per gli aggiornamenti in tempo reale.",
          incorrect: "Ritardare gli aggiornamenti di sicurezza compromette lo scopo di una revisione in tempo reale."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "TJ", title: "Scenario: Effect Reversal", xp: 25,
        scenario: "Un nuovo ampio studio inverte la direzione dell'effetto combinato da beneficio a nessun beneficio.",
        question: "Cosa dovrebbe fare il team?",
        options: [
          { letter: "A", text: "Delay updates to avoid confusion", correct: false },
          { letter: "B", text: "Problema un aggiornamento importante e spiegare l'inversione", correct: true },
          { letter: "C", text: "Rimuovere il nuovo studio", correct: false },
          { letter: "D", text: "Publish without changing conclusions", correct: false }
        ],
        feedback: {
          correct: "Correct. A direction change is a major trigger and must be communicated clearly.",
          incorrect: "Living reviews exist to surface reversals promptly and transparently."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "La svolta √® il momento in cui la risposta cambia." }}
    ]
  },
  {
    id: 6, title: "The Record", subtitle: "Versionamento e trasparenza", xp: 170,
    slides: [
      { type: "title", theme: "gold-bg", content: { title: "The Record", subtitle: "Every update must leave a trail" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Publish clear version history",
          "Label major and minor updates",
          "Keep citations stable across versions",
          "Explain what changed and why"
        ],
        tip: "La saga di Tamiflu ha dimostrato che senza una documentazione trasparente, anche le revisioni sistematiche possono fuorviare per anni."
      }},
      { type: "story", theme: "gold-bg", content: {
        label: "THE LEDGER", title: "WHO living guidelines",
        text: "WHO living guidance during COVID published explicit versions. Each update noted new trials and whether recommendations changed.",
        followup: "La trasparenza ha reso gli aggiornamenti credibili e utilizzabili per le politiche."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Version Rules",
        subtitle: "Small change or new conclusion",
        text: "Major update: conclusion changes or certainty shifts. Minor update: new trials but same conclusion.",
        highlight: "Readers should know which version to cite."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "VS", title: "Scenario: Minor Update", xp: 25,
        scenario: "Sono stati aggiunti due nuovi studi, ma l'effetto complessivo e la certezza non cambiano.",
        question: "Come dovresti etichettare l'aggiornamento?",
        options: [
          { letter: "A", text: "Major update", correct: false },
          { letter: "B", text: "Minor update with change log", correct: true },
          { letter: "C", text: "Do not publish", correct: false },
          { letter: "D", text: "Riscrivi comunque la conclusione", correct: false }
        ],
        feedback: {
          correct: "Corretto. L'aggiornamento √® reale ma non cambia le conclusioni, quindi etichettalo come secondario e documenta la modifica.",
          incorrect: "Le etichette delle versioni devono riflettere l'entit√† della modifica, non solo i nuovi dati."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "VS", title: "Scenario: Citation", xp: 25,
        scenario: "A guideline cites version 1.2, but version 2.0 reverses the recommendation.",
        question: "Qual √® la pratica migliore?",
        options: [
          { letter: "A", text: "Keep citing 1.2 to avoid confusion", correct: false },
          { letter: "B", text: "Citare la versione pi√π recente e documentare la modifica", correct: true },
          { letter: "C", text: "Remove version numbers", correct: false },
          { letter: "D", text: "Stop updates to preserve citations", correct: false }
        ],
        feedback: {
          correct: "Corretto. Le revisioni viventi richiedono citazioni con versione in modo che i lettori conoscano le prove attuali.",
          incorrect: "Avoiding versioning hides changes and weakens trust."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Every update must leave a trail." }}
    ]
  },
  {
    id: 7, title: "The Balance", subtitle: "Sustain or retire", xp: 190,
    slides: [
      { type: "title", theme: "teal-bg", content: { title: "The Balance", subtitle: "Know when to pause the pulse" }},
      { type: "objectives", theme: "dark", content: {
        objectives: [
          "Decidi quando le prove si stabilizzano",
          "Set stopping or hibernation criteria",
          "Pianifica il passaggio di consegne e la manutenzione",
          "Torna alla lezione di apertura con chiarezza"
        ],
        tip: "La struttura ad anello termina dove √® iniziata: le prove in movimento incontrano la stabilit√† risposta."
      }},
      { type: "story", theme: "green-bg", content: {
        label: "THE REST", title: "Quando la curva si appiattisce",
        text: "Dopo un'ondata di studi, le prove su una terapia COVID si sono stabilizzate. Gli aggiornamenti aggiungevano poco e le risorse erano limitate. Il team √® passato alla sorveglianza annuale con una chiara regola di riavvio.",
        followup: "Living does not mean forever. It means as long as it matters."
      }},
      { type: "concept", theme: "dark", content: {
        title: "Stopping Rules",
        subtitle: "When to sleep",
        text: "Interrompere o ibernare quando nuove prove sono rare, la conclusione √® stabile e la decisione non dipende pi√π dagli aggiornamenti.",
        highlight: "A living review should earn its maintenance cost."
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SL", title: "Scenario: Retire or Continue", xp: 35,
        scenario: "Nessun nuovo studio per 18 mesi e la conclusione non √® cambiata nei tre aggiornamenti.",
        question: "Qual √® la migliore azione?",
        options: [
          { letter: "A", text: "Maintain monthly updates forever", correct: false },
          { letter: "B", text: "Shift to hibernation with restart criteria", correct: true },
          { letter: "C", text: "Eliminare la revisione", correct: false },
          { letter: "D", text: "Ignorare la mancanza di nuove prove", correct: false }
        ],
        feedback: {
          correct: "Corretto. L'ibernazione preserva la revisione risparmiando risorse, con una regola chiara per la riattivazione.",
          incorrect: "Le revisioni in tempo reale devono bilanciare valore e costo. Se le prove sono stabili, √® giustificata una cadenza pi√π leggera."
        }
      }},
      { type: "decision", theme: "dark", content: {
        icon: "SL", title: "Scenario: il ritorno", xp: 35,
        scenario: "Un nuovo studio importante appare dopo l'ibernazione e mette in discussione la conclusione attuale.",
        question: "Cosa dovrebbe fare il team?",
        options: [
          { letter: "A", text: "Ignore it until the next annual scan", correct: false },
          { letter: "B", text: "Riattivare la revisione vivente e pubblicare una nuova versione", correct: true },
          { letter: "C", text: "Rimuovere la vecchia conclusione", correct: false },
          { letter: "D", text: "Inizia una nuova revisione non correlata", correct: false }
        ],
        feedback: {
          correct: "Corretto. L'ibernazione dovrebbe includere chiare regole di riavvio e una rapida riattivazione quando compaiono prove importanti.",
          incorrect: "La promessa vivente √® di rispondere quando le prove cambiano."
        }
      }},
      { type: "refrain", theme: "black", content: { text: "Quando le prove si muovono, la revisione deve muoversi." }}
    ]
  }
];

// ===== NAVIGATION STATE =====
let currentModule = 0;
let currentSlide = 0;
let consecutiveCorrect = gameState.consecutiveCorrect || 0;

// ===== SAVE/LOAD =====
function saveGame() {
  safeSetStorage('livingReviewGame_v1', gameState);
}

function resetProgress() {
  if (confirm('Reset all progress and achievements?')) {
    gameState = { ...DEFAULT_STATE, answeredQuestions: {}, badges: [], completedModules: [], consecutiveCorrect: 0 };
    saveGame();
    currentModule = 0;
    currentSlide = 0;
    renderAll();
  }
}

// ===== COURSE PROGRESS =====
function updateCourseProgress() {
  const totalModules = MODULES.length;
  const completedCount = gameState.completedModules.length;
  const pct = Math.round((completedCount / totalModules) * 100);
  const fillEl = document.getElementById('courseProgressFill');
  const pctEl = document.getElementById('courseProgressPct');
  if (fillEl) fillEl.style.width = pct + '%';
  if (pctEl) pctEl.textContent = pct + '%';
}

// ===== XP & LEVELING =====
function addXP(amount) {
  gameState.xp += amount;
  checkLevelUp();
  saveGame();
  updateStatsDisplay();
  showXPPopup(amount);
}

function checkLevelUp() {
  for (let i = LEVELS.length - 1; i >= 0; i--) {
    if (gameState.xp >= LEVELS[i].xp && gameState.level < LEVELS[i].level) {
      gameState.level = LEVELS[i].level;
      showLevelUp(LEVELS[i]);
      break;
    }
  }
}

function showXPPopup(amount) {
  const popup = document.getElementById('xpPopup');
  document.getElementById('xpAmount').textContent = `+${amount}`;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 1500);
}

function showLevelUp(levelData) {
  triggerConfetti();
  const modal = document.getElementById('levelModal');
  document.getElementById('levelModalLevel').textContent = `Level ${levelData.level}`;
  document.getElementById('levelModalName').textContent = levelData.title;
  modal.classList.add('show');
  modal.setAttribute('aria-hidden', 'false');

  // Auto-close after 10 seconds (extended for accessibility)
  setTimeout(() => {
    closeLevelModal();
  }, 10000);
}

function closeLevelModal() {
  const modal = document.getElementById('levelModal');
  if (modal) {
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
  }
}

// ===== BADGES =====
function awardBadge(badgeId) {
  if (gameState.badges.includes(badgeId)) return;
  gameState.badges.push(badgeId);
  saveGame();
  const badge = BADGES.find(b => b.id === badgeId);
  if (badge) showBadgeModal(badge);
  updateBadges();
}

function showBadgeModal(badge, celebrate = true) {
  document.getElementById('badgeModalIcon').textContent = badge.icon;
  document.getElementById('badgeModalTitle').textContent = badge.name;
  document.getElementById('badgeModalDesc').textContent = badge.desc;
  const modal = document.getElementById('badgeModal');
  modal.classList.add('show');
  if (celebrate) triggerConfetti();

  // Focus trap
  const focusableElements = modal.querySelectorAll('button, [tabindex]:not([tabindex="-1"])');
  if (focusableElements.length > 0) {
    const firstFocusable = focusableElements[0];
    const lastFocusable = focusableElements[focusableElements.length - 1];
    firstFocusable.focus();

    // Remove any existing focus trap listener
    if (modal._focusTrapHandler) {
      modal.removeEventListener('keydown', modal._focusTrapHandler);
    }

    modal._focusTrapHandler = function(e) {
      if (e.key === 'Tab') {
        if (e.shiftKey && document.activeElement === firstFocusable) {
          e.preventDefault();
          lastFocusable.focus();
        } else if (!e.shiftKey && document.activeElement === lastFocusable) {
          e.preventDefault();
          firstFocusable.focus();
        }
      }
      if (e.key === 'Escape') {
        closeBadgeModal();
      }
    };
    modal.addEventListener('keydown', modal._focusTrapHandler);
  }
}

function showBadgeDetails(badgeId) {
  const badge = BADGES.find(b => b.id === badgeId);
  if (!badge) return;
  const earned = gameState.badges.includes(badgeId);
  const desc = earned ? badge.desc : `${badge.desc} (Locked)`;
  showBadgeModal({ ...badge, desc }, earned);
}

function closeBadgeModal() {
  const modal = document.getElementById('badgeModal');
  if (modal._focusTrapHandler) {
    modal.removeEventListener('keydown', modal._focusTrapHandler);
    modal._focusTrapHandler = null;
  }
  modal.classList.remove('show');
}

// ===== STREAK =====
function updateStreak() {
  const today = new Date().toDateString();
  if (gameState.lastActive !== today) {
    const yesterday = new Date(Date.now() - 86400000).toDateString();
    if (gameState.lastActive === yesterday) {
      gameState.streak++;
      if (gameState.streak >= 3) awardBadge('streak_3');
      if (gameState.streak >= 7) awardBadge('streak_7');
    } else if (gameState.lastActive) {
      gameState.streak = 1;
    } else {
      gameState.streak = 1;
    }
    gameState.lastActive = today;
    saveGame();
  }
}

// ===== CONFETTI =====
function triggerConfetti() {
  if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
  const container = document.getElementById('confettiContainer');
  const colors = ['#D4AF37', '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#0f766e'];
  for (let i = 0; i < 50; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    container.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3500);
  }
}

// ===== COMBO =====
function updateComboDisplay() {
  const comboEl = document.getElementById('comboDisplay');
  const countEl = document.getElementById('comboCount');
  if (consecutiveCorrect >= 2) {
    countEl.textContent = consecutiveCorrect;
    comboEl.classList.add('show');
  } else {
    comboEl.classList.remove('show');
  }
}

// ===== MOBILE SIDEBAR =====
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
  var btn = document.querySelector('.sidebar-toggle, .hamburger, .mobile-menu-btn'); if (btn) btn.setAttribute('aria-expanded', btn.getAttribute('aria-expanded') === 'true' ? 'false' : 'true');
}

// ===== RENDER =====
function renderAll() {
  updateStreak();
  renderSidebar();
  renderSlides();
  updateStatsDisplay();
  updateBadges();
  updateCourseProgress();
}

function updateStatsDisplay() {
  const levelData = LEVELS.find(l => l.level === gameState.level) || LEVELS[0];
  const nextLevel = LEVELS.find(l => l.level === gameState.level + 1);

  document.getElementById('levelIcon').textContent = levelData.icon;
  document.getElementById('levelTitle').textContent = levelData.title;
  document.getElementById('levelNum').textContent = gameState.level;

  const currentXP = gameState.xp - levelData.xp;
  const neededXP = nextLevel ? (nextLevel.xp - levelData.xp) : 500;
  const pct = Math.min(100, (currentXP / neededXP) * 100);

  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('xpCurrent').textContent = currentXP;
  document.getElementById('xpNeeded').textContent = neededXP;

  document.getElementById('correctCount').textContent = gameState.correctAnswers;
  document.getElementById('decisionCount').textContent = gameState.decisionsCompleted;
  document.getElementById('synthesisCount').textContent = gameState.completedModules.length;
  document.getElementById('streakCount').textContent = gameState.streak;

  const streakEl = document.getElementById('streakDisplay');
  streakEl.classList.toggle('active', gameState.streak > 0);
}

function updateBadges() {
  const grid = document.getElementById('badgesGrid');
  grid.innerHTML = BADGES.map(b => {
    const earned = gameState.badges.includes(b.id);
    const label = `${b.name}: ${b.desc}`;
    return `<button class="badge-item ${earned ? 'earned' : ''}" type="button" data-tooltip="${label}" aria-label="${label}" title="${label}" onclick="showBadgeDetails('${b.id}')">${b.icon}</button>`;
  }).join('');
}

function renderSidebar() {
  const list = document.getElementById('moduleList');
  list.innerHTML = MODULES.map((mod, i) => {
    const completed = gameState.completedModules.includes(mod.id);
    const locked = i > 0 && !gameState.completedModules.includes(MODULES[i-1].id);
    const estMins = Math.round(mod.slides.length * 1.5);
    return `
      <div class="module-item ${i === currentModule ? 'active' : ''} ${completed ? 'completed' : ''} ${locked ? 'locked' : ''}"
           onclick="${locked ? '' : `goToModule(${i})`}"
           tabindex="${locked ? -1 : 0}"
           role="button"
           aria-disabled="${locked ? 'true' : 'false'}">
        <div class="module-number">${completed ? 'OK' : (locked ? 'LK' : mod.id)}</div>
        <div class="module-info">
          <div class="module-title">${mod.title}</div>
          <div class="module-subtitle">${mod.subtitle}</div>
          <div class="module-xp">+${mod.xp} XP</div>
          <div class="module-time">Time ~${estMins} min</div>
        </div>
      </div>
    `;
  }).join('');
}

function renderSlides() {
  const container = document.getElementById('slidesContainer');
  container.innerHTML = MODULES.map((mod, mi) => {
    const progressPct = ((currentSlide + 1) / mod.slides.length) * 100;
    return `
    <div class="module-slides ${mi === currentModule ? 'active' : ''}" data-module="${mi}">
      <div class="slide-progress-bar" style="width: ${mi === currentModule ? progressPct : 0}%"></div>
      ${mod.slides.map((slide, si) => renderSlide(slide, si, mi)).join('')}
      <div class="slide-nav">
        <button class="nav-btn prev" onclick="prevSlide()" ${currentSlide === 0 ? 'disabled' : ''} aria-label="Previous slide">&lt;</button>
        <div class="nav-center">
          <div class="slide-counter">${currentSlide + 1} / ${mod.slides.length}</div>
          <div class="progress-dots">
            ${mod.slides.map((_, i) => `<button class="progress-dot ${i === currentSlide ? 'active' : ''}" type="button" onclick="goToSlide(${i})" aria-label="Go to slide ${i + 1}" ${i === currentSlide ? 'aria-current="true"' : ''}></button>`).join('')}
          </div>
        </div>
        <button class="nav-btn next" onclick="nextSlide()" aria-label="Next slide">&gt;</button>
      </div>
      <div class="keyboard-hint" style="position:absolute;bottom:5px;left:50%;transform:translateX(-50%);font-size:0.6rem;opacity:0.4;">Left / Right arrows or swipe to navigate</div>
    </div>
  `;
  }).join('');
  document.getElementById('currentModule').textContent = MODULES[currentModule].title;
  updateSlideVisibility();
}

function renderSlide(slide, index, moduleIndex) {
  const theme = slide.theme || 'dark';
  let html = `<div class="slide ${theme} ${index === currentSlide ? 'active' : ''}" data-slide="${index}">`;

  switch(slide.type) {
    case 'title':
      html += `<div class="content"><h1 class="title gold animate">${slide.content.title}</h1><p class="subtitle animate delay-1">${slide.content.subtitle}</p></div>`;
      break;

    case 'objectives':
      html += `<div class="content">
        <div class="objectives-box animate">
          <div class="objectives-header">
            <div class="objectives-icon">GOAL</div>
            <div class="objectives-title">Learning Objectives</div>
          </div>
          <ul class="objectives-list">
            ${slide.content.objectives.map(obj => `<li>${obj}</li>`).join('')}
          </ul>
        </div>
        ${slide.content.tip ? `<p class="subtitle animate delay-1" style="font-size:0.85rem;max-width:600px">${slide.content.tip}</p>` : ''}
      </div>`;
      break;

    case 'story':
      html += `<div class="content">
        <article class="story-box ${slide.content.success ? 'success' : ''} ${slide.content.warning ? 'warning' : ''} ${slide.content.teal ? 'teal' : ''} animate" role="article">
          <div class="story-label">${slide.content.label}</div>
          ${slide.content.title ? `<h2 class="title gold" style="font-size:1.8rem;margin-bottom:0.75rem">${slide.content.title}</h2>` : ''}
          <p class="story-text">${slide.content.text}</p>
          ${slide.content.followup ? `<p class="story-text" style="margin-top:0.75rem;font-style:italic;opacity:0.9">${slide.content.followup}</p>` : ''}
        </article>
      </div>`;
      break;

    case 'stats':
      html += `<div class="content">
        ${slide.content.title ? `<h2 class="title gold animate">${slide.content.title}</h2>` : ''}
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        <div class="stats-grid animate delay-2">
          ${slide.content.stats.map(s => `<div class="stat-box"><div class="stat-value gold">${s.value}</div><div class="stat-label">${s.label}</div></div>`).join('')}
        </div>
        ${slide.content.caption ? `<p class="subtitle animate delay-3" style="font-size:0.85rem;margin-top:0.75rem">${slide.content.caption}</p>` : ''}
      </div>`;
      break;

    case 'refrain':
      html += `<div class="content" style="justify-content:center;height:100%"><p class="refrain animate">"${slide.content.text}"</p></div>`;
      break;

    case 'concept':
      html += `<div class="content">
        <h2 class="title ${theme === 'light' ? 'navy' : 'gold'} animate">${slide.content.title}</h2>
        ${slide.content.subtitle ? `<p class="subtitle animate delay-1">${slide.content.subtitle}</p>` : ''}
        ${slide.content.text ? `<div class="card ${theme === 'light' ? '' : 'navy-bg'} animate delay-2"><p class="card-text">${slide.content.text}</p></div>` : ''}
        ${slide.content.highlight ? `<div class="story-box warning animate delay-3"><div class="story-label">Key Insight</div><p class="story-text">${slide.content.highlight}</p></div>` : ''}
        ${slide.content.checkpoints ? `
          <div class="timeline animate delay-2" style="margin-top:0.75rem">
            ${slide.content.checkpoints.map(cp => `
              <div class="timeline-item"><div class="timeline-days">${cp.day}</div><div class="timeline-content"><div class="timeline-title">${cp.event}</div></div></div>
            `).join('')}
          </div>
        ` : ''}
      </div>`;
      break;

    case 'checklist':
      html += `<div class="content">
        <h2 class="title gold animate">${slide.content.title}</h2>
        <div class="checklist animate delay-1">
          ${slide.content.items.map(item => `
            <div class="checklist-item">
              <div class="check-icon">OK</div>
              <div class="checklist-text">${item}</div>
            </div>
          `).join('')}
        </div>
      </div>`;
      break;

    case 'decision':
      const did = `dec_${moduleIndex}_${index}`;
      const answered = gameState.answeredQuestions[did];
      html += `<div class="content">
        <div class="decision-tree animate">
          <div class="decision-header">
            <div class="decision-icon">${slide.content.icon}</div>
            <div class="decision-title">${slide.content.title}</div>
            <div class="decision-xp">+${slide.content.xp} XP</div>
          </div>
          <div class="decision-scenario">${slide.content.scenario}</div>
          <div class="decision-question">${slide.content.question}</div>
          <div class="decision-options">
            ${slide.content.options.map(opt => {
              const isSelected = answered === opt.letter;
              const showCorrect = answered && opt.correct;
              const showIncorrect = answered && isSelected && !opt.correct;
              return `
                <div class="decision-option ${isSelected ? 'selected' : ''} ${showCorrect ? 'correct' : ''} ${showIncorrect ? 'incorrect' : ''} ${answered ? 'disabled' : ''}"
                     onclick="answerDecision('${did}', '${opt.letter}', ${opt.correct}, ${slide.content.xp})"
                     tabindex="0"
                     role="button"
                     aria-pressed="${isSelected ? 'true' : 'false'}"
                     aria-disabled="${answered ? 'true' : 'false'}">
                  <div class="option-letter">${opt.letter}</div>
                  <div class="option-text">${opt.text}</div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="decision-feedback ${answered ? 'show' : ''} ${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'correct' : 'incorrect'}" role="alert" aria-live="polite">
            <div class="feedback-title">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? 'Correct!' : 'Not quite'}</div>
            <div class="feedback-text">${answered && slide.content.options.find(o => o.letter === answered)?.correct ? slide.content.feedback.correct : slide.content.feedback.incorrect}</div>
            ${answered && !(slide.content.options.find(o => o.letter === answered)?.correct) ? `<div style="margin-top:0.5rem;font-size:0.8rem;color:var(--orange);font-weight:600;">Partial credit: +${Math.floor(slide.content.xp * 0.2)} XP</div>` : ''}
          </div>
        </div>
      </div>`;
      break;

    default:
      html += '<div class="slide-content"><p>Unknown slide type</p></div>';
      break;
  }

  html += '</div>';
  return html;
}

function updateSlideVisibility() {
  const container = document.querySelector('.module-slides.active');
  if (!container) return;

  container.querySelectorAll('.slide').forEach((slide, i) => {
    slide.classList.toggle('active', i === currentSlide);
  });

  const progressBar = container.querySelector('.slide-progress-bar');
  if (progressBar) {
    const pct = ((currentSlide + 1) / MODULES[currentModule].slides.length) * 100;
    progressBar.style.width = pct + '%';
  }

  container.querySelector('.slide-counter').textContent = `${currentSlide + 1} / ${MODULES[currentModule].slides.length}`;
  container.querySelectorAll('.progress-dot').forEach((dot, i) => {
    const isActive = i === currentSlide;
    dot.classList.toggle('active', isActive);
    if (isActive) {
      dot.setAttribute('aria-current', 'true');
    } else {
      dot.removeAttribute('aria-current');
    }
  });
  const prevBtn = container.querySelector('.nav-btn.prev');
  const nextBtn = container.querySelector('.nav-btn.next');
  if (prevBtn) prevBtn.disabled = currentSlide === 0;
  if (nextBtn) {
    const onLastSlide = currentSlide === MODULES[currentModule].slides.length - 1;
    nextBtn.disabled = onLastSlide && gameState.completedModules.includes(MODULES[currentModule].id);
  }
}

// ===== ANSWERS =====
function answerDecision(did, letter, correct, xp) {
  if (gameState.answeredQuestions[did] !== undefined) return;
  gameState.answeredQuestions[did] = letter;
  gameState.decisionsCompleted++;

  if (gameState.decisionsCompleted === 1) awardBadge('first_update');

  if (correct) {
    gameState.correctAnswers++;
    consecutiveCorrect++;
    addXP(xp);
    if (consecutiveCorrect >= 5) awardBadge('perfect_5');
    if (gameState.decisionsCompleted >= 18) awardBadge('decision_maker');
  } else {
    consecutiveCorrect = 0;
    addXP(Math.floor(xp * 0.2));
  }
  gameState.consecutiveCorrect = consecutiveCorrect;
  saveGame();
  renderSlides();
  updateComboDisplay();
  updateStatsDisplay();
}

// ===== NAVIGATION =====
function goToModule(index) {
  if (index > 0 && !gameState.completedModules.includes(MODULES[index-1].id)) return;
  currentModule = index;
  currentSlide = 0;
  renderSlides();
  renderSidebar();
}

function goToSlide(index) {
  currentSlide = index;
  updateSlideVisibility();
}

function nextSlide() {
  const mod = MODULES[currentModule];
  if (currentSlide < mod.slides.length - 1) {
    currentSlide++;
    updateSlideVisibility();
  } else {
    completeModule();
  }
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
    updateSlideVisibility();
  }
}

function completeModule() {
  const mod = MODULES[currentModule];
  if (!gameState.completedModules.includes(mod.id)) {
    gameState.completedModules.push(mod.id);
    addXP(mod.xp);

    // Module-specific badges
    if (mod.id === 2) awardBadge('signal_scout');
    if (mod.id === 3) awardBadge('protocol_anchor');
    if (mod.id === 4) awardBadge('screening_builder');
    if (mod.id === 5) awardBadge('threshold_judge');
    if (mod.id === 6) awardBadge('version_steward');
    if (mod.id === 7) awardBadge('sustainability_lead');
    if (gameState.completedModules.length === MODULES.length) awardBadge('finisher');

    saveGame();
    triggerConfetti();
    updateCourseProgress();
  }

  if (currentModule < MODULES.length - 1) {
    goToModule(currentModule + 1);
  } else if (gameState.completedModules.length === MODULES.length && !gameState.courseCompleted) {
    gameState.courseCompleted = true;
    saveGame();
    showCourseCompletion();
  }
}

function showCourseCompletion() {
  document.getElementById('completionXP').textContent = gameState.xp;
  document.getElementById('completionBadges').textContent = gameState.badges.length;
  document.getElementById('completionLevel').textContent = gameState.level;
  document.getElementById('completionOverlay').classList.add('show');
  triggerConfetti();
}

function closeCompletion() {
  document.getElementById('completionOverlay').classList.remove('show');
}

function reviewBadges() {
  document.getElementById('completionOverlay').classList.remove('show');
  // Scroll to badges panel and highlight it
  const badgesPanel = document.querySelector('.badges-panel');
  if (badgesPanel) {
    badgesPanel.scrollIntoView({ behavior: 'smooth', block: 'center' });
    badgesPanel.style.transition = 'box-shadow 0.3s ease';
    badgesPanel.style.boxShadow = '0 0 20px 5px rgba(212,175,55,0.6)';
    setTimeout(() => {
      badgesPanel.style.boxShadow = '';
    }, 2000);
  }
}

function downloadCertificate() {
  const courseName = 'Revisioni sistematiche viventi: il viaggio continuo delle prove';
  const completionDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const level = LEVELS[gameState.level - 1] || LEVELS[0];
  const badgeCount = gameState.badges.length;
  const totalXP = gameState.xp;

  const certHTML = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Certificate of Completion - ${courseName}</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Source+Sans+Pro:wght@400;600&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Source Sans Pro', sans-serif; background: #f5f5f5; padding: 20px; }
    .certificate {
      max-width: 800px; margin: 0 auto; background: linear-gradient(135deg, #1E2761 0%, #141B3D 100%);
      border: 8px solid #D4AF37; border-radius: 12px; padding: 60px 50px; text-align: center;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .cert-header { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 1rem; letter-spacing: 0.3em; text-transform: uppercase; margin-bottom: 10px; }
    .cert-title { font-family: 'Cormorant Garamond', serif; color: #FAF8F5; font-size: 3rem; font-weight: 700; margin-bottom: 30px; }
    .cert-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1rem; margin-bottom: 40px; }
    .cert-course { font-family: 'Cormorant Garamond', serif; color: #D4AF37; font-size: 2rem; font-weight: 600; margin-bottom: 15px; padding: 20px; border-top: 1px solid rgba(212,175,55,0.3); border-bottom: 1px solid rgba(212,175,55,0.3); }
    .cert-stats { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
    .cert-stat { text-align: center; }
    .cert-stat-value { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: #D4AF37; font-weight: 700; }
    .cert-stat-label { font-size: 0.8rem; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.1em; }
    .cert-date { color: rgba(255,255,255,0.7); font-size: 0.95rem; margin-top: 40px; }
    .cert-footer { margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(212,175,55,0.2); }
    .cert-issuer { color: rgba(255,255,255,0.5); font-size: 0.85rem; }
    .cert-badge { display: inline-block; margin-top: 15px; padding: 8px 20px; background: rgba(212,175,55,0.2); border: 1px solid rgba(212,175,55,0.4); border-radius: 20px; color: #D4AF37; font-size: 0.9rem; }
    @media print {
      body { background: white; padding: 0; }
      .certificate { box-shadow: none; }
    }
  </style>
</head>
<body>
  <div class="certificate">
    <div class="cert-header">Synthesis Course Collection</div>
    <div class="cert-title">Certificate of Completion</div>
    <div class="cert-subtitle">This certifies successful completion of</div>
    <div class="cert-course">${courseName}</div>
    <div class="cert-stats">
      <div class="cert-stat">
        <div class="cert-stat-value">${totalXP.toLocaleString()}</div>
        <div class="cert-stat-label">Total XP Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${badgeCount}</div>
        <div class="cert-stat-label">Badges Earned</div>
      </div>
      <div class="cert-stat">
        <div class="cert-stat-value">${level.title}</div>
        <div class="cert-stat-label">Final Level</div>
      </div>
    </div>
    <div class="cert-date">Completed on ${completionDate}</div>
    <div class="cert-footer">
      <div class="cert-issuer">Synthesis Course Collection ‚Äî Evidence Synthesis & Meta-Analysis Training</div>
      <div class="cert-badge">Verified Completion</div>
    </div>
  </div>
  <script>window.onload = () => window.print();<\/script>
</body>
</html>`;

  const blob = new Blob([certHTML], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Certificate-Living-Reviews-Course.html';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== KEYBOARD =====
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeBadgeModal();
    document.getElementById('completionOverlay').classList.remove('show');
    closeLevelModal();
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebarOverlay').classList.remove('show');
    return;
  }

  if ((e.target.classList.contains('module-item') || e.target.classList.contains('decision-option')) && (e.key === 'Enter' || e.key === ' ')) {
    e.preventDefault();
    e.target.click();
    return;
  }

  const isRoleButton = e.target && e.target.getAttribute && e.target.getAttribute('role') === 'button';
  const isFormControl = e.target && e.target.closest && e.target.closest('button, a, input, textarea, select');
  if (isRoleButton || isFormControl) {
    if (e.key === ' ' && isRoleButton) {
      e.preventDefault();
      e.target.click();
    }
    return;
  }

  if (e.key === 'ArrowRight' || e.key === ' ') {
    e.preventDefault();
    const mod = MODULES[currentModule];
    const onLastSlide = currentSlide === mod.slides.length - 1;
    if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
    nextSlide();
  } else if (e.key === 'ArrowLeft') {
    e.preventDefault();
    prevSlide();
  }
});

// ===== TOUCH =====
let touchStartX = 0;
document.addEventListener('touchstart', (e) => { touchStartX = e.changedTouches[0].screenX; }, { passive: true });
document.addEventListener('touchend', (e) => {
  const diff = touchStartX - e.changedTouches[0].screenX;
  if (Math.abs(diff) > 50) {
    if (diff > 0) {
      const mod = MODULES[currentModule];
      const onLastSlide = currentSlide === mod.slides.length - 1;
      if (onLastSlide && gameState.completedModules.includes(mod.id)) return;
      nextSlide();
    } else {
      prevSlide();
    }
  }
}, { passive: true });

// ===== INIT =====
renderAll();
</script>
</body>
</html>
