<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Preuves observationnelles¬†: Quand les ECR sont impossibles</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&amp;family=Source+Sans+Pro:wght@400;600&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script>
if (typeof Plotly === 'undefined') {
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('[id*="plot"], [id*="chart"], .plotly-graph-div, .js-plotly-plot').forEach(function(el) {
      el.innerHTML = '<div style="padding:2rem;text-align:center;background:#2a2a4a;border:1px dashed #D4AF37;border-radius:8px;color:#FAF8F5;margin:1rem 0;"><p style="font-size:1.1rem;margin-bottom:0.5rem;">Interactive chart unavailable offline</p><p style="font-size:0.85rem;opacity:0.7;">Connect to the internet to load interactive Plotly.js visualizations</p></div>';
    });
  });
}
</script>
<style>
:root {
  --navy: #1E2761;
  --deep-navy: #141B3D;
  --gold: #D4AF37;
  --cream: #FAF8F5;
  --red: #BF2D2D;
  --teal: #2D8B8B;
  --light-text: #718096;
  --green: #2D8B5F;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Source Sans Pro', sans-serif;
  background: var(--cream);
  color: var(--navy);
  min-height: 100vh;
  display: flex;
}

/* Skip Link for Accessibility */
.skip-link {
  position: absolute;
  top: -40px;
  left: 0;
  background: var(--gold);
  color: var(--navy);
  padding: 8px 16px;
  z-index: 1000;
  font-weight: 600;
  text-decoration: none;
  border-radius: 0 0 8px 0;
}

.skip-link:focus {
  top: 0;
}

/* Hamburger Menu */
.hamburger {
  display: none;
  position: fixed;
  top: 1rem;
  left: 1rem;
  z-index: 1001;
  background: var(--navy);
  border: none;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  flex-direction: column;
  gap: 4px;
}

.hamburger span {
  display: block;
  width: 24px;
  height: 3px;
  background: var(--gold);
  border-radius: 2px;
  transition: transform 0.3s;
}

.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  z-index: 999;
}

/* Sidebar */
.sidebar {
  width: 280px;
  background: var(--navy);
  padding: 2rem 1rem;
  display: flex;
  flex-direction: column;
  position: fixed;
  height: 100vh;
  overflow-y: auto;
  z-index: 1000;
}

.logo {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  color: var(--gold);
  margin-bottom: 0.5rem;
  text-align: center;
}

.tagline {
  font-size: 0.75rem;
  color: rgba(255,255,255,0.6);
  text-align: center;
  margin-bottom: 2rem;
  font-style: italic;
}

.nav-section {
  margin-bottom: 1.5rem;
}

.nav-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: rgba(255,255,255,0.4);
  margin-bottom: 0.75rem;
  padding-left: 0.5rem;
}

.module-item {
  display: flex;
  align-items: center;
  padding: 0.75rem;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  margin-bottom: 0.25rem;
  border: none;
  background: transparent;
  width: 100%;
  text-align: left;
  font-family: inherit;
  font-size: inherit;
}

.module-item:hover {
  background: rgba(255,255,255,0.1);
}

.module-item.active {
  background: rgba(212, 175, 55, 0.2);
  border-left: 3px solid var(--gold);
}

.module-item.completed .module-number {
  background: var(--green);
}

.module-number {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.8rem;
  color: white;
  margin-right: 0.75rem;
  flex-shrink: 0;
}

.module-info {
  flex: 1;
  min-width: 0;
}

.module-title {
  font-size: 0.9rem;
  color: white;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.module-subtitle {
  font-size: 0.7rem;
  color: rgba(255,255,255,0.5);
}

/* Main Content */
.main-content {
  flex: 1;
  margin-left: 280px;
  display: flex;
  flex-direction: column;
  min-height: 100vh;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 2rem;
  background: white;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  flex-wrap: wrap;
  gap: 1rem;
}

.progress-section {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.progress-bar {
  width: 200px;
  height: 8px;
  background: rgba(0,0,0,0.1);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--gold), var(--teal));
  border-radius: 4px;
  transition: width 0.3s;
}

.progress-text {
  font-size: 0.85rem;
  color: var(--light-text);
}

.points-display {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  background: linear-gradient(135deg, var(--navy), #2a3a7d);
  color: var(--gold);
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-weight: 600;
}

.top-actions {
  display: flex;
  gap: 0.5rem;
}

.action-btn {
  padding: 0.5rem 1rem;
  border: 1px solid var(--navy);
  background: transparent;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s;
}

.action-btn:hover {
  background: var(--navy);
  color: white;
}

/* Slide Container */
.slide-container {
  flex: 1;
  padding: 2rem;
  max-width: 900px;
  margin: 0 auto;
  width: 100%;
}

/* Slide Types */
.slide-title {
  text-align: center;
  padding: 4rem 2rem;
}

.slide-title h1 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 3rem;
  color: var(--navy);
  margin-bottom: 1rem;
}

.slide-title .subtitle {
  font-size: 1.5rem;
  color: var(--gold);
  margin-bottom: 1rem;
}

.slide-title .description {
  font-size: 1.1rem;
  color: var(--light-text);
  max-width: 600px;
  margin: 0 auto;
}

/* Principle Display */
.principle-box {
  background: linear-gradient(135deg, var(--navy), #2a3a7d);
  border-radius: 16px;
  padding: 3rem;
  text-align: center;
  margin: 2rem 0;
}

.principle-box .number {
  font-size: 4rem;
  color: var(--gold);
  font-family: 'Cormorant Garamond', serif;
  line-height: 1;
}

.principle-box .text {
  font-size: 1.8rem;
  color: white;
  font-family: 'Cormorant Garamond', serif;
  margin-top: 1rem;
  font-style: italic;
}

/* Story Deep */
.story-deep {
  background: linear-gradient(135deg, rgba(191,45,45,0.08), rgba(30,39,97,0.12));
  border-left: 4px solid var(--red);
  border-radius: 0 16px 16px 0;
  padding: 1.5rem;
  margin: 1.5rem 0;
}

.story-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--red);
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.story-source {
  font-size: 0.8rem;
  color: var(--light-text);
  margin-bottom: 1rem;
  font-style: italic;
}

.timeline {
  position: relative;
  padding-left: 2rem;
  margin: 1.5rem 0;
}

.timeline::before {
  content: '';
  position: absolute;
  left: 0.5rem;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, var(--gold), var(--red), var(--green));
}

.timeline-event {
  position: relative;
  margin-bottom: 1rem;
  padding-left: 1rem;
}

.timeline-event::before {
  content: '';
  position: absolute;
  left: -1.5rem;
  top: 0.5rem;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--gold);
}

.timeline-event.crisis::before {
  background: var(--red);
}

.timeline-event.revelation::before {
  background: var(--green);
}

.timeline-year {
  font-weight: 600;
  color: var(--gold);
  font-size: 0.9rem;
}

.timeline-text {
  color: var(--navy);
  font-size: 0.95rem;
  margin-top: 0.25rem;
}

.real-data-card {
  background: white;
  border: 2px solid var(--gold);
  border-radius: 12px;
  padding: 1rem;
  margin: 1rem 0;
}

.real-data-card h4 {
  color: var(--gold);
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.real-data-card h4::before {
  content: 'üìä';
}

.data-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 0.75rem;
}

.data-item {
  text-align: center;
}

.data-value {
  font-size: 1.1rem;
  font-weight: 600;
  color: var(--navy);
}

.data-label {
  font-size: 0.75rem;
  color: var(--light-text);
}

.story-hook {
  background: rgba(212, 175, 55, 0.1);
  border-left: 3px solid var(--gold);
  padding: 1rem;
  margin-top: 1rem;
  font-style: italic;
  color: var(--navy);
}

/* Story Box - Real World Case Studies */
.story-box {
  background: linear-gradient(135deg, rgba(45,139,95,0.08), rgba(30,39,97,0.10));
  border-left: 4px solid var(--green);
  border-radius: 0 16px 16px 0;
  padding: 1.5rem;
  margin: 1.5rem 0;
  box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}

.story-box-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 1rem;
}

.story-box-icon {
  font-size: 1.5rem;
}

.story-box-title {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  color: var(--navy);
  font-weight: 600;
}

.story-box-source {
  font-size: 0.75rem;
  color: var(--light-text);
  font-style: italic;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid rgba(0,0,0,0.08);
}

.story-box-content {
  color: var(--navy);
  line-height: 1.7;
  font-size: 0.95rem;
}

.story-box-content p {
  margin-bottom: 1rem;
}

.story-box-content p:last-child {
  margin-bottom: 0;
}

.story-box-lesson {
  background: rgba(212, 175, 55, 0.15);
  border-left: 3px solid var(--gold);
  padding: 1rem;
  margin-top: 1.25rem;
  border-radius: 0 8px 8px 0;
}

.story-box-lesson-label {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--gold);
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.story-box-lesson-text {
  color: var(--navy);
  font-weight: 500;
  font-size: 0.95rem;
  line-height: 1.5;
}

/* Content Box */
.content-box {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.content-box h3 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  color: var(--navy);
  margin-bottom: 1rem;
}

.content-section {
  margin-bottom: 1.25rem;
}

.content-section h4 {
  color: var(--teal);
  font-size: 1rem;
  margin-bottom: 0.5rem;
}

.content-section p {
  color: var(--navy);
  line-height: 1.6;
}

.content-section ul {
  list-style: none;
  padding-left: 0;
}

.content-section li {
  padding: 0.4rem 0;
  padding-left: 1.5rem;
  position: relative;
  color: var(--navy);
}

.content-section li::before {
  content: '‚Üí';
  position: absolute;
  left: 0;
  color: var(--gold);
}

/* Method Box */
.method-box {
  background: linear-gradient(135deg, rgba(45,139,139,0.08), rgba(30,39,97,0.08));
  border-left: 4px solid var(--teal);
  border-radius: 0 16px 16px 0;
  padding: 1.5rem;
  margin: 1.5rem 0;
}

.method-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  color: var(--teal);
  margin-bottom: 0.5rem;
  font-weight: 600;
}

.method-box h3 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  color: var(--navy);
  margin-bottom: 1rem;
}

/* Quiz */
.quiz-container {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.quiz-question {
  font-size: 1.1rem;
  color: var(--navy);
  margin-bottom: 1.5rem;
  font-weight: 600;
}

.quiz-options {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.quiz-option {
  padding: 1rem;
  border: 2px solid rgba(0,0,0,0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  text-align: left;
  font-size: 1rem;
  font-family: inherit;
  color: var(--navy);
}

.quiz-option:hover {
  border-color: var(--gold);
  background: rgba(212, 175, 55, 0.05);
}

.quiz-option.selected {
  border-color: var(--navy);
  background: rgba(30, 39, 97, 0.05);
}

.quiz-option.correct {
  border-color: var(--green);
  background: rgba(45, 139, 95, 0.1);
}

.quiz-option.incorrect {
  border-color: var(--red);
  background: rgba(191, 45, 45, 0.1);
}

.quiz-feedback {
  margin-top: 1rem;
  padding: 1rem;
  border-radius: 8px;
  display: none;
}

.quiz-feedback.show {
  display: block;
}

.quiz-feedback.correct {
  background: rgba(45, 139, 95, 0.1);
  border-left: 3px solid var(--green);
}

.quiz-feedback.incorrect {
  background: rgba(191, 45, 45, 0.1);
  border-left: 3px solid var(--red);
}

/* Decision Tree */
.decision-tree {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.decision-tree h3 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  color: var(--navy);
  margin-bottom: 1rem;
}

.decision-scenario {
  background: rgba(212, 175, 55, 0.1);
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  font-style: italic;
}

.decision-situation {
  background: rgba(30, 39, 97, 0.05);
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
}

.decision-question {
  font-weight: 600;
  color: var(--navy);
  margin-bottom: 1rem;
}

.decision-branches {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.decision-branch {
  padding: 1rem;
  border: 2px solid rgba(0,0,0,0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  background: white;
  text-align: left;
  font-family: inherit;
  font-size: 0.95rem;
  color: var(--navy);
  min-height: 48px;
}

.decision-branch:hover {
  border-color: var(--gold);
  background: rgba(212, 175, 55, 0.05);
}

.decision-outcome {
  padding: 1.5rem;
  border-radius: 8px;
  margin-top: 1rem;
}

.decision-outcome.good {
  background: rgba(45, 139, 95, 0.1);
  border-left: 4px solid var(--green);
}

.decision-outcome.bad {
  background: rgba(191, 45, 45, 0.1);
  border-left: 4px solid var(--red);
}

.decision-outcome.neutral {
  background: rgba(212, 175, 55, 0.1);
  border-left: 4px solid var(--gold);
}

.decision-outcome h4 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.2rem;
  margin-bottom: 0.5rem;
}

.decision-lesson {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(0,0,0,0.1);
  font-style: italic;
}

.decision-history {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.history-step {
  background: var(--navy);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.8rem;
}

.undo-btn {
  background: transparent;
  border: 1px solid var(--red);
  color: var(--red);
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  margin-bottom: 1rem;
}

.undo-btn:hover {
  background: var(--red);
  color: white;
}

/* Tool Container */
.tool-container {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  margin: 1rem 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  border: 2px solid var(--teal);
}

.tool-container h3 {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.3rem;
  color: var(--teal);
  margin-bottom: 0.5rem;
}

.tool-description {
  color: var(--light-text);
  margin-bottom: 1rem;
}

.tool-inputs {
  display: grid;
  gap: 1rem;
  margin-bottom: 1rem;
}

.input-group {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.input-group label {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--navy);
}

.input-group input, .input-group select, .input-group textarea {
  padding: 0.75rem;
  border: 1px solid rgba(0,0,0,0.2);
  border-radius: 6px;
  font-size: 1rem;
  font-family: inherit;
}

.input-group input:focus, .input-group select:focus, .input-group textarea:focus {
  outline: none;
  border-color: var(--teal);
}

.tool-btn {
  background: var(--teal);
  color: white;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: background 0.2s;
}

.tool-btn:hover {
  background: #247070;
}

.tool-output {
  margin-top: 1rem;
  padding: 1rem;
  background: rgba(45, 139, 139, 0.05);
  border-radius: 8px;
  border: 1px solid rgba(45, 139, 139, 0.2);
}

.plot-area {
  min-height: 350px;
  background: white;
  border-radius: 8px;
  margin: 1rem 0;
}

/* Navigation */
.nav-buttons {
  display: flex;
  justify-content: space-between;
  padding: 1rem 2rem;
  background: white;
  border-top: 1px solid rgba(0,0,0,0.1);
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  transition: all 0.2s;
}

.nav-btn.prev {
  background: transparent;
  border: 2px solid var(--navy);
  color: var(--navy);
}

.nav-btn.prev:hover {
  background: var(--navy);
  color: white;
}

.nav-btn.next {
  background: var(--gold);
  color: var(--navy);
}

.nav-btn.next:hover {
  background: #c9a032;
}

.nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Focus States for Accessibility */
button:focus, .module-item:focus, .quiz-option:focus,
.decision-branch:focus, input:focus, select:focus, a:focus {
  outline: 3px solid var(--gold);
  outline-offset: 2px;
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
  :root {
    --gold: #FFD700;
    --cream: #FFFFFF;
  }
}

/* Focus-visible styles for keyboard navigation */
:focus-visible {
  outline: 2px solid var(--gold, #D4AF37);
  outline-offset: 2px;
}

:focus:not(:focus-visible) {
  outline: none;
}

button:focus-visible,
a:focus-visible,
[role="button"]:focus-visible,
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: 2px solid var(--gold, #D4AF37);
  outline-offset: 2px;
  box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.3);
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    transition-duration: 0.01ms !important;
  }
}

/* Screen Reader Only */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
  .hamburger {
    display: flex;
  }

  .sidebar {
    transform: translateX(-100%);
    transition: transform 0.3s;
  }

  .sidebar.open {
    transform: translateX(0);
  }

  .sidebar-overlay.show {
    display: block;
  }

  .main-content {
    margin-left: 0;
  }

  .slide-title h1 {
    font-size: 2rem;
  }

  .principle-box .text {
    font-size: 1.4rem;
  }

  .top-bar {
    padding: 1rem;
  }

  .progress-bar {
    width: 120px;
  }

  .decision-branch {
    min-height: 48px;
  }

  .quiz-option {
    min-height: 48px;
  }
}

@media (max-width: 480px) {
  .sidebar {
    width: 100%;
  }

  .slide-container {
    padding: 1rem;
  }

  .story-deep, .method-box, .content-box {
    padding: 1rem;
  }

  .data-grid {
    grid-template-columns: 1fr 1fr;
  }

  .top-actions {
    width: 100%;
    justify-content: center;
  }
}

/* Time Estimates */
.time-estimate {
  color: var(--teal);
  font-weight: 600;
  font-size: 0.65rem;
}

.course-time {
  font-size: 0.8rem;
  color: var(--light-text);
  padding: 0.25rem 0.75rem;
  background: rgba(45, 139, 139, 0.1);
  border-radius: 12px;
}

/* Badge Notification */
.badge-notification {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: linear-gradient(135deg, var(--navy), #2a3a7d);
  border-radius: 16px;
  padding: 1rem 1.5rem;
  display: flex;
  align-items: center;
  gap: 1rem;
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
  z-index: 3000;
  transform: translateY(100px);
  opacity: 0;
  transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.badge-notification.show {
  transform: translateY(0);
  opacity: 1;
}

.badge-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.badge-info {
  color: white;
}

.badge-earned {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--gold);
  margin-bottom: 0.25rem;
}

.badge-name {
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.2rem;
  font-weight: 600;
}

/* Badge Grid in Modal */
.badge-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 1rem;
  margin-top: 1rem;
}

.badge-card {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  text-align: center;
  border: 2px solid transparent;
  transition: all 0.3s;
}

.badge-card.earned {
  border-color: var(--gold);
  box-shadow: 0 4px 12px rgba(212, 175, 55, 0.2);
}

.badge-card.locked {
  opacity: 0.5;
  filter: grayscale(1);
}

.badge-card .badge-icon {
  width: 56px;
  height: 56px;
  margin: 0 auto 0.75rem;
  font-size: 1.75rem;
}

.badge-card .badge-name {
  color: var(--navy);
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.badge-card .badge-requirement {
  font-size: 0.75rem;
  color: var(--light-text);
}

/* Mastery Checkpoint */
.mastery-checkpoint {
  background: linear-gradient(135deg, rgba(45, 139, 95, 0.15), rgba(45, 139, 139, 0.1));
  border: 2px solid var(--green);
  border-radius: 16px;
  padding: 1.5rem;
  margin: 2rem 0;
  text-align: center;
}

.mastery-checkpoint h3 {
  color: var(--green);
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

.mastery-checkpoint .mastery-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.mastery-checkpoint p {
  color: var(--navy);
  font-size: 1rem;
  margin: 0;
}

.mastery-checkpoint .mastery-stats {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid rgba(45, 139, 95, 0.3);
}

.mastery-stat {
  text-align: center;
}

.mastery-stat .stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--green);
}

.mastery-stat .stat-label {
  font-size: 0.75rem;
  color: var(--light-text);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* IPTW Deep Dive Box */
.iptw-deepdive {
  background: linear-gradient(135deg, rgba(212, 175, 55, 0.1), rgba(30, 39, 97, 0.08));
  border-left: 4px solid var(--gold);
  border-radius: 0 12px 12px 0;
  padding: 1.25rem;
  margin: 1rem 0;
}

.iptw-deepdive h4 {
  color: var(--gold);
  font-family: 'Cormorant Garamond', serif;
  font-size: 1.1rem;
  margin-bottom: 0.75rem;
}

.iptw-formula {
  font-family: monospace;
  background: rgba(30, 39, 97, 0.1);
  padding: 0.5rem 1rem;
  border-radius: 6px;
  margin: 0.5rem 0;
  color: var(--navy);
}
  </style>
</head>
<body>
<a class="skip-link" href="#main-content">Skip to main content</a>
<button aria-expanded="false" aria-label="Toggle navigation menu" class="hamburger">
<span></span>
<span></span>
<span></span>
</button>
<div class="sidebar-overlay"></div>
<nav aria-label="Modules du cours" class="sidebar" role="navigation">
<a href="index.html" onmouseout="this.style.color='rgba(212,175,55,0.7)'" onmouseover="this.style.color='#D4AF37'" style="display:block;font-size:0.7rem;color:rgba(212,175,55,0.7);text-decoration:none;margin-bottom:0.5rem;padding:0.5rem 1rem 0;">‚Üê Course Library</a>
<div class="logo">Observational Evidence</div>
<div class="tagline">Quand les ECR sont impossibles</div>
<div class="nav-section">
<div class="nav-label">Modules</div>
<div id="module-nav"></div>
</div>
</nav>
<main class="main-content" id="main-content">
<div class="top-bar">
<div class="progress-section">
<div class="progress-bar">
<div class="progress-fill" id="progress-fill" style="width: 0%"></div>
</div>
<span class="progress-text" id="progress-text">0% Complete</span>
</div>
<div class="points-display">
<span id="points-display">0</span> XP
      </div>
<div class="course-time">
<span id="total-time">5h 30m total</span>
</div>
<div class="top-actions">
<button class="action-btn" onclick="openBadges()">üèÜ Badges</button>
<button class="action-btn" onclick="openGlossary()">Glossary</button>
<button class="action-btn" onclick="openToolLibrary()">Tools</button>
</div>
</div>
<div class="slide-container" id="slide-container"></div>
<div aria-live="polite" class="sr-only" id="slide-announce"></div>
<div class="nav-buttons">
<button class="nav-btn prev" id="prev-btn" onclick="prevSlide()">
<span>‚Üê</span> Previous
      </button>
<button class="nav-btn next" id="next-btn" onclick="nextSlide()">
        Next <span>‚Üí</span>
</button>
</div>
</main>
<script>
// Course Data
const STORAGE_KEY = 'observational-evidence-course-progress';

let currentModule = 0;
let currentSlide = 0;
let gameState = {
  points: 0,
  earnedBadges: [],
  toolsUsed: [],
  modulesCompleted: [],
  scenariosCompleted: {},
  decisionTrees: {}
};

// Badge Definitions with visual designs
const BADGES = {
  'bias-detective': { name: 'Bias Detective', icon: 'üîç', color: '#BF2D2D', requirement: 'Terminez tous les modules sur les pr√©jug√©s' },
  'dag-master': { name: 'DAG Master', icon: 'üï∏Ô∏è', color: '#2D8B8B', requirement: 'Build 3 DAGs correctly' },
  'robins-ranger': { name: 'ROBINS Ranger', icon: 'üõ°Ô∏è', color: '#D4AF37', requirement: 'Terminez 5 √©valuations ROBINS-I' },
  'story-scholar': { name: 'Story Scholar', icon: 'üìö', color: '#1e2761', requirement: 'Lisez les 16 √©tudes de cas' },
  'decision-ace': { name: 'Decision Ace', icon: 'üéØ', color: '#2D8B5F', requirement: 'Compl√©tez les 19 arbres de d√©cision' },
  'quiz-champion': { name: 'Quiz Champion', icon: 'üèÜ', color: '#9B59B6', requirement: 'Score 100% on all quizzes' },
  'methods-master': { name: 'Methods Master', icon: 'üéì', color: '#E67E22', requirement: 'Compl√©tez l\'int√©gralit√© cours' },
  'capstone-conqueror': { name: 'Capstone Conqueror', icon: 'üëë', color: '#C0392B', requirement: 'Terminez les 3 sc√©narios de synth√®se' }
};

const modules = [
  {
    id: 0,
    title: "The Opening",
    subtitle: "Pourquoi les preuves observationnelles sont importantes",
    principle: null,
    estimatedTime: "15 min",
    slides: [
      {
        type: 'title',
        content: {
          title: "Observational Evidence",
          subtitle: "Quand les ECR sont impossibles",
          text: "Apprenez √† extraire la v√©rit√© de donn√©es d√©sordonn√©es du monde r√©el √† travers les histoires de ceux qui ont √©t√© tromp√©s - et de ceux qui ont sauv√© des vies sans qu'une seule randomisation essai."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE SALVATION: THALIDOMIDE ‚Äî WHEN OBSERVATION SAVED LIVES",
          source: "Lancet 1961; McBride | BMJ 1961; Lenz | No RCT existed",
          timeline: [
            { year: "1957", text: "Thalidomide marketed in Germany as 'completely safe' sedative. Sold over-the-counter. Pregnant women take it for morning sickness.", type: "normal" },
            { year: "1959-60", text: "Reports of peripheral neuropathy emerge. Company dismisses concerns. No systematic monitoring exists.", type: "normal" },
            { year: "Nov 1961", text: "Dr. William McBride in Australia notices pattern: mothers of babies with limb defects took thalidomide. He writes to Lancet.", type: "revelation" },
            { year: "Nov 1961", text: "Dr. Widukind Lenz in Germany independently identifies the same pattern through case-control reasoning.", type: "revelation" },
            { year: "Dec 1961", text: "Drug withdrawn worldwide. 10,000+ children affected. Two observant physicians saved countless more.", type: "crisis" },
            { year: "Legacy", text: "Modern pharmacovigilance born. FDA strengthened. The lesson: OBSERVATIONAL DATA can detect harms RCTs miss.", type: "revelation" }
          ],
          realData: {
            endpoint: "Phocomelia (limb defects)",
            drug: "Thalidomide exposure in first trimester",
            placebo: "No exposure",
            rr: "Case-control OR > 100",
            ci: "Unquestionable association",
            nnh: "~10,000 children affected"
          },
          hook: "THE HOOK: No RCT detected thalidomide's harm. Two physicians, using observational reasoning, saw a pattern and saved a generation. This course teaches you to see patterns ‚Äî and to know when they're real."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è APER√áU CL√â¬†: La thalidomide prouve que les preuves observationnelles peuvent SAUVER des vies. Mais le THS prouve qu‚Äôil peut aussi TROMPER. La question n'est pas de savoir s'il faut utiliser les donn√©es d'observation¬†: il s'agit plut√¥t de savoir comment les utiliser judicieusement."
        }
      },
      {
        type: 'content',
        content: {
          title: "When RCTs Are Impossible or Insufficient",
          sections: [
            {
              heading: "RCTs Cannot Answer These Questions:",
              items: [
                "Rare harms (need millions of patients, decades of follow-up)",
                "Long-term outcomes (RCTs rarely last >5 years)",
                "Real-world effectiveness (RCTs select ideal patients)",
                "Unethical randomization (can't randomize smoking, poverty)",
                "Historical questions (what happened before RCTs existed?)"
              ]
            },
            {
              heading: "Observational Data Can:",
              items: [
                "Detect rare adverse events (thalidomide, Vioxx)",
                "Track lifetime outcomes (Framingham, Nurses' Health)",
                "√âtudiez les populations du monde r√©el (pas seulement √©ligibles aux essais)",
                "Generate hypotheses for future RCTs",
                "Monitor post-marketing drug safety"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Les sept principes des preuves d'observation",
          sections: [
            {
              heading: "Your Guide Through This Course:",
              items: [
                "1. \"Association is not causation\" ‚Äî Confounding deceives",
                "2. \"Time flows one direction\" ‚Äî Temporality matters",
                "3. \\\"Vous voyez ce que vous cherchez\\\" ‚Äî Le biais de s√©lection se cache",
                "4. \"Measurement shapes reality\" ‚Äî Information bias distorts",
                "5. \"Context determines meaning\" ‚Äî Effect modification exists",
                "6. \"Adjustment is not magic\" ‚Äî Residual confounding remains",
                "7. \"Replication builds confidence\" ‚Äî One study is never enough"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Comment fonctionne ce cours",
          sections: [
            {
              heading: "Each Module Contains:",
              items: [
                "üìñ UNE HISTOIRE ‚Äî V√©ritables d√©sastres et triomphes de la recherche observationnelle",
                "üîß LA M√âTHODE ‚Äî Comment le faire correctement",
                "‚öôÔ∏è L'OUTIL ‚Äî Pratique interactive",
                "üîÄ LE SC√âNARIO ‚Äî Appliquez votre jugement",
                "‚úÖ LE QUIZ ‚Äî Testez votre compr√©hension"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'rct-vs-obs-decision',
          title: "Quand avez-vous besoin de donn√©es d'observation¬†?",
          situation: "You're a researcher deciding how to study a clinical question. For each scenario, decide: RCT or observational?",
          nodes: {
            start: {
              question: "SC√âNARIO¬†: Vous souhaitez √©tudier si le tabagisme provoque le cancer du poumon. Quel mod√®le d'√©tude¬†?",
              branches: [
                { text: "RCT ‚Äî randomize people to smoke or not smoke", nextNode: "rct_smoking_wrong" },
                { text: "Observatoire¬†: suivez les fumeurs et les non-fumeurs au fil du temps", nextNode: "obs_smoking_correct" }
              ]
            },
            rct_smoking_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Ethically impossible!",
              text: "Vous ne pouvez pas randomiser les personnes pour qu'elles fument¬†: cela serait nocif. C‚Äôest pr√©cis√©ment pourquoi les preuves observationnelles √©taient essentielles pour √©tablir le tabagisme ‚Üí le cancer du poumon. Doll et Hill ont eu recours √† des √©tudes de cohorte parce que les ECR √©taient contraires √† l'√©thique.",
              lesson: "Lorsque l'exposition CAUSE un pr√©judice, la randomisation est contraire √† l'√©thique. Les donn√©es d'observation sont la seule option."
            },
            obs_smoking_correct: {
              situation: "Correct! Smoking studies must be observational. NEXT SCENARIO:",
              question: "You want to know if a new diabetes drug reduces heart attacks. What design?",
              branches: [
                { text: "RCT ‚Äî randomize patients to drug vs placebo", nextNode: "rct_drug_correct" },
                { text: "Observational ‚Äî compare patients who chose the drug", nextNode: "obs_drug_partial" }
              ]
            },
            rct_drug_correct: {
              situation: "Id√©al¬†! Mais l'ECR prendra 5 ans et 10 000 patients. La direction souhaite une r√©ponse dans 6 mois en utilisant les donn√©es des sinistres. Qu'en dites-vous ?",
              question: "Your response:",
              branches: [
                { text: "L'√©tude observationnelle ‚Äî la rapidit√© compte", nextNode: "speed_wrong" },
                { text: "Expliquez que les donn√©es observationnelles pour cette question seront confondues", nextNode: "explain_correct" }
              ]
            },
            obs_drug_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible, but risky",
              text: "Les √©tudes observationnelles sur les effets des m√©dicaments ont de graves confusions selon l'indication ‚Äî les patients les plus malades re√ßoivent le m√©dicament. Vous d√©couvrirez peut-√™tre que le m√©dicament PROVOQUE des crises cardiaques simplement parce qu‚Äôon le prescrit √† des patients sujets aux crises cardiaques. C'est la le√ßon du THS.",
              lesson: "Pour les affections traitables, les ECR sont pr√©f√©r√©s lorsque cela est possible. Les √©tudes observationnelles sur les m√©dicaments n√©cessitent une conception tr√®s soign√©e (comparateur actif, nouvel utilisateur, √©mulation d'essai cible)."
            },
            speed_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "C'est ainsi que le THS s'est produit¬†!",
              text: "Les √©tudes observationnelles sur le THS ont √©t√© r√©alis√©es parce qu'elles √©taient plus rapides et plus faciles que les ECR. Ils ont donn√© la mauvaise r√©ponse pendant 20 ans. La rapidit√© sans validit√© est pire que l'attente.",
              lesson: "Les mauvaises r√©ponses rapides nuisent aux patients. Si les preuves observationnelles sont trop biais√©es, il est pr√©f√©rable d'attendre un ECR."
            },
            explain_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Excellent scientific judgment!",
              text: "Vous avez correctement identifi√© que cette question (m√©dicament ‚Üí r√©sultat cardiovasculaire) est tr√®s susceptible d'√™tre confondue par indication. Les preuves observationnelles ici ne seraient pas fiables. L'ECR vaut la peine d'attendre.",
              lesson: "Sachez quand les donn√©es d'observation PEUVENT et NE PEUVENT PAS r√©pondre √† votre question. L'efficacit√© des m√©dicaments avec une confusion selon l'indication est un territoire dangereux."
            }
          }
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: As you learn observational methods, remember both faces of the coin. Thalidomide shows observation SAVES lives. But this course will also show how it COSTS lives when done carelessly. Stay humble. Stay skeptical. Stay curious."
        }
      }
    ]
  },
  {
    id: 1,
    title: "The Trap",
    subtitle: "Confounding",
    principle: 0,
    story: "HRT",
    estimatedTime: "25 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "L'association n'est pas un lien de causalit√©"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA TROMPERIE¬†: THS ‚Äî LORSQUE 30 √âTUDES ONT MENTI",
          source: "JAMA 2002; 288:321-333 | WHI Writing Group | PubMed: 12117397",
          timeline: [
            { year: "1960s-80s", text: "Observational studies consistently show HRT reduces CHD by 40-50%. Biological rationale compelling: estrogen improves lipids.", type: "normal" },
            { year: "1985", text: "Framingham: Women on HRT have 50% lower CHD risk. Millions of prescriptions written for 'cardioprotection.'", type: "normal" },
            { year: "1991", text: "√âtude sur la sant√© des infirmi√®res¬†: RR 0,56 (IC √† 95¬†% 0,40-0,80) pour CHD. Preuve ¬´ d√©finitive ¬ª. Le THS devient la norme de soins.", type: "normal" },
            { year: "1998", text: "HERS trial (first large RCT): HR 0.99 (0.81-1.22). NO BENEFIT. Dismissed as 'wrong population.'", type: "crisis" },
            { year: "Jul 2002", text: "WHI arr√™t√© pour HARM. CHD HR 1,29 (1,02-1,63). Le cancer du sein a augment√©. Les plus de 30 √©tudes √©taient TOUTES FAUX.", type: "crisis" },
            { year: "The Truth", text: "Healthy user bias: Women who chose HRT were healthier, richer, more educated, exercised more. The 'benefit' was confounding.", type: "revelation" }
          ],
          realData: {
            endpoint: "Coronary heart disease",
            drug: "Observational: RR 0.56 (0.40-0.80)",
            placebo: "RCT (WHI): HR 1.29 (1.02-1.63)",
            rr: "OPPOSITE DIRECTIONS",
            ci: "Confounding flipped benefit to harm",
            nnh: "Millions of women misled for decades"
          },
          hook: "THE QUESTION: How can 30 observational studies, 40+ meta-analyses, and 'compelling' biological rationale all be wrong? Because they measured WHO TAKES HRT, not WHAT HRT DOES. The women who chose HRT were already healthier. Confounding is invisible ‚Äî until an RCT exposes it."
        }
      },
      {
        type: 'story-box',
        content: {
          icon: 'üíî',
          title: "The HRT Reversal: 20 Years of Wrong Answers",
          source: "Women's Health Initiative, JAMA 2002",
          paragraphs: [
            "For decades, observational studies showed women on hormone replacement therapy had 50% fewer heart attacks. The biological rationale was compelling: estrogen improves lipid profiles. Millions of women were prescribed HRT specifically for 'cardioprotection.'",
            "Ensuite, l'ECR de la Women's Health Initiative (2002) a provoqu√© un choc¬†: le THS a en fait AUGMENT√â les crises cardiaques de 29¬†%. L'essai a √©t√© interrompu pr√©matur√©ment pour cause de pr√©judice.",
            "What went wrong? The observational studies suffered from 'healthy user bias.' Women who chose HRT were wealthier, more educated, more health-conscious, and more likely to exercise. They would have had fewer heart attacks regardless of HRT. The studies were measuring the TYPE of woman who took HRT, not what HRT actually did."
          ],
          lesson: "Confounding created a false signal that lasted 20 years and influenced millions of prescriptions. When you observe that users of something have better outcomes, always ask: are they better off BECAUSE of the treatment, or were they already different?"
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: HRT's 'benefit' wasn't from the drug ‚Äî it was from the type of woman who chose to take it. Confounders are variables that affect BOTH the exposure and the outcome. Unless you account for them, you're measuring the confounder, not the treatment."
        }
      },
      {
        type: 'content',
        content: {
          title: "What is Confounding?",
          sections: [
            {
              heading: "The Three Conditions for Confounding:",
              items: [
                "1. Le confondeur est associ√© √† EXPOSURE",
                "2. Le facteur de confusion est associ√© au OUTCOME",
                "3. Le facteur de confusion n'est PAS sur la voie causale"
              ]
            },
            {
              heading: "HRT Example:",
              items: [
                "Confounder: Socioeconomic status / health consciousness",
                "Associated with exposure: Wealthy, educated women more likely to seek HRT",
                "Associated with outcome: Wealthy, educated women have lower CHD risk anyway",
                "Not on causal pathway: SES doesn't mediate HRT's biological effect",
                "R√©sultat¬†: le THS semble b√©n√©fique car les utilisateurs du THS √©taient en meilleure sant√© au d√©part"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: IDENTIFICATION DES CONFONDEURS",
          title: "Thinking Causally",
          sections: [
            {
              heading: "Step 1: Draw a DAG (Directed Acyclic Graph)",
              text: "Visualisez les relations causales entre l'exposition, le r√©sultat et les facteurs de confusion potentiels. Les fl√®ches indiquent la direction causale."
            },
            {
              heading: "Step 2: Identify Backdoor Paths",
              text: "Tout chemin allant de l'exposition au r√©sultat qui va en ARRI√àRE via une cause commune est un chemin confondant qui doit √™tre bloqu√©."
            },
            {
              heading: "Step 3: Decide What to Adjust For",
              text: "Ajustez les facteurs confondants (causes communes). NE PAS ajuster les effets des m√©diateurs (sur le chemin causal) ou des collisionneurs (effets courants)."
            },
            {
              heading: "Step 4: Assess Residual Confounding",
              text: "Even after adjustment, unmeasured confounders remain. Sensitivity analysis can estimate their potential impact."
            }
          ]
        }
      },
      {
        type: 'tool',
        content: {
          id: 'dag-builder',
          title: "DAG Builder",
          description: "Build a Directed Acyclic Graph to visualize causal relationships and identify confounders"
        }
      },
      {
        type: 'story-box',
        content: {
          icon: '‚òï',
          title: "Le paradoxe du caf√© de l'√©tude sur la sant√© des infirmi√®res",
          source: "Nurses' Health Study, Multiple Publications 1980s-2000s",
          paragraphs: [
            "Les premi√®res analyses de l'√©tude sur la sant√© des infirmi√®res ont r√©v√©l√© un lien troublant¬†: les buveurs de caf√© pr√©sentaient des taux plus √©lev√©s de maladies cardiaques. Les directives m√©dicales ont commenc√© √† mettre en garde contre la consommation de caf√©. L'association semblait claire dans les donn√©es.",
            "Then researchers noticed something: coffee drinkers smoked more. In that era, coffee and cigarettes went together. When smoking was properly adjusted for, the coffee-heart disease link vanished entirely.",
            "Mais l'histoire ne s'arr√™te pas l√†. Des √©tudes ult√©rieures utilisant de meilleures m√©thodes et un suivi plus long ont montr√© que le caf√© pourrait en fait √™tre PROTECTEUR contre les maladies cardiaques, le diab√®te de type 2 et certains cancers. Le m√™me ensemble de donn√©es, analys√© avec un meilleur contr√¥le de confusion, est parvenu √† la conclusion oppos√©e."
          ],
          lesson: "Le contr√¥le de confusion n'est pas seulement important¬†: il peut compl√®tement inverser vos conclusions. L'histoire du caf√© montre comment une association n√©faste peut devenir nulle, puis devenir protectrice, le tout √† partir des m√™mes donn√©es sous-jacentes lorsqu'elles sont analys√©es avec des m√©thodes de plus en plus am√©lior√©es."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'confounding_decision_tree',
          title: "L'√©nigme du caf√©",
          situation: "You're analyzing observational data on coffee consumption and mortality. Your crude analysis shows coffee drinkers have 15% higher mortality (RR 1.15, p<0.01). A colleague suggests this proves coffee is harmful.",
          nodes: {
            start: {
              id: 'start',
              situation: "Avant de publier \"COFFEE KILLS\", vous r√©fl√©chissez aux facteurs de confusion potentiels. Quelle est votre premi√®re pens√©e¬†?",
              question: "Quel facteur de confusion vous pr√©occupe le plus¬†?",
              branches: [
                { id: 'smoking', text: "Smoking ‚Äî coffee drinkers smoke more", nextNode: 'smoking_path' },
                { id: 'age', text: "Age ‚Äî older people drink more coffee", nextNode: 'age_path' },
                { id: 'no_confounder', text: "L'association est r√©elle¬†: publiez telle quelle", nextNode: 'publish_crude' }
              ]
            },
            smoking_path: {
              id: 'smoking_path',
              situation: "Vous stratifiez selon le statut de fumeur. Parmi les non-fumeurs¬†: RR 0,92 (0,85-0,99). Chez les fumeurs : RR 1,35 (1,20-1,52). Le RR brut de 1,15 a √©t√© confondu par le tabagisme.",
              question: "Que concluez-vous¬†?",
              branches: [
                { id: 'coffee_protective', text: "Coffee is actually protective (in non-smokers)", nextNode: 'protective_finding' },
                { id: 'more_analysis', text: "Need to adjust for more confounders before concluding", nextNode: 'multivariate' },
                { id: 'effect_modification', text: "Cela ressemble √† une modification d'effet, pas seulement √† une confusion", nextNode: 'effect_mod_insight' }
              ]
            },
            age_path: {
              id: 'age_path',
              situation: "You check age distribution. Mean age: coffee drinkers 58 years, non-drinkers 52 years. Older people drink more coffee AND have higher mortality. Classic confounding.",
              question: "Comment proc√©dez-vous¬†?",
              branches: [
                { id: 'age_adjust', text: "Ajuster en fonction de l'√¢ge et r√©analyser", nextNode: 'age_adjusted' },
                { id: 'age_stratify', text: "Stratify by age groups", nextNode: 'age_stratified' }
              ]
            },
            publish_crude: {
              id: 'publish_crude',
              type: 'outcome',
              consequence: 'bad',
              title: "La panique du caf√©",
              text: "Your paper is published. Headlines: 'COFFEE INCREASES DEATH RISK BY 15%'. Three months later, another team adjusts for smoking ‚Äî finding coffee is protective. Your paper is criticized as a textbook example of confounding. Your credibility suffers.",
              lesson: "LA CONS√âQUENCE¬†: Chaque association d'observation a des facteurs de confusion potentiels. Publier des associations grossi√®res sans tenir compte de la confusion n‚Äôest pas de la science ‚Äì c‚Äôest de la sp√©culation. L'histoire du THS aurait d√ª nous l'apprendre."
            },
            protective_finding: {
              id: 'protective_finding',
              type: 'outcome',
              consequence: 'neutral',
              title: "Partial Credit",
              text: "Adjusting for smoking reveals coffee's apparent protective effect. But other confounders remain: socioeconomic status, diet, exercise. The non-smokers who drink coffee may still differ from non-smokers who don't.",
              lesson: "THE GRADUAL REVEAL: Adjusting for one confounder is better than none, but rarely sufficient. Multiple confounders usually exist. Each adjustment can reveal new associations ‚Äî or new biases."
            },
            multivariate: {
              id: 'multivariate',
              situation: "You build a multivariate model adjusting for: smoking, age, BMI, alcohol, income, education, exercise. Adjusted RR: 0.88 (0.82-0.95). Coffee appears protective after accounting for measured confounders.",
              question: "Can you now conclude coffee prevents death?",
              branches: [
                { id: 'conclude_protective', text: "Oui ‚Äî l'analyse ajust√©e est causale", nextNode: 'overclaiming' },
                { id: 'residual_confounding', text: "No ‚Äî unmeasured confounders may remain", nextNode: 'wise_conclusion' }
              ]
            },
            effect_mod_insight: {
              id: 'effect_mod_insight',
              type: 'outcome',
              consequence: 'good',
              title: "Sharp Thinking",
              text: "Vous avez remarqu√© que l'effet diff√®re selon le statut tabagique (nocif chez les fumeurs, protecteur chez les non-fumeurs). Il s‚Äôagit d‚Äôune modification d‚Äôeffet ‚Äì l‚Äôeffet du caf√© diff√®re v√©ritablement selon les sous-groupes. D√©clarer un effet moyen unique serait trompeur.",
              lesson: "THE PROTECTION: Confounding distorts the overall effect. Effect modification means the effect truly varies. In your paper, report stratum-specific effects: 'Coffee was associated with lower mortality in non-smokers (RR 0.92) but higher mortality in smokers (RR 1.35).'"
            },
            age_adjusted: {
              id: 'age_adjusted',
              situation: "Apr√®s ajustement selon l'√¢ge¬†: RR 1,02 (0,95-1,10). L'association a disparu ! L‚Äô√¢ge √©tait un facteur de confusion important. Mais attendez¬†: devriez-vous √©galement vous adapter au tabagisme¬†?",
              isEnding: true,
              outcome: 'neutral',
              lesson: "THE REPETITION: One confounder down, potentially many to go. Age adjustment removed most of the crude association. But comprehensive analysis requires considering ALL major confounders. The job isn't done."
            },
            age_stratified: {
              id: 'age_stratified',
              situation: "Age-stratified results: <50 years: RR 0.95. 50-65 years: RR 1.01. >65 years: RR 0.98. No age group shows significant association. The crude RR 1.15 was entirely due to age confounding.",
              isEnding: true,
              outcome: 'good',
              lesson: "THE REVELATION: Stratification lets you SEE the confounding. In every age stratum, coffee shows no association with mortality. The crude association was an artifact of age differences between coffee drinkers and non-drinkers."
            },
            overclaiming: {
              id: 'overclaiming',
              type: 'outcome',
              consequence: 'bad',
              title: "La conclusion trop confiante",
              text: "You conclude 'coffee prevents death.' But unmeasured confounders remain: genetics, personality type, sleep quality, stress levels. The HRT studies also 'adjusted for everything' ‚Äî and were still wrong. Observational data, no matter how adjusted, cannot prove causation.",
              lesson: "L'AVERTISSEMENT¬†: L'ajustement r√©duit la confusion mais ne l'√©limine jamais. Il y a toujours des facteurs de confusion non mesur√©s. Dites ¬´ associ√© √† ¬ª et non ¬´ causes ¬ª. Dites ¬´ sugg√®re ¬ª et non ¬´ prouve ¬ª. L'humilit√© n'est pas une faiblesse, c'est de l'honn√™tet√©."
            },
            wise_conclusion: {
              id: 'wise_conclusion',
              type: 'outcome',
              consequence: 'good',
              title: "La conclusion honn√™te",
              text: "Your paper states: 'After adjustment for measured confounders, coffee consumption was associated with lower mortality (RR 0.88, 0.82-0.95). However, residual confounding cannot be excluded. These findings are hypothesis-generating and require confirmation in randomized trials.'",
              lesson: "THE PROTECTION: This is honest science. You report the finding, acknowledge limitations, and don't overclaim. If coffee truly is protective, future studies will confirm it. If it's residual confounding, you haven't misled anyone."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "L'√©tude sur la sant√© des infirmi√®res a r√©v√©l√© que les utilisatrices d'un THS pr√©sentaient un risque de maladie coronarienne 44 % inf√©rieur (RR 0,56). L'ECR WHI a r√©v√©l√© que le THS augmentait le risque de maladie coronarienne de 29¬†% (HR 1,29). Qu'est-ce qui explique le mieux cet √©cart¬†?",
          options: [
            { id: 'a', text: "L'ECR √©tait erron√© car il utilisait diff√©rentes formulations de THS", correct: false },
            { id: 'b', text: "Concertant en raison des caract√©ristiques saines des utilisateurs dans l'√©tude observationnelle", correct: true },
            { id: 'c', text: "L'√©tude observationnelle avait plus de puissance statistique", correct: false },
            { id: 'd', text: "Effect modification by age of participants", correct: false }
          ],
          explanation: "Healthy user bias (confounding): Women who chose HRT were systematically healthier, more educated, and had better healthcare access. These factors independently reduce CHD risk. When an RCT randomized women regardless of these characteristics, the 'benefit' disappeared and harm emerged. This is the canonical example of confounding in epidemiology."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE REVERSAL: BETA-CAROTENE ‚Äî WHEN MECHANISM MET REALITY",
          source: "NEJM 1994 ATBC | NEJM 1996 CARET | Observational promise, RCT destruction",
          timeline: [
            { year: "1980s", text: "Les √©tudes observationnelles montrent syst√©matiquement que les personnes ayant un taux √©lev√© de les niveaux de b√™ta-carot√®ne ont des taux de cancer plus faibles. Hypoth√®se antioxydante¬†: le b√™ta-carot√®ne neutralise les radicaux libres responsables du cancer.", type: "normal" },
            { year: "Mechanism", text: "Compelling biology: oxidative stress ‚Üí DNA damage ‚Üí cancer. Antioxidants should prevent this. Prospective cohorts show 30-40% lower lung cancer in high beta-carotene consumers.", type: "normal" },
            { year: "1994 ATBC", text: "Finnish RCT of beta-carotene in smokers: INCREASED lung cancer by 18% (RR 1.18, 95% CI 1.03-1.36). 8% higher total mortality. Trial stopped for harm.", type: "crisis" },
            { year: "1996 CARET", text: "US RCT stopped 21 months early: 28% INCREASE in lung cancer (RR 1.28, 95% CI 1.04-1.57). 17% higher death rate. Two RCTs showed same harm.", type: "crisis" },
            { year: "The Explanation", text: "Confounding: People who eat vegetables are healthier overall. Beta-carotene was a MARKER of healthy diet, not the CAUSE of protection. Supplementing the chemical didn't help ‚Äî it may have hurt.", type: "revelation" },
            { year: "Lesson", text: "La plausibilit√© biologique n'est PAS une preuve. Le m√©canisme sans randomisation est une narration. Le corps est complexe : les suppl√©ments isol√©s ne reproduisent pas les bienfaits des aliments complets.", type: "revelation" }
          ],
          realData: {
            endpoint: "Lung cancer incidence",
            drug: "Beta-carotene supplements",
            placebo: "Placebo",
            rr: "Observational: RR ~0.70 | RCT ATBC: RR 1.18 | RCT CARET: RR 1.28",
            ci: "Observational WRONG direction",
            nnh: "Supplements INCREASED cancer, opposite of observational prediction"
          },
          hook: "THE HOOK: Beta-carotene was the 'perfect' hypothesis ‚Äî strong observational association, compelling mechanism, clear dose-response. And it was COMPLETELY WRONG. This is why we need RCTs, and why observational data showing protective effects of interventions must be treated with deep skepticism."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: Every observational finding of benefit should be treated as provisional until an RCT confirms it. HRT, beta-carotene, vitamin E, hormone replacement ‚Äî all showed 'benefit' observationally, all showed harm or null in RCTs. The pattern is clear: CONFOUNDING MAKES THINGS LOOK HELPFUL THAT AREN'T."
        }
      }
    ]
  },
  {
    id: 2,
    title: "The Designs",
    subtitle: "Study Architecture",
    principle: 1,
    story: "Framingham",
    estimatedTime: "20 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Time flows one direction"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE FOUNDATION: FRAMINGHAM ‚Äî 75 YEARS OF WATCHING",
          source: "Framingham Heart Study | Est. 1948 | 15,000+ participants across 3 generations",
          timeline: [
            { year: "1948", text: "NIH recruits 5,209 residents of Framingham, Massachusetts. Goal: understand cardiovascular disease. No one knows what 'risk factors' are yet.", type: "normal" },
            { year: "1960s", text: "First major findings: smoking, high cholesterol, high blood pressure linked to heart disease. The term 'risk factor' is coined.", type: "revelation" },
            { year: "1971", text: "Offspring Study begins: 5,124 children of original participants enrolled. Multigenerational follow-up starts.", type: "normal" },
            { year: "1988", text: "Landmark finding: HDL cholesterol is protective. Distinguishing 'good' from 'bad' cholesterol transforms cardiology.", type: "revelation" },
            { year: "2002", text: "Third Generation Study enrolls grandchildren. 75 years of continuous observation.", type: "normal" },
            { year: "Legacy", text: "Plus de 3 000 articles publi√©s. Mod√®les de pr√©vision des risques utilis√©s dans le monde entier. Preuve que les √©tudes de cohorte peuvent changer la m√©decine.", type: "revelation" }
          ],
          realData: {
            endpoint: "Cardiovascular disease incidence and mortality",
            drug: "Prospective cohort design",
            placebo: "75+ years of follow-up",
            rr: "Identified smoking, cholesterol, BP, diabetes as risk factors",
            ci: "Risk prediction equations used globally",
            nnh: "Transformed preventive cardiology"
          },
          hook: "THE HOOK: Framingham didn't randomize anyone. It just watched ‚Äî carefully, systematically, for 75 years. It discovered that smoking causes heart disease, that cholesterol matters, that prevention is possible. Sometimes the most powerful studies are the most patient."
        }
      },
      {
        type: 'story-box',
        content: {
          icon: '‚ù§Ô∏è',
          title: "The Framingham Heart Study's 70-Year Legacy",
          source: "Framingham Heart Study | Institut national du c≈ìur, des poumons et du sang du NIH | 1948 √† aujourd'hui",
          paragraphs: [
            "En 1948, 5¬†209 habitants de Framingham, dans le Massachusetts, se sont inscrits √† une √©tude sans hypoth√®se claire. Les chercheurs ne savaient pas ce qu'ils recherchaient¬†: ils savaient simplement que les maladies cardiaques tuaient des Am√©ricains et personne ne comprenait pourquoi.",
            "Soixante-quinze ans plus tard, trois g√©n√©rations de Framinghamer nous ont appris l'essentiel de ce que nous savons sur le risque cardiovasculaire. Le cholest√©rol LDL. Fumeur. Hypertension. Diab√®te. Ob√©sit√©. Le score de risque de Framingham. C'est ici que le concept m√™me de ¬´¬†facteur de risque¬†¬ª a √©t√© invent√©.",
            "Personne n'a √©t√© randomis√©. Aucune intervention n'a √©t√© test√©e. Les chercheurs ont simplement mesur√© tout ce qu‚Äôils pouvaient, puis ont attendu et observ√© pendant des d√©cennies. L'√©tude qui a invent√© l'√©pid√©miologie cardiovasculaire moderne l'a fait gr√¢ce √† une observation patiente et m√©ticuleuse."
          ],
          lesson: "Certaines questions ne peuvent trouver de r√©ponse qu'en observant attentivement pendant de tr√®s longues p√©riodes. Framingham prouve que les √©tudes de cohorte observationnelles, r√©alis√©es de mani√®re rigoureuse sur une p√©riode de temps suffisante, peuvent transformer la m√©decine, m√™me sans randomisation."
        }
      },
      {
        type: 'content',
        content: {
          title: "The Three Major Observational Designs",
          sections: [
            {
              heading: "1. √âTUDE DE COHORTE¬†‚Äì¬†Suivez en avant",
              items: [
                "Commencez avec les personnes qui N'ONT PAS le r√©sultat",
                "Measure exposures at baseline",
                "Follow over time, count who develops outcome",
                "Calculate INCIDENCE rates and RISK ratios",
                "Strength: Temporal sequence clear (exposure before outcome)",
                "Weakness: Expensive, time-consuming, rare outcomes difficult"
              ]
            },
            {
              heading: "2. √âTUDE CASE-CONTROL ‚Äî Regarder en arri√®re",
              items: [
                "Commencez par les personnes qui ONT le r√©sultat (cas)",
                "Match to people WITHOUT the outcome (controls)",
                "Look backward: what exposures did they have?",
                "Calculate ODDS ratios (cannot calculate RR directly)",
                "Strength: Efficient for rare outcomes",
                "Weakness: Recall bias, selection bias in choosing controls"
              ]
            },
            {
              heading: "3. √âTUDE TRANSVERSALE ‚Äî Aper√ßu",
              items: [
                "Measure exposure and outcome at SAME TIME",
                "Cannot determine temporal sequence",
                "Calculate PREVALENCE ratios or odds ratios",
                "Strength: Quick, cheap, good for prevalence estimation",
                "Weakness: Cannot establish causation (chicken vs egg)"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: CHOISIR VOTRE CONCEPTION",
          title: "Faire correspondre la conception √† la question",
          sections: [
            {
              heading: "Use COHORT When:",
              text: "‚Ä¢ Exposure is common, outcome is common\n‚Ä¢ You can wait for outcomes to occur\n‚Ä¢ You want to calculate incidence/risk\n‚Ä¢ You need clear temporal sequence\n‚Ä¢ Example: Framingham (CVD risk factors)"
            },
            {
              heading: "Use CASE-CONTROL When:",
              text: "‚Ä¢ Le r√©sultat est RARE ‚Ä¢ Vous avez besoin de r√©ponses rapidement ‚Ä¢ Les ressources sont limit√©es ‚Ä¢ Exemple¬†: Thalidomide (naissance rare d√©fauts)"
            },
            {
              heading: "Use CROSS-SECTIONAL When:",
              text: "‚Ä¢ You need prevalence, not incidence\n‚Ä¢ Resources are very limited\n‚Ä¢ Temporal sequence doesn't matter\n‚Ä¢ Example: Disease burden surveys"
            },
            {
              heading: "The Nested Designs:",
              text: "‚Ä¢ Cas-t√©moins imbriqu√©s¬†: cas et contr√¥les au sein d'une cohorte ‚Ä¢ Cohorte de cas¬†: sous-cohorte al√©atoire + tous les cas ‚Ä¢ Ceux-ci combinent l'efficacit√© du cas-t√©moin avec la validit√© de la cohorte"
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Why Temporal Sequence Matters",
          sections: [
            {
              heading: "The Reverse Causation Trap:",
              items: [
                "Cross-sectional: Low BMI associated with cancer",
                "Interpretation A: Being thin causes cancer",
                "Interpretation B: Cancer causes weight loss (the truth)",
                "Sans donn√©es temporelles, vous ne pouvez pas savoir lequel est arriv√© en premier"
              ]
            },
            {
              heading: "Cohort Advantage:",
              items: [
                "Measure BMI in healthy people",
                "Suivez pendant 10 ans",
                "See who develops cancer",
                "Now temporal sequence is clear: BMI preceded cancer",
                "But still can't prove causation (confounding possible)"
              ]
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Dr. McBride a remarqu√© que les m√®res de b√©b√©s pr√©sentant des anomalies des membres avaient pris de la thalidomide. Il les a compar√©s aux m√®res de b√©b√©s en bonne sant√©. Quel mod√®le d'√©tude a-t-il implicitement utilis√©¬†?",
          options: [
            { id: 'a', text: "Cohort study ‚Äî following pregnant women forward", correct: false },
            { id: 'b', text: "√âtude cas-t√©moins ‚Äî commen√ßant avec les b√©b√©s affect√©s (cas)", correct: true },
            { id: 'c', text: "√âtude transversale ‚Äî mesurant simultan√©ment l'exposition et les r√©sultats", correct: false },
            { id: 'd', text: "Randomized trial ‚Äî assigning thalidomide exposure", correct: false }
          ],
          explanation: "McBride started with the outcome (babies with phocomelia = cases), compared to babies without defects (controls), and looked backward at maternal exposures. This is the essence of case-control design ‚Äî efficient for rare outcomes, which is why it detected thalidomide so quickly."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "L'HORREUR RETARD√âE¬†: DES ‚Äî QUAND LES FILLES PAYENT POUR LES M√àRES M√âDECINE",
          source: "NEJM 1971; Herbst et al | Cancer 1977 | Delayed harm 20+ years",
          timeline: [
            { year: "1940s-70s", text: "Di√©thylstilbestrol (DES) administr√© √† des millions de femmes enceintes pour pr√©venir les fausses couches. Bas√© sur des ¬´¬†preuves¬†¬ª d'observation et la plausibilit√© biologique.", type: "normal" },
            { year: "1953", text: "RCT shows DES doesn't prevent miscarriage. Drug continues to be prescribed anyway ‚Äî 'it might help, can't hurt.'", type: "crisis" },
            { year: "1971", text: "Herbst notices cluster of vaginal clear cell adenocarcinoma in young women. EXTREMELY RARE cancer. Case-control study: 7/8 cases had DES-exposed mothers.", type: "revelation" },
            { year: "The Horror", text: "Les dommages sont apparus 15 √† 25¬†ANS apr√®s l'exposition. Ce sont les filles qui ont d√©velopp√© un cancer, pas les m√®res. Aucun ECR n'aurait pu d√©tecter cela.", type: "crisis" },
            { year: "Observational Power", text: "Only case-control design could link rare cancer to decades-old exposure. Cohort would have taken 30 years. RCT would have ended long before cancers appeared.", type: "revelation" },
            { year: "Lesson", text: "Certains pr√©judices sont RETARD√âS de plusieurs d√©cennies. Certains affectent la NOUVELLE G√âN√âRATION. Seule l‚Äô√©pid√©miologie observationnelle peut les d√©tecter. C'est pourquoi la pharmacovigilance existe.", type: "revelation" }
          ],
          realData: {
            endpoint: "Clear cell adenocarcinoma of vagina/cervix",
            drug: "DES exposure in utero",
            placebo: "No DES exposure",
            rr: "OR = 40+ (case-control)",
            ci: "Extremely rare cancer in young women",
            nnh: "~1 in 1000 exposed daughters developed cancer"
          },
          hook: "LE CROCHET¬†: DES prouve que les m√©faits peuvent sauter une g√©n√©ration et appara√Ætre des d√©cennies plus tard. Aucun ECR ne peut suivre les r√©sultats sur 25 ans √† travers les g√©n√©rations. La conception cas-t√©moins √©tait le SEUL moyen de d√©tecter ce lien. L'observation n'√©tait pas seulement utile¬†: c'√©tait la seule option."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'study-design-choice',
          title: "Choisissez le bon mod√®le d'√©tude",
          situation: "Vous √™tes un √©pid√©miologiste confront√© √† diff√©rentes questions de recherche. Pour chacun, choisissez le mod√®le d'observation le plus appropri√©.",
          nodes: {
            start: {
              question: "QUESTION 1: A rare childhood leukemia (1 in 100,000) may be linked to living near power lines. Resources are limited. Which design?",
              branches: [
                { text: "Cohort study ‚Äî follow children near power lines", nextNode: "cohort_leukemia_wrong" },
                { text: "√âtude cas-t√©moins¬†: commencez par les cas de leuc√©mie, v√©rifiez la r√©sidence", nextNode: "casecontrol_leukemia_correct" },
                { text: "Cross-sectional ‚Äî survey current residence and disease", nextNode: "cross_leukemia_wrong" }
              ]
            },
            cohort_leukemia_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Impratique pour les r√©sultats rares¬†!",
              text: "Avec un taux de 1 sur 100 000, vous auriez besoin de suivre 1 MILLION d'enfants pour esp√©rer seulement 10 cas. Les √©tudes de cohorte sont terribles pour leurs r√©sultats rares. Cela prendrait des d√©cennies et des ressources √©normes.",
              lesson: "R√©sultat rare ‚Üí Cas-t√©moin. Vous commencez avec des cas existants, ce qui est efficace."
            },
            cross_leukemia_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Mauvais pour les questions d'incidence¬†!",
              text: "Mesures transversales de la pr√©valence (qui souffre actuellement de la maladie), et non de l'incidence (qui D√âVELOPPE la maladie). Pour le cancer, vous voulez conna√Ætre les nouveaux cas. Les analyses transversales ne permettent pas non plus d'√©tablir la temporalit√©¬†: vivaient-ils √† proximit√© de lignes √©lectriques AVANT le cancer¬†?",
              lesson: "Cross-sectional can't establish temporal sequence. Useless for cancer etiology."
            },
            casecontrol_leukemia_correct: {
              situation: "Excellent¬†! Le cas-t√©moin est efficace pour les r√©sultats rares. QUESTION 2 : Vous souhaitez identifier TOUS les facteurs de risque de maladies cardiovasculaires sur 30 ans. Quel mod√®le¬†?",
              question: "Choose:",
              branches: [
                { text: "√âtude de cohorte¬†‚Äì mesurer tout au d√©part, suivre les maladies cardiovasculaires", nextNode: "cohort_cvd_correct" },
                { text: "√âtude cas-t√©moins¬†‚Äì trouver des cas de maladies cardiovasculaires, poser des questions sur les expositions pass√©es", nextNode: "casecontrol_cvd_partial" }
              ]
            },
            cohort_cvd_correct: {
              situation: "Parfait¬†! C'est exactement ce qu'a fait Framingham. QUESTION 3 : Un nouveau vaccin a √©t√© introduit le mois dernier. Les rapports sugg√®rent que cela pourrait provoquer une r√©action auto-immune rare dans les 2 semaines suivant la vaccination. Meilleure conception¬†?",
              question: "Choose:",
              branches: [
                { text: "Case-control ‚Äî find autoimmune cases, check vaccination status", nextNode: "casecontrol_vaccine_partial" },
                { text: "Self-controlled case series ‚Äî compare each person's risk during exposed vs unexposed time", nextNode: "sccs_vaccine_correct" }
              ]
            },
            casecontrol_cvd_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible, but limited",
              text: "Les cas-t√©moins peuvent √©tudier les facteurs de risque de maladies cardiovasculaires, mais souffrent d'un biais de rappel (les cas se souviennent diff√©remment des expositions) et ne peuvent √©tudier qu'un seul r√©sultat √† la fois. La cohorte vous permet d'√©tudier PLUSIEURS r√©sultats et d'obtenir une mesure pr√©cise de l'exposition au d√©part.",
              lesson: "Pour une identification compl√®te des facteurs de risque avec une mesure pr√©cise de l'exposition, la cohorte est pr√©f√©rable."
            },
            casecontrol_vaccine_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Works, but there's a better option",
              text: "Le cas-t√©moin fonctionnerait, mais est vuln√©rable aux biais des vaccin√©s en bonne sant√© (les personnes en meilleure sant√© sont vaccin√©es). Pour les r√©actions aigu√´s aux vaccins avec des fen√™tres de risque d√©finies, les conceptions autocontr√¥l√©es √©liminent la confusion entre les personnes.",
              lesson: "Les conceptions autocontr√¥l√©es sont puissantes pour les r√©actions aigu√´s avec des fen√™tres temporelles claires."
            },
            sccs_vaccine_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Excellent choice!",
              text: "Les s√©ries de cas autocontr√¥l√©es comparent le risque de chaque personne pendant la fen√™tre post-vaccination de 2 semaines √† sa p√©riode de r√©f√©rence. Tous les facteurs de confusion entre les personnes (√¢ge, √©tat de sant√©, g√©n√©tique) sont automatiquement contr√¥l√©s, car chaque personne est son propre contr√¥le.",
              lesson: "SCCS a jou√© un r√¥le crucial dans les √©tudes sur l'innocuit√© des vaccins, notamment pour d√©mystifier le mythe ROR-autisme. C'est puissant lorsque les fen√™tres de risque sont bien d√©finies."
            }
          }
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è L'AVERTISSEMENT¬†:¬†Aucune conception d'√©tude n'est parfaite. Les √©tudes de cohorte n√©cessitent du temps et des ressources. Les √©tudes cas-t√©moins souffrent d‚Äôun biais de rappel. La transversale ne peut pas √©tablir de temporalit√©. Les conceptions autocontr√¥l√©es ne peuvent pas g√©rer les facteurs de confusion qui varient dans le temps. CONNAISSEZ LES FAIBLESSES DE VOTRE CONCEPTION avant de vous fier √† ses r√©sultats."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've completed the foundations. You understand WHY observational evidence matters (Module 0), HOW confounding deceives (Module 1), and WHICH study designs exist (Module 2). Now we go deeper: DAGs for causal reasoning, specific biases, and the tools to handle them."
        }
      }
    ]
  },
  // MODULE 3: THE CONFOUNDERS (DAGs and Causal Diagrams)
  {
    id: 3,
    title: "The Confounders",
    subtitle: "DAGs & Causal Thinking",
    principle: 5,
    estimatedTime: "25 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "L'ajustement n'est pas magique"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PARADOXE¬†: OB√âSIT√â ET MORTALIT√â - QUAND L'AJUSTEMENT TU√â",
          source: "JAMA 2005; Flegal et al | Epidemiology wars | Multiple analyses",
          timeline: [
            { year: "2005", text: "√âtude CDC¬†: Le surpoids (IMC 25-30) associ√© √† une mortalit√© INF√âRIEURE √† celle poids normal. Les gros titres d√©clarent que ¬´¬†la graisse est saine¬†¬ª.", type: "normal" },
            { year: "2005-10", text: "Scientists divided: Some see 'obesity paradox,' others see confounding and collider bias. Adjustment strategies differ dramatically.", type: "crisis" },
            { year: "Key Issue", text: "Devrions-nous nous adapter au tabagisme¬†? Les fumeurs sont minces ET meurent t√¥t. S'adapter au tabagisme aggrave le surpoids (correct). NE PAS ajuster donne un aspect protecteur (faux).", type: "revelation" },
            { year: "Another Issue", text: "Devrions-nous nous adapter aux maladies caus√©es par l'ob√©sit√©¬†? Le diab√®te, les maladies cardiaques sont des M√âDIATEURS. L'ajustement bloque le chemin causal que nous voulons estimer.", type: "revelation" },
            { year: "Resolution", text: "Diff√©rentes hypoth√®ses du DAG ‚Üí diff√©rentes strat√©gies d'ajustement ‚Üí diff√©rentes conclusions. Le DAG n'est pas facultatif¬†: il d√©termine la r√©ponse.", type: "revelation" },
            { year: "Lesson", text: "Vous DEVEZ √©tablir explicitement vos hypoth√®ses causales. Sinon, vous vous ajustez aveugl√©ment et vous obtiendrez la r√©ponse que dictent vos hypoth√®ses (non d√©clar√©es).", type: "revelation" }
          ],
          realData: {
            endpoint: "All-cause mortality",
            drug: "Overweight (BMI 25-30)",
            placebo: "Normal weight (BMI 18.5-25)",
            rr: "HR 0.88 (unadjusted) to 1.20+ (smoking-adjusted)",
            ci: "Conclusion flips based on adjustment",
            nnh: "Public health messaging chaos"
          },
          hook: "THE HOOK: The same data, analyzed by competent scientists, gave opposite answers. Not because anyone cheated ‚Äî but because they had different causal models in their heads. DAGs make those models explicit."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è APER√áU CL√â¬†: L'ajustement ne consiste pas seulement √† ¬´¬†contr√¥ler les variables¬†¬ª. Chaque variable que vous ajustez constitue une R√âCLAMATION causale. Ajuster pour un facteur de confusion ‚Üí bloque le biais. Ajustez pour un m√©diateur ‚Üí bloque l‚Äôeffet souhait√©. Ajuster pour un collisionneur ‚Üí CR√âE un biais. Un DAG vous oblige √† √©noncer explicitement vos affirmations."
        }
      },
      {
        type: 'content',
        content: {
          title: "What Is a DAG?",
          sections: [
            {
              heading: "Directed Acyclic Graph",
              items: [
                "DIRECTED: Arrows show causal direction (cause ‚Üí effect)",
                "ACYCLIC¬†: pas de boucles¬†‚Äì vous ne pouvez pas causer votre propre cause",
                "GRAPH: Visual network of variables and relationships",
                "Purpose: Makes causal assumptions EXPLICIT and testable"
              ]
            },
            {
              heading: "Three Types of Variables:",
              items: [
                "CONFFOUNDER¬†: cause commune de l'exposition et du r√©sultat (ajustez POUR cela)",
                "MEDIATEUR¬†: sur le cheminement causal de l'exposition au r√©sultat (√† NE PAS FAIRE ajuster)",
                "COLLIDER: Common effect of two variables (DON'T adjust ‚Äî creates bias)"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA METHODE : LECTURE D'UN DAG",
          title: "Chemins de porte d√©rob√©e et ajustement",
          sections: [
            {
              heading: "√âtape 1 : D√©terminez votre question",
              text: "Quel est l'effet causal de l'EXPOSITION sur le R√âSULTAT¬†? Dessinez une fl√®che directe depuis l‚Äôexposition ‚Üí le r√©sultat. C'est ce que vous souhaitez estimer."
            },
            {
              heading: "Step 2: Find Backdoor Paths",
              text: "Un chemin de porte d√©rob√©e va en arri√®re hors de l'exposition (contre la fl√®che) √† travers n'importe quel chemin vers le r√©sultat. Exemple : Exposition ‚Üê Confondeur ‚Üí R√©sultat. Cela cr√©e une association parasite."
            },
            {
              heading: "Step 3: Block Backdoor Paths",
              text: "Ajustez les variables qui bloquent tous les chemins de porte d√©rob√©e. Cela signifie g√©n√©ralement s‚Äôadapter aux facteurs confondants. Mais NE JAMAIS ajuster les collisions - cela OUVRE les chemins."
            },
            {
              heading: "Step 4: Check for Collider Bias",
              text: "Un collisionneur est un effet courant¬†: A ‚Üí Collisionneur ‚Üê B. Le conditionnement sur un collisionneur cr√©e une association entre A et B m√™me s'il n'en existe pas. Pi√®ge classique¬†: Ajustement pour ¬´ l'hospitalisation ¬ª dans les √©tudes en milieu hospitalier."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "The Collider Trap: Berkson's Paradox",
          sections: [
            {
              heading: "The Classic Example:",
              items: [
                "Question: Does diabetes cause respiratory disease?",
                "Hospital-based study: Among hospitalized patients, diabetes is NEGATIVELY associated with respiratory disease",
                "√âtude bas√©e sur la population : Aucune association",
                "Why? Hospitalization is a COLLIDER ‚Äî both diabetes and respiratory disease cause hospitalization"
              ]
            },
            {
              heading: "The Mechanism:",
              items: [
                "Among hospitalized patients, if someone DOESN'T have diabetes, they must have respiratory disease (otherwise why hospitalized?)",
                "This creates artificial negative association",
                "Ajustement pour l'hospitalisation (conditionnement sur le collisionneur) Biais INDUIT qui n'existait pas dans la population"
              ]
            },
            {
              heading: "Modern Examples:",
              items: [
                "COVID severity paradox: Smokers seemed protected because hospitalized non-smokers had other severe conditions",
                "Obesity paradox in heart failure: Sicker thin patients, healthier obese patients selected into studies",
                "If it seems paradoxical, look for a collider"
              ]
            }
          ]
        }
      },
      {
        type: 'story-box',
        content: {
          icon: 'üß¨',
          title: "The UK Biobank Collider Probl√®me<",
          source: "UK Biobank | Nature Communications 2020 | COVID-19 Studies",
          paragraphs: [
            "UK Biobank is a treasure‚Äî500,000 participants with genetic and health data. But participants are systematically different from the UK average: healthier, wealthier, and more educated. This is selection into a study.",
            "In 2020, researchers using UK Biobank found something strange: obesity appeared to be PROTECTIVE against COVID-19 death. This contradicted everything known about COVID risk factors. How could obesity protect against a disease where obesity is a major risk factor?",
            "The answer was a collider effect. The same factors that led to UK Biobank participation (health consciousness, education, access) also reduced COVID risk. Among UK Biobank participants, those who were obese but still healthy enough to participate were a selected, healthier group. Selection into the study created a spurious protective association."
          ],
          lesson: "Even the best datasets can produce wrong answers if you don't account for how people got into the study. Selection is a collider. When your study population is selected (and it always is, somehow), ask: could that selection distort the relationship I'm studying?"
        }
      },
      {
        type: 'tool',
        content: {
          type: 'dag-builder',
          title: "Outil de cr√©ation DAG",
          description: "Build a causal diagram to identify confounders, mediators, and colliders."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'dag-adjustment',
          title: "La d√©cision d'ajustement",
          situation: "You're studying whether a new diabetes drug reduces cardiovascular events. You have data on: the drug, CV events, age, prior CV disease, and HbA1c (blood sugar control). HbA1c improves with the drug. What should you adjust for?",
          nodes: {
            start: {
              question: "L'√¢ge est associ√© √† la fois √† la prescription de m√©dicaments (les patients plus √¢g√©s re√ßoivent plus de m√©dicaments) et aux √©v√©nements cardiovasculaires. Quel type de variable est l'√¢ge¬†?",
              branches: [
                { text: "Confondateur¬†‚Äì¬†ajustez-le", nextNode: "age_correct" },
                { text: "Mediator ‚Äî don't adjust", nextNode: "age_wrong" },
                { text: "Collider ‚Äî adjusting would create bias", nextNode: "age_wrong" }
              ]
            },
            age_correct: {
              situation: "Correct¬†! L'√¢ge est un facteur de confusion (cause commune). Maintenant : l‚ÄôHbA1c (glyc√©mie) s‚Äôam√©liore avec le m√©dicament et affecte √©galement les √©v√©nements CV. Quel type de variable est l'HbA1c¬†?",
              question: "Devriez-vous ajuster l'HbA1c¬†?",
              branches: [
                { text: "Yes ‚Äî it's a confounder", nextNode: "hba1c_wrong" },
                { text: "No ‚Äî it's a mediator on the causal pathway", nextNode: "hba1c_correct" },
                { text: "Cela d√©pend de la question de recherche", nextNode: "hba1c_nuanced" }
              ]
            },
            age_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Pas tout √† fait exact",
              text: "L'√¢ge est un facteur de confusion¬†: il provoque √† la fois l'exposition (les patients plus √¢g√©s sont plus susceptibles d'avoir m√©dicaments) et l‚Äôissue (les patients plus √¢g√©s ont plus d‚Äô√©v√©nements CV). Vous devez ajuster l'√¢ge pour bloquer ce chemin de porte d√©rob√©e.",
              lesson: "Un facteur de confusion est une CAUSE courante. L'√¢ge d√©termine les d√©cisions de traitement et provoque des √©v√©nements CV. Il ne s'agit pas d'un lien causal entre m√©dicaments et √©v√©nements CV."
            },
            hba1c_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Careful!",
              text: "HbA1c is on the CAUSAL PATHWAY: Drug ‚Üí HbA1c ‚Üí CV events. If the drug works by improving blood sugar, adjusting for HbA1c blocks the very effect you're trying to measure!",
              lesson: "Ne vous ajustez jamais aux m√©diateurs. Vous √©valuerez uniquement ¬´¬†l'effet direct¬†¬ª non m√©di√© par cette voie, qui peut √™tre nul m√™me si le m√©dicament fonctionne r√©ellement."
            },
            hba1c_correct: {
              situation: "Excellent! Now the final question: Prior CV disease predicts both drug prescribing (doctors give the drug to high-risk patients) AND CV events. What is it?",
              question: "Devriez-vous vous adapter √† une maladie cardiovasculaire ant√©rieure¬†?",
              branches: [
                { text: "Yes ‚Äî it's a confounder (confounding by indication)", nextNode: "final_success" },
                { text: "No ‚Äî it might be a collider", nextNode: "final_partial" }
              ]
            },
            hba1c_nuanced: {
              type: 'outcome',
              outcome: 'partial',
              title: "C'est une r√©ponse sophistiqu√©e",
              text: "Vous avez raison, cela d√©pend¬†! Si vous voulez l'effet TOTAL du m√©dicament, n'ajustez pas l'HbA1c (c'est un m√©diateur). Si vous voulez savoir si le m√©dicament a des effets AU-DEL√Ä du contr√¥le de la glyc√©mie, vous pouvez l'ajuster, mais c'est une question diff√©rente.",
              lesson: "Le DAG doit refl√©ter votre question causale sp√©cifique. Diff√©rentes questions ‚Üí diff√©rents ensembles d'ajustements."
            },
            final_success: {
              type: 'outcome',
              outcome: 'success',
              title: "Perfect DAG reasoning!",
              text: "You correctly identified: Age = confounder (adjust), HbA1c = mediator (don't adjust), Prior CV disease = confounder by indication (adjust). Your analysis will estimate the causal effect of the drug.",
              lesson: "C'est ce qu'on appelle la ¬´ confusion par indication ¬ª ‚Äî le biais le plus courant dans les √©tudes sur les m√©dicaments. Les patients les plus malades re√ßoivent un traitement, ce qui fait que le traitement semble nocif. Vous DEVEZ ajuster en fonction de la gravit√© de base."
            },
            final_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Almost!",
              text: "Une maladie CV ant√©rieure EST ici un facteur de confusion¬†: elle d√©termine √† la fois les d√©cisions de traitement et les r√©sultats. Vous devriez vous y adapter. Ce n'est PAS un collisionneur car les √©v√©nements CV (le r√©sultat) ne provoquent pas de maladie CV ant√©rieure (temporairement impossible).",
              lesson: "Les collisionneurs n√©cessitent deux fl√®ches pointant vers la variable. Une maladie CV ant√©rieure comporte des fl√®ches pointant vers l'EXT√âRIEUR (vers le m√©dicament, vers le r√©sultat). C'est un facteur de confusion."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Dans une √©tude sur le caf√© et le cancer du poumon, le tabagisme est associ√© √† la fois √† la consommation de caf√© et au cancer du poumon. Apr√®s ajustement au tabagisme, l‚Äôassociation caf√©-cancer dispara√Æt. Que s'est-il pass√©¬†?",
          options: [
            { id: 'a', text: "Smoking was a mediator ‚Äî coffee causes smoking which causes cancer", correct: false },
            { id: 'b', text: "Smoking was a confounder ‚Äî adjusting removed spurious association", correct: true },
            { id: 'c', text: "Smoking was a collider ‚Äî adjusting induced bias", correct: false },
            { id: 'd', text: "Coffee protects against cancer but smoking cancels the benefit", correct: false }
          ],
          explanation: "Smoking is a classic confounder: Coffee ‚Üê Smoking ‚Üí Cancer. Smokers drink more coffee AND get more cancer. The coffee-cancer association was spurious, created by the common cause (smoking). Adjusting for the confounder blocked the backdoor path and revealed no true effect."
        }
      }
    ]
  },
  // MODULE 4: THE BIAS (Selection, Information, Time-Related Biases)
  {
    id: 4,
    title: "The Bias",
    subtitle: "Selection & Information Bias",
    principle: 2,
    estimatedTime: "30 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Time flows one direction"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "L'ILLUSION DE L'IMMORTALIT√â¬†: LES STATINES ET LE TEMPS SANS MORT",
          source: "Am J Epidemiol 2003; Suissa | Drug Safety 2007 | 'Immortal Time Bias'",
          timeline: [
            { year: "2001-04", text: "Multiple observational studies find statins reduce cancer mortality by 30-50%. Biologically plausible: anti-inflammatory effects, cell cycle regulation.", type: "normal" },
            { year: "The Design", text: "√âtude de cohorte¬†:¬†Patients class√©s comme ¬´¬†utilisateurs de statines¬†¬ª s'ils ont JAMAIS rempli une ordonnance de statines. Par rapport aux jamais utilisateurs. Suivi du diagnostic jusqu'au d√©c√®s.", type: "normal" },
            { year: "The Flaw", text: "Pour √™tre class√© comme ¬´¬†utilisateur de statine¬†¬ª, vous devez SURVIVRE suffisamment longtemps pour ex√©cuter une ordonnance. Le temps √©coul√© avant la premi√®re prescription est ¬´ immortel ¬ª ‚Äì par d√©finition, vous ne pouvez pas mourir pendant ce temps.", type: "revelation" },
            { year: "The Math", text: "Le temps immortel est class√© √† tort comme ¬´ expos√© ¬ª. Cela gonfle artificiellement la survie du groupe expos√©. Le ¬´¬†b√©n√©fice¬†¬ª est un artefact math√©matique.", type: "crisis" },
            { year: "Correction", text: "When immortal time is properly handled (time-varying exposure), statin's cancer mortality benefit disappears: HR 0.99 (0.89-1.10)", type: "revelation" },
            { year: "Lesson", text: "Vous ne pouvez pas comparer ¬´¬†jamais ou jamais¬†¬ª lorsque le timing d'exposition est important. Le temps doit √™tre class√© correctement, sinon vous cr√©ez une illusion d'immortalit√©.", type: "revelation" }
          ],
          realData: {
            endpoint: "Cancer mortality",
            drug: "Statins (immortal time bias)",
            placebo: "No statins",
            rr: "HR 0.52 (biased) ‚Üí HR 0.99 (corrected)",
            ci: "Artifact ‚Üí null",
            nnh: "False hope for cancer patients"
          },
          hook: "THE HOOK: Immortal time bias is everywhere. Any study comparing 'ever vs never' users is at risk. The bias direction is ALWAYS toward benefit for the exposure. If your observational study shows a drug prevents cancer/death/etc, check for immortal time first."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY TAKEAWAY: Immortal time bias occurs when the definition of 'exposed' requires surviving to a certain point, but that survival time is misclassified as 'exposed' time. The bias ALWAYS makes the exposure look beneficial. Landmark analysis or time-varying covariates can fix it."
        }
      },
      {
        type: 'story-box',
        content: {
          icon: 'üíä',
          title: "Le biais du temps immortel dans les √©tudes sur le cancer par les statines",
          source: "Am J Epidemiol 2003; Suissa S. | Drug Safety 2007",
          paragraphs: [
            "In the early 2000s, several observational studies reported exciting findings: statins appeared to reduce cancer risk by 20-30%. The biological mechanism seemed plausible‚Äîstatins have anti-inflammatory properties and might inhibit cancer cell growth.",
            "Mais l'√©pid√©miologiste Samy Suissa a identifi√© une faille critique. Ces √©tudes comparaient les ¬´ utilisateurs de statines ¬ª aux ¬´ non-utilisateurs ¬ª √† partir du moment z√©ro, souvent la date du diagnostic ou de l'entr√©e dans la cohorte. Le probl√®me¬†: certains ¬´¬†utilisateurs¬†¬ª n'avaient m√™me pas encore commenc√© √† prendre des statines au temps z√©ro.",
            "The time between cohort entry and first statin prescription was 'immortal time'‚Äîby definition, patients couldn't die during this period (they had to survive to become statin users). This immortal time was misclassified as 'exposed' time, artificially inflating survival in the statin group. When properly analyzed with time-varying exposure, the cancer benefit disappeared completely."
          ],
          lesson: "Whenever you see an observational study showing a drug 'prevents' cancer or death, ask: How was exposure defined? Did patients need to survive to become 'exposed'? If the answer is yes, immortal time bias is likely inflating the benefit."
        }
      },
      {
        type: 'content',
        content: {
          title: "The Three Major Bias Families",
          sections: [
            {
              heading: "1. SELECTION BIAS",
              items: [
                "Qui participe √† l'√©tude¬†? Qui reste IN¬†?",
                "Healthy user bias: HRT users were healthier to start",
                "Sick quitter bias: People quit smoking because they're ill, making quitters look worse",
                "Loss to follow-up: Sicker patients drop out, making survivors look better",
                "Berkson's bias: Hospital-based selection distorts associations"
              ]
            },
            {
              heading: "2. INFORMATION BIAS",
              items: [
                "How accurately is exposure/outcome measured?",
                "Recall bias: Cases remember exposures better than controls",
                "Interviewer bias: Interviewers probe harder when they know disease status",
                "Misclassification: Errors in exposure or outcome measurement",
                "Differential misclassification can bias in either direction"
              ]
            },
            {
              heading: "3. TIME-RELATED BIAS",
              items: [
                "Immortal time bias: Survival required to become 'exposed'",
                "Time-lag bias: Comparing prevalent vs incident users",
                "Depletion of susceptibles: Early deaths remove high-risk from 'current user' category",
                "Lead time bias: Screening advances diagnosis without extending life"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: D√âTECTER LE BIAIS DE TEMPS IMMORTEL",
          title: "Drapeaux rouges et solutions",
          sections: [
            {
              heading: "Red Flags (Study Design):",
              text: "‚Ä¢ Exposure defined as 'ever vs never' with no time component\n‚Ä¢ Exposure requires multiple prescriptions/visits\n‚Ä¢ Time zero differs between groups\n‚Ä¢ Exposure definition is based on future events"
            },
            {
              heading: "Red Flags (Results):",
              text: "‚Ä¢ Unexpectedly large protective effect (HR < 0.70)\n‚Ä¢ Exposure 'protects' against multiple unrelated outcomes\n‚Ä¢ Biologically implausible benefit for plausible exposure\n‚Ä¢ Dose-response goes the 'wrong' direction"
            },
            {
              heading: "Solutions:",
              text: "1. LANDMARK ANALYSIS: Start follow-up at a fixed time point (e.g., 6 months post-diagnosis). Classify exposure based on that time.\n\n2. TIME-VARYING EXPOSURE: Change exposure status on the day it occurs. Before first statin = unexposed time. After = exposed time.\n\n3. CLONING METHODS: Create copies of patients, assign to exposure groups, censor appropriately."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Biais de s√©lection¬†: l'utilisateur en bonne sant√© et l'abandon malade",
          sections: [
            {
              heading: "Healthy User Bias:",
              items: [
                "People who choose treatment are systematically different",
                "HRT: Women who chose HRT were wealthier, more health-conscious",
                "Vaccines: Parents who vaccinate also do other healthy behaviors",
                "Supplements: Users have healthier lifestyles overall",
                "Le ¬´¬†b√©n√©fice¬†¬ª du traitement est en fait la s√©lection effet"
              ]
            },
            {
              heading: "Sick Quitter Bias:",
              items: [
                "People stop behaviors when they feel ill",
                "Alcohol: Former drinkers have higher mortality than current drinkers",
                "But former drinkers quit because they were sick",
                "Smoking: Recent quitters have higher cancer rates (cancer caused quitting)",
                "Creates the appearance of 'J-shaped' curves or protective effects"
              ]
            },
            {
              heading: "Detection and Correction:",
              items: [
                "Compare to 'never users,' not 'former users'",
                "Look at TIME of quitting relative to outcome",
                "Use active comparators (another drug) not non-users",
                "Consider intentions (prescriptions filled vs filled and taken)"
              ]
            }
          ]
        }
      },
      {
        type: 'story-box',
        content: {
          icon: 'üè•',
          title: "The Hospitalized Patient Paradox: Berkson's Bias",
          source: "Berkson J, Biometrics 1946 | Classic Selection Bias",
          paragraphs: [
            "In hospital-based studies, researchers noticed something strange: diabetes appeared to be PROTECTIVE against infections. Diabetic patients seemed less likely to have infectious diseases. This was paradoxical‚Äîdiabetes impairs immune function.",
            "L'explication √©tait le biais de Berkson, une forme de biais de s√©lection. Les diab√©tiques hospitalis√©s √©taient l√† principalement pour la gestion du diab√®te et non pour les infections. Mais les patients hospitalis√©s NON diab√©tiques √©taient plus susceptibles d'√™tre pr√©sents POUR des infections (entre autres affections aigu√´s).",
            "En √©tudiant uniquement les patients hospitalis√©s, les chercheurs ont cr√©√© une fausse association n√©gative. La m√™me relation diab√®te-infection √©tudi√©e dans la population g√©n√©rale a montr√© l'association POSITIF attendue : le diab√®te augmente le risque d'infection."
          ],
          lesson: "Studying only hospitalized (or otherwise selected) populations can create, eliminate, or reverse associations that exist in the general population. Always ask: how did patients get INTO this study, and could that selection process distort the exposure-outcome relationship?"
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'bias-detection',
          title: "Le d√©tecteur de biais",
          situation: "Une √©tude affirme que la metformine r√©duit le risque de cancer chez les diab√©tiques (HR 0,63, IC √† 95 % 0,58-0,68). L‚Äô√©tude a compar√© les utilisateurs de metformine aux non-utilisateurs. Les patients ont √©t√© class√©s comme utilisateurs de metformine s‚Äôils remplissaient ‚â•2 prescriptions. Le suivi a commenc√© d√®s le diagnostic du diab√®te.",
          nodes: {
            start: {
              question: "Quel est le biais le plus probable dans cette √©tude¬†?",
              branches: [
                { text: "Confounding by indication ‚Äî metformin given to healthier patients", nextNode: "confounding" },
                { text: "Immortal time bias ‚Äî must survive to fill 2 prescriptions", nextNode: "immortal_correct" },
                { text: "Healthy user bias ‚Äî metformin users are health-conscious", nextNode: "healthy_user" },
                { text: "No bias ‚Äî the confidence interval is narrow", nextNode: "no_bias_wrong" }
              ]
            },
            immortal_correct: {
              situation: "Correct¬†! Pour ex√©cuter 2 ordonnances, les patients doivent survivre au moins le temps qui les s√©pare. Cette dur√©e de survie est class√©e √† tort comme ¬´ expos√©e ¬ª alors qu'elle devrait √™tre ¬´ non expos√©e ¬ª.",
              question: "Comment rem√©dieriez-vous √† cette √©tude¬†?",
              branches: [
                { text: "Use landmark analysis ‚Äî start follow-up after a fixed period", nextNode: "fix_correct" },
                { text: "Ajuster en fonction des comorbidit√©s", nextNode: "fix_wrong" },
                { text: "Exclude patients who died early", nextNode: "fix_wrong2" }
              ]
            },
            confounding: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible, mais pas le probl√®me principal",
              text: "La confusion par indication est un probl√®me pr√©occupation (la metformine administr√©e aux diab√©tiques ¬´ en meilleure sant√© ¬ª). Mais la conception de l‚Äô√©tude cr√©e explicitement un TEMPS IMMORTEL ‚Äì exiger 2 prescriptions signifie que la survie doit √™tre class√©e comme expos√©e. Il s'agit du biais dominant.",
              lesson: "When a study requires multiple events (prescriptions, visits, tests) to define exposure, immortal time bias is almost always present."
            },
            healthy_user: {
              type: 'outcome',
              outcome: 'partial',
              title: "Connexe, mais pas le m√©canisme",
              text: "Healthy user bias is a form of confounding ‚Äî metformin users may be more health-conscious. But the study design creates a STRONGER bias: immortal time. Even if users and non-users were identical at baseline, requiring 2 prescriptions creates artificial immortality.",
              lesson: "Le biais du temps immortel n'est PAS d√©routant¬†: il s'agit d'un biais structurel d√ª √† une mauvaise classification du temps. Il existe m√™me sans aucune diff√©rence entre les groupes."
            },
            no_bias_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Narrow CI doesn't mean no bias!",
              text: "Un intervalle de confiance √©troit signifie que l'estimation est pr√©cise, mais pas qu'elle soit impartiale. Cette √©tude comporte une √âNORME erreur syst√©matique. Le ¬´¬†v√©ritable¬†¬ª effet pourrait √™tre nul (HR¬†1,0) malgr√© un IC serr√© autour de 0,63.",
              lesson: "Pr√©cision ‚â† Exactitude. Le biais est une erreur syst√©matique. La taille et la pr√©cision de l'√©chantillon ne corrigent pas les biais¬†: elles vous donnent simplement tort plus pr√©cis√©ment."
            },
            fix_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Excellent solution!",
              text: "Une analyse de r√©f√©rence d√©finirait le suivi pour commencer, disons, 6¬†mois apr√®s le diagnostic. Tous ceux qui survivent jusqu'√† 6 mois sont inclus. Le statut d‚Äôexposition est d√©fini √† ce stade. Aucun temps immortel ne peut √™tre mal class√©.",
              lesson: "L'analyse des rep√®res est la solution la plus simple au biais du temps immortel. Le ¬´ point de rep√®re ¬ª doit √™tre cliniquement significatif et appliqu√© de la m√™me mani√®re √† tous les patients."
            },
            fix_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Adjustment doesn't fix immortal time",
              text: "Immortal time bias is NOT confounding ‚Äî you can't adjust it away. No matter how many comorbidities you control for, the structural problem remains: time before first prescription is misclassified.",
              lesson: "Immortal time bias requires DESIGN fixes (landmark, time-varying exposure), not statistical adjustment."
            },
            fix_wrong2: {
              type: 'outcome',
              outcome: 'danger',
              title: "Cela ne fait qu'empirer les choses¬†!",
              text: "L'exclusion des d√©c√®s pr√©matur√©s √©limine les patients m√™mes qui d√©montrent le biais¬†! Vous ne garderiez que les survivants, ce qui rendrait le probl√®me du temps immortel encore plus extr√™me. Il s'agit d'un biais de survie qui s'ajoute au biais de temps immortel.",
              lesson: "Ne ¬´ corrigez ¬ª jamais le biais en supprimant des donn√©es. Corrigez-le en classant correctement le temps d√®s le d√©but."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Une √©tude r√©v√®le que les patients qui survivent plus de 5 ans apr√®s le diagnostic du cancer et qui commencent ensuite √† m√©diter ont un taux de mortalit√© 60 % inf√©rieur √† celui des non-m√©ditants. Quel est le d√©faut le plus critique¬†?",
          options: [
            { id: 'a', text: "Confounding ‚Äî meditators are healthier overall", correct: false },
            { id: 'b', text: "Immortal time bias ‚Äî must survive 5 years to become a meditator", correct: true },
            { id: 'c', text: "Recall bias ‚Äî survivors remember meditation better", correct: false },
            { id: 'd', text: "Selection bias ‚Äî only motivated patients meditate", correct: false }
          ],
          explanation: "The study defines 'meditators' as those who survive 5+ years AND THEN start meditation. All 5 years of survival are 'immortal' ‚Äî by definition, you can't die during time required to become exposed. This immortal time is then misclassified as 'exposed' time, artificially inflating survival in meditators."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PI√àGE DE LA M√âMOIRE¬†: BIAIS DE RAPPEL ET EXPOSITIONS FANT√îMES",
          source: "Case-control studies of birth defects | Multiple examples | Information bias",
          timeline: [
            { year: "Classic Setup", text: "On demande √† la m√®re d'un b√©b√© atteint d'une anomalie cong√©nitale¬†:¬†¬´¬†Avez-vous pris des m√©dicaments pendant la grossesse¬†?¬†¬ª Elle cherche d√©sesp√©r√©ment dans sa m√©moire tout ce qui pourrait expliquer l'√©tat de son enfant.", type: "normal" },
            { year: "The Comparison", text: "Mother of healthy baby is asked same question. She shrugs: 'Maybe some Tylenol? I don't really remember.' No motivation to dig through memory.", type: "normal" },
            { year: "The Bias", text: "Les m√®res cas se souviennent de plus d'expositions que les m√®res t√©moins - non pas parce qu'elles en ont eu plus, mais parce qu'elles ont RECHERCH√â plus fort. Il s'agit d'un rappel diff√©rentiel.", type: "crisis" },
            { year: "Real Example", text: "Des √©tudes cas-t√©moins ont r√©v√©l√© des associations entre de nombreux m√©dicaments et des malformations cong√©nitales. Lorsque les dossiers de prescription (donn√©es objectives) ont √©t√© utilis√©s au lieu du rappel, la plupart des associations ont disparu.", type: "revelation" },
            { year: "Bendectin Disaster", text: "Le m√©dicament contre les naus√©es matinales Bendectin a √©t√© retir√© en raison de la pression judiciaire exerc√©e par les √©tudes de rappel cas-t√©moins. Des recherches ult√©rieures ont montr√© que c'√©tait S√õR. Les femmes enceintes ont perdu l'acc√®s √† un traitement efficace en raison d'un biais de rappel.", type: "crisis" },
            { year: "Lesson", text: "When outcomes prompt memory searches, recall is biased. Use OBJECTIVE exposure data (records, biomarkers) when possible. When using recall, make interviewers BLIND to case/control status.", type: "revelation" }
          ],
          realData: {
            endpoint: "Various birth defects",
            drug: "Multiple medications (recall-based)",
            placebo: "No medication (recall-based)",
            rr: "OR 2-4x higher in recall studies vs objective records",
            ci: "Recall-based associations often spurious",
            nnh: "Bendectin withdrawn despite being safe"
          },
          hook: "THE HOOK: Recall bias is insidious because it feels like valid data. Mothers genuinely believe they're reporting accurately ‚Äî but grief and guilt drive memory searches that control mothers don't perform. The cure? Objective data sources, or blinded interviewers."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'recall-bias-detection',
          title: "Est-ce un biais de rappel¬†?",
          situation: "You're reviewing case-control studies. Identify whether recall bias is a major threat.",
          nodes: {
            start: {
              question: "√âTUDE¬†A¬†: Les cas atteints d'un cancer du poumon ont √©t√© interrog√©s sur leurs ant√©c√©dents de tabagisme par rapport aux t√©moins sans cancer. Les deux groupes ont pos√© les m√™mes questions aux m√™mes intervieweurs. Le biais de rappel est-il un probl√®me¬†?",
              branches: [
                { text: "Yes ‚Äî lung cancer patients remember smoking differently", nextNode: "lung_cancer_wrong" },
                { text: "Minimal ‚Äî smoking is a salient, memorable behavior", nextNode: "lung_cancer_correct" }
              ]
            },
            lung_cancer_correct: {
              situation: "Correct¬†! Fumer est m√©morable et v√©rifiable. Le biais de rappel est moins probl√©matique pour les expositions MAJEURES SAILLANTES. √âTUDE B¬†:¬†Cas de leuc√©mie infantile par rapport aux t√©moins. Les parents ont pos√© des questions sur l'utilisation de pesticides √† la maison il y a 5 ans.",
              question: "Is recall bias a concern?",
              branches: [
                { text: "Major concern ‚Äî parents of sick children search memory harder", nextNode: "leukemia_correct" },
                { text: "Minor concern ‚Äî pesticide use is memorable", nextNode: "leukemia_wrong" }
              ]
            },
            lung_cancer_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Some concern, but limited",
              text: "Le biais de rappel est plus probl√©matique pour les expositions SUBTILES ET MINEURES qui n√©cessitent des recherches de m√©moire. Le tabagisme est un √©l√©ment important : les gens savent s‚Äôils ont fum√©. C'est v√©rifiable via des biomarqueurs. La plus grande pr√©occupation des √©tudes sur le cancer du poumon est la confusion (les fumeurs ont d'autres comportements √† risque).",
              lesson: "Recall bias is exposure-specific. Major behaviors (smoking, alcohol) are less affected than minor ones (dietary supplements, brief exposures)."
            },
            leukemia_correct: {
              situation: "Exactement¬†! L‚Äôutilisation de pesticides √† usage domestique il y a 5 ans est vague et consultable. √âTUDE C : Cas d'infarctus du myocarde. Donn√©es d'exposition extraites des dossiers de prescription pharmaceutique AVANT l'apparition de l'IM.",
              question: "Is recall bias a concern?",
              branches: [
                { text: "Yes ‚Äî patients still might misreport", nextNode: "mi_wrong" },
                { text: "Non¬†: les donn√©es ont √©t√© enregistr√©es AVANT le r√©sultat, ne peuvent pas √™tre influenc√©es", nextNode: "mi_correct" }
              ]
            },
            leukemia_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "High recall bias risk!",
              text: "Pesticide use 5 years ago is exactly the type of exposure prone to recall bias: (1) vague definition, (2) long ago, (3) guilt-inducing for parents of sick children. Parents of leukemia cases will search memory for ANY chemical exposure. Controls won't.",
              lesson: "Red flags for recall bias: vague exposures, long recall periods, emotionally-charged outcomes (especially children), differential motivation to remember."
            },
            mi_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "No recall bias possible!",
              text: "Lorsque les donn√©es d'exposition sont enregistr√©es AVANT que le r√©sultat ne se produise (v√©rification prospective), le biais de rappel est impossible. Les donn√©es ne peuvent pas changer en fonction du statut du r√©sultat. C'est pourquoi les √©tudes de cohorte et les √©tudes utilisant des dossiers m√©dicaux sont moins susceptibles de subir des biais de rappel.",
              lesson: "The cure for recall bias: prospective data collection, medical/pharmacy records, biomarkers ‚Äî anything recorded before the outcome is known."
            },
            mi_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Pas avec des dossiers objectifs¬†!",
              text: "Les dossiers pharmaceutiques ont √©t√© remplis AVANT l'IM. Le patient ne peut pas revenir en arri√®re et modifier les ordonnances qu'il a ex√©cut√©es. Il s‚Äôagit de donn√©es objectives, enregistr√©es de mani√®re prospective, immunis√©es contre les biais de rappel. C'est exactement pourquoi les chercheurs utilisent les dossiers de sant√© √©lectroniques.",
              lesson: "Objective records > memory. Prospective > retrospective. When you have records, use them instead of asking patients to remember."
            }
          }
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: Selection bias, information bias, and time-related bias all make associations appear where none exist (or disappear when real). They are NOT fixed by larger sample sizes. They are NOT fixed by narrow confidence intervals. They are ONLY fixed by proper study design. A precise biased estimate is just precise bias."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've mastered the bias zoo. Immortal time (survival to exposure), healthy user (who chooses treatment), sick quitter (who stops), recall bias (differential memory), Berkson's (hospital selection). Now you'll learn ROBINS-I ‚Äî the systematic framework to assess all these biases together."
        }
      }
    ]
  },
  // MODULE 5: THE ASSESSMENT (ROBINS-I)
  {
    id: 5,
    title: "The Assessment",
    subtitle: "ROBINS-I pour Biais",
    principle: 4,
    estimatedTime: "25 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Measurement shapes reality"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PI√àGE PAND√âMIQUE¬†: HYDROXYCHLOROQUINE ET CHAOS D'OBSERVATION",
          source: "Lancet 2020 (retracted) | Multiple observational studies | COVID-19 pandemic",
          timeline: [
            { year: "Mar 2020", text: "French study (Gautret): HCQ + azithromycin shows viral clearance. 'Cure found!' Small, non-randomized, methodologically flawed.", type: "normal" },
            { year: "Apr 2020", text: "Observational studies flood preprint servers. Some show benefit (confounding by indication, immortal time). Some show harm (sicker patients got HCQ).", type: "crisis" },
            { year: "May 2020", text: "Lancet publie une √©tude observationnelle¬†: l'HCQ augmente la mortalit√© (HR 1,35). Le monde suspend les essais. √âtude ult√©rieure R√âTRAIT√âE ‚Äì donn√©es fabriqu√©es.", type: "crisis" },
            { year: "Jun 2020", text: "QUI SOLIDARIT√â, les essais de R√âCUP√âRATION (ECR) montrent que l'HCQ ne fonctionne pas. Les √©tudes observationnelles avaient donn√© des r√©ponses contradictoires pendant des mois.", type: "revelation" },
            { year: "The Problem", text: "Les √©tudes observationnelles pendant la crise pr√©sentaient de graves confusions (les patients les plus malades recevaient du HCQ), un biais de temps immortel (survie requise pour recevoir le m√©dicament) et un biais d'indication.", type: "revelation" },
            { year: "The Lesson", text: "L'√©valuation syst√©matique des biais (ROBINS-I) aurait pu signaler les √©tudes les plus peu fiables AVANT l'√©laboration de la politique. La rapidit√© sans qualit√© co√ªte des vies.", type: "revelation" }
          ],
          realData: {
            endpoint: "COVID-19 mortality",
            drug: "Hydroxychloroquine observational",
            placebo: "No HCQ",
            rr: "Ranged from HR 0.50 to HR 2.60",
            ci: "Completely contradictory",
            nnh: "Months of confusion, RCTs delayed"
          },
          hook: "LE CROCHET¬†: La d√©b√¢cle du HCQ a montr√© ce qui se produit lorsque des √©tudes observationnelles sont r√©alis√©es sans √©valuation rigoureuse des biais. ROBINS-I fournit un cadre syst√©matique pour √©valuer le risque de biais dans les √©tudes non randomis√©es ‚Äì avant de faire confiance √† leurs r√©sultats."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è APER√áU CL√â¬†: ROBINS-I demande¬†:¬†¬´ √Ä quoi ressemblerait cette √©tude en tant qu‚ÄôECR¬†?¬†¬ª V√©rifie ensuite syst√©matiquement o√π il s‚Äô√©carte. Il ne s'agit pas de savoir si les √©tudes observationnelles sont ¬´ mauvaises ¬ª, il s'agit d'√©valuer honn√™tement leurs limites."
        }
      },
      {
        type: 'content',
        content: {
          title: "ROBINS-I: Risk of Bias In Non-randomized Studies of Interventions",
          sections: [
            {
              heading: "What Is ROBINS-I?",
              items: [
                "Developed by Cochrane for systematic reviews",
                "Structured assessment of 7 bias domains",
                "Ancr√© √† un ¬´ essai cible ¬ª ‚Äî l'ECR id√©al que vous souhaiteriez voir exister",
                "Produces domain-level and overall risk of bias judgments",
                "Required by many journals and guideline bodies"
              ]
            },
            {
              heading: "The Target Trial Concept:",
              items: [
                "Quel ECR feriez-vous si l'√©thique et la logistique le permettaient¬†?",
                "Define: eligibility, interventions, outcomes, follow-up, analysis",
                "L'√©tude observationnelle EMULE ceci essai",
                "Bias = deviation from the target trial"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE : DOMAINES ROBINS-I",
          title: "Seven Sources of Bias",
          sections: [
            {
              heading: "Pre-Intervention Domains:",
              text: "1. CONFONDANT¬†: Les groupes √©taient-ils comparables au d√©part¬†? - Des facteurs de confusion non mesur√©s ? Une confusion variable dans le temps ? - R√©fl√©chissez¬†: utilisateurs de THS par rapport aux non-utilisateurs. 2. S√âLECTION¬†: La s√©lection dans l'√©tude √©tait-elle li√©e √† l'intervention et aux r√©sultats¬†? - Pr√©jug√©s r√©pandus des utilisateurs¬†? S√©lection hospitali√®re ? - Pensez¬†: S√©lectionner uniquement les survivants"
            },
            {
              heading: "At-Intervention Domain:",
              text: "3. CLASSIFICATION DES INTERVENTIONS¬†: Le statut de l'intervention a-t-il √©t√© bien d√©fini et v√©rifi√©¬†? - Biais du temps immortel ? Erreur de classification de l'exposition ? - Pensez¬†: d√©finitions ¬´¬†Toujours ou jamais¬†¬ª"
            },
            {
              heading: "Post-Intervention Domains:",
              text: "4. DEVIATIONS: Were there deviations from intended interventions?\n   - Non-adherence? Co-interventions?\n   - Think: Patients stopping treatment\n\n5. MISSING DATA: Were outcomes measured for all participants?\n   - Differential loss to follow-up?\n   - Think: Sicker patients dropping out\n\n6. MEASUREMENT: Could outcome measurement be affected by intervention status?\n   - Blinding? Detection bias?\n   - Think: Knowing treatment affects diagnosis\n\n7. SELECTION OF RESULTS: Were results selected from multiple analyses?\n   - Outcome switching? Subgroup fishing?\n   - Think: Reporting only favorable analyses"
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "ROBINS-I Judgment Levels",
          sections: [
            {
              heading: "Low Risk of Bias:",
              text: "L'√©tude est comparable √† un ECR bien r√©alis√© en ce qui concerne ce domaine. Confondeurs identifi√©s ET ajust√©s. Pas de temps immortel. Suivi complet."
            },
            {
              heading: "Moderate Risk of Bias:",
              text: "Son pour une √©tude non randomis√©e mais ne peut √™tre consid√©r√© comme comparable √† un ECR. Il reste probablement une certaine confusion. Pr√©occupations mineures concernant les m√©thodes."
            },
            {
              heading: "Serious Risk of Bias:",
              text: "L'√©tude pr√©sente des probl√®mes importants. Une confusion importante est probable. D√©fauts de conception (temps immortel, s√©lection). Les r√©sultats doivent √™tre interpr√©t√©s avec une grande prudence."
            },
            {
              heading: "Critical Risk of Bias:",
              text: "L'√©tude est trop probl√©matique pour fournir des preuves utiles. Des d√©fauts fondamentaux qui ne peuvent √™tre corrig√©s. Ne devrait g√©n√©ralement pas √™tre inclus dans la synth√®se."
            },
            {
              heading: "Overall Judgment:",
              text: "The overall risk of bias is the MOST SEVERE judgment across domains. One critical domain = critical overall. This is intentionally conservative."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'robins-assessment',
          title: "ROBINS-I Assessment Practice",
          situation: "Une √©tude observationnelle compare les r√©sultats du COVID-19 chez les patients ayant re√ßu du remdesivir par rapport aux soins standard. Le remdesivir a √©t√© administr√© sur la base du jugement du m√©decin. L'√©tude a √©t√© ajust√©e en fonction de l'√¢ge, du sexe et des comorbidit√©s. Aucune donn√©e sur la gravit√© de la maladie au d√©but du traitement.",
          nodes: {
            start: {
              question: "Pour le domaine CONFOUNDING, quel est votre jugement¬†?",
              branches: [
                { text: "Low risk ‚Äî they adjusted for key confounders", nextNode: "confound_low" },
                { text: "Serious risk ‚Äî disease severity unmeasured", nextNode: "confound_correct" },
                { text: "Risque critique ‚Äî l'√©tude est fondamentalement erron√©e", nextNode: "confound_critical" }
              ]
            },
            confound_correct: {
              situation: "Good judgment! Physicians gave remdesivir to sicker patients. Without adjusting for baseline severity, the study is biased AGAINST remdesivir (confounding by indication). Now assess CLASSIFICATION OF INTERVENTIONS:",
              question: "Patients were classified as 'remdesivir users' if they received at least one dose during hospitalization.",
              branches: [
                { text: "Low risk ‚Äî clear definition", nextNode: "class_low" },
                { text: "Serious risk ‚Äî immortal time bias possible", nextNode: "class_correct" }
              ]
            },
            confound_low: {
              type: 'outcome',
              outcome: 'danger',
              title: "Too optimistic!",
              text: "Adjusting for age, sex, and comorbidities doesn't capture the most important confounder: DISEASE SEVERITY at treatment initiation. Physicians gave remdesivir to sicker patients. This creates confounding by indication ‚Äî the treatment appears harmful because treated patients were sicker.",
              lesson: "Always ask: 'What determined who got treatment?' If it's disease severity and you can't measure that, confounding is serious."
            },
            confound_critical: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possibly too harsh",
              text: "Bien que la confusion soit grave, le terme ¬´ critique ¬ª est r√©serv√© aux biais qui ne peuvent pas √™tre corrig√©s, m√™me en principe, ou lorsque la direction et l'ampleur font que des r√©sultats totalement peu informatifs. Certaines informations sur la comparaison peuvent encore √™tre extraites avec prudence.",
              lesson: "Le risque critique de biais signifie que l'√©tude doit g√©n√©ralement √™tre exclue de la synth√®se. R√©servez-le aux d√©fauts vraiment mortels."
            },
            class_low: {
              type: 'outcome',
              outcome: 'danger',
              title: "V√©rifiez le temps immortel¬†!",
              text: "Pour recevoir du remdesivir pendant une hospitalisation, les patients doivent SURVIVRE jusqu'au traitement. Le temps √©coul√© entre l‚Äôadmission et la premi√®re dose est ¬´ immortel ¬ª : les patients ne peuvent pas mourir pendant ce temps. Si ce temps est class√© comme temps ¬´ trait√© ¬ª, cela cr√©e un biais temporel immortel favorisant le remdesivir.",
              lesson: "Any time-to-treatment or requirement to survive to receive treatment creates potential immortal time bias."
            },
            class_correct: {
              situation: "Correct¬†! Si le temps √©coul√© depuis l‚Äôadmission au remdesivir est class√© comme ¬´ expos√© ¬ª, il existe un biais temporel immortel. Maintenant, quel est votre risque GLOBAL de biais de jugement¬†?",
              question: "Overall judgment:",
              branches: [
                { text: "Mod√©r√©¬†‚Äì il y a des inqui√©tudes, mais l'√©tude est utilisable", nextNode: "overall_moderate" },
                { text: "Serious ‚Äî multiple domains have important problems", nextNode: "overall_correct" },
                { text: "Critique¬†‚Äì¬†l'√©tude ne fournit aucune preuve utile", nextNode: "overall_critical" }
              ]
            },
            overall_moderate: {
              type: 'outcome',
              outcome: 'partial',
              title: "Likely too generous",
              text: "En cas de biais de confusion s√©rieux ET de biais de classification s√©rieux (temps immortel), le jugement global devrait √™tre au moins S√âRIEUX. L'ensemble est d√©termin√© par le pire domaine¬†: vous ne pouvez pas faire la moyenne des pr√©occupations s√©rieuses.",
              lesson: "Overall ROBINS-I judgment = worst single domain judgment. One serious domain = serious overall."
            },
            overall_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Appropriate judgment!",
              text: "En cas de confusion grave (gravit√© non mesur√©e) et de biais de classification s√©rieux (temps immortel potentiel), le risque global de biais est GRAVE. Les r√©sultats de l'√©tude doivent √™tre interpr√©t√©s avec une grande prudence et peuvent ne pas convenir √† une synth√®se quantitative.",
              lesson: "ROBINS-I est intentionnellement conservateur. Les √©tudes observationnelles sur les m√©dicaments dans le monde r√©el comportent souvent de s√©rieux risques de biais. Il vaut mieux le reconna√Ætre honn√™tement que de pr√©tendre le contraire."
            },
            overall_critical: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possibly warranted, but justify carefully",
              text: "Le risque critique n√©cessite qu‚Äôau moins un domaine soit critique, ou plusieurs domaines s√©rieux qui, ensemble, rendent les r√©sultats non informatifs. Si vous pouvez expliquer pourquoi aucune information utile ne peut √™tre extraite, la critique peut √™tre appropri√©e.",
              lesson: "Le jugement critique signifie¬†:¬†¬´¬†Cette √©tude ne devrait pas √©clairer les d√©cisions cliniques.¬†¬ª Utilisez-le avec parcimonie, mais ne l'√©vitez pas lorsque cela est vraiment justifi√©."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Une √©tude pr√©sente un risque ¬´ faible ¬ª pour 6 domaines ROBINS-I, mais un risque ¬´ s√©rieux ¬ª de confusion. Quel est le risque global de biais¬†?",
          options: [
            { id: 'a', text: "Low ‚Äî most domains are fine", correct: false },
            { id: 'b', text: "Moderate ‚Äî one serious domain warrants caution", correct: false },
            { id: 'c', text: "Serious ‚Äî overall is the worst single domain", correct: true },
            { id: 'd', text: "Cannot determine ‚Äî need to average the domains", correct: false }
          ],
          explanation: "Dans ROBINS-I, le risque global de jugement biais√© est √©gal au jugement LE PLUS S√âRIEUX dans tous les domaines. Il ne s‚Äôagit pas d‚Äôune moyenne : un d√©faut fatal reste fatal. Si la confusion est grave, l'√©tude ne peut pas √™tre consid√©r√©e comme un risque global ¬´ faible ¬ª ou ¬´ mod√©r√© ¬ª, quelle que soit la fa√ßon dont les autres domaines sont trait√©s."
        }
      }
    ]
  },
  // MODULE 6: THE ADJUSTMENT (Propensity Scores)
  {
    id: 6,
    title: "The Adjustment",
    subtitle: "Propensity Scores",
    principle: 5,
    estimatedTime: "30 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "L'ajustement n'est pas magique"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "L'illusion de l'√©quilibre¬†: les scores de propension et les valeurs non mesur√©es",
          source: "King & Nielsen 2019 | Epidemiology debates | Propensity score wars",
          timeline: [
            { year: "1983", text: "Rosenbaum et Rubin introduisent les scores de propension¬†: probabilit√© de traitement compte tenu des covariables. R√©volutionnaire pour l'inf√©rence causale dans les donn√©es d'observation.", type: "normal" },
            { year: "2000s", text: "L'appariement des scores de propension devient la ¬´ r√©f√©rence ¬ª pour les √©tudes d'observation. Les articles se multiplient affirmant un √©quilibre ¬´ de type ECR ¬ª.", type: "normal" },
            { year: "2010s", text: "Problems emerge: matching discards data, pruning can increase bias. IPTW and overlap weighting gain favor.", type: "crisis" },
            { year: "Key Issue", text: "Propensity scores balance MEASURED confounders only. If the key confounder is UNMEASURED, propensity scores give false confidence.", type: "revelation" },
            { year: "Example", text: "COX-2 inhibitors vs NSAIDs: propensity-matched studies showed safety. But unmeasured factors (channeling to lower-risk patients) weren't captured. RCTs revealed CV harm.", type: "crisis" },
            { year: "Lesson", text: "Les scores de propension sont un OUTIL, pas un rem√®de. Ils √©quilibrent ce que vous mesurez. Restes de confusion non mesur√©s¬†‚Äì¬†une analyse de sensibilit√© est essentielle.", type: "revelation" }
          ],
          realData: {
            endpoint: "Cardiovascular events",
            drug: "COX-2 inhibitors (propensity-adjusted)",
            placebo: "Traditional NSAIDs",
            rr: "Observational: HR ~0.80 | RCT: HR 1.50+",
            ci: "Unmeasured channeling bias",
            nnh: "Vioxx withdrawn after 88,000+ cardiac events"
          },
          hook: "LE CROCHET¬†: Les scores de propension donnaient aux √©tudes observationnelles un aspect ¬´¬†√©quilibr√©¬†¬ª. Mais l‚Äô√©quilibre sur les facteurs mesur√©s ne signifie pas l‚Äô√©quilibre sur TOUS les facteurs. Le d√©sastre du COX-2/Vioxx a montr√© que des statistiques sophistiqu√©es ne peuvent pas corriger les donn√©es manquantes."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY INSIGHT: Propensity scores control for confounding by MEASURED variables. They create a pseudo-population where treatment is unrelated to those variables. But UNMEASURED confounders remain ‚Äî and propensity scores can create false confidence by making studies look 'rigorous' when key confounders are missing."
        }
      },
      {
        type: 'content',
        content: {
          title: "What Is a Propensity Score?",
          sections: [
            {
              heading: "Definition:",
              items: [
                "Probability of receiving treatment given observed covariates",
                "PS = P(Treatment=1 | X‚ÇÅ, X‚ÇÇ, ..., X‚Çñ)",
                "Estimated using logistic regression (or machine learning)",
                "Summarizes many confounders into a single number"
              ]
            },
            {
              heading: "Why It Works (When It Works):",
              items: [
                "Balancing property: At each PS value, treatment is 'random' with respect to covariates",
                "Creates pseudo-randomization: mimics what an RCT would do",
                "Enables comparison of 'like with like'",
                "Reduces dimensionality: many confounders ‚Üí one score"
              ]
            },
            {
              heading: "The Limitation:",
              items: [
                "Only balances what's IN the model",
                "Unmeasured confounders remain unbalanced",
                "Can't balance what you don't know",
                "The 'strong ignorability' assumption is UNTESTABLE"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: APPROCHES DU SCORE DE PROPENSIT√â",
          title: "Four Ways to Use Propensity Scores",
          sections: [
            {
              heading: "1. MATCHING",
              text: "Associez les patients trait√©s et non trait√©s avec des valeurs PS similaires. + Intuitif, transparent ‚àí Rejet des patients non appari√©s ‚àí Peut augmenter le biais s'il est mal fait (King & Nielsen)"
            },
            {
              heading: "2. STRATIFICATION",
              text: "Divide population into strata (e.g., quintiles) by PS.\n+ Simple, uses all data\n‚àí Residual confounding within strata\n‚àí Fewer strata = more bias; more = sparse data"
            },
            {
              heading: "3. INVERSE PROBABILITY WEIGHTING (IPTW)",
              text: "Weight patients by inverse of their PS.\n+ Uses all data, estimates population effect\n‚àí Extreme weights cause instability\n‚àí Sensitive to model misspecification"
            },
            {
              heading: "4. COVARIATE ADJUSTMENT",
              text: "Include PS as covariate in outcome model.\n+ Simple to implement\n‚àí Less efficient than other methods\n‚àí Doesn't check balance directly"
            },
            {
              heading: "Modern Preference:",
              text: "IPTW avec des poids stabilis√©s ou des poids superpos√©s souvent pr√©f√©r√©s. Le matching est de plus en plus critiqu√©. Mais TOUTES les m√©thodes n√©cessitent une bonne s√©lection de covariables et une bonne analyse de sensibilit√©."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Checking Balance: The Key Diagnostic",
          sections: [
            {
              heading: "Standardized Mean Difference (SMD):",
              items: [
                "SMD = (mean_treated - mean_control) / pooled_SD",
                "Before PS adjustment: expect large SMDs (confounding)",
                "After PS adjustment: SMDs should be <0.1 (balanced)",
                "If SMDs remain large, PS failed to balance"
              ]
            },
            {
              heading: "What to Check:",
              items: [
                "Balance on ALL measured confounders (not just PS)",
                "Balance on important interactions and non-linearities",
                "Overlap: both groups should have similar PS distributions",
                "En l'absence de chevauchement, l'effet n'est pas estimable"
              ]
            },
            {
              heading: "Red Flags:",
              items: [
                "SMD >0.1 after adjustment = residual imbalance",
                "Non-overlapping PS distributions = positivity violation",
                "Extreme weights (>10 or <0.1) = instability",
                "Results sensitive to PS model specification = fragile"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "IPTW Deep Dive: Modern Weighting Methods",
          sections: [
            {
              heading: "Standard IPTW (Inverse Probability of Treatment Weighting)",
              items: [
                "Weight for treated: w = 1/PS",
                "Weight for untreated: w = 1/(1-PS)",
                "Creates pseudo-population where treatment is independent of covariates",
                "Estimates AVERAGE TREATMENT EFFECT (ATE) in full population",
                "Problem: extreme weights when PS near 0 or 1"
              ]
            },
            {
              heading: "Stabilized Weights (sw-IPTW)",
              items: [
                "Treated: sw = P(T=1)/PS",
                "Untreated: sw = P(T=0)/(1-PS)",
                "Numerator stabilizes by multiplying by marginal probability",
                "Reduces variance, preserves sample size interpretation",
                "Preferred over standard IPTW in modern practice"
              ]
            },
            {
              heading: "Overlap Weights (OW) ‚Äî Modern Favorite",
              items: [
                "Treated: w = 1-PS",
                "Untreated: w = PS",
                "Targets patients with clinical equipoise (PS near 0.5)",
                "Automatically handles extreme PS ‚Äî no trimming needed",
                "Estimates effect in population where treatment decision is uncertain",
                "Best balance properties; increasingly recommended"
              ]
            },
            {
              heading: "Weight Diagnostics:",
              items: [
                "Check weight distribution (mean, max, SD)",
                "Mean of weights should ‚âà 1 for stabilized",
                "Truncate at 99th percentile if extreme (but acknowledge sensitivity)",
                "Plot weighted SMDs ‚Äî all should be <0.1",
                "Effective sample size: ESS = (Œ£w)¬≤/Œ£w¬≤ ‚Äî watch for low ESS"
              ]
            },
            {
              heading: "When to Use Which:",
              text: "IPTW/stabilized: want population-average effect, have good overlap. Overlap weights: extreme PS values, want robust estimates, uncertain treatment decisions. Matching: want intuitive comparison, can afford data loss. Avoid matching if sample is small or effect heterogeneity matters."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'propensity-decision',
          title: "La d√©cision sur le score de propension",
          situation: "You're analyzing whether a new anticoagulant (vs warfarin) reduces stroke in atrial fibrillation. You have data on age, sex, comorbidities, and CHA‚ÇÇDS‚ÇÇ-VASc score. You DON'T have data on: renal function, patient frailty, or reason for drug choice.",
          nodes: {
            start: {
              question: "Vous pr√©voyez d'utiliser la correspondance du score de propension. Quelle est la premi√®re chose que vous devez v√©rifier¬†?",
              branches: [
                { text: "Whether the propensity score model is statistically significant", nextNode: "sig_wrong" },
                { text: "Whether covariates are balanced after matching (SMDs <0.1)", nextNode: "balance_correct" },
                { text: "Whether the treatment effect is statistically significant", nextNode: "effect_wrong" }
              ]
            },
            balance_correct: {
              situation: "Correct! After matching, your SMDs are all <0.1. But you're worried about unmeasured confounding (renal function, frailty). What should you do?",
              question: "How do you address unmeasured confounding?",
              branches: [
                { text: "Add more measured variables to the PS model", nextNode: "more_vars" },
                { text: "Effectuer une analyse de sensibilit√© en cas de confusion non mesur√©e", nextNode: "sensitivity_correct" },
                { text: "Signaler le r√©sultat correspondant comme ¬´¬†ajust√© pour tenir compte de la confusion¬†¬ª", nextNode: "report_wrong" }
              ]
            },
            sig_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Wrong focus!",
              text: "La signification statistique du mod√®le PS n'est pas pertinente. Vous ne vous souciez pas de savoir si le traitement est ¬´ pr√©visible ¬ª ‚Äì vous vous souciez de savoir si les covariables sont √âQUILIBR√âES. Un mod√®le PS tr√®s significatif peut toujours ne pas parvenir √† √©quilibrer les principaux facteurs de confusion.",
              lesson: "Les mod√®les de score de propension sont jug√©s en fonction de l'√©quilibre atteint, et non en fonction des valeurs p ou des statistiques c. V√©rifiez les CMS, pas l'ajustement du mod√®le."
            },
            effect_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Wrong order!",
              text: "Vous ne devez JAMAIS examiner les effets du traitement avant de v√©rifier l'√©quilibre. Si les covariables ne sont pas √©quilibr√©es, l'estimation de l'effet est biais√©e. Examiner d'abord les effets peut vous inciter √† continuer √† peaufiner jusqu'√† ce que vous obteniez la r√©ponse souhait√©e.",
              lesson: "V√©rifiez toujours le solde AVANT d'examiner les effets du traitement. Pr√©-sp√©cifiez votre approche PS et vos crit√®res d'√©quilibre."
            },
            more_vars: {
              type: 'outcome',
              outcome: 'partial',
              title: "Helpful but insufficient",
              text: "L'ajout de variables mesur√©es peut aider, mais vous avez dit que la fonction r√©nale et la fragilit√© ne sont PAS MESUR√âES. Vous ne pouvez pas ajouter ce que vous n'avez pas. Vous avez besoin d'une analyse de sensibilit√© pour √©valuer le degr√© de confusion non mesur√© qui serait n√©cessaire pour modifier votre conclusion.",
              lesson: "Vous ne pouvez pas ajuster ce que vous ne mesurez pas. L'analyse de sensibilit√© quantifie l'impact potentiel de ce qui manque."
            },
            sensitivity_correct: {
              situation: "Excellent¬†! Vous ex√©cutez une analyse de sensibilit√© √† l‚Äôaide de la valeur E. Votre r√©sultat est HR 0,75 (0,65-0,87). La valeur E est de 1,82. Qu'est-ce que cela signifie¬†?",
              question: "Interpretation:",
              branches: [
                { text: "Un facteur de confusion non mesur√© avec un RR ‚â•1,82 avec √† la fois le traitement et le r√©sultat pourrait expliquer l'effet.", nextNode: "evalue_correct" },
                { text: "The result is robust because 1.82 is a large number", nextNode: "evalue_partial" }
              ]
            },
            report_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Misleading claim!",
              text: "Le fait de d√©clarer ¬´ corrig√© pour tenir compte des facteurs de confusion ¬ª implique que tous les facteurs de confusion sont pris en compte. Mais les scores de propension √©quilibrent UNIQUEMENT les variables mesur√©es. Avec des facteurs confondants non mesur√©s (fonction r√©nale, fragilit√©, canalisation), votre estimation peut encore √™tre fortement biais√©e.",
              lesson: "Always state: 'Adjusted for MEASURED confounders.' Acknowledge what's missing. Never claim full adjustment."
            },
            evalue_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Perfect interpretation!",
              text: "La valeur E quantifie la robustesse¬†: un facteur confondant non mesur√© aurait besoin d'un RR ‚â•¬†1,82 avec √† la fois l'exposition et le r√©sultat pour expliquer pleinement votre r√©sultat. Vous devriez maintenant vous demander : ¬´ Un facteur de confusion avec RR 1,82 est-il plausible ? Pour la fonction r√©nale affectant √† la fois le choix d'anticoagulant et l'accident vasculaire c√©r√©bral - tr√®s probablement oui.",
              lesson: "E-values don't prove causation. They help you assess: 'How strong would hidden bias need to be?' Compare to known confounder strengths."
            },
            evalue_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Needs context!",
              text: "Le fait que 1,82 soit ¬´¬†√©lev√©¬†¬ª d√©pend du contexte. Le tabagisme a un RR d'environ 20 pour le cancer du poumon, d'environ 2 √† 3 pour les maladies cardiaques. La fonction r√©nale peut avoir un RR de 1,5 √† 2 pour les accidents vasculaires c√©r√©braux. Vous devez comparer √† des forces de confusion plausibles, et non √† un seuil arbitraire.",
              lesson: "Les valeurs E n√©cessitent un jugement clinique. 1,82 n'est pas intrins√®quement robuste ou fragile¬†: cela d√©pend des facteurs de confusion non mesur√©s qui existent et de leur intensit√©."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "After propensity score matching, you achieve perfect balance (all SMDs <0.1) on 15 measured covariates. You can now conclude:",
          options: [
            { id: 'a', text: "L'effet du traitement n'est pas confondu", correct: false },
            { id: 'b', text: "L'effet du traitement n'est pas confondu par les 15 covariables mesur√©es", correct: true },
            { id: 'c', text: "L'√©tude est √©quivalente √† une RCT", correct: false },
            { id: 'd', text: "Unmeasured confounding has been addressed", correct: false }
          ],
          explanation: "Les scores de propension √©quilibrent uniquement le contenu du mod√®le. Un √©quilibre parfait sur 15 covariables signifie que ces 15 ne sont plus des facteurs de confusion ‚Äì mais ne dit rien sur les variables non mesur√©es. L'√©tude n'est PAS √©quivalente √† un ECR car la randomisation √©quilibre TOUS les facteurs de confusion, mesur√©s et non mesur√©s."
        }
      },
      {
        type: 'content',
        content: {
          title: "Negative Control Outcomes: Testing Your Adjustment",
          sections: [
            {
              heading: "The Brilliant Idea:",
              items: [
                "Choisissez un r√©sultat que votre exposition NE PEUT PAS affecter de mani√®re plausible",
                "Si votre analyse montre un ¬´ effet ¬ª sur ce contr√¥le n√©gatif ‚Üí vous avez des facteurs de confusion r√©siduels",
                "Exemple¬†: Statines ne devrait pas affecter les accidents de voiture. Si votre √©tude sur les statines montre moins d'accidents de voiture chez les utilisateurs de statines ‚Üí confusion (les personnes en meilleure sant√© prennent des statines ET conduisent prudemment)"
              ]
            },
            {
              heading: "How It Works:",
              items: [
                "Same exposure, same adjustment, different outcome",
                "Negative control outcome should share confounders with primary outcome",
                "But exposure has no biological pathway to negative control",
                "Association with negative control = confounding signal"
              ]
            },
            {
              heading: "Real Example:",
              items: [
                "Study: Do ACE inhibitors reduce COVID mortality?",
                "Primary outcome: COVID death",
                "Negative control: Injuries/accidents",
                "If ACE inhibitors 'reduce' injuries too ‚Üí healthy user confounding",
                "Used in major COVID-19 pharmacoepidemiology studies"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'negative-control-design',
          title: "Design a Negative Control Test",
          situation: "Vous √©tudiez si la vaccination contre la grippe r√©duit les √©v√©nements cardiovasculaires. Vous souhaitez tester la confusion chez les vaccin√©s sains √† l'aide de contr√¥les n√©gatifs.",
          nodes: {
            start: {
              question: "Which outcome would be a good NEGATIVE CONTROL for flu vaccine ‚Üí cardiovascular events?",
              branches: [
                { text: "Pneumonia hospitalization", nextNode: "pneumonia_wrong" },
                { text: "Hip fracture", nextNode: "hip_correct" },
                { text: "Diabetes diagnosis", nextNode: "diabetes_wrong" }
              ]
            },
            pneumonia_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Ce n'est pas un bon contr√¥le n√©gatif¬†!",
              text: "Flu vaccine MIGHT actually prevent pneumonia (flu can lead to secondary bacterial pneumonia). A negative control must be an outcome the exposure CANNOT plausibly affect. Pneumonia is biologically related to flu.",
              lesson: "Les contr√¥les n√©gatifs ne doivent avoir AUCUNE voie biologique issue de l'exposition. S'il existe un m√©canisme plausible, ce n'est pas un contr√¥le valide."
            },
            hip_correct: {
              situation: "Excellent choix¬†! Le vaccin contre la grippe n‚Äôa aucune voie biologique menant aux fractures de la hanche. Mais les fractures de la hanche partagent des facteurs confondants avec les √©v√©nements cardiovasculaires (√¢ge, fragilit√©, comportement en faveur de la sant√©). Vous constatez d√©sormais que la vaccination contre la grippe est associ√©e √† 20¬†% de fractures de la hanche en moins (RR 0,80).",
              question: "Qu'est-ce que cela vous apprend sur vos r√©sultats cardiovasculaires¬†?",
              branches: [
                { text: "Flu vaccine might actually prevent fractures too ‚Äî it's beneficial!", nextNode: "beneficial_wrong" },
                { text: "You have unmeasured confounding ‚Äî healthy vaccinees have better outcomes generally", nextNode: "confounding_correct" }
              ]
            },
            diabetes_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible mais pas id√©al",
              text: "Le diagnostic de diab√®te est chronique et peut partager des facteurs confondants. Mais le timing est d√©licat : vous avez besoin de NOUVEAUX r√©sultats apr√®s la vaccination. Les maladies chroniques sont plus difficiles √† chronom√©trer avec pr√©cision. Les fractures ou les accidents de la hanche sont meilleurs parce qu'il s'agit d'√©v√©nements aigus.",
              lesson: "Good negative controls are: (1) acute (clear timing), (2) share confounders with primary outcome, (3) have no biological link to exposure."
            },
            beneficial_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "C'est le pi√®ge de la confusion¬†!",
              text: "There is NO biological mechanism by which flu vaccine prevents hip fractures. The 'benefit' is confounding: people who get vaccinated are healthier, more mobile, less frail, and less likely to fall. This SAME confounding affects your cardiovascular finding.",
              lesson: "Lorsque les contr√¥les n√©gatifs montrent des ¬´¬†effets¬†¬ª, votre analyse principale est confuse. L'ampleur de l'effet du contr√¥le n√©gatif indique l'ampleur de votre biais."
            },
            confounding_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Exactly right!",
              text: "Si le vaccin contre la grippe ¬´ pr√©vient ¬ª les fractures de la hanche (RR 0,80) et qu'il n'y a aucun m√©canisme biologique, alors environ 20 % de vos effets observ√©s sont dus √† une confusion chez les vaccin√©s en bonne sant√©. Votre RR cardiovasculaire de 0,70 pourrait en r√©alit√© √™tre plus proche de 0,88 (RR/0,80). Le contr√¥le n√©gatif quantifie votre biais.",
              lesson: "Negative controls are diagnostic. Use them to: (1) detect confounding, (2) estimate its magnitude, (3) potentially calibrate your main estimate. This is essential for credible observational research."
            }
          }
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: Propensity scores are TOOLS, not magic wands. They balance what you measure. They create false confidence when you haven't measured the key confounders. Always ask: 'What would a negative control show?' If your exposure 'prevents' outcomes it biologically cannot affect, your adjustment has failed."
        }
      }
    ]
  },
  // MODULE 7: THE TARGET TRIAL (Target Trial Emulation)
  {
    id: 7,
    title: "L'essai cible",
    subtitle: "Emulating RCTs",
    principle: 1,
    estimatedTime: "25 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "L'association n'est pas un lien de causalit√©"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA CLARIFICATION¬†: L'ASPIRINE ET LE CANCER - QUAND LE CADRAGE A TOUT CHANG√â",
          source: "Hern√°n & Robins | Am J Epidemiol 2016 | Target trial framework",
          timeline: [
            { year: "1990s-2000s", text: "√âtudes d'observation incoh√©rentes sur l'aspirine et le cancer. Certains font preuve de protection, d‚Äôautres non. Diff√©rentes fen√™tres temporelles, populations, d√©finitions.", type: "normal" },
            { year: "The Problem", text: "Chaque √©tude posait une question l√©g√®rement diff√©rente. ¬´¬†L'aspirine pr√©vient-elle le cancer¬†?¬†¬ª est ambigu. QUEL r√©gime d'aspirine ? Chez QUI ? Commenc√© QUAND ? Par rapport √† QUOI ?", type: "crisis" },
            { year: "Target Trial", text: "Specify the RCT you WISH you could do: eligibility (healthy adults 50-70), intervention (aspirin 75mg daily), comparator (no aspirin), outcomes (cancer incidence at 10 years), time zero.", type: "revelation" },
            { year: "Emulation", text: "Analysez maintenant les donn√©es d'observation comme s'il s'agissait de cet essai. Cloner les patients au temps z√©ro. Appliquer les crit√®res d‚Äô√©ligibilit√©. Suivez √† partir du m√™me point de d√©part. Comparez les m√™mes r√©sultats.", type: "revelation" },
            { year: "Resolution", text: "Lorsque les √©tudes ont imit√© l'essai cible SAME, les r√©sultats sont devenus coh√©rents. Les √©carts √©taient dus √† des questions de recherche diff√©rentes (souvent implicites).", type: "revelation" },
            { year: "Lesson", text: "Avant d'analyser les donn√©es d'observation, PR√âCISEZ VOTRE ESSAI CIBLE. Cela rend les hypoth√®ses explicites, √©vite les biais courants et permet la comparaison entre les √©tudes.", type: "revelation" }
          ],
          realData: {
            endpoint: "Cancer incidence/mortality",
            drug: "Aspirin (various regimens)",
            placebo: "No aspirin (various comparators)",
            rr: "Ranged HR 0.70 to 1.20 depending on implicit trial",
            ci: "Clarified once target trial specified",
            nnh: "Decades of confusion from ambiguous questions"
          },
          hook: "THE HOOK: 'Does aspirin prevent cancer?' isn't a research question ‚Äî it's a family of questions. Target trial emulation forces you to be precise: WHICH intervention, in WHOM, compared to WHAT, measured HOW. Precision enables causal inference."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY INSIGHT: Every observational analysis implicitly emulates SOME randomized trial. The target trial framework makes this explicit. By specifying eligibility, interventions, outcomes, and time zero BEFORE analysis, you prevent biases like immortal time, prevalent user bias, and confounding by indication."
        }
      },
      {
        type: 'story-box',
        content: {
          icon: 'üéØ',
          title: "The Target Trial Emulation Revolution",
          source: "Hernan & Robins, Am J Epidemiol 2016 | Causal Inference Framework",
          paragraphs: [
            "In 2016, Miguel Hernan and James Robins formalized a methodological revolution: 'target trial emulation.' The idea was deceptively simple‚Äîdesign your observational analysis as if it were the RCT you wish you could do.",
            "They applied this to a contentious question: do statins prevent death in primary prevention? Traditional observational methods showed a 25% mortality reduction. But when analyzed using target trial emulation‚Äîproper time zero, new-user design, clear eligibility‚Äîthe benefit dropped to 15%.",
            "The 10-percentage-point difference wasn't noise‚Äîit was bias that traditional methods had missed. Immortal time, prevalent user bias, and unclear time zero had all inflated the apparent benefit. Target trial emulation didn't just give a different answer; it gave a more honest one."
          ],
          lesson: "Target trial emulation is reshaping observational research. By forcing explicit specification of eligibility, interventions, time zero, and outcomes BEFORE analysis, it prevents the biases that have historically made observational studies unreliable. It's not a statistical trick‚Äîit's a framework for honest causal thinking."
        }
      },
      {
        type: 'content',
        content: {
          title: "Le cadre d'essai cible",
          sections: [
            {
              heading: "Step 1: Specify the Protocol (7 Components):",
              items: [
                "1. ELIGIBILITY: Who would be enrolled?",
                "2. INTERVENTIONS: What treatments, at what doses?",
                "3. ASSIGNMENT: How would randomization work?",
                "4. TIME ZERO: When does follow-up start?",
                "5. OUTCOMES: What do you measure, and when?",
                "6. FOLLOW-UP: How long do you track patients?",
                "7. ANALYSE¬†:¬†Intention de traiter¬†? Par protocole¬†?"
              ]
            },
            {
              heading: "Step 2: Emulate with Observational Data:",
              items: [
                "Apply eligibility criteria to your database",
                "Define time zero (same for all patients!)",
                "Classify exposure at time zero (not after)",
                "Use methods to handle confounding (PS, IPW)",
                "Analysez comme vous le feriez pour l'ECR"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: √âVITER LES BIAIS GR√ÇCE √Ä UN ESSAI CIBLE",
          title: "How Specification Prevents Bias",
          sections: [
            {
              heading: "Prevents IMMORTAL TIME BIAS:",
              text: "En d√©finissant le temps z√©ro, vous ne pouvez pas classer √† tort le temps de survie comme temps d'exposition. L'horloge de chacun commence au m√™me moment (√©ligibilit√© + attribution du traitement), pas au moment o√π ils re√ßoivent le traitement."
            },
            {
              heading: "Prevents PREVALENT USER BIAS:",
              text: "L'essai cible sp√©cifie les NOUVEAUX utilisateurs, tout comme un ECR. On ne m√©lange pas des personnes qui viennent de commencer (incident) avec des personnes sous traitement depuis des ann√©es (pr√©valent). L'essai n'inclut pas les utilisateurs courants."
            },
            {
              heading: "Prevents CONFOUNDING BY INDICATION:",
              text: "Eligibility criteria define who could receive either treatment. Propensity scores or IPW handle remaining confounding. You're comparing 'like with like' at time zero."
            },
            {
              heading: "Ensures CLEAR OUTCOMES:",
              text: "L'√©valuation des r√©sultats est d√©finie a priori. Vous ne pouvez pas modifier le point de terminaison apr√®s avoir vu les donn√©es. Le protocole d'essai cible se verrouille dans votre plan d'analyse."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Time Zero: The Critical Concept",
          sections: [
            {
              heading: "What Is Time Zero?",
              items: [
                "Le moment o√π l'essai hypoth√©tique serait randomis√©",
                "DOIT √™tre le m√™me pour tous les patients de l'analyse",
                "MUST be when exposure status is assigned",
                "Follow-up starts AT time zero, not before"
              ]
            },
            {
              heading: "Common Mistakes:",
              items: [
                "Using 'ever vs never' exposure (no time zero)",
                "Starting follow-up at diagnosis but assigning exposure later",
                "Mixing incident and prevalent users",
                "Different time zeros for different groups"
              ]
            },
            {
              heading: "Example: Statins After MI",
              items: [
                "Target trial: Randomize at hospital discharge",
                "Emulation: Time zero = discharge date",
                "Assign statin status AT DISCHARGE (not later prescriptions)",
                "Suivi de la sortie au r√©sultat",
                "This prevents immortal time bias"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'target-trial-design',
          title: "Concevez votre cible Essai",
          situation: "Vous souhaitez √©tudier si le d√©but d'un r√©gime m√©diterran√©en apr√®s une crise cardiaque r√©duit la mortalit√© par rapport au r√©gime habituel. Vous disposez de dossiers de sant√© √©lectroniques avec des √©valuations di√©t√©tiques √† diff√©rents moments.",
          nodes: {
            start: {
              question: "What should be your time zero?",
              branches: [
                { text: "Date of first Mediterranean diet assessment", nextNode: "diet_date_wrong" },
                { text: "Hospital discharge after MI", nextNode: "discharge_correct" },
                { text: "Date of MI diagnosis", nextNode: "mi_date_partial" }
              ]
            },
            discharge_correct: {
              situation: "Good choice! Discharge is when a dietary intervention could plausibly start. Now, how do you define 'Mediterranean diet' exposure?",
              question: "Exposure definition:",
              branches: [
                { text: "Any Mediterranean diet assessment scored 'high' during follow-up", nextNode: "any_high_wrong" },
                { text: "Mediterranean diet score at the first post-discharge assessment", nextNode: "first_assessment_correct" },
                { text: "Sustained high Mediterranean diet score for 6+ months", nextNode: "sustained_partial" }
              ]
            },
            diet_date_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "This creates immortal time bias!",
              text: "Les patients doivent SURVIVRE jusqu'√† leur premi√®re √©valuation di√©t√©tique pour √™tre class√©s dans la cat√©gorie ¬´¬†r√©gime m√©diterran√©en¬†¬ª. Le temps entre l‚ÄôIM et l‚Äô√©valuation est un temps immortel. S'il est mal class√©, cela gonfle artificiellement la survie dans le groupe soumis au r√©gime.",
              lesson: "Le temps z√©ro doit √™tre le moment o√π l'intervention POURRAIT commencer, et non le moment o√π elle a √©t√© mesur√©e. Les dates d'√©valuation di√©t√©tique varient¬†: cela cr√©e des temps z√©ros diff√©rentiels."
            },
            mi_date_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Reasonable but challenging",
              text: "La date de l'IM est raisonnable pour le temps z√©ro, mais l'intervention di√©t√©tique ne peut pas commencer tant que le patient n'est pas stable (g√©n√©ralement sa sortie). Si vous commencez √† l'IM, vous disposez d'une br√®ve p√©riode de ¬´¬†soins aigus¬†¬ª pendant laquelle l'exposition alimentaire n'est pas d√©finie.",
              lesson: "Le temps z√©ro devrait √™tre celui o√π l'intervention est FAIBLE. Pour les interventions sur le mode de vie post-IM, la sortie est souvent plus pratique que l'IM lui-m√™me."
            },
            any_high_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "This is immortal time bias again!",
              text: "D√©finir l'exposition par TOUTE √©valuation au cours du suivi signifie que les patients doivent survivre √† cette √©valuation. Le temps qui s'√©coule avant d'atteindre le score ¬´ √©lev√© ¬ª est un temps immortel. Il s'agit du m√™me biais que les √©tudes sur les statines contre le cancer.",
              lesson: "L'exposition doit √™tre attribu√©e au temps z√©ro, et non en fonction d'√©v√©nements futurs. Vous ne pouvez pas ¬´¬†√™tre expos√©¬†¬ª pendant le suivi dans le cadre d'essai cible."
            },
            first_assessment_correct: {
              situation: "Excellent¬†! Exposition attribu√©e lors de la premi√®re √©valuation apr√®s le temps z√©ro. Maintenant, qu'en est-il des patients sans √©valuation alimentaire¬†?",
              question: "Comment g√©rer les donn√©es alimentaires manquantes¬†?",
              branches: [
                { text: "Exclude them ‚Äî they don't have the key variable", nextNode: "exclude_wrong" },
                { text: "Classer comme ¬´¬†r√©gime habituel¬†¬ª (comparateur) et effectuer une analyse de sensibilit√©", nextNode: "classify_correct" }
              ]
            },
            sustained_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "C'est une question diff√©rente",
              text: "'Sustained' exposure over 6 months is a valid question, but it's a DIFFERENT target trial: one studying adherent patients (per-protocol effect). The primary analysis should be intention-to-treat: initial assignment regardless of subsequent adherence.",
              lesson: "Target trial can be ITT or per-protocol. ITT compares initial strategies. Per-protocol compares sustained adherence. State which you're emulating."
            },
            exclude_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Cela cr√©e une s√©lection biais¬†!",
              text: "Exclure les patients sans donn√©es alimentaires signifie que vous s√©lectionnez un sous-ensemble non al√©atoire. Si les patients les plus malades sont moins susceptibles de r√©aliser des √©valuations di√©t√©tiques, votre comparaison porte d√©sormais uniquement sur les patients en meilleure sant√©¬†‚Äì biais de s√©lection.",
              lesson: "Les donn√©es manquantes doivent √™tre trait√©es et non utilis√©es √† des fins d'exclusion. L'essai cible n'exclurait pas les patients ayant manqu√© un questionnaire."
            },
            classify_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Thoughtful approach!",
              text: "Traiter les disparus comme un ¬´ r√©gime alimentaire habituel ¬ª maintient la cohorte. Les analyses de sensibilit√© peuvent explorer des alternatives. Cela imite ce que ferait un ECR¬†: les patients qui ne suivent pas le protocole de r√©gime sont toujours analys√©s dans le groupe qui leur a √©t√© attribu√© (ITT).",
              lesson: "G√©rez les donn√©es manquantes avec des m√©thodes fond√©es sur des principes (imputation multiple, pond√©ration de probabilit√© inverse). Ne jamais exclure en fonction de la disponibilit√© des donn√©es apr√®s le temps z√©ro."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A study compares 'metformin initiators' to 'sulfonylurea initiators' among patients with newly diagnosed diabetes. Time zero is defined as the date of first drug prescription. This study design:",
          options: [
            { id: 'a', text: "Has immortal time bias because patients must survive to get a prescription", correct: false },
            { id: 'b', text: "Appropriately emulates a target trial comparing these two treatments", correct: true },
            { id: 'c', text: "Has prevalent user bias because some patients are on long-term therapy", correct: false },
            { id: 'd', text: "Cannot estimate causal effects because it's observational", correct: false }
          ],
          explanation: "This is an ACTIVE COMPARATOR NEW USER (ACNU) design ‚Äî the gold standard for drug safety studies. Time zero is first prescription (new users). Both groups start at the same point. There's no immortal time because patients are classified at the moment of first prescription, and no prevalent user bias because only new users are included."
        }
      }
    ]
  },
  // MODULE 8: THE SYNTHESIS (Meta-analysis of Observational Studies)
  {
    id: 8,
    title: "The Synthesis",
    subtitle: "Regroupement des preuves observationnelles",
    principle: 6,
    estimatedTime: "30 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "La moyenne peut se situer"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PROBL√àME DE POOLING¬†: VITAMINE D ET MORTALIT√â¬†‚Äì LORSQUE LA M√âTA-ANALYSE BIAIS MAGNIFI√â",
          source: "Multiple vitamin D meta-analyses | Autier 2014 | Mendelian randomization studies",
          timeline: [
            { year: "2007-2012", text: "Les √©tudes d'observation montrent syst√©matiquement qu'un faible taux de vitamine D pr√©dit une mortalit√© plus √©lev√©e. Biologie plausible. M√©ta-analyses de cohortes¬†: RR regroup√© ~¬†1,5-2,0 pour les taux de vitamine D faibles ou √©lev√©s.", type: "normal" },
            { year: "The MA Problem", text: "Les √©tudes observationnelles de m√©ta-analyse regroupent les BIAIS, pas seulement les signaux. Si chaque √©tude pr√©sente un biais d'utilisateur sain, l'estimation group√©e est une estimation pr√©cise de l'effet biais√©.", type: "crisis" },
            { year: "RCTs Arrive", text: "VITAL, ViDA, D-Health: large RCTs of vitamin D supplementation. Results: null effects on mortality, cardiovascular disease, cancer. RR ~1.00.", type: "revelation" },
            { year: "Mendelian Randomization", text: "√âtudes MR (utilisant des variantes g√©n√©tiques comme instruments)¬†: aucun effet causal de la vitamine D sur la mortalit√©. L'association observationnelle √©tait CONFOND√âE.", type: "revelation" },
            { year: "The Explanation", text: "Reverse causation: illness lowers vitamin D levels. Confounding: outdoor activity, exercise, healthy lifestyle all correlate with vitamin D AND longevity.", type: "revelation" },
            { year: "Lesson", text: "La m√©ta-analyse d'√©tudes biais√©es donne une r√©ponse biais√©e pr√©cise. ¬´¬†D√©chets entrants, d√©chets sortants¬†¬ª √† grande √©chelle. L'h√©t√©rog√©n√©it√© des biais, et pas seulement les effets, est importante.", type: "revelation" }
          ],
          realData: {
            endpoint: "All-cause mortality",
            drug: "Vitamin D (observational low vs high)",
            placebo: "RCT supplementation vs placebo",
            rr: "Observational: RR 1.57 | RCT: RR 0.97 (0.93-1.02)",
            ci: "Confounding created false association",
            nnh: "Billions spent on vitamin D supplements"
          },
          hook: "THE HOOK: Meta-analysis of 50 biased studies doesn't give you the truth ‚Äî it gives you a very precise biased estimate. Before pooling observational studies, assess each one's ROBINS-I risk of bias. Consider whether you're pooling signal or noise."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY INSIGHT: Heterogeneity in observational meta-analyses isn't just about effect size variation ‚Äî it's about BIAS variation. Different studies have different confounding structures, selection mechanisms, and measurement approaches. Pooling doesn't solve this; it obscures it."
        }
      },
      {
        type: 'content',
        content: {
          title: "Quand m√©ta-analyser les √©tudes observationnelles",
          sections: [
            {
              heading: "Appropriate Situations:",
              items: [
                "RCTs are impossible (rare harms, long-term outcomes)",
                "Exposure cannot be randomized (smoking, environmental)",
                "Complementing RCT evidence (generalizability, subgroups)",
                "Les √©tudes utilisent des conceptions similaires et abordent des biais similaires",
                "La question concerne l'ASSOCIATION (pas essentiellement la causalit√©)"
              ]
            },
            {
              heading: "Problematic Situations:",
              items: [
                "Studies have incompatible confounding structures",
                "Major unmeasured confounders likely differ across studies",
                "Studies use different exposure/outcome definitions",
                "Pooling to achieve 'statistical significance'",
                "Ignoring within-study bias to focus on between-study variance"
              ]
            },
            {
              heading: "The Fundamental Question:",
              text: "Sont vous mutualisez les √âTUDES ou mutualisez les BIAIS ? Si chaque √©tude est confondue dans le m√™me sens, la m√©ta-analyse vous donnera une estimation confuse plus pr√©cise, pas la v√©rit√©."
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: M√âTA-ANALYSE D'OBSERVATION",
          title: "Best Practices",
          sections: [
            {
              heading: "1. Use ROBINS-I for Each Study:",
              text: "√âvaluez le risque de biais domaine par domaine. Les √©tudes √† risque critique doivent g√©n√©ralement √™tre exclues ou analys√©es s√©par√©ment. Les √©tudes √† risques graves n√©cessitent une analyse de sensibilit√©."
            },
            {
              heading: "2. Don't Mix RCTs and Observational:",
              text: "Diff√©rentes structures de biais rendent la combinaison probl√©matique. Pr√©senter s√©par√©ment. En cas de combinaison, pond√©ration en fonction de la qualit√© de la conception de l'√©tude, et pas seulement de la variance."
            },
            {
              heading: "3. Explore Heterogeneity by Bias:",
              text: "Subgroup by ROBINS-I risk level. If low-risk studies give different answers than high-risk studies, that's informative: bias explains heterogeneity."
            },
            {
              heading: "4. Consider Adjusted vs Crude:",
              text: "Meta-analyze adjusted estimates (not crude). But different adjustment sets = different estimands. Document what each study adjusted for."
            },
            {
              heading: "5. Use GRADE for Observational:",
              text: "Commencez avec une certitude ¬´ faible ¬ª (et non ¬´ √©lev√©e ¬ª comme les ECR). Notez √† la baisse pour les biais suppl√©mentaires, les incoh√©rences, les impr√©cisions et le caract√®re indirect. √âvaluez uniquement avec prudence."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Heterogeneity: Different Sources in Observational Data",
          sections: [
            {
              heading: "Clinical Heterogeneity:",
              text: "Different populations, interventions, outcomes, timing ‚Äî same as in RCT meta-analyses."
            },
            {
              heading: "Methodological Heterogeneity:",
              text: "Diff√©rentes conceptions d'√©tude (cohorte ou cas-t√©moins), diff√©rentes strat√©gies d'ajustement, diff√©rentes d√©finitions d'exposition. Ceci est PLUS important dans la MA observationnelle."
            },
            {
              heading: "Bias Heterogeneity:",
              text: "Different confounding structures, different amounts of unmeasured confounding, different selection mechanisms. This is UNIQUE to observational MA."
            },
            {
              heading: "What High I¬≤ Means:",
              items: [
                "In RCT MA: treatment effects truly differ across populations",
                "In observational MA: could be effect heterogeneity OR bias heterogeneity",
                "Vous ne pouvez pas distinguer sans examiner les √©tudes",
                "Meta-regression by study quality can help, but is often underpowered"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'obs-ma-decision',
          title: "Devriez-vous regrouper ces √©tudes¬†?",
          situation: "You're conducting a systematic review on coffee and cardiovascular disease. You found 15 cohort studies, 3 case-control studies, and 2 RCTs. ROBINS-I assessment: 5 cohorts at moderate risk, 8 at serious risk, 2 at critical risk. The case-controls are all serious risk. RCTs are low risk but underpowered.",
          nodes: {
            start: {
              question: "Quelle est votre approche de la synth√®se¬†?",
              branches: [
                { text: "Pool all 20 studies to maximize power", nextNode: "pool_all_wrong" },
                { text: "Pool only low/moderate risk studies, exclude high risk", nextNode: "exclude_high" },
                { text: "Present stratified analyses by risk of bias level", nextNode: "stratified_correct" }
              ]
            },
            pool_all_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Cela amplifie biais¬†!",
              text: "Regrouper 20¬†√©tudes lorsque plus de 10¬†√©tudes pr√©sentent un biais grave/critique signifie que votre estimation group√©e est domin√©e par des donn√©es biais√©es. Vous obtiendrez une estimation tr√®s pr√©cise du biais moyen entre les √©tudes.",
              lesson: "Plus d'√©tudes ‚â† meilleure m√©ta-analyse. La qualit√© compte plus que la quantit√©. Ne regroupez jamais les √©tudes de risques critiques dans l‚Äôanalyse principale."
            },
            exclude_high: {
              situation: "Mieux¬†! Mais vous ne disposez d√©sormais que de 5 cohortes (mod√©r√©es) et de 2 ECR (faibles) ‚Äì donn√©es limit√©es. Que faites-vous ensuite¬†?",
              question: "Synthesis approach:",
              branches: [
                { text: "Regroupez les 5 cohortes et les 2 ECR ensemble", nextNode: "pool_mixed_wrong" },
                { text: "Pr√©sentez les ECR s√©par√©ment, les cohortes s√©par√©ment, avec une analyse de sensibilit√©", nextNode: "separate_correct" }
              ]
            },
            stratified_correct: {
              situation: "Excellent! You plan to show: (1) RCTs alone, (2) Low/moderate risk cohorts, (3) All studies. This is transparent.",
              question: "Vos ECR montrent un RR de 0,95 (0,60-1,50). Les cohortes √† risque mod√©r√© affichent un RR de 0,75 (0,70-0,80). Les √©tudes √† haut risque montrent un RR de 0,65 (0,60-0,70). Que concluez-vous¬†?",
              branches: [
                { text: "Coffee protects ‚Äî all estimates show benefit", nextNode: "conclude_benefit_wrong" },
                { text: "Lower quality studies show stronger effects ‚Äî suggests bias", nextNode: "conclude_bias_correct" }
              ]
            },
            pool_mixed_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Attention au m√©lange¬†!",
              text: "Les ECR et les √©tudes observationnelles ont des structures de biais fondamentalement diff√©rentes. Les regrouper donne un chiffre, mais on ne sait pas exactement ce que ce chiffre estime. Mieux vaut pr√©senter s√©par√©ment et discuter de la concordance/discordance.",
              lesson: "Si les ECR et les √©tudes observationnelles concordent, la confiance augmente. S‚Äôils ne sont pas d‚Äôaccord, explorez pourquoi (confusion ? modification de l‚Äôeffet ?). Ne cachez pas vos d√©saccords en les mettant en commun."
            },
            separate_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Rigorous approach!",
              text: "La pr√©sentation s√©par√©e des ECR et des √©tudes observationnelles permet aux lecteurs de constater la concordance/discordance. Les analyses de sensibilit√© montrent comment les r√©sultats changent selon diff√©rentes hypoth√®ses. Ceci est transparent et informatif.",
              lesson: "Le but de la m√©ta-analyse est de r√©sumer les preuves, et non de fabriquer un seul chiffre. La stratification par qualit√© d'√©tude est plus honn√™te que de tout regrouper."
            },
            conclude_benefit_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Surveillez la tendance¬†!",
              text: "L'ECR (biais le plus faible) montre un effet nul (0,95, IC d√©passe 1). √Ä mesure que le risque de biais augmente, le b√©n√©fice apparent augmente (0,75 ‚Üí 0,65). Il s'agit d'un signe classique selon lequel la CONFONDATION, et non le caf√©, explique le ¬´¬†b√©n√©fice¬†¬ª.",
              lesson: "Lorsque la taille de l'effet augmente avec le risque de biais, suspectez un biais et non un lien de causalit√©. L'ECR est votre point d'ancrage¬†: les estimations observationnelles doivent √™tre interpr√©t√©es par rapport √† lui."
            },
            conclude_bias_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Astute interpretation!",
              text: "Vous avez identifi√© le mod√®le ¬´¬†risque de biais par rapport √† l'ampleur de l'effet¬†¬ª¬†: les √©tudes de moindre qualit√© montrent des effets plus importants. Il s‚Äôagit d‚Äôune preuve solide de confusion (biais des utilisateurs sains¬†: les buveurs de caf√© sont en meilleure sant√©). Le r√©sultat nul de l'ECR est probablement plus proche de la v√©rit√©.",
              lesson: "La stratification par risque de biais est diagnostique. Si les √©tudes de haute qualit√© et de mauvaise qualit√© donnent des r√©ponses diff√©rentes, faites confiance aux √©tudes de haute qualit√© et recherchez ce qui biaise les √©tudes de mauvaise qualit√©."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "A meta-analysis of 30 observational studies shows a pooled OR of 0.72 (0.68-0.76) with I¬≤ = 5%. What can you conclude?",
          options: [
            { id: 'a', text: "L'effet est r√©el¬†: coh√©rent dans toutes les √©tudes avec une haute pr√©cision", correct: false },
            { id: 'b', text: "Les √©tudes sont homog√®nes, ce qui augmente la confiance dans l'estimation", correct: false },
            { id: 'c', text: "Un I¬≤ faible signifie que les √©tudes sont d'accord, mais elles peuvent toutes √™tre biais√©es. dans la m√™me direction", correct: true },
            { id: 'd', text: "Il s'agit d'une preuve solide d'un effet protecteur causal", correct: false }
          ],
          explanation: "Low I¬≤ means studies are consistent ‚Äî but they could be consistently BIASED. If all 30 studies have healthy user bias, they'll all show a protective effect, and I¬≤ will be low. Homogeneity is reassuring only if studies aren't all biased the same way. Without ROBINS-I assessment, you can't distinguish consistency of effect from consistency of bias."
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE TIME ILLUSION: LEAD TIME BIAS ‚Äî WHEN SCREENING LOOKED MIRACULOUS",
          source: "Welch 2010 | Overdiagnosed | Neuroblastoma screening | PSA debates",
          timeline: [
            { year: "The Promise", text: "Cancer screening finds disease early. 'Early detection saves lives.' 5-year survival with screening: 95%. Without screening: 60%. Screening works... right?", type: "normal" },
            { year: "The Illusion", text: "A patient diagnosed at age 60 (no screening) dies at 65. 5-year survival = 0%. The SAME patient diagnosed at 55 (screening) dies at 65. 5-year survival = 100%. NOTHING CHANGED except diagnosis date.", type: "revelation" },
            { year: "Neuroblastoma", text: "Le Japon a d√©pist√© tous les nourrissons pour le neuroblastome (cancer de l'enfant). J'ai trouv√© 3 fois plus de cas. La survie √† 5 ans a grimp√© en fl√®che. MAIS¬†: La mortalit√© est rest√©e INCHANG√âE. Ils ont d√©couvert des cancers qui auraient r√©gress√© d'eux-m√™mes.", type: "crisis" },
            { year: "PSA Screening", text: "Le d√©pistage de la prostate augmente consid√©rablement la survie √† 5 ans. Mais le b√©n√©fice en termes de mortalit√© est minime, voire nul, dans de nombreux essais. De nombreux hommes re√ßoivent un traitement contre un cancer qui ne les aurait jamais tu√©s.", type: "crisis" },
            { year: "The Math", text: "Lead time = time between screen detection and when symptoms would appear. If lead time is 5 years, 5-year survival improves by 100% even with ZERO mortality benefit.", type: "revelation" },
            { year: "Lesson", text: "N'utilisez JAMAIS les statistiques de survie pour √©valuer le d√©pistage. Seule la MORTALIT√â (d√©c√®s par population) dit la v√©rit√©. La survie est contamin√©e par les d√©lais d'ex√©cution et le surdiagnostic.", type: "revelation" }
          ],
          realData: {
            endpoint: "5-year survival vs population mortality",
            drug: "Cancer screening programs",
            placebo: "No screening",
            rr: "Survival: dramatic improvement | Mortality: often minimal",
            ci: "Lead time creates illusion of benefit",
            nnh: "Des millions de personnes sont surdiagnostiqu√©es avec des ¬´ cancers ¬ª qui n'auraient jamais caus√© de pr√©judice"
          },
          hook: "THE HOOK: '5-year survival improved 50%' sounds like screening works. But it might just mean you moved the starting line. Survival measures time from DIAGNOSIS. If diagnosis is earlier but death is the same, survival 'improves' without anyone living longer. This is lead time bias ‚Äî and it has fooled millions."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'screening-evaluation',
          title: "√âvaluez cette all√©gation de d√©pistage",
          situation: "Un nouveau test de d√©pistage du cancer du pancr√©as est promu. Les supports marketing montrent : ¬´ La survie √† 5 ans est de 25 % avec le d√©pistage contre 5 % sans ¬ª. Le test co√ªte 500¬†$ et pr√©sente un taux de faux positifs de 3¬†% n√©cessitant un suivi invasif.",
          nodes: {
            start: {
              question: "Quelle est votre premi√®re pr√©occupation concernant l'all√©gation de survie de ¬´¬†25¬†% contre 5¬†%¬†¬ª¬†?",
              branches: [
                { text: "It's impressive ‚Äî 5x better survival!", nextNode: "impressed_wrong" },
                { text: "Survival doesn't prove mortality benefit ‚Äî could be lead time", nextNode: "lead_time_correct" },
                { text: "L'√©tude n'a probablement pas √©t√© randomis√©e", nextNode: "randomization_partial" }
              ]
            },
            impressed_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "You've been fooled by lead time!",
              text: "Le cancer du pancr√©as est presque universellement mortel. Si le d√©pistage fait avancer le diagnostic d‚Äôun an mais que les patients d√©c√®dent toujours au m√™me √¢ge, la survie √† un an passe d‚Äôenviron 20 % √† environ 40 % ‚Äì avec Z√âRO vie sauv√©e. Les statistiques de survie n'ont aucun sens pour √©valuer le d√©pistage.",
              lesson: "N'acceptez JAMAIS la survie comme preuve du b√©n√©fice du d√©pistage. Exigez des donn√©es sur la mortalit√© provenant d‚Äôessais randomis√©s."
            },
            lead_time_correct: {
              situation: "Excellent skepticism! You ask for mortality data. They provide: 'In a cohort study, screened patients had 30% lower pancreatic cancer mortality.'",
              question: "Is this convincing?",
              branches: [
                { text: "Yes ‚Äî mortality is the right endpoint", nextNode: "cohort_wrong" },
                { text: "No ‚Äî cohort studies of screening have healthy screener bias", nextNode: "healthy_screener_correct" }
              ]
            },
            randomization_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Good instinct, but the specific bias matters",
              text: "Oui, l‚Äô√©tude est probablement observationnelle. Mais le biais SP√âCIFIQUE est le d√©lai d‚Äôex√©cution : la survie s‚Äôam√©liore simplement en diagnostiquant plus t√¥t, m√™me si la date du d√©c√®s reste inchang√©e. La randomisation serait utile, mais m√™me dans ce cas, vous avez besoin de la MORTALIT√â, et non de la survie, comme crit√®re d'√©valuation.",
              lesson: "For screening evaluation: (1) Must be mortality, not survival, (2) Must be randomized or very carefully designed to avoid healthy screener bias."
            },
            cohort_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Healthy screener bias!",
              text: "Les personnes qui choisissent le d√©pistage sont syst√©matiquement en meilleure sant√©. Ils font plus d‚Äôexercice, mangent mieux et ont un meilleur acc√®s aux soins de sant√©. Ils ont une mortalit√© plus faible POUR TOUT ‚Äì y compris le cancer du pancr√©as ‚Äì m√™me si le d√©pistage ne fonctionne pas. C'est √† nouveau un THS.",
              lesson: "Un pr√©jug√© sain du d√©pistage est un biais sain de l'utilisateur appliqu√© au d√©pistage. Seuls les ECR peuvent l‚Äô√©liminer. Les comparaisons observationnelles de mortalit√© pour le d√©pistage ne sont pas fiables."
            },
            healthy_screener_correct: {
              situation: "Perfect! You demand RCT evidence. The company says: 'An RCT is ongoing but won't report for 10 years. In the meantime, shouldn't we offer screening?'",
              question: "Your response:",
              branches: [
                { text: "Yes ‚Äî some benefit is likely, and screening is harmless", nextNode: "harmless_wrong" },
                { text: "No ‚Äî unproven screening causes harm through false positives, overdiagnosis, and anxiety", nextNode: "wait_correct" }
              ]
            },
            harmless_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Le d√©pistage n'est PAS inoffensif¬†!",
              text: "3% false positive rate √ó millions screened = tens of thousands of invasive biopsies. Pancreas biopsies can cause pancreatitis, bleeding, death. Plus anxiety from false alarms. Plus overdiagnosis of indolent tumors treated unnecessarily. Screening without proven benefit is NET HARM.",
              lesson: "Screening has COSTS: false positives, overdiagnosis, anxiety, procedures. These are CERTAIN. Benefit is UNCERTAIN until RCT-proven. Uncertain benefit + certain harm = wait for evidence."
            },
            wait_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Evidence-based patience!",
              text: "You correctly identified: (1) survival claims mean nothing (lead time), (2) observational mortality claims have healthy screener bias, (3) screening has real harms. Until an RCT shows MORTALITY benefit outweighs harms, screening should not be implemented.",
              lesson: "Screening is INTERVENTION. It requires the same evidence standard as drugs: RCT showing benefits > harms. 'Early detection' sounds good but isn't automatically beneficial."
            }
          }
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: Screening programs are among the most bias-prone topics in medicine. Lead time bias makes survival look better than reality. Length bias makes screening find slow-growing (less lethal) cancers. Healthy screener bias makes screened populations look healthier. Overdiagnosis turns healthy people into patients. DEMAND RCT mortality evidence before accepting screening claims."
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ PROGRESS CHECK: You've learned to pool observational evidence carefully. You understand that meta-analysis can magnify bias as easily as signal. You can identify lead time bias in screening studies. You know when to trust pooled estimates and when to be skeptical. Next: pharmacovigilance ‚Äî detecting drug safety signals."
        }
      }
    ]
  },
  // MODULE 9: THE PHARMACOVIGILANCE (Signal Detection)
  {
    id: 9,
    title: "The Pharmacovigilance",
    subtitle: "Signal Detection",
    principle: 2,
    estimatedTime: "25 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Time flows one direction"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "THE SIGNAL IGNORED: VIOXX ‚Äî WHEN 88,000 HEARTS STOPPED",
          source: "NEJM 2005 | FDA | Merck internal documents | VIGOR, APPROVe trials",
          timeline: [
            { year: "1999", text: "Vioxx (rofecoxib) approved. COX-2 inhibitor for arthritis. Marketed as 'safer on stomach' than older NSAIDs. Billions in sales projected.", type: "normal" },
            { year: "2000", text: "VIGOR trial: 4x higher cardiovascular events vs naproxen. Merck interprets as 'naproxen is cardioprotective,' not 'Vioxx is cardiotoxic.' FDA concerned.", type: "crisis" },
            { year: "2001-04", text: "Observational studies show signal: cardiovascular events in Vioxx users. David Graham (FDA) estimates 88,000-140,000 excess cardiac events. Internal Merck data shows risk.", type: "crisis" },
            { year: "2004", text: "APPROVe trial (colon polyps): Stopped early for cardiovascular harm. RR 1.92 (95% CI 1.19-3.11). Merck withdraws Vioxx worldwide.", type: "revelation" },
            { year: "The Failure", text: "Les rapports spontan√©s, les signaux d'observation et m√™me les donn√©es internes ont √©t√© rejet√©s. La hi√©rarchie des preuves a √©t√© utilis√©e pour IGNORER les signes avant-coureurs jusqu'√† ce que les ECR confirment les dommages.", type: "revelation" },
            { year: "Lesson", text: "Les preuves observationnelles des DANGERS ne devraient pas exiger le m√™me seuil que les preuves des B√âN√âFICES. Les signaux comptent. 88 000 d√©c√®s, c'est le co√ªt de l'attente de preuves ¬´ parfaites ¬ª.", type: "revelation" }
          ],
          realData: {
            endpoint: "Myocardial infarction / sudden cardiac death",
            drug: "Rofecoxib (Vioxx)",
            placebo: "Naproxen / placebo",
            rr: "RR 1.92 (1.19-3.11) in APPROVe",
            ci: "Signal present for 4 years before withdrawal",
            nnh: "88,000-140,000 excess cardiac events estimated"
          },
          hook: "THE HOOK: Pharmacovigilance failed because signals were dismissed as 'only observational.' The evidence hierarchy that protects against false positives for benefits should not be used to dismiss warnings of harm. When lives are at stake, false negatives kill."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY INSIGHT: For HARMS, the evidence threshold should be LOWER than for benefits. Why? False positive (thinking something harmful is safe) has worse consequences than false negative (thinking something safe is harmful). Observational signals for harm deserve urgent attention, not dismissal."
        }
      },
      {
        type: 'content',
        content: {
          title: "Pharmacovigilance: The Science of Safety Signals",
          sections: [
            {
              heading: "Why Observational Data Is Essential for Safety:",
              items: [
                "Les ECR sont ALIMENT√âS pour les b√©n√©fices, et non pour les dommages rares",
                "100-patient RCT: can detect 3% event rate, NOT 0.1% rate",
                "Rare harms need millions of patient-years of exposure",
                "Post-marketing surveillance is the only way to detect them",
                "Thalidomide, Vioxx, DES ‚Äî all detected observationally"
              ]
            },
            {
              heading: "Signal Detection Methods:",
              items: [
                "Spontaneous reporting (FAERS, Yellow Card) ‚Äî passive surveillance",
                "Disproportionality analysis ‚Äî observed vs expected reports",
                "Case series ‚Äî temporal clustering of events",
                "Cohort studies ‚Äî active surveillance in databases",
                "Self-controlled designs ‚Äî within-person comparisons"
              ]
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: √âVALUATION DES SIGNAUX DE S√âCURIT√â",
          title: "Du signal √† l'action",
          sections: [
            {
              heading: "Signal Detection (Is there something there?):",
              text: "‚Ä¢ Spontaneous reports: PRR, ROR, IC (information component)\n‚Ä¢ Database studies: compare exposed vs unexposed rates\n‚Ä¢ Case series: temporal pattern, dose-response\n‚Ä¢ Biological plausibility: is there a mechanism?"
            },
            {
              heading: "Signal Validation (Is it real?):",
              text: "‚Ä¢ Le signal peut-il √™tre r√©pliqu√© dans une autre base de donn√©es ? ‚Ä¢ Y a-t-il une confusion par indication ? ‚Ä¢ Y a-t-il un biais de d√©tection/notori√©t√© ? ‚Ä¢ Les m√©thodes ind√©pendantes donnent-elles des r√©sultats coh√©rents¬†?"
            },
            {
              heading: "Signal Assessment (Is it clinically important?):",
              text: "‚Ä¢ Absolute risk: how many excess events per 1,000 users?\n‚Ä¢ Comparison to alternatives: are other drugs safer?\n‚Ä¢ Severity: death/disability vs transient symptoms?\n‚Ä¢ Population at risk: vulnerable subgroups?"
            },
            {
              heading: "Action:",
              text: "‚Ä¢ Communicate risk (label changes, dear doctor letters)\n‚Ä¢ Restrict use (contraindications, REMS)\n‚Ä¢ Withdraw (if risk outweighs all benefit)\n‚Ä¢ Request confirmatory studies (if uncertainty remains)"
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Self-Controlled Designs: Eliminating Between-Person Confounding",
          sections: [
            {
              heading: "The Idea:",
              items: [
                "Use each person as their own control",
                "Compare risk during 'exposed' periods to 'unexposed' periods",
                "All time-invariant confounders automatically controlled",
                "No healthy user bias from comparing different people"
              ]
            },
            {
              heading: "Case-Crossover Design:",
              items: [
                "Commencer par les cas (personnes ayant eu l'√©v√©nement)",
                "Compare their exposure in the hazard period (just before event)",
                "To their exposure in control periods (earlier times)",
                "If exposure is higher in hazard periods ‚Üí association"
              ]
            },
            {
              heading: "Self-Controlled Case Series (SCCS):",
              items: [
                "Uses only people who had BOTH exposure and outcome",
                "Compares rate during exposed periods to unexposed periods",
                "Requires that exposure doesn't affect future outcome probability",
                "Largement utilis√© pour la s√©curit√© des vaccins (l'autisme ROR d√©mystifi√© de cette fa√ßon)"
              ]
            },
            {
              heading: "Limitations:",
              items: [
                "Can't control for TIME-VARYING confounders",
                "Assumes event doesn't change future exposure probability",
                "Needs intermittent exposure (not continuous use)",
                "Can be affected by exposure trends over time"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'signal-assessment',
          title: "√âvaluer ce signal de s√©curit√©",
          situation: "Un nouvel antid√©presseur a √©t√© sur le march√© depuis 2 ans. Des rapports spontan√©s au FAERS sugg√®rent une association possible avec une mort cardiaque subite. Le taux de d√©claration est 3 fois plus √©lev√© que pour les autres antid√©presseurs. Le m√©dicament n'a pas d'allongement de l'intervalle QT connu dans les essais. 500 000 patients l'ont utilis√©.",
          nodes: {
            start: {
              question: "First step: Is this signal reliable?",
              branches: [
                { text: "No ‚Äî spontaneous reports are unreliable, need RCT confirmation", nextNode: "dismiss_wrong" },
                { text: "Peut-√™tre ‚Äî v√©rifier les biais de d√©claration et les confusions par indication", nextNode: "check_bias_correct" },
                { text: "Yes ‚Äî 3x higher is definitely a signal, withdraw the drug", nextNode: "overreact_wrong" }
              ]
            },
            check_bias_correct: {
              situation: "Good. You investigate. The drug is preferentially prescribed to older, sicker patients (confounding by indication). But the disproportionality persists after adjusting for age and comorbidity in database studies. Rate ratio: 2.1 (95% CI 1.4-3.2) vs comparator antidepressants.",
              question: "Next step:",
              branches: [
                { text: "Validate in an independent database using different methods", nextNode: "validate_correct" },
                { text: "Issue immediate drug withdrawal ‚Äî 2.1 RR is alarming", nextNode: "withdraw_early" },
                { text: "Ignorer ‚Äî les √©tudes de bases de donn√©es sont observationnelles, attendre les ECR", nextNode: "dismiss_again_wrong" }
              ]
            },
            dismiss_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Dangerous dismissal!",
              text: "Les rapports spontan√©s PEUVENT √™tre peu fiables, mais ils sont en premi√®re ligne de la surveillance de la s√©curit√©. Un taux de signalement 3 fois plus √©lev√© justifie une enqu√™te et non un licenciement. Le signal cardiaque du Vioxx figurait dans les rapports spontan√©s pendant des ann√©es avant que des mesures ne soient prises.",
              lesson: "Les signaux justifient une enqu√™te. ¬´ Peu fiable ¬ª ne signifie pas ¬´ ignorer ¬ª. Cela signifie ¬´ approfondir les recherches avec de meilleures m√©thodes ¬ª."
            },
            overreact_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Premature action!",
              text: "Spontaneous reporting has many biases: notoriety bias (more reports after media coverage), channeling (drug given to sicker patients), stimulated reporting. A 3x disproportionality needs confirmation before withdrawing a drug that may help millions.",
              lesson: "Les signaux doivent √™tre valid√©s avant une action drastique. Mais la validation devrait √™tre RAPIDE ‚Äî et non les 4 ans qu'il a fallu pour le Vioxx."
            },
            validate_correct: {
              situation: "Vous r√©pliquez dans une deuxi√®me base de donn√©es et trouvez des r√©sultats similaires¬†: RR 1,9 (1,3-2,8). Une s√©rie de cas auto-contr√¥l√©s montre √©galement un risque √©lev√© pendant les p√©riodes d'exposition¬†: IRR 2,5 (1,6-3,9). Et maintenant¬†?",
              question: "Decision time:",
              branches: [
                { text: "Preuves solides¬†: communiquer le risque et envisager des restrictions", nextNode: "action_correct" },
                { text: "Still observational ‚Äî request an RCT before acting", nextNode: "request_rct_wrong" }
              ]
            },
            withdraw_early: {
              type: 'outcome',
              outcome: 'partial',
              title: "Maybe appropriate, but validate first",
              text: "Un rapport de taux de 2,1 pour la mort subite d'origine cardiaque est grave. Mais la r√©plication de donn√©es ind√©pendantes renforcerait la confiance. Si le signal est r√©el, une action est n√©cessaire. Mais s'il s'agit d'un artefact, le sevrage nuit aux patients qui b√©n√©ficient du m√©dicament.",
              lesson: "En cas de pr√©judices graves, privil√©giez l'action. Mais une validation rapide (quelques jours, voire semaines, et non ann√©es) peut √©viter √† la fois des retraits inutiles et des actions retard√©es."
            },
            dismiss_again_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "C'est l'√©chec du Vioxx¬†!",
              text: "Attendre les preuves ECR d'un pr√©judice est une erreur. Les ECR portant sur des pr√©judices rares n√©cessiteraient des √©chantillons d‚Äôune taille √©norme. Les √©tudes de bases de donn√©es avec des r√©sultats coh√©rents entre les m√©thodes (cohorte, SCCS) et les populations fournissent des preuves solides. ¬´¬†Observatoire¬†¬ª ne signifie pas ¬´¬†ignorer¬†¬ª.",
              lesson: "En ce qui concerne les pr√©judices, plusieurs √©tudes observationnelles coh√©rentes fournissent souvent des preuves plus solides que l'attente d'un ECR (souvent impossible). Agir sur la base des meilleures preuves disponibles."
            },
            request_rct_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "An RCT for sudden cardiac death?",
              text: "Pour d√©tecter un doublement des morts cardiaques subites (taux de base ~ 0,1 %), il faudrait que plus de 50¬†000 patients soient suivis pendant des ann√©es. Ce n‚Äôest pas pratique. D‚Äôici la fin d‚Äôun ECR, des milliers d‚Äôautres pourraient mourir. Les preuves observationnelles sont les MEILLEURES preuves que nous aurons jamais pour des dommages rares et graves.",
              lesson: "La m√©decine fond√©e sur des preuves n'est pas un ¬´ ECR ou rien ¬ª. Il s'agit de ¬´¬†utiliser les meilleures preuves disponibles¬†¬ª. Pour les dommages rares, cela signifie des √©tudes observationnelles bien men√©es."
            },
            action_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Appropriate response!",
              text: "With replicated observational evidence using multiple methods, action is warranted. Options: label warnings, contraindications for high-risk patients, REMS program, or (if alternatives exist and harm is severe) withdrawal. The exact action depends on benefit-harm balance.",
              lesson: "Signal ‚Üí Validation ‚Üí √âvaluation ‚Üí Action. La catastrophe du Vioxx s'est produite parce que l'action a √©t√© retard√©e. De multiples signaux d'observation coh√©rents EXIGENT une r√©ponse."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Pourquoi le seuil de preuve pour les DANGERS des m√©dicaments est-il g√©n√©ralement inf√©rieur √† celui pour les B√âN√âFICES des m√©dicaments¬†?",
          options: [
            { id: 'a', text: "Harms are easier to measure than benefits", correct: false },
            { id: 'b', text: "Le co√ªt d'un faux n√©gatif (pr√©judice manquant) d√©passe le co√ªt d'un faux positif (b√©n√©fice manquant)", correct: true },
            { id: 'c', text: "Les √©tudes d'observation sont plus fiables pour les pr√©judices que pour les b√©n√©fices", correct: false },
            { id: 'd', text: "RCTs cannot detect harms, only benefits", correct: false }
          ],
          explanation: "Pour les b√©n√©fices, un faux positif (approuvant un traitement inefficace) gaspille des ressources. Pour les pr√©judices, un faux n√©gatif (manquant un effet nocif) tue des personnes. L‚Äôasym√©trie des cons√©quences justifie des seuils de preuve asym√©triques. Nous devrions avoir besoin de MOINS de certitude pour soup√ßonner un pr√©judice que pour croire un b√©n√©fice."
        }
      }
    ]
  },
  // MODULE 10: THE INTEGRATION (When to Trust Observational Evidence)
  {
    id: 10,
    title: "The Integration",
    subtitle: "When to Trust",
    principle: 6,
    estimatedTime: "35 min",
    slides: [
      {
        type: 'principle-display',
        content: {
          principle: "Replication builds confidence"
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LA CONVERGENCE¬†: LE TABAGISME ET LE CANCER DU POUMON ‚Äî LORSQUE L'OBSERVATION √âTAIT ASSEZ",
          source: "Doll & Hill 1950-2004 | Bradford Hill Criteria | Never randomized",
          timeline: [
            { year: "1950", text: "Doll & Hill case-control study: smokers 9x more likely to have lung cancer. Tobacco industry demands RCT proof. (Unethical to randomize smoking)", type: "normal" },
            { year: "1954", text: "British Doctors cohort begins. Prospective design addresses reverse causation. Shows dose-response: more cigarettes ‚Üí more cancer.", type: "normal" },
            { year: "1964", text: "US Surgeon General declares smoking causes lung cancer. Based entirely on observational evidence. No RCT ever conducted.", type: "revelation" },
            { year: "2004", text: "50-year follow-up: smokers lose 10 years of life expectancy. Quitting at any age helps. Observational evidence now indisputable.", type: "revelation" },
            { year: "How We Knew", text: "Strength (RR = 10-30), consistency (every study), temporality (smoking preceded cancer), dose-response, biological plausibility, coherence, specificity, analogy, experiment (cessation reduces risk).", type: "revelation" },
            { year: "Lesson", text: "Les crit√®res de Bradford Hill ont permis de d√©duire une causalit√© √† partir de donn√©es d'observation lorsque les ECR √©taient impossibles. Des associations fortes, coh√©rentes et biologiquement plausibles PEUVENT √©tablir un lien de causalit√© sans randomisation.", type: "revelation" }
          ],
          realData: {
            endpoint: "Lung cancer mortality",
            drug: "Heavy smoking (20+ cigarettes/day)",
            placebo: "Never smokers",
            rr: "RR 10-30 (study dependent)",
            ci: "Unmistakable association",
            nnh: "Millions of deaths attributable to smoking"
          },
          hook: "LE CROCHET¬†: Nous n'avons jamais randomis√© le tabagisme. Pourtant, personne ne doute que fumer provoque le cancer du poumon. Comment les preuves observationnelles ont-elles √† elles seules convaincu le monde ? Les crit√®res de Bradford¬†Hill¬†‚Äì un cadre d'inf√©rence causale lorsque les ECR sont impossibles ou contraires √† l'√©thique."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚è∏Ô∏è KEY INSIGHT: Observational evidence CAN establish causation when: (1) associations are STRONG, (2) results REPLICATE across studies/populations/methods, (3) temporality is clear, (4) dose-response exists, (5) biological mechanism is plausible, (6) findings are COHERENT with existing knowledge. No single criterion is required; it's the totality of evidence."
        }
      },
      {
        type: 'content',
        content: {
          title: "The Bradford Hill Criteria (Updated)",
          sections: [
            {
              heading: "1. Strength of Association:",
              text: "Larger effect sizes are less likely to be entirely due to confounding. RR = 10 is hard to explain by bias alone; RR = 1.2 might be entirely confounded."
            },
            {
              heading: "2. Consistency:",
              text: "Same finding across different populations, settings, methods, times. If it replicates everywhere, less likely to be artifact."
            },
            {
              heading: "3. Specificity:",
              text: "L'exposition m√®ne √† un r√©sultat sp√©cifique (pas tout). Mais les maladies multicausales violent cette r√®gle : le tabagisme provoque de nombreuses maladies. Crit√®re le moins important."
            },
            {
              heading: "4. Temporality:",
              text: "Cause MUST precede effect. This is essential. Cohort studies establish temporality; cross-sectional cannot."
            },
            {
              heading: "5. Biological Gradient (Dose-Response):",
              text: "More exposure ‚Üí more outcome. Supports causation. But non-linear relationships can be causal too."
            },
            {
              heading: "6. Plausibility:",
              text: "Il existe un m√©canisme biologique qui pourrait expliquer la relation. Mais le m√©canisme n'est pas toujours connu pour les v√©ritables causes."
            },
            {
              heading: "7. Coherence:",
              text: "Association doesn't conflict with known biology, natural history, epidemiology. Should 'fit' existing knowledge."
            },
            {
              heading: "8. Experiment:",
              text: "La suppression de l'exposition r√©duit le r√©sultat (√©tudes de cessation). Ou bien des exp√©riences naturelles montrent des effets."
            },
            {
              heading: "9. Analogy:",
              text: "Similar exposures cause similar outcomes. If A causes X, then similar B might cause similar Y."
            }
          ]
        }
      },
      {
        type: 'method',
        content: {
          label: "LA M√âTHODE¬†: TRIANGULATION",
          title: "Modern Approach to Causal Inference",
          sections: [
            {
              heading: "What Is Triangulation?",
              text: "Utiliser plusieurs mod√®les d'√©tude, chacun avec DIFF√âRENTES sources de biais, pour voir s'ils convergent vers la m√™me r√©ponse. Si les biais diff√®rent mais que les r√©sultats concordent, il s'agit plus probablement d'un lien causal."
            },
            {
              heading: "Example: Alcohol and Heart Disease",
              text: "‚Ä¢ Cohort studies: moderate drinking appears protective (confounded by healthy user?)\n‚Ä¢ Mendelian randomization: genetic variants for alcohol metabolism show NO protection\n‚Ä¢ Sibling comparisons: within-family, no protective effect\n\nTriangulation: cohort studies were confounded. Observational 'benefit' is not causal."
            },
            {
              heading: "Key Insight:",
              text: "Different methods have different biases:\n‚Ä¢ Cohort studies: confounding, selection\n‚Ä¢ Case-control: recall bias\n‚Ä¢ Mendelian randomization: pleiotropy, weak instruments\n‚Ä¢ Within-family: shared family environment\n\nIf ALL methods agree despite DIFFERENT biases, confidence in causality increases."
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Quand faire confiance aux preuves observationnelles",
          sections: [
            {
              heading: "HIGH Confidence When:",
              items: [
                "Large effect size (RR > 2-3) ‚Äî hard to explain by bias alone",
                "Coh√©rents entre plusieurs m√©thodes avec des biais diff√©rents",
                "Clear temporality (prospective cohort, not cross-sectional)",
                "Dose-response present",
                "Biologically plausible mechanism known",
                "Low risk of bias by ROBINS-I criteria",
                "Mendelian randomization agrees with observational"
              ]
            },
            {
              heading: "LOW Confidence When:",
              items: [
                "Small effect size (RR 1.0-1.5) ‚Äî easily confounded",
                "Les r√©sultats varient selon la m√©thode (cohorte vs cas-t√©moins en d√©saccord)",
                "Cross-sectional design (reverse causation possible)",
                "No dose-response or paradoxical patterns",
                "Mechanism unknown or contradicts biology",
                "High risk of bias across studies",
                "Mendelian randomization contradicts observational"
              ]
            },
            {
              heading: "The 'Smoking Test':",
              text: "Pourrait une confusion non mesur√©e est-elle aussi forte que le tabagisme ‚Üí cancer du poumon (RR 10-30)¬†? Si votre effet est RR 1,3, un facteur de confusion avec RR 2 sur l'exposition et le r√©sultat pourrait l'expliquer pleinement. Si votre effet est RR¬†10, il est beaucoup plus difficile √† expliquer."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'trust-decision',
          title: "Devriez-vous faire confiance √† ce r√©sultat d'observation¬†?",
          situation: "You've read that red meat consumption is associated with colorectal cancer. Cohort studies show RR ~1.2 (1.1-1.4) for high vs low consumption. This is consistent across multiple cohorts. Biological plausibility exists (heme iron, heterocyclic amines). No RCT is possible (can't randomize diet for decades).",
          nodes: {
            start: {
              question: "First consideration: What do you think of RR = 1.2?",
              branches: [
                { text: "Moderate effect ‚Äî warrants public health attention", nextNode: "moderate_wrong" },
                { text: "Small effect ‚Äî could easily be explained by confounding", nextNode: "small_correct" },
                { text: "Negligible ‚Äî ignore it", nextNode: "ignore_wrong" }
              ]
            },
            small_correct: {
              situation: "Correct. Le RR 1.2 est petit et pourrait √™tre confondu. Mais c‚Äôest COH√âRENT entre les cohortes. Est-ce que cela change les choses¬†?",
              question: "Consistency across cohorts means:",
              branches: [
                { text: "It's probably causal ‚Äî too consistent to be chance", nextNode: "consistent_overinterpret" },
                { text: "Les √©tudes peuvent partager le m√™me biais (utilisateur sain, confusion r√©siduelle)", nextNode: "shared_bias_correct" }
              ]
            },
            moderate_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Be more skeptical",
              text: "RR 1,2 est un PETIT effet en √©pid√©miologie. √Ä titre de comparaison, le tabagisme et le cancer du poumon repr√©sentent un RR de 10 √† 30. Une taille d‚Äôeffet de 1,2 se situe dans la plage qu‚Äôune confusion non mesur√©e pourrait facilement produire. Ce n'est pas ¬´ mod√©r√© ¬ª, c'est ¬´ incertain ¬ª.",
              lesson: "In observational epidemiology, be skeptical of RR < 2. Such effects could be entirely confounded."
            },
            ignore_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Don't dismiss entirely",
              text: "RR 1.2 at a population level still matters. If millions eat high red meat, even small excess risks produce substantial burden. The effect may be real but confounded; it's worth investigating with different methods.",
              lesson: "Small effects can have large public health impact. Don't dismiss, but be appropriately uncertain."
            },
            consistent_overinterpret: {
              type: 'outcome',
              outcome: 'partial',
              title: "Attention √† la coh√©rence¬†!",
              text: "Consistency is reassuring, but cohort studies share SIMILAR biases: all have healthy user effects, similar measurement error, similar confounding structures. Consistency within one method doesn't rule out systematic bias in that method.",
              lesson: "La coh√©rence entre les M√âTHODES (cohorte, cas-t√©moins, randomisation mend√©lienne) est plus rassurante que la coh√©rence au sein d'une seule m√©thode."
            },
            shared_bias_correct: {
              situation: "Bien. Et si des √©tudes de randomisation mend√©lienne (RM) √©taient r√©alis√©es, utilisant des variantes g√©n√©tiques qui affectent la consommation de viande rouge ? Supposons que l'IRM ne montre AUCUNE association avec le cancer colorectal.",
              question: "Que concluez-vous¬†?",
              branches: [
                { text: "L'IRM est d√©finitive - les √©tudes de cohorte ont √©t√© confondues", nextNode: "mr_definitive_partial" },
                { text: "Triangulation: discordant results suggest confounding, but MR has limitations too", nextNode: "triangulation_correct" }
              ]
            },
            mr_definitive_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "MR isn't perfect either",
              text: "Mendelian randomization has limitations: genetic variants may affect multiple pathways (pleiotropy), instruments may be weak, genetic effects operate lifelong (not same as adult dietary change). Discordant MR suggests confounding in cohorts, but doesn't definitively prove null effect.",
              lesson: "Aucune m√©thode unique n'est d√©finitive. La triangulation signifie √©valuer les preuves provenant de plusieurs approches, chacune avec des limites diff√©rentes."
            },
            triangulation_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Excellent triangulation!",
              text: "You've correctly identified: (1) small effect size ‚Üí possibly confounded; (2) consistency within method doesn't rule out shared bias; (3) discordant MR suggests confounding but isn't definitive. The appropriate conclusion is: 'Uncertain ‚Äî possible small effect, possibly confounded.'",
              lesson: "This is the current scientific consensus on red meat and colorectal cancer: probably some effect, but magnitude uncertain due to potential confounding. Public health messaging should reflect this uncertainty."
            }
          }
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Quel sc√©nario fournit les preuves observationnelles les plus FORTES pour √©tablir un lien de causalit√©¬†?",
          options: [
            { id: 'a', text: "20 √©tudes de cohorte montrant un RR 1,3, toutes avec des structures de confusion similaires", correct: false },
            { id: 'b', text: "5 √©tudes utilisant diff√©rentes m√©thodes (cohorte, cas-t√©moins, MR, fr√®res et s≈ìurs) tous montrant un RR ~ 3", correct: true },
            { id: 'c', text: "1 grande √©tude de cohorte avec 1 million de participants montrant un RR 1,5", correct: false },
            { id: 'd', text: "A meta-analysis of 50 studies showing pooled RR 1.2 with I¬≤ = 0%", correct: false }
          ],
          explanation: "Triangulation across different methods with different biases provides the strongest evidence. If cohort studies (confounding), case-control (recall bias), MR (pleiotropy), and sibling comparisons (genetic confounding) all converge on RR ~3, each method's biases are unlikely to produce the same false answer. Large N or many studies with the SAME bias doesn't help."
        }
      },
      {
        type: 'content',
        content: {
          title: "Mendelian Randomization: Nature's RCT",
          sections: [
            {
              heading: "The Brilliant Idea:",
              items: [
                "Genetic variants are assigned at conception (before any confounders)",
                "Like random assignment in an RCT",
                "Find a gene that affects exposure (e.g., alcohol metabolism)",
                "Compare outcomes in people with different gene variants",
                "Since genes are 'randomized,' confounding is eliminated"
              ]
            },
            {
              heading: "Example: Alcohol and Heart Disease",
              items: [
                "Observational: moderate drinkers have lower CVD than non-drinkers",
                "Confounding? Moderate drinkers may be healthier overall",
                "MR approach: Use ALDH2 gene (affects alcohol metabolism)",
                "People with 'slow metabolizer' variant drink less",
                "MR result: NO cardioprotection from moderate drinking",
                "L'association observationnelle √©tait CONFOND√âE"
              ]
            },
            {
              heading: "Limitations (IMPORTANT):",
              items: [
                "PLEIOTROPY: Gene may affect outcome through other pathways",
                "WEAK INSTRUMENTS: Gene may explain tiny fraction of exposure",
                "POPULATION STRATIFICATION: Ancestry can confound",
                "DEVELOPMENTAL EFFECTS: Lifelong genetic effect ‚â† adult intervention",
                "La RM est puissante mais pas infaillible - utilis√©e pour la triangulation"
              ]
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'mr-interpretation',
          title: "Interpr√©ter cette √©tude MR",
          situation: "Observational studies consistently show that higher vitamin D levels are associated with lower risk of multiple sclerosis (MS). RR = 0.60 (0.50-0.70) per 50 nmol/L higher vitamin D. An MR study uses genetic variants affecting vitamin D synthesis.",
          nodes: {
            start: {
              question: "L'√©tude MR r√©v√®le¬†:¬†une pr√©disposition g√©n√©tique √† une teneur plus √©lev√©e en vitamine D est associ√©e √† un risque plus faible de SEP (OR 0,70 par 50 nmol/L g√©n√©tiquement pr√©dit). Qu'est-ce que cela sugg√®re¬†?",
              branches: [
                { text: "Vitamin D supplementation will prevent MS", nextNode: "supplement_wrong" },
                { text: "L'association observationnelle peut √™tre causale, pas seulement confondue", nextNode: "causal_correct" },
                { text: "Nous devrions rejeter les √©tudes observationnelles", nextNode: "dismiss_wrong" }
              ]
            },
            supplement_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Too far!",
              text: "MR supports causality of vitamin D LEVELS, but: (1) Lifelong genetically-determined levels ‚â† adult supplementation; (2) The genetic effect operates from birth; (3) There may be critical windows in childhood. MR suggests vitamin D matters but doesn't prove SUPPLEMENTATION works.",
              lesson: "MR teste l'effet causal de l'EXPOSITION. Cela ne vous dit pas si une INTERVENTION fonctionnera, surtout si le moment/la dose/la forme diff√®rent."
            },
            causal_correct: {
              situation: "Interpr√©tation correcte¬†! Le MR soutient la causalit√©. Mais avant d'√™tre confiant, que devez-vous v√©rifier¬†?",
              question: "What's the key assumption to verify?",
              branches: [
                { text: "Sample size is adequate", nextNode: "sample_wrong" },
                { text: "The genetic variants don't affect MS through other pathways (pleiotropy)", nextNode: "pleiotropy_correct" }
              ]
            },
            dismiss_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Don't dismiss ‚Äî triangulate!",
              text: "MR SUPPORTING observational findings is good news! When methods with different biases agree (observational: confounding; MR: pleiotropy), confidence increases. Consistency between methods is the goal of triangulation.",
              lesson: "L'accord entre les √©tudes observationnelles et IRM RENFORCE les arguments en faveur de la causalit√©. Ils ont des biais diff√©rents, donc si les deux sont d'accord, la confusion dans les √©tudes observationnelles est moins probable."
            },
            sample_wrong: {
              type: 'outcome',
              outcome: 'partial',
              title: "Vrai, mais pas l'hypoth√®se cl√©",
              text: "La taille ad√©quate de l'√©chantillon est importante pour la pr√©cision, mais l'hypoth√®se FONDAMENTALE de la RM est que les variantes g√©n√©tiques n'affectent le r√©sultat que PAR l'exposition. Si les g√®nes de la vitamine D affectent √©galement directement la fonction immunitaire (pl√©iotropie), la RM est biais√©e.",
              lesson: "MR validity depends on: (1) Genes affect exposure, (2) Genes don't affect outcome except through exposure, (3) Genes aren't confounded (usually satisfied). Violation of #2 (pleiotropy) is the main threat."
            },
            pleiotropy_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Exactly right!",
              text: "La pl√©iotropie est le talon d'Achille de la MR. Si les g√®nes de la vitamine D affectent √©galement la fonction immunitaire, le comportement d‚Äôexposition au soleil ou d‚Äôautres voies menant √† la SEP, l‚Äôestimation de la RM est biais√©e. Des m√©thodes existent pour tester/ajuster la pl√©iotropie (MR-Egger, m√©diane pond√©r√©e), mais cela reste une pr√©occupation.",
              lesson: "When reading MR studies, always ask: 'Could these genes affect the outcome through OTHER pathways?' If yes, interpret cautiously. Use multiple genetic variants and sensitivity analyses."
            }
          }
        }
      },
      {
        type: 'story-deep',
        content: {
          label: "LE PI√àGE DU SOUS-GROUPE¬†: ACCORD¬†‚Äì QUAND LA MOYENNE CACHAIT LE DANGER",
          source: "NEJM 2008; ACCORD Study Group | Intensive glycemic control | Effect modification",
          timeline: [
            { year: "Hypothesis", text: "Lower blood sugar should prevent diabetic complications. Target HbA1c <6% (intensive) vs <7.5% (standard). Makes biological sense.", type: "normal" },
            { year: "2008", text: "ACCORD s'est arr√™t√© pr√©matur√©ment pour HARM. Le contr√¥le intensif a augment√© la MORTALIT√â : HR 1,22 (1,01-1,46). 257 d√©c√®s contre 203. Le contraire de ce qui √©tait attendu.", type: "crisis" },
            { year: "But Wait", text: "ADVANCE trial (similar design): NO mortality increase. VADT trial: NO mortality increase. Same intervention, different results. Why?", type: "crisis" },
            { year: "Subgroup Analysis", text: "Dans ACCORD, les patients AYANT des ant√©c√©dents de maladie cardiovasculaire pr√©sentaient une mortalit√© PLUS √âLEV√âE avec un contr√¥le intensif. Les patients SANS MCV avaient une mortalit√© INF√âRIEURE. La MOYENNE a masqu√© les effets oppos√©s.", type: "revelation" },
            { year: "The Lesson", text: "Modification de l'effet¬†: l'intervention aide certains et nuit √† d'autres. La moyenne entre les sous-groupes donne un effet trompeur ¬´ nul ¬ª ou faible. La m√©decine personnalis√©e n√©cessite de comprendre les avantages pour l'OMS et les dommages √† l'OMS.", type: "revelation" },
            { year: "Clinical Impact", text: "Les lignes directrices recommandent d√©sormais CONTRE les cibles de glucose agressives chez les patients √¢g√©s atteints de maladies cardiovasculaires. Mais POUR un contr√¥le intensif chez les diab√©tiques plus jeunes et en meilleure sant√©. Une r√©ponse unique ne convient pas √† tout le monde.", type: "revelation" }
          ],
          realData: {
            endpoint: "All-cause mortality",
            drug: "Intensive glycemic control (HbA1c <6%)",
            placebo: "Standard control (HbA1c <7.5%)",
            rr: "Overall: HR 1.22 (1.01-1.46) | By CVD: OPPOSITE directions",
            ci: "Heterogeneity of treatment effect",
            nnh: "One-size-fits-all kills"
          },
          hook: "LE CROCHET¬†: ACCORD montre pourquoi les ¬´¬†effets moyens du traitement¬†¬ª peuvent √™tre dangereux. La moyenne pour tous les patients √©tait faible. Mais cette MOYENNE cachait le fait qu‚Äôun contr√¥le intensif aidait les uns et en tuait d‚Äôautres. Les √©tudes observationnelles peuvent explorer les modifications d'effet que les ECR n√©gligent."
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'effect-modification',
          title: "Cet effet est-il modifi√© ou confondant¬†?",
          situation: "In your observational study, you find that a statin reduces cardiovascular events overall (HR 0.80). But when you stratify by age: <65 years HR 0.60; ‚â•65 years HR 0.95.",
          nodes: {
            start: {
              question: "What is happening here?",
              branches: [
                { text: "Confounding by age ‚Äî need to adjust", nextNode: "confounding_wrong" },
                { text: "Effect modification ‚Äî statin works better in younger patients", nextNode: "modification_correct" },
                { text: "Statistical artifact ‚Äî subgroups are underpowered", nextNode: "artifact_partial" }
              ]
            },
            confounding_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Ceci n'est PAS confondant¬†!",
              text: "Cet √©l√©ment confondant signifie que l'√¢ge fausse la relation exposition-r√©sultat (les patients plus √¢g√©s sont plus susceptibles de recevoir des statines ET de souffrir de maladies cardiovasculaires). La modification de l'effet signifie que l'EFFET DES STATINES DIFF√àRE selon l'√¢ge. Ceux-ci sont fondamentalement diff√©rents. Vous avez d√©j√† stratifi√© par √¢ge¬†: cela MONTRE les diff√©rents effets.",
              lesson: "Confondant¬†: le facteur de confusion cr√©e une association fallacieuse. Modification de l'effet : l'effet est v√©ritablement DIFF√âRENT selon les sous-groupes. La stratification r√©v√®le une modification de l'effet."
            },
            modification_correct: {
              situation: "Correct¬†! L‚Äôeffet diff√®re v√©ritablement selon l‚Äô√¢ge. Maintenant¬†: devriez-vous d√©clarer le HR global de 0,80 ou les r√©sultats stratifi√©s¬†?",
              question: "Best reporting:",
              branches: [
                { text: "Rapportez uniquement le HR global de 0,80 ‚Äî les r√©sultats stratifi√©s g√©n√®rent des hypoth√®ses", nextNode: "overall_wrong" },
                { text: "D√©clarez les deux, en soulignant que l'effet diff√®re selon l'√¢ge et les implications cliniques", nextNode: "both_correct" }
              ]
            },
            artifact_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Worth checking, but pattern suggests real modification",
              text: "V√©rifiez toujours si les diff√©rences entre les sous-groupes pourraient √™tre le fruit du hasard. Mais HR 0,60 contre HR 0,95 repr√©sente une grande diff√©rence. Test d'interaction (p pour interaction). Si elle est significative, la modification de l‚Äôeffet est probablement r√©elle. M√™me si elle n'est pas significative, la diff√©rence clinique peut avoir de l'importance.",
              lesson: "Test for statistical interaction. But don't dismiss clinically important differences just because p>0.05 ‚Äî subgroup analyses are often underpowered."
            },
            overall_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "C'est l'erreur ACCORD¬†!",
              text: "Ne signaler que l‚Äôeffet global cache le fait que les statines fonctionnent TR√àS bien chez les patients plus jeunes et √† peine chez les patients plus √¢g√©s. Un patient de 65 ans d√©cidant d‚Äôopter pour des statines obtiendrait des informations trompeuses. La modification de l'effet a des IMPLICATIONS CLINIQUES.",
              lesson: "Lorsqu'une modification de l'effet existe, l'effet global peut √™tre TROMPEUR. Rapportez les r√©sultats stratifi√©s et discutez de qui en profite le plus et de qui pourrait ne pas en b√©n√©ficier."
            },
            both_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Transparent et cliniquement utile¬†!",
              text: "Reporting both allows clinicians to make better decisions. A 50-year-old might be more motivated to take statins (HR 0.60). An 80-year-old might reasonably decline (HR 0.95, with potential side effects). Personalized medicine requires understanding heterogeneity.",
              lesson: "La modification de l'effet est une INFORMATION, pas une nuisance. L'exploration et le rapport des effets des sous-groupes ‚Äî avec la prudence appropri√©e concernant les tests multiples ‚Äî am√©liorent les soins cliniques."
            }
          }
        }
      },
      {
        type: 'content',
        content: {
          title: "Beyond PS: Instrumental Variables & Natural Experiments",
          sections: [
            {
              heading: "When PS Methods Fail:",
              text: "Propensity scores require the 'no unmeasured confounding' assumption. When key confounders are unmeasured, we need different approaches: instrumental variables (IV) and natural experiments."
            },
            {
              heading: "Instrumental Variable Intuition:",
              items: [
                "Trouver quelque chose qui affecte le TRAITEMENT mais pas le R√âSULTAT (sauf par le traitement)",
                "Cet ¬´¬†instrument¬†¬ª imite la randomisation pour un sous-ensemble de patients",
                "Example: Distance to hospital affects treatment choice, not directly affecting outcome",
                "Les estimations IV sont valides m√™me avec des facteurs de confusion non mesur√©s ‚Äî si l'instrument est valide"
              ]
            },
            {
              heading: "Common Instruments in Healthcare:",
              items: [
                "Geographic variation (physician preference, facility availability)",
                "Calendar time (guideline changes, drug approvals)",
                "Mendelian randomization (genetic variants as instruments)",
                "Regression discontinuity (treatment thresholds based on arbitrary cutoffs)"
              ]
            },
            {
              heading: "Limitations:",
              items: [
                "Instruments often have weak correlation with treatment (low power)",
                "Exclusion restriction is untestable (must argue, can't prove)",
                "Estimates may be local (compliers only, not full population)",
                "Finding valid instruments is HARD ‚Äî most proposed instruments fail scrutiny"
              ]
            },
            {
              heading: "Key Takeaway:",
              text: "Les m√©thodes IV sont puissantes lorsqu'il existe des instruments valides. La randomisation mend√©lienne est IV avec des instruments g√©n√©tiques. Mais ces hypoth√®ses sont solides et souvent viol√©es. Utilisez IV comme triangulation, et non comme seule source de preuves."
            }
          ]
        }
      },
      {
        type: 'principle',
        content: {
          text: "üéØ MASTERY CHECKPOINT: You've now learned the complete toolkit for observational evidence: bias identification, DAGs, study designs, ROBINS-I, propensity scores (matching, IPTW, overlap weights), target trial emulation, instrumental variables, Mendelian randomization, negative controls, Bradford Hill criteria, and triangulation. You can IDENTIFY when observational evidence is trustworthy and when it's not. This is the core competency of evidence-based medicine."
        }
      },
      {
        type: 'principle',
        content: {
          text: "‚ö†Ô∏è THE WARNING: Average effects can hide opposite effects in subgroups. 'No overall effect' might mean 'helps some, harms others.' Effect modification is not a statistical nuisance ‚Äî it's clinical reality. When you find it, REPORT it. When you don't find it, you may have missed it."
        }
      }
    ]
  },
  // MODULE 11: THE CAPSTONE (Putting It All Together)
  {
    id: 11,
    title: "The Capstone",
    subtitle: "Putting It Together",
    principle: null,
    estimatedTime: "45 min",
    slides: [
      {
        type: 'title',
        content: {
          title: "The Capstone",
          subtitle: "Analyser une √©tude observationnelle",
          text: "Appliquez tout ce que vous avez appris pour √©valuer de mani√®re critique une v√©ritable √©tude observationnelle. Vous √©valuerez les biais, la conception et d√©ciderez si vous devez faire confiance aux conclusions."
        }
      },
      {
        type: 'content',
        content: {
          title: "Exercice de synth√®se¬†: √©valuer cette √©tude",
          sections: [
            {
              heading: "The Study:",
              text: "Une √©tude de cohorte affirme qu'un nouveau m√©dicament contre l'hypertension (m√©dicament X) r√©duit le risque d'accident vasculaire c√©r√©bral de 40¬†% par rapport aux m√©dicaments plus anciens (RR 0,60, IC √† 95¬†% 0,52-0,70). L'√©tude a utilis√© une base de donn√©es d'assurance maladie avec 50 000 patients suivis pendant 3 ans."
            },
            {
              heading: "Study Details:",
              items: [
                "Patients were classified as 'Drug X users' if they had ‚â•2 prescriptions",
                "Comparator was 'any other antihypertensive'",
                "Ajust√© en fonction de l'√¢ge, du sexe, du diab√®te et des maladies cardiovasculaires ant√©rieures",
                "Follow-up started from first Drug X prescription",
                "Le m√©dicament X √©tait plus r√©cent et plus cher, souvent utilis√© apr√®s l'√©chec d'autres m√©dicaments"
              ]
            },
            {
              heading: "Your Task:",
              text: "Utilisez les principes de ce cours pour √©valuer cette √©tude. Tenez compte des biais, des confusions, de la conception de l'√©tude et de la question de savoir si les r√©sultats doivent modifier la pratique clinique."
            }
          ]
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'capstone-assessment',
          title: "Capstone: Full Evaluation",
          situation: "Vous √©valuez l'√©tude Drug¬†X. Travaillez syst√©matiquement sur chaque biais.",
          nodes: {
            start: {
              question: "STEP 1 - IMMORTAL TIME: Patients needed ‚â•2 prescriptions to be 'Drug X users.' Time from first to second prescription is...",
              branches: [
                { text: "Correctly classified as unexposed ‚Äî no problem", nextNode: "immortal_wrong" },
                { text: "Likely immortal time ‚Äî must survive to get 2 prescriptions", nextNode: "immortal_correct" }
              ]
            },
            immortal_correct: {
              situation: "Correct¬†! Exiger 2 prescriptions cr√©e un temps immortel. Cela biaise en faveur du b√©n√©fice du m√©dicament X.",
              question: "√âTAPE 2 - CONFONDATION PAR INDICATION¬†: Le m√©dicament X a √©t√© ¬´ utilis√© apr√®s l'√©chec d'autres m√©dicaments ¬ª. Cela signifie que les utilisateurs du m√©dicament X sont...",
              branches: [
                { text: "Sicker patients with harder-to-control BP ‚Äî confounding AGAINST Drug X", nextNode: "indication_sicker_correct" },
                { text: "Healthier patients who can afford newer drugs ‚Äî confounding FOR Drug X", nextNode: "indication_healthier_partial" }
              ]
            },
            immortal_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Il s'agit d'un biais temporel immortel¬†!",
              text: "Si un patient d√©c√®de apr√®s sa premi√®re prescription mais avant sa seconde, il est class√© comme ¬´¬†non-utilisateur du m√©dicament X¬†¬ª - mais il A FAIT utiliser le m√©dicament X. Le temps entre les prescriptions est immortel et mal class√©. Cela penche TOUJOURS en faveur d'un b√©n√©fice apparent pour l'exposition n√©cessitant la survie.",
              lesson: "Any exposure definition requiring multiple events (prescriptions, visits, tests) creates immortal time bias."
            },
            indication_sicker_correct: {
              situation: "Correct¬†! Le m√©dicament X administr√© √† des patients plus malades aurait un biais CONTRE le m√©dicament. Mais l‚Äô√©tude montre des avantages. Si le biais d'indication est CONTRE et que le r√©sultat montre un b√©n√©fice, qu'est-ce que cela signifie¬†?",
              question: "STEP 3 - DIRECTION OF BIAS: With immortal time (FOR) and confounding by indication (AGAINST), the NET bias is...",
              branches: [
                { text: "They cancel out ‚Äî result is probably unbiased", nextNode: "cancel_wrong" },
                { text: "Unclear ‚Äî depends on which bias is larger", nextNode: "direction_correct" }
              ]
            },
            indication_healthier_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible, but consider the full picture",
              text: "¬´¬†Utilis√© apr√®s l'√©chec d'autres m√©dicaments¬†¬ª signifie g√©n√©ralement des patients PLUS DIFFICILES √Ä TRAITER, et non des patients en meilleure sant√©. Ils ont √©chou√© au traitement de premi√®re intention. Cela cr√©e une confusion par indication CONTRE le m√©dicament X. L'√©tude SOUS-ESTIMERA tout b√©n√©fice r√©el.",
              lesson: "Confounding by indication in drug studies usually makes new/expensive drugs look WORSE (given to sicker patients) ‚Äî unless healthy user bias dominates."
            },
            cancel_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Biases don't just 'cancel out'!",
              text: "Vous ne pouvez pas supposer que les biais s'annulent. Le biais du temps immortel est presque toujours pr√©sent lorsque la conception le cr√©e. Les confusions par indication d√©pendent des modes de prescription. Vous devez estimer la MAGNITUDE de chaque biais, et non supposer qu'ils se compensent.",
              lesson: "Identifying bias direction is step 1. Estimating bias MAGNITUDE requires sensitivity analysis or design changes."
            },
            direction_correct: {
              situation: "Correct! Net bias is unclear. You need more information.",
              question: "STEP 4 - ROBINS-I ASSESSMENT: Given what you know, what is your overall risk of bias judgment?",
              branches: [
                { text: "Moderate ‚Äî some concerns but usable", nextNode: "robins_moderate_wrong" },
                { text: "Serious ‚Äî important problems that require caution", nextNode: "robins_serious_correct" },
                { text: "Critical ‚Äî too flawed to be useful", nextNode: "robins_critical_partial" }
              ]
            },
            robins_moderate_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Too generous!",
              text: "Avec √† la fois un biais temporel immortel ET des facteurs de confusion non mesur√©s (gravit√© de l'hypertension, √©chec du traitement ant√©rieur), cette √©tude pr√©sente de GRAVES probl√®mes m√©thodologiques. ¬´ Mod√©r√© ¬ª implique que c'est presque aussi bon qu'un ECR ‚Äì ce n'est pas le cas.",
              lesson: "ROBINS-I is intentionally strict. Real-world drug studies rarely achieve 'low' or 'moderate' without careful design (new user, active comparator, etc.)."
            },
            robins_serious_correct: {
              situation: "Appropriate! The study has serious risk of bias. Final step:",
              question: "√âTAPE 5 - D√âCISION CLINIQUE¬†: Un coll√®gue souhaite faire passer ses patients au m√©dicament X sur la base de cette √©tude. Vous conseillez...",
              branches: [
                { text: "Switch ‚Äî even with bias, 40% reduction is clinically meaningful", nextNode: "switch_wrong" },
                { text: "Ne changez pas¬†: attendez de meilleures preuves (ECR ou observationnelle mieux con√ßue)", nextNode: "wait_correct" }
              ]
            },
            robins_critical_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Possible, but justify carefully",
              text: "¬´¬†Critique¬†¬ª signifie que l'√©tude ne fournit essentiellement aucune information utile. En raison de graves biais de temps immortel et de confusion, les r√©sultats sont discutables, mais certaines informations sur l'utilisation r√©elle du m√©dicament sont toujours pr√©sentes. ¬´¬†S√©rieux¬†¬ª avec des mises en garde majeures peut √™tre plus appropri√©.",
              lesson: "Reserve 'critical' for truly fatal flaws: fabricated data, fundamental design impossibilities, or complete uninformativeness."
            },
            switch_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "C'est exactement l'erreur du THS¬†!",
              text: "A 40% reduction in an observational study with serious bias could easily be ENTIRELY artifactual. Remember: HRT showed 40-50% reduction in cohorts, but the truth was HARM. Immortal time alone can create 20-40% apparent benefit. Don't change practice based on seriously biased observational data.",
              lesson: "Ne jamais assimiler un ¬´¬†r√©sultat d'observation statistiquement significatif¬†¬ª √† un ¬´¬†effet r√©el¬†¬ª. Le THS, la vitamine D et d'autres inversions ont tous commenc√© avec des preuves observationnelles apparemment convaincantes."
            },
            wait_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Excellent clinical judgment!",
              text: "You've correctly identified that: (1) immortal time bias inflates benefit, (2) confounding direction is unclear, (3) ROBINS-I = serious risk, (4) a 40% reduction could be artifact. The appropriate response is to wait for better evidence while acknowledging uncertainty.",
              lesson: "This capstone synthesizes everything: bias identification, ROBINS-I assessment, and clinical decision-making under uncertainty. You've learned to see beyond the headline number."
            }
          }
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'capstone-screening',
          title: "Capstone 2¬†: La controverse sur le d√©pistage",
          situation: "Un nouveau test sanguin pr√©tend d√©tecter la maladie d'Alzheimer √† un stade pr√©coce. Commercialisation¬†:¬†¬´¬†Survie √† 5¬†ans¬†:¬†80¬†% avec d√©tection pr√©coce contre 40¬†% sans.¬†¬ª Des √©tudes observationnelles montrent que les patients diagnostiqu√©s pr√©cocement ¬´ vivent plus longtemps ¬ª. Vous faites partie d'un comit√© de politique de sant√© qui d√©cide de recommander ou non le d√©pistage de la population.",
          nodes: {
            start: {
              question: "PREMI√àRE¬†:¬†Quelle est votre pr√©occupation imm√©diate concernant l'all√©gation ¬´¬†80¬†% contre 40¬†% de survie¬†¬ª¬†?",
              branches: [
                { text: "The numbers sound too good ‚Äî probably exaggerated", nextNode: "exaggerated_partial" },
                { text: "This is lead time bias ‚Äî survival improves just by diagnosing earlier", nextNode: "lead_time_correct" },
                { text: "Sample sizes must have been small", nextNode: "sample_wrong" }
              ]
            },
            lead_time_correct: {
              situation: "Exactly! You demand MORTALITY data. They provide: 'Observational cohort shows 25% lower dementia-related mortality in screened patients (HR 0.75, 95% CI 0.65-0.87).'",
              question: "Est-ce une preuve convaincante pour le d√©pistage de la population¬†?",
              branches: [
                { text: "Oui¬†: la mortalit√© est le bon r√©sultat et la HR est significatif", nextNode: "mortality_wrong" },
                { text: "No ‚Äî observational screening studies have healthy screener bias", nextNode: "screener_bias_correct" }
              ]
            },
            exaggerated_partial: {
              type: 'outcome',
              outcome: 'partial',
              title: "Skepticism is good, but identify the SPECIFIC bias",
              text: "Votre instinct a raison, mais le m√©canisme sp√©cifique est le BIAIS DU D√âLAIS. Si la maladie d'Alzheimer est d√©tect√©e 3 ans plus t√¥t par d√©pistage mais que les patients d√©c√®dent toujours au m√™me √¢ge, la survie √† 5 ans passe de 40 % √† 80 % avec un b√©n√©fice de mortalit√© Z√âRO. Les statistiques de survie sont syst√©matiquement trompeuses pour le d√©pistage.",
              lesson: "Always name the specific bias. 'Sounds too good' isn't actionable. 'Lead time bias inflates survival' is."
            },
            sample_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Sample size isn't the issue here!",
              text: "M√™me avec un million de patients, les statistiques de survie pour le d√©pistage n'ont aucune signification en raison d'un biais de d√©lai. L‚Äô√©tude pourrait √™tre parfaitement pr√©cise sans toutefois vous dire si le d√©pistage sauve des vies. Il s'agit d'un biais syst√©matique et non d'une erreur al√©atoire.",
              lesson: "Precision (large N) doesn't fix bias. A very precise estimate of the wrong thing is still wrong."
            },
            mortality_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "You forgot healthy screener bias!",
              text: "People who seek screening are systematically healthier: they exercise, eat well, have good healthcare access. They have lower mortality FROM EVERYTHING ‚Äî including dementia ‚Äî even if screening doesn't help. This is the same bias that fooled us with HRT, colonoscopy, and health checkups.",
              lesson: "Observational comparisons of screened vs unscreened populations are ALWAYS confounded by healthy screener bias. Only RCTs can eliminate it."
            },
            screener_bias_correct: {
              situation: "Perfect! You demand RCT evidence. They say: 'No RCT exists, but screening is harmless ‚Äî it's just a blood test. Why not offer it while we wait for RCT results?'",
              question: "Your response:",
              branches: [
                { text: "Reasonable ‚Äî a blood test has minimal harm", nextNode: "harmless_wrong" },
                { text: "Le d√©pistage n'est PAS inoffensif¬†: il existe des pr√©judices en aval", nextNode: "harms_correct" }
              ]
            },
            harmless_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Screening cascade causes real harm!",
              text: "The blood test may be harmless, but what happens NEXT? False positives lead to: anxiety, depression, insurance discrimination, further invasive testing, treatments with side effects for disease that may never cause symptoms. For Alzheimer's with no disease-modifying treatment, early diagnosis may cause psychological harm without benefit.",
              lesson: "Screening harms: false positives ‚Üí anxiety + invasive follow-up; overdiagnosis ‚Üí treating indolent disease; psychological burden of 'patient' label. These are CERTAIN. Benefits are UNCERTAIN until RCT-proven."
            },
            harms_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Outstanding policy reasoning!",
              text: "You correctly identified: (1) survival claims = lead time bias; (2) mortality observational data = healthy screener bias; (3) screening has real downstream harms. Your recommendation: NO population screening until RCT demonstrates that mortality benefits outweigh harms of false positives, overdiagnosis, and psychological burden.",
              lesson: "This capstone integrates: lead time bias, healthy screener confounding, harm-benefit balance, and evidence standards. You've learned to think critically about screening claims."
            }
          }
        }
      },
      {
        type: 'decision-tree',
        content: {
          id: 'capstone-safety-signal',
          title: "Capstone 3¬†: Le signal de s√©curit√©",
          situation: "A widely-used diabetes drug has been on the market for 8 years. Spontaneous reports suggest possible bladder cancer association. Observational studies show conflicting results: some OR 1.3, some OR 1.0. An industry-funded cohort shows no association. Patient advocacy groups demand withdrawal.",
          nodes: {
            start: {
              question: "PREMI√àRE √âTAPE¬†: Comment √©valuez-vous les preuves observationnelles contradictoires¬†?",
              branches: [
                { text: "Faites confiance √† la cohorte de l'industrie¬†‚Äì c'est la plus grande et la plus rigoureuse", nextNode: "industry_wrong" },
                { text: "Assess each study's risk of bias systematically using ROBINS-I", nextNode: "robins_correct" },
                { text: "Moyenne de toutes les √©tudes ‚Äî la v√©rit√© est probablement au milieu", nextNode: "average_wrong" }
              ]
            },
            industry_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Funding bias is real!",
              text: "Industry-funded studies of their own drugs consistently show more favorable results than independent studies. This isn't necessarily fraud ‚Äî it's design choices: shorter follow-up (bladder cancer takes years), healthier populations, favorable comparators. Evaluate the METHODS, not the sponsor.",
              lesson: "Assess risk of bias, not prestige. Large doesn't mean unbiased. Consider: follow-up duration, comparator choice, outcome ascertainment, time-related biases."
            },
            robins_correct: {
              situation: "Bonne approche¬†! ROBINS-I r√©v√®le¬†: Les √©tudes montrant OR 1,3 ont un suivi plus long (5 ans et plus). Les √©tudes montrant une valeur nulle ont un suivi plus court (2 √† 3 ans). Le cancer de la vessie a une longue latence. Que concluez-vous¬†?",
              question: "Your interpretation:",
              branches: [
                { text: "Les √©tudes nulles ont probablement raison ‚Äî davantage d'√©tudes ne montrent aucun effet", nextNode: "null_wrong" },
                { text: "Un suivi plus long est m√©thodologiquement correct pour les r√©sultats latents ‚Äî le signal peut √™tre r√©el", nextNode: "latency_correct" }
              ]
            },
            average_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Don't average biased with unbiased!",
              text: "Si certaines √©tudes pr√©sentent des d√©fauts de conception (suivi court pour un r√©sultat latent), la moyenne avec de meilleures √©tudes dilue le signal. Vous ne voulez pas de ¬´ moyenne ¬ª entre les bonnes et les mauvaises preuves¬†: vous voulez comprendre POURQUOI elles diff√®rent et faire confiance √† celles qui sont m√©thodologiquement valables.",
              lesson: "La m√©ta-analyse ne fait pas de moyenne. C'est une synth√®se avec une pond√©ration de qualit√©. Comprenez les sources d'h√©t√©rog√©n√©it√© avant de les regrouper."
            },
            null_wrong: {
              type: 'outcome',
              outcome: 'danger',
              title: "Count of studies doesn't matter ‚Äî quality does!",
              text: "Three studies with 2-year follow-up can't detect a cancer that takes 5+ years to develop. They're methodologically incapable of finding the signal even if it exists. The two studies with adequate follow-up both show elevated risk. For latent outcomes, insufficient follow-up = unable to detect, not 'no effect.'",
              lesson: "For safety signals with latent outcomes: (1) Longer follow-up is REQUIRED; (2) Short-term null studies are uninformative; (3) Trust methodologically adequate studies, not study counts."
            },
            latency_correct: {
              situation: "Correct! Now: The drug helps millions with diabetes. Bladder cancer is rare. Even if OR=1.3 is real, absolute risk is small. How do you weigh benefits vs harms?",
              question: "Your recommendation:",
              branches: [
                { text: "Withdraw the drug ‚Äî any cancer signal is unacceptable", nextNode: "withdraw_extreme" },
                { text: "Poursuivez la surveillance am√©lior√©e, la formation des patients/prescripteurs et les √©tudes en cours", nextNode: "monitor_correct" }
              ]
            },
            withdraw_extreme: {
              type: 'outcome',
              outcome: 'partial',
              title: "Consid√©rez l'√©quilibre b√©n√©fices-inconv√©nients¬†!",
              text: "Diabetes causes heart attacks, strokes, amputations, blindness. If this drug provides substantial benefit and the cancer risk is small (NNH > 1000), withdrawal might cause NET HARM ‚Äî more deaths from uncontrolled diabetes than prevented cancers. Regulatory decisions must weigh absolute risks.",
              lesson: "Drug safety isn't binary. Weigh: (1) magnitude of benefit, (2) magnitude of harm, (3) availability of alternatives, (4) population affected. Small relative risks in rare outcomes may be acceptable if benefits are large."
            },
            monitor_correct: {
              type: 'outcome',
              outcome: 'success',
              title: "Balanced regulatory thinking!",
              text: "Your recommendation acknowledges: (1) Signal is plausible given latency-appropriate evidence; (2) Absolute risk is small; (3) Benefits are substantial; (4) Uncertainty remains. Enhanced monitoring allows continued benefit while gathering more data. Consider contraindication in patients with prior bladder cancer or other high-risk features.",
              lesson: "This capstone integrates: signal evaluation, bias assessment, benefit-harm balance, and proportionate response. Real pharmacovigilance is nuanced, not reflexive withdrawal or dismissal."
            }
          }
        }
      },
      {
        type: 'content',
        content: {
          title: "üéì Cours termin√©¬†: ce que vous avez appris",
          sections: [
            {
              heading: "You can now:",
              items: [
                "‚úì Distinguish confounding, selection bias, and information bias",
                "‚úì Draw and interpret DAGs (Directed Acyclic Graphs)",
                "‚úì Identify immortal time bias and other time-related biases",
                "‚úì Recognize lead time bias in screening studies",
                "‚úì Conduct ROBINS-I risk of bias assessments",
                "‚úì Understand propensity scores and their limitations",
                "‚úì Use negative controls to detect unmeasured confounding",
                "‚úì Apply the target trial framework",
                "‚úì Interpr√©ter les √©tudes de randomisation mend√©liennes",
                "‚úì Evaluate when to meta-analyze observational studies",
                "‚úì Utiliser les crit√®res de Bradford Hill et la triangulation pour l'inf√©rence causale",
                "‚úì Interpret pharmacovigilance signals appropriately",
                "‚úì Understand effect modification and heterogeneity"
              ]
            },
            {
              heading: "The Seven Principles:",
              items: [
                "1. Association is not causation ‚Äî confounding deceives",
                "2. Time flows one direction ‚Äî temporality matters",
                "3. Vous voyez ce que vous recherchez¬†: le biais de s√©lection se cache",
                "4. Measurement shapes reality ‚Äî information bias distorts",
                "5. Adjustment is not magic ‚Äî residual confounding remains",
                "6. The average can lie ‚Äî heterogeneity matters",
                "7. Replication builds confidence ‚Äî one study is never enough"
              ]
            }
          ]
        }
      },
      {
        type: 'content',
        content: {
          title: "Final Reflection",
          sections: [
            {
              heading: "Remember:",
              text: "Les preuves observationnelles ne sont pas inf√©rieures aux preuves ECR¬†‚Äì elles sont DIFF√âRENTES. Lorsque les ECR sont impossibles, contraires √† l‚Äô√©thique ou insuffisants, les donn√©es observationnelles constituent la meilleure preuve dont nous disposons. Mais cela n√©cessite une interpr√©tation prudente."
            },
            {
              heading: "The Thalidomide-HRT Paradox:",
              items: [
                "Thalidomide: Observational evidence SAVED lives (detected harm RCTs missed)",
                "HRT: Observational evidence COST lives (confounding created false benefit)",
                "La diff√©rence n'√©tait pas l'observation par rapport √† la randomisation, mais plut√¥t par une analyse minutieuse ou n√©gligente."
              ]
            },
            {
              heading: "Your Responsibility:",
              text: "En tant que personne qui comprend d√©sormais les preuves observationnelles, vous pouvez identifier quand elles sont dignes de confiance, quand elles sont trompeuses et quand exiger de meilleures donn√©es. Utilisez ces connaissances pour aider les patients, et non pour rejeter toutes les recherches observationnelles par r√©flexe."
            },
            {
              heading: "The Straight Path:",
              text: "Entre la confiance aveugle dans les r√©sultats de l'observation et le rejet automatique se trouve l'√©valuation critique. Vous avez appris √† suivre ce chemin. Utilisez-le √† bon escient."
            }
          ]
        }
      },
      {
        type: 'quiz',
        content: {
          question: "Vous avez termin√© le cours¬†! D'apr√®s tout ce que vous avez appris, quel √©nonc√© illustre le mieux le r√¥le des preuves observationnelles en m√©decine¬†?",
          options: [
            { id: 'a', text: "Les preuves observationnelles ne doivent jamais √™tre utilis√©es pour des d√©cisions cliniques¬†: seuls les ECR comptent", correct: false },
            { id: 'b', text: "Les preuves observationnelles sont aussi fiables que les preuves issues des ECR lorsque la taille des √©chantillons est suffisamment grande", correct: false },
            { id: 'c', text: "Les preuves observationnelles sont essentielles mais n√©cessitent une √©valuation minutieuse de biais, de confusion et de r√©plication avant la confiance", correct: true },
            { id: 'd', text: "Les preuves observationnelles ne sont utiles que pour g√©n√©rer des hypoth√®ses, jamais pour les confirmer", correct: false }
          ],
          explanation: "Observational evidence is essential for rare harms, long-term outcomes, and questions that can't be randomized. But it requires rigorous bias assessment (ROBINS-I), understanding of confounding structures (DAGs), and triangulation across methods. The goal isn't to dismiss observational data ‚Äî it's to know when it's trustworthy."
        }
      }
    ]
  }
];

// Render Functions
function renderModuleNav() {
  const nav = document.getElementById('module-nav');
  nav.innerHTML = modules.map((m, i) => `
    <button class="module-item ${i === currentModule ? 'active' : ''} ${gameState.modulesCompleted.includes(i) ? 'completed' : ''}"
            onclick="goToModule(${i})"
            aria-current="${i === currentModule ? 'true' : 'false'}">
      <div class="module-number">${gameState.modulesCompleted.includes(i) ? '‚úì' : i}</div>
      <div class="module-info">
        <div class="module-title">${m.title}</div>
        <div class="module-subtitle">${m.subtitle}${m.estimatedTime ? ` ¬∑ <span class="time-estimate">${m.estimatedTime}</span>` : ''}</div>
      </div>
    </button>
  `).join('');

  // Update total course time in header
  const totalMinutes = modules.reduce((sum, m) => {
    const mins = m.estimatedTime ? parseInt(m.estimatedTime) : 0;
    return sum + mins;
  }, 0);
  const hours = Math.floor(totalMinutes / 60);
  const mins = totalMinutes % 60;
  const timeDisplay = document.getElementById('total-time');
  if (timeDisplay) timeDisplay.textContent = `${hours}h ${mins}m total`;
}

// Badge checking and awarding
function checkBadges() {
  const newBadges = [];

  // Story Scholar - read all stories (complete modules with stories)
  if (gameState.modulesCompleted.length >= 10 && !gameState.earnedBadges.includes('story-scholar')) {
    newBadges.push('story-scholar');
  }

  // Decision Ace - complete significant decision trees
  const treesCompleted = Object.keys(gameState.decisionTrees).filter(k =>
    gameState.decisionTrees[k].history && gameState.decisionTrees[k].history.length > 0
  ).length;
  if (treesCompleted >= 15 && !gameState.earnedBadges.includes('decision-ace')) {
    newBadges.push('decision-ace');
  }

  // Methods Master - complete all modules
  if (gameState.modulesCompleted.length === 12 && !gameState.earnedBadges.includes('methods-master')) {
    newBadges.push('methods-master');
  }

  // Award new badges
  newBadges.forEach(badge => {
    gameState.earnedBadges.push(badge);
    showBadgeNotification(badge);
  });

  if (newBadges.length > 0) saveProgress();
}

function showBadgeNotification(badgeId) {
  const badge = BADGES[badgeId];
  if (!badge) return;

  const notification = document.createElement('div');
  notification.className = 'badge-notification';
  notification.innerHTML = `
    <div class="badge-icon" style="background: ${badge.color}">${badge.icon}</div>
    <div class="badge-info">
      <div class="badge-earned">Badge Earned!</div>
      <div class="badge-name">${badge.name}</div>
    </div>
  `;
  document.body.appendChild(notification);

  setTimeout(() => notification.classList.add('show'), 100);
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => notification.remove(), 500);
  }, 3000);
}

function renderSlide() {
  const container = document.getElementById('slide-container');
  const module = modules[currentModule];
  const slide = module.slides[currentSlide];

  let html = '';

  switch(slide.type) {
    case 'title':
      html = `
        <div class="slide-title">
          <h1>${slide.content.title}</h1>
          <div class="subtitle">${slide.content.subtitle}</div>
          <p class="description">${slide.content.text}</p>
        </div>
      `;
      break;

    case 'principle-display':
      html = `
        <div class="principle-box">
          <div class="number">${module.principle !== null ? module.principle + 1 : ''}</div>
          <div class="text">"${slide.content.principle}"</div>
        </div>
      `;
      break;

    case 'principle':
      html = `
        <div class="principle-box" style="background: linear-gradient(135deg, rgba(212,175,55,0.15), rgba(30,39,97,0.1)); padding: 2rem;">
          <div class="text" style="font-size: 1.2rem; line-height: 1.6; white-space: pre-line;">${slide.content.text}</div>
        </div>
      `;
      break;

    case 'story-deep':
      html = renderStoryDeep(slide.content);
      break;

    case 'story-box':
      html = renderStoryBox(slide.content);
      break;

    case 'content':
      html = renderContent(slide.content);
      break;

    case 'method':
      html = renderMethod(slide.content);
      break;

    case 'tool':
      html = renderTool(slide.content);
      break;

    case 'decision-tree':
      html = renderDecisionTree(slide.content);
      break;

    case 'quiz':
      html = renderQuiz(slide.content);
      break;

    default:
      html = `<p>Unknown slide type: ${slide.type}</p>`;
  }

  container.innerHTML = html;
  updateProgress();
  updateNavButtons();

  // Announce slide change for screen readers
  const announcer = document.getElementById('slide-announce');
  if (announcer) {
    const module = modules[currentModule];
    announcer.textContent = `Slide ${currentSlide + 1} of ${module.slides.length}, Module: ${module.title}`;
  }
}

function renderStoryDeep(content) {
  return `
    <div class="story-deep">
      <div class="story-label">${content.label}</div>
      <div class="story-source">${content.source}</div>

      <div class="timeline">
        ${content.timeline.map(event => `
          <div class="timeline-event ${event.type}">
            <div class="timeline-year">${event.year}</div>
            <div class="timeline-text">${event.text}</div>
          </div>
        `).join('')}
      </div>

      <div class="real-data-card">
        <h4>The Data That Matters</h4>
        <div class="data-grid">
          <div class="data-item">
            <div class="data-value">${content.realData.endpoint}</div>
            <div class="data-label">Endpoint</div>
          </div>
          <div class="data-item">
            <div class="data-value">${content.realData.drug}</div>
            <div class="data-label">Exposed</div>
          </div>
          <div class="data-item">
            <div class="data-value">${content.realData.placebo}</div>
            <div class="data-label">Unexposed</div>
          </div>
          <div class="data-item">
            <div class="data-value">${content.realData.rr}</div>
            <div class="data-label">Effect</div>
          </div>
        </div>
      </div>

      <div class="story-hook">${content.hook}</div>
    </div>
  `;
}

function renderStoryBox(content) {
  return `
    <div class="story-box">
      <div class="story-box-header">
        <span class="story-box-icon">${content.icon || 'üìñ'}</span>
        <span class="story-box-title">${content.title}</span>
      </div>
      ${content.source ? `<div class="story-box-source">${content.source}</div>` : ''}
      <div class="story-box-content">
        ${content.paragraphs.map(p => `<p>${p}</p>`).join('')}
      </div>
      <div class="story-box-lesson">
        <div class="story-box-lesson-label">The Lesson</div>
        <div class="story-box-lesson-text">${content.lesson}</div>
      </div>
    </div>
  `;
}

function renderContent(content) {
  return `
    <div class="content-box">
      <h3>${content.title}</h3>
      ${content.sections.map(section => `
        <div class="content-section">
          <h4>${section.heading}</h4>
          ${section.text ? `<p>${section.text}</p>` : ''}
          ${section.items ? `<ul>${section.items.map(item => `<li>${item}</li>`).join('')}</ul>` : ''}
        </div>
      `).join('')}
    </div>
  `;
}

function renderMethod(content) {
  return `
    <div class="method-box">
      <div class="method-label">${content.label}</div>
      <h3>${content.title}</h3>
      ${content.sections.map(section => `
        <div class="content-section">
          <h4>${section.heading}</h4>
          <p style="white-space: pre-line;">${section.text}</p>
        </div>
      `).join('')}
    </div>
  `;
}

function renderTool(content) {
  if (content.id === 'dag-builder') {
    return renderDAGBuilder(content);
  }
  return `
    <div class="tool-container">
      <h3>${content.title}</h3>
      <p class="tool-description">${content.description}</p>
      <p style="color: var(--light-text); font-style: italic;">Tool implementation coming soon...</p>
    </div>
  `;
}

function renderDAGBuilder(content) {
  return `
    <div class="tool-container">
      <h3>${content.title}</h3>
      <p class="tool-description">${content.description}</p>

      <div class="tool-inputs" style="grid-template-columns: 1fr 1fr;">
        <div class="input-group">
          <label>Exposure</label>
          <input type="text" id="dag-exposure" placeholder="e.g., HRT use" value="HRT use">
        </div>
        <div class="input-group">
          <label>Outcome</label>
          <input type="text" id="dag-outcome" placeholder="e.g., CHD" value="CHD">
        </div>
      </div>

      <div class="input-group">
        <label>Potential Confounders (one per line)</label>
        <textarea id="dag-confounders" rows="4" placeholder="e.g.,&#10;Socioeconomic status&#10;Exercise&#10;Education">Socioeconomic status
Exercise habits
Healthcare access
Education level</textarea>
      </div>

      <button class="tool-btn" onclick="generateDAG()">Generate DAG</button>

      <div class="tool-output" id="dag-output" style="display: none;">
        <div id="dag-plot" class="plot-area"></div>
        <div id="dag-interpretation"></div>
      </div>
    </div>
  `;
}

function escapeHTML(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function generateDAG() {
  const exposureRaw = document.getElementById('dag-exposure').value || 'Exposure';
  const outcomeRaw = document.getElementById('dag-outcome').value || 'Outcome';
  const confoundersText = document.getElementById('dag-confounders').value;
  const confoundersRaw = confoundersText.split('\n').filter(c => c.trim());
  const exposure = escapeHTML(exposureRaw);
  const outcome = escapeHTML(outcomeRaw);
  const confounders = confoundersRaw.map(c => escapeHTML(c));

  const output = document.getElementById('dag-output');
  output.style.display = 'block';

  // Create nodes
  const nodes = [
    { id: 'exposure', label: exposure, x: 0, y: 0.5 },
    { id: 'outcome', label: outcome, x: 1, y: 0.5 }
  ];

  confounders.forEach((c, i) => {
    nodes.push({
      id: `conf${i}`,
      label: c.trim(),
      x: 0.5,
      y: 0.1 + (i * 0.2)
    });
  });

  // Create edges
  const edges = [];
  confounders.forEach((c, i) => {
    edges.push({ from: `conf${i}`, to: 'exposure' });
    edges.push({ from: `conf${i}`, to: 'outcome' });
  });
  edges.push({ from: 'exposure', to: 'outcome', style: 'dashed' });

  // Create Plotly visualization
  const nodeX = nodes.map(n => n.x);
  const nodeY = nodes.map(n => n.y);
  const nodeLabels = nodes.map(n => n.label);

  // Create edge traces
  const edgeTraces = edges.map(e => {
    const fromNode = nodes.find(n => n.id === e.from);
    const toNode = nodes.find(n => n.id === e.to);
    return {
      x: [fromNode.x, toNode.x],
      y: [fromNode.y, toNode.y],
      mode: 'lines',
      line: {
        color: e.style === 'dashed' ? '#D4AF37' : '#1e2761',
        width: 2,
        dash: e.style === 'dashed' ? 'dash' : 'solid'
      },
      hoverinfo: 'none'
    };
  });

  const nodeTrace = {
    x: nodeX,
    y: nodeY,
    mode: 'markers+text',
    marker: {
      size: 40,
      color: nodes.map(n => n.id === 'exposure' ? '#2D8B8B' : n.id === 'outcome' ? '#BF2D2D' : '#D4AF37')
    },
    text: nodeLabels,
    textposition: 'bottom center',
    hoverinfo: 'text'
  };

  const layout = {
    showlegend: false,
    xaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [-0.2, 1.2] },
    yaxis: { showgrid: false, zeroline: false, showticklabels: false, range: [-0.1, 1.1] },
    margin: { t: 20, b: 40, l: 20, r: 20 },
    height: 350,
    paper_bgcolor: 'rgba(0,0,0,0)',
    plot_bgcolor: 'rgba(0,0,0,0)'
  };

  Plotly.newPlot('dag-plot', [...edgeTraces, nodeTrace], layout, { displayModeBar: false });

  // Interpretation
  document.getElementById('dag-interpretation').innerHTML = `
    <h4 style="color: var(--teal); margin-top: 1rem;">Interpretation</h4>
    <p><strong>Backdoor paths identified:</strong> ${confounders.length} potential confounders create backdoor paths from ${exposure} to ${outcome}.</p>
    <p><strong>To estimate the causal effect of ${exposure} on ${outcome}:</strong></p>
    <ul style="margin-left: 1rem;">
      <li>You must adjust for: ${confounders.join(', ') || 'No confounders identified'}</li>
      <li>The dashed arrow represents the causal effect of interest</li>
      <li>Solid arrows represent confounding paths that must be blocked</li>
    </ul>
    <p style="color: var(--red); margin-top: 0.5rem;"><strong>Warning:</strong> Unmeasured confounders may still exist!</p>
  `;

  addPoints(50);
  if (!gameState.toolsUsed.includes('dag-builder')) {
    gameState.toolsUsed.push('dag-builder');
  }
  saveProgress();
}

function renderDecisionTree(content) {
  const treeId = content.id;
  const treeState = gameState.decisionTrees[treeId] || { currentNode: 'start', history: [] };

  let node;
  if (content.nodes[treeState.currentNode]) {
    node = content.nodes[treeState.currentNode];
  } else {
    node = content.nodes.start;
    treeState.currentNode = 'start';
  }

  let html = `
    <div class="decision-tree">
      <h3>${content.title}</h3>
      <div class="decision-scenario">${content.situation}</div>
  `;

  // Show history
  if (treeState.history.length > 0) {
    html += `
      <div class="decision-history">
        ${treeState.history.map((h, i) => `<span class="history-step">${i + 1}. ${h}</span>`).join('')}
      </div>
      <button class="undo-btn" onclick="undoDecision('${treeId}')">‚Üê Undo Last Choice</button>
    `;
  }

  // Current situation
  if (node.situation) {
    html += `<div class="decision-situation">${node.situation}</div>`;
  }

  // Check if it's an ending
  if (node.type === 'outcome' || node.isEnding) {
    html += `
      <div class="decision-outcome ${node.consequence || node.outcome}">
        <h4>${node.title || 'Outcome'}</h4>
        <p>${node.text || ''}</p>
        <div class="decision-lesson">${node.lesson || ''}</div>
      </div>
      <button class="tool-btn" style="margin-top: 1rem;" onclick="resetDecisionTree('${treeId}')">Try Again</button>
    `;
  } else {
    // Show question and branches
    html += `<div class="decision-question">${node.question}</div>`;
    html += `<div class="decision-branches">`;
    node.branches.forEach(branch => {
      html += `
        <button class="decision-branch" onclick="makeDecision('${treeId}', '${branch.nextNode}', '${branch.text.substring(0, 30).replace(/\\/g, '\\\\').replace(/'/g, "\\'")}...')">
          ${branch.text}
        </button>
      `;
    });
    html += `</div>`;
  }

  html += `</div>`;
  return html;
}

function makeDecision(treeId, nextNode, choiceText) {
  if (!gameState.decisionTrees[treeId]) {
    gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  }
  gameState.decisionTrees[treeId].history.push({ nextNode: nextNode, choiceText: choiceText });
  gameState.decisionTrees[treeId].currentNode = nextNode;
  addPoints(10);
  saveProgress();
  renderSlide();
}

function undoDecision(treeId) {
  const tree = gameState.decisionTrees[treeId];
  if (tree && tree.history.length > 0) {
    tree.history.pop();
    // Replay from start using stored nextNode values
    tree.currentNode = 'start';
    for (const entry of tree.history) {
      // Support both old string format and new object format
      const node = typeof entry === 'object' ? entry.nextNode : null;
      if (node) tree.currentNode = node;
    }
    saveProgress();
    renderSlide();
  }
}

function resetDecisionTree(treeId) {
  gameState.decisionTrees[treeId] = { currentNode: 'start', history: [] };
  saveProgress();
  renderSlide();
}

function renderQuiz(content) {
  const quizId = `quiz_${currentModule}_${currentSlide}`;

  return `
    <div class="quiz-container" role="group" aria-labelledby="quiz-question">
      <div class="quiz-question" id="quiz-question">${content.question}</div>
      <div class="quiz-options" role="radiogroup">
        ${content.options.map((opt, i) => `
          <button class="quiz-option"
                  role="radio"
                  aria-checked="false"
                  data-correct="${opt.correct}"
                  data-option-id="${opt.id}"
                  onclick="selectQuizOption(this, '${quizId}', ${opt.correct})">
            ${opt.text}
          </button>
        `).join('')}
      </div>
      <div class="quiz-feedback" id="feedback-${quizId}" role="alert" aria-live="polite">
        <p>${content.explanation}</p>
      </div>
    </div>
  `;
}

const _answeredQuizzes = new Set();

function selectQuizOption(element, quizId, isCorrect) {
  // Prevent re-answering after first answer
  if (_answeredQuizzes.has(quizId)) return;

  const container = element.closest('.quiz-container');
  const options = container.querySelectorAll('.quiz-option');
  const feedback = document.getElementById(`feedback-${quizId}`);

  // Clear previous selections
  options.forEach(opt => {
    opt.classList.remove('selected', 'correct', 'incorrect');
    opt.setAttribute('aria-checked', 'false');
  });

  // Mark selection
  element.classList.add('selected');
  element.setAttribute('aria-checked', 'true');

  // Show result
  if (isCorrect) {
    element.classList.add('correct');
    feedback.classList.add('show', 'correct');
    feedback.classList.remove('incorrect');
    addPoints(30);
  } else {
    element.classList.add('incorrect');
    feedback.classList.add('show', 'incorrect');
    feedback.classList.remove('correct');
    // Show correct answer
    options.forEach(opt => {
      if (opt.dataset.correct === 'true') {
        opt.classList.add('correct');
      }
    });
  }

  // Lock quiz after answering
  _answeredQuizzes.add(quizId);
  options.forEach(opt => {
    opt.style.pointerEvents = 'none';
    opt.setAttribute('aria-disabled', 'true');
  });

  saveProgress();
}

// Navigation
function nextSlide() {
  const module = modules[currentModule];
  if (currentSlide < module.slides.length - 1) {
    currentSlide++;
  } else if (currentModule < modules.length - 1) {
    if (!gameState.modulesCompleted.includes(currentModule)) {
      gameState.modulesCompleted.push(currentModule);
      addPoints(100);
      checkBadges();
    }
    currentModule++;
    currentSlide = 0;
  }
  saveProgress();
  renderSlide();
  renderModuleNav();
  window.scrollTo(0, 0);
}

function prevSlide() {
  if (currentSlide > 0) {
    currentSlide--;
  } else if (currentModule > 0) {
    currentModule--;
    currentSlide = modules[currentModule].slides.length - 1;
  }
  saveProgress();
  renderSlide();
  renderModuleNav();
  window.scrollTo(0, 0);
}

function goToModule(moduleIndex) {
  currentModule = moduleIndex;
  currentSlide = 0;
  saveProgress();
  renderSlide();
  renderModuleNav();
  closeSidebar();
  window.scrollTo(0, 0);
}

function updateNavButtons() {
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');

  prevBtn.disabled = currentModule === 0 && currentSlide === 0;

  const isLastSlide = currentModule === modules.length - 1 &&
                      currentSlide === modules[currentModule].slides.length - 1;
  nextBtn.textContent = isLastSlide ? 'Complete Course' : 'Next ‚Üí';
}

function updateProgress() {
  let totalSlides = 0;
  let completedSlides = 0;

  modules.forEach((m, i) => {
    totalSlides += m.slides.length;
    if (i < currentModule) {
      completedSlides += m.slides.length;
    } else if (i === currentModule) {
      completedSlides += currentSlide;
    }
  });

  const percent = Math.round((completedSlides / totalSlides) * 100);
  document.getElementById('progress-fill').style.width = `${percent}%`;
  document.getElementById('progress-text').textContent = `${percent}% Complete`;
}

// Points System
function addPoints(points) {
  gameState.points += points;
  document.getElementById('points-display').textContent = gameState.points;
}

// Persistence
function saveProgress() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      currentModule,
      currentSlide,
      gameState
    }));
  } catch (e) {
    console.log('Could not save progress:', e);
  }
}

function loadProgress() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const data = JSON.parse(saved);
      if (data.gameState) {
        gameState = {
          points: data.gameState.points || 0,
          earnedBadges: data.gameState.earnedBadges || [],
          toolsUsed: data.gameState.toolsUsed || [],
          modulesCompleted: data.gameState.modulesCompleted || [],
          scenariosCompleted: data.gameState.scenariosCompleted || {},
          decisionTrees: data.gameState.decisionTrees || {}
        };
      }
      if (typeof data.currentModule === 'number' && data.currentModule >= 0 && data.currentModule < modules.length) {
        currentModule = data.currentModule;
      }
      if (typeof data.currentSlide === 'number' && data.currentSlide >= 0) {
        currentSlide = Math.min(data.currentSlide, modules[currentModule].slides.length - 1);
      }
    }
  } catch (e) {
    console.log('Could not load progress:', e);
  }
}

// Mobile Menu
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.sidebar-overlay');
  const hamburger = document.querySelector('.hamburger');

  sidebar.classList.toggle('open');
  overlay.classList.toggle('show');
  hamburger.setAttribute('aria-expanded', sidebar.classList.contains('open'));
}

function closeSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.querySelector('.sidebar-overlay');
  const hamburger = document.querySelector('.hamburger');

  sidebar.classList.remove('open');
  overlay.classList.remove('show');
  hamburger.setAttribute('aria-expanded', 'false');
}

// Modal utilities: close by ID, Escape key handler
function closeModalOverlay(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function _attachModalEscapeHandler(overlayId) {
  function handler(e) {
    if (e.key === 'Escape') {
      closeModalOverlay(overlayId);
      document.removeEventListener('keydown', handler);
    }
  }
  document.addEventListener('keydown', handler);
}

// Badges Modal
function openBadges() {
  const earnedCount = gameState.earnedBadges.length;
  const totalCount = Object.keys(BADGES).length;

  const html = `
    <div id="badges-modal-overlay" role="dialog" aria-modal="true" aria-label="Badges" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
      <div style="background: white; border-radius: 12px; max-width: 700px; max-height: 80vh; overflow-y: auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="font-family: 'Cormorant Garamond', serif; color: var(--navy);">üèÜ Badges (${earnedCount}/${totalCount})</h2>
          <button id="badges-modal-close" onclick="closeModalOverlay('badges-modal-overlay')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;" aria-label="Close badges">&times;</button>
        </div>
        <div class="badge-grid">
          ${Object.entries(BADGES).map(([id, badge]) => {
            const earned = gameState.earnedBadges.includes(id);
            return `
              <div class="badge-card ${earned ? 'earned' : 'locked'}">
                <div class="badge-icon" style="background: ${badge.color}">${badge.icon}</div>
                <div class="badge-name">${badge.name}</div>
                <div class="badge-requirement">${earned ? '‚úì Earned!' : badge.requirement}</div>
              </div>
            `;
          }).join('')}
        </div>
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
  const closeBtn = document.getElementById('badges-modal-close');
  if (closeBtn) closeBtn.focus();
  _attachModalEscapeHandler('badges-modal-overlay');
}

// Glossary
function openGlossary() {
  const terms = [
    { term: "Confounding", def: "Une variable associ√©e √† la fois √† l'exposition et au r√©sultat, faussant la relation apparente entre eux." },
    { term: "Selection Bias", def: "Erreur syst√©matique d√©coulant de la mani√®re dont les participants sont s√©lectionn√©s ou retenus dans un" },
    { term: "Information Bias", def: "Systematic error in measurement or classification of exposure or outcome." },
    { term: "DAG", def: "Directed Acyclic Graph - a visual representation of causal relationships between variables." },
    { term: "Cohort Study", def: "√âtude observationnelle suivant un groupe au fil du temps pour voir qui d√©veloppe un r√©sultat." },
    { term: "Case-Control Study", def: "√âtude comparant les personnes avec un r√©sultat (cas) √† celles sans (t√©moins) pour identifier les expositions." },
    { term: "Odds Ratio", def: "Ratio of odds of exposure in cases vs controls; approximates RR when outcome is rare." },
    { term: "Risk Ratio", def: "Ratio of risk in exposed vs unexposed; measures strength of association." },
    { term: "Healthy User Bias", def: "Confounding where people who seek treatment are systematically healthier." },
    { term: "Immortal Time Bias", def: "Biais r√©sultant d'une mauvaise classification du temps-personne lorsque le statut d'exposition change temps." },
    { term: "ROBINS-I", def: "Risque de biais dans les √©tudes non randomis√©es - Outil d'intervention pour √©valuer les biais." },
    { term: "Propensity Score", def: "Probability of receiving treatment given observed covariates; used for adjustment." },
    { term: "Target Trial", def: "ECR hypoth√©tique que l'analyse observationnelle tente d'imiter." },
    { term: "Residual Confounding", def: "Confounding that remains after adjustment due to unmeasured or imperfectly measured confounders." },
    { term: "Effect Modification", def: "When the effect of exposure on outcome differs across levels of another variable." },
    { term: "IPTW", def: "Inverse Probability of Treatment Weighting - weights subjects by inverse of propensity score to balance confounders." },
    { term: "Overlap Weights", def: "Modern PS weighting targeting patients with clinical equipoise; weights by 1-PS for treated, PS for untreated." },
    { term: "Instrumental Variable", def: "A variable affecting treatment but not outcome except through treatment; enables causal inference despite unmeasured confounding." },
    { term: "Mendelian Randomization", def: "Using genetic variants as instrumental variables; leverages random inheritance to mimic randomization." },
    { term: "Bradford Hill Criteria", def: "Nine criteria for assessing causation from observational data: strength, consistency, specificity, temporality, biological gradient, plausibility, coherence, experiment, analogy." },
    { term: "Triangulation", def: "Comparing evidence across multiple methods with different biases; concordance increases confidence in causal claims." },
    { term: "Negative Control", def: "An exposure-outcome pair with no expected causal relationship; association suggests unmeasured confounding." },
    { term: "Lead Time Bias", def: "Apparent survival improvement from earlier diagnosis without true mortality benefit; common in screening evaluation." },
    { term: "E-value", def: "Minimum strength of unmeasured confounding needed to explain away an observed association." },
    { term: "New User Design", def: "Inclure uniquement les patients commen√ßant le traitement (pas les utilisateurs courants) pour √©viter les biais des survivants et capturer pr√©cocement effets." }
  ];

  const html = `
    <div id="glossary-modal-overlay" role="dialog" aria-modal="true" aria-label="Glossary" style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 1rem;">
      <div style="background: white; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h2 style="font-family: 'Cormorant Garamond', serif; color: var(--navy);">Glossary</h2>
          <button id="glossary-modal-close" onclick="closeModalOverlay('glossary-modal-overlay')" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;" aria-label="Close glossary">&times;</button>
        </div>
        ${terms.map(t => `
          <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid rgba(0,0,0,0.1);">
            <strong style="color: var(--teal);">${t.term}</strong>
            <p style="margin-top: 0.25rem; color: var(--navy);">${t.def}</p>
          </div>
        `).join('')}
      </div>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);
  const closeBtn = document.getElementById('glossary-modal-close');
  if (closeBtn) closeBtn.focus();
  _attachModalEscapeHandler('glossary-modal-overlay');
}

function openToolLibrary() {
  alert('Biblioth√®que d\'outils √† venir¬†! Outils abord√©s dans ce cours¬†: ‚Ä¢¬†DAG Builder¬† ‚Ä¢ Visualiseur de confusion ‚Ä¢ √âvaluation ROBINS-I ‚Ä¢ Calculateur de score de propension ‚Ä¢ Concepteur d\'essai cible');
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  loadProgress();
  renderModuleNav();
  renderSlide();
  document.getElementById('points-display').textContent = gameState.points;

  // Mobile menu handlers
  document.querySelector('.hamburger').addEventListener('click', toggleSidebar);
  document.querySelector('.sidebar-overlay').addEventListener('click', closeSidebar);

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowRight' && !e.target.matches('input, textarea, button, select, [role="button"]')) {
      nextSlide();
    } else if (e.key === 'ArrowLeft' && !e.target.matches('input, textarea, button, select, [role="button"]')) {
      prevSlide();
    }
  });
});
</script>
</body>
</html>
